<?php/**** @package acp* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** @ignore*/if (!defined('IN_PHPBB')){	exit;}/*** Recalculate Nested Sets** @param int	$new_id	first left_id (should start with 1)* @param string	$pkey	primary key-column (containing the id for the parent_id of the children)* @param string	$table	constant or fullname of the table* @param int	$parent_id parent_id of the current set (default = 0)* @param array	$where	contains strings to compare closer on the where statement (additional)** @author EXreaction*/function recalc_nested_sets(&$new_id, $pkey, $table, $parent_id = 0, $where = array()){	global $db;	$sql = 'SELECT *		FROM ' . $table . '		WHERE parent_id = ' . (int) $parent_id .		((!empty($where)) ? ' AND ' . implode(' AND ', $where) : '') . '		ORDER BY left_id ASC';	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		// First we update the left_id for this module		if ($row['left_id'] != $new_id)		{			$db->sql_query('UPDATE ' . $table . ' SET ' . $db->sql_build_array('UPDATE', array('left_id' => $new_id)) . " WHERE $pkey = {$row[$pkey]}");		}		$new_id++;		// Then we go through any children and update their left/right id's		recalc_nested_sets($new_id, $pkey, $table, $row[$pkey], $where);		// Then we come back and update the right_id for this module		if ($row['right_id'] != $new_id)		{			$db->sql_query('UPDATE ' . $table . ' SET ' . $db->sql_build_array('UPDATE', array('right_id' => $new_id)) . " WHERE $pkey = {$row[$pkey]}");		}		$new_id++;	}	$db->sql_freeresult($result);}/*** Simple version of jumpbox, just lists authed forums*/function make_forum_select($select_id = false, $ignore_id = false, $ignore_acl = false, $ignore_nonpost = false, $ignore_emptycat = true, $only_acl_post = false, $return_array = false){	global $db, $user, $auth;	// This query is identical to the jumpbox one	$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, forum_flags, forum_options, left_id, right_id		FROM ' . FORUMS_TABLE . '		ORDER BY left_id ASC';	$result = $db->sql_query($sql, 600);	$right = 0;	$padding_store = array('0' => '');	$padding = '';	$forum_list = ($return_array) ? array() : '';	// Sometimes it could happen that forums will be displayed here not be displayed within the index page	// This is the result of forums not displayed at index, having list permissions and a parent of a forum with no permissions.	// If this happens, the padding could be "broken"	while ($row = $db->sql_fetchrow($result))	{		if ($row['left_id'] < $right)		{			$padding .= '&nbsp; &nbsp;';			$padding_store[$row['parent_id']] = $padding;		}		else if ($row['left_id'] > $right + 1)		{			$padding = (isset($padding_store[$row['parent_id']])) ? $padding_store[$row['parent_id']] : '';		}		$right = $row['right_id'];		$disabled = false;		if (!$ignore_acl && $auth->acl_gets(array('f_list', 'a_forum', 'a_forumadd', 'a_forumdel'), $row['forum_id']))		{			if ($only_acl_post && !$auth->acl_get('f_post', $row['forum_id']) || (!$auth->acl_get('m_approve', $row['forum_id']) && !$auth->acl_get('f_noapprove', $row['forum_id'])))			{				$disabled = true;			}		}		else if (!$ignore_acl)		{			continue;		}		if (			((is_array($ignore_id) && in_array($row['forum_id'], $ignore_id)) || $row['forum_id'] == $ignore_id)			||			// Non-postable forum with no subforums, don't display			($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']) && $ignore_emptycat)			||			($row['forum_type'] != FORUM_POST && $ignore_nonpost)			)		{			$disabled = true;		}		if ($return_array)		{			// Include some more information...			$selected = (is_array($select_id)) ? ((in_array($row['forum_id'], $select_id)) ? true : false) : (($row['forum_id'] == $select_id) ? true : false);			$forum_list[$row['forum_id']] = array_merge(array('padding' => $padding, 'selected' => ($selected && !$disabled), 'disabled' => $disabled), $row);		}		else		{			$selected = (is_array($select_id)) ? ((in_array($row['forum_id'], $select_id)) ? ' selected="selected"' : '') : (($row['forum_id'] == $select_id) ? ' selected="selected"' : '');			$forum_list .= '<option value="' . $row['forum_id'] . '"' . (($disabled) ? ' disabled="disabled" class="disabled-option"' : $selected) . '>' . $padding . $row['forum_name'] . '</option>';		}	}	$db->sql_freeresult($result);	unset($padding_store);	return $forum_list;}/*** Generate size select options*/function size_select_options($size_compare){	global $user;	$size_types_text = array($user->lang['BYTES'], $user->lang['KIB'], $user->lang['MIB']);	$size_types = array('b', 'kb', 'mb');	$s_size_options = '';	for ($i = 0, $size = sizeof($size_types_text); $i < $size; $i++)	{		$selected = ($size_compare == $size_types[$i]) ? ' selected="selected"' : '';		$s_size_options .= '<option value="' . $size_types[$i] . '"' . $selected . '>' . $size_types_text[$i] . '</option>';	}	return $s_size_options;}/*** Generate list of groups (option fields without select)** @param int $group_id The default group id to mark as selected* @param array $exclude_ids The group ids to exclude from the list, false (default) if you whish to exclude no id* @param int $manage_founder If set to false (default) all groups are returned, if 0 only those groups returned not being managed by founders only, if 1 only those groups returned managed by founders only.** @return string The list of options.*/function group_select_options($group_id, $exclude_ids = false, $manage_founder = false){	global $db, $user, $config;	$exclude_sql = ($exclude_ids !== false && sizeof($exclude_ids)) ? 'WHERE ' . $db->sql_in_set('group_id', array_map('intval', $exclude_ids), true) : '';	$sql_and = (!$config['coppa_enable']) ? (($exclude_sql) ? ' AND ' : ' WHERE ') . "group_name <> 'REGISTERED_COPPA'" : '';	$sql_founder = ($manage_founder !== false) ? (($exclude_sql || $sql_and) ? ' AND ' : ' WHERE ') . 'group_founder_manage = ' . (int) $manage_founder : '';	$sql = 'SELECT group_id, group_name, group_type		FROM ' . GROUPS_TABLE . "		$exclude_sql		$sql_and		$sql_founder		ORDER BY group_type DESC, group_name ASC";	$result = $db->sql_query($sql);	$s_group_options = '';	while ($row = $db->sql_fetchrow($result))	{		$selected = ($row['group_id'] == $group_id) ? ' selected="selected"' : '';		$s_group_options .= '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="sep"' : '') . ' value="' . $row['group_id'] . '"' . $selected . '>' . (($row['group_type'] == GROUP_SPECIAL) ? $user->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';	}	$db->sql_freeresult($result);	return $s_group_options;}/*** Obtain authed forums list*/function get_forum_list($acl_list = 'f_list', $id_only = true, $postable_only = false, $no_cache = false){	global $db, $auth;	static $forum_rows;	if (!isset($forum_rows))	{		// This query is identical to the jumpbox one		$expire_time = ($no_cache) ? 0 : 600;		$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id			FROM ' . FORUMS_TABLE . '			ORDER BY left_id ASC';		$result = $db->sql_query($sql, $expire_time);		$forum_rows = array();		$right = $padding = 0;		$padding_store = array('0' => 0);		while ($row = $db->sql_fetchrow($result))		{			if ($row['left_id'] < $right)			{				$padding++;				$padding_store[$row['parent_id']] = $padding;			}			else if ($row['left_id'] > $right + 1)			{				// Ok, if the $padding_store for this parent is empty there is something wrong. For now we will skip over it.				// @todo digging deep to find out "how" this can happen.				$padding = (isset($padding_store[$row['parent_id']])) ? $padding_store[$row['parent_id']] : $padding;			}			$right = $row['right_id'];			$row['padding'] = $padding;			$forum_rows[] = $row;		}		$db->sql_freeresult($result);		unset($padding_store);	}	$rowset = array();	foreach ($forum_rows as $row)	{		if ($postable_only && $row['forum_type'] != FORUM_POST)		{			continue;		}		if ($acl_list == '' || ($acl_list != '' && $auth->acl_gets($acl_list, $row['forum_id'])))		{			$rowset[] = ($id_only) ? (int) $row['forum_id'] : $row;		}	}	return $rowset;}/*** Get forum branch*/function get_forum_branch($forum_id, $type = 'all', $order = 'descending', $include_forum = true){	global $db;	switch ($type)	{		case 'parents':			$condition = 'f1.left_id BETWEEN f2.left_id AND f2.right_id';		break;		case 'children':			$condition = 'f2.left_id BETWEEN f1.left_id AND f1.right_id';		break;		default:			$condition = 'f2.left_id BETWEEN f1.left_id AND f1.right_id OR f1.left_id BETWEEN f2.left_id AND f2.right_id';		break;	}	$rows = array();	$sql = 'SELECT f2.*		FROM ' . FORUMS_TABLE . ' f1		LEFT JOIN ' . FORUMS_TABLE . " f2 ON ($condition)		WHERE f1.forum_id = $forum_id		ORDER BY f2.left_id " . (($order == 'descending') ? 'ASC' : 'DESC');	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		if (!$include_forum && $row['forum_id'] == $forum_id)		{			continue;		}		$rows[] = $row;	}	$db->sql_freeresult($result);	return $rows;}/*** Copies permissions from one forum to others** @param int	$src_forum_id		The source forum we want to copy permissions from* @param array	$dest_forum_ids		The destination forum(s) we want to copy to* @param bool	$clear_dest_perms	True if destination permissions should be deleted* @param bool	$add_log			True if log entry should be added** @return bool						False on error** @author bantu*/function copy_forum_permissions($src_forum_id, $dest_forum_ids, $clear_dest_perms = true, $add_log = true){	global $db;	// Only one forum id specified	if (!is_array($dest_forum_ids))	{		$dest_forum_ids = array($dest_forum_ids);	}	// Make sure forum ids are integers	$src_forum_id = (int) $src_forum_id;	$dest_forum_ids = array_map('intval', $dest_forum_ids);	// No source forum or no destination forums specified	if (empty($src_forum_id) || empty($dest_forum_ids))	{		return false;	}	// Check if source forum exists	$sql = 'SELECT forum_name		FROM ' . FORUMS_TABLE . '		WHERE forum_id = ' . $src_forum_id;	$result = $db->sql_query($sql);	$src_forum_name = $db->sql_fetchfield('forum_name');	$db->sql_freeresult($result);	// Source forum doesn't exist	if (empty($src_forum_name))	{		return false;	}	// Check if destination forums exists	$sql = 'SELECT forum_id, forum_name		FROM ' . FORUMS_TABLE . '		WHERE ' . $db->sql_in_set('forum_id', $dest_forum_ids);	$result = $db->sql_query($sql);	$dest_forum_ids = $dest_forum_names = array();	while ($row = $db->sql_fetchrow($result))	{		$dest_forum_ids[]	= (int) $row['forum_id'];		$dest_forum_names[]	= $row['forum_name'];	}	$db->sql_freeresult($result);	// No destination forum exists	if (empty($dest_forum_ids))	{		return false;	}	// From the mysql documentation:	// Prior to MySQL 4.0.14, the target table of the INSERT statement cannot appear	// in the FROM clause of the SELECT part of the query. This limitation is lifted in 4.0.14.	// Due to this we stay on the safe side if we do the insertion "the manual way"	// Rowsets we're going to insert	$users_sql_ary = $groups_sql_ary = array();	// Query acl users table for source forum data	$sql = 'SELECT user_id, auth_option_id, auth_role_id, auth_setting		FROM ' . ACL_USERS_TABLE . '		WHERE forum_id = ' . $src_forum_id;	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$row = array(			'user_id'			=> (int) $row['user_id'],			'auth_option_id'	=> (int) $row['auth_option_id'],			'auth_role_id'		=> (int) $row['auth_role_id'],			'auth_setting'		=> (int) $row['auth_setting'],		);		foreach ($dest_forum_ids as $dest_forum_id)		{			$users_sql_ary[] = $row + array('forum_id' => $dest_forum_id);		}	}	$db->sql_freeresult($result);	// Query acl groups table for source forum data	$sql = 'SELECT group_id, auth_option_id, auth_role_id, auth_setting		FROM ' . ACL_GROUPS_TABLE . '		WHERE forum_id = ' . $src_forum_id;	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$row = array(			'group_id'			=> (int) $row['group_id'],			'auth_option_id'	=> (int) $row['auth_option_id'],			'auth_role_id'		=> (int) $row['auth_role_id'],			'auth_setting'		=> (int) $row['auth_setting'],		);		foreach ($dest_forum_ids as $dest_forum_id)		{			$groups_sql_ary[] = $row + array('forum_id' => $dest_forum_id);		}	}	$db->sql_freeresult($result);	$db->sql_transaction('begin');	// Clear current permissions of destination forums	if ($clear_dest_perms)	{		$sql = 'DELETE FROM ' . ACL_USERS_TABLE . '			WHERE ' . $db->sql_in_set('forum_id', $dest_forum_ids);		$db->sql_query($sql);		$sql = 'DELETE FROM ' . ACL_GROUPS_TABLE . '			WHERE ' . $db->sql_in_set('forum_id', $dest_forum_ids);		$db->sql_query($sql);	}	$db->sql_multi_insert(ACL_USERS_TABLE, $users_sql_ary);	$db->sql_multi_insert(ACL_GROUPS_TABLE, $groups_sql_ary);	if ($add_log)	{		add_log('admin', 'LOG_FORUM_COPIED_PERMISSIONS', $src_forum_name, implode(', ', $dest_forum_names));	}	$db->sql_transaction('commit');	return true;}/*** Get physical file listing*/function filelist($rootdir, $dir = '', $type = 'gif|jpg|jpeg|png'){	$matches = array($dir => array());	// Remove initial / if present	$rootdir = (substr($rootdir, 0, 1) == '/') ? substr($rootdir, 1) : $rootdir;	// Add closing / if not present	$rootdir = ($rootdir && substr($rootdir, -1) != '/') ? $rootdir . '/' : $rootdir;	// Remove initial / if present	$dir = (substr($dir, 0, 1) == '/') ? substr($dir, 1) : $dir;	// Add closing / if not present	$dir = ($dir && substr($dir, -1) != '/') ? $dir . '/' : $dir;	if (!is_dir($rootdir . $dir))	{		return $matches;	}	$dh = @opendir($rootdir . $dir);	if (!$dh)	{		return $matches;	}	while (($fname = readdir($dh)) !== false)	{		if (is_file("$rootdir$dir$fname"))		{			if (filesize("$rootdir$dir$fname") && preg_match('#\.' . $type . '$#i', $fname))			{				$matches[$dir][] = $fname;			}		}		else if ($fname[0] != '.' && is_dir("$rootdir$dir$fname"))		{			$matches += filelist($rootdir, "$dir$fname", $type);		}	}	closedir($dh);	return $matches;}/*** Move topic(s)*/function move_topics($topic_ids, $forum_id, $auto_sync = true){	global $db;	if (empty($topic_ids))	{		return;	}	$forum_ids = array($forum_id);	if (!is_array($topic_ids))	{		$topic_ids = array($topic_ids);	}	$sql = 'DELETE FROM ' . TOPICS_TABLE . '		WHERE ' . $db->sql_in_set('topic_moved_id', $topic_ids) . '			AND forum_id = ' . $forum_id;	$db->sql_query($sql);	if ($auto_sync)	{		$sql = 'SELECT DISTINCT forum_id			FROM ' . TOPICS_TABLE . '			WHERE ' . $db->sql_in_set('topic_id', $topic_ids);		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$forum_ids[] = $row['forum_id'];		}		$db->sql_freeresult($result);	}	$table_ary = array(TOPICS_TABLE, POSTS_TABLE, LOG_TABLE, DRAFTS_TABLE, TOPICS_TRACK_TABLE);	foreach ($table_ary as $table)	{		$sql = "UPDATE $table			SET forum_id = $forum_id			WHERE " . $db->sql_in_set('topic_id', $topic_ids);		$db->sql_query($sql);	}	unset($table_ary);	if ($auto_sync)	{		sync('forum', 'forum_id', $forum_ids, true, true);		unset($forum_ids);	}}/*** Move post(s)*/function move_posts($post_ids, $topic_id, $auto_sync = true){	global $db;	if (!is_array($post_ids))	{		$post_ids = array($post_ids);	}	$forum_ids = array();	$topic_ids = array($topic_id);	$sql = 'SELECT DISTINCT topic_id, forum_id		FROM ' . POSTS_TABLE . '		WHERE ' . $db->sql_in_set('post_id', $post_ids);	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$forum_ids[] = (int) $row['forum_id'];		$topic_ids[] = (int) $row['topic_id'];	}	$db->sql_freeresult($result);	$sql = 'SELECT forum_id		FROM ' . TOPICS_TABLE . '		WHERE topic_id = ' . $topic_id;	$result = $db->sql_query($sql);	$forum_row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if (!$forum_row)	{		trigger_error('NO_TOPIC');	}	$sql = 'UPDATE ' . POSTS_TABLE . '		SET forum_id = ' . (int) $forum_row['forum_id'] . ", topic_id = $topic_id		WHERE " . $db->sql_in_set('post_id', $post_ids);	$db->sql_query($sql);	$sql = 'UPDATE ' . ATTACHMENTS_TABLE . "		SET topic_id = $topic_id, in_message = 0		WHERE " . $db->sql_in_set('post_msg_id', $post_ids);	$db->sql_query($sql);	if ($auto_sync)	{		$forum_ids[] = (int) $forum_row['forum_id'];		sync('topic_reported', 'topic_id', $topic_ids);		sync('topic_attachment', 'topic_id', $topic_ids);		sync('topic', 'topic_id', $topic_ids, true);		sync('forum', 'forum_id', $forum_ids, true, true);	}	// Update posted information	update_posted_info($topic_ids);}/*** Remove topic(s)*/function delete_topics($where_type, $where_ids, $auto_sync = true, $post_count_sync = true, $call_delete_posts = true){	global $db, $config;	$approved_topics = 0;	$forum_ids = $topic_ids = array();	if ($where_type === 'range')	{		$where_clause = $where_ids;	}	else	{		$where_ids = (is_array($where_ids)) ? array_unique($where_ids) : array($where_ids);		if (!sizeof($where_ids))		{			return array('topics' => 0, 'posts' => 0);		}		$where_clause = $db->sql_in_set($where_type, $where_ids);	}	// Making sure that delete_posts does not call delete_topics again...	$return = array(		'posts' => ($call_delete_posts) ? delete_posts($where_type, $where_ids, false, true, $post_count_sync, false) : 0,	);	$sql = 'SELECT topic_id, forum_id, topic_approved, topic_moved_id		FROM ' . TOPICS_TABLE . '		WHERE ' . $where_clause;	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$forum_ids[] = $row['forum_id'];		$topic_ids[] = $row['topic_id'];		if ($row['topic_approved'] && !$row['topic_moved_id'])		{			$approved_topics++;		}	}	$db->sql_freeresult($result);	$return['topics'] = sizeof($topic_ids);	if (!sizeof($topic_ids))	{		return $return;	}	$db->sql_transaction('begin');	$table_ary = array(BOOKMARKS_TABLE, TOPICS_TRACK_TABLE, TOPICS_POSTED_TABLE, POLL_VOTES_TABLE, POLL_OPTIONS_TABLE, TOPICS_WATCH_TABLE, TOPICS_TABLE);	foreach ($table_ary as $table)	{		$sql = "DELETE FROM $table			WHERE " . $db->sql_in_set('topic_id', $topic_ids);		$db->sql_query($sql);	}	unset($table_ary);	$moved_topic_ids = array();	// update the other forums	$sql = 'SELECT topic_id, forum_id		FROM ' . TOPICS_TABLE . '		WHERE ' . $db->sql_in_set('topic_moved_id', $topic_ids);	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$forum_ids[] = $row['forum_id'];		$moved_topic_ids[] = $row['topic_id'];	}	$db->sql_freeresult($result);	if (sizeof($moved_topic_ids))	{		$sql = 'DELETE FROM ' . TOPICS_TABLE . '			WHERE ' . $db->sql_in_set('topic_id', $moved_topic_ids);		$db->sql_query($sql);	}	$db->sql_transaction('commit');	if ($auto_sync)	{		sync('forum', 'forum_id', array_unique($forum_ids), true, true);		sync('topic_reported', $where_type, $where_ids);	}	if ($approved_topics)	{		set_config_count('num_topics', $approved_topics * (-1), true);	}	return $return;}/*** Remove post(s)*/function delete_posts($where_type, $where_ids, $auto_sync = true, $posted_sync = true, $post_count_sync = true, $call_delete_topics = true){	global $db, $config, $phpbb_root_path, $phpEx;	if ($where_type === 'range')	{		$where_clause = $where_ids;	}	else	{		if (is_array($where_ids))		{			$where_ids = array_unique($where_ids);		}		else		{			$where_ids = array($where_ids);		}		if (!sizeof($where_ids))		{			return false;		}		$where_ids = array_map('intval', $where_ids);/*		Possible code for splitting post deletion		if (sizeof($where_ids) >= 1001)		{			// Split into chunks of 1000			$chunks = array_chunk($where_ids, 1000);			foreach ($chunks as $_where_ids)			{				delete_posts($where_type, $_where_ids, $auto_sync, $posted_sync, $post_count_sync, $call_delete_topics);			}			return;		}*/		$where_clause = $db->sql_in_set($where_type, $where_ids);	}	$approved_posts = 0;	$post_ids = $topic_ids = $forum_ids = $post_counts = $remove_topics = array();	$sql = 'SELECT post_id, poster_id, post_approved, post_postcount, topic_id, forum_id		FROM ' . POSTS_TABLE . '		WHERE ' . $where_clause;	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$post_ids[] = (int) $row['post_id'];		$poster_ids[] = (int) $row['poster_id'];		$topic_ids[] = (int) $row['topic_id'];		$forum_ids[] = (int) $row['forum_id'];		if ($row['post_postcount'] && $post_count_sync && $row['post_approved'])		{			$post_counts[$row['poster_id']] = (!empty($post_counts[$row['poster_id']])) ? $post_counts[$row['poster_id']] + 1 : 1;		}		if ($row['post_approved'])		{			$approved_posts++;		}	}	$db->sql_freeresult($result);	if (!sizeof($post_ids))	{		return false;	}	$db->sql_transaction('begin');	$table_ary = array(POSTS_TABLE, REPORTS_TABLE);	foreach ($table_ary as $table)	{		$sql = "DELETE FROM $table			WHERE " . $db->sql_in_set('post_id', $post_ids);		$db->sql_query($sql);	}	unset($table_ary);	// Adjust users post counts	if (sizeof($post_counts) && $post_count_sync)	{		foreach ($post_counts as $poster_id => $substract)		{			$sql = 'UPDATE ' . USERS_TABLE . '				SET user_posts = 0				WHERE user_id = ' . $poster_id . '				AND user_posts < ' . $substract;			$db->sql_query($sql);			$sql = 'UPDATE ' . USERS_TABLE . '				SET user_posts = user_posts - ' . $substract . '				WHERE user_id = ' . $poster_id . '				AND user_posts >= ' . $substract;			$db->sql_query($sql);		}	}	// Remove topics now having no posts?	if (sizeof($topic_ids))	{		$sql = 'SELECT topic_id			FROM ' . POSTS_TABLE . '			WHERE ' . $db->sql_in_set('topic_id', $topic_ids) . '			GROUP BY topic_id';		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$remove_topics[] = $row['topic_id'];		}		$db->sql_freeresult($result);		// Actually, those not within remove_topics should be removed. ;)		$remove_topics = array_diff($topic_ids, $remove_topics);	}	// Remove the message from the search index	$search_type = basename($config['search_type']);	if (!file_exists($phpbb_root_path . 'includes/search/' . $search_type . '.' . $phpEx))	{		trigger_error('NO_SUCH_SEARCH_MODULE');	}	include_once("{$phpbb_root_path}includes/search/$search_type.$phpEx");	$error = false;	$search = new $search_type($error);	if ($error)	{		trigger_error($error);	}	$search->index_remove($post_ids, $poster_ids, $forum_ids);	delete_attachments('post', $post_ids, false);	$db->sql_transaction('commit');	// Resync topics_posted table	if ($posted_sync)	{		update_posted_info($topic_ids);	}	if ($auto_sync)	{		sync('topic_reported', 'topic_id', $topic_ids);		sync('topic', 'topic_id', $topic_ids, true);		sync('forum', 'forum_id', $forum_ids, true, true);	}	if ($approved_posts)	{		set_config_count('num_posts', $approved_posts * (-1), true);	}	// We actually remove topics now to not be inconsistent (the delete_topics function calls this function too)	if (sizeof($remove_topics) && $call_delete_topics)	{		delete_topics('topic_id', $remove_topics, $auto_sync, $post_count_sync, false);	}	return sizeof($post_ids);}/*** Delete Attachments** @param string $mode can be: post|message|topic|attach|user* @param mixed $ids can be: post_ids, message_ids, topic_ids, attach_ids, user_ids* @param bool $resync set this to false if you are deleting posts or topics*/function delete_attachments($mode, $ids, $resync = true){	global $db, $config;	// 0 is as bad as an empty array	if (empty($ids))	{		return false;	}	if (is_array($ids))	{		$ids = array_unique($ids);		$ids = array_map('intval', $ids);	}	else	{		$ids = array((int) $ids);	}	$sql_where = '';	switch ($mode)	{		case 'post':		case 'message':			$sql_id = 'post_msg_id';			$sql_where = ' AND in_message = ' . ($mode == 'message' ? 1 : 0);		break;		case 'topic':			$sql_id = 'topic_id';		break;		case 'user':			$sql_id = 'poster_id';		break;		case 'attach':		default:			$sql_id = 'attach_id';			$mode = 'attach';		break;	}	$post_ids = $message_ids = $topic_ids = $physical = array();	// Collect post and topic ids for later use if we need to touch remaining entries (if resync is enabled)	$sql = 'SELECT post_msg_id, topic_id, in_message, physical_filename, thumbnail, filesize, is_orphan			FROM ' . ATTACHMENTS_TABLE . '			WHERE ' . $db->sql_in_set($sql_id, $ids);	$sql .= $sql_where;	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		// We only need to store post/message/topic ids if resync is enabled and the file is not orphaned		if ($resync && !$row['is_orphan'])		{			if (!$row['in_message'])			{				$post_ids[] = $row['post_msg_id'];				$topic_ids[] = $row['topic_id'];			}			else			{				$message_ids[] = $row['post_msg_id'];			}		}		$physical[] = array('filename' => $row['physical_filename'], 'thumbnail' => $row['thumbnail'], 'filesize' => $row['filesize'], 'is_orphan' => $row['is_orphan']);	}	$db->sql_freeresult($result);	// Delete attachments	$sql = 'DELETE FROM ' . ATTACHMENTS_TABLE . '		WHERE ' . $db->sql_in_set($sql_id, $ids);	$sql .= $sql_where;	$db->sql_query($sql);	$num_deleted = $db->sql_affectedrows();	if (!$num_deleted)	{		return 0;	}	// Delete attachments from filesystem	$space_removed = $files_removed = 0;	foreach ($physical as $file_ary)	{		if (phpbb_unlink($file_ary['filename'], 'file', true) && !$file_ary['is_orphan'])		{			// Only non-orphaned files count to the file size			$space_removed += $file_ary['filesize'];			$files_removed++;		}		if ($file_ary['thumbnail'])		{			phpbb_unlink($file_ary['filename'], 'thumbnail', true);		}	}	if ($space_removed || $files_removed)	{		set_config_count('upload_dir_size', $space_removed * (-1), true);		set_config_count('num_files', $files_removed * (-1), true);	}	// If we do not resync, we do not need to adjust any message, post, topic or user entries	if (!$resync)	{		return $num_deleted;	}	// No more use for the original ids	unset($ids);	// Now, we need to resync posts, messages, topics. We go through every one of them	$post_ids = array_unique($post_ids);	$message_ids = array_unique($message_ids);	$topic_ids = array_unique($topic_ids);	// Update post indicators for posts now no longer having attachments	if (sizeof($post_ids))	{		// Just check which posts are still having an assigned attachment not orphaned by querying the attachments table		$sql = 'SELECT post_msg_id			FROM ' . ATTACHMENTS_TABLE . '			WHERE ' . $db->sql_in_set('post_msg_id', $post_ids) . '				AND in_message = 0				AND is_orphan = 0';		$result = $db->sql_query($sql);		$remaining_ids = array();		while ($row = $db->sql_fetchrow($result))		{			$remaining_ids[] = $row['post_msg_id'];		}		$db->sql_freeresult($result);		// Now only unset those ids remaining		$post_ids = array_diff($post_ids, $remaining_ids);		if (sizeof($post_ids))		{			$sql = 'UPDATE ' . POSTS_TABLE . '				SET post_attachment = 0				WHERE ' . $db->sql_in_set('post_id', $post_ids);			$db->sql_query($sql);		}	}	// Update message table if messages are affected	if (sizeof($message_ids))	{		// Just check which messages are still having an assigned attachment not orphaned by querying the attachments table		$sql = 'SELECT post_msg_id			FROM ' . ATTACHMENTS_TABLE . '			WHERE ' . $db->sql_in_set('post_msg_id', $message_ids) . '				AND in_message = 1				AND is_orphan = 0';		$result = $db->sql_query($sql);		$remaining_ids = array();		while ($row = $db->sql_fetchrow($result))		{			$remaining_ids[] = $row['post_msg_id'];		}		$db->sql_freeresult($result);		// Now only unset those ids remaining		$message_ids = array_diff($message_ids, $remaining_ids);		if (sizeof($message_ids))		{			$sql = 'UPDATE ' . PRIVMSGS_TABLE . '				SET message_attachment = 0				WHERE ' . $db->sql_in_set('msg_id', $message_ids);			$db->sql_query($sql);		}	}	// Now update the topics. This is a bit trickier, because there could be posts still having attachments within the topic	if (sizeof($topic_ids))	{		// Just check which topics are still having an assigned attachment not orphaned by querying the attachments table (much less entries expected)		$sql = 'SELECT topic_id			FROM ' . ATTACHMENTS_TABLE . '			WHERE ' . $db->sql_in_set('topic_id', $topic_ids) . '				AND is_orphan = 0';		$result = $db->sql_query($sql);		$remaining_ids = array();		while ($row = $db->sql_fetchrow($result))		{			$remaining_ids[] = $row['topic_id'];		}		$db->sql_freeresult($result);		// Now only unset those ids remaining		$topic_ids = array_diff($topic_ids, $remaining_ids);		if (sizeof($topic_ids))		{			$sql = 'UPDATE ' . TOPICS_TABLE . '				SET topic_attachment = 0				WHERE ' . $db->sql_in_set('topic_id', $topic_ids);			$db->sql_query($sql);		}	}	return $num_deleted;}/*** Deletes shadow topics pointing to a specified forum.** @param int		$forum_id		The forum id* @param string		$sql_more		Additional WHERE statement, e.g. t.topic_time < (time() - 1234)* @param bool		$auto_sync		Will call sync() if this is true** @return array		Array with affected forums** @author bantu*/function delete_topic_shadows($forum_id, $sql_more = '', $auto_sync = true){	global $db;	if (!$forum_id)	{		// Nothing to do.		return;	}	// Set of affected forums we have to resync	$sync_forum_ids = array();	// Amount of topics we select and delete at once.	$batch_size = 500;	do	{		$sql = 'SELECT t2.forum_id, t2.topic_id			FROM ' . TOPICS_TABLE . ' t2, ' . TOPICS_TABLE . ' t			WHERE t2.topic_moved_id = t.topic_id				AND t.forum_id = ' . (int) $forum_id . '				' . (($sql_more) ? 'AND ' . $sql_more : '');		$result = $db->sql_query_limit($sql, $batch_size);		$topic_ids = array();		while ($row = $db->sql_fetchrow($result))		{			$topic_ids[] = (int) $row['topic_id'];			$sync_forum_ids[(int) $row['forum_id']] = (int) $row['forum_id'];		}		$db->sql_freeresult($result);		if (!empty($topic_ids))		{			$sql = 'DELETE FROM ' . TOPICS_TABLE . '				WHERE ' . $db->sql_in_set('topic_id', $topic_ids);			$db->sql_query($sql);		}	}	while (sizeof($topic_ids) == $batch_size);	if ($auto_sync)	{		sync('forum', 'forum_id', $sync_forum_ids, true, true);	}	return $sync_forum_ids;}/*** Update/Sync posted information for topics*/function update_posted_info(&$topic_ids){	global $db, $config;	if (empty($topic_ids) || !$config['load_db_track'])	{		return;	}	// First of all, let us remove any posted information for these topics	$sql = 'DELETE FROM ' . TOPICS_POSTED_TABLE . '		WHERE ' . $db->sql_in_set('topic_id', $topic_ids);	$db->sql_query($sql);	// Now, let us collect the user/topic combos for rebuilding the information	$sql = 'SELECT poster_id, topic_id		FROM ' . POSTS_TABLE . '		WHERE ' . $db->sql_in_set('topic_id', $topic_ids) . '			AND poster_id <> ' . ANONYMOUS . '		GROUP BY poster_id, topic_id';	$result = $db->sql_query($sql);	$posted = array();	while ($row = $db->sql_fetchrow($result))	{		// Add as key to make them unique (grouping by) and circumvent empty keys on array_unique		$posted[$row['poster_id']][] = $row['topic_id'];	}	$db->sql_freeresult($result);	// Now add the information...	$sql_ary = array();	foreach ($posted as $user_id => $topic_row)	{		foreach ($topic_row as $topic_id)		{			$sql_ary[] = array(				'user_id'		=> (int) $user_id,				'topic_id'		=> (int) $topic_id,				'topic_posted'	=> 1,			);		}	}	unset($posted);	$db->sql_multi_insert(TOPICS_POSTED_TABLE, $sql_ary);}/*** Delete attached file*/function phpbb_unlink($filename, $mode = 'file', $entry_removed = false){	global $db, $phpbb_root_path, $config;	// Because of copying topics or modifications a physical filename could be assigned more than once. If so, do not remove the file itself.	$sql = 'SELECT COUNT(attach_id) AS num_entries		FROM ' . ATTACHMENTS_TABLE . "		WHERE physical_filename = '" . $db->sql_escape(utf8_basename($filename)) . "'";	$result = $db->sql_query($sql);	$num_entries = (int) $db->sql_fetchfield('num_entries');	$db->sql_freeresult($result);	// Do not remove file if at least one additional entry with the same name exist.	if (($entry_removed && $num_entries > 0) || (!$entry_removed && $num_entries > 1))	{		return false;	}	$filename = ($mode == 'thumbnail') ? 'thumb_' . utf8_basename($filename) : utf8_basename($filename);	return @unlink($phpbb_root_path . $config['upload_path'] . '/' . $filename);}/*** All-encompasing sync function** Exaples:* <code>* sync('topic', 'topic_id', 123);			// resync topic #123* sync('topic', 'forum_id', array(2, 3));	// resync topics from forum #2 and #3* sync('topic');							// resync all topics* sync('topic', 'range', 'topic_id BETWEEN 1 AND 60');	// resync a range of topics/forums (only available for 'topic' and 'forum' modes)* </code>** Modes:* - forum				Resync complete forum* - topic				Resync topics* - topic_moved			Removes topic shadows that would be in the same forum as the topic they link to* - topic_approved		Resyncs the topic_approved flag according to the status of the first post* - post_reported		Resyncs the post_reported flag, relying on actual reports* - topic_reported		Resyncs the topic_reported flag, relying on post_reported flags* - post_attachement	Same as post_reported, but with attachment flags* - topic_attachement	Same as topic_reported, but with attachment flags*/function sync($mode, $where_type = '', $where_ids = '', $resync_parents = false, $sync_extra = false){	global $db;	if (is_array($where_ids))	{		$where_ids = array_unique($where_ids);		$where_ids = array_map('intval', $where_ids);	}	else if ($where_type != 'range')	{		$where_ids = ($where_ids) ? array((int) $where_ids) : array();	}	if ($mode == 'forum' || $mode == 'topic' || $mode == 'topic_approved' || $mode == 'topic_reported' || $mode == 'post_reported')	{		if (!$where_type)		{			$where_sql = '';			$where_sql_and = 'WHERE';		}		else if ($where_type == 'range')		{			// Only check a range of topics/forums. For instance: 'topic_id BETWEEN 1 AND 60'			$where_sql = 'WHERE (' . $mode[0] . ".$where_ids)";			$where_sql_and = $where_sql . "\n\tAND";		}		else		{			// Do not sync the "global forum"			$where_ids = array_diff($where_ids, array(0));			if (!sizeof($where_ids))			{				// Empty array with IDs. This means that we don't have any work to do. Just return.				return;			}			// Limit the topics/forums we are syncing, use specific topic/forum IDs.			// $where_type contains the field for the where clause (forum_id, topic_id)			$where_sql = 'WHERE ' . $db->sql_in_set($mode[0] . '.' . $where_type, $where_ids);			$where_sql_and = $where_sql . "\n\tAND";		}	}	else	{		if (!sizeof($where_ids))		{			return;		}		// $where_type contains the field for the where clause (forum_id, topic_id)		$where_sql = 'WHERE ' . $db->sql_in_set($mode[0] . '.' . $where_type, $where_ids);		$where_sql_and = $where_sql . "\n\tAND";	}	switch ($mode)	{		case 'topic_moved':			$db->sql_transaction('begin');			switch ($db->sql_layer)			{				case 'mysql4':				case 'mysqli':					$sql = 'DELETE FROM ' . TOPICS_TABLE . '						USING ' . TOPICS_TABLE . ' t1, ' . TOPICS_TABLE . " t2						WHERE t1.topic_moved_id = t2.topic_id							AND t1.forum_id = t2.forum_id";					$db->sql_query($sql);				break;				default:					$sql = 'SELECT t1.topic_id						FROM ' .TOPICS_TABLE . ' t1, ' . TOPICS_TABLE . " t2						WHERE t1.topic_moved_id = t2.topic_id							AND t1.forum_id = t2.forum_id";					$result = $db->sql_query($sql);					$topic_id_ary = array();					while ($row = $db->sql_fetchrow($result))					{						$topic_id_ary[] = $row['topic_id'];					}					$db->sql_freeresult($result);					if (!sizeof($topic_id_ary))					{						return;					}					$sql = 'DELETE FROM ' . TOPICS_TABLE . '						WHERE ' . $db->sql_in_set('topic_id', $topic_id_ary);					$db->sql_query($sql);				break;			}			$db->sql_transaction('commit');			break;		case 'topic_approved':			$db->sql_transaction('begin');			switch ($db->sql_layer)			{				case 'mysql4':				case 'mysqli':					$sql = 'UPDATE ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p						SET t.topic_approved = p.post_approved						$where_sql_and t.topic_first_post_id = p.post_id";					$db->sql_query($sql);				break;				default:					$sql = 'SELECT t.topic_id, p.post_approved						FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p						$where_sql_and p.post_id = t.topic_first_post_id							AND p.post_approved <> t.topic_approved";					$result = $db->sql_query($sql);					$topic_ids = array();					while ($row = $db->sql_fetchrow($result))					{						$topic_ids[] = $row['topic_id'];					}					$db->sql_freeresult($result);					if (!sizeof($topic_ids))					{						return;					}					$sql = 'UPDATE ' . TOPICS_TABLE . '						SET topic_approved = 1 - topic_approved						WHERE ' . $db->sql_in_set('topic_id', $topic_ids);					$db->sql_query($sql);				break;			}			$db->sql_transaction('commit');			break;		case 'post_reported':			$post_ids = $post_reported = array();			$db->sql_transaction('begin');			$sql = 'SELECT p.post_id, p.post_reported				FROM ' . POSTS_TABLE . " p				$where_sql				GROUP BY p.post_id, p.post_reported";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$post_ids[$row['post_id']] = $row['post_id'];				if ($row['post_reported'])				{					$post_reported[$row['post_id']] = 1;				}			}			$db->sql_freeresult($result);			$sql = 'SELECT DISTINCT(post_id)				FROM ' . REPORTS_TABLE . '				WHERE ' . $db->sql_in_set('post_id', $post_ids) . '					AND report_closed = 0';			$result = $db->sql_query($sql);			$post_ids = array();			while ($row = $db->sql_fetchrow($result))			{				if (!isset($post_reported[$row['post_id']]))				{					$post_ids[] = $row['post_id'];				}				else				{					unset($post_reported[$row['post_id']]);				}			}			$db->sql_freeresult($result);			// $post_reported should be empty by now, if it's not it contains			// posts that are falsely flagged as reported			foreach ($post_reported as $post_id => $void)			{				$post_ids[] = $post_id;			}			if (sizeof($post_ids))			{				$sql = 'UPDATE ' . POSTS_TABLE . '					SET post_reported = 1 - post_reported					WHERE ' . $db->sql_in_set('post_id', $post_ids);				$db->sql_query($sql);			}			$db->sql_transaction('commit');			break;		case 'topic_reported':			if ($sync_extra)			{				sync('post_reported', $where_type, $where_ids);			}			$topic_ids = $topic_reported = array();			$db->sql_transaction('begin');			$sql = 'SELECT DISTINCT(t.topic_id)				FROM ' . POSTS_TABLE . " t				$where_sql_and t.post_reported = 1";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$topic_reported[$row['topic_id']] = 1;			}			$db->sql_freeresult($result);			$sql = 'SELECT t.topic_id, t.topic_reported				FROM ' . TOPICS_TABLE . " t				$where_sql";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				if ($row['topic_reported'] ^ isset($topic_reported[$row['topic_id']]))				{					$topic_ids[] = $row['topic_id'];				}			}			$db->sql_freeresult($result);			if (sizeof($topic_ids))			{				$sql = 'UPDATE ' . TOPICS_TABLE . '					SET topic_reported = 1 - topic_reported					WHERE ' . $db->sql_in_set('topic_id', $topic_ids);				$db->sql_query($sql);			}			$db->sql_transaction('commit');			break;		case 'post_attachment':			$post_ids = $post_attachment = array();			$db->sql_transaction('begin');			$sql = 'SELECT p.post_id, p.post_attachment				FROM ' . POSTS_TABLE . " p				$where_sql				GROUP BY p.post_id, p.post_attachment";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$post_ids[$row['post_id']] = $row['post_id'];				if ($row['post_attachment'])				{					$post_attachment[$row['post_id']] = 1;				}			}			$db->sql_freeresult($result);			$sql = 'SELECT DISTINCT(post_msg_id)				FROM ' . ATTACHMENTS_TABLE . '				WHERE ' . $db->sql_in_set('post_msg_id', $post_ids) . '					AND in_message = 0';			$result = $db->sql_query($sql);			$post_ids = array();			while ($row = $db->sql_fetchrow($result))			{				if (!isset($post_attachment[$row['post_msg_id']]))				{					$post_ids[] = $row['post_msg_id'];				}				else				{					unset($post_attachment[$row['post_msg_id']]);				}			}			$db->sql_freeresult($result);			// $post_attachment should be empty by now, if it's not it contains			// posts that are falsely flagged as having attachments			foreach ($post_attachment as $post_id => $void)			{				$post_ids[] = $post_id;			}			if (sizeof($post_ids))			{				$sql = 'UPDATE ' . POSTS_TABLE . '					SET post_attachment = 1 - post_attachment					WHERE ' . $db->sql_in_set('post_id', $post_ids);				$db->sql_query($sql);			}			$db->sql_transaction('commit');			break;		case 'topic_attachment':			if ($sync_extra)			{				sync('post_attachment', $where_type, $where_ids);			}			$topic_ids = $topic_attachment = array();			$db->sql_transaction('begin');			$sql = 'SELECT DISTINCT(t.topic_id)				FROM ' . POSTS_TABLE . " t				$where_sql_and t.post_attachment = 1";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$topic_attachment[$row['topic_id']] = 1;			}			$db->sql_freeresult($result);			$sql = 'SELECT t.topic_id, t.topic_attachment				FROM ' . TOPICS_TABLE . " t				$where_sql";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				if ($row['topic_attachment'] ^ isset($topic_attachment[$row['topic_id']]))				{					$topic_ids[] = $row['topic_id'];				}			}			$db->sql_freeresult($result);			if (sizeof($topic_ids))			{				$sql = 'UPDATE ' . TOPICS_TABLE . '					SET topic_attachment = 1 - topic_attachment					WHERE ' . $db->sql_in_set('topic_id', $topic_ids);				$db->sql_query($sql);			}			$db->sql_transaction('commit');			break;		case 'forum':			$db->sql_transaction('begin');			// 1: Get the list of all forums			$sql = 'SELECT f.*				FROM ' . FORUMS_TABLE . " f				$where_sql";			$result = $db->sql_query($sql);			$forum_data = $forum_ids = $post_ids = $last_post_id = $post_info = array();			while ($row = $db->sql_fetchrow($result))			{				if ($row['forum_type'] == FORUM_LINK)				{					continue;				}				$forum_id = (int) $row['forum_id'];				$forum_ids[$forum_id] = $forum_id;				$forum_data[$forum_id] = $row;				if ($sync_extra)				{					$forum_data[$forum_id]['posts'] = 0;					$forum_data[$forum_id]['topics'] = 0;					$forum_data[$forum_id]['topics_real'] = 0;				}				$forum_data[$forum_id]['last_post_id'] = 0;				$forum_data[$forum_id]['last_post_subject'] = '';				$forum_data[$forum_id]['last_post_time'] = 0;				$forum_data[$forum_id]['last_poster_id'] = 0;				$forum_data[$forum_id]['last_poster_name'] = '';				$forum_data[$forum_id]['last_poster_colour'] = '';			}			$db->sql_freeresult($result);			if (!sizeof($forum_ids))			{				break;			}			$forum_ids = array_values($forum_ids);			// 2: Get topic counts for each forum (optional)			if ($sync_extra)			{				$sql = 'SELECT forum_id, topic_approved, COUNT(topic_id) AS forum_topics					FROM ' . TOPICS_TABLE . '					WHERE ' . $db->sql_in_set('forum_id', $forum_ids) . '					GROUP BY forum_id, topic_approved';				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$forum_id = (int) $row['forum_id'];					$forum_data[$forum_id]['topics_real'] += $row['forum_topics'];					if ($row['topic_approved'])					{						$forum_data[$forum_id]['topics'] = $row['forum_topics'];					}				}				$db->sql_freeresult($result);			}			// 3: Get post count for each forum (optional)			if ($sync_extra)			{				if (sizeof($forum_ids) == 1)				{					$sql = 'SELECT SUM(t.topic_replies + 1) AS forum_posts						FROM ' . TOPICS_TABLE . ' t						WHERE ' . $db->sql_in_set('t.forum_id', $forum_ids) . '							AND t.topic_approved = 1							AND t.topic_status <> ' . ITEM_MOVED;				}				else				{					$sql = 'SELECT t.forum_id, SUM(t.topic_replies + 1) AS forum_posts						FROM ' . TOPICS_TABLE . ' t						WHERE ' . $db->sql_in_set('t.forum_id', $forum_ids) . '							AND t.topic_approved = 1							AND t.topic_status <> ' . ITEM_MOVED . '						GROUP BY t.forum_id';				}				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$forum_id = (sizeof($forum_ids) == 1) ? (int) $forum_ids[0] : (int) $row['forum_id'];					$forum_data[$forum_id]['posts'] = (int) $row['forum_posts'];				}				$db->sql_freeresult($result);			}			// 4: Get last_post_id for each forum			if (sizeof($forum_ids) == 1)			{				$sql = 'SELECT MAX(t.topic_last_post_id) as last_post_id					FROM ' . TOPICS_TABLE . ' t					WHERE ' . $db->sql_in_set('t.forum_id', $forum_ids) . '						AND t.topic_approved = 1';			}			else			{				$sql = 'SELECT t.forum_id, MAX(t.topic_last_post_id) as last_post_id					FROM ' . TOPICS_TABLE . ' t					WHERE ' . $db->sql_in_set('t.forum_id', $forum_ids) . '						AND t.topic_approved = 1					GROUP BY t.forum_id';			}			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$forum_id = (sizeof($forum_ids) == 1) ? (int) $forum_ids[0] : (int) $row['forum_id'];				$forum_data[$forum_id]['last_post_id'] = (int) $row['last_post_id'];				$post_ids[] = $row['last_post_id'];			}			$db->sql_freeresult($result);			// 5: Retrieve last_post infos			if (sizeof($post_ids))			{				$sql = 'SELECT p.post_id, p.poster_id, p.post_subject, p.post_time, p.post_username, u.username, u.user_colour					FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u					WHERE ' . $db->sql_in_set('p.post_id', $post_ids) . '						AND p.poster_id = u.user_id';				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$post_info[$row['post_id']] = $row;				}				$db->sql_freeresult($result);				foreach ($forum_data as $forum_id => $data)				{					if ($data['last_post_id'])					{						if (isset($post_info[$data['last_post_id']]))						{							$forum_data[$forum_id]['last_post_subject'] = $post_info[$data['last_post_id']]['post_subject'];							$forum_data[$forum_id]['last_post_time'] = $post_info[$data['last_post_id']]['post_time'];							$forum_data[$forum_id]['last_poster_id'] = $post_info[$data['last_post_id']]['poster_id'];							$forum_data[$forum_id]['last_poster_name'] = ($post_info[$data['last_post_id']]['poster_id'] != ANONYMOUS) ? $post_info[$data['last_post_id']]['username'] : $post_info[$data['last_post_id']]['post_username'];							$forum_data[$forum_id]['last_poster_colour'] = $post_info[$data['last_post_id']]['user_colour'];						}						else						{							// For some reason we did not find the post in the db							$forum_data[$forum_id]['last_post_id'] = 0;							$forum_data[$forum_id]['last_post_subject'] = '';							$forum_data[$forum_id]['last_post_time'] = 0;							$forum_data[$forum_id]['last_poster_id'] = 0;							$forum_data[$forum_id]['last_poster_name'] = '';							$forum_data[$forum_id]['last_poster_colour'] = '';						}					}				}				unset($post_info);			}			// 6: Now do that thing			$fieldnames = array('last_post_id', 'last_post_subject', 'last_post_time', 'last_poster_id', 'last_poster_name', 'last_poster_colour');			if ($sync_extra)			{				array_push($fieldnames, 'posts', 'topics', 'topics_real');			}			foreach ($forum_data as $forum_id => $row)			{				$sql_ary = array();				foreach ($fieldnames as $fieldname)				{					if ($row['forum_' . $fieldname] != $row[$fieldname])					{						if (preg_match('#(name|colour|subject)$#', $fieldname))						{							$sql_ary['forum_' . $fieldname] = (string) $row[$fieldname];						}						else						{							$sql_ary['forum_' . $fieldname] = (int) $row[$fieldname];						}					}				}				if (sizeof($sql_ary))				{					$sql = 'UPDATE ' . FORUMS_TABLE . '						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '						WHERE forum_id = ' . $forum_id;					$db->sql_query($sql);				}			}			$db->sql_transaction('commit');			break;		case 'topic':			$topic_data = $post_ids = $approved_unapproved_ids = $resync_forums = $delete_topics = $delete_posts = $moved_topics = array();			$db->sql_transaction('begin');			$sql = 'SELECT t.topic_id, t.forum_id, t.topic_moved_id, t.topic_approved, ' . (($sync_extra) ? 't.topic_attachment, t.topic_reported, ' : '') . 't.topic_poster, t.topic_time, t.topic_replies, t.topic_replies_real, t.topic_first_post_id, t.topic_first_poster_name, t.topic_first_poster_colour, t.topic_last_post_id, t.topic_last_post_subject, t.topic_last_poster_id, t.topic_last_poster_name, t.topic_last_poster_colour, t.topic_last_post_time				FROM ' . TOPICS_TABLE . " t				$where_sql";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				if ($row['topic_moved_id'])				{					$moved_topics[] = $row['topic_id'];					continue;				}				$topic_id = (int) $row['topic_id'];				$topic_data[$topic_id] = $row;				$topic_data[$topic_id]['replies_real'] = -1;				$topic_data[$topic_id]['replies'] = 0;				$topic_data[$topic_id]['first_post_id'] = 0;				$topic_data[$topic_id]['last_post_id'] = 0;				unset($topic_data[$topic_id]['topic_id']);				// This array holds all topic_ids				$delete_topics[$topic_id] = '';				if ($sync_extra)				{					$topic_data[$topic_id]['reported'] = 0;					$topic_data[$topic_id]['attachment'] = 0;				}			}			$db->sql_freeresult($result);			// Use "t" as table alias because of the $where_sql clause			// NOTE: 't.post_approved' in the GROUP BY is causing a major slowdown.			$sql = 'SELECT t.topic_id, t.post_approved, COUNT(t.post_id) AS total_posts, MIN(t.post_id) AS first_post_id, MAX(t.post_id) AS last_post_id				FROM ' . POSTS_TABLE . " t				$where_sql				GROUP BY t.topic_id, t.post_approved";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$topic_id = (int) $row['topic_id'];				$row['first_post_id'] = (int) $row['first_post_id'];				$row['last_post_id'] = (int) $row['last_post_id'];				if (!isset($topic_data[$topic_id]))				{					// Hey, these posts come from a topic that does not exist					$delete_posts[$topic_id] = '';				}				else				{					// Unset the corresponding entry in $delete_topics					// When we'll be done, only topics with no posts will remain					unset($delete_topics[$topic_id]);					$topic_data[$topic_id]['replies_real'] += $row['total_posts'];					$topic_data[$topic_id]['first_post_id'] = (!$topic_data[$topic_id]['first_post_id']) ? $row['first_post_id'] : min($topic_data[$topic_id]['first_post_id'], $row['first_post_id']);					if ($row['post_approved'] || !$topic_data[$topic_id]['last_post_id'])					{						$topic_data[$topic_id]['replies'] = $row['total_posts'] - 1;						$topic_data[$topic_id]['last_post_id'] = $row['last_post_id'];					}				}			}			$db->sql_freeresult($result);			foreach ($topic_data as $topic_id => $row)			{				$post_ids[] = $row['first_post_id'];				if ($row['first_post_id'] != $row['last_post_id'])				{					$post_ids[] = $row['last_post_id'];				}			}			// Now we delete empty topics and orphan posts			if (sizeof($delete_posts))			{				delete_posts('topic_id', array_keys($delete_posts), false);				unset($delete_posts);			}			if (!sizeof($topic_data))			{				// If we get there, topic ids were invalid or topics did not contain any posts				delete_topics($where_type, $where_ids, true);				return;			}			if (sizeof($delete_topics))			{				$delete_topic_ids = array();				foreach ($delete_topics as $topic_id => $void)				{					unset($topic_data[$topic_id]);					$delete_topic_ids[] = $topic_id;				}				delete_topics('topic_id', $delete_topic_ids, false);				unset($delete_topics, $delete_topic_ids);			}			$sql = 'SELECT p.post_id, p.topic_id, p.post_approved, p.poster_id, p.post_subject, p.post_username, p.post_time, u.username, u.user_colour				FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u				WHERE ' . $db->sql_in_set('p.post_id', $post_ids) . '					AND u.user_id = p.poster_id';			$result = $db->sql_query($sql);			$post_ids = array();			while ($row = $db->sql_fetchrow($result))			{				$topic_id = intval($row['topic_id']);				if ($row['post_id'] == $topic_data[$topic_id]['first_post_id'])				{					if ($topic_data[$topic_id]['topic_approved'] != $row['post_approved'])					{						$approved_unapproved_ids[] = $topic_id;					}					$topic_data[$topic_id]['time'] = $row['post_time'];					$topic_data[$topic_id]['poster'] = $row['poster_id'];					$topic_data[$topic_id]['first_poster_name'] = ($row['poster_id'] == ANONYMOUS) ? $row['post_username'] : $row['username'];					$topic_data[$topic_id]['first_poster_colour'] = $row['user_colour'];				}				if ($row['post_id'] == $topic_data[$topic_id]['last_post_id'])				{					$topic_data[$topic_id]['last_poster_id'] = $row['poster_id'];					$topic_data[$topic_id]['last_post_subject'] = $row['post_subject'];					$topic_data[$topic_id]['last_post_time'] = $row['post_time'];					$topic_data[$topic_id]['last_poster_name'] = ($row['poster_id'] == ANONYMOUS) ? $row['post_username'] : $row['username'];					$topic_data[$topic_id]['last_poster_colour'] = $row['user_colour'];				}			}			$db->sql_freeresult($result);			// Make sure shadow topics do link to existing topics			if (sizeof($moved_topics))			{				$delete_topics = array();				$sql = 'SELECT t1.topic_id, t1.topic_moved_id					FROM ' . TOPICS_TABLE . ' t1					LEFT JOIN ' . TOPICS_TABLE . ' t2 ON (t2.topic_id = t1.topic_moved_id)					WHERE ' . $db->sql_in_set('t1.topic_id', $moved_topics) . '						AND t2.topic_id IS NULL';				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$delete_topics[] = $row['topic_id'];				}				$db->sql_freeresult($result);				if (sizeof($delete_topics))				{					delete_topics('topic_id', $delete_topics, false);				}				unset($delete_topics);				// Make sure shadow topics having no last post data being updated (this only rarely happens...)				$sql = 'SELECT topic_id, topic_moved_id, topic_last_post_id, topic_first_post_id					FROM ' . TOPICS_TABLE . '					WHERE ' . $db->sql_in_set('topic_id', $moved_topics) . '						AND topic_last_post_time = 0';				$result = $db->sql_query($sql);				$shadow_topic_data = $post_ids = array();				while ($row = $db->sql_fetchrow($result))				{					$shadow_topic_data[$row['topic_moved_id']] = $row;					$post_ids[] = $row['topic_last_post_id'];					$post_ids[] = $row['topic_first_post_id'];				}				$db->sql_freeresult($result);				$sync_shadow_topics = array();				if (sizeof($post_ids))				{					$sql = 'SELECT p.post_id, p.topic_id, p.post_approved, p.poster_id, p.post_subject, p.post_username, p.post_time, u.username, u.user_colour						FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u						WHERE ' . $db->sql_in_set('p.post_id', $post_ids) . '							AND u.user_id = p.poster_id';					$result = $db->sql_query($sql);					$post_ids = array();					while ($row = $db->sql_fetchrow($result))					{						$topic_id = (int) $row['topic_id'];						// Ok, there should be a shadow topic. If there isn't, then there's something wrong with the db.						// However, there's not much we can do about it.						if (!empty($shadow_topic_data[$topic_id]))						{							if ($row['post_id'] == $shadow_topic_data[$topic_id]['topic_first_post_id'])							{								$orig_topic_id = $shadow_topic_data[$topic_id]['topic_id'];								if (!isset($sync_shadow_topics[$orig_topic_id]))								{									$sync_shadow_topics[$orig_topic_id] = array();								}								$sync_shadow_topics[$orig_topic_id]['topic_time'] = $row['post_time'];								$sync_shadow_topics[$orig_topic_id]['topic_poster'] = $row['poster_id'];								$sync_shadow_topics[$orig_topic_id]['topic_first_poster_name'] = ($row['poster_id'] == ANONYMOUS) ? $row['post_username'] : $row['username'];								$sync_shadow_topics[$orig_topic_id]['topic_first_poster_colour'] = $row['user_colour'];							}							if ($row['post_id'] == $shadow_topic_data[$topic_id]['topic_last_post_id'])							{								$orig_topic_id = $shadow_topic_data[$topic_id]['topic_id'];								if (!isset($sync_shadow_topics[$orig_topic_id]))								{									$sync_shadow_topics[$orig_topic_id] = array();								}								$sync_shadow_topics[$orig_topic_id]['topic_last_poster_id'] = $row['poster_id'];								$sync_shadow_topics[$orig_topic_id]['topic_last_post_subject'] = $row['post_subject'];								$sync_shadow_topics[$orig_topic_id]['topic_last_post_time'] = $row['post_time'];								$sync_shadow_topics[$orig_topic_id]['topic_last_poster_name'] = ($row['poster_id'] == ANONYMOUS) ? $row['post_username'] : $row['username'];								$sync_shadow_topics[$orig_topic_id]['topic_last_poster_colour'] = $row['user_colour'];							}						}					}					$db->sql_freeresult($result);					$shadow_topic_data = array();					// Update the information we collected					if (sizeof($sync_shadow_topics))					{						foreach ($sync_shadow_topics as $sync_topic_id => $sql_ary)						{							$sql = 'UPDATE ' . TOPICS_TABLE . '								SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '								WHERE topic_id = ' . $sync_topic_id;							$db->sql_query($sql);						}					}				}				unset($sync_shadow_topics, $shadow_topic_data);			}			// approved becomes unapproved, and vice-versa			if (sizeof($approved_unapproved_ids))			{				$sql = 'UPDATE ' . TOPICS_TABLE . '					SET topic_approved = 1 - topic_approved					WHERE ' . $db->sql_in_set('topic_id', $approved_unapproved_ids);				$db->sql_query($sql);			}			unset($approved_unapproved_ids);			// These are fields that will be synchronised			$fieldnames = array('time', 'replies', 'replies_real', 'poster', 'first_post_id', 'first_poster_name', 'first_poster_colour', 'last_post_id', 'last_post_subject', 'last_post_time', 'last_poster_id', 'last_poster_name', 'last_poster_colour');			if ($sync_extra)			{				// This routine assumes that post_reported values are correct				// if they are not, use sync('post_reported') first				$sql = 'SELECT t.topic_id, p.post_id					FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p					$where_sql_and p.topic_id = t.topic_id						AND p.post_reported = 1					GROUP BY t.topic_id, p.post_id";				$result = $db->sql_query($sql);				$fieldnames[] = 'reported';				while ($row = $db->sql_fetchrow($result))				{					$topic_data[intval($row['topic_id'])]['reported'] = 1;				}				$db->sql_freeresult($result);				// This routine assumes that post_attachment values are correct				// if they are not, use sync('post_attachment') first				$sql = 'SELECT t.topic_id, p.post_id					FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p					$where_sql_and p.topic_id = t.topic_id						AND p.post_attachment = 1					GROUP BY t.topic_id, p.post_id";				$result = $db->sql_query($sql);				$fieldnames[] = 'attachment';				while ($row = $db->sql_fetchrow($result))				{					$topic_data[intval($row['topic_id'])]['attachment'] = 1;				}				$db->sql_freeresult($result);			}			foreach ($topic_data as $topic_id => $row)			{				$sql_ary = array();				foreach ($fieldnames as $fieldname)				{					if (isset($row[$fieldname]) && isset($row['topic_' . $fieldname]) && $row['topic_' . $fieldname] != $row[$fieldname])					{						$sql_ary['topic_' . $fieldname] = $row[$fieldname];					}				}				if (sizeof($sql_ary))				{					$sql = 'UPDATE ' . TOPICS_TABLE . '						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '						WHERE topic_id = ' . $topic_id;					$db->sql_query($sql);					$resync_forums[$row['forum_id']] = $row['forum_id'];				}			}			unset($topic_data);			$db->sql_transaction('commit');			// if some topics have been resync'ed then resync parent forums			// except when we're only syncing a range, we don't want to sync forums during			// batch processing.			if ($resync_parents && sizeof($resync_forums) && $where_type != 'range')			{				sync('forum', 'forum_id', array_values($resync_forums), true, true);			}			break;	}	return;}/*** Prune function*/function prune($forum_id, $prune_mode, $prune_date, $prune_flags = 0, $auto_sync = true){	global $db;	if (!is_array($forum_id))	{		$forum_id = array($forum_id);	}	if (!sizeof($forum_id))	{		return;	}	$sql_and = '';	if (!($prune_flags & FORUM_FLAG_PRUNE_ANNOUNCE))	{		$sql_and .= ' AND topic_type <> ' . POST_ANNOUNCE;	}	if (!($prune_flags & FORUM_FLAG_PRUNE_STICKY))	{		$sql_and .= ' AND topic_type <> ' . POST_STICKY;	}	if ($prune_mode == 'posted')	{		$sql_and .= " AND topic_last_post_time < $prune_date";	}	if ($prune_mode == 'viewed')	{		$sql_and .= " AND topic_last_view_time < $prune_date";	}	$sql = 'SELECT topic_id		FROM ' . TOPICS_TABLE . '		WHERE ' . $db->sql_in_set('forum_id', $forum_id) . "			AND poll_start = 0			$sql_and";	$result = $db->sql_query($sql);	$topic_list = array();	while ($row = $db->sql_fetchrow($result))	{		$topic_list[] = $row['topic_id'];	}	$db->sql_freeresult($result);	if ($prune_flags & FORUM_FLAG_PRUNE_POLL)	{		$sql = 'SELECT topic_id			FROM ' . TOPICS_TABLE . '			WHERE ' . $db->sql_in_set('forum_id', $forum_id) . "				AND poll_start > 0				AND poll_last_vote < $prune_date				$sql_and";		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$topic_list[] = $row['topic_id'];		}		$db->sql_freeresult($result);		$topic_list = array_unique($topic_list);	}	return delete_topics('topic_id', $topic_list, $auto_sync, false);}/*** Function auto_prune(), this function now relies on passed vars*/function auto_prune($forum_id, $prune_mode, $prune_flags, $prune_days, $prune_freq){	global $db;	$sql = 'SELECT forum_name		FROM ' . FORUMS_TABLE . "		WHERE forum_id = $forum_id";	$result = $db->sql_query($sql, 3600);	$row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if ($row)	{		$prune_date = time() - ($prune_days * 86400);		$next_prune = time() + ($prune_freq * 86400);		prune($forum_id, $prune_mode, $prune_date, $prune_flags, true);		$sql = 'UPDATE ' . FORUMS_TABLE . "			SET prune_next = $next_prune			WHERE forum_id = $forum_id";		$db->sql_query($sql);		add_log('admin', 'LOG_AUTO_PRUNE', $row['forum_name']);	}	return;}/*** remove_comments will strip the sql comment lines out of an uploaded sql file* specifically for mssql and postgres type files in the install....*/function remove_comments(&$output){	$lines = explode("\n", $output);	$output = '';	// try to keep mem. use down	$linecount = sizeof($lines);	$in_comment = false;	for ($i = 0; $i < $linecount; $i++)	{		if (trim($lines[$i]) == '/*')		{			$in_comment = true;		}		if (!$in_comment)		{			$output .= $lines[$i] . "\n";		}		if (trim($lines[$i]) == '*/')		{			$in_comment = false;		}	}	unset($lines);	return $output;}/*** Cache moderators, called whenever permissions are changed via admin_permissions. Changes of username* and group names must be carried through for the moderators table*/function cache_moderators(){	global $db, $cache, $auth, $phpbb_root_path, $phpEx;	// Remove cached sql results	$cache->destroy('sql', MODERATOR_CACHE_TABLE);	// Clear table	switch ($db->sql_layer)	{		case 'sqlite':		case 'firebird':			$db->sql_query('DELETE FROM ' . MODERATOR_CACHE_TABLE);		break;		default:			$db->sql_query('TRUNCATE TABLE ' . MODERATOR_CACHE_TABLE);		break;	}	// We add moderators who have forum moderator permissions without an explicit ACL_NEVER setting	$hold_ary = $ug_id_ary = $sql_ary = array();	// Grab all users having moderative options...	$hold_ary = $auth->acl_user_raw_data(false, 'm_%', false);	// Add users?	if (sizeof($hold_ary))	{		// At least one moderative option warrants a display		$ug_id_ary = array_keys($hold_ary);		// Remove users who have group memberships with DENY moderator permissions		$sql = $db->sql_build_query('SELECT', array(			'SELECT'	=> 'a.forum_id, ug.user_id, g.group_id',			'FROM'		=> array(				ACL_OPTIONS_TABLE	=> 'o',				USER_GROUP_TABLE	=> 'ug',				GROUPS_TABLE		=> 'g',				ACL_GROUPS_TABLE	=> 'a',			),			'LEFT_JOIN'	=> array(				array(					'FROM'	=> array(ACL_ROLES_DATA_TABLE => 'r'),					'ON'	=> 'a.auth_role_id = r.role_id'				)			),			'WHERE'		=> '(o.auth_option_id = a.auth_option_id OR o.auth_option_id = r.auth_option_id)				AND ((a.auth_setting = ' . ACL_NEVER . ' AND r.auth_setting IS NULL)					OR r.auth_setting = ' . ACL_NEVER . ')				AND a.group_id = ug.group_id				AND g.group_id = ug.group_id				AND NOT (ug.group_leader = 1 AND g.group_skip_auth = 1)				AND ' . $db->sql_in_set('ug.user_id', $ug_id_ary) . "				AND ug.user_pending = 0				AND o.auth_option " . $db->sql_like_expression('m_' . $db->any_char),		));		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			if (isset($hold_ary[$row['user_id']][$row['forum_id']]))			{				unset($hold_ary[$row['user_id']][$row['forum_id']]);			}		}		$db->sql_freeresult($result);		if (sizeof($hold_ary))		{			// Get usernames...			$sql = 'SELECT user_id, username				FROM ' . USERS_TABLE . '				WHERE ' . $db->sql_in_set('user_id', array_keys($hold_ary));			$result = $db->sql_query($sql);			$usernames_ary = array();			while ($row = $db->sql_fetchrow($result))			{				$usernames_ary[$row['user_id']] = $row['username'];			}			foreach ($hold_ary as $user_id => $forum_id_ary)			{				// Do not continue if user does not exist				if (!isset($usernames_ary[$user_id]))				{					continue;				}				foreach ($forum_id_ary as $forum_id => $auth_ary)				{					$sql_ary[] = array(						'forum_id'		=> (int) $forum_id,						'user_id'		=> (int) $user_id,						'username'		=> (string) $usernames_ary[$user_id],						'group_id'		=> 0,						'group_name'	=> ''					);				}			}		}	}	// Now to the groups...	$hold_ary = $auth->acl_group_raw_data(false, 'm_%', false);	if (sizeof($hold_ary))	{		$ug_id_ary = array_keys($hold_ary);		// Make sure not hidden or special groups are involved...		$sql = 'SELECT group_name, group_id, group_type			FROM ' . GROUPS_TABLE . '			WHERE ' . $db->sql_in_set('group_id', $ug_id_ary);		$result = $db->sql_query($sql);		$groupnames_ary = array();		while ($row = $db->sql_fetchrow($result))		{			if ($row['group_type'] == GROUP_HIDDEN || $row['group_type'] == GROUP_SPECIAL)			{				unset($hold_ary[$row['group_id']]);			}			$groupnames_ary[$row['group_id']] = $row['group_name'];		}		$db->sql_freeresult($result);		foreach ($hold_ary as $group_id => $forum_id_ary)		{			// If there is no group, we do not assign it...			if (!isset($groupnames_ary[$group_id]))			{				continue;			}			foreach ($forum_id_ary as $forum_id => $auth_ary)			{				$flag = false;				foreach ($auth_ary as $auth_option => $setting)				{					// Make sure at least one ACL_YES option is set...					if ($setting == ACL_YES)					{						$flag = true;						break;					}				}				if (!$flag)				{					continue;				}				$sql_ary[] = array(					'forum_id'		=> (int) $forum_id,					'user_id'		=> 0,					'username'		=> '',					'group_id'		=> (int) $group_id,					'group_name'	=> (string) $groupnames_ary[$group_id]				);			}		}	}	$db->sql_multi_insert(MODERATOR_CACHE_TABLE, $sql_ary);}/*** View log* If $log_count is set to false, we will skip counting all entries in the database.*/function view_log($mode, &$log, &$log_count, $limit = 0, $offset = 0, $forum_id = 0, $topic_id = 0, $user_id = 0, $limit_days = 0, $sort_by = 'l.log_time DESC', $keywords = ''){	global $db, $user, $auth, $phpEx, $phpbb_root_path, $phpbb_admin_path;	$topic_id_list = $reportee_id_list = $is_auth = $is_mod = array();	$profile_url = (defined('IN_ADMIN')) ? append_sid("{$phpbb_admin_path}index.$phpEx", 'i=users&amp;mode=overview') : append_sid("{$phpbb_root_path}memberlist.$phpEx", 'mode=viewprofile');	switch ($mode)	{		case 'admin':			$log_type = LOG_ADMIN;			$sql_forum = '';		break;		case 'mod':			$log_type = LOG_MOD;			$sql_forum = '';			if ($topic_id)			{				$sql_forum = 'AND l.topic_id = ' . (int) $topic_id;			}			else if (is_array($forum_id))			{				$sql_forum = 'AND ' . $db->sql_in_set('l.forum_id', array_map('intval', $forum_id));			}			else if ($forum_id)			{				$sql_forum = 'AND l.forum_id = ' . (int) $forum_id;			}		break;		case 'user':			$log_type = LOG_USERS;			$sql_forum = 'AND l.reportee_id = ' . (int) $user_id;		break;		case 'users':			$log_type = LOG_USERS;			$sql_forum = '';		break;		case 'critical':			$log_type = LOG_CRITICAL;			$sql_forum = '';		break;		default:			return;	}	// Use no preg_quote for $keywords because this would lead to sole backslashes being added	// We also use an OR connection here for spaces and the | string. Currently, regex is not supported for searching (but may come later).	$keywords = preg_split('#[\s|]+#u', utf8_strtolower($keywords), 0, PREG_SPLIT_NO_EMPTY);	$sql_keywords = '';	if (!empty($keywords))	{		$keywords_pattern = array();		// Build pattern and keywords...		for ($i = 0, $num_keywords = sizeof($keywords); $i < $num_keywords; $i++)		{			$keywords_pattern[] = preg_quote($keywords[$i], '#');			$keywords[$i] = $db->sql_like_expression($db->any_char . $keywords[$i] . $db->any_char);		}		$keywords_pattern = '#' . implode('|', $keywords_pattern) . '#ui';		$operations = array();		foreach ($user->lang as $key => $value)		{			if (substr($key, 0, 4) == 'LOG_' && preg_match($keywords_pattern, $value))			{				$operations[] = $key;			}		}		$sql_keywords = 'AND (';		if (!empty($operations))		{			$sql_keywords .= $db->sql_in_set('l.log_operation', $operations) . ' OR ';		}		$sql_keywords .= 'LOWER(l.log_data) ' . implode(' OR LOWER(l.log_data) ', $keywords) . ')';	}	if ($log_count !== false)	{		$sql = 'SELECT COUNT(l.log_id) AS total_entries			FROM ' . LOG_TABLE . ' l, ' . USERS_TABLE . " u			WHERE l.log_type = $log_type				AND l.user_id = u.user_id				AND l.log_time >= $limit_days				$sql_keywords				$sql_forum";		$result = $db->sql_query($sql);		$log_count = (int) $db->sql_fetchfield('total_entries');		$db->sql_freeresult($result);	}	// $log_count may be false here if false was passed in for it,	// because in this case we did not run the COUNT() query above.	// If we ran the COUNT() query and it returned zero rows, return;	// otherwise query for logs below.	if ($log_count === 0)	{		// Save the queries, because there are no logs to display		return 0;	}	if ($offset >= $log_count)	{		$offset = ($offset - $limit < 0) ? 0 : $offset - $limit;	}	$sql = "SELECT l.*, u.username, u.username_clean, u.user_colour		FROM " . LOG_TABLE . " l, " . USERS_TABLE . " u		WHERE l.log_type = $log_type			AND u.user_id = l.user_id			" . (($limit_days) ? "AND l.log_time >= $limit_days" : '') . "			$sql_keywords			$sql_forum		ORDER BY $sort_by";	$result = $db->sql_query_limit($sql, $limit, $offset);	$i = 0;	$log = array();	while ($row = $db->sql_fetchrow($result))	{		if ($row['topic_id'])		{			$topic_id_list[] = $row['topic_id'];		}		if ($row['reportee_id'])		{			$reportee_id_list[] = $row['reportee_id'];		}		$log[$i] = array(			'id'				=> $row['log_id'],			'reportee_id'			=> $row['reportee_id'],			'reportee_username'		=> '',			'reportee_username_full'=> '',			'user_id'			=> $row['user_id'],			'username'			=> $row['username'],			'username_full'		=> get_username_string('full', $row['user_id'], $row['username'], $row['user_colour'], false, $profile_url),			'ip'				=> $row['log_ip'],			'time'				=> $row['log_time'],			'forum_id'			=> $row['forum_id'],			'topic_id'			=> $row['topic_id'],			'viewforum'			=> ($row['forum_id'] && $auth->acl_get('f_read', $row['forum_id'])) ? append_sid("{$phpbb_root_path}viewforum.$phpEx", 'f=' . $row['forum_id']) : false,			'action'			=> (isset($user->lang[$row['log_operation']])) ? $user->lang[$row['log_operation']] : '{' . ucfirst(str_replace('_', ' ', $row['log_operation'])) . '}',		);		if (!empty($row['log_data']))		{			$log_data_ary = @unserialize($row['log_data']);			$log_data_ary = ($log_data_ary === false) ? array() : $log_data_ary;			if (isset($user->lang[$row['log_operation']]))			{				// Check if there are more occurrences of % than arguments, if there are we fill out the arguments array				// It doesn't matter if we add more arguments than placeholders				if ((substr_count($log[$i]['action'], '%') - sizeof($log_data_ary)) > 0)				{					$log_data_ary = array_merge($log_data_ary, array_fill(0, substr_count($log[$i]['action'], '%') - sizeof($log_data_ary), ''));				}				$log[$i]['action'] = vsprintf($log[$i]['action'], $log_data_ary);				// If within the admin panel we do not censor text out				if (defined('IN_ADMIN'))				{					$log[$i]['action'] = bbcode_nl2br($log[$i]['action']);				}				else				{					$log[$i]['action'] = bbcode_nl2br(censor_text($log[$i]['action']));				}			}			else if (!empty($log_data_ary))			{				$log[$i]['action'] .= '<br />' . implode('', $log_data_ary);			}			/* Apply make_clickable... has to be seen if it is for good. :/			// Seems to be not for the moment, reconsider later...			$log[$i]['action'] = make_clickable($log[$i]['action']);			*/		}		$i++;	}	$db->sql_freeresult($result);	if (sizeof($topic_id_list))	{		$topic_id_list = array_unique($topic_id_list);		// This query is not really needed if move_topics() updates the forum_id field,		// although it's also used to determine if the topic still exists in the database		$sql = 'SELECT topic_id, forum_id			FROM ' . TOPICS_TABLE . '			WHERE ' . $db->sql_in_set('topic_id', array_map('intval', $topic_id_list));		$result = $db->sql_query($sql);		$default_forum_id = 0;		while ($row = $db->sql_fetchrow($result))		{			if (!$row['forum_id'])			{				if ($auth->acl_getf_global('f_read'))				{					if (!$default_forum_id)					{						$sql = 'SELECT forum_id							FROM ' . FORUMS_TABLE . '							WHERE forum_type = ' . FORUM_POST;						$f_result = $db->sql_query_limit($sql, 1);						$default_forum_id = (int) $db->sql_fetchfield('forum_id', false, $f_result);						$db->sql_freeresult($f_result);					}					$is_auth[$row['topic_id']] = $default_forum_id;				}			}			else			{				if ($auth->acl_get('f_read', $row['forum_id']))				{					$is_auth[$row['topic_id']] = $row['forum_id'];				}			}			if ($auth->acl_gets('a_', 'm_', $row['forum_id']))			{				$is_mod[$row['topic_id']] = $row['forum_id'];			}		}		$db->sql_freeresult($result);		foreach ($log as $key => $row)		{			$log[$key]['viewtopic'] = (isset($is_auth[$row['topic_id']])) ? append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $is_auth[$row['topic_id']] . '&amp;t=' . $row['topic_id']) : false;			$log[$key]['viewlogs'] = (isset($is_mod[$row['topic_id']])) ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=logs&amp;mode=topic_logs&amp;t=' . $row['topic_id'], true, $user->session_id) : false;		}	}	if (sizeof($reportee_id_list))	{		$reportee_id_list = array_unique($reportee_id_list);		$reportee_names_list = array();		$sql = 'SELECT user_id, username, user_colour			FROM ' . USERS_TABLE . '			WHERE ' . $db->sql_in_set('user_id', $reportee_id_list);		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$reportee_names_list[$row['user_id']] = $row;		}		$db->sql_freeresult($result);		foreach ($log as $key => $row)		{			if (!isset($reportee_names_list[$row['reportee_id']]))			{				continue;			}			$log[$key]['reportee_username'] = $reportee_names_list[$row['reportee_id']]['username'];			$log[$key]['reportee_username_full'] = get_username_string('full', $row['reportee_id'], $reportee_names_list[$row['reportee_id']]['username'], $reportee_names_list[$row['reportee_id']]['user_colour'], false, $profile_url);		}	}	return $offset;}/*** Update foes - remove moderators and administrators from foe lists...*/function update_foes($group_id = false, $user_id = false){	global $db, $auth;	// update foes for some user	if (is_array($user_id) && sizeof($user_id))	{		$sql = 'DELETE FROM ' . ZEBRA_TABLE . '			WHERE ' . $db->sql_in_set('zebra_id', $user_id) . '				AND foe = 1';		$db->sql_query($sql);		return;	}	// update foes for some group	if (is_array($group_id) && sizeof($group_id))	{		// Grab group settings...		$sql = $db->sql_build_query('SELECT', array(			'SELECT'	=> 'a.group_id',			'FROM'		=> array(				ACL_OPTIONS_TABLE	=> 'ao',				ACL_GROUPS_TABLE	=> 'a'			),			'LEFT_JOIN'	=> array(				array(					'FROM'	=> array(ACL_ROLES_DATA_TABLE => 'r'),					'ON'	=> 'a.auth_role_id = r.role_id'				),			),			'WHERE'		=> '(ao.auth_option_id = a.auth_option_id OR ao.auth_option_id = r.auth_option_id)				AND ' . $db->sql_in_set('a.group_id', $group_id) . "				AND ao.auth_option IN ('a_', 'm_')",			'GROUP_BY'	=> 'a.group_id'		));		$result = $db->sql_query($sql);		$groups = array();		while ($row = $db->sql_fetchrow($result))		{			$groups[] = (int) $row['group_id'];		}		$db->sql_freeresult($result);		if (!sizeof($groups))		{			return;		}		switch ($db->sql_layer)		{			case 'mysqli':			case 'mysql4':				$sql = 'DELETE ' . (($db->sql_layer === 'mysqli' || version_compare($db->sql_server_info(true), '4.1', '>=')) ? 'z.*' : ZEBRA_TABLE) . '					FROM ' . ZEBRA_TABLE . ' z, ' . USER_GROUP_TABLE . ' ug					WHERE z.zebra_id = ug.user_id						AND z.foe = 1						AND ' . $db->sql_in_set('ug.group_id', $groups);				$db->sql_query($sql);			break;			default:				$sql = 'SELECT user_id					FROM ' . USER_GROUP_TABLE . '					WHERE ' . $db->sql_in_set('group_id', $groups);				$result = $db->sql_query($sql);				$users = array();				while ($row = $db->sql_fetchrow($result))				{					$users[] = (int) $row['user_id'];				}				$db->sql_freeresult($result);				if (sizeof($users))				{					$sql = 'DELETE FROM ' . ZEBRA_TABLE . '						WHERE ' . $db->sql_in_set('zebra_id', $users) . '							AND foe = 1';					$db->sql_query($sql);				}			break;		}		return;	}	// update foes for everyone	$perms = array();	foreach ($auth->acl_get_list(false, array('a_', 'm_'), false) as $forum_id => $forum_ary)	{		foreach ($forum_ary as $auth_option => $user_ary)		{			$perms = array_merge($perms, $user_ary);		}	}	if (sizeof($perms))	{		$sql = 'DELETE FROM ' . ZEBRA_TABLE . '			WHERE ' . $db->sql_in_set('zebra_id', array_unique($perms)) . '				AND foe = 1';		$db->sql_query($sql);	}	unset($perms);}/*** Lists inactive users*/function view_inactive_users(&$users, &$user_count, $limit = 0, $offset = 0, $limit_days = 0, $sort_by = 'user_inactive_time DESC'){	global $db, $user;	$sql = 'SELECT COUNT(user_id) AS user_count		FROM ' . USERS_TABLE . '		WHERE user_type = ' . USER_INACTIVE .		(($limit_days) ? " AND user_inactive_time >= $limit_days" : '');	$result = $db->sql_query($sql);	$user_count = (int) $db->sql_fetchfield('user_count');	$db->sql_freeresult($result);	if ($user_count == 0)	{		// Save the queries, because there are no users to display		return 0;	}	if ($offset >= $user_count)	{		$offset = ($offset - $limit < 0) ? 0 : $offset - $limit;	}	$sql = 'SELECT *		FROM ' . USERS_TABLE . '		WHERE user_type = ' . USER_INACTIVE .		(($limit_days) ? " AND user_inactive_time >= $limit_days" : '') . "		ORDER BY $sort_by";	$result = $db->sql_query_limit($sql, $limit, $offset);	while ($row = $db->sql_fetchrow($result))	{		$row['inactive_reason'] = $user->lang['INACTIVE_REASON_UNKNOWN'];		switch ($row['user_inactive_reason'])		{			case INACTIVE_REGISTER:				$row['inactive_reason'] = $user->lang['INACTIVE_REASON_REGISTER'];			break;			case INACTIVE_PROFILE:				$row['inactive_reason'] = $user->lang['INACTIVE_REASON_PROFILE'];			break;			case INACTIVE_MANUAL:				$row['inactive_reason'] = $user->lang['INACTIVE_REASON_MANUAL'];			break;			case INACTIVE_REMIND:				$row['inactive_reason'] = $user->lang['INACTIVE_REASON_REMIND'];			break;		}		$users[] = $row;	}	return $offset;}/*** Lists warned users*/function view_warned_users(&$users, &$user_count, $limit = 0, $offset = 0, $limit_days = 0, $sort_by = 'user_warnings DESC'){	global $db;	$sql = 'SELECT user_id, username, user_colour, user_warnings, user_last_warning		FROM ' . USERS_TABLE . '		WHERE user_warnings > 0		' . (($limit_days) ? "AND user_last_warning >= $limit_days" : '') . "		ORDER BY $sort_by";	$result = $db->sql_query_limit($sql, $limit, $offset);	$users = $db->sql_fetchrowset($result);	$db->sql_freeresult($result);	$sql = 'SELECT count(user_id) AS user_count		FROM ' . USERS_TABLE . '		WHERE user_warnings > 0		' . (($limit_days) ? "AND user_last_warning >= $limit_days" : '');	$result = $db->sql_query($sql);	$user_count = (int) $db->sql_fetchfield('user_count');	$db->sql_freeresult($result);	return;}/*** Get database size* Currently only mysql and mssql are supported*/function get_database_size(){	global $db, $user, $table_prefix;	$database_size = false;	// This code is heavily influenced by a similar routine in phpMyAdmin 2.2.0	switch ($db->sql_layer)	{		case 'mysql':		case 'mysql4':		case 'mysqli':			$sql = 'SELECT VERSION() AS mysql_version';			$result = $db->sql_query($sql);			$row = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			if ($row)			{				$version = $row['mysql_version'];				if (preg_match('#(3\.23|[45]\.)#', $version))				{					$db_name = (preg_match('#^(?:3\.23\.(?:[6-9]|[1-9]{2}))|[45]\.#', $version)) ? "`{$db->dbname}`" : $db->dbname;					$sql = 'SHOW TABLE STATUS						FROM ' . $db_name;					$result = $db->sql_query($sql, 7200);					$database_size = 0;					while ($row = $db->sql_fetchrow($result))					{						if ((isset($row['Type']) && $row['Type'] != 'MRG_MyISAM') || (isset($row['Engine']) && ($row['Engine'] == 'MyISAM' || $row['Engine'] == 'InnoDB')))						{							if ($table_prefix != '')							{								if (strpos($row['Name'], $table_prefix) !== false)								{									$database_size += $row['Data_length'] + $row['Index_length'];								}							}							else							{								$database_size += $row['Data_length'] + $row['Index_length'];							}						}					}					$db->sql_freeresult($result);				}			}		break;		case 'firebird':			global $dbname;			// if it on the local machine, we can get lucky			if (file_exists($dbname))			{				$database_size = filesize($dbname);			}		break;		case 'sqlite':			global $dbhost;			if (file_exists($dbhost))			{				$database_size = filesize($dbhost);			}		break;		case 'mssql':		case 'mssql_odbc':		case 'mssqlnative':			$sql = 'SELECT ((SUM(size) * 8.0) * 1024.0) as dbsize				FROM sysfiles';			$result = $db->sql_query($sql, 7200);			$database_size = ($row = $db->sql_fetchrow($result)) ? $row['dbsize'] : false;			$db->sql_freeresult($result);		break;		case 'postgres':			$sql = "SELECT proname				FROM pg_proc				WHERE proname = 'pg_database_size'";			$result = $db->sql_query($sql);			$row = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			if ($row['proname'] == 'pg_database_size')			{				$database = $db->dbname;				if (strpos($database, '.') !== false)				{					list($database, ) = explode('.', $database);				}				$sql = "SELECT oid					FROM pg_database					WHERE datname = '$database'";				$result = $db->sql_query($sql);				$row = $db->sql_fetchrow($result);				$db->sql_freeresult($result);				$oid = $row['oid'];				$sql = 'SELECT pg_database_size(' . $oid . ') as size';				$result = $db->sql_query($sql);				$row = $db->sql_fetchrow($result);				$db->sql_freeresult($result);				$database_size = $row['size'];			}		break;		case 'oracle':			$sql = 'SELECT SUM(bytes) as dbsize				FROM user_segments';			$result = $db->sql_query($sql, 7200);			$database_size = ($row = $db->sql_fetchrow($result)) ? $row['dbsize'] : false;			$db->sql_freeresult($result);		break;	}	$database_size = ($database_size !== false) ? get_formatted_filesize($database_size) : $user->lang['NOT_AVAILABLE'];	return $database_size;}/*** Retrieve contents from remotely stored file*/function get_remote_file($host, $directory, $filename, &$errstr, &$errno, $port = 80, $timeout = 6){	global $user;	if ($fsock = @fsockopen($host, $port, $errno, $errstr, $timeout))	{		@fputs($fsock, "GET $directory/$filename HTTP/1.1\r\n");		@fputs($fsock, "HOST: $host\r\n");		@fputs($fsock, "Connection: close\r\n\r\n");		$timer_stop = time() + $timeout;		stream_set_timeout($fsock, $timeout);		$file_info = '';		$get_info = false;		while (!@feof($fsock))		{			if ($get_info)			{				$file_info .= @fread($fsock, 1024);			}			else			{				$line = @fgets($fsock, 1024);				if ($line == "\r\n")				{					$get_info = true;				}				else if (stripos($line, '404 not found') !== false)				{					$errstr = $user->lang['FILE_NOT_FOUND'] . ': ' . $filename;					return false;				}			}			$stream_meta_data = stream_get_meta_data($fsock);			if (!empty($stream_meta_data['timed_out']) || time() >= $timer_stop)			{				$errstr = $user->lang['FSOCK_TIMEOUT'];				return false;			}		}		@fclose($fsock);	}	else	{		if ($errstr)		{			$errstr = utf8_convert_message($errstr);			return false;		}		else		{			$errstr = $user->lang['FSOCK_DISABLED'];			return false;		}	}	return $file_info;}/*** Tidy Warnings* Remove all warnings which have now expired from the database* The duration of a warning can be defined by the administrator* This only removes the warning and reduces the associated count,* it does not remove the user note recording the contents of the warning*/function tidy_warnings(){	global $db, $config;	$expire_date = time() - ($config['warnings_expire_days'] * 86400);	$warning_list = $user_list = array();	$sql = 'SELECT * FROM ' . WARNINGS_TABLE . "		WHERE warning_time < $expire_date";	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$warning_list[] = $row['warning_id'];		$user_list[$row['user_id']] = isset($user_list[$row['user_id']]) ? ++$user_list[$row['user_id']] : 1;	}	$db->sql_freeresult($result);	if (sizeof($warning_list))	{		$db->sql_transaction('begin');		$sql = 'DELETE FROM ' . WARNINGS_TABLE . '			WHERE ' . $db->sql_in_set('warning_id', $warning_list);		$db->sql_query($sql);		foreach ($user_list as $user_id => $value)		{			$sql = 'UPDATE ' . USERS_TABLE . " SET user_warnings = user_warnings - $value				WHERE user_id = $user_id";			$db->sql_query($sql);		}		$db->sql_transaction('commit');	}	set_config('warnings_last_gc', time(), true);}/*** Tidy database, doing some maintanance tasks*/function tidy_database(){	global $db;	// Here we check permission consistency	// Sometimes, it can happen permission tables having forums listed which do not exist	$sql = 'SELECT forum_id		FROM ' . FORUMS_TABLE;	$result = $db->sql_query($sql);	$forum_ids = array(0);	while ($row = $db->sql_fetchrow($result))	{		$forum_ids[] = $row['forum_id'];	}	$db->sql_freeresult($result);	// Delete those rows from the acl tables not having listed the forums above	$sql = 'DELETE FROM ' . ACL_GROUPS_TABLE . '		WHERE ' . $db->sql_in_set('forum_id', $forum_ids, true);	$db->sql_query($sql);	$sql = 'DELETE FROM ' . ACL_USERS_TABLE . '		WHERE ' . $db->sql_in_set('forum_id', $forum_ids, true);	$db->sql_query($sql);	set_config('database_last_gc', time(), true);}/*** Add permission language - this will make sure custom files will be included*/function add_permission_language(){	global $user, $phpEx;	// First of all, our own file. We need to include it as the first file because it presets all relevant variables.	$user->add_lang('acp/permissions_phpbb');	$files_to_add = array();	// Now search in acp and mods folder for permissions_ files.	foreach (array('acp/', 'mods/') as $path)	{		$dh = @opendir($user->lang_path . $user->lang_name . '/' . $path);		if ($dh)		{			while (($file = readdir($dh)) !== false)			{				if ($file !== 'permissions_phpbb.' . $phpEx && strpos($file, 'permissions_') === 0 && substr($file, -(strlen($phpEx) + 1)) === '.' . $phpEx)				{					$files_to_add[] = $path . substr($file, 0, -(strlen($phpEx) + 1));				}			}			closedir($dh);		}	}	if (!sizeof($files_to_add))	{		return false;	}	$user->add_lang($files_to_add);	return true;}/** * Obtains the latest version information * * @param bool $force_update Ignores cached data. Defaults to false. * @param bool $warn_fail Trigger a warning if obtaining the latest version information fails. Defaults to false. * @param int $ttl Cache version information for $ttl seconds. Defaults to 86400 (24 hours). * * @return string | false Version info on success, false on failure. */function obtain_latest_version_info($force_update = false, $warn_fail = false, $ttl = 86400){	global $cache;	$info = $cache->get('versioncheck');	if ($info === false || $force_update)	{		$errstr = '';		$errno = 0;		$info = get_remote_file('version.phpbb.com', '/phpbb',				((defined('PHPBB_QA')) ? '30x_qa.txt' : '30x.txt'), $errstr, $errno);		if ($info === false)		{			$cache->destroy('versioncheck');			if ($warn_fail)			{				trigger_error($errstr, E_USER_WARNING);			}			return false;		}		$cache->put('versioncheck', $info, $ttl);	}	return $info;}/** * Enables a particular flag in a bitfield column of a given table. * * @param string	$table_name		The table to update * @param string	$column_name	The column containing a bitfield to update * @param int		$flag			The binary flag which is OR-ed with the current column value * @param string	$sql_more		This string is attached to the sql query generated to update the table. * * @return void */function enable_bitfield_column_flag($table_name, $column_name, $flag, $sql_more = ''){	global $db;	$sql = 'UPDATE ' . $table_name . '		SET ' . $column_name . ' = ' . $db->sql_bit_or($column_name, $flag) . '		' . $sql_more;	$db->sql_query($sql);}?>
<?php/**** @package acp* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** @ignore*/if (!defined('IN_PHPBB')){	exit;}/*** @package acp*/class acp_styles{	var $u_action;	var $style_cfg;	var $template_cfg;	var $theme_cfg;	var $imageset_cfg;	var $imageset_keys;	function main($id, $mode)	{		global $db, $user, $auth, $template, $cache;		global $config, $phpbb_root_path, $phpbb_admin_path, $phpEx;		// Hardcoded template bitfield to add for new templates		$bitfield = new bitfield();		$bitfield->set(0);		$bitfield->set(1);		$bitfield->set(2);		$bitfield->set(3);		$bitfield->set(4);		$bitfield->set(8);		$bitfield->set(9);		$bitfield->set(11);		$bitfield->set(12);		define('TEMPLATE_BITFIELD', $bitfield->get_base64());		unset($bitfield);		$user->add_lang('acp/styles');		$this->tpl_name = 'acp_styles';		$this->page_title = 'ACP_CAT_STYLES';		$action = request_var('action', '');		$action = (isset($_POST['add'])) ? 'add' : $action;		$style_id = request_var('id', 0);		// Fill the configuration variables		$this->style_cfg = $this->template_cfg = $this->theme_cfg = $this->imageset_cfg = '## phpBB {MODE} configuration file## @package phpBB3# @copyright (c) 2005 phpBB Group# @license http://opensource.org/licenses/gpl-license.php GNU Public License### At the left is the name, please do not change this# At the right the value is entered# For on/off options the valid values are on, off, 1, 0, true and false## Values get trimmed, if you want to add a space in front or at the end of# the value, then enclose the value with single or double quotes.# Single and double quotes do not need to be escaped.### General Information about this {MODE}name = {NAME}copyright = {COPYRIGHT}version = {VERSION}';		$this->theme_cfg .= '# Some configuration options## You have to turn this option on if you want to use the# path template variables ({T_IMAGESET_PATH} for example) within# your css file.# This is mostly the case if you want to use language specific# images within your css file.#parse_css_file = {PARSE_CSS_FILE}';		$this->template_cfg .= '# Some configuration options## You can use this function to inherit templates from another template.# The template of the given name has to be installed.# Templates cannot inherit from inheriting templates.#';		$this->imageset_keys = array(			'logos' => array(				'site_logo',			),			'buttons'	=> array(				'icon_back_top', 'icon_contact_aim', 'icon_contact_email', 'icon_contact_icq', 'icon_contact_jabber', 'icon_contact_msnm', 'icon_contact_pm', 'icon_contact_yahoo', 'icon_contact_www', 'icon_post_delete', 'icon_post_edit', 'icon_post_info', 'icon_post_quote', 'icon_post_report', 'icon_user_online', 'icon_user_offline', 'icon_user_profile', 'icon_user_search', 'icon_user_warn', 'button_pm_forward', 'button_pm_new', 'button_pm_reply', 'button_topic_locked', 'button_topic_new', 'button_topic_reply',			),			'icons'		=> array(				'icon_post_target', 'icon_post_target_unread', 'icon_topic_attach', 'icon_topic_latest', 'icon_topic_newest', 'icon_topic_reported', 'icon_topic_unapproved', 'icon_friend', 'icon_foe',			),			'forums'	=> array(				'forum_link', 'forum_read', 'forum_read_locked', 'forum_read_subforum', 'forum_unread', 'forum_unread_locked', 'forum_unread_subforum', 'subforum_read', 'subforum_unread'			),			'folders'	=> array(				'topic_moved', 'topic_read', 'topic_read_mine', 'topic_read_hot', 'topic_read_hot_mine', 'topic_read_locked', 'topic_read_locked_mine', 'topic_unread', 'topic_unread_mine', 'topic_unread_hot', 'topic_unread_hot_mine', 'topic_unread_locked', 'topic_unread_locked_mine', 'sticky_read', 'sticky_read_mine', 'sticky_read_locked', 'sticky_read_locked_mine', 'sticky_unread', 'sticky_unread_mine', 'sticky_unread_locked', 'sticky_unread_locked_mine', 'announce_read', 'announce_read_mine', 'announce_read_locked', 'announce_read_locked_mine', 'announce_unread', 'announce_unread_mine', 'announce_unread_locked', 'announce_unread_locked_mine', 'global_read', 'global_read_mine', 'global_read_locked', 'global_read_locked_mine', 'global_unread', 'global_unread_mine', 'global_unread_locked', 'global_unread_locked_mine', 'pm_read', 'pm_unread',			),			'polls'		=> array(				'poll_left', 'poll_center', 'poll_right',			),			'ui'		=> array(				'upload_bar',			),			'user'		=> array(				'user_icon1', 'user_icon2', 'user_icon3', 'user_icon4', 'user_icon5', 'user_icon6', 'user_icon7', 'user_icon8', 'user_icon9', 'user_icon10',			),		);		// Execute overall actions		switch ($action)		{			case 'delete':				if ($style_id)				{					$this->remove($mode, $style_id);					return;				}			break;			case 'export':				if ($style_id)				{					$this->export($mode, $style_id);					return;				}			break;			case 'install':				$this->install($mode);				return;			break;			case 'add':				$this->add($mode);				return;			break;			case 'details':				if ($style_id)				{					$this->details($mode, $style_id);					return;				}			break;			case 'edit':				if ($style_id)				{					switch ($mode)					{						case 'imageset':							return $this->edit_imageset($style_id);						case 'template':							return $this->edit_template($style_id);						case 'theme':							return $this->edit_theme($style_id);					}				}			break;			case 'cache':				if ($style_id)				{					switch ($mode)					{						case 'template':							return $this->template_cache($style_id);					}				}			break;		}		switch ($mode)		{			case 'style':				switch ($action)				{					case 'activate':					case 'deactivate':						if ($style_id == $config['default_style'])						{							trigger_error($user->lang['DEACTIVATE_DEFAULT'] . adm_back_link($this->u_action), E_USER_WARNING);						}						if (($action == 'deactivate' && confirm_box(true)) || $action == 'activate')						{							$sql = 'UPDATE ' . STYLES_TABLE . '								SET style_active = ' . (($action == 'activate') ? 1 : 0) . '								WHERE style_id = ' . $style_id;							$db->sql_query($sql);							// Set style to default for any member using deactivated style							if ($action == 'deactivate')							{								$sql = 'UPDATE ' . USERS_TABLE . '									SET user_style = ' . $config['default_style'] . "									WHERE user_style = $style_id";								$db->sql_query($sql);								$sql = 'UPDATE ' . FORUMS_TABLE . '									SET forum_style = 0									WHERE forum_style = ' . $style_id;								$db->sql_query($sql);							}						}						else if ($action == 'deactivate')						{							$s_hidden_fields = array(								'i'			=> $id,								'mode'		=> $mode,								'action'	=> $action,								'style_id'	=> $style_id,							);							confirm_box(false, $user->lang['CONFIRM_OPERATION'], build_hidden_fields($s_hidden_fields));						}					break;				}				$this->frontend('style', array('details'), array('export', 'delete'));			break;			case 'template':				switch ($action)				{					// Refresh template data stored in db and clear cache					case 'refresh':						$sql = 'SELECT *							FROM ' . STYLES_TEMPLATE_TABLE . "							WHERE template_id = $style_id";						$result = $db->sql_query($sql);						$template_row = $db->sql_fetchrow($result);						$db->sql_freeresult($result);						if (!$template_row)						{							trigger_error($user->lang['NO_TEMPLATE'] . adm_back_link($this->u_action), E_USER_WARNING);						}						if (confirm_box(true))						{							$template_refreshed = '';							// Only refresh database if the template is stored in the database							if ($template_row['template_storedb'] && file_exists("{$phpbb_root_path}styles/{$template_row['template_path']}/template/"))							{								$filelist = array('' => array());								$sql = 'SELECT template_filename, template_mtime									FROM ' . STYLES_TEMPLATE_DATA_TABLE . "									WHERE template_id = $style_id";								$result = $db->sql_query($sql);								while ($row = $db->sql_fetchrow($result))								{//									if (@filemtime("{$phpbb_root_path}styles/{$template_row['template_path']}/template/" . $row['template_filename']) > $row['template_mtime'])//									{										// get folder info from the filename										if (($slash_pos = strrpos($row['template_filename'], '/')) === false)										{											$filelist[''][] = $row['template_filename'];										}										else										{											$filelist[substr($row['template_filename'], 0, $slash_pos + 1)][] = substr($row['template_filename'], $slash_pos + 1, strlen($row['template_filename']) - $slash_pos - 1);										}//									}								}								$db->sql_freeresult($result);								$this->store_templates('update', $style_id, $template_row['template_path'], $filelist);								unset($filelist);								$template_refreshed = $user->lang['TEMPLATE_REFRESHED'] . '<br />';								add_log('admin', 'LOG_TEMPLATE_REFRESHED', $template_row['template_name']);							}							$this->clear_template_cache($template_row);							trigger_error($template_refreshed . $user->lang['TEMPLATE_CACHE_CLEARED'] . adm_back_link($this->u_action));						}						else						{							confirm_box(false, ($template_row['template_storedb']) ? $user->lang['CONFIRM_TEMPLATE_REFRESH'] : $user->lang['CONFIRM_TEMPLATE_CLEAR_CACHE'], build_hidden_fields(array(								'i'			=> $id,								'mode'		=> $mode,								'action'	=> $action,								'id'		=> $style_id							)));						}					break;				}				$this->frontend('template', array('edit', 'cache', 'details'), array('refresh', 'export', 'delete'));			break;			case 'theme':				switch ($action)				{					// Refresh theme data stored in the database					case 'refresh':						$sql = 'SELECT *							FROM ' . STYLES_THEME_TABLE . "							WHERE theme_id = $style_id";						$result = $db->sql_query($sql);						$theme_row = $db->sql_fetchrow($result);						$db->sql_freeresult($result);						if (!$theme_row)						{							trigger_error($user->lang['NO_THEME'] . adm_back_link($this->u_action), E_USER_WARNING);						}						if (!$theme_row['theme_storedb'])						{							trigger_error($user->lang['THEME_ERR_REFRESH_FS'] . adm_back_link($this->u_action), E_USER_WARNING);						}						if (confirm_box(true))						{							if ($theme_row['theme_storedb'] && file_exists("{$phpbb_root_path}styles/{$theme_row['theme_path']}/theme/stylesheet.css"))							{								// Save CSS contents								$sql_ary = array(									'theme_mtime'	=> (int) filemtime("{$phpbb_root_path}styles/{$theme_row['theme_path']}/theme/stylesheet.css"),									'theme_data'	=> $this->db_theme_data($theme_row)								);								$sql = 'UPDATE ' . STYLES_THEME_TABLE . ' SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "									WHERE theme_id = $style_id";								$db->sql_query($sql);								$cache->destroy('sql', STYLES_THEME_TABLE);								add_log('admin', 'LOG_THEME_REFRESHED', $theme_row['theme_name']);								trigger_error($user->lang['THEME_REFRESHED'] . adm_back_link($this->u_action));							}						}						else						{							confirm_box(false, $user->lang['CONFIRM_THEME_REFRESH'], build_hidden_fields(array(								'i'			=> $id,								'mode'		=> $mode,								'action'	=> $action,								'id'		=> $style_id							)));						}					break;				}				$this->frontend('theme', array('edit', 'details'), array('refresh', 'export', 'delete'));			break;			case 'imageset':				switch ($action)				{					case 'refresh':						$sql = 'SELECT *							FROM ' . STYLES_IMAGESET_TABLE . "							WHERE imageset_id = $style_id";						$result = $db->sql_query($sql);						$imageset_row = $db->sql_fetchrow($result);						$db->sql_freeresult($result);						if (!$imageset_row)						{							trigger_error($user->lang['NO_IMAGESET'] . adm_back_link($this->u_action), E_USER_WARNING);						}						if (confirm_box(true))						{							$sql_ary = array();							$imageset_definitions = array();							foreach ($this->imageset_keys as $topic => $key_array)							{								$imageset_definitions = array_merge($imageset_definitions, $key_array);							}							$cfg_data_imageset = parse_cfg_file("{$phpbb_root_path}styles/{$imageset_row['imageset_path']}/imageset/imageset.cfg");							$db->sql_transaction('begin');							$sql = 'DELETE FROM ' . STYLES_IMAGESET_DATA_TABLE . '								WHERE imageset_id = ' . $style_id;							$result = $db->sql_query($sql);							foreach ($cfg_data_imageset as $image_name => $value)							{								if (strpos($value, '*') !== false)								{									if (substr($value, -1, 1) === '*')									{										list($image_filename, $image_height) = explode('*', $value);										$image_width = 0;									}									else									{										list($image_filename, $image_height, $image_width) = explode('*', $value);									}								}								else								{									$image_filename = $value;									$image_height = $image_width = 0;								}								if (strpos($image_name, 'img_') === 0 && $image_filename)								{									$image_name = substr($image_name, 4);									if (in_array($image_name, $imageset_definitions))									{										$sql_ary[] = array(											'image_name'		=> (string) $image_name,											'image_filename'	=> (string) $image_filename,											'image_height'		=> (int) $image_height,											'image_width'		=> (int) $image_width,											'imageset_id'		=> (int) $style_id,											'image_lang'		=> '',										);									}								}							}							$sql = 'SELECT lang_dir								FROM ' . LANG_TABLE;							$result = $db->sql_query($sql);							while ($row = $db->sql_fetchrow($result))							{								if (@file_exists("{$phpbb_root_path}styles/{$imageset_row['imageset_path']}/imageset/{$row['lang_dir']}/imageset.cfg"))								{									$cfg_data_imageset_data = parse_cfg_file("{$phpbb_root_path}styles/{$imageset_row['imageset_path']}/imageset/{$row['lang_dir']}/imageset.cfg");									foreach ($cfg_data_imageset_data as $image_name => $value)									{										if (strpos($value, '*') !== false)										{											if (substr($value, -1, 1) === '*')											{												list($image_filename, $image_height) = explode('*', $value);												$image_width = 0;											}											else											{												list($image_filename, $image_height, $image_width) = explode('*', $value);											}										}										else										{											$image_filename = $value;											$image_height = $image_width = 0;										}										if (strpos($image_name, 'img_') === 0 && $image_filename)										{											$image_name = substr($image_name, 4);											if (in_array($image_name, $imageset_definitions))											{												$sql_ary[] = array(													'image_name'		=> (string) $image_name,													'image_filename'	=> (string) $image_filename,													'image_height'		=> (int) $image_height,													'image_width'		=> (int) $image_width,													'imageset_id'		=> (int) $style_id,													'image_lang'		=> (string) $row['lang_dir'],												);											}										}									}								}							}							$db->sql_freeresult($result);							$db->sql_multi_insert(STYLES_IMAGESET_DATA_TABLE, $sql_ary);							$db->sql_transaction('commit');							$cache->destroy('sql', STYLES_IMAGESET_DATA_TABLE);							$cache->destroy('imageset_site_logo_md5');							add_log('admin', 'LOG_IMAGESET_REFRESHED', $imageset_row['imageset_name']);							trigger_error($user->lang['IMAGESET_REFRESHED'] . adm_back_link($this->u_action));						}						else						{							confirm_box(false, $user->lang['CONFIRM_IMAGESET_REFRESH'], build_hidden_fields(array(								'i'			=> $id,								'mode'		=> $mode,								'action'	=> $action,								'id'		=> $style_id							)));						}					break;				}				$this->frontend('imageset', array('edit', 'details'), array('refresh', 'export', 'delete'));			break;		}	}	/**	* Build Frontend with supplied options	*/	function frontend($mode, $options, $actions)	{		global $user, $template, $db, $config, $phpbb_root_path, $phpEx;		$sql_from = '';		$style_count = array();		switch ($mode)		{			case 'style':				$sql_from = STYLES_TABLE;				$sql = 'SELECT user_style, COUNT(user_style) AS style_count					FROM ' . USERS_TABLE . '					GROUP BY user_style';				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$style_count[$row['user_style']] = $row['style_count'];				}				$db->sql_freeresult($result);			break;			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$l_prefix = strtoupper($mode);		$this->page_title = 'ACP_' . $l_prefix . 'S';		$template->assign_vars(array(			'S_FRONTEND'		=> true,			'S_STYLE'			=> ($mode == 'style') ? true : false,			'L_TITLE'			=> $user->lang[$this->page_title],			'L_EXPLAIN'			=> $user->lang[$this->page_title . '_EXPLAIN'],			'L_NAME'			=> $user->lang[$l_prefix . '_NAME'],			'L_INSTALLED'		=> $user->lang['INSTALLED_' . $l_prefix],			'L_UNINSTALLED'		=> $user->lang['UNINSTALLED_' . $l_prefix],			'L_NO_UNINSTALLED'	=> $user->lang['NO_UNINSTALLED_' . $l_prefix],			'L_CREATE'			=> $user->lang['CREATE_' . $l_prefix],			'U_ACTION'			=> $this->u_action,			)		);		$sql = "SELECT *			FROM $sql_from";		$result = $db->sql_query($sql);		$installed = array();		$basis_options = '<option class="sep" value="">' . $user->lang['OPTIONAL_BASIS'] . '</option>';		while ($row = $db->sql_fetchrow($result))		{			$installed[] = $row[$mode . '_name'];			$basis_options .= '<option value="' . $row[$mode . '_id'] . '">' . $row[$mode . '_name'] . '</option>';			$stylevis = ($mode == 'style' && !$row['style_active']) ? 'activate' : 'deactivate';			$s_options = array();			foreach ($options as $option)			{				$s_options[] = '<a href="' . $this->u_action . "&amp;action=$option&amp;id=" . $row[$mode . '_id'] . '">' . $user->lang[strtoupper($option)] . '</a>';			}			$s_actions = array();			foreach ($actions as $option)			{				$s_actions[] = '<a href="' . $this->u_action . "&amp;action=$option&amp;id=" . $row[$mode . '_id'] . '">' . $user->lang[strtoupper($option)] . '</a>';			}			$template->assign_block_vars('installed', array(				'S_DEFAULT_STYLE'		=> ($mode == 'style' && $row['style_id'] == $config['default_style']) ? true : false,				'U_EDIT'				=> $this->u_action . '&amp;action=' . (($mode == 'style') ? 'details' : 'edit') . '&amp;id=' . $row[$mode . '_id'],				'U_STYLE_ACT_DEACT'		=> $this->u_action . '&amp;action=' . $stylevis . '&amp;id=' . $row[$mode . '_id'],				'L_STYLE_ACT_DEACT'		=> $user->lang['STYLE_' . strtoupper($stylevis)],				'S_OPTIONS'				=> implode(' | ', $s_options),				'S_ACTIONS'				=> implode(' | ', $s_actions),				'U_PREVIEW'				=> ($mode == 'style') ? append_sid("{$phpbb_root_path}index.$phpEx", "$mode=" . $row[$mode . '_id']) : '',				'NAME'					=> $row[$mode . '_name'],				'STYLE_COUNT'			=> ($mode == 'style' && isset($style_count[$row['style_id']])) ? $style_count[$row['style_id']] : 0,				)			);		}		$db->sql_freeresult($result);		// Grab uninstalled items		$new_ary = $cfg = array();		$dp = @opendir("{$phpbb_root_path}styles");		if ($dp)		{			while (($file = readdir($dp)) !== false)			{				if ($file[0] == '.' || !is_dir($phpbb_root_path . 'styles/' . $file))				{					continue;				}				$subpath = ($mode != 'style') ? "$mode/" : '';				if (file_exists("{$phpbb_root_path}styles/$file/$subpath$mode.cfg"))				{					if ($cfg = file("{$phpbb_root_path}styles/$file/$subpath$mode.cfg"))					{						$items = parse_cfg_file('', $cfg);						$name = (isset($items['name'])) ? trim($items['name']) : false;						if ($name && !in_array($name, $installed))						{							$new_ary[] = array(								'path'		=> $file,								'name'		=> $name,								'copyright'	=> $items['copyright'],							);						}					}				}			}			closedir($dp);		}		unset($installed);		if (sizeof($new_ary))		{			foreach ($new_ary as $cfg)			{				$template->assign_block_vars('uninstalled', array(					'NAME'			=> $cfg['name'],					'COPYRIGHT'		=> $cfg['copyright'],					'U_INSTALL'		=> $this->u_action . '&amp;action=install&amp;path=' . urlencode($cfg['path']))				);			}		}		unset($new_ary);		$template->assign_vars(array(			'S_BASIS_OPTIONS'		=> $basis_options)		);	}	/**	* Provides a template editor which allows saving changes to template files on the filesystem or in the database.	*	* @param int $template_id specifies which template set is being edited	*/	function edit_template($template_id)	{		global $phpbb_root_path, $phpEx, $config, $db, $cache, $user, $template, $safe_mode;		if (defined('PHPBB_DISABLE_ACP_EDITOR'))		{			trigger_error($user->lang['EDITOR_DISABLED'] . adm_back_link($this->u_action));		}		$this->page_title = 'EDIT_TEMPLATE';		$filelist = $filelist_cats = array();		$template_data	= utf8_normalize_nfc(request_var('template_data', '', true));		$template_data	= htmlspecialchars_decode($template_data);		$template_file	= utf8_normalize_nfc(request_var('template_file', '', true));		$text_rows		= max(5, min(999, request_var('text_rows', 20)));		$save_changes	= (isset($_POST['save'])) ? true : false;		// make sure template_file path doesn't go upwards		$template_file = preg_replace('#\.{2,}#', '.', $template_file);		// Retrieve some information about the template		$sql = 'SELECT template_storedb, template_path, template_name			FROM ' . STYLES_TEMPLATE_TABLE . "			WHERE template_id = $template_id";		$result = $db->sql_query($sql);		$template_info = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$template_info)		{			trigger_error($user->lang['NO_TEMPLATE'] . adm_back_link($this->u_action), E_USER_WARNING);		}		if ($save_changes && !check_form_key('acp_styles'))		{			trigger_error($user->lang['FORM_INVALID'] . adm_back_link($this->u_action), E_USER_WARNING);		}		else if (!$save_changes)		{			add_form_key('acp_styles');		}		// save changes to the template if the user submitted any		if ($save_changes && $template_file)		{			// Get the filesystem location of the current file			$file = "{$phpbb_root_path}styles/{$template_info['template_path']}/template/$template_file";			$additional = '';			// If the template is stored on the filesystem try to write the file else store it in the database			if (!$safe_mode && !$template_info['template_storedb'] && file_exists($file) && phpbb_is_writable($file))			{				if (!($fp = @fopen($file, 'wb')))				{					// File exists and is writeable, but still not able to be written to					trigger_error(sprintf($user->lang['TEMPLATE_FILE_NOT_WRITABLE'], htmlspecialchars($template_file)) . adm_back_link($this->u_action), E_USER_WARNING);				}				fwrite($fp, $template_data);				fclose($fp);			}			else			{				$db->sql_transaction('begin');				// If it's not stored in the db yet, then update the template setting and store all template files in the db				if (!$template_info['template_storedb'])				{					if ($super = $this->get_super('template', $template_id))					{						$this->store_in_db('template', $super['template_id']);					}					else					{						$this->store_in_db('template', $template_id);					}					add_log('admin', 'LOG_TEMPLATE_EDIT_DETAILS', $template_info['template_name']);					$additional .= '<br />' . $user->lang['EDIT_TEMPLATE_STORED_DB'];				}				// Update the template_data table entry for this template file				$sql = 'UPDATE ' . STYLES_TEMPLATE_DATA_TABLE . "					SET template_data = '" . $db->sql_escape($template_data) . "', template_mtime = " . time() . "					WHERE template_id = $template_id						AND template_filename = '" . $db->sql_escape($template_file) . "'";				$db->sql_query($sql);				$db->sql_transaction('commit');			}			// destroy the cached version of the template (filename without extension)			$this->clear_template_cache($template_info, array(substr($template_file, 0, -5)));			$cache->destroy('sql', STYLES_TABLE);			add_log('admin', 'LOG_TEMPLATE_EDIT', $template_info['template_name'], $template_file);			trigger_error($user->lang['TEMPLATE_FILE_UPDATED'] . $additional . adm_back_link($this->u_action . "&amp;action=edit&amp;id=$template_id&amp;text_rows=$text_rows&amp;template_file=$template_file"));		}		// Generate a category array containing template filenames		if (!$template_info['template_storedb'])		{			$template_path = "{$phpbb_root_path}styles/{$template_info['template_path']}/template";			$filelist = filelist($template_path, '', 'html');			$filelist[''] = array_diff($filelist[''], array('bbcode.html'));			if ($template_file)			{				if (!file_exists($template_path . "/$template_file") || !($template_data = file_get_contents($template_path . "/$template_file")))				{					trigger_error($user->lang['NO_TEMPLATE'] . adm_back_link($this->u_action), E_USER_WARNING);				}			}		}		else		{			$sql = 'SELECT *				FROM ' . STYLES_TEMPLATE_DATA_TABLE . "				WHERE template_id = $template_id";			$result = $db->sql_query($sql);			$filelist = array('' => array());			while ($row = $db->sql_fetchrow($result))			{				$file_info = pathinfo($row['template_filename']);				if (($file_info['basename'] != 'bbcode') && ($file_info['extension'] == 'html'))				{					if (($file_info['dirname'] == '.') || empty($file_info['dirname']))					{						$filelist[''][] = $row['template_filename'];					}					else					{						$filelist[$file_info['dirname'] . '/'][] = $file_info['basename'];					}				}				if ($row['template_filename'] == $template_file)				{					$template_data = $row['template_data'];				}			}			$db->sql_freeresult($result);			unset($file_info);		}		if (empty($filelist['']))		{			trigger_error($user->lang['NO_TEMPLATE'] . adm_back_link($this->u_action), E_USER_WARNING);		}		// Now create the categories		$filelist_cats[''] = array();		foreach ($filelist as $pathfile => $file_ary)		{			// Use the directory name as category name			if (!empty($pathfile))			{				$filelist_cats[$pathfile] = array();				foreach ($file_ary as $file)				{					$filelist_cats[$pathfile][$pathfile . $file] = $file;				}			}			// or if it's in the main category use the word before the first underscore to group files			else			{				$cats = array();				foreach ($file_ary as $file)				{					$cats[] = substr($file, 0, strpos($file, '_'));					$filelist_cats[substr($file, 0, strpos($file, '_'))][$file] = $file;				}				$cats = array_values(array_unique($cats));				// we don't need any single element categories so put them into the misc '' category				for ($i = 0, $n = sizeof($cats); $i < $n; $i++)				{					if (sizeof($filelist_cats[$cats[$i]]) == 1 && $cats[$i] !== '')					{						$filelist_cats[''][key($filelist_cats[$cats[$i]])] = current($filelist_cats[$cats[$i]]);						unset($filelist_cats[$cats[$i]]);					}				}				unset($cats);			}		}		unset($filelist);		// Generate list of categorised template files		$tpl_options = '';		ksort($filelist_cats);		foreach ($filelist_cats as $category => $tpl_ary)		{			ksort($tpl_ary);			if (!empty($category))			{				$tpl_options .= '<option class="sep" value="">' . $category . '</option>';			}			foreach ($tpl_ary as $filename => $file)			{				$selected = ($template_file == $filename) ? ' selected="selected"' : '';				$tpl_options .= '<option value="' . $filename . '"' . $selected . '>' . $file . '</option>';			}		}		$template->assign_vars(array(			'S_EDIT_TEMPLATE'	=> true,			'S_HIDDEN_FIELDS'	=> build_hidden_fields(array('template_file' => $template_file)),			'S_TEMPLATES'		=> $tpl_options,			'U_ACTION'			=> $this->u_action . "&amp;action=edit&amp;id=$template_id&amp;text_rows=$text_rows",			'U_BACK'			=> $this->u_action,			'L_EDIT'			=> $user->lang['EDIT_TEMPLATE'],			'L_EDIT_EXPLAIN'	=> $user->lang['EDIT_TEMPLATE_EXPLAIN'],			'L_EDITOR'			=> $user->lang['TEMPLATE_EDITOR'],			'L_EDITOR_HEIGHT'	=> $user->lang['TEMPLATE_EDITOR_HEIGHT'],			'L_FILE'			=> $user->lang['TEMPLATE_FILE'],			'L_SELECT'			=> $user->lang['SELECT_TEMPLATE'],			'L_SELECTED'		=> $user->lang['SELECTED_TEMPLATE'],			'L_SELECTED_FILE'	=> $user->lang['SELECTED_TEMPLATE_FILE'],			'SELECTED_TEMPLATE'	=> $template_info['template_name'],			'TEMPLATE_FILE'		=> $template_file,			'TEMPLATE_DATA'		=> utf8_htmlspecialchars($template_data),			'TEXT_ROWS'			=> $text_rows)		);	}	/**	* Allows the admin to view cached versions of template files and clear single template cache files	*	* @param int $template_id specifies which template's cache is shown	*/	function template_cache($template_id)	{		global $phpbb_root_path, $phpEx, $config, $db, $cache, $user, $template;		$source		= str_replace('/', '.', request_var('source', ''));		$file_ary	= array_diff(request_var('delete', array('')), array(''));		$submit		= isset($_POST['submit']) ? true : false;		$sql = 'SELECT *			FROM ' . STYLES_TEMPLATE_TABLE . "			WHERE template_id = $template_id";		$result = $db->sql_query($sql);		$template_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$template_row)		{			trigger_error($user->lang['NO_TEMPLATE'] . adm_back_link($this->u_action), E_USER_WARNING);		}		// User wants to delete one or more files ...		if ($submit && $file_ary)		{			$this->clear_template_cache($template_row, $file_ary);			trigger_error($user->lang['TEMPLATE_CACHE_CLEARED'] . adm_back_link($this->u_action . "&amp;action=cache&amp;id=$template_id"));		}		$cache_prefix = 'tpl_' . str_replace('_', '-', $template_row['template_path']);		// Someone wants to see the cached source ... so we'll highlight it,		// add line numbers and indent it appropriately. This could be nasty		// on larger source files ...		if ($source && file_exists("{$phpbb_root_path}cache/{$cache_prefix}_$source.html.$phpEx"))		{			adm_page_header($user->lang['TEMPLATE_CACHE']);			$template->set_filenames(array(				'body'	=> 'viewsource.html')			);			$template->assign_vars(array(				'FILENAME'	=> str_replace('.', '/', $source) . '.html')			);			$code = str_replace(array("\r\n", "\r"), array("\n", "\n"), file_get_contents("{$phpbb_root_path}cache/{$cache_prefix}_$source.html.$phpEx"));			$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');			foreach ($conf as $ini_var)			{				@ini_set($ini_var, str_replace('highlight.', 'syntax', $ini_var));			}			$marker = 'MARKER' . time();			$code = highlight_string(str_replace("\n", $marker, $code), true);			$code = str_replace($marker, "\n", $code);			$str_from = array('<span style="color: ', '<font color="syntax', '</font>', '<code>', '</code>','[', ']', '.', ':');			$str_to = array('<span class="', '<span class="syntax', '</span>', '', '', '&#91;', '&#93;', '&#46;', '&#58;');			$code = str_replace($str_from, $str_to, $code);			$code = preg_replace('#^(<span class="[a-z_]+">)\n?(.*?)\n?(</span>)$#ism', '$1$2$3', $code);			$code = substr($code, strlen('<span class="syntaxhtml">'));			$code = substr($code, 0, -1 * strlen('</ span>'));			$code = explode("\n", $code);			foreach ($code as $key => $line)			{				$template->assign_block_vars('source', array(					'LINENUM'	=> $key + 1,					'LINE'		=> preg_replace('#([^ ;])&nbsp;([^ &])#', '$1 $2', $line))				);				unset($code[$key]);			}			adm_page_footer();		}		$filemtime = array();		if ($template_row['template_storedb'])		{			$ids = array();			if (isset($template_row['template_inherits_id']) && $template_row['template_inherits_id'])			{				$ids[] = $template_row['template_inherits_id'];			}			$ids[] = $template_row['template_id'];			$filemtime 			= array();			$file_template_db	= array();			foreach ($ids as $id)			{				$sql = 'SELECT template_filename, template_mtime					FROM ' . STYLES_TEMPLATE_DATA_TABLE . "					WHERE template_id = $id";				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$filemtime[$row['template_filename']] = $row['template_mtime'];					$file_template_db[$row['template_filename']] = $id;				}				$db->sql_freeresult($result);			}		}		// Get a list of cached template files and then retrieve additional information about them		$file_ary = $this->template_cache_filelist($template_row['template_path']);		foreach ($file_ary as $file)		{			$file		= str_replace('/', '.', $file);			// perform some dirty guessing to get the path right.			// We assume that three dots in a row were '../'			$tpl_file	= str_replace('.', '/', $file);			$tpl_file	= str_replace('///', '../', $tpl_file);			$filename = "{$cache_prefix}_$file.html.$phpEx";			if (!file_exists("{$phpbb_root_path}cache/$filename"))			{				continue;			}			$file_tpl = "{$phpbb_root_path}styles/{$template_row['template_path']}/template/$tpl_file.html";			$inherited = false;			if (isset($template_row['template_inherits_id']) && $template_row['template_inherits_id'])			{				if (!$template_row['template_storedb'])				{					if (!file_exists($file_tpl))					{						$file_tpl = "{$phpbb_root_path}styles/{$template_row['template_inherit_path']}/template/$tpl_file.html";						$inherited = true;					}				}				else				{					if ($file_template_db[$file . '.html'] == $template_row['template_inherits_id'])					{						$file_tpl = "{$phpbb_root_path}styles/{$template_row['template_inherit_path']}/template/$tpl_file.html";						$inherited = true;					}				}			}			// Correct the filename if it is stored in database and the file is in a subfolder.			if ($template_row['template_storedb'])			{				$file = str_replace('.', '/', $file);			}			$template->assign_block_vars('file', array(				'U_VIEWSOURCE'	=> $this->u_action . "&amp;action=cache&amp;id=$template_id&amp;source=$file",				'CACHED'		=> $user->format_date(filemtime("{$phpbb_root_path}cache/$filename")),				'FILENAME'		=> $file,				'FILENAME_PATH'	=> $file_tpl,				'FILESIZE'		=> get_formatted_filesize(filesize("{$phpbb_root_path}cache/$filename")),				'MODIFIED'		=> $user->format_date((!$template_row['template_storedb']) ? filemtime($file_tpl) : $filemtime[$file . '.html']))			);		}		unset($filemtime);		$template->assign_vars(array(			'S_CACHE'			=> true,			'S_TEMPLATE'		=> true,			'U_ACTION'			=> $this->u_action . "&amp;action=cache&amp;id=$template_id",			'U_BACK'			=> $this->u_action)		);	}	/**	* Provides a css editor and a basic easier to use stylesheet editing tool for less experienced (or lazy) users	*	* @param int $theme_id specifies which theme is being edited	*/	function edit_theme($theme_id)	{		global $phpbb_root_path, $phpEx, $config, $db, $cache, $user, $template, $safe_mode;		$this->page_title = 'EDIT_THEME';		$filelist = $filelist_cats = array();		$theme_data		= utf8_normalize_nfc(request_var('template_data', '', true));		$theme_data		= htmlspecialchars_decode($theme_data);		$theme_file		= utf8_normalize_nfc(request_var('template_file', '', true));		$text_rows		= max(5, min(999, request_var('text_rows', 20)));		$save_changes	= (isset($_POST['save'])) ? true : false;		// make sure theme_file path doesn't go upwards		$theme_file = str_replace('..', '.', $theme_file);		// Retrieve some information about the theme		$sql = 'SELECT theme_storedb, theme_path, theme_name, theme_data			FROM ' . STYLES_THEME_TABLE . "			WHERE theme_id = $theme_id";		$result = $db->sql_query($sql);		if (!($theme_info = $db->sql_fetchrow($result)))		{			trigger_error($user->lang['NO_THEME'] . adm_back_link($this->u_action), E_USER_WARNING);		}		$db->sql_freeresult($result);		// save changes to the theme if the user submitted any		if ($save_changes)		{			// Get the filesystem location of the current file			$file = "{$phpbb_root_path}styles/{$theme_info['theme_path']}/theme/$theme_file";			$additional = '';			$message = $user->lang['THEME_UPDATED'];			// If the theme is stored on the filesystem try to write the file else store it in the database			if (!$safe_mode && !$theme_info['theme_storedb'] && file_exists($file) && phpbb_is_writable($file))			{				if (!($fp = @fopen($file, 'wb')))				{					trigger_error($user->lang['NO_THEME'] . adm_back_link($this->u_action), E_USER_WARNING);				}				fwrite($fp, $theme_data);				fclose($fp);			}			else			{				// Write stylesheet to db				$sql_ary = array(					'theme_mtime'		=> time(),					'theme_storedb'		=> 1,					'theme_data'		=> $this->db_theme_data($theme_info, $theme_data),				);				$sql = 'UPDATE ' . STYLES_THEME_TABLE . '					SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '					WHERE theme_id = ' . $theme_id;				$db->sql_query($sql);				$cache->destroy('sql', STYLES_THEME_TABLE);				// notify the user if the theme was not stored in the db before his modification				if (!$theme_info['theme_storedb'])				{					add_log('admin', 'LOG_THEME_EDIT_DETAILS', $theme_info['theme_name']);					$message .= '<br />' . $user->lang['EDIT_THEME_STORED_DB'];				}			}			$cache->destroy('sql', STYLES_THEME_TABLE);			add_log('admin', (!$theme_info['theme_storedb']) ? 'LOG_THEME_EDIT_FILE' : 'LOG_THEME_EDIT', $theme_info['theme_name'], (!$theme_info['theme_storedb']) ? $theme_file : '');			trigger_error($message . adm_back_link($this->u_action . "&amp;action=edit&amp;id=$theme_id&amp;template_file=$theme_file&amp;text_rows=$text_rows"));		}		// Generate a category array containing theme filenames		if (!$theme_info['theme_storedb'])		{			$theme_path = "{$phpbb_root_path}styles/{$theme_info['theme_path']}/theme";			$filelist = filelist($theme_path, '', 'css');			if ($theme_file)			{				if (!file_exists($theme_path . "/$theme_file") || !($theme_data = file_get_contents($theme_path . "/$theme_file")))				{					trigger_error($user->lang['NO_THEME'] . adm_back_link($this->u_action), E_USER_WARNING);				}			}		}		else		{			$theme_data = &$theme_info['theme_data'];		}		// Now create the categories		$filelist_cats[''] = array();		foreach ($filelist as $pathfile => $file_ary)		{			// Use the directory name as category name			if (!empty($pathfile))			{				$filelist_cats[$pathfile] = array();				foreach ($file_ary as $file)				{					$filelist_cats[$pathfile][$pathfile . $file] = $file;				}			}			// or if it's in the main category use the word before the first underscore to group files			else			{				$cats = array();				foreach ($file_ary as $file)				{					$cats[] = substr($file, 0, strpos($file, '_'));					$filelist_cats[substr($file, 0, strpos($file, '_'))][$file] = $file;				}				$cats = array_values(array_unique($cats));				// we don't need any single element categories so put them into the misc '' category				for ($i = 0, $n = sizeof($cats); $i < $n; $i++)				{					if (sizeof($filelist_cats[$cats[$i]]) == 1 && $cats[$i] !== '')					{						$filelist_cats[''][key($filelist_cats[$cats[$i]])] = current($filelist_cats[$cats[$i]]);						unset($filelist_cats[$cats[$i]]);					}				}				unset($cats);			}		}		unset($filelist);		// Generate list of categorised theme files		$tpl_options = '';		ksort($filelist_cats);		foreach ($filelist_cats as $category => $tpl_ary)		{			ksort($tpl_ary);			if (!empty($category))			{				$tpl_options .= '<option class="sep" value="">' . $category . '</option>';			}			foreach ($tpl_ary as $filename => $file)			{				$selected = ($theme_file == $filename) ? ' selected="selected"' : '';				$tpl_options .= '<option value="' . $filename . '"' . $selected . '>' . $file . '</option>';			}		}		$template->assign_vars(array(			'S_EDIT_THEME'		=> true,			'S_HIDDEN_FIELDS'	=> build_hidden_fields(array('template_file' => $theme_file)),			'S_THEME_IN_DB'		=> $theme_info['theme_storedb'],			'S_TEMPLATES'		=> $tpl_options,			'U_ACTION'			=> $this->u_action . "&amp;action=edit&amp;id=$theme_id&amp;text_rows=$text_rows",			'U_BACK'			=> $this->u_action,			'L_EDIT'			=> $user->lang['EDIT_THEME'],			'L_EDIT_EXPLAIN'	=> $user->lang['EDIT_THEME_EXPLAIN'],			'L_EDITOR'			=> $user->lang['THEME_EDITOR'],			'L_EDITOR_HEIGHT'	=> $user->lang['THEME_EDITOR_HEIGHT'],			'L_FILE'			=> $user->lang['THEME_FILE'],			'L_SELECT'			=> $user->lang['SELECT_THEME'],			'L_SELECTED'		=> $user->lang['SELECTED_THEME'],			'L_SELECTED_FILE'	=> $user->lang['SELECTED_THEME_FILE'],			'SELECTED_TEMPLATE'	=> $theme_info['theme_name'],			'TEMPLATE_FILE'		=> $theme_file,			'TEMPLATE_DATA'		=> utf8_htmlspecialchars($theme_data),			'TEXT_ROWS'			=> $text_rows)		);	}	/**	* Edit imagesets	*	* @param int $imageset_id specifies which imageset is being edited	*/	function edit_imageset($imageset_id)	{		global $db, $user, $phpbb_root_path, $cache, $template;		$this->page_title = 'EDIT_IMAGESET';		if (!$imageset_id)		{			trigger_error($user->lang['NO_IMAGESET'] . adm_back_link($this->u_action), E_USER_WARNING);		}		$update		= (isset($_POST['update'])) ? true : false;		$imgname	= request_var('imgname', 'site_logo');		$imgname	= preg_replace('#[^a-z0-9\-+_]#i', '', $imgname);		$sql_extra = $imgnamelang = '';		$sql = 'SELECT imageset_path, imageset_name			FROM ' . STYLES_IMAGESET_TABLE . "			WHERE imageset_id = $imageset_id";		$result = $db->sql_query($sql);		$imageset_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$imageset_row)		{			trigger_error($user->lang['NO_IMAGESET'] . adm_back_link($this->u_action), E_USER_WARNING);		}		$imageset_path		= $imageset_row['imageset_path'];		$imageset_name		= $imageset_row['imageset_name'];		if (strpos($imgname, '-') !== false)		{			list($imgname, $imgnamelang) = explode('-', $imgname);			$sql_extra = " AND image_lang IN ('" . $db->sql_escape($imgnamelang) . "', '')";		}		$sql = 'SELECT image_filename, image_width, image_height, image_lang, image_id			FROM ' . STYLES_IMAGESET_DATA_TABLE . "			WHERE imageset_id = $imageset_id				AND image_name = '" . $db->sql_escape($imgname) . "'$sql_extra";		$result = $db->sql_query($sql);		$imageset_data_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		$image_filename	= $imageset_data_row['image_filename'];		$image_width	= $imageset_data_row['image_width'];		$image_height	= $imageset_data_row['image_height'];		$image_lang		= $imageset_data_row['image_lang'];		$image_id		= $imageset_data_row['image_id'];		$imgsize		= ($imageset_data_row['image_width'] && $imageset_data_row['image_height']) ? 1 : 0;		// Check to see whether the selected image exists in the table		$valid_name = ($update) ? false : true;		foreach ($this->imageset_keys as $category => $img_ary)		{			if (in_array($imgname, $img_ary))			{				$valid_name = true;				break;			}		}		if ($update && isset($_POST['imgpath']) && $valid_name)		{			// If imgwidth and imgheight are non-zero grab the actual size			// from the image itself ... we ignore width settings for the poll center image			$imgwidth	= request_var('imgwidth', 0);			$imgheight	= request_var('imgheight', 0);			$imgsize	= request_var('imgsize', 0);			$imgpath	= request_var('imgpath', '');			$imgpath	= str_replace('..', '.', $imgpath);			// If no dimensions selected, we reset width and height to 0 ;)			if (!$imgsize)			{				$imgwidth = $imgheight = 0;			}			$imglang = '';			if ($imgpath && !file_exists("{$phpbb_root_path}styles/$imageset_path/imageset/$imgpath"))			{				trigger_error($user->lang['NO_IMAGE_ERROR'] . adm_back_link($this->u_action), E_USER_WARNING);			}			// Determine width/height. If dimensions included and no width/height given, we detect them automatically...			if ($imgsize && $imgpath)			{				if (!$imgwidth || !$imgheight)				{					list($imgwidth_file, $imgheight_file) = getimagesize("{$phpbb_root_path}styles/$imageset_path/imageset/$imgpath");					$imgwidth = ($imgwidth) ? $imgwidth : $imgwidth_file;					$imgheight = ($imgheight) ? $imgheight : $imgheight_file;				}				$imgwidth	= ($imgname != 'poll_center') ? (int) $imgwidth : 0;				$imgheight	= (int) $imgheight;			}			if (strpos($imgpath, '/') !== false)			{				list($imglang, $imgfilename) = explode('/', $imgpath);			}			else			{				$imgfilename = $imgpath;			}			$sql_ary = array(				'image_filename'	=> (string) $imgfilename,				'image_width'		=> (int) $imgwidth,				'image_height'		=> (int) $imgheight,				'image_lang'		=> (string) $imglang,			);			// already exists			if ($imageset_data_row)			{				$sql = 'UPDATE ' . STYLES_IMAGESET_DATA_TABLE . '					SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "					WHERE image_id = $image_id";				$db->sql_query($sql);			}			// does not exist			else if (!$imageset_data_row)			{				$sql_ary['image_name']	= $imgname;				$sql_ary['imageset_id']	= (int) $imageset_id;				$db->sql_query('INSERT INTO ' . STYLES_IMAGESET_DATA_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));			}			$cache->destroy('sql', STYLES_IMAGESET_DATA_TABLE);			add_log('admin', 'LOG_IMAGESET_EDIT', $imageset_name);			$template->assign_var('SUCCESS', true);			$image_filename = $imgfilename;			$image_width	= $imgwidth;			$image_height	= $imgheight;			$image_lang		= $imglang;		}		$imglang = '';		$imagesetlist = array('nolang' => array(), 'lang' => array());		$langs = array();		$dir = "{$phpbb_root_path}styles/$imageset_path/imageset";		$dp = @opendir($dir);		if ($dp)		{			while (($file = readdir($dp)) !== false)			{				if ($file[0] != '.' && strtoupper($file) != 'CVS' && !is_file($dir . '/' . $file) && !is_link($dir . '/' . $file))				{					$langs[] = $file;				}				else if (preg_match('#\.(?:gif|jpg|png)$#', $file))				{					$imagesetlist['nolang'][] = $file;				}			}			if ($sql_extra)			{				$dp2 = @opendir("$dir/$imgnamelang");				if ($dp2)				{					while (($file2 = readdir($dp2)) !== false)					{						if (preg_match('#\.(?:gif|jpg|png)$#', $file2))						{							$imagesetlist['lang'][] = "$imgnamelang/$file2";						}					}					closedir($dp2);				}			}			closedir($dp);		}		// Generate list of image options		$img_options = '';		foreach ($this->imageset_keys as $category => $img_ary)		{			$template->assign_block_vars('category', array(				'NAME'			=> $user->lang['IMG_CAT_' . strtoupper($category)]			));			foreach ($img_ary as $img)			{				if ($category == 'buttons')				{					foreach ($langs as $language)					{						$template->assign_block_vars('category.images', array(							'SELECTED'			=> ($img == $imgname && $language == $imgnamelang),							'VALUE'				=> $img . '-' . $language,							'TEXT'				=> $user->lang['IMG_' . strtoupper($img)] . ' [ ' . $language . ' ]'						));					}				}				else				{					$template->assign_block_vars('category.images', array(						'SELECTED'			=> ($img == $imgname),						'VALUE'				=> $img,						'TEXT'				=> (($category == 'custom') ? $img : $user->lang['IMG_' . strtoupper($img)])					));				}			}		}		// Make sure the list of possible images is sorted alphabetically		sort($imagesetlist['lang']);		sort($imagesetlist['nolang']);		$image_found = false;		$img_val = '';		foreach ($imagesetlist as $type => $img_ary)		{			if ($type !== 'lang' || $sql_extra)			{				$template->assign_block_vars('imagesetlist', array(					'TYPE'	=> ($type == 'lang')				));			}			foreach ($img_ary as $img)			{				$imgtext = preg_replace('/^([^\/]+\/)/', '', $img);				$selected = (!empty($imgname) && strpos($image_filename, $imgtext) !== false);				if ($selected)				{					$image_found = true;					$img_val = htmlspecialchars($img);				}				$template->assign_block_vars('imagesetlist.images', array(					'SELECTED'			=> $selected,					'TEXT'				=> $imgtext,					'VALUE'				=> htmlspecialchars($img)				));			}		}		$imgsize_bool = (!empty($imgname) && $image_width && $image_height) ? true : false;		$image_request = '../styles/' . $imageset_path . '/imageset/' . ($image_lang ? $imgnamelang . '/' : '') . $image_filename;		$template->assign_vars(array(			'S_EDIT_IMAGESET'	=> true,			'L_TITLE'			=> $user->lang[$this->page_title],			'L_EXPLAIN'			=> $user->lang[$this->page_title . '_EXPLAIN'],			'IMAGE_OPTIONS'		=> $img_options,			'IMAGE_SIZE'		=> $image_width,			'IMAGE_HEIGHT'		=> $image_height,			'IMAGE_REQUEST'		=> (empty($image_filename)) ? 'images/no_image.png' : $image_request,			'U_ACTION'			=> $this->u_action . "&amp;action=edit&amp;id=$imageset_id",			'U_BACK'			=> $this->u_action,			'NAME'				=> $imageset_name,			'A_NAME'			=> addslashes($imageset_name),			'PATH'				=> $imageset_path,			'A_PATH'			=> addslashes($imageset_path),			'ERROR'				=> !$valid_name,			'IMG_SRC'			=> ($image_found) ? '../styles/' . $imageset_path . '/imageset/' . $img_val : 'images/no_image.png',			'IMAGE_SELECT'		=> $image_found		));	}	/**	* Remove style/template/theme/imageset	*/	function remove($mode, $style_id)	{		global $db, $template, $user, $phpbb_root_path, $cache, $config;		$new_id = request_var('new_id', 0);		$update = (isset($_POST['update'])) ? true : false;		$sql_where = '';		switch ($mode)		{			case 'style':				$sql_from = STYLES_TABLE;				$sql_select = 'style_id, style_name, template_id, theme_id, imageset_id';				$sql_where = 'AND style_active = 1';			break;			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;				$sql_select = 'template_id, template_name, template_path, template_storedb';			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;				$sql_select = 'theme_id, theme_name, theme_path, theme_storedb';			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;				$sql_select = 'imageset_id, imageset_name, imageset_path';			break;		}		if ($mode === 'template' && ($conflicts = $this->check_inheritance($mode, $style_id)))		{			$l_type = strtoupper($mode);			$msg = $user->lang[$l_type . '_DELETE_DEPENDENT'];			foreach ($conflicts as $id => $values)			{				$msg .= '<br />' . $values['template_name'];			}			trigger_error($msg . adm_back_link($this->u_action), E_USER_WARNING);		}		$l_prefix = strtoupper($mode);		$sql = "SELECT $sql_select			FROM $sql_from			WHERE {$mode}_id = $style_id";		$result = $db->sql_query($sql);		$style_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$style_row)		{			trigger_error($user->lang['NO_' . $l_prefix] . adm_back_link($this->u_action), E_USER_WARNING);		}		$s_only_component = $this->display_component_options($mode, $style_row[$mode . '_id'], $style_row);		if ($s_only_component)		{			trigger_error($user->lang['ONLY_' . $l_prefix] . adm_back_link($this->u_action), E_USER_WARNING);		}		if ($update)		{			if ($mode == 'style')			{				$sql = "DELETE FROM $sql_from					WHERE {$mode}_id = $style_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . USERS_TABLE . "					SET user_style = $new_id					WHERE user_style = $style_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . FORUMS_TABLE . "					SET forum_style = $new_id					WHERE forum_style = $style_id";				$db->sql_query($sql);				if ($style_id == $config['default_style'])				{					set_config('default_style', $new_id);				}				// Remove the components				$components = array('template', 'theme', 'imageset');				foreach ($components as $component)				{					$new_id = request_var('new_' . $component . '_id', 0);					$component_id = $style_row[$component . '_id'];					$this->remove_component($component, $component_id, $new_id, $style_id);				}			}			else			{				$this->remove_component($mode, $style_id, $new_id);			}			$cache->destroy('sql', STYLES_TABLE);			add_log('admin', 'LOG_' . $l_prefix . '_DELETE', $style_row[$mode . '_name']);			$message = ($mode != 'style') ? $l_prefix . '_DELETED_FS' : $l_prefix . '_DELETED';			trigger_error($user->lang[$message] . adm_back_link($this->u_action));		}		$this->page_title = 'DELETE_' . $l_prefix;		$template->assign_vars(array(			'S_DELETE'			=> true,			'L_TITLE'			=> $user->lang[$this->page_title],			'L_EXPLAIN'			=> $user->lang[$this->page_title . '_EXPLAIN'],			'L_NAME'			=> $user->lang[$l_prefix . '_NAME'],			'L_REPLACE'			=> $user->lang['REPLACE_' . $l_prefix],			'L_REPLACE_EXPLAIN'	=> $user->lang['REPLACE_' . $l_prefix . '_EXPLAIN'],			'U_ACTION'		=> $this->u_action . "&amp;action=delete&amp;id=$style_id",			'U_BACK'		=> $this->u_action,			'NAME'			=> $style_row[$mode . '_name'],			)		);		if ($mode == 'style')		{			$template->assign_vars(array(				'S_DELETE_STYLE'		=> true,			));		}	}	/**	* Remove template/theme/imageset entry from the database	*/	function remove_component($component, $component_id, $new_id, $style_id = false)	{		global $db;		if (($new_id == 0) || ($component === 'template' && ($conflicts = $this->check_inheritance($component, $component_id))))		{			// We can not delete the template, as the user wants to keep the component or an other template is inheriting from this one.			return;		}		$component_in_use = array();		if ($component != 'style')		{			$component_in_use = $this->component_in_use($component, $component_id, $style_id);		}		if (($new_id == -1) && !empty($component_in_use))		{			// We can not delete the component, as it is still in use			return;		}		if ($component == 'imageset')		{			$sql = 'DELETE FROM ' . STYLES_IMAGESET_DATA_TABLE . "				WHERE imageset_id = $component_id";			$db->sql_query($sql);		}		switch ($component)		{			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;;			break;		}		$sql = "DELETE FROM $sql_from			WHERE {$component}_id = $component_id";		$db->sql_query($sql);		$sql = 'UPDATE ' . STYLES_TABLE . "			SET {$component}_id = $new_id			WHERE {$component}_id = $component_id";		$db->sql_query($sql);	}	/**	* Display the options which can be used to replace a style/template/theme/imageset	*	* @return boolean Returns true if the component is the only component and can not be deleted.	*/	function display_component_options($component, $component_id, $style_row = false, $style_id = false)	{		global $db, $template, $user;		$is_only_component = true;		$component_in_use = array();		if ($component != 'style')		{			$component_in_use = $this->component_in_use($component, $component_id, $style_id);		}		$sql_where = '';		switch ($component)		{			case 'style':				$sql_from = STYLES_TABLE;				$sql_where = 'WHERE style_active = 1';			break;			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;				$sql_where = 'WHERE template_inherits_id <> ' . $component_id;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$s_options = '';		if (($component != 'style') && empty($component_in_use))		{			// If it is not in use, there must be another component			$is_only_component = false;			$sql = "SELECT {$component}_id, {$component}_name				FROM $sql_from				WHERE {$component}_id = {$component_id}";			$result = $db->sql_query($sql);			$row = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			$s_options .= '<option value="-1" selected="selected">' . $user->lang['DELETE_' . strtoupper($component)] . '</option>';			$s_options .= '<option value="0">' . sprintf($user->lang['KEEP_' . strtoupper($component)], $row[$component . '_name']) . '</option>';		}		else		{			$sql = "SELECT {$component}_id, {$component}_name				FROM $sql_from				$sql_where				ORDER BY {$component}_name ASC";			$result = $db->sql_query($sql);			$s_keep_option = $s_options = '';			while ($row = $db->sql_fetchrow($result))			{				if ($row[$component . '_id'] != $component_id)				{					$is_only_component = false;					$s_options .= '<option value="' . $row[$component . '_id'] . '">' . sprintf($user->lang['REPLACE_WITH_OPTION'], $row[$component . '_name']) . '</option>';				}				else if ($component != 'style')				{					$s_keep_option = '<option value="0" selected="selected">' . sprintf($user->lang['KEEP_' . strtoupper($component)], $row[$component . '_name']) . '</option>';				}			}			$db->sql_freeresult($result);			$s_options = $s_keep_option . $s_options;		}		if (!$style_row)		{			$template->assign_var('S_REPLACE_' . strtoupper($component) . '_OPTIONS', $s_options);		}		else		{			$template->assign_var('S_REPLACE_OPTIONS', $s_options);			if ($component == 'style')			{				$components = array('template', 'theme', 'imageset');				foreach ($components as $component)				{					$this->display_component_options($component, $style_row[$component . '_id'], false, $component_id, true);				}			}		}		return $is_only_component;	}	/**	* Check whether the component is still used by another style or component	*/	function component_in_use($component, $component_id, $style_id = false)	{		global $db;		$component_in_use = array();		if ($style_id)		{			$sql = 'SELECT style_id, style_name				FROM ' . STYLES_TABLE . "				WHERE {$component}_id = {$component_id}					AND style_id <> {$style_id}				ORDER BY style_name ASC";		}		else		{			$sql = 'SELECT style_id, style_name				FROM ' . STYLES_TABLE . "				WHERE {$component}_id = {$component_id}				ORDER BY style_name ASC";		}		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$component_in_use[] = $row['style_name'];		}		$db->sql_freeresult($result);		if ($component === 'template' && ($conflicts = $this->check_inheritance($component, $component_id)))		{			foreach ($conflicts as $temp_id => $conflict_data)			{				$component_in_use[] = $conflict_data['template_name'];			}		}		return $component_in_use;	}	/**	* Export style or style elements	*/	function export($mode, $style_id)	{		global $db, $template, $user, $phpbb_root_path, $cache, $phpEx, $config;		$update = (isset($_POST['update'])) ? true : false;		$inc_template = request_var('inc_template', 0);		$inc_theme = request_var('inc_theme', 0);		$inc_imageset = request_var('inc_imageset', 0);		$store = request_var('store', 0);		$format = request_var('format', '');		$error = array();		$methods = array('tar');		$available_methods = array('tar.gz' => 'zlib', 'tar.bz2' => 'bz2', 'zip' => 'zlib');		foreach ($available_methods as $type => $module)		{			if (!@extension_loaded($module))			{				continue;			}			$methods[] = $type;		}		if (!in_array($format, $methods))		{			$format = 'tar';		}		switch ($mode)		{			case 'style':				if ($update && ($inc_template + $inc_theme + $inc_imageset) < 1)				{					$error[] = $user->lang['STYLE_ERR_MORE_ELEMENTS'];				}				$name = 'style_name';				$sql_select = 's.style_id, s.style_name, s.style_copyright';				$sql_select .= ($inc_template) ? ', t.*' : ', t.template_name';				$sql_select .= ($inc_theme) ? ', c.*' : ', c.theme_name';				$sql_select .= ($inc_imageset) ? ', i.*' : ', i.imageset_name';				$sql_from = STYLES_TABLE . ' s, ' . STYLES_TEMPLATE_TABLE . ' t, ' . STYLES_THEME_TABLE . ' c, ' . STYLES_IMAGESET_TABLE . ' i';				$sql_where = "s.style_id = $style_id AND t.template_id = s.template_id AND c.theme_id = s.theme_id AND i.imageset_id = s.imageset_id";				$l_prefix = 'STYLE';			break;			case 'template':				$name = 'template_name';				$sql_select = '*';				$sql_from = STYLES_TEMPLATE_TABLE;				$sql_where = "template_id = $style_id";				$l_prefix = 'TEMPLATE';			break;			case 'theme':				$name = 'theme_name';				$sql_select = '*';				$sql_from = STYLES_THEME_TABLE;				$sql_where = "theme_id = $style_id";				$l_prefix = 'THEME';			break;			case 'imageset':				$name = 'imageset_name';				$sql_select = '*';				$sql_from = STYLES_IMAGESET_TABLE;				$sql_where = "imageset_id = $style_id";				$l_prefix = 'IMAGESET';			break;		}		if ($update && !sizeof($error))		{			$sql = "SELECT $sql_select				FROM $sql_from				WHERE $sql_where";			$result = $db->sql_query($sql);			$style_row = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			if (!$style_row)			{				trigger_error($user->lang['NO_' . $l_prefix] . adm_back_link($this->u_action), E_USER_WARNING);			}			$var_ary = array('style_id', 'style_name', 'style_copyright', 'template_id', 'template_name', 'template_path', 'template_copyright', 'template_storedb', 'template_inherits_id', 'bbcode_bitfield', 'theme_id', 'theme_name', 'theme_path', 'theme_copyright', 'theme_storedb', 'theme_mtime', 'theme_data', 'imageset_id', 'imageset_name', 'imageset_path', 'imageset_copyright');			foreach ($var_ary as $var)			{				if (!isset($style_row[$var]))				{					$style_row[$var] = '';				}			}			$files = $data = array();			if ($mode == 'style')			{				$style_cfg = str_replace(array('{MODE}', '{NAME}', '{COPYRIGHT}', '{VERSION}'), array($mode, $style_row['style_name'], $style_row['style_copyright'], $config['version']), $this->style_cfg);				$style_cfg .= (!$inc_template) ? "\nrequired_template = {$style_row['template_name']}" : '';				$style_cfg .= (!$inc_theme) ? "\nrequired_theme = {$style_row['theme_name']}" : '';				$style_cfg .= (!$inc_imageset) ? "\nrequired_imageset = {$style_row['imageset_name']}" : '';				$data[] = array(					'src'		=> $style_cfg,					'prefix'	=> 'style.cfg'				);				unset($style_cfg);			}			// Export template core code			if ($mode == 'template' || $inc_template)			{				$template_cfg = str_replace(array('{MODE}', '{NAME}', '{COPYRIGHT}', '{VERSION}'), array($mode, $style_row['template_name'], $style_row['template_copyright'], $config['version']), $this->template_cfg);				$use_template_name = '';				// Add the inherit from variable, depending on it's use...				if ($style_row['template_inherits_id'])				{					// Get the template name					$sql = 'SELECT template_name						FROM ' . STYLES_TEMPLATE_TABLE . '						WHERE template_id = ' . (int) $style_row['template_inherits_id'];					$result = $db->sql_query($sql);					$use_template_name = (string) $db->sql_fetchfield('template_name');					$db->sql_freeresult($result);				}				$template_cfg .= ($use_template_name) ? "\ninherit_from = $use_template_name" : "\n#inherit_from = ";				$template_cfg .= "\n\nbbcode_bitfield = {$style_row['bbcode_bitfield']}";				$data[] = array(					'src'		=> $template_cfg,					'prefix'	=> 'template/template.cfg'				);				// This is potentially nasty memory-wise ...				if (!$style_row['template_storedb'])				{					$files[] = array(						'src'		=> "styles/{$style_row['template_path']}/template/",						'prefix-'	=> "styles/{$style_row['template_path']}/",						'prefix+'	=> false,						'exclude'	=> 'template.cfg'					);				}				else				{					$sql = 'SELECT template_filename, template_data						FROM ' . STYLES_TEMPLATE_DATA_TABLE . "						WHERE template_id = {$style_row['template_id']}";					$result = $db->sql_query($sql);					while ($row = $db->sql_fetchrow($result))					{						$data[] = array(							'src' => $row['template_data'],							'prefix' => 'template/' . $row['template_filename']						);					}					$db->sql_freeresult($result);				}				unset($template_cfg);			}			// Export theme core code			if ($mode == 'theme' || $inc_theme)			{				$theme_cfg = str_replace(array('{MODE}', '{NAME}', '{COPYRIGHT}', '{VERSION}'), array($mode, $style_row['theme_name'], $style_row['theme_copyright'], $config['version']), $this->theme_cfg);				// Read old cfg file				$items = $cache->obtain_cfg_items($style_row);				$items = $items['theme'];				if (!isset($items['parse_css_file']))				{					$items['parse_css_file'] = 'off';				}				$theme_cfg = str_replace(array('{PARSE_CSS_FILE}'), array($items['parse_css_file']), $theme_cfg);				$files[] = array(					'src'		=> "styles/{$style_row['theme_path']}/theme/",					'prefix-'	=> "styles/{$style_row['theme_path']}/",					'prefix+'	=> false,					'exclude'	=> ($style_row['theme_storedb']) ? 'stylesheet.css,theme.cfg' : 'theme.cfg'				);				$data[] = array(					'src'		=> $theme_cfg,					'prefix'	=> 'theme/theme.cfg'				);				if ($style_row['theme_storedb'])				{					$data[] = array(						'src'		=> $style_row['theme_data'],						'prefix'	=> 'theme/stylesheet.css'					);				}				unset($items, $theme_cfg);			}			// Export imageset core code			if ($mode == 'imageset' || $inc_imageset)			{				$imageset_cfg = str_replace(array('{MODE}', '{NAME}', '{COPYRIGHT}', '{VERSION}'), array($mode, $style_row['imageset_name'], $style_row['imageset_copyright'], $config['version']), $this->imageset_cfg);				$imageset_main = array();				$sql = 'SELECT image_filename, image_name, image_height, image_width					FROM ' . STYLES_IMAGESET_DATA_TABLE . "					WHERE imageset_id = $style_id						AND image_lang = ''";				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$imageset_main[$row['image_name']] = $row['image_filename'] . ($row['image_height'] ? '*' . $row['image_height']: '') . ($row['image_width'] ? '*' . $row['image_width']: '');				}				$db->sql_freeresult($result);				foreach ($this->imageset_keys as $topic => $key_array)				{					foreach ($key_array as $key)					{						if (isset($imageset_main[$key]))						{							$imageset_cfg .= "\nimg_" . $key . ' = ' . str_replace("styles/{$style_row['imageset_path']}/imageset/", '{PATH}', $imageset_main[$key]);						}					}				}				$files[] = array(					'src'		=> "styles/{$style_row['imageset_path']}/imageset/",					'prefix-'	=> "styles/{$style_row['imageset_path']}/",					'prefix+'	=> false,					'exclude'	=> 'imageset.cfg'				);				$data[] = array(					'src'		=> trim($imageset_cfg),					'prefix'	=> 'imageset/imageset.cfg'				);				end($data);				$imageset_root = "{$phpbb_root_path}styles/{$style_row['imageset_path']}/imageset/";				if ($dh = @opendir($imageset_root))				{					while (($fname = readdir($dh)) !== false)					{						if ($fname[0] != '.' && $fname != 'CVS' && is_dir("$imageset_root$fname"))						{							$files[key($files)]['exclude'] .= ',' . $fname . '/imageset.cfg';						}					}					closedir($dh);				}				$imageset_lang = array();				$sql = 'SELECT image_filename, image_name, image_height, image_width, image_lang					FROM ' . STYLES_IMAGESET_DATA_TABLE . "					WHERE imageset_id = $style_id						AND image_lang <> ''";				$result = $db->sql_query($sql);				while ($row = $db->sql_fetchrow($result))				{					$imageset_lang[$row['image_lang']][$row['image_name']] = $row['image_filename'] . ($row['image_height'] ? '*' . $row['image_height']: '') . ($row['image_width'] ? '*' . $row['image_width']: '');				}				$db->sql_freeresult($result);				foreach ($imageset_lang as $lang => $imageset_localized)				{					$imageset_cfg = str_replace(array('{MODE}', '{NAME}', '{COPYRIGHT}', '{VERSION}'), array($mode, $style_row['imageset_name'], $style_row['imageset_copyright'], $config['version']), $this->imageset_cfg);					foreach ($this->imageset_keys as $topic => $key_array)					{						foreach ($key_array as $key)						{							if (isset($imageset_localized[$key]))							{								$imageset_cfg .= "\nimg_" . $key . ' = ' . str_replace("styles/{$style_row['imageset_path']}/imageset/", '{PATH}', $imageset_localized[$key]);							}						}					}					$data[] = array(						'src'		=> trim($imageset_cfg),						'prefix'	=> 'imageset/' . $lang . '/imageset.cfg'					);				}				unset($imageset_cfg);			}			switch ($format)			{				case 'tar':					$ext = '.tar';				break;				case 'zip':					$ext = '.zip';				break;				case 'tar.gz':					$ext = '.tar.gz';				break;				case 'tar.bz2':					$ext = '.tar.bz2';				break;				default:					$error[] = $user->lang[$l_prefix . '_ERR_ARCHIVE'];			}			if (!sizeof($error))			{				include($phpbb_root_path . 'includes/functions_compress.' . $phpEx);				if ($mode == 'style')				{					$path = preg_replace('#[^\w-]+#', '_', $style_row['style_name']);				}				else				{					$path = $style_row[$mode . '_path'];				}				if ($format == 'zip')				{					$compress = new compress_zip('w', $phpbb_root_path . "store/$path$ext");				}				else				{					$compress = new compress_tar('w', $phpbb_root_path . "store/$path$ext", $ext);				}				if (sizeof($files))				{					foreach ($files as $file_ary)					{						$compress->add_file($file_ary['src'], $file_ary['prefix-'], $file_ary['prefix+'], $file_ary['exclude']);					}				}				if (sizeof($data))				{					foreach ($data as $data_ary)					{						$compress->add_data($data_ary['src'], $data_ary['prefix']);					}				}				$compress->close();				add_log('admin', 'LOG_' . $l_prefix . '_EXPORT', $style_row[$mode . '_name']);				if (!$store)				{					$compress->download($path);					@unlink("{$phpbb_root_path}store/$path$ext");					exit;				}				trigger_error(sprintf($user->lang[$l_prefix . '_EXPORTED'], "store/$path$ext") . adm_back_link($this->u_action));			}		}		$sql = "SELECT {$mode}_id, {$mode}_name			FROM " . (($mode == 'style') ? STYLES_TABLE : $sql_from) . "			WHERE {$mode}_id = $style_id";		$result = $db->sql_query($sql);		$style_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$style_row)		{			trigger_error($user->lang['NO_' . $l_prefix] . adm_back_link($this->u_action), E_USER_WARNING);		}		$this->page_title = $l_prefix . '_EXPORT';		$format_buttons = '';		foreach ($methods as $method)		{			$format_buttons .= '<label><input type="radio"' . ((!$format_buttons) ? ' id="format"' : '') . ' class="radio" value="' . $method . '" name="format"' . (($method == $format) ? ' checked="checked"' : '') . ' /> ' . $method . '</label>';		}		$template->assign_vars(array(			'S_EXPORT'		=> true,			'S_ERROR_MSG'	=> (sizeof($error)) ? true : false,			'S_STYLE'		=> ($mode == 'style') ? true : false,			'L_TITLE'		=> $user->lang[$this->page_title],			'L_EXPLAIN'		=> $user->lang[$this->page_title . '_EXPLAIN'],			'L_NAME'		=> $user->lang[$l_prefix . '_NAME'],			'U_ACTION'		=> $this->u_action . '&amp;action=export&amp;id=' . $style_id,			'U_BACK'		=> $this->u_action,			'ERROR_MSG'			=> (sizeof($error)) ? implode('<br />', $error) : '',			'NAME'				=> $style_row[$mode . '_name'],			'FORMAT_BUTTONS'	=> $format_buttons)		);	}	/**	* Display details	*/	function details($mode, $style_id)	{		global $template, $db, $config, $user, $safe_mode, $cache, $phpbb_root_path;		$update = (isset($_POST['update'])) ? true : false;		$l_type = strtoupper($mode);		$error = array();		$element_ary = array('template' => STYLES_TEMPLATE_TABLE, 'theme' => STYLES_THEME_TABLE, 'imageset' => STYLES_IMAGESET_TABLE);		switch ($mode)		{			case 'style':				$sql_from = STYLES_TABLE;			break;			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$sql = "SELECT *			FROM $sql_from			WHERE {$mode}_id = $style_id";		$result = $db->sql_query($sql);		$style_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$style_row)		{			trigger_error($user->lang['NO_' . $l_type] . adm_back_link($this->u_action), E_USER_WARNING);		}		$style_row['style_default'] = ($mode == 'style' && $config['default_style'] == $style_id) ? 1 : 0;		if ($update)		{			$name = utf8_normalize_nfc(request_var('name', '', true));			$copyright = utf8_normalize_nfc(request_var('copyright', '', true));			$template_id = request_var('template_id', 0);			$theme_id = request_var('theme_id', 0);			$imageset_id = request_var('imageset_id', 0);			$style_active = request_var('style_active', 0);			$style_default = request_var('style_default', 0);			$store_db = request_var('store_db', 0);			// If the admin selected the style to be the default style, but forgot to activate it... we will do it for him			if ($style_default)			{				$style_active = 1;			}			$sql = "SELECT {$mode}_id, {$mode}_name				FROM $sql_from				WHERE {$mode}_id <> $style_id				AND LOWER({$mode}_name) = '" . $db->sql_escape(strtolower($name)) . "'";			$result = $db->sql_query($sql);			$conflict = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			if ($mode == 'style' && (!$template_id || !$theme_id || !$imageset_id))			{				$error[] = $user->lang['STYLE_ERR_NO_IDS'];			}			if ($mode == 'style' && $style_row['style_active'] && !$style_active && $config['default_style'] == $style_id)			{				$error[] = $user->lang['DEACTIVATE_DEFAULT'];			}			if (!$name || $conflict)			{				$error[] = $user->lang[$l_type . '_ERR_STYLE_NAME'];			}			if ($mode === 'theme' || $mode === 'template')			{				// a rather elaborate check we have to do here once to avoid trouble later				$check = "{$phpbb_root_path}styles/" . $style_row["{$mode}_path"] . (($mode === 'theme') ? '/theme/stylesheet.css' : '/template');				if (($style_row["{$mode}_storedb"] != $store_db) && !$store_db && ($safe_mode || !phpbb_is_writable($check)))				{					$error[] = $user->lang['EDIT_' . strtoupper($mode) . '_STORED_DB'];					$store_db = 1;				}				// themes which have to be parsed have to go into db				if ($mode == 'theme')				{					$cfg = parse_cfg_file("{$phpbb_root_path}styles/" . $style_row["{$mode}_path"] . "/theme/theme.cfg");					if (isset($cfg['parse_css_file']) && $cfg['parse_css_file'] && !$store_db)					{						$error[] = $user->lang['EDIT_THEME_STORE_PARSED'];						$store_db = 1;					}				}			}			if (!sizeof($error))			{				// Check length settings				if (utf8_strlen($name) > 30)				{					$error[] = $user->lang[$l_type . '_ERR_NAME_LONG'];				}				if (utf8_strlen($copyright) > 60)				{					$error[] = $user->lang[$l_type . '_ERR_COPY_LONG'];				}			}		}		if ($update && sizeof($error))		{			$style_row = array_merge($style_row, array(				'template_id'			=> $template_id,				'theme_id'				=> $theme_id,				'imageset_id'			=> $imageset_id,				'style_active'			=> $style_active,				$mode . '_storedb'		=> $store_db,				$mode . '_name'			=> $name,				$mode . '_copyright'	=> $copyright)			);		}		// User has submitted form and no errors have occurred		if ($update && !sizeof($error))		{			$sql_ary = array(				$mode . '_name'			=> $name,				$mode . '_copyright'	=> $copyright			);			switch ($mode)			{				case 'style':					$sql_ary += array(						'template_id'		=> (int) $template_id,						'theme_id'			=> (int) $theme_id,						'imageset_id'		=> (int) $imageset_id,						'style_active'		=> (int) $style_active,					);				break;				case 'imageset':				break;				case 'theme':					if ($style_row['theme_storedb'] != $store_db)					{						$theme_data = '';						if (!$style_row['theme_storedb'])						{							$theme_data = $this->db_theme_data($style_row);						}						else if (!$store_db && !$safe_mode && phpbb_is_writable("{$phpbb_root_path}styles/{$style_row['theme_path']}/theme/stylesheet.css"))						{							$store_db = 1;							$theme_data = $style_row['theme_data'];							if ($fp = @fopen("{$phpbb_root_path}styles/{$style_row['theme_path']}/theme/stylesheet.css", 'wb'))							{								$store_db = (@fwrite($fp, str_replace("styles/{$style_row['theme_path']}/theme/", './', $theme_data))) ? 0 : 1;							}							fclose($fp);						}						$sql_ary += array(							'theme_mtime'	=> ($store_db) ? filemtime("{$phpbb_root_path}styles/{$style_row['theme_path']}/theme/stylesheet.css") : 0,							'theme_storedb'	=> $store_db,							'theme_data'	=> ($store_db) ? $theme_data : '',						);					}				break;				case 'template':					if ($style_row['template_storedb'] != $store_db)					{						if ($super = $this->get_super($mode, $style_row['template_id']))						{							$error[] = (sprintf($user->lang["{$l_type}_INHERITS"], $super['template_name']));							$sql_ary = array();						}						else						{							if (!$store_db && !$safe_mode && phpbb_is_writable("{$phpbb_root_path}styles/{$style_row['template_path']}/template"))							{								$err = $this->store_in_fs('template', $style_row['template_id']);								if ($err)								{									$error += $err;								}							}							else if ($store_db)							{								$this->store_in_db('template', $style_row['template_id']);							}							else							{								// We no longer store within the db, but are also not able to update the file structure								// Since the admin want to switch this, we adhere to his decision. But we also need to remove the cache								$sql = 'DELETE FROM ' . STYLES_TEMPLATE_DATA_TABLE . "									WHERE template_id = $style_id";								$db->sql_query($sql);							}							$sql_ary += array(								'template_storedb'	=> $store_db,							);						}					}				break;			}			if (sizeof($sql_ary))			{				$sql = "UPDATE $sql_from					SET " . $db->sql_build_array('UPDATE', $sql_ary) . "					WHERE {$mode}_id = $style_id";				$db->sql_query($sql);				// Making this the default style?				if ($mode == 'style' && $style_default)				{					set_config('default_style', $style_id);				}			}			$cache->destroy('sql', STYLES_TABLE);			add_log('admin', 'LOG_' . $l_type . '_EDIT_DETAILS', $name);			if (sizeof($error))			{				trigger_error(implode('<br />', $error) . adm_back_link($this->u_action), E_USER_WARNING);			}			else			{				trigger_error($user->lang[$l_type . '_DETAILS_UPDATED'] . adm_back_link($this->u_action));			}		}		if ($mode == 'style')		{			foreach ($element_ary as $element => $table)			{				$sql = "SELECT {$element}_id, {$element}_name					FROM $table					ORDER BY {$element}_id ASC";				$result = $db->sql_query($sql);				${$element . '_options'} = '';				while ($row = $db->sql_fetchrow($result))				{					$selected = ($row[$element . '_id'] == $style_row[$element . '_id']) ? ' selected="selected"' : '';					${$element . '_options'} .= '<option value="' . $row[$element . '_id'] . '"' . $selected . '>' . $row[$element . '_name'] . '</option>';				}				$db->sql_freeresult($result);			}		}		if ($mode == 'template')		{			$super = array();			if (isset($style_row[$mode . '_inherits_id']) && $style_row['template_inherits_id'])			{				$super = $this->get_super($mode, $style_row['template_id']);			}		}		$this->page_title = 'EDIT_DETAILS_' . $l_type;		$template->assign_vars(array(			'S_DETAILS'				=> true,			'S_ERROR_MSG'			=> (sizeof($error)) ? true : false,			'S_STYLE'				=> ($mode == 'style') ? true : false,			'S_TEMPLATE'			=> ($mode == 'template') ? true : false,			'S_THEME'				=> ($mode == 'theme') ? true : false,			'S_IMAGESET'			=> ($mode == 'imageset') ? true : false,			'S_STORE_DB'			=> (isset($style_row[$mode . '_storedb'])) ? $style_row[$mode . '_storedb'] : 0,			'S_STORE_DB_DISABLED'	=> (isset($style_row[$mode . '_inherits_id'])) ? $style_row[$mode . '_inherits_id'] : 0,			'S_STYLE_ACTIVE'		=> (isset($style_row['style_active'])) ? $style_row['style_active'] : 0,			'S_STYLE_DEFAULT'		=> (isset($style_row['style_default'])) ? $style_row['style_default'] : 0,			'S_SUPERTEMPLATE'		=> (isset($style_row[$mode . '_inherits_id']) && $style_row[$mode . '_inherits_id']) ? $super['template_name'] : 0,			'S_TEMPLATE_OPTIONS'	=> ($mode == 'style') ? $template_options : '',			'S_THEME_OPTIONS'		=> ($mode == 'style') ? $theme_options : '',			'S_IMAGESET_OPTIONS'	=> ($mode == 'style') ? $imageset_options : '',			'U_ACTION'		=> $this->u_action . '&amp;action=details&amp;id=' . $style_id,			'U_BACK'		=> $this->u_action,			'L_TITLE'				=> $user->lang[$this->page_title],			'L_EXPLAIN'				=> $user->lang[$this->page_title . '_EXPLAIN'],			'L_NAME'				=> $user->lang[$l_type . '_NAME'],			'L_LOCATION'			=> ($mode == 'template' || $mode == 'theme') ? $user->lang[$l_type . '_LOCATION'] : '',			'L_LOCATION_EXPLAIN'	=> ($mode == 'template' || $mode == 'theme') ? $user->lang[$l_type . '_LOCATION_EXPLAIN'] : '',			'ERROR_MSG'		=> (sizeof($error)) ? implode('<br />', $error) : '',			'NAME'			=> $style_row[$mode . '_name'],			'COPYRIGHT'		=> $style_row[$mode . '_copyright'],			)		);	}	/**	* Load css file contents	*/	function load_css_file($path, $filename)	{		global $phpbb_root_path;		$file = "{$phpbb_root_path}styles/$path/theme/$filename";		if (file_exists($file) && ($content = file_get_contents($file)))		{			$content = trim($content);		}		else		{			$content = '';		}		if (defined('DEBUG'))		{			$content = "/* BEGIN @include $filename */ \n $content \n /* END @include $filename */ \n";		}		return $content;	}	/**	* Returns a string containing the value that should be used for the theme_data column in the theme database table.	* Includes contents of files loaded via @import	*	* @param array $theme_row is an associative array containing the theme's current database entry	* @param mixed $stylesheet can either be the new content for the stylesheet or false to load from the standard file	* @param string $root_path should only be used in case you want to use a different root path than "{$phpbb_root_path}styles/{$theme_row['theme_path']}"	*	* @return string Stylesheet data for theme_data column in the theme table	*/	function db_theme_data($theme_row, $stylesheet = false, $root_path = '')	{		global $phpbb_root_path;		if (!$root_path)		{			$root_path = $phpbb_root_path . 'styles/' . $theme_row['theme_path'];		}		if (!$stylesheet)		{			$stylesheet = '';			if (file_exists($root_path . '/theme/stylesheet.css'))			{				$stylesheet = file_get_contents($root_path . '/theme/stylesheet.css');			}		}		// Match CSS imports		$matches = array();		preg_match_all('/@import url\((["\'])(.*)\1\);/i', $stylesheet, $matches);		// remove commented stylesheets (very simple parser, allows only whitespace		// around an @import statement)		preg_match_all('#/\*\s*@import url\((["\'])(.*)\1\);\s\*/#i', $stylesheet, $commented);		$matches[2] = array_diff($matches[2], $commented[2]);		if (sizeof($matches))		{			foreach ($matches[0] as $idx => $match)			{				if (isset($matches[2][$idx]))				{					$stylesheet = str_replace($match, acp_styles::load_css_file($theme_row['theme_path'], $matches[2][$idx]), $stylesheet);				}			}		}		// adjust paths		return str_replace('./', 'styles/' . $theme_row['theme_path'] . '/theme/', $stylesheet);	}	/**	* Store template files into db	*/	function store_templates($mode, $style_id, $template_path, $filelist)	{		global $phpbb_root_path, $phpEx, $db;		$template_path = $template_path . '/template/';		$includes = array();		foreach ($filelist as $pathfile => $file_ary)		{			foreach ($file_ary as $file)			{				if (!($fp = @fopen("{$phpbb_root_path}styles/$template_path$pathfile$file", 'r')))				{					trigger_error("Could not open {$phpbb_root_path}styles/$template_path$pathfile$file", E_USER_ERROR);				}				$filesize = filesize("{$phpbb_root_path}styles/$template_path$pathfile$file");				if ($filesize)				{					$template_data = fread($fp, $filesize);				}				fclose($fp);				if (!$filesize)				{					// File is empty					continue;				}				if (preg_match_all('#<!-- INCLUDE (.*?\.html) -->#is', $template_data, $matches))				{					foreach ($matches[1] as $match)					{						$includes[trim($match)][] = $file;					}				}			}		}		foreach ($filelist as $pathfile => $file_ary)		{			foreach ($file_ary as $file)			{				// Skip index.				if (strpos($file, 'index.') === 0)				{					continue;				}				// We could do this using extended inserts ... but that could be one				// heck of a lot of data ...				$sql_ary = array(					'template_id'			=> (int) $style_id,					'template_filename'		=> "$pathfile$file",					'template_included'		=> (isset($includes[$file])) ? implode(':', $includes[$file]) . ':' : '',					'template_mtime'		=> (int) filemtime("{$phpbb_root_path}styles/$template_path$pathfile$file"),					'template_data'			=> (string) file_get_contents("{$phpbb_root_path}styles/$template_path$pathfile$file"),				);				if ($mode == 'insert')				{					$sql = 'INSERT INTO ' . STYLES_TEMPLATE_DATA_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary);				}				else				{					$sql = 'UPDATE ' . STYLES_TEMPLATE_DATA_TABLE . ' SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "						WHERE template_id = $style_id							AND template_filename = '" . $db->sql_escape("$pathfile$file") . "'";				}				$db->sql_query($sql);			}		}	}	/**	* Returns an array containing all template filenames for one template that are currently cached.	*	* @param string $template_path contains the name of the template's folder in /styles/	*	* @return array of filenames that exist in /styles/$template_path/template/ (without extension!)	*/	function template_cache_filelist($template_path)	{		global $phpbb_root_path, $phpEx, $user;		$cache_prefix = 'tpl_' . str_replace('_', '-', $template_path);		if (!($dp = @opendir("{$phpbb_root_path}cache")))		{			trigger_error($user->lang['TEMPLATE_ERR_CACHE_READ'] . adm_back_link($this->u_action), E_USER_WARNING);		}		$file_ary = array();		while ($file = readdir($dp))		{			if ($file[0] == '.')			{				continue;			}			if (is_file($phpbb_root_path . 'cache/' . $file) && (strpos($file, $cache_prefix) === 0))			{				$file_ary[] = str_replace('.', '/', preg_replace('#^' . preg_quote($cache_prefix, '#') . '_(.*?)\.html\.' . $phpEx . '$#i', '\1', $file));			}		}		closedir($dp);		return $file_ary;	}	/**	* Destroys cached versions of template files	*	* @param array $template_row contains the template's row in the STYLES_TEMPLATE_TABLE database table	* @param mixed $file_ary is optional and may contain an array of template file names which should be refreshed in the cache.	*	The file names should be the original template file names and not the cache file names.	*/	function clear_template_cache($template_row, $file_ary = false)	{		global $phpbb_root_path, $phpEx, $user;		$cache_prefix = 'tpl_' . str_replace('_', '-', $template_row['template_path']);		if (!$file_ary || !is_array($file_ary))		{			$file_ary = $this->template_cache_filelist($template_row['template_path']);			$log_file_list = $user->lang['ALL_FILES'];		}		else		{			$log_file_list = implode(', ', $file_ary);		}		foreach ($file_ary as $file)		{			$file = str_replace('/', '.', $file);			$file = "{$phpbb_root_path}cache/{$cache_prefix}_$file.html.$phpEx";			if (file_exists($file) && is_file($file))			{				@unlink($file);			}		}		unset($file_ary);		add_log('admin', 'LOG_TEMPLATE_CACHE_CLEARED', $template_row['template_name'], $log_file_list);	}	/**	* Install Style/Template/Theme/Imageset	*/	function install($mode)	{		global $phpbb_root_path, $phpEx, $config, $db, $cache, $user, $template;		$l_type = strtoupper($mode);		$error = $installcfg = $style_row = array();		$root_path = $cfg_file = '';		$element_ary = array('template' => STYLES_TEMPLATE_TABLE, 'theme' => STYLES_THEME_TABLE, 'imageset' => STYLES_IMAGESET_TABLE);		$install_path = request_var('path', '');		$update = (isset($_POST['update'])) ? true : false;		// Installing, obtain cfg file contents		if ($install_path)		{			$root_path = $phpbb_root_path . 'styles/' . $install_path . '/';			$cfg_file = ($mode == 'style') ? "$root_path$mode.cfg" : "$root_path$mode/$mode.cfg";			if (!file_exists($cfg_file))			{				$error[] = $user->lang[$l_type . '_ERR_NOT_' . $l_type];			}			else			{				$installcfg = parse_cfg_file($cfg_file);			}		}		// Installing		if (sizeof($installcfg))		{			$name		= $installcfg['name'];			$copyright	= $installcfg['copyright'];			$version	= $installcfg['version'];			$style_row = array(				$mode . '_id'			=> 0,				$mode . '_name'			=> '',				$mode . '_copyright'	=> ''			);			switch ($mode)			{				case 'style':					$style_row = array(						'style_id'			=> 0,						'style_name'		=> $installcfg['name'],						'style_copyright'	=> $installcfg['copyright']					);					$reqd_template = (isset($installcfg['required_template'])) ? $installcfg['required_template'] : false;					$reqd_theme = (isset($installcfg['required_theme'])) ? $installcfg['required_theme'] : false;					$reqd_imageset = (isset($installcfg['required_imageset'])) ? $installcfg['required_imageset'] : false;					// Check to see if each element is already installed, if it is grab the id					foreach ($element_ary as $element => $table)					{						$style_row = array_merge($style_row, array(							$element . '_id'			=> 0,							$element . '_name'			=> '',							$element . '_copyright'		=> '')						);			 			$this->test_installed($element, $error, (${'reqd_' . $element}) ? $phpbb_root_path . 'styles/' . $reqd_template . '/' : $root_path, ${'reqd_' . $element}, $style_row[$element . '_id'], $style_row[$element . '_name'], $style_row[$element . '_copyright']);						if (!$style_row[$element . '_name'])						{							$style_row[$element . '_name'] = $reqd_template;						}						// Merge other information to installcfg... if present						$cfg_file = $phpbb_root_path . 'styles/' . $install_path . '/' . $element . '/' . $element . '.cfg';						if (file_exists($cfg_file))						{							$cfg_contents = parse_cfg_file($cfg_file);							// Merge only specific things. We may need them later.							foreach (array('inherit_from', 'parse_css_file') as $key)							{								if (!empty($cfg_contents[$key]) && !isset($installcfg[$key]))								{									$installcfg[$key] = $cfg_contents[$key];								}							}						}					}				break;				case 'template':					$this->test_installed('template', $error, $root_path, false, $style_row['template_id'], $style_row['template_name'], $style_row['template_copyright']);				break;				case 'theme':					$this->test_installed('theme', $error, $root_path, false, $style_row['theme_id'], $style_row['theme_name'], $style_row['theme_copyright']);				break;				case 'imageset':					$this->test_installed('imageset', $error, $root_path, false, $style_row['imageset_id'], $style_row['imageset_name'], $style_row['imageset_copyright']);				break;			}		}		else		{			trigger_error($user->lang['NO_' . $l_type] . adm_back_link($this->u_action), E_USER_WARNING);		}		$style_row['store_db'] = request_var('store_db', 0);		$style_row['style_active'] = request_var('style_active', 1);		$style_row['style_default'] = request_var('style_default', 0);		// User has submitted form and no errors have occurred		if ($update && !sizeof($error))		{			if ($mode == 'style')			{				foreach ($element_ary as $element => $table)				{					${$element . '_root_path'} = (${'reqd_' . $element}) ? $phpbb_root_path . 'styles/' . ${'reqd_' . $element} . '/' : false;					${$element . '_path'} = (${'reqd_' . $element}) ? ${'reqd_' . $element} : false;				}				$this->install_style($error, 'install', $root_path, $style_row['style_id'], $style_row['style_name'], $install_path, $style_row['style_copyright'], $style_row['style_active'], $style_row['style_default'], $style_row, $template_root_path, $template_path, $theme_root_path, $theme_path, $imageset_root_path, $imageset_path);			}			else			{				$style_row['store_db'] = $this->install_element($mode, $error, 'install', $root_path, $style_row[$mode . '_id'], $style_row[$mode . '_name'], $install_path, $style_row[$mode . '_copyright'], $style_row['store_db']);			}			if (!sizeof($error))			{				$cache->destroy('sql', STYLES_TABLE);				$message = ($style_row['store_db']) ? '_ADDED_DB' : '_ADDED';				trigger_error($user->lang[$l_type . $message] . adm_back_link($this->u_action));			}		}		$this->page_title = 'INSTALL_' . $l_type;		$template->assign_vars(array(			'S_DETAILS'			=> true,			'S_INSTALL'			=> true,			'S_ERROR_MSG'		=> (sizeof($error)) ? true : false,			'S_LOCATION'		=> (isset($installcfg['inherit_from']) && $installcfg['inherit_from']) ? false : true,			'S_STYLE'			=> ($mode == 'style') ? true : false,			'S_TEMPLATE'		=> ($mode == 'template') ? true : false,			'S_SUPERTEMPLATE'	=> (isset($installcfg['inherit_from'])) ? $installcfg['inherit_from'] : '',			'S_THEME'			=> ($mode == 'theme') ? true : false,			'S_STORE_DB'			=> (isset($style_row[$mode . '_storedb'])) ? $style_row[$mode . '_storedb'] : 0,			'S_STYLE_ACTIVE'		=> (isset($style_row['style_active'])) ? $style_row['style_active'] : 0,			'S_STYLE_DEFAULT'		=> (isset($style_row['style_default'])) ? $style_row['style_default'] : 0,			'U_ACTION'			=> $this->u_action . "&amp;action=install&amp;path=" . urlencode($install_path),			'U_BACK'			=> $this->u_action,			'L_TITLE'				=> $user->lang[$this->page_title],			'L_EXPLAIN'				=> $user->lang[$this->page_title . '_EXPLAIN'],			'L_NAME'				=> $user->lang[$l_type . '_NAME'],			'L_LOCATION'			=> ($mode == 'template' || $mode == 'theme') ? $user->lang[$l_type . '_LOCATION'] : '',			'L_LOCATION_EXPLAIN'	=> ($mode == 'template' || $mode == 'theme') ? $user->lang[$l_type . '_LOCATION_EXPLAIN'] : '',			'ERROR_MSG'			=> (sizeof($error)) ? implode('<br />', $error) : '',			'NAME'				=> $style_row[$mode . '_name'],			'COPYRIGHT'			=> $style_row[$mode . '_copyright'],			'TEMPLATE_NAME'		=> ($mode == 'style') ? $style_row['template_name'] : '',			'THEME_NAME'		=> ($mode == 'style') ? $style_row['theme_name'] : '',			'IMAGESET_NAME'		=> ($mode == 'style') ? $style_row['imageset_name'] : '')		);	}	/**	* Add new style	*/	function add($mode)	{		global $phpbb_root_path, $phpEx, $config, $db, $cache, $user, $template;		$l_type = strtoupper($mode);		$element_ary = array('template' => STYLES_TEMPLATE_TABLE, 'theme' => STYLES_THEME_TABLE, 'imageset' => STYLES_IMAGESET_TABLE);		$error = array();		$style_row = array(			$mode . '_name'			=> utf8_normalize_nfc(request_var('name', '', true)),			$mode . '_copyright'	=> utf8_normalize_nfc(request_var('copyright', '', true)),			'template_id'			=> 0,			'theme_id'				=> 0,			'imageset_id'			=> 0,			'store_db'				=> request_var('store_db', 0),			'style_active'			=> request_var('style_active', 1),			'style_default'			=> request_var('style_default', 0),		);		$basis = request_var('basis', 0);		$update = (isset($_POST['update'])) ? true : false;		if ($basis)		{			switch ($mode)			{				case 'style':					$sql_select = 'template_id, theme_id, imageset_id';					$sql_from = STYLES_TABLE;				break;				case 'template':					$sql_select = 'template_id';					$sql_from = STYLES_TEMPLATE_TABLE;				break;				case 'theme':					$sql_select = 'theme_id';					$sql_from = STYLES_THEME_TABLE;				break;				case 'imageset':					$sql_select = 'imageset_id';					$sql_from = STYLES_IMAGESET_TABLE;				break;			}			$sql = "SELECT $sql_select				FROM $sql_from				WHERE {$mode}_id = $basis";			$result = $db->sql_query($sql);			$row = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			if (!$row)			{				$error[] = $user->lang['NO_' . $l_type];			}			if (!sizeof($error))			{				$style_row['template_id']	= (isset($row['template_id'])) ? $row['template_id'] : $style_row['template_id'];				$style_row['theme_id']		= (isset($row['theme_id'])) ? $row['theme_id'] : $style_row['theme_id'];				$style_row['imageset_id']	= (isset($row['imageset_id'])) ? $row['imageset_id'] : $style_row['imageset_id'];			}		}		if ($update)		{			$style_row['template_id'] = request_var('template_id', $style_row['template_id']);			$style_row['theme_id'] = request_var('theme_id', $style_row['theme_id']);			$style_row['imageset_id'] = request_var('imageset_id', $style_row['imageset_id']);			if ($mode == 'style' && (!$style_row['template_id'] || !$style_row['theme_id'] || !$style_row['imageset_id']))			{				$error[] = $user->lang['STYLE_ERR_NO_IDS'];			}		}		// User has submitted form and no errors have occurred		if ($update && !sizeof($error))		{			if ($mode == 'style')			{				$style_row['style_id'] = 0;				$this->install_style($error, 'add', '', $style_row['style_id'], $style_row['style_name'], '', $style_row['style_copyright'], $style_row['style_active'], $style_row['style_default'], $style_row);			}			if (!sizeof($error))			{				$cache->destroy('sql', STYLES_TABLE);				$message = ($style_row['store_db']) ? '_ADDED_DB' : '_ADDED';				trigger_error($user->lang[$l_type . $message] . adm_back_link($this->u_action));			}		}		if ($mode == 'style')		{			foreach ($element_ary as $element => $table)			{				$sql = "SELECT {$element}_id, {$element}_name					FROM $table					ORDER BY {$element}_id ASC";				$result = $db->sql_query($sql);				${$element . '_options'} = '';				while ($row = $db->sql_fetchrow($result))				{					$selected = ($row[$element . '_id'] == $style_row[$element . '_id']) ? ' selected="selected"' : '';					${$element . '_options'} .= '<option value="' . $row[$element . '_id'] . '"' . $selected . '>' . $row[$element . '_name'] . '</option>';				}				$db->sql_freeresult($result);			}		}		$this->page_title = 'ADD_' . $l_type;		$template->assign_vars(array(			'S_DETAILS'			=> true,			'S_ADD'				=> true,			'S_ERROR_MSG'		=> (sizeof($error)) ? true : false,			'S_STYLE'			=> ($mode == 'style') ? true : false,			'S_TEMPLATE'		=> ($mode == 'template') ? true : false,			'S_THEME'			=> ($mode == 'theme') ? true : false,			'S_BASIS'			=> ($basis) ? true : false,			'S_STORE_DB'			=> (isset($style_row['storedb'])) ? $style_row['storedb'] : 0,			'S_STYLE_ACTIVE'		=> (isset($style_row['style_active'])) ? $style_row['style_active'] : 0,			'S_STYLE_DEFAULT'		=> (isset($style_row['style_default'])) ? $style_row['style_default'] : 0,			'S_TEMPLATE_OPTIONS'	=> ($mode == 'style') ? $template_options : '',			'S_THEME_OPTIONS'		=> ($mode == 'style') ? $theme_options : '',			'S_IMAGESET_OPTIONS'	=> ($mode == 'style') ? $imageset_options : '',			'U_ACTION'			=> $this->u_action . '&amp;action=add&amp;basis=' . $basis,			'U_BACK'			=> $this->u_action,			'L_TITLE'				=> $user->lang[$this->page_title],			'L_EXPLAIN'				=> $user->lang[$this->page_title . '_EXPLAIN'],			'L_NAME'				=> $user->lang[$l_type . '_NAME'],			'L_LOCATION'			=> ($mode == 'template' || $mode == 'theme') ? $user->lang[$l_type . '_LOCATION'] : '',			'L_LOCATION_EXPLAIN'	=> ($mode == 'template' || $mode == 'theme') ? $user->lang[$l_type . '_LOCATION_EXPLAIN'] : '',			'ERROR_MSG'			=> (sizeof($error)) ? implode('<br />', $error) : '',			'NAME'				=> $style_row[$mode . '_name'],			'COPYRIGHT'			=> $style_row[$mode . '_copyright'])		);	}	/**					$reqd_template = (isset($installcfg['required_template'])) ? $installcfg['required_template'] : false;					$reqd_theme = (isset($installcfg['required_theme'])) ? $installcfg['required_theme'] : false;					$reqd_imageset = (isset($installcfg['required_imageset'])) ? $installcfg['required_imageset'] : false;					// Check to see if each element is already installed, if it is grab the id					foreach ($element_ary as $element => $table)					{						$style_row = array_merge($style_row, array(							$element . '_id'			=> 0,							$element . '_name'			=> '',							$element . '_copyright'		=> '')						);			 			$this->test_installed($element, $error, $root_path, ${'reqd_' . $element}, $style_row[$element . '_id'], $style_row[$element . '_name'], $style_row[$element . '_copyright']);	* Is this element installed? If not, grab its cfg details	*/	function test_installed($element, &$error, $root_path, $reqd_name, &$id, &$name, &$copyright)	{		global $db, $user;		switch ($element)		{			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$l_element = strtoupper($element);		$chk_name = ($reqd_name !== false) ? $reqd_name : $name;		$sql = "SELECT {$element}_id, {$element}_name			FROM $sql_from			WHERE {$element}_name = '" . $db->sql_escape($chk_name) . "'";		$result = $db->sql_query($sql);		if ($row = $db->sql_fetchrow($result))		{			$name = $row[$element . '_name'];			$id = $row[$element . '_id'];		}		else		{			if (!($cfg = @file("$root_path$element/$element.cfg")))			{				$error[] = sprintf($user->lang['REQUIRES_' . $l_element], $reqd_name);				return false;			}			$cfg = parse_cfg_file("$root_path$element/$element.cfg", $cfg);			$name = $cfg['name'];			$copyright = $cfg['copyright'];			$id = 0;			unset($cfg);		}		$db->sql_freeresult($result);	}	/**	* Install/Add style	*/	function install_style(&$error, $action, $root_path, &$id, $name, $path, $copyright, $active, $default, &$style_row, $template_root_path = false, $template_path = false, $theme_root_path = false, $theme_path = false, $imageset_root_path = false, $imageset_path = false)	{		global $config, $db, $user;		$element_ary = array('template', 'theme', 'imageset');		if (!$name)		{			$error[] = $user->lang['STYLE_ERR_STYLE_NAME'];		}		// Check length settings		if (utf8_strlen($name) > 30)		{			$error[] = $user->lang['STYLE_ERR_NAME_LONG'];		}		if (utf8_strlen($copyright) > 60)		{			$error[] = $user->lang['STYLE_ERR_COPY_LONG'];		}		// Check if the name already exist		$sql = 'SELECT style_id			FROM ' . STYLES_TABLE . "			WHERE style_name = '" . $db->sql_escape($name) . "'";		$result = $db->sql_query($sql);		$row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if ($row)		{			$error[] = $user->lang['STYLE_ERR_NAME_EXIST'];		}		if (sizeof($error))		{			return false;		}		foreach ($element_ary as $element)		{			// Zero id value ... need to install element ... run usual checks			// and do the install if necessary			if (!$style_row[$element . '_id'])			{				$this->install_element($element, $error, $action, (${$element . '_root_path'}) ? ${$element . '_root_path'} : $root_path, $style_row[$element . '_id'], $style_row[$element . '_name'], (${$element . '_path'}) ? ${$element . '_path'} : $path, $style_row[$element . '_copyright']);			}		}		if (!$style_row['template_id'] || !$style_row['theme_id'] || !$style_row['imageset_id'])		{			$error[] = $user->lang['STYLE_ERR_NO_IDS'];		}		if (sizeof($error))		{			return false;		}		$db->sql_transaction('begin');		$sql_ary = array(			'style_name'		=> $name,			'style_copyright'	=> $copyright,			'style_active'		=> (int) $active,			'template_id'		=> (int) $style_row['template_id'],			'theme_id'			=> (int) $style_row['theme_id'],			'imageset_id'		=> (int) $style_row['imageset_id'],		);		$sql = 'INSERT INTO ' . STYLES_TABLE . '			' . $db->sql_build_array('INSERT', $sql_ary);		$db->sql_query($sql);		$id = $db->sql_nextid();		if ($default)		{			$sql = 'UPDATE ' . USERS_TABLE . "				SET user_style = $id				WHERE user_style = " . $config['default_style'];			$db->sql_query($sql);			set_config('default_style', $id);		}		$db->sql_transaction('commit');		add_log('admin', 'LOG_STYLE_ADD', $name);	}	/**	* Install/add an element, doing various checks as we go	*/	function install_element($mode, &$error, $action, $root_path, &$id, $name, $path, $copyright, $store_db = 0)	{		global $phpbb_root_path, $db, $user;		// we parse the cfg here (again)		$cfg_data = parse_cfg_file("$root_path$mode/$mode.cfg");		switch ($mode)		{			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$l_type = strtoupper($mode);		if (!$name)		{			$error[] = $user->lang[$l_type . '_ERR_STYLE_NAME'];		}		// Check length settings		if (utf8_strlen($name) > 30)		{			$error[] = $user->lang[$l_type . '_ERR_NAME_LONG'];		}		if (utf8_strlen($copyright) > 60)		{			$error[] = $user->lang[$l_type . '_ERR_COPY_LONG'];		}		// Check if the name already exist		$sql = "SELECT {$mode}_id			FROM $sql_from			WHERE {$mode}_name = '" . $db->sql_escape($name) . "'";		$result = $db->sql_query($sql);		$row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if ($row)		{			// If it exist, we just use the style on installation			if ($action == 'install')			{				$id = $row[$mode . '_id'];				return false;			}			$error[] = $user->lang[$l_type . '_ERR_NAME_EXIST'];		}		if (isset($cfg_data['inherit_from']) && $cfg_data['inherit_from'])		{			if ($mode === 'template')			{				$select_bf = ', bbcode_bitfield';			}			else			{				$select_bf = '';			}			$sql = "SELECT {$mode}_id, {$mode}_name, {$mode}_path, {$mode}_storedb $select_bf				FROM $sql_from				WHERE {$mode}_name = '" . $db->sql_escape($cfg_data['inherit_from']) . "'					AND {$mode}_inherits_id = 0";			$result = $db->sql_query($sql);			$row = $db->sql_fetchrow($result);			$db->sql_freeresult($result);			if (!$row)			{				$error[] = sprintf($user->lang[$l_type . '_ERR_REQUIRED_OR_INCOMPLETE'], $cfg_data['inherit_from']);			}			else			{				$inherit_id = $row["{$mode}_id"];				$inherit_path = $row["{$mode}_path"];				$inherit_bf = ($mode === 'template') ? $row["bbcode_bitfield"] : false;				$cfg_data['store_db'] = $row["{$mode}_storedb"];				$store_db = $row["{$mode}_storedb"];			}		}		else		{			$inherit_id = 0;			$inherit_path = '';			$inherit_bf = false;		}		if (sizeof($error))		{			return false;		}		$sql_ary = array(			$mode . '_name'			=> $name,			$mode . '_copyright'	=> $copyright,			$mode . '_path'			=> $path,		);		switch ($mode)		{			case 'template':				// We check if the template author defined a different bitfield				if (!empty($cfg_data['template_bitfield']))				{					$sql_ary['bbcode_bitfield'] = $cfg_data['template_bitfield'];				}				else if ($inherit_bf)				{					$sql_ary['bbcode_bitfield'] = $inherit_bf;				}				else				{					$sql_ary['bbcode_bitfield'] = TEMPLATE_BITFIELD;				}				// We set a pre-defined bitfield here which we may use further in 3.2				$sql_ary += array(					'template_storedb'		=> $store_db,				);				if (isset($cfg_data['inherit_from']) && $cfg_data['inherit_from'])				{					$sql_ary += array(						'template_inherits_id'	=> $inherit_id,						'template_inherit_path' => $inherit_path,					);				}			break;			case 'theme':				// We are only interested in the theme configuration for now				if (isset($cfg_data['parse_css_file']) && $cfg_data['parse_css_file'])				{					$store_db = 1;				}				$sql_ary += array(					'theme_storedb'	=> $store_db,					'theme_data'	=> ($store_db) ? $this->db_theme_data($sql_ary, false, $root_path) : '',					'theme_mtime'	=> (int) filemtime("{$phpbb_root_path}styles/$path/theme/stylesheet.css")				);			break;			// all the heavy lifting is done later			case 'imageset':			break;		}		$db->sql_transaction('begin');		$sql = "INSERT INTO $sql_from			" . $db->sql_build_array('INSERT', $sql_ary);		$db->sql_query($sql);		$id = $db->sql_nextid();		if ($mode == 'template' && $store_db)		{			$filelist = filelist("{$root_path}template", '', 'html');			$this->store_templates('insert', $id, $path, $filelist);		}		else if ($mode == 'imageset')		{			$cfg_data = parse_cfg_file("$root_path$mode/imageset.cfg");			$imageset_definitions = array();			foreach ($this->imageset_keys as $topic => $key_array)			{				$imageset_definitions = array_merge($imageset_definitions, $key_array);			}			foreach ($cfg_data as $key => $value)			{				if (strpos($value, '*') !== false)				{					if (substr($value, -1, 1) === '*')					{						list($image_filename, $image_height) = explode('*', $value);						$image_width = 0;					}					else					{						list($image_filename, $image_height, $image_width) = explode('*', $value);					}				}				else				{					$image_filename = $value;					$image_height = $image_width = 0;				}				if (strpos($key, 'img_') === 0 && $image_filename)				{					$key = substr($key, 4);					if (in_array($key, $imageset_definitions))					{						$sql_ary = array(							'image_name'		=> $key,							'image_filename'	=> str_replace('{PATH}', "styles/$path/imageset/", trim($image_filename)),							'image_height'		=> (int) $image_height,							'image_width'		=> (int) $image_width,							'imageset_id'		=> (int) $id,							'image_lang'		=> '',						);						$db->sql_query('INSERT INTO ' . STYLES_IMAGESET_DATA_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));					}				}			}			unset($cfg_data);			$sql = 'SELECT lang_dir				FROM ' . LANG_TABLE;			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				if (@file_exists("$root_path$mode/{$row['lang_dir']}/imageset.cfg"))				{					$cfg_data_imageset_data = parse_cfg_file("$root_path$mode/{$row['lang_dir']}/imageset.cfg");					foreach ($cfg_data_imageset_data as $image_name => $value)					{						if (strpos($value, '*') !== false)						{							if (substr($value, -1, 1) === '*')							{								list($image_filename, $image_height) = explode('*', $value);								$image_width = 0;							}							else							{								list($image_filename, $image_height, $image_width) = explode('*', $value);							}						}						else						{							$image_filename = $value;							$image_height = $image_width = 0;						}						if (strpos($image_name, 'img_') === 0 && $image_filename)						{							$image_name = substr($image_name, 4);							if (in_array($image_name, $imageset_definitions))							{								$sql_ary = array(									'image_name'		=> $image_name,									'image_filename'	=> $image_filename,									'image_height'		=> (int) $image_height,									'image_width'		=> (int) $image_width,									'imageset_id'		=> (int) $id,									'image_lang'		=> $row['lang_dir'],								);								$db->sql_query('INSERT INTO ' . STYLES_IMAGESET_DATA_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));							}						}					}					unset($cfg_data_imageset_data);				}			}			$db->sql_freeresult($result);		}		$db->sql_transaction('commit');		$log = ($store_db) ? 'LOG_' . $l_type . '_ADD_DB' : 'LOG_' . $l_type . '_ADD_FS';		add_log('admin', $log, $name);		// Return store_db in case it had to be altered		return $store_db;	}	/**	* Checks downwards dependencies	*	* @access public	* @param string $mode The element type to check - only template is supported	* @param int $id The template id	* @returns false if no component inherits, array with name, path and id for each subtemplate otherwise	*/	function check_inheritance($mode, $id)	{		global $db;		$l_type = strtoupper($mode);		switch ($mode)		{			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$sql = "SELECT {$mode}_id, {$mode}_name, {$mode}_path			FROM $sql_from			WHERE {$mode}_inherits_id = " . (int) $id;		$result = $db->sql_query($sql);		$names = array();		while ($row = $db->sql_fetchrow($result))		{			$names[$row["{$mode}_id"]] = array(				"{$mode}_id" => $row["{$mode}_id"],				"{$mode}_name" => $row["{$mode}_name"],				"{$mode}_path" => $row["{$mode}_path"],			);		}		$db->sql_freeresult($result);		if (sizeof($names))		{			return $names;		}		else		{			return false;		}	}	/**	* Checks upwards dependencies	*	* @access public	* @param string $mode The element type to check - only template is supported	* @param int $id The template id	* @returns false if the component does not inherit, array with name, path and id otherwise	*/	function get_super($mode, $id)	{		global $db;		$l_type = strtoupper($mode);		switch ($mode)		{			case 'template':				$sql_from = STYLES_TEMPLATE_TABLE;			break;			case 'theme':				$sql_from = STYLES_THEME_TABLE;			break;			case 'imageset':				$sql_from = STYLES_IMAGESET_TABLE;			break;		}		$sql = "SELECT {$mode}_inherits_id			FROM $sql_from			WHERE {$mode}_id = " . (int) $id;		$result = $db->sql_query_limit($sql, 1);		if ($row = $db->sql_fetchrow($result))		{			$db->sql_freeresult($result);		}		else		{			return false;		}		$super_id = $row["{$mode}_inherits_id"];		$sql = "SELECT {$mode}_id, {$mode}_name, {$mode}_path			FROM $sql_from			WHERE {$mode}_id = " . (int) $super_id;		$result = $db->sql_query_limit($sql, 1);		if ($row = $db->sql_fetchrow($result))		{			$db->sql_freeresult($result);			return $row;		}		return false;	}	/**	* Moves a template set and its subtemplates to the database	*	* @access public	* @param string $mode The component to move - only template is supported	* @param int $id The template id	*/	function store_in_db($mode, $id)	{		global $db, $user;		$error = array();		$l_type = strtoupper($mode);		if ($super = $this->get_super($mode, $id))		{			$error[] = (sprintf($user->lang["{$l_type}_INHERITS"], $super['template_name']));			return $error;		}		$sql = "SELECT {$mode}_id, {$mode}_name, {$mode}_path			FROM " . STYLES_TEMPLATE_TABLE . '			WHERE template_id = ' . (int) $id;		$result = $db->sql_query_limit($sql, 1);		if ($row = $db->sql_fetchrow($result))		{			$db->sql_freeresult($result);			$subs = $this->check_inheritance($mode, $id);			$this->_store_in_db($mode, $id, $row["{$mode}_path"]);			if ($subs && sizeof($subs))			{				foreach ($subs as $sub_id => $sub)				{					if ($err = $this->_store_in_db($mode, $sub["{$mode}_id"], $sub["{$mode}_path"]))					{						$error[] = $err;					}				}			}		}		if (sizeof($error))		{			return $error;		}		return false;	}	/**	* Moves a template set to the database	*	* @access private	* @param string $mode The component to move - only template is supported	* @param int $id The template id	* @param string $path TThe path to the template files	*/	function _store_in_db($mode, $id, $path)	{		global $phpbb_root_path, $db;		$filelist = filelist("{$phpbb_root_path}styles/{$path}/template", '', 'html');		$this->store_templates('insert', $id, $path, $filelist);		// Okay, we do the query here -shouldn't be triggered often.		$sql = 'UPDATE ' . STYLES_TEMPLATE_TABLE . '						SET template_storedb = 1						WHERE template_id = ' . $id;		$db->sql_query($sql);	}	/**	* Moves a template set and its subtemplates to the filesystem	*	* @access public	* @param string $mode The component to move - only template is supported	* @param int $id The template id	*/	function store_in_fs($mode, $id)	{		global $db, $user;		$error = array();		$l_type = strtoupper($mode);		if ($super = $this->get_super($mode, $id))		{			$error[] = (sprintf($user->lang["{$l_type}_INHERITS"], $super['template_name']));			return($error);		}		$sql = "SELECT {$mode}_id, {$mode}_name, {$mode}_path			FROM " . STYLES_TEMPLATE_TABLE . '			WHERE template_id = ' . (int) $id;		$result = $db->sql_query_limit($sql, 1);		if ($row = $db->sql_fetchrow($result))		{			$db->sql_freeresult($result);			if (!sizeof($error))			{				$subs = $this->check_inheritance($mode, $id);				$this->_store_in_fs($mode, $id, $row["{$mode}_path"]);				if ($subs && sizeof($subs))				{					foreach ($subs as $sub_id => $sub)					{						$this->_store_in_fs($mode, $sub["{$mode}_id"], $sub["{$mode}_path"]);					}				}			}			if (sizeof($error))			{				$this->store_in_db($id, $mode);				return $error;			}		}		return false;	}	/**	* Moves a template set to the filesystem	*	* @access private	* @param string $mode The component to move - only template is supported	* @param int $id The template id	* @param string $path The path to the template	*/	function _store_in_fs($mode, $id, $path)	{		global $phpbb_root_path, $db, $user, $safe_mode;		$store_db = 0;		$error = array();		if (!$safe_mode && phpbb_is_writable("{$phpbb_root_path}styles/{$path}/template"))		{			$sql = 'SELECT *					FROM ' . STYLES_TEMPLATE_DATA_TABLE . "					WHERE template_id = $id";			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				if (!($fp = @fopen("{$phpbb_root_path}styles/{$path}/template/" . $row['template_filename'], 'wb')))				{					$store_db = 1;					$error[] = $user->lang['EDIT_TEMPLATE_STORED_DB'];					break;				}				fwrite($fp, $row['template_data']);				fclose($fp);			}			$db->sql_freeresult($result);			if (!$store_db)			{				$sql = 'DELETE FROM ' . STYLES_TEMPLATE_DATA_TABLE . "						WHERE template_id = $id";				$db->sql_query($sql);			}		}		if (sizeof($error))		{			return $error;		}		$sql = 'UPDATE ' . STYLES_TEMPLATE_TABLE . '				SET template_storedb = 0				WHERE template_id = ' . $id;		$db->sql_query($sql);		return false;	}}?>
<?php/**** @package phpBB3* @version $Id$* @copyright (c) 2006 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License** This file creates SQL statements to upgrade phpBB on MySQL 3.x/4.0.x to 4.1.x/5.x**///// Security message://// This script is potentially dangerous.// Remove or comment the next line (die(".... ) to enable this script.// Do NOT FORGET to either remove this script or disable it after you have used it.//die("Please read the first lines of this script for instructions on how to enable it");define('IN_PHPBB', true);$phpbb_root_path = (defined('PHPBB_ROOT_PATH')) ? PHPBB_ROOT_PATH : './';$phpEx = substr(strrchr(__FILE__, '.'), 1);include($phpbb_root_path . 'common.' . $phpEx);$prefix = $table_prefix;$newline = "\n";if (PHP_SAPI !== 'cli'){	$newline = '<br>';}$sql = 'DESCRIBE ' . POSTS_TABLE . ' post_text';$result = $db->sql_query($sql);$row = $db->sql_fetchrow($result);$db->sql_freeresult($result);$mysql_indexer = $drop_index = false;if (strtolower($row['Type']) === 'mediumtext'){	$mysql_indexer = true;}if (strtolower($row['Key']) === 'mul'){	$drop_index = true;}echo "USE $dbname;$newline$newline";@set_time_limit(0);$schema_data = get_schema_struct();$dbms_type_map = array(	'mysql_41'	=> array(		'INT:'		=> 'int(%d)',		'BINT'		=> 'bigint(20)',		'UINT'		=> 'mediumint(8) UNSIGNED',		'UINT:'		=> 'int(%d) UNSIGNED',		'TINT:'		=> 'tinyint(%d)',		'USINT'		=> 'smallint(4) UNSIGNED',		'BOOL'		=> 'tinyint(1) UNSIGNED',		'VCHAR'		=> 'varchar(255)',		'VCHAR:'	=> 'varchar(%d)',		'CHAR:'		=> 'char(%d)',		'XSTEXT'	=> 'text',		'XSTEXT_UNI'=> 'varchar(100)',		'STEXT'		=> 'text',		'STEXT_UNI'	=> 'varchar(255)',		'TEXT'		=> 'text',		'TEXT_UNI'	=> 'text',		'MTEXT'		=> 'mediumtext',		'MTEXT_UNI'	=> 'mediumtext',		'TIMESTAMP'	=> 'int(11) UNSIGNED',		'DECIMAL'	=> 'decimal(5,2)',		'DECIMAL:'	=> 'decimal(%d,2)',		'PDECIMAL'	=> 'decimal(6,3)',		'PDECIMAL:'	=> 'decimal(%d,3)',		'VCHAR_UNI'	=> 'varchar(255)',		'VCHAR_UNI:'=> 'varchar(%d)',		'VCHAR_CI'	=> 'varchar(255)',		'VARBINARY'	=> 'varbinary(255)',	),	'mysql_40'	=> array(		'INT:'		=> 'int(%d)',		'BINT'		=> 'bigint(20)',		'UINT'		=> 'mediumint(8) UNSIGNED',		'UINT:'		=> 'int(%d) UNSIGNED',		'TINT:'		=> 'tinyint(%d)',		'USINT'		=> 'smallint(4) UNSIGNED',		'BOOL'		=> 'tinyint(1) UNSIGNED',		'VCHAR'		=> 'varbinary(255)',		'VCHAR:'	=> 'varbinary(%d)',		'CHAR:'		=> 'binary(%d)',		'XSTEXT'	=> 'blob',		'XSTEXT_UNI'=> 'blob',		'STEXT'		=> 'blob',		'STEXT_UNI'	=> 'blob',		'TEXT'		=> 'blob',		'TEXT_UNI'	=> 'blob',		'MTEXT'		=> 'mediumblob',		'MTEXT_UNI'	=> 'mediumblob',		'TIMESTAMP'	=> 'int(11) UNSIGNED',		'DECIMAL'	=> 'decimal(5,2)',		'DECIMAL:'	=> 'decimal(%d,2)',		'PDECIMAL'	=> 'decimal(6,3)',		'PDECIMAL:'	=> 'decimal(%d,3)',		'VCHAR_UNI'	=> 'blob',		'VCHAR_UNI:'=> array('varbinary(%d)', 'limit' => array('mult', 3, 255, 'blob')),		'VCHAR_CI'	=> 'blob',		'VARBINARY'	=> 'varbinary(255)',	),);foreach ($schema_data as $table_name => $table_data){	$table_name = str_replace('phpbb_', $prefix, $table_name);	// Write comment about table	echo "# Table: '{$table_name}'$newline";	// Create Table statement	$generator = $textimage = false;	// Do we need to DROP a fulltext index before we alter the table?	if ($table_name == ($prefix . 'posts') && $drop_index)	{		echo "ALTER TABLE {$table_name}{$newline}";		echo "DROP INDEX post_text,{$newline}DROP INDEX post_subject,{$newline}DROP INDEX post_content;{$newline}{$newline}";	}	$line = "ALTER TABLE {$table_name} $newline";	// Table specific so we don't get overlap	$modded_array = array();	// Write columns one by one...	foreach ($table_data['COLUMNS'] as $column_name => $column_data)	{		// Get type		if (strpos($column_data[0], ':') !== false)		{			list($orig_column_type, $column_length) = explode(':', $column_data[0]);			$column_type = sprintf($dbms_type_map['mysql_41'][$orig_column_type . ':'], $column_length);			if (isset($dbms_type_map['mysql_40'][$orig_column_type . ':']['limit'][0]))			{				switch ($dbms_type_map['mysql_40'][$orig_column_type . ':']['limit'][0])				{					case 'mult':						if (($column_length * $dbms_type_map['mysql_40'][$orig_column_type . ':']['limit'][1]) > $dbms_type_map['mysql_40'][$orig_column_type . ':']['limit'][2])						{							$modded_array[$column_name] = $column_type;						}					break;				}			}			$orig_column_type .= ':';		}		else		{			$orig_column_type = $column_data[0];			$other_column_type = $dbms_type_map['mysql_40'][$column_data[0]];			if ($other_column_type == 'text' || $other_column_type == 'blob')			{				$modded_array[$column_name] = $column_type;			}			$column_type = $dbms_type_map['mysql_41'][$column_data[0]];		}		// Adjust default value if db-dependant specified		if (is_array($column_data[1]))		{			$column_data[1] = (isset($column_data[1][$dbms])) ? $column_data[1][$dbms] : $column_data[1]['default'];		}		$line .= "\tMODIFY {$column_name} {$column_type} ";		// For hexadecimal values do not use single quotes		if (!is_null($column_data[1]) && substr($column_type, -4) !== 'text' && substr($column_type, -4) !== 'blob')		{			$line .= (strpos($column_data[1], '0x') === 0) ? "DEFAULT {$column_data[1]} " : "DEFAULT '{$column_data[1]}' ";		}		$line .= 'NOT NULL';		if (isset($column_data[2]))		{			if ($column_data[2] == 'auto_increment')			{				$line .= ' auto_increment';			}			else if ($column_data[2] == 'true_sort')			{				$line .= ' COLLATE utf8_unicode_ci';			}			else if ($column_data[2] == 'no_sort')			{				$line .= ' COLLATE utf8_bin';			}		}		else if (preg_match('/(?:var)?char|(?:medium)?text/i', $column_type))		{			$line .= ' COLLATE utf8_bin';		}		$line .= ",$newline";	}	// Write Keys	if (isset($table_data['KEYS']))	{		foreach ($table_data['KEYS'] as $key_name => $key_data)		{			$temp = '';			if (!is_array($key_data[1]))			{				$key_data[1] = array($key_data[1]);			}			$temp .= ($key_data[0] == 'INDEX') ? "\tADD KEY" : '';			$temp .= ($key_data[0] == 'UNIQUE') ? "\tADD UNIQUE" : '';			$repair = false;			foreach ($key_data[1] as $key => $col_name)			{				if (isset($modded_array[$col_name]))				{					$repair = true;				}			}			if ($repair)			{				$line .= "\tDROP INDEX " . $key_name . ",$newline";				$line .= $temp;				$line .= ' ' . $key_name . ' (' . implode(', ', $key_data[1]) . "),$newline";			}		}	}	//$line .= "\tCONVERT TO CHARACTER SET `utf8`$newline";	$line .= "\tDEFAULT CHARSET=utf8 COLLATE=utf8_bin;$newline$newline";	echo $line . "$newline";	// Do we now need to re-add the fulltext index? ;)	if ($table_name == ($prefix . 'posts') && $drop_index)	{		echo "ALTER TABLE $table_name ADD FULLTEXT (post_subject), ADD FULLTEXT (post_text), ADD FULLTEXT post_content (post_subject, post_text);{$newline}";	}}/*** Define the basic structure* The format:*		array('{TABLE_NAME}' => {TABLE_DATA})*		{TABLE_DATA}:*			COLUMNS = array({column_name} = array({column_type}, {default}, {auto_increment}))*			PRIMARY_KEY = {column_name(s)}*			KEYS = array({key_name} = array({key_type}, {column_name(s)})),**	Column Types:*	INT:x		=> SIGNED int(x)*	BINT		=> BIGINT*	UINT		=> mediumint(8) UNSIGNED*	UINT:x		=> int(x) UNSIGNED*	TINT:x		=> tinyint(x)*	USINT		=> smallint(4) UNSIGNED (for _order columns)*	BOOL		=> tinyint(1) UNSIGNED*	VCHAR		=> varchar(255)*	CHAR:x		=> char(x)*	XSTEXT_UNI	=> text for storing 100 characters (topic_title for example)*	STEXT_UNI	=> text for storing 255 characters (normal input field with a max of 255 single-byte chars) - same as VCHAR_UNI*	TEXT_UNI	=> text for storing 3000 characters (short text, descriptions, comments, etc.)*	MTEXT_UNI	=> mediumtext (post text, large text)*	VCHAR:x		=> varchar(x)*	TIMESTAMP	=> int(11) UNSIGNED*	DECIMAL		=> decimal number (5,2)*	DECIMAL:	=> decimal number (x,2)*	PDECIMAL	=> precision decimal number (6,3)*	PDECIMAL:	=> precision decimal number (x,3)*	VCHAR_UNI	=> varchar(255) BINARY*	VCHAR_CI	=> varchar_ci for postgresql, others VCHAR*/function get_schema_struct(){	$schema_data = array();	$schema_data['phpbb_attachments'] = array(		'COLUMNS'		=> array(			'attach_id'			=> array('UINT', NULL, 'auto_increment'),			'post_msg_id'		=> array('UINT', 0),			'topic_id'			=> array('UINT', 0),			'in_message'		=> array('BOOL', 0),			'poster_id'			=> array('UINT', 0),			'is_orphan'			=> array('BOOL', 1),			'physical_filename'	=> array('VCHAR', ''),			'real_filename'		=> array('VCHAR', ''),			'download_count'	=> array('UINT', 0),			'attach_comment'	=> array('TEXT_UNI', ''),			'extension'			=> array('VCHAR:100', ''),			'mimetype'			=> array('VCHAR:100', ''),			'filesize'			=> array('UINT:20', 0),			'filetime'			=> array('TIMESTAMP', 0),			'thumbnail'			=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'attach_id',		'KEYS'			=> array(			'filetime'			=> array('INDEX', 'filetime'),			'post_msg_id'		=> array('INDEX', 'post_msg_id'),			'topic_id'			=> array('INDEX', 'topic_id'),			'poster_id'			=> array('INDEX', 'poster_id'),			'is_orphan'			=> array('INDEX', 'is_orphan'),		),	);	$schema_data['phpbb_acl_groups'] = array(		'COLUMNS'		=> array(			'group_id'			=> array('UINT', 0),			'forum_id'			=> array('UINT', 0),			'auth_option_id'	=> array('UINT', 0),			'auth_role_id'		=> array('UINT', 0),			'auth_setting'		=> array('TINT:2', 0),		),		'KEYS'			=> array(			'group_id'		=> array('INDEX', 'group_id'),			'auth_opt_id'	=> array('INDEX', 'auth_option_id'),			'auth_role_id'	=> array('INDEX', 'auth_role_id'),		),	);	$schema_data['phpbb_acl_options'] = array(		'COLUMNS'		=> array(			'auth_option_id'	=> array('UINT', NULL, 'auto_increment'),			'auth_option'		=> array('VCHAR:50', ''),			'is_global'			=> array('BOOL', 0),			'is_local'			=> array('BOOL', 0),			'founder_only'		=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'auth_option_id',		'KEYS'			=> array(			'auth_option'		=> array('UNIQUE', 'auth_option'),		),	);	$schema_data['phpbb_acl_roles'] = array(		'COLUMNS'		=> array(			'role_id'			=> array('UINT', NULL, 'auto_increment'),			'role_name'			=> array('VCHAR_UNI', ''),			'role_description'	=> array('TEXT_UNI', ''),			'role_type'			=> array('VCHAR:10', ''),			'role_order'		=> array('USINT', 0),		),		'PRIMARY_KEY'	=> 'role_id',		'KEYS'			=> array(			'role_type'			=> array('INDEX', 'role_type'),			'role_order'		=> array('INDEX', 'role_order'),		),	);	$schema_data['phpbb_acl_roles_data'] = array(		'COLUMNS'		=> array(			'role_id'			=> array('UINT', 0),			'auth_option_id'	=> array('UINT', 0),			'auth_setting'		=> array('TINT:2', 0),		),		'PRIMARY_KEY'	=> array('role_id', 'auth_option_id'),		'KEYS'			=> array(			'ath_op_id'			=> array('INDEX', 'auth_option_id'),		),	);	$schema_data['phpbb_acl_users'] = array(		'COLUMNS'		=> array(			'user_id'			=> array('UINT', 0),			'forum_id'			=> array('UINT', 0),			'auth_option_id'	=> array('UINT', 0),			'auth_role_id'		=> array('UINT', 0),			'auth_setting'		=> array('TINT:2', 0),		),		'KEYS'			=> array(			'user_id'			=> array('INDEX', 'user_id'),			'auth_option_id'	=> array('INDEX', 'auth_option_id'),			'auth_role_id'		=> array('INDEX', 'auth_role_id'),		),	);	$schema_data['phpbb_banlist'] = array(		'COLUMNS'		=> array(			'ban_id'			=> array('UINT', NULL, 'auto_increment'),			'ban_userid'		=> array('UINT', 0),			'ban_ip'			=> array('VCHAR:40', ''),			'ban_email'			=> array('VCHAR_UNI:100', ''),			'ban_start'			=> array('TIMESTAMP', 0),			'ban_end'			=> array('TIMESTAMP', 0),			'ban_exclude'		=> array('BOOL', 0),			'ban_reason'		=> array('VCHAR_UNI', ''),			'ban_give_reason'	=> array('VCHAR_UNI', ''),		),		'PRIMARY_KEY'			=> 'ban_id',		'KEYS'			=> array(			'ban_end'			=> array('INDEX', 'ban_end'),			'ban_user'			=> array('INDEX', array('ban_userid', 'ban_exclude')),			'ban_email'			=> array('INDEX', array('ban_email', 'ban_exclude')),			'ban_ip'			=> array('INDEX', array('ban_ip', 'ban_exclude')),		),	);	$schema_data['phpbb_bbcodes'] = array(		'COLUMNS'		=> array(			'bbcode_id'				=> array('USINT', 0),			'bbcode_tag'			=> array('VCHAR:16', ''),			'bbcode_helpline'		=> array('VCHAR_UNI', ''),			'display_on_posting'	=> array('BOOL', 0),			'bbcode_match'			=> array('TEXT_UNI', ''),			'bbcode_tpl'			=> array('MTEXT_UNI', ''),			'first_pass_match'		=> array('MTEXT_UNI', ''),			'first_pass_replace'	=> array('MTEXT_UNI', ''),			'second_pass_match'		=> array('MTEXT_UNI', ''),			'second_pass_replace'	=> array('MTEXT_UNI', ''),		),		'PRIMARY_KEY'	=> 'bbcode_id',		'KEYS'			=> array(			'display_on_post'		=> array('INDEX', 'display_on_posting'),		),	);	$schema_data['phpbb_bookmarks'] = array(		'COLUMNS'		=> array(			'topic_id'			=> array('UINT', 0),			'user_id'			=> array('UINT', 0),		),		'PRIMARY_KEY'			=> array('topic_id', 'user_id'),	);	$schema_data['phpbb_bots'] = array(		'COLUMNS'		=> array(			'bot_id'			=> array('UINT', NULL, 'auto_increment'),			'bot_active'		=> array('BOOL', 1),			'bot_name'			=> array('STEXT_UNI', ''),			'user_id'			=> array('UINT', 0),			'bot_agent'			=> array('VCHAR', ''),			'bot_ip'			=> array('VCHAR', ''),		),		'PRIMARY_KEY'	=> 'bot_id',		'KEYS'			=> array(			'bot_active'		=> array('INDEX', 'bot_active'),		),	);	$schema_data['phpbb_config'] = array(		'COLUMNS'		=> array(			'config_name'		=> array('VCHAR', ''),			'config_value'		=> array('VCHAR_UNI', ''),			'is_dynamic'		=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'config_name',		'KEYS'			=> array(			'is_dynamic'		=> array('INDEX', 'is_dynamic'),		),	);	$schema_data['phpbb_confirm'] = array(		'COLUMNS'		=> array(			'confirm_id'		=> array('CHAR:32', ''),			'session_id'		=> array('CHAR:32', ''),			'confirm_type'		=> array('TINT:3', 0),			'code'				=> array('VCHAR:8', ''),			'seed'				=> array('UINT:10', 0),			'attempts'			=> array('UINT', 0),		),		'PRIMARY_KEY'	=> array('session_id', 'confirm_id'),		'KEYS'			=> array(			'confirm_type'		=> array('INDEX', 'confirm_type'),		),	);	$schema_data['phpbb_disallow'] = array(		'COLUMNS'		=> array(			'disallow_id'		=> array('UINT', NULL, 'auto_increment'),			'disallow_username'	=> array('VCHAR_UNI:255', ''),		),		'PRIMARY_KEY'	=> 'disallow_id',	);	$schema_data['phpbb_drafts'] = array(		'COLUMNS'		=> array(			'draft_id'			=> array('UINT', NULL, 'auto_increment'),			'user_id'			=> array('UINT', 0),			'topic_id'			=> array('UINT', 0),			'forum_id'			=> array('UINT', 0),			'save_time'			=> array('TIMESTAMP', 0),			'draft_subject'		=> array('STEXT_UNI', ''),			'draft_message'		=> array('MTEXT_UNI', ''),		),		'PRIMARY_KEY'	=> 'draft_id',		'KEYS'			=> array(			'save_time'			=> array('INDEX', 'save_time'),		),	);	$schema_data['phpbb_extensions'] = array(		'COLUMNS'		=> array(			'extension_id'		=> array('UINT', NULL, 'auto_increment'),			'group_id'			=> array('UINT', 0),			'extension'			=> array('VCHAR:100', ''),		),		'PRIMARY_KEY'	=> 'extension_id',	);	$schema_data['phpbb_extension_groups'] = array(		'COLUMNS'		=> array(			'group_id'			=> array('UINT', NULL, 'auto_increment'),			'group_name'		=> array('VCHAR_UNI', ''),			'cat_id'			=> array('TINT:2', 0),			'allow_group'		=> array('BOOL', 0),			'download_mode'		=> array('BOOL', 1),			'upload_icon'		=> array('VCHAR', ''),			'max_filesize'		=> array('UINT:20', 0),			'allowed_forums'	=> array('TEXT', ''),			'allow_in_pm'		=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'group_id',	);	$schema_data['phpbb_forums'] = array(		'COLUMNS'		=> array(			'forum_id'				=> array('UINT', NULL, 'auto_increment'),			'parent_id'				=> array('UINT', 0),			'left_id'				=> array('UINT', 0),			'right_id'				=> array('UINT', 0),			'forum_parents'			=> array('MTEXT', ''),			'forum_name'			=> array('STEXT_UNI', ''),			'forum_desc'			=> array('TEXT_UNI', ''),			'forum_desc_bitfield'	=> array('VCHAR:255', ''),			'forum_desc_options'	=> array('UINT:11', 7),			'forum_desc_uid'		=> array('VCHAR:8', ''),			'forum_link'			=> array('VCHAR_UNI', ''),			'forum_password'		=> array('VCHAR_UNI:40', ''),			'forum_style'			=> array('UINT', 0),			'forum_image'			=> array('VCHAR', ''),			'forum_rules'			=> array('TEXT_UNI', ''),			'forum_rules_link'		=> array('VCHAR_UNI', ''),			'forum_rules_bitfield'	=> array('VCHAR:255', ''),			'forum_rules_options'	=> array('UINT:11', 7),			'forum_rules_uid'		=> array('VCHAR:8', ''),			'forum_topics_per_page'	=> array('TINT:4', 0),			'forum_type'			=> array('TINT:4', 0),			'forum_status'			=> array('TINT:4', 0),			'forum_posts'			=> array('UINT', 0),			'forum_topics'			=> array('UINT', 0),			'forum_topics_real'		=> array('UINT', 0),			'forum_last_post_id'	=> array('UINT', 0),			'forum_last_poster_id'	=> array('UINT', 0),			'forum_last_post_subject' => array('STEXT_UNI', ''),			'forum_last_post_time'	=> array('TIMESTAMP', 0),			'forum_last_poster_name'=> array('VCHAR_UNI', ''),			'forum_last_poster_colour'=> array('VCHAR:6', ''),			'forum_flags'			=> array('TINT:4', 32),			'forum_options'			=> array('UINT:20', 0),			'display_subforum_list'	=> array('BOOL', 1),			'display_on_index'		=> array('BOOL', 1),			'enable_indexing'		=> array('BOOL', 1),			'enable_icons'			=> array('BOOL', 1),			'enable_prune'			=> array('BOOL', 0),			'prune_next'			=> array('TIMESTAMP', 0),			'prune_days'			=> array('UINT', 0),			'prune_viewed'			=> array('UINT', 0),			'prune_freq'			=> array('UINT', 0),		),		'PRIMARY_KEY'	=> 'forum_id',		'KEYS'			=> array(			'left_right_id'			=> array('INDEX', array('left_id', 'right_id')),			'forum_lastpost_id'		=> array('INDEX', 'forum_last_post_id'),		),	);	$schema_data['phpbb_forums_access'] = array(		'COLUMNS'		=> array(			'forum_id'				=> array('UINT', 0),			'user_id'				=> array('UINT', 0),			'session_id'			=> array('CHAR:32', ''),		),		'PRIMARY_KEY'	=> array('forum_id', 'user_id', 'session_id'),	);	$schema_data['phpbb_forums_track'] = array(		'COLUMNS'		=> array(			'user_id'				=> array('UINT', 0),			'forum_id'				=> array('UINT', 0),			'mark_time'				=> array('TIMESTAMP', 0),		),		'PRIMARY_KEY'	=> array('user_id', 'forum_id'),	);	$schema_data['phpbb_forums_watch'] = array(		'COLUMNS'		=> array(			'forum_id'				=> array('UINT', 0),			'user_id'				=> array('UINT', 0),			'notify_status'			=> array('BOOL', 0),		),		'KEYS'			=> array(			'forum_id'				=> array('INDEX', 'forum_id'),			'user_id'				=> array('INDEX', 'user_id'),			'notify_stat'			=> array('INDEX', 'notify_status'),		),	);	$schema_data['phpbb_groups'] = array(		'COLUMNS'		=> array(			'group_id'				=> array('UINT', NULL, 'auto_increment'),			'group_type'			=> array('TINT:4', 1),			'group_founder_manage'	=> array('BOOL', 0),			'group_skip_auth'		=> array('BOOL', 0),			'group_name'			=> array('VCHAR_CI', ''),			'group_desc'			=> array('TEXT_UNI', ''),			'group_desc_bitfield'	=> array('VCHAR:255', ''),			'group_desc_options'	=> array('UINT:11', 7),			'group_desc_uid'		=> array('VCHAR:8', ''),			'group_display'			=> array('BOOL', 0),			'group_avatar'			=> array('VCHAR', ''),			'group_avatar_type'		=> array('TINT:2', 0),			'group_avatar_width'	=> array('USINT', 0),			'group_avatar_height'	=> array('USINT', 0),			'group_rank'			=> array('UINT', 0),			'group_colour'			=> array('VCHAR:6', ''),			'group_sig_chars'		=> array('UINT', 0),			'group_receive_pm'		=> array('BOOL', 0),			'group_message_limit'	=> array('UINT', 0),			'group_max_recipients'	=> array('UINT', 0),			'group_legend'			=> array('BOOL', 1),		),		'PRIMARY_KEY'	=> 'group_id',		'KEYS'			=> array(			'group_legend_name'		=> array('INDEX', array('group_legend', 'group_name')),		),	);	$schema_data['phpbb_icons'] = array(		'COLUMNS'		=> array(			'icons_id'				=> array('UINT', NULL, 'auto_increment'),			'icons_url'				=> array('VCHAR', ''),			'icons_width'			=> array('TINT:4', 0),			'icons_height'			=> array('TINT:4', 0),			'icons_order'			=> array('UINT', 0),			'display_on_posting'	=> array('BOOL', 1),		),		'PRIMARY_KEY'	=> 'icons_id',		'KEYS'			=> array(			'display_on_posting'	=> array('INDEX', 'display_on_posting'),		),	);	$schema_data['phpbb_lang'] = array(		'COLUMNS'		=> array(			'lang_id'				=> array('TINT:4', NULL, 'auto_increment'),			'lang_iso'				=> array('VCHAR:30', ''),			'lang_dir'				=> array('VCHAR:30', ''),			'lang_english_name'		=> array('VCHAR_UNI:100', ''),			'lang_local_name'		=> array('VCHAR_UNI:255', ''),			'lang_author'			=> array('VCHAR_UNI:255', ''),		),		'PRIMARY_KEY'	=> 'lang_id',		'KEYS'			=> array(			'lang_iso'				=> array('INDEX', 'lang_iso'),		),	);	$schema_data['phpbb_log'] = array(		'COLUMNS'		=> array(			'log_id'				=> array('UINT', NULL, 'auto_increment'),			'log_type'				=> array('TINT:4', 0),			'user_id'				=> array('UINT', 0),			'forum_id'				=> array('UINT', 0),			'topic_id'				=> array('UINT', 0),			'reportee_id'			=> array('UINT', 0),			'log_ip'				=> array('VCHAR:40', ''),			'log_time'				=> array('TIMESTAMP', 0),			'log_operation'			=> array('TEXT_UNI', ''),			'log_data'				=> array('MTEXT_UNI', ''),		),		'PRIMARY_KEY'	=> 'log_id',		'KEYS'			=> array(			'log_type'				=> array('INDEX', 'log_type'),			'forum_id'				=> array('INDEX', 'forum_id'),			'topic_id'				=> array('INDEX', 'topic_id'),			'reportee_id'			=> array('INDEX', 'reportee_id'),			'user_id'				=> array('INDEX', 'user_id'),		),	);	$schema_data['phpbb_moderator_cache'] = array(		'COLUMNS'		=> array(			'forum_id'				=> array('UINT', 0),			'user_id'				=> array('UINT', 0),			'username'				=> array('VCHAR_UNI:255', ''),			'group_id'				=> array('UINT', 0),			'group_name'			=> array('VCHAR_UNI', ''),			'display_on_index'		=> array('BOOL', 1),		),		'KEYS'			=> array(			'disp_idx'				=> array('INDEX', 'display_on_index'),			'forum_id'				=> array('INDEX', 'forum_id'),		),	);	$schema_data['phpbb_modules'] = array(		'COLUMNS'		=> array(			'module_id'				=> array('UINT', NULL, 'auto_increment'),			'module_enabled'		=> array('BOOL', 1),			'module_display'		=> array('BOOL', 1),			'module_basename'		=> array('VCHAR', ''),			'module_class'			=> array('VCHAR:10', ''),			'parent_id'				=> array('UINT', 0),			'left_id'				=> array('UINT', 0),			'right_id'				=> array('UINT', 0),			'module_langname'		=> array('VCHAR', ''),			'module_mode'			=> array('VCHAR', ''),			'module_auth'			=> array('VCHAR', ''),		),		'PRIMARY_KEY'	=> 'module_id',		'KEYS'			=> array(			'left_right_id'			=> array('INDEX', array('left_id', 'right_id')),			'module_enabled'		=> array('INDEX', 'module_enabled'),			'class_left_id'			=> array('INDEX', array('module_class', 'left_id')),		),	);	$schema_data['phpbb_poll_options'] = array(		'COLUMNS'		=> array(			'poll_option_id'		=> array('TINT:4', 0),			'topic_id'				=> array('UINT', 0),			'poll_option_text'		=> array('TEXT_UNI', ''),			'poll_option_total'		=> array('UINT', 0),		),		'KEYS'			=> array(			'poll_opt_id'			=> array('INDEX', 'poll_option_id'),			'topic_id'				=> array('INDEX', 'topic_id'),		),	);	$schema_data['phpbb_poll_votes'] = array(		'COLUMNS'		=> array(			'topic_id'				=> array('UINT', 0),			'poll_option_id'		=> array('TINT:4', 0),			'vote_user_id'			=> array('UINT', 0),			'vote_user_ip'			=> array('VCHAR:40', ''),		),		'KEYS'			=> array(			'topic_id'				=> array('INDEX', 'topic_id'),			'vote_user_id'			=> array('INDEX', 'vote_user_id'),			'vote_user_ip'			=> array('INDEX', 'vote_user_ip'),		),	);	$schema_data['phpbb_posts'] = array(		'COLUMNS'		=> array(			'post_id'				=> array('UINT', NULL, 'auto_increment'),			'topic_id'				=> array('UINT', 0),			'forum_id'				=> array('UINT', 0),			'poster_id'				=> array('UINT', 0),			'icon_id'				=> array('UINT', 0),			'poster_ip'				=> array('VCHAR:40', ''),			'post_time'				=> array('TIMESTAMP', 0),			'post_approved'			=> array('BOOL', 1),			'post_reported'			=> array('BOOL', 0),			'enable_bbcode'			=> array('BOOL', 1),			'enable_smilies'		=> array('BOOL', 1),			'enable_magic_url'		=> array('BOOL', 1),			'enable_sig'			=> array('BOOL', 1),			'post_username'			=> array('VCHAR_UNI:255', ''),			'post_subject'			=> array('STEXT_UNI', '', 'true_sort'),			'post_text'				=> array('MTEXT_UNI', ''),			'post_checksum'			=> array('VCHAR:32', ''),			'post_attachment'		=> array('BOOL', 0),			'bbcode_bitfield'		=> array('VCHAR:255', ''),			'bbcode_uid'			=> array('VCHAR:8', ''),			'post_postcount'		=> array('BOOL', 1),			'post_edit_time'		=> array('TIMESTAMP', 0),			'post_edit_reason'		=> array('STEXT_UNI', ''),			'post_edit_user'		=> array('UINT', 0),			'post_edit_count'		=> array('USINT', 0),			'post_edit_locked'		=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'post_id',		'KEYS'			=> array(			'forum_id'				=> array('INDEX', 'forum_id'),			'topic_id'				=> array('INDEX', 'topic_id'),			'poster_ip'				=> array('INDEX', 'poster_ip'),			'poster_id'				=> array('INDEX', 'poster_id'),			'post_approved'			=> array('INDEX', 'post_approved'),			'post_username'			=> array('INDEX', 'post_username'),			'tid_post_time'			=> array('INDEX', array('topic_id', 'post_time')),		),	);	$schema_data['phpbb_privmsgs'] = array(		'COLUMNS'		=> array(			'msg_id'				=> array('UINT', NULL, 'auto_increment'),			'root_level'			=> array('UINT', 0),			'author_id'				=> array('UINT', 0),			'icon_id'				=> array('UINT', 0),			'author_ip'				=> array('VCHAR:40', ''),			'message_time'			=> array('TIMESTAMP', 0),			'enable_bbcode'			=> array('BOOL', 1),			'enable_smilies'		=> array('BOOL', 1),			'enable_magic_url'		=> array('BOOL', 1),			'enable_sig'			=> array('BOOL', 1),			'message_subject'		=> array('STEXT_UNI', ''),			'message_text'			=> array('MTEXT_UNI', ''),			'message_edit_reason'	=> array('STEXT_UNI', ''),			'message_edit_user'		=> array('UINT', 0),			'message_attachment'	=> array('BOOL', 0),			'bbcode_bitfield'		=> array('VCHAR:255', ''),			'bbcode_uid'			=> array('VCHAR:8', ''),			'message_edit_time'		=> array('TIMESTAMP', 0),			'message_edit_count'	=> array('USINT', 0),			'to_address'			=> array('TEXT_UNI', ''),			'bcc_address'			=> array('TEXT_UNI', ''),			'message_reported'		=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'msg_id',		'KEYS'			=> array(			'author_ip'				=> array('INDEX', 'author_ip'),			'message_time'			=> array('INDEX', 'message_time'),			'author_id'				=> array('INDEX', 'author_id'),			'root_level'			=> array('INDEX', 'root_level'),		),	);	$schema_data['phpbb_privmsgs_folder'] = array(		'COLUMNS'		=> array(			'folder_id'				=> array('UINT', NULL, 'auto_increment'),			'user_id'				=> array('UINT', 0),			'folder_name'			=> array('VCHAR_UNI', ''),			'pm_count'				=> array('UINT', 0),		),		'PRIMARY_KEY'	=> 'folder_id',		'KEYS'			=> array(			'user_id'				=> array('INDEX', 'user_id'),		),	);	$schema_data['phpbb_privmsgs_rules'] = array(		'COLUMNS'		=> array(			'rule_id'				=> array('UINT', NULL, 'auto_increment'),			'user_id'				=> array('UINT', 0),			'rule_check'			=> array('UINT', 0),			'rule_connection'		=> array('UINT', 0),			'rule_string'			=> array('VCHAR_UNI', ''),			'rule_user_id'			=> array('UINT', 0),			'rule_group_id'			=> array('UINT', 0),			'rule_action'			=> array('UINT', 0),			'rule_folder_id'		=> array('INT:11', 0),		),		'PRIMARY_KEY'	=> 'rule_id',		'KEYS'			=> array(			'user_id'				=> array('INDEX', 'user_id'),		),	);	$schema_data['phpbb_privmsgs_to'] = array(		'COLUMNS'		=> array(			'msg_id'				=> array('UINT', 0),			'user_id'				=> array('UINT', 0),			'author_id'				=> array('UINT', 0),			'pm_deleted'			=> array('BOOL', 0),			'pm_new'				=> array('BOOL', 1),			'pm_unread'				=> array('BOOL', 1),			'pm_replied'			=> array('BOOL', 0),			'pm_marked'				=> array('BOOL', 0),			'pm_forwarded'			=> array('BOOL', 0),			'folder_id'				=> array('INT:11', 0),		),		'KEYS'			=> array(			'msg_id'				=> array('INDEX', 'msg_id'),			'author_id'				=> array('INDEX', 'author_id'),			'usr_flder_id'			=> array('INDEX', array('user_id', 'folder_id')),		),	);	$schema_data['phpbb_profile_fields'] = array(		'COLUMNS'		=> array(			'field_id'				=> array('UINT', NULL, 'auto_increment'),			'field_name'			=> array('VCHAR_UNI', ''),			'field_type'			=> array('TINT:4', 0),			'field_ident'			=> array('VCHAR:20', ''),			'field_length'			=> array('VCHAR:20', ''),			'field_minlen'			=> array('VCHAR', ''),			'field_maxlen'			=> array('VCHAR', ''),			'field_novalue'			=> array('VCHAR_UNI', ''),			'field_default_value'	=> array('VCHAR_UNI', ''),			'field_validation'		=> array('VCHAR_UNI:20', ''),			'field_required'		=> array('BOOL', 0),			'field_show_on_reg'		=> array('BOOL', 0),			'field_show_on_vt'		=> array('BOOL', 0),			'field_show_profile'	=> array('BOOL', 0),			'field_hide'			=> array('BOOL', 0),			'field_no_view'			=> array('BOOL', 0),			'field_active'			=> array('BOOL', 0),			'field_order'			=> array('UINT', 0),		),		'PRIMARY_KEY'	=> 'field_id',		'KEYS'			=> array(			'fld_type'			=> array('INDEX', 'field_type'),			'fld_ordr'			=> array('INDEX', 'field_order'),		),	);	$schema_data['phpbb_profile_fields_data'] = array(		'COLUMNS'		=> array(			'user_id'				=> array('UINT', 0),		),		'PRIMARY_KEY'	=> 'user_id',	);	$schema_data['phpbb_profile_fields_lang'] = array(		'COLUMNS'		=> array(			'field_id'				=> array('UINT', 0),			'lang_id'				=> array('UINT', 0),			'option_id'				=> array('UINT', 0),			'field_type'			=> array('TINT:4', 0),			'lang_value'			=> array('VCHAR_UNI', ''),		),		'PRIMARY_KEY'	=> array('field_id', 'lang_id', 'option_id'),	);	$schema_data['phpbb_profile_lang'] = array(		'COLUMNS'		=> array(			'field_id'				=> array('UINT', 0),			'lang_id'				=> array('UINT', 0),			'lang_name'				=> array('VCHAR_UNI', ''),			'lang_explain'			=> array('TEXT_UNI', ''),			'lang_default_value'	=> array('VCHAR_UNI', ''),		),		'PRIMARY_KEY'	=> array('field_id', 'lang_id'),	);	$schema_data['phpbb_ranks'] = array(		'COLUMNS'		=> array(			'rank_id'				=> array('UINT', NULL, 'auto_increment'),			'rank_title'			=> array('VCHAR_UNI', ''),			'rank_min'				=> array('UINT', 0),			'rank_special'			=> array('BOOL', 0),			'rank_image'			=> array('VCHAR', ''),		),		'PRIMARY_KEY'	=> 'rank_id',	);	$schema_data['phpbb_reports'] = array(		'COLUMNS'		=> array(			'report_id'				=> array('UINT', NULL, 'auto_increment'),			'reason_id'				=> array('USINT', 0),			'post_id'				=> array('UINT', 0),			'pm_id'					=> array('UINT', 0),			'user_id'				=> array('UINT', 0),			'user_notify'			=> array('BOOL', 0),			'report_closed'			=> array('BOOL', 0),			'report_time'			=> array('TIMESTAMP', 0),			'report_text'			=> array('MTEXT_UNI', ''),		),		'PRIMARY_KEY'	=> 'report_id',		'KEYS'			=> array(			'post_id'			=> array('INDEX', 'post_id'),			'pm_id'				=> array('INDEX', 'pm_id'),		),	);	$schema_data['phpbb_reports_reasons'] = array(		'COLUMNS'		=> array(			'reason_id'				=> array('USINT', NULL, 'auto_increment'),			'reason_title'			=> array('VCHAR_UNI', ''),			'reason_description'	=> array('MTEXT_UNI', ''),			'reason_order'			=> array('USINT', 0),		),		'PRIMARY_KEY'	=> 'reason_id',	);	$schema_data['phpbb_search_results'] = array(		'COLUMNS'		=> array(			'search_key'			=> array('VCHAR:32', ''),			'search_time'			=> array('TIMESTAMP', 0),			'search_keywords'		=> array('MTEXT_UNI', ''),			'search_authors'		=> array('MTEXT', ''),		),		'PRIMARY_KEY'	=> 'search_key',	);	$schema_data['phpbb_search_wordlist'] = array(		'COLUMNS'		=> array(			'word_id'			=> array('UINT', NULL, 'auto_increment'),			'word_text'			=> array('VCHAR_UNI', ''),			'word_common'		=> array('BOOL', 0),			'word_count'		=> array('UINT', 0),		),		'PRIMARY_KEY'	=> 'word_id',		'KEYS'			=> array(			'wrd_txt'			=> array('UNIQUE', 'word_text'),			'wrd_cnt'			=> array('INDEX', 'word_count'),		),	);	$schema_data['phpbb_search_wordmatch'] = array(		'COLUMNS'		=> array(			'post_id'			=> array('UINT', 0),			'word_id'			=> array('UINT', 0),			'title_match'		=> array('BOOL', 0),		),		'KEYS'			=> array(			'unq_mtch'			=> array('UNIQUE', array('word_id', 'post_id', 'title_match')),			'word_id'			=> array('INDEX', 'word_id'),			'post_id'			=> array('INDEX', 'post_id'),		),	);	$schema_data['phpbb_sessions'] = array(		'COLUMNS'		=> array(			'session_id'			=> array('CHAR:32', ''),			'session_user_id'		=> array('UINT', 0),			'session_forum_id'		=> array('UINT', 0),			'session_last_visit'	=> array('TIMESTAMP', 0),			'session_start'			=> array('TIMESTAMP', 0),			'session_time'			=> array('TIMESTAMP', 0),			'session_ip'			=> array('VCHAR:40', ''),			'session_browser'		=> array('VCHAR:150', ''),			'session_forwarded_for'	=> array('VCHAR:255', ''),			'session_page'			=> array('VCHAR_UNI', ''),			'session_viewonline'	=> array('BOOL', 1),			'session_autologin'		=> array('BOOL', 0),			'session_admin'			=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'session_id',		'KEYS'			=> array(			'session_time'		=> array('INDEX', 'session_time'),			'session_user_id'	=> array('INDEX', 'session_user_id'),			'session_fid'		=> array('INDEX', 'session_forum_id'),		),	);	$schema_data['phpbb_sessions_keys'] = array(		'COLUMNS'		=> array(			'key_id'			=> array('CHAR:32', ''),			'user_id'			=> array('UINT', 0),			'last_ip'			=> array('VCHAR:40', ''),			'last_login'		=> array('TIMESTAMP', 0),		),		'PRIMARY_KEY'	=> array('key_id', 'user_id'),		'KEYS'			=> array(			'last_login'		=> array('INDEX', 'last_login'),		),	);	$schema_data['phpbb_sitelist'] = array(		'COLUMNS'		=> array(			'site_id'		=> array('UINT', NULL, 'auto_increment'),			'site_ip'		=> array('VCHAR:40', ''),			'site_hostname'	=> array('VCHAR', ''),			'ip_exclude'	=> array('BOOL', 0),		),		'PRIMARY_KEY'		=> 'site_id',	);	$schema_data['phpbb_smilies'] = array(		'COLUMNS'		=> array(			'smiley_id'			=> array('UINT', NULL, 'auto_increment'),			// We may want to set 'code' to VCHAR:50 or check if unicode support is possible... at the moment only ASCII characters are allowed.			'code'				=> array('VCHAR_UNI:50', ''),			'emotion'			=> array('VCHAR_UNI:50', ''),			'smiley_url'		=> array('VCHAR:50', ''),			'smiley_width'		=> array('USINT', 0),			'smiley_height'		=> array('USINT', 0),			'smiley_order'		=> array('UINT', 0),			'display_on_posting'=> array('BOOL', 1),		),		'PRIMARY_KEY'	=> 'smiley_id',		'KEYS'			=> array(			'display_on_post'		=> array('INDEX', 'display_on_posting'),		),	);	$schema_data['phpbb_styles'] = array(		'COLUMNS'		=> array(			'style_id'				=> array('UINT', NULL, 'auto_increment'),			'style_name'			=> array('VCHAR_UNI:255', ''),			'style_copyright'		=> array('VCHAR_UNI', ''),			'style_active'			=> array('BOOL', 1),			'template_id'			=> array('UINT', 0),			'theme_id'				=> array('UINT', 0),			'imageset_id'			=> array('UINT', 0),		),		'PRIMARY_KEY'	=> 'style_id',		'KEYS'			=> array(			'style_name'		=> array('UNIQUE', 'style_name'),			'template_id'		=> array('INDEX', 'template_id'),			'theme_id'			=> array('INDEX', 'theme_id'),			'imageset_id'		=> array('INDEX', 'imageset_id'),		),	);	$schema_data['phpbb_styles_template'] = array(		'COLUMNS'		=> array(			'template_id'			=> array('UINT', NULL, 'auto_increment'),			'template_name'			=> array('VCHAR_UNI:255', ''),			'template_copyright'	=> array('VCHAR_UNI', ''),			'template_path'			=> array('VCHAR:100', ''),			'bbcode_bitfield'		=> array('VCHAR:255', 'kNg='),			'template_storedb'		=> array('BOOL', 0),			'template_inherits_id'		=> array('UINT:4', 0),			'template_inherit_path'		=> array('VCHAR', ''),		),		'PRIMARY_KEY'	=> 'template_id',		'KEYS'			=> array(			'tmplte_nm'				=> array('UNIQUE', 'template_name'),		),	);	$schema_data['phpbb_styles_template_data'] = array(		'COLUMNS'		=> array(			'template_id'			=> array('UINT', 0),			'template_filename'		=> array('VCHAR:100', ''),			'template_included'		=> array('TEXT', ''),			'template_mtime'		=> array('TIMESTAMP', 0),			'template_data'			=> array('MTEXT_UNI', ''),		),		'KEYS'			=> array(			'tid'					=> array('INDEX', 'template_id'),			'tfn'					=> array('INDEX', 'template_filename'),		),	);	$schema_data['phpbb_styles_theme'] = array(		'COLUMNS'		=> array(			'theme_id'				=> array('UINT', NULL, 'auto_increment'),			'theme_name'			=> array('VCHAR_UNI:255', ''),			'theme_copyright'		=> array('VCHAR_UNI', ''),			'theme_path'			=> array('VCHAR:100', ''),			'theme_storedb'			=> array('BOOL', 0),			'theme_mtime'			=> array('TIMESTAMP', 0),			'theme_data'			=> array('MTEXT_UNI', ''),		),		'PRIMARY_KEY'	=> 'theme_id',		'KEYS'			=> array(			'theme_name'		=> array('UNIQUE', 'theme_name'),		),	);	$schema_data['phpbb_styles_imageset'] = array(		'COLUMNS'		=> array(			'imageset_id'				=> array('UINT', NULL, 'auto_increment'),			'imageset_name'				=> array('VCHAR_UNI:255', ''),			'imageset_copyright'		=> array('VCHAR_UNI', ''),			'imageset_path'				=> array('VCHAR:100', ''),		),		'PRIMARY_KEY'		=> 'imageset_id',		'KEYS'				=> array(			'imgset_nm'			=> array('UNIQUE', 'imageset_name'),		),	);	$schema_data['phpbb_styles_imageset_data'] = array(		'COLUMNS'		=> array(			'image_id'				=> array('UINT', NULL, 'auto_increment'),			'image_name'			=> array('VCHAR:200', ''),			'image_filename'		=> array('VCHAR:200', ''),			'image_lang'			=> array('VCHAR:30', ''),			'image_height'			=> array('USINT', 0),			'image_width'			=> array('USINT', 0),			'imageset_id'			=> array('UINT', 0),		),		'PRIMARY_KEY'		=> 'image_id',		'KEYS'				=> array(			'i_d'			=> array('INDEX', 'imageset_id'),		),	);	$schema_data['phpbb_topics'] = array(		'COLUMNS'		=> array(			'topic_id'					=> array('UINT', NULL, 'auto_increment'),			'forum_id'					=> array('UINT', 0),			'icon_id'					=> array('UINT', 0),			'topic_attachment'			=> array('BOOL', 0),			'topic_approved'			=> array('BOOL', 1),			'topic_reported'			=> array('BOOL', 0),			'topic_title'				=> array('STEXT_UNI', '', 'true_sort'),			'topic_poster'				=> array('UINT', 0),			'topic_time'				=> array('TIMESTAMP', 0),			'topic_time_limit'			=> array('TIMESTAMP', 0),			'topic_views'				=> array('UINT', 0),			'topic_replies'				=> array('UINT', 0),			'topic_replies_real'		=> array('UINT', 0),			'topic_status'				=> array('TINT:3', 0),			'topic_type'				=> array('TINT:3', 0),			'topic_first_post_id'		=> array('UINT', 0),			'topic_first_poster_name'	=> array('VCHAR_UNI', ''),			'topic_first_poster_colour'	=> array('VCHAR:6', ''),			'topic_last_post_id'		=> array('UINT', 0),			'topic_last_poster_id'		=> array('UINT', 0),			'topic_last_poster_name'	=> array('VCHAR_UNI', ''),			'topic_last_poster_colour'	=> array('VCHAR:6', ''),			'topic_last_post_subject'	=> array('STEXT_UNI', ''),			'topic_last_post_time'		=> array('TIMESTAMP', 0),			'topic_last_view_time'		=> array('TIMESTAMP', 0),			'topic_moved_id'			=> array('UINT', 0),			'topic_bumped'				=> array('BOOL', 0),			'topic_bumper'				=> array('UINT', 0),			'poll_title'				=> array('STEXT_UNI', ''),			'poll_start'				=> array('TIMESTAMP', 0),			'poll_length'				=> array('TIMESTAMP', 0),			'poll_max_options'			=> array('TINT:4', 1),			'poll_last_vote'			=> array('TIMESTAMP', 0),			'poll_vote_change'			=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> 'topic_id',		'KEYS'			=> array(			'forum_id'			=> array('INDEX', 'forum_id'),			'forum_id_type'		=> array('INDEX', array('forum_id', 'topic_type')),			'last_post_time'	=> array('INDEX', 'topic_last_post_time'),			'topic_approved'	=> array('INDEX', 'topic_approved'),			'forum_appr_last'	=> array('INDEX', array('forum_id', 'topic_approved', 'topic_last_post_id')),			'fid_time_moved'	=> array('INDEX', array('forum_id', 'topic_last_post_time', 'topic_moved_id')),		),	);	$schema_data['phpbb_topics_track'] = array(		'COLUMNS'		=> array(			'user_id'			=> array('UINT', 0),			'topic_id'			=> array('UINT', 0),			'forum_id'			=> array('UINT', 0),			'mark_time'			=> array('TIMESTAMP', 0),		),		'PRIMARY_KEY'	=> array('user_id', 'topic_id'),		'KEYS'			=> array(			'topic_id'			=> array('INDEX', 'topic_id'),			'forum_id'			=> array('INDEX', 'forum_id'),		),	);	$schema_data['phpbb_topics_posted'] = array(		'COLUMNS'		=> array(			'user_id'			=> array('UINT', 0),			'topic_id'			=> array('UINT', 0),			'topic_posted'		=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> array('user_id', 'topic_id'),	);	$schema_data['phpbb_topics_watch'] = array(		'COLUMNS'		=> array(			'topic_id'			=> array('UINT', 0),			'user_id'			=> array('UINT', 0),			'notify_status'		=> array('BOOL', 0),		),		'KEYS'			=> array(			'topic_id'			=> array('INDEX', 'topic_id'),			'user_id'			=> array('INDEX', 'user_id'),			'notify_stat'		=> array('INDEX', 'notify_status'),		),	);	$schema_data['phpbb_user_group'] = array(		'COLUMNS'		=> array(			'group_id'			=> array('UINT', 0),			'user_id'			=> array('UINT', 0),			'group_leader'		=> array('BOOL', 0),			'user_pending'		=> array('BOOL', 1),		),		'KEYS'			=> array(			'group_id'			=> array('INDEX', 'group_id'),			'user_id'			=> array('INDEX', 'user_id'),			'group_leader'		=> array('INDEX', 'group_leader'),		),	);	$schema_data['phpbb_users'] = array(		'COLUMNS'		=> array(			'user_id'					=> array('UINT', NULL, 'auto_increment'),			'user_type'					=> array('TINT:2', 0),			'group_id'					=> array('UINT', 3),			'user_permissions'			=> array('MTEXT', ''),			'user_perm_from'			=> array('UINT', 0),			'user_ip'					=> array('VCHAR:40', ''),			'user_regdate'				=> array('TIMESTAMP', 0),			'username'					=> array('VCHAR_CI', ''),			'username_clean'			=> array('VCHAR_CI', ''),			'user_password'				=> array('VCHAR_UNI:40', ''),			'user_passchg'				=> array('TIMESTAMP', 0),			'user_pass_convert'			=> array('BOOL', 0),			'user_email'				=> array('VCHAR_UNI:100', ''),			'user_email_hash'			=> array('BINT', 0),			'user_birthday'				=> array('VCHAR:10', ''),			'user_lastvisit'			=> array('TIMESTAMP', 0),			'user_lastmark'				=> array('TIMESTAMP', 0),			'user_lastpost_time'		=> array('TIMESTAMP', 0),			'user_lastpage'				=> array('VCHAR_UNI:200', ''),			'user_last_confirm_key'		=> array('VCHAR:10', ''),			'user_last_search'			=> array('TIMESTAMP', 0),			'user_warnings'				=> array('TINT:4', 0),			'user_last_warning'			=> array('TIMESTAMP', 0),			'user_login_attempts'		=> array('TINT:4', 0),			'user_inactive_reason'		=> array('TINT:2', 0),			'user_inactive_time'		=> array('TIMESTAMP', 0),			'user_posts'				=> array('UINT', 0),			'user_lang'					=> array('VCHAR:30', ''),			'user_timezone'				=> array('DECIMAL', 0),			'user_dst'					=> array('BOOL', 0),			'user_dateformat'			=> array('VCHAR_UNI:30', 'd M Y H:i'),			'user_style'				=> array('UINT', 0),			'user_rank'					=> array('UINT', 0),			'user_colour'				=> array('VCHAR:6', ''),			'user_new_privmsg'			=> array('INT:4', 0),			'user_unread_privmsg'		=> array('INT:4', 0),			'user_last_privmsg'			=> array('TIMESTAMP', 0),			'user_message_rules'		=> array('BOOL', 0),			'user_full_folder'			=> array('INT:11', -3),			'user_emailtime'			=> array('TIMESTAMP', 0),			'user_topic_show_days'		=> array('USINT', 0),			'user_topic_sortby_type'	=> array('VCHAR:1', 't'),			'user_topic_sortby_dir'		=> array('VCHAR:1', 'd'),			'user_post_show_days'		=> array('USINT', 0),			'user_post_sortby_type'		=> array('VCHAR:1', 't'),			'user_post_sortby_dir'		=> array('VCHAR:1', 'a'),			'user_notify'				=> array('BOOL', 0),			'user_notify_pm'			=> array('BOOL', 1),			'user_notify_type'			=> array('TINT:4', 0),			'user_allow_pm'				=> array('BOOL', 1),			'user_allow_viewonline'		=> array('BOOL', 1),			'user_allow_viewemail'		=> array('BOOL', 1),			'user_allow_massemail'		=> array('BOOL', 1),			'user_options'				=> array('UINT:11', 230271),			'user_avatar'				=> array('VCHAR', ''),			'user_avatar_type'			=> array('TINT:2', 0),			'user_avatar_width'			=> array('USINT', 0),			'user_avatar_height'		=> array('USINT', 0),			'user_sig'					=> array('MTEXT_UNI', ''),			'user_sig_bbcode_uid'		=> array('VCHAR:8', ''),			'user_sig_bbcode_bitfield'	=> array('VCHAR:255', ''),			'user_from'					=> array('VCHAR_UNI:100', ''),			'user_icq'					=> array('VCHAR:15', ''),			'user_aim'					=> array('VCHAR_UNI', ''),			'user_yim'					=> array('VCHAR_UNI', ''),			'user_msnm'					=> array('VCHAR_UNI', ''),			'user_jabber'				=> array('VCHAR_UNI', ''),			'user_website'				=> array('VCHAR_UNI:200', ''),			'user_occ'					=> array('TEXT_UNI', ''),			'user_interests'			=> array('TEXT_UNI', ''),			'user_actkey'				=> array('VCHAR:32', ''),			'user_newpasswd'			=> array('VCHAR_UNI:40', ''),			'user_form_salt'			=> array('VCHAR_UNI:32', ''),			'user_new'					=> array('BOOL', 1),			'user_reminded'				=> array('TINT:4', 0),			'user_reminded_time'		=> array('TIMESTAMP', 0),		),		'PRIMARY_KEY'	=> 'user_id',		'KEYS'			=> array(			'user_birthday'				=> array('INDEX', 'user_birthday'),			'user_email_hash'			=> array('INDEX', 'user_email_hash'),			'user_type'					=> array('INDEX', 'user_type'),			'username_clean'			=> array('UNIQUE', 'username_clean'),		),	);	$schema_data['phpbb_warnings'] = array(		'COLUMNS'		=> array(			'warning_id'			=> array('UINT', NULL, 'auto_increment'),			'user_id'				=> array('UINT', 0),			'post_id'				=> array('UINT', 0),			'log_id'				=> array('UINT', 0),			'warning_time'			=> array('TIMESTAMP', 0),		),		'PRIMARY_KEY'	=> 'warning_id',	);	$schema_data['phpbb_words'] = array(		'COLUMNS'		=> array(			'word_id'				=> array('UINT', NULL, 'auto_increment'),			'word'					=> array('VCHAR_UNI', ''),			'replacement'			=> array('VCHAR_UNI', ''),		),		'PRIMARY_KEY'	=> 'word_id',	);	$schema_data['phpbb_zebra'] = array(		'COLUMNS'		=> array(			'user_id'				=> array('UINT', 0),			'zebra_id'				=> array('UINT', 0),			'friend'				=> array('BOOL', 0),			'foe'					=> array('BOOL', 0),		),		'PRIMARY_KEY'	=> array('user_id', 'zebra_id'),	);	return $schema_data;}?>
<?php/**** acp_attachments [English]** @package language* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** DO NOT CHANGE*/if (!defined('IN_PHPBB')){	exit;}if (empty($lang) || !is_array($lang)){	$lang = array();}// DEVELOPERS PLEASE NOTE//// All language files should use UTF-8 as their encoding and the files must not contain a BOM.//// Placeholders can now contain order information, e.g. instead of// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows// translators to re-order the output of data while ensuring it remains correct//// You do not need this where single placeholders are used, e.g. 'Message %d' is fine// equally where a string contains only two placeholders which are used to wrap text// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine$lang = array_merge($lang, array(	'ACP_ATTACHMENT_SETTINGS_EXPLAIN'	=> 'Here you can configure the main settings for attachments and the associated special categories.',	'ACP_EXTENSION_GROUPS_EXPLAIN'		=> 'Here you can add, delete, modify or disable your extension groups. Further options include the assignment of a special category to them, changing the download mechanism and defining an upload icon which will be displayed in front of the attachment which belongs to the group.',	'ACP_MANAGE_EXTENSIONS_EXPLAIN'		=> 'Here you can manage your allowed extensions. To activate your extensions, please refer to the extension groups management panel. We strongly recommend not to allow scripting extensions (such as <code>php</code>, <code>php3</code>, <code>php4</code>, <code>phtml</code>, <code>pl</code>, <code>cgi</code>, <code>py</code>, <code>rb</code>, <code>asp</code>, <code>aspx</code>, and so forth).',	'ACP_ORPHAN_ATTACHMENTS_EXPLAIN'	=> 'Here you are able to see orphaned files. This happens mostly if users are attaching files but not submitting the post. You are able to delete the files or attach them to existing posts. Attaching to posts requires a valid post ID, you have to determine this ID by yourself. This will assign the already uploaded attachment to the post you entered.',	'ADD_EXTENSION'						=> 'Add extension',	'ADD_EXTENSION_GROUP'				=> 'Add extension group',	'ADMIN_UPLOAD_ERROR'				=> 'Errors while trying to attach file: %s.',	'ALLOWED_FORUMS'					=> 'Allowed forums',	'ALLOWED_FORUMS_EXPLAIN'			=> 'Able to post the assigned extensions at the selected (or all if selected) forums.',	'ALLOWED_IN_PM_POST'				=> 'Allowed',	'ALLOW_ATTACHMENTS'					=> 'Allow attachments',	'ALLOW_ALL_FORUMS'					=> 'Allow all forums',	'ALLOW_IN_PM'						=> 'Allowed in private messaging',	'ALLOW_PM_ATTACHMENTS'				=> 'Allow attachments in private messages',	'ALLOW_SELECTED_FORUMS'				=> 'Only forums selected below',	'ASSIGNED_EXTENSIONS'				=> 'Assigned extensions',	'ASSIGNED_GROUP'					=> 'Assigned extension group',	'ATTACH_EXTENSIONS_URL'				=> 'Extensions',	'ATTACH_EXT_GROUPS_URL'				=> 'Extension groups',	'ATTACH_ID'							=> 'ID',	'ATTACH_MAX_FILESIZE'				=> 'Maximum file size',	'ATTACH_MAX_FILESIZE_EXPLAIN'		=> 'Maximum size of each file, with 0 being unlimited.',	'ATTACH_MAX_PM_FILESIZE'			=> 'Maximum file size messaging',	'ATTACH_MAX_PM_FILESIZE_EXPLAIN'	=> 'Maximum size of each file, with 0 being unlimited, attached to a private message.',	'ATTACH_ORPHAN_URL'					=> 'Orphan attachments',	'ATTACH_POST_ID'					=> 'Post ID',	'ATTACH_QUOTA'						=> 'Total attachment quota',	'ATTACH_QUOTA_EXPLAIN'				=> 'Maximum drive space available for attachments for the whole board, with 0 being unlimited.',	'ATTACH_TO_POST'					=> 'Attach file to post',	'CAT_FLASH_FILES'			=> 'Flash files',	'CAT_IMAGES'				=> 'Images',	'CAT_QUICKTIME_FILES'		=> 'Quicktime media files',	'CAT_RM_FILES'				=> 'RealMedia media files',	'CAT_WM_FILES'				=> 'Windows Media media files',	'CHECK_CONTENT'				=> 'Check attachment files',	'CHECK_CONTENT_EXPLAIN'		=> 'Some browsers can be tricked to assume an incorrect mimetype for uploaded files. This option ensures that such files likely to cause this are rejected.',	'CREATE_GROUP'				=> 'Create new group',	'CREATE_THUMBNAIL'			=> 'Create thumbnail',	'CREATE_THUMBNAIL_EXPLAIN'	=> 'Create a thumbnail in all possible situations.',	'DEFINE_ALLOWED_IPS'			=> 'Define allowed IPs/hostnames',	'DEFINE_DISALLOWED_IPS'			=> 'Define disallowed IPs/hostnames',	'DOWNLOAD_ADD_IPS_EXPLAIN'		=> 'To specify several different IPs or hostnames enter each on a new line. To specify a range of IP addresses separate the start and end with a hyphen (-), to specify a wildcard use *.',	'DOWNLOAD_REMOVE_IPS_EXPLAIN'	=> 'You can remove (or un-exclude) multiple IP addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded IPs have a blue background.',	'DISPLAY_INLINED'				=> 'Display images inline',	'DISPLAY_INLINED_EXPLAIN'		=> 'If set to No image attachments will show as a link.',	'DISPLAY_ORDER'					=> 'Attachment display order',	'DISPLAY_ORDER_EXPLAIN'			=> 'Display attachments ordered by time.',	'EDIT_EXTENSION_GROUP'			=> 'Edit extension group',	'EXCLUDE_ENTERED_IP'			=> 'Enable this to exclude the entered IP/hostname.',	'EXCLUDE_FROM_ALLOWED_IP'		=> 'Exclude IP from allowed IPs/hostnames',	'EXCLUDE_FROM_DISALLOWED_IP'	=> 'Exclude IP from disallowed IPs/hostnames',	'EXTENSIONS_UPDATED'			=> 'Extensions successfully updated.',	'EXTENSION_EXIST'				=> 'The extension %s already exists.',	'EXTENSION_GROUP'				=> 'Extension group',	'EXTENSION_GROUPS'				=> 'Extension groups',	'EXTENSION_GROUP_DELETED'		=> 'Extension group successfully deleted.',	'EXTENSION_GROUP_EXIST'			=> 'The extension group %s already exists.',	'EXT_GROUP_ARCHIVES'			=> 'Archives',	'EXT_GROUP_DOCUMENTS'			=> 'Documents',	'EXT_GROUP_DOWNLOADABLE_FILES'	=> 'Downloadable Files',	'EXT_GROUP_FLASH_FILES'			=> 'Flash Files',	'EXT_GROUP_IMAGES'				=> 'Images',	'EXT_GROUP_PLAIN_TEXT'			=> 'Plain Text',	'EXT_GROUP_QUICKTIME_MEDIA'		=> 'Quicktime Media',	'EXT_GROUP_REAL_MEDIA'			=> 'Real Media',	'EXT_GROUP_WINDOWS_MEDIA'		=> 'Windows Media',	'GO_TO_EXTENSIONS'		=> 'Go to extension management screen',	'GROUP_NAME'			=> 'Group name',	'IMAGE_LINK_SIZE'			=> 'Image link dimensions',	'IMAGE_LINK_SIZE_EXPLAIN'	=> 'Display image attachment as an inline text link if image is larger than this. To disable this behaviour, set the values to 0px by 0px.',	'IMAGICK_PATH'				=> 'Imagemagick path',	'IMAGICK_PATH_EXPLAIN'		=> 'Full path to the imagemagick convert application, e.g. <samp>/usr/bin/</samp>.',	'MAX_ATTACHMENTS'				=> 'Maximum number of attachments per post',	'MAX_ATTACHMENTS_PM'			=> 'Maximum number of attachments per private message',	'MAX_EXTGROUP_FILESIZE'			=> 'Maximum file size',	'MAX_IMAGE_SIZE'				=> 'Maximum image dimensions',	'MAX_IMAGE_SIZE_EXPLAIN'		=> 'Maximum size of image attachments. Set both values to 0px by 0px to disable dimension checking.',	'MAX_THUMB_WIDTH'				=> 'Maximum thumbnail width in pixel',	'MAX_THUMB_WIDTH_EXPLAIN'		=> 'A generated thumbnail will not exceed the width set here.',	'MIN_THUMB_FILESIZE'			=> 'Minimum thumbnail file size',	'MIN_THUMB_FILESIZE_EXPLAIN'	=> 'Do not create a thumbnail for images smaller than this.',	'MODE_INLINE'					=> 'Inline',	'MODE_PHYSICAL'					=> 'Physical',	'NOT_ALLOWED_IN_PM'			=> 'Only allowed in posts',	'NOT_ALLOWED_IN_PM_POST'	=> 'Not allowed',	'NOT_ASSIGNED'				=> 'Not assigned',	'NO_EXT_GROUP'				=> 'None',	'NO_EXT_GROUP_NAME'			=> 'No group name entered',	'NO_EXT_GROUP_SPECIFIED'	=> 'No extension group specified.',	'NO_FILE_CAT'				=> 'None',	'NO_IMAGE'					=> 'No image',	'NO_THUMBNAIL_SUPPORT'		=> 'Thumbnail support has been disabled. For proper functionality either the GD extension need to be available or imagemagick being installed. Both were not found.',	'NO_UPLOAD_DIR'				=> 'The upload directory you specified does not exist.',	'NO_WRITE_UPLOAD'			=> 'The upload directory you specified cannot be written to. Please alter the permissions to allow the webserver to write to it.',	'ONLY_ALLOWED_IN_PM'	=> 'Only allowed in private messages',	'ORDER_ALLOW_DENY'		=> 'Allow',	'ORDER_DENY_ALLOW'		=> 'Deny',	'REMOVE_ALLOWED_IPS'		=> 'Remove or un-exclude <em>allowed</em> IPs/hostnames',	'REMOVE_DISALLOWED_IPS'		=> 'Remove or un-exclude <em>disallowed</em> IPs/hostnames',	'SEARCH_IMAGICK'				=> 'Search for Imagemagick',	'SECURE_ALLOW_DENY'				=> 'Allow/Deny list',	'SECURE_ALLOW_DENY_EXPLAIN'		=> 'Change the default behaviour when secure downloads are enabled of the Allow/Deny list to that of a <strong>whitelist</strong> (Allow) or a <strong>blacklist</strong> (Deny).',	'SECURE_DOWNLOADS'				=> 'Enable secure downloads',	'SECURE_DOWNLOADS_EXPLAIN'		=> 'With this option enabled, downloads are limited to IPs/hostnames you define.',	'SECURE_DOWNLOAD_NOTICE'		=> 'Secure Downloads are not enabled. The settings below will be applied after enabling secure downloads.',	'SECURE_DOWNLOAD_UPDATE_SUCCESS'=> 'The IP list has been updated successfully.',	'SECURE_EMPTY_REFERRER'			=> 'Allow empty referrer',	'SECURE_EMPTY_REFERRER_EXPLAIN'	=> 'Secure downloads are based on referrers. Do you want to allow downloads for those omitting the referrer?',	'SETTINGS_CAT_IMAGES'			=> 'Image category settings',	'SPECIAL_CATEGORY'				=> 'Special category',	'SPECIAL_CATEGORY_EXPLAIN'		=> 'Special categories differ between the way presented within posts.',	'SUCCESSFULLY_UPLOADED'			=> 'Successfully uploaded.',	'SUCCESS_EXTENSION_GROUP_ADD'	=> 'Extension group successfully added.',	'SUCCESS_EXTENSION_GROUP_EDIT'	=> 'Extension group successfully updated.',	'UPLOADING_FILES'				=> 'Uploading files',	'UPLOADING_FILE_TO'				=> 'Uploading file %1$s to post number %2$d',	'UPLOAD_DENIED_FORUM'			=> 'You do not have the permission to upload files to forum %s.',	'UPLOAD_DIR'					=> 'Upload directory',	'UPLOAD_DIR_EXPLAIN'			=> 'Storage path for attachments. Please note that if you change this directory while already having uploaded attachments you need to manually copy the files to their new location.',	'UPLOAD_ICON'					=> 'Upload icon',	'UPLOAD_NOT_DIR'				=> 'The upload location you specified does not appear to be a directory.',));?>
<?php/**** @package phpBB3* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**/if (php_sapi_name() != 'cli'){	die("This program must be run from the command line.\n");}//// Security message://// This script is potentially dangerous.// Remove or comment the next line (die(".... ) to enable this script.// Do NOT FORGET to either remove this script or disable it after you have used it.//die("Please read the first lines of this script for instructions on how to enable it");set_time_limit(0);error_reporting(E_ALL);define('IN_PHPBB', true);$phpbb_root_path = '../';$phpEx = substr(strrchr(__FILE__, '.'), 1);/*** Let's download some files we need*/download('http://www.unicode.org/Public/UNIDATA/NormalizationTest.txt');download('http://www.unicode.org/Public/UNIDATA/UnicodeData.txt');/*** Those are the tests we run*/$test_suite = array(	/**	* NFC	*   c2 ==  NFC(c1) ==  NFC(c2) ==  NFC(c3)	*   c4 ==  NFC(c4) ==  NFC(c5)	*/	'NFC'	=>	array(		'c2'	=>	array('c1', 'c2', 'c3'),		'c4'	=>	array('c4', 'c5')	),	/**	* NFD	*   c3 ==  NFD(c1) ==  NFD(c2) ==  NFD(c3)	*   c5 ==  NFD(c4) ==  NFD(c5)	*/	'NFD'	=>	array(		'c3'	=>	array('c1', 'c2', 'c3'),		'c5'	=>	array('c4', 'c5')	),	/**	* NFKC	*   c4 == NFKC(c1) == NFKC(c2) == NFKC(c3) == NFKC(c4) == NFKC(c5)	*/	'NFKC'	=>	array(		'c4'	=>	array('c1', 'c2', 'c3', 'c4', 'c5')	),	/**	* NFKD	*   c5 == NFKD(c1) == NFKD(c2) == NFKD(c3) == NFKD(c4) == NFKD(c5)	*/	'NFKD'	=>	array(		'c5'	=>	array('c1', 'c2', 'c3', 'c4', 'c5')	));require_once($phpbb_root_path . 'includes/utf/utf_normalizer.' . $phpEx);$i = $n = 0;$failed = false;$tested_chars = array();$fp = fopen($phpbb_root_path . 'develop/NormalizationTest.txt', 'rb');while (!feof($fp)){	$line = fgets($fp);	++$n;	if ($line[0] == '@')	{		if ($i)		{			echo "done\n";		}		$i = 0;		echo "\n", substr($line, 1), "\n\n";		continue;	}	if (!strpos(' 0123456789ABCDEF', $line[0]))	{		continue;	}	if (++$i % 100 == 0)	{		echo $i, ' ';	}	list($c1, $c2, $c3, $c4, $c5) = explode(';', $line);	if (!strpos($c1, ' '))	{		/**		* We are currently testing a single character, we add it to the list of		* characters we have processed so that we can exclude it when testing		* for invariants		*/		$tested_chars[$c1] = 1;	}	foreach ($test_suite as $form => $serie)	{		foreach ($serie as $expected => $tests)		{			$hex_expected = ${$expected};			$utf_expected = hexseq_to_utf($hex_expected);			foreach ($tests as $test)			{				$utf_result = $utf_expected;				call_user_func(array('utf_normalizer', $form), $utf_result);				if (strcmp($utf_expected, $utf_result))				{					$failed = true;					$hex_result = utf_to_hexseq($utf_result);					echo "\nFAILED $expected == $form($test) ($hex_expected != $hex_result)";				}			}		}		if ($failed)		{			die("\n\nFailed at line $n\n");		}	}}fclose($fp);/*** Test for invariants*/echo "\n\nTesting for invariants...\n\n";$fp = fopen($phpbb_root_path . 'develop/UnicodeData.txt', 'rt');$n = 0;while (!feof($fp)){	if (++$n % 100 == 0)	{		echo $n, ' ';	}	$line = fgets($fp, 1024);	if (!$pos = strpos($line, ';'))	{		continue;	}	$hex_tested = $hex_expected = substr($line, 0, $pos);	if (isset($tested_chars[$hex_tested]))	{		continue;	}	$utf_expected = hex_to_utf($hex_expected);	if ($utf_expected >= UTF8_SURROGATE_FIRST	 && $utf_expected <= UTF8_SURROGATE_LAST)	{		/**		* Surrogates are illegal on their own, we expect the normalizer		* to return a replacement char		*/		$utf_expected = UTF8_REPLACEMENT;		$hex_expected = utf_to_hexseq($utf_expected);	}	foreach (array('nfc', 'nfkc', 'nfd', 'nfkd') as $form)	{		$utf_result = $utf_expected;		utf_normalizer::$form($utf_result);		$hex_result = utf_to_hexseq($utf_result);//		echo "$form($utf_expected) == $utf_result\n";		if (strcmp($utf_expected, $utf_result))		{			$failed = 1;			echo "\nFAILED $hex_expected == $form($hex_tested) ($hex_expected != $hex_result)";		}	}	if ($failed)	{		die("\n\nFailed at line $n\n");	}}fclose($fp);die("\n\nALL TESTS PASSED SUCCESSFULLY\n");/*** Download a file to the develop/ dir** @param	string	$url		URL of the file to download* @return	void*/function download($url){	global $phpbb_root_path;	if (file_exists($phpbb_root_path . 'develop/' . basename($url)))	{		return;	}	echo 'Downloading from ', $url, ' ';	if (!$fpr = fopen($url, 'rb'))	{		die("Can't download from $url\nPlease download it yourself and put it in the develop/ dir, kthxbai");	}	if (!$fpw = fopen($phpbb_root_path . 'develop/' . basename($url), 'wb'))	{		die("Can't open develop/" . basename($url) . " for output... please check your permissions or something");	}	$i = 0;	$chunk = 32768;	$done = '';	while (!feof($fpr))	{		$i += fwrite($fpw, fread($fpr, $chunk));		echo str_repeat("\x08", strlen($done));		$done = ($i >> 10) . ' KiB';		echo $done;	}	fclose($fpr);	fclose($fpw);	echo "\n";}/*** Convert a UTF string to a sequence of codepoints in hexadecimal** @param	string	$utf	UTF string* @return	integer			Unicode codepoints in hex*/function utf_to_hexseq($str){	$pos = 0;	$len = strlen($str);	$ret = array();	while ($pos < $len)	{		$c = $str[$pos];		switch ($c & "\xF0")		{			case "\xC0":			case "\xD0":				$utf_char = substr($str, $pos, 2);				$pos += 2;				break;			case "\xE0":				$utf_char = substr($str, $pos, 3);				$pos += 3;				break;			case "\xF0":				$utf_char = substr($str, $pos, 4);				$pos += 4;				break;			default:				$utf_char = $c;				++$pos;		}		$hex = dechex(utf_to_cp($utf_char));		if (!isset($hex[3]))		{			$hex = substr('000' . $hex, -4);		}		$ret[] = $hex;	}	return strtr(implode(' ', $ret), 'abcdef', 'ABCDEF');}/*** Convert a UTF-8 char to its codepoint** @param	string	$utf_char	UTF-8 char* @return	integer				Unicode codepoint*/function utf_to_cp($utf_char){	switch (strlen($utf_char))	{		case 1:			return ord($utf_char);		case 2:			return ((ord($utf_char[0]) & 0x1F) << 6) | (ord($utf_char[1]) & 0x3F);		case 3:			return ((ord($utf_char[0]) & 0x0F) << 12) | ((ord($utf_char[1]) & 0x3F) << 6) | (ord($utf_char[2]) & 0x3F);		case 4:			return ((ord($utf_char[0]) & 0x07) << 18) | ((ord($utf_char[1]) & 0x3F) << 12) | ((ord($utf_char[2]) & 0x3F) << 6) | (ord($utf_char[3]) & 0x3F);		default:			die('UTF-8 chars can only be 1-4 bytes long');	}}/*** Return a UTF string formed from a sequence of codepoints in hexadecimal** @param	string	$seq		Sequence of codepoints, separated with a space* @return	string				UTF-8 string*/function hexseq_to_utf($seq){	return implode('', array_map('hex_to_utf', explode(' ', $seq)));}/*** Convert a codepoint in hexadecimal to a UTF-8 char** @param	string	$hex		Codepoint, in hexadecimal* @return	string				UTF-8 char*/function hex_to_utf($hex){	return cp_to_utf(hexdec($hex));}/*** Convert a codepoint to a UTF-8 char** @param	integer	$cp			Unicode codepoint* @return	string				UTF-8 string*/function cp_to_utf($cp){	if ($cp > 0xFFFF)	{		return chr(0xF0 | ($cp >> 18)) . chr(0x80 | (($cp >> 12) & 0x3F)) . chr(0x80 | (($cp >> 6) & 0x3F)) . chr(0x80 | ($cp & 0x3F));	}	else if ($cp > 0x7FF)	{		return chr(0xE0 | ($cp >> 12)) . chr(0x80 | (($cp >> 6) & 0x3F)) . chr(0x80 | ($cp & 0x3F));	}	else if ($cp > 0x7F)	{		return chr(0xC0 | ($cp >> 6)) . chr(0x80 | ($cp & 0x3F));	}	else	{		return chr($cp);	}}
<?php/**** @package ucp* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** @ignore*/if (!defined('IN_PHPBB')){	exit;}/*** ucp_prefs* Changing user preferences* @package ucp*/class ucp_prefs{	var $u_action;	function main($id, $mode)	{		global $config, $db, $user, $auth, $template, $phpbb_root_path, $phpEx;		$submit = (isset($_POST['submit'])) ? true : false;		$error = $data = array();		$s_hidden_fields = '';		switch ($mode)		{			case 'personal':				add_form_key('ucp_prefs_personal');				$data = array(					'notifymethod'	=> request_var('notifymethod', $user->data['user_notify_type']),					'dateformat'	=> request_var('dateformat', $user->data['user_dateformat'], true),					'lang'			=> basename(request_var('lang', $user->data['user_lang'])),					'style'			=> request_var('style', (int) $user->data['user_style']),					'tz'			=> request_var('tz', (float) $user->data['user_timezone']),					'dst'			=> request_var('dst', (bool) $user->data['user_dst']),					'viewemail'		=> request_var('viewemail', (bool) $user->data['user_allow_viewemail']),					'massemail'		=> request_var('massemail', (bool) $user->data['user_allow_massemail']),					'hideonline'	=> request_var('hideonline', (bool) !$user->data['user_allow_viewonline']),					'notifypm'		=> request_var('notifypm', (bool) $user->data['user_notify_pm']),					'popuppm'		=> request_var('popuppm', (bool) $user->optionget('popuppm')),					'allowpm'		=> request_var('allowpm', (bool) $user->data['user_allow_pm']),				);				if ($data['notifymethod'] == NOTIFY_IM && (!$config['jab_enable'] || !$user->data['user_jabber'] || !@extension_loaded('xml')))				{					// Jabber isnt enabled, or no jabber field filled in. Update the users table to be sure its correct.					$data['notifymethod'] = NOTIFY_BOTH;				}				if ($submit)				{					$data['style'] = ($config['override_user_style']) ? $config['default_style'] : $data['style'];					$error = validate_data($data, array(						'dateformat'	=> array('string', false, 1, 30),						'lang'			=> array('language_iso_name'),						'tz'			=> array('num', false, -14, 14),					));					if (!check_form_key('ucp_prefs_personal'))					{						$error[] = 'FORM_INVALID';					}					if (!sizeof($error))					{						$user->optionset('popuppm', $data['popuppm']);						$sql_ary = array(							'user_allow_pm'			=> $data['allowpm'],							'user_allow_viewemail'	=> $data['viewemail'],							'user_allow_massemail'	=> $data['massemail'],							'user_allow_viewonline'	=> ($auth->acl_get('u_hideonline')) ? !$data['hideonline'] : $user->data['user_allow_viewonline'],							'user_notify_type'		=> $data['notifymethod'],							'user_notify_pm'		=> $data['notifypm'],							'user_options'			=> $user->data['user_options'],							'user_dst'				=> $data['dst'],							'user_dateformat'		=> $data['dateformat'],							'user_lang'				=> $data['lang'],							'user_timezone'			=> $data['tz'],							'user_style'			=> $data['style'],						);						$sql = 'UPDATE ' . USERS_TABLE . '							SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '							WHERE user_id = ' . $user->data['user_id'];						$db->sql_query($sql);						meta_refresh(3, $this->u_action);						$message = $user->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($user->lang['RETURN_UCP'], '<a href="' . $this->u_action . '">', '</a>');						trigger_error($message);					}					// Replace "error" strings with their real, localised form					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$user->lang['\\1'])) ? \$user->lang['\\1'] : '\\1'", $error);				}				$dateformat_options = '';				foreach ($user->lang['dateformats'] as $format => $null)				{					$dateformat_options .= '<option value="' . $format . '"' . (($format == $data['dateformat']) ? ' selected="selected"' : '') . '>';					$dateformat_options .= $user->format_date(time(), $format, false) . ((strpos($format, '|') !== false) ? $user->lang['VARIANT_DATE_SEPARATOR'] . $user->format_date(time(), $format, true) : '');					$dateformat_options .= '</option>';				}				$s_custom = false;				$dateformat_options .= '<option value="custom"';				if (!isset($user->lang['dateformats'][$data['dateformat']]))				{					$dateformat_options .= ' selected="selected"';					$s_custom = true;				}				$dateformat_options .= '>' . $user->lang['CUSTOM_DATEFORMAT'] . '</option>';				$template->assign_vars(array(					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',					'S_NOTIFY_EMAIL'	=> ($data['notifymethod'] == NOTIFY_EMAIL) ? true : false,					'S_NOTIFY_IM'		=> ($data['notifymethod'] == NOTIFY_IM) ? true : false,					'S_NOTIFY_BOTH'		=> ($data['notifymethod'] == NOTIFY_BOTH) ? true : false,					'S_VIEW_EMAIL'		=> $data['viewemail'],					'S_MASS_EMAIL'		=> $data['massemail'],					'S_ALLOW_PM'		=> $data['allowpm'],					'S_HIDE_ONLINE'		=> $data['hideonline'],					'S_NOTIFY_PM'		=> $data['notifypm'],					'S_POPUP_PM'		=> $data['popuppm'],					'S_DST'				=> $data['dst'],					'DATE_FORMAT'			=> $data['dateformat'],					'A_DATE_FORMAT'			=> addslashes($data['dateformat']),					'S_DATEFORMAT_OPTIONS'	=> $dateformat_options,					'S_CUSTOM_DATEFORMAT'	=> $s_custom,					'DEFAULT_DATEFORMAT'	=> $config['default_dateformat'],					'A_DEFAULT_DATEFORMAT'	=> addslashes($config['default_dateformat']),					'S_LANG_OPTIONS'		=> language_select($data['lang']),					'S_STYLE_OPTIONS'		=> ($config['override_user_style']) ? '' : style_select($data['style']),					'S_TZ_OPTIONS'			=> tz_select($data['tz'], true),					'S_CAN_HIDE_ONLINE'		=> ($auth->acl_get('u_hideonline')) ? true : false,					'S_SELECT_NOTIFY'		=> ($config['jab_enable'] && $user->data['user_jabber'] && @extension_loaded('xml')) ? true : false)				);			break;			case 'view':				add_form_key('ucp_prefs_view');				$data = array(					'topic_sk'		=> request_var('topic_sk', (!empty($user->data['user_topic_sortby_type'])) ? $user->data['user_topic_sortby_type'] : 't'),					'topic_sd'		=> request_var('topic_sd', (!empty($user->data['user_topic_sortby_dir'])) ? $user->data['user_topic_sortby_dir'] : 'd'),					'topic_st'		=> request_var('topic_st', (!empty($user->data['user_topic_show_days'])) ? $user->data['user_topic_show_days'] : 0),					'post_sk'		=> request_var('post_sk', (!empty($user->data['user_post_sortby_type'])) ? $user->data['user_post_sortby_type'] : 't'),					'post_sd'		=> request_var('post_sd', (!empty($user->data['user_post_sortby_dir'])) ? $user->data['user_post_sortby_dir'] : 'a'),					'post_st'		=> request_var('post_st', (!empty($user->data['user_post_show_days'])) ? $user->data['user_post_show_days'] : 0),					'images'		=> request_var('images', (bool) $user->optionget('viewimg')),					'flash'			=> request_var('flash', (bool) $user->optionget('viewflash')),					'smilies'		=> request_var('smilies', (bool) $user->optionget('viewsmilies')),					'sigs'			=> request_var('sigs', (bool) $user->optionget('viewsigs')),					'avatars'		=> request_var('avatars', (bool) $user->optionget('viewavatars')),					'wordcensor'	=> request_var('wordcensor', (bool) $user->optionget('viewcensors')),				);				if ($submit)				{					$error = validate_data($data, array(						'topic_sk'	=> array('string', false, 1, 1),						'topic_sd'	=> array('string', false, 1, 1),						'post_sk'	=> array('string', false, 1, 1),						'post_sd'	=> array('string', false, 1, 1),					));					if (!check_form_key('ucp_prefs_view'))					{						$error[] = 'FORM_INVALID';					}					if (!sizeof($error))					{						$user->optionset('viewimg', $data['images']);						$user->optionset('viewflash', $data['flash']);						$user->optionset('viewsmilies', $data['smilies']);						$user->optionset('viewsigs', $data['sigs']);						$user->optionset('viewavatars', $data['avatars']);						if ($auth->acl_get('u_chgcensors'))						{							$user->optionset('viewcensors', $data['wordcensor']);						}						$sql_ary = array(							'user_options'				=> $user->data['user_options'],							'user_topic_sortby_type'	=> $data['topic_sk'],							'user_post_sortby_type'		=> $data['post_sk'],							'user_topic_sortby_dir'		=> $data['topic_sd'],							'user_post_sortby_dir'		=> $data['post_sd'],							'user_topic_show_days'	=> $data['topic_st'],							'user_post_show_days'	=> $data['post_st'],						);						$sql = 'UPDATE ' . USERS_TABLE . '							SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '							WHERE user_id = ' . $user->data['user_id'];						$db->sql_query($sql);						meta_refresh(3, $this->u_action);						$message = $user->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($user->lang['RETURN_UCP'], '<a href="' . $this->u_action . '">', '</a>');						trigger_error($message);					}					// Replace "error" strings with their real, localised form					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$user->lang['\\1'])) ? \$user->lang['\\1'] : '\\1'", $error);				}				$sort_dir_text = array('a' => $user->lang['ASCENDING'], 'd' => $user->lang['DESCENDING']);				// Topic ordering options				$limit_topic_days = array(0 => $user->lang['ALL_TOPICS'], 1 => $user->lang['1_DAY'], 7 => $user->lang['7_DAYS'], 14 => $user->lang['2_WEEKS'], 30 => $user->lang['1_MONTH'], 90 => $user->lang['3_MONTHS'], 180 => $user->lang['6_MONTHS'], 365 => $user->lang['1_YEAR']);				$sort_by_topic_text = array('a' => $user->lang['AUTHOR'], 't' => $user->lang['POST_TIME'], 'r' => $user->lang['REPLIES'], 's' => $user->lang['SUBJECT'], 'v' => $user->lang['VIEWS']);				$sort_by_topic_sql = array('a' => 't.topic_first_poster_name', 't' => 't.topic_last_post_time', 'r' => 't.topic_replies', 's' => 't.topic_title', 'v' => 't.topic_views');				// Post ordering options				$limit_post_days = array(0 => $user->lang['ALL_POSTS'], 1 => $user->lang['1_DAY'], 7 => $user->lang['7_DAYS'], 14 => $user->lang['2_WEEKS'], 30 => $user->lang['1_MONTH'], 90 => $user->lang['3_MONTHS'], 180 => $user->lang['6_MONTHS'], 365 => $user->lang['1_YEAR']);				$sort_by_post_text = array('a' => $user->lang['AUTHOR'], 't' => $user->lang['POST_TIME'], 's' => $user->lang['SUBJECT']);				$sort_by_post_sql = array('a' => 'u.username_clean', 't' => 'p.post_id', 's' => 'p.post_subject');				$_options = array('topic', 'post');				foreach ($_options as $sort_option)				{					${'s_limit_' . $sort_option . '_days'} = '<select name="' . $sort_option . '_st">';					foreach (${'limit_' . $sort_option . '_days'} as $day => $text)					{						$selected = ($data[$sort_option . '_st'] == $day) ? ' selected="selected"' : '';						${'s_limit_' . $sort_option . '_days'} .= '<option value="' . $day . '"' . $selected . '>' . $text . '</option>';					}					${'s_limit_' . $sort_option . '_days'} .= '</select>';					${'s_sort_' . $sort_option . '_key'} = '<select name="' . $sort_option . '_sk">';					foreach (${'sort_by_' . $sort_option . '_text'} as $key => $text)					{						$selected = ($data[$sort_option . '_sk'] == $key) ? ' selected="selected"' : '';						${'s_sort_' . $sort_option . '_key'} .= '<option value="' . $key . '"' . $selected . '>' . $text . '</option>';					}					${'s_sort_' . $sort_option . '_key'} .= '</select>';					${'s_sort_' . $sort_option . '_dir'} = '<select name="' . $sort_option . '_sd">';					foreach ($sort_dir_text as $key => $value)					{						$selected = ($data[$sort_option . '_sd'] == $key) ? ' selected="selected"' : '';						${'s_sort_' . $sort_option . '_dir'} .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';					}					${'s_sort_' . $sort_option . '_dir'} .= '</select>';				}				$template->assign_vars(array(					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',					'S_IMAGES'			=> $data['images'],					'S_FLASH'			=> $data['flash'],					'S_SMILIES'			=> $data['smilies'],					'S_SIGS'			=> $data['sigs'],					'S_AVATARS'			=> $data['avatars'],					'S_DISABLE_CENSORS'	=> $data['wordcensor'],					'S_CHANGE_CENSORS'		=> ($auth->acl_get('u_chgcensors') && $config['allow_nocensors']) ? true : false,					'S_TOPIC_SORT_DAYS'		=> $s_limit_topic_days,					'S_TOPIC_SORT_KEY'		=> $s_sort_topic_key,					'S_TOPIC_SORT_DIR'		=> $s_sort_topic_dir,					'S_POST_SORT_DAYS'		=> $s_limit_post_days,					'S_POST_SORT_KEY'		=> $s_sort_post_key,					'S_POST_SORT_DIR'		=> $s_sort_post_dir)				);			break;			case 'post':				$data = array(					'bbcode'	=> request_var('bbcode', $user->optionget('bbcode')),					'smilies'	=> request_var('smilies', $user->optionget('smilies')),					'sig'		=> request_var('sig', $user->optionget('attachsig')),					'notify'	=> request_var('notify', (bool) $user->data['user_notify']),				);				add_form_key('ucp_prefs_post');				if ($submit)				{					if (check_form_key('ucp_prefs_post'))					{						$user->optionset('bbcode', $data['bbcode']);						$user->optionset('smilies', $data['smilies']);						$user->optionset('attachsig', $data['sig']);						$sql_ary = array(							'user_options'	=> $user->data['user_options'],							'user_notify'	=> $data['notify'],						);						$sql = 'UPDATE ' . USERS_TABLE . '							SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '							WHERE user_id = ' . $user->data['user_id'];						$db->sql_query($sql);						$msg = $user->lang['PREFERENCES_UPDATED'];					}					else					{						$msg = $user->lang['FORM_INVALID'];					}					meta_refresh(3, $this->u_action);					$message = $msg . '<br /><br />' . sprintf($user->lang['RETURN_UCP'], '<a href="' . $this->u_action . '">', '</a>');					trigger_error($message);				}				$template->assign_vars(array(					'S_BBCODE'	=> $data['bbcode'],					'S_SMILIES'	=> $data['smilies'],					'S_SIG'		=> $data['sig'],					'S_NOTIFY'	=> $data['notify'])				);			break;		}		$template->assign_vars(array(			'L_TITLE'			=> $user->lang['UCP_PREFS_' . strtoupper($mode)],			'S_HIDDEN_FIELDS'	=> $s_hidden_fields,			'S_UCP_ACTION'		=> $this->u_action)		);		$this->tpl_name = 'ucp_prefs_' . $mode;		$this->page_title = 'UCP_PREFS_' . strtoupper($mode);	}}?>
<?php/**** @package phpBB3* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**/if (php_sapi_name() != 'cli'){	die("This program must be run from the command line.\n");}//// Security message://// This script is potentially dangerous.// Remove or comment the next line (die(".... ) to enable this script.// Do NOT FORGET to either remove this script or disable it after you have used it.//die("Please read the first lines of this script for instructions on how to enable it");set_time_limit(0);define('IN_PHPBB', true);$phpbb_root_path = '../';$phpEx = substr(strrchr(__FILE__, '.'), 1);echo "Checking for required files\n";download('http://www.unicode.org/Public/UNIDATA/CompositionExclusions.txt');download('http://www.unicode.org/Public/UNIDATA/DerivedNormalizationProps.txt');download('http://www.unicode.org/Public/UNIDATA/UnicodeData.txt');echo "\n";require_once($phpbb_root_path . 'includes/utf/utf_normalizer.' . $phpEx);$file_contents = array();/*** Generate some Hangul/Jamo stuff*/echo "\nGenerating Hangul and Jamo tables\n";for ($i = 0; $i < UNICODE_HANGUL_LCOUNT; ++$i){	$utf_char = cp_to_utf(UNICODE_HANGUL_LBASE + $i);	$file_contents['utf_normalizer_common']['utf_jamo_index'][$utf_char] = $i * UNICODE_HANGUL_VCOUNT * UNICODE_HANGUL_TCOUNT + UNICODE_HANGUL_SBASE;	$file_contents['utf_normalizer_common']['utf_jamo_type'][$utf_char] = UNICODE_JAMO_L;}for ($i = 0; $i < UNICODE_HANGUL_VCOUNT; ++$i){	$utf_char = cp_to_utf(UNICODE_HANGUL_VBASE + $i);	$file_contents['utf_normalizer_common']['utf_jamo_index'][$utf_char] = $i * UNICODE_HANGUL_TCOUNT;	$file_contents['utf_normalizer_common']['utf_jamo_type'][$utf_char] = UNICODE_JAMO_V;}for ($i = 0; $i < UNICODE_HANGUL_TCOUNT; ++$i){	$utf_char = cp_to_utf(UNICODE_HANGUL_TBASE + $i);	$file_contents['utf_normalizer_common']['utf_jamo_index'][$utf_char] = $i;	$file_contents['utf_normalizer_common']['utf_jamo_type'][$utf_char] = UNICODE_JAMO_T;}/*** Load the CompositionExclusions table*/echo "Loading CompositionExclusion\n";$fp = fopen('CompositionExclusions.txt', 'rt');$exclude = array();while (!feof($fp)){	$line = fgets($fp, 1024);	if (!strpos(' 0123456789ABCDEFabcdef', $line[0]))	{		continue;	}	$cp = strtok($line, ' ');	if ($pos = strpos($cp, '..'))	{		$start = hexdec(substr($cp, 0, $pos));		$end = hexdec(substr($cp, $pos + 2));		for ($i = $start; $i < $end; ++$i)		{			$exclude[$i] = 1;		}	}	else	{		$exclude[hexdec($cp)] = 1;	}}fclose($fp);/*** Load QuickCheck tables*/echo "Generating QuickCheck tables\n";$fp = fopen('DerivedNormalizationProps.txt', 'rt');while (!feof($fp)){	$line = fgets($fp, 1024);	if (!strpos(' 0123456789ABCDEFabcdef', $line[0]))	{		continue;	}	$p = array_map('trim', explode(';', strtok($line, '#')));	/**	* Capture only NFC_QC, NFKC_QC	*/	if (!preg_match('#^NFK?C_QC$#', $p[1]))	{		continue;	}	if ($pos = strpos($p[0], '..'))	{		$start = hexdec(substr($p[0], 0, $pos));		$end = hexdec(substr($p[0], $pos + 2));	}	else	{		$start = $end = hexdec($p[0]);	}	if ($start >= UTF8_HANGUL_FIRST && $end <= UTF8_HANGUL_LAST)	{		/**		* We do not store Hangul syllables in the array		*/		continue;	}	if ($p[2] == 'M')	{		$val = UNICODE_QC_MAYBE;	}	else	{		$val = UNICODE_QC_NO;	}	if ($p[1] == 'NFKC_QC')	{		$file = 'utf_nfkc_qc';	}	else	{		$file = 'utf_nfc_qc';	}	for ($i = $start; $i <= $end; ++$i)	{		/**		* The vars have the same name as the file: $utf_nfc_qc is in utf_nfc_qc.php		*/		$file_contents[$file][$file][cp_to_utf($i)] = $val;	}}fclose($fp);/*** Do mappings*/echo "Loading Unicode decomposition mappings\n";$fp = fopen($phpbb_root_path . 'develop/UnicodeData.txt', 'rt');$map = array();while (!feof($fp)){	$p = explode(';', fgets($fp, 1024));	$cp = hexdec($p[0]);	if (!empty($p[3]))	{		/**		* Store combining class > 0		*/		$file_contents['utf_normalizer_common']['utf_combining_class'][cp_to_utf($cp)] = (int) $p[3];	}	if (!isset($p[5]) || !preg_match_all('#[0-9A-F]+#', strip_tags($p[5]), $m))	{		continue;	}	if (strpos($p[5], '>'))	{		$map['NFKD'][$cp] = implode(' ', array_map('hexdec', $m[0]));	}	else	{		$map['NFD'][$cp] = $map['NFKD'][$cp] = implode(' ', array_map('hexdec', $m[0]));	}}fclose($fp);/*** Build the canonical composition table*/echo "Generating the Canonical Composition table\n";foreach ($map['NFD'] as $cp => $decomp_seq){	if (!strpos($decomp_seq, ' ') || isset($exclude[$cp]))	{		/**		* Singletons are excluded from canonical composition		*/		continue;	}	$utf_seq = implode('', array_map('cp_to_utf', explode(' ', $decomp_seq)));	if (!isset($file_contents['utf_canonical_comp']['utf_canonical_comp'][$utf_seq]))	{		$file_contents['utf_canonical_comp']['utf_canonical_comp'][$utf_seq] = cp_to_utf($cp);	}}/*** Decompose the NF[K]D mappings recursively and prepare the file contents*/echo "Generating the Canonical and Compatibility Decomposition tables\n\n";foreach ($map as $type => $decomp_map){	foreach ($decomp_map as $cp => $decomp_seq)	{		$decomp_map[$cp] = decompose($decomp_map, $decomp_seq);	}	unset($decomp_seq);	if ($type == 'NFKD')	{		$file = 'utf_compatibility_decomp';		$var = 'utf_compatibility_decomp';	}	else	{		$file = 'utf_canonical_decomp';		$var = 'utf_canonical_decomp';	}	/**	* Generate the corresponding file	*/	foreach ($decomp_map as $cp => $decomp_seq)	{		$file_contents[$file][$var][cp_to_utf($cp)] = implode('', array_map('cp_to_utf', explode(' ', $decomp_seq)));	}}/*** Generate and/or alter the files*/foreach ($file_contents as $file => $contents){	/**	* Generate a new file	*/	echo "Writing to $file.$phpEx\n";	if (!$fp = fopen($phpbb_root_path . 'includes/utf/data/' . $file . '.' . $phpEx, 'wb'))	{		trigger_error('Cannot open ' . $file . ' for write');	}	fwrite($fp, '<?php');	foreach ($contents as $var => $val)	{		fwrite($fp, "\n\$GLOBALS[" . my_var_export($var) . ']=' . my_var_export($val) . ";");	}	fclose($fp);}echo "\n*** UTF-8 normalization tables done\n\n";/*** Now we'll generate the files needed by the search indexer*/echo "Generating search indexer tables\n";$fp = fopen($phpbb_root_path . 'develop/UnicodeData.txt', 'rt');$map = array();while ($line = fgets($fp, 1024)){	/**	* The current line is split, $m[0] hold the codepoint in hexadecimal and	* all other fields numbered as in http://www.unicode.org/Public/UNIDATA/UCD.html#UnicodeData.txt	*/	$m = explode(';', $line);	/**	* @var	integer	$cp			Current char codepoint	* @var	string	$utf_char	UTF-8 representation of current char	*/	$cp = hexdec($m[0]);	$utf_char = cp_to_utf($cp);	/**	* $m[2] holds the "General Category" of the character	* @link http://www.unicode.org/Public/UNIDATA/UCD.html#General_Category_Values	*/	switch ($m[2][0])	{		case 'L':			/**			* We allow all letters and map them to their lowercased counterpart on the fly			*/			$map_to_hex = (isset($m[13][0])) ? $m[13] : $m[0];			if (preg_match('#^LATIN.*(?:LETTER|LIGATURE) ([A-Z]{2}(?![A-Z]))$#', $m[1], $capture))			{				/**				* Special hack for some latin ligatures. Using the name of a character				* is bad practice, but for now it works well enough.				*				* @todo Note that ligatures with combining marks such as U+01E2 are				* not supported at this time				*/				$map[$cp] = strtolower($capture[1]);			}			else if (isset($m[13][0]))			{				/**				* If the letter has a lowercased form, use it				*/				$map[$cp] = hex_to_utf($m[13]);			}			else			{				/**				* In all other cases, map the letter to itself				*/				$map[$cp] = $utf_char;			}			break;		case 'M':			/**			* We allow all marks, they are mapped to themselves			*/			$map[$cp] = $utf_char;			break;		case 'N':			/**			* We allow all numbers, but we map them to their numeric value whenever			* possible. The numeric value (field #8) is in ASCII already			*			* @todo Note that fractions such as U+00BD will be converted to something			* like "1/2", with a slash. However, "1/2" entered in ASCII is converted			* to "1 2". This will have to be fixed.			*/			$map[$cp] = (isset($m[8][0])) ? $m[8] : $utf_char;			break;		default:			/**			* Everything else is ignored, skip to the next line			*/			continue 2;	}}fclose($fp);/*** Add some cheating*/$cheats = array(	'00DF'	=>	'ss',		#	German sharp S	'00C5'	=>	'ae',		#	Capital A with diaeresis	'00E4'	=>	'ae',		#	Small A with diaeresis	'00D6'	=>	'oe',		#	Capital O with diaeresis	'00F6'	=>	'oe',		#	Small O with diaeresis	'00DC'	=>	'ue',		#	Capital U with diaeresis	'00FC'	=>	'ue',		#	Small U with diaeresis);/*** Add our "cheat replacements" to the map*/foreach ($cheats as $hex => $map_to){	$map[hexdec($hex)] = $map_to;}/*** Split the map into smaller blocks*/$file_contents = array();foreach ($map as $cp => $map_to){	$file_contents[$cp >> 11][cp_to_utf($cp)] = $map_to;}unset($map);foreach ($file_contents as $idx => $contents){	echo "Writing to search_indexer_$idx.$phpEx\n";	$fp = fopen($phpbb_root_path . 'includes/utf/data/search_indexer_' . $idx . '.' . $phpEx, 'wb');	fwrite($fp, '<?php return ' . my_var_export($contents) . ';');	fclose($fp);}echo "\n*** Search indexer tables done\n\n";die("\nAll done!\n");//////////////////////////////////////////////////////////////////////////////////                             Internal functions                             ///////////////////////////////////////////////////////////////////////////////////*** Decompose a sequence recusively** @param	array	$decomp_map	Decomposition mapping, passed by reference* @param	string	$decomp_seq	Decomposition sequence as decimal codepoints separated with a space* @return	string				Decomposition sequence, fully decomposed*/function decompose(&$decomp_map, $decomp_seq){	$ret = array();	foreach (explode(' ', $decomp_seq) as $cp)	{		if (isset($decomp_map[$cp]))		{			$ret[] = decompose($decomp_map, $decomp_map[$cp]);		}		else		{			$ret[] = $cp;		}	}	return implode(' ', $ret);}/*** Return a parsable string representation of a variable** This is function is limited to array/strings/integers** @param	mixed	$var		Variable* @return	string				PHP code representing the variable*/function my_var_export($var){	if (is_array($var))	{		$lines = array();		foreach ($var as $k => $v)		{			$lines[] = my_var_export($k) . '=>' . my_var_export($v);		}		return 'array(' . implode(',', $lines) . ')';	}	else if (is_string($var))	{		return "'" . str_replace(array('\\', "'"), array('\\\\', "\\'"), $var) . "'";	}	else	{		return $var;	}}/*** Download a file to the develop/ dir** @param	string	$url		URL of the file to download* @return	void*/function download($url){	global $phpbb_root_path;	if (file_exists($phpbb_root_path . 'develop/' . basename($url)))	{		return;	}	echo 'Downloading from ', $url, ' ';	if (!$fpr = fopen($url, 'rb'))	{		die("Can't download from $url\nPlease download it yourself and put it in the develop/ dir, kthxbai");	}	if (!$fpw = fopen($phpbb_root_path . 'develop/' . basename($url), 'wb'))	{		die("Can't open develop/" . basename($url) . " for output... please check your permissions or something");	}	$i = 0;	$chunk = 32768;	$done = '';	while (!feof($fpr))	{		$i += fwrite($fpw, fread($fpr, $chunk));		echo str_repeat("\x08", strlen($done));		$done = ($i >> 10) . ' KiB';		echo $done;	}	fclose($fpr);	fclose($fpw);	echo "\n";}/*** Convert a codepoint in hexadecimal to a UTF-8 char** @param	string	$hex		Codepoint, in hexadecimal* @return	string				UTF-8 char*/function hex_to_utf($hex){	return cp_to_utf(hexdec($hex));}/*** Return a UTF string formed from a sequence of codepoints in hexadecimal** @param	string	$seq		Sequence of codepoints, separated with a space* @return	string				UTF-8 string*/function hexseq_to_utf($seq){	return implode('', array_map('hex_to_utf', explode(' ', $seq)));}/*** Convert a codepoint to a UTF-8 char** @param	integer	$cp			Unicode codepoint* @return	string				UTF-8 string*/function cp_to_utf($cp){	if ($cp > 0xFFFF)	{		return chr(0xF0 | ($cp >> 18)) . chr(0x80 | (($cp >> 12) & 0x3F)) . chr(0x80 | (($cp >> 6) & 0x3F)) . chr(0x80 | ($cp & 0x3F));	}	else if ($cp > 0x7FF)	{		return chr(0xE0 | ($cp >> 12)) . chr(0x80 | (($cp >> 6) & 0x3F)) . chr(0x80 | ($cp & 0x3F));	}	else if ($cp > 0x7F)	{		return chr(0xC0 | ($cp >> 6)) . chr(0x80 | ($cp & 0x3F));	}	else	{		return chr($cp);	}}
<?php/**** ucp [English]** @package language* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** DO NOT CHANGE*/if (!defined('IN_PHPBB')){	exit;}if (empty($lang) || !is_array($lang)){	$lang = array();}// DEVELOPERS PLEASE NOTE//// All language files should use UTF-8 as their encoding and the files must not contain a BOM.//// Placeholders can now contain order information, e.g. instead of// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows// translators to re-order the output of data while ensuring it remains correct//// You do not need this where single placeholders are used, e.g. 'Message %d' is fine// equally where a string contains only two placeholders which are used to wrap text// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine// Privacy policy and T&C$lang = array_merge($lang, array(	'TERMS_OF_USE_CONTENT'	=> 'By accessing %1$s (hereinafter we, us, our, %1$s, %2$s), you agree to be legally bound by the following terms. If you do not agree to be legally bound by all of the following terms then please do not access and/or use %1$s. We may change these at any time and well do our utmost in informing you, though it would be prudent to review this regularly yourself as your continued usage of %1$s after changes mean you agree to be legally bound by these terms as they are updated and/or amended.<br />	<br />	Our forums are powered by phpBB (hereinafter they, them, their, phpBB software, www.phpbb.com, phpBB Group, phpBB Teams) which is a bulletin board solution released under the <a href="http://opensource.org/licenses/gpl-license.php">General Public License</a> (hereinafter GPL) and can be downloaded from <a href="http://www.phpbb.com/">www.phpbb.com</a>. The phpBB software only facilitates internet based discussions, the phpBB Group are not responsible for what we allow and/or disallow as permissible content and/or conduct. For further information about phpBB, please see: <a href="http://www.phpbb.com/">http://www.phpbb.com/</a>.<br />	<br />	You agree not to post any abusive, obscene, vulgar, slanderous, hateful, threatening, sexually-orientated or any other material that may violate any laws be it of your country, the country where %1$s is hosted or International Law. Doing so may lead to you being immediately and permanently banned, with notification of your Internet Service Provider if deemed required by us. The IP address of all posts are recorded to aid in enforcing these conditions. You agree that %1$s have the right to remove, edit, move or close any topic at any time should we see fit. As a user you agree to any information you have entered to being stored in a database. While this information will not be disclosed to any third party without your consent, neither %1$s nor phpBB shall be held responsible for any hacking attempt that may lead to the data being compromised.	',	'PRIVACY_POLICY'		=> 'This policy explains in detail how %1$s along with its affiliated companies (hereinafter we, us, our, %1$s, %2$s) and phpBB (hereinafter they, them, their, phpBB software, www.phpbb.com, phpBB Group, phpBB Teams) use any information collected during any session of usage by you (hereinafter your information).<br />	<br />	Your information is collected via two ways. Firstly, by browsing %1$s will cause the phpBB software to create a number of cookies, which are small text files that are downloaded on to your computers web browser temporary files. The first two cookies just contain a user identifier (hereinafter user-id) and an anonymous session identifier (hereinafter session-id), automatically assigned to you by the phpBB software. A third cookie will be created once you have browsed topics within %1$s and is used to store which topics have been read, thereby improving your user experience.<br />	<br />	We may also create cookies external to the phpBB software whilst browsing %1$s, though these are outside the scope of this document which is intended to only cover the pages created by the phpBB software. The second way in which we collect your information is by what you submit to us. This can be, and is not limited to: posting as an anonymous user (hereinafter anonymous posts), registering on %1$s (hereinafter your account) and posts submitted by you after registration and whilst logged in (hereinafter your posts).<br />	<br />	Your account will at a bare minimum contain a uniquely identifiable name (hereinafter your user name), a personal password used for logging into your account (hereinafter your password) and a personal, valid e-mail address (hereinafter your e-mail). Your information for your account at %1$s is protected by data-protection laws applicable in the country that hosts us. Any information beyond your user name, your password, and your e-mail address required by %1$s during the registration process is either mandatory or optional, at the discretion of %1$s. In all cases, you have the option of what information in your account is publicly displayed. Furthermore, within your account, you have the option to opt-in or opt-out of automatically generated e-mails from the phpBB software.<br />	<br />	Your password is ciphered (a one-way hash) so that it is secure. However, it is recommended that you do not reuse the same password across a number of different websites. Your password is the means of accessing your account at %1$s, so please guard it carefully and under no circumstance will anyone affiliated with %1$s, phpBB or another 3rd party, legitimately ask you for your password. Should you forget your password for your account, you can use the I forgot my password feature provided by the phpBB software. This process will ask you to submit your user name and your e-mail, then the phpBB software will generate a new password to reclaim your account.<br />	',));// Common language entries$lang = array_merge($lang, array(	'ACCOUNT_ACTIVE'				=> 'Your account has now been activated. Thank you for registering.',	'ACCOUNT_ACTIVE_ADMIN'			=> 'The account has now been activated.',	'ACCOUNT_ACTIVE_PROFILE'		=> 'Your account has now been successfully reactivated.',	'ACCOUNT_ADDED'					=> 'Thank you for registering, your account has been created. You may now login with your username and password.',	'ACCOUNT_COPPA'					=> 'Your account has been created but has to be approved, please check your e-mail for details.',	'ACCOUNT_EMAIL_CHANGED'			=> 'Your account has been updated. However, this board requires account reactivation on e-mail changes. An activation key has been sent to the new e-mail address you provided. Please check your e-mail for further information.',	'ACCOUNT_EMAIL_CHANGED_ADMIN'	=> 'Your account has been updated. However, this board requires account reactivation by the administrators on e-mail changes. An e-mail has been sent to them and you will be informed when your account has been reactivated.',	'ACCOUNT_INACTIVE'				=> 'Your account has been created. However, this board requires account activation, an activation key has been sent to the e-mail address you provided. Please check your e-mail for further information.',	'ACCOUNT_INACTIVE_ADMIN'		=> 'Your account has been created. However, this board requires account activation by the administrator group. An e-mail has been sent to them and you will be informed when your account has been activated.',	'ACTIVATION_EMAIL_SENT'			=> 'The activation e-mail has been sent to your e-mail address.',	'ACTIVATION_EMAIL_SENT_ADMIN'	=> 'The activation e-mail has been sent to the administrators e-mail addresses.',	'ADD'							=> 'Add',	'ADD_BCC'						=> 'Add [BCC]',	'ADD_FOES'						=> 'Add new foes',	'ADD_FOES_EXPLAIN'				=> 'You may enter several usernames each on a different line.',	'ADD_FOLDER'					=> 'Add folder',	'ADD_FRIENDS'					=> 'Add new friends',	'ADD_FRIENDS_EXPLAIN'			=> 'You may enter several usernames each on a different line.',	'ADD_NEW_RULE'					=> 'Add new rule',	'ADD_RULE'						=> 'Add rule',	'ADD_TO'						=> 'Add [To]',	'ADD_USERS_UCP_EXPLAIN'			=> 'Here you can add new users to the group. You may select whether this group becomes the new default for the selected users. Please enter each username on a separate line.',	'ADMIN_EMAIL'					=> 'Administrators can e-mail me information',	'AGREE'							=> 'I agree to these terms',	'ALLOW_PM'						=> 'Allow users to send you private messages',	'ALLOW_PM_EXPLAIN'				=> 'Note that administrators and moderators will always be able to send you messages.',	'ALREADY_ACTIVATED'				=> 'You have already activated your account.',	'ATTACHMENTS_EXPLAIN'			=> 'This is a list of attachments you have made in posts to this board.',	'ATTACHMENTS_DELETED'			=> 'Attachments successfully deleted.',	'ATTACHMENT_DELETED'			=> 'Attachment successfully deleted.',	'AVATAR_CATEGORY'				=> 'Category',	'AVATAR_EXPLAIN'				=> 'Maximum dimensions; width: %1$d pixels, height: %2$d pixels, file size: %3$.2f KiB.',	'AVATAR_FEATURES_DISABLED'		=> 'The avatar functionality is currently disabled.',	'AVATAR_GALLERY'				=> 'Local gallery',	'AVATAR_GENERAL_UPLOAD_ERROR'	=> 'Could not upload avatar to %s.',	'AVATAR_NOT_ALLOWED'			=> 'Your avatar cannot be displayed because avatars have been disallowed.',	'AVATAR_PAGE'					=> 'Page',	'AVATAR_TYPE_NOT_ALLOWED'		=> 'Your current avatar cannot be displayed because its type has been disallowed.',	'BACK_TO_DRAFTS'			=> 'Back to saved drafts',	'BACK_TO_LOGIN'				=> 'Back to login screen',	'BIRTHDAY'					=> 'Birthday',	'BIRTHDAY_EXPLAIN'			=> 'Setting a year will list your age when it is your birthday.',	'BOARD_DATE_FORMAT'			=> 'My date format',	'BOARD_DATE_FORMAT_EXPLAIN'	=> 'The syntax used is identical to the PHP <a href="http://www.php.net/date">date()</a> function.',	'BOARD_DST'					=> 'Summer Time/<abbr title="Daylight Saving Time">DST</abbr> is in effect',	'BOARD_LANGUAGE'			=> 'My language',	'BOARD_STYLE'				=> 'My board style',	'BOARD_TIMEZONE'			=> 'My timezone',	'BOOKMARKS'					=> 'Bookmarks',	'BOOKMARKS_EXPLAIN'			=> 'You can bookmark topics for future reference. Select the checkbox for any bookmark you wish to delete, then press the <em>Remove marked bookmarks</em> button.',	'BOOKMARKS_DISABLED'		=> 'Bookmarks are disabled on this board.',	'BOOKMARKS_REMOVED'			=> 'Bookmarks removed successfully.',	'CANNOT_EDIT_MESSAGE_TIME'	=> 'You can no longer edit or delete that message.',	'CANNOT_MOVE_TO_SAME_FOLDER'=> 'Messages cannot be moved to the folder you want to remove.',	'CANNOT_MOVE_FROM_SPECIAL'	=> 'Messages cannot be moved from the outbox.',	'CANNOT_RENAME_FOLDER'		=> 'This folder cannot be renamed.',	'CANNOT_REMOVE_FOLDER'		=> 'This folder cannot be removed.',	'CHANGE_DEFAULT_GROUP'		=> 'Change default group',	'CHANGE_PASSWORD'			=> 'Change password',	'CLICK_GOTO_FOLDER'			=> '%1$sGo to your %3$s folder%2$s',	'CLICK_RETURN_FOLDER'		=> '%1$sReturn to your %3$s folder%2$s',	'CONFIRMATION'				=> 'Confirmation of registration',	'CONFIRM_CHANGES'			=> 'Confirm changes',	'CONFIRM_EMAIL'				=> 'Confirm e-mail address',	'CONFIRM_EMAIL_EXPLAIN'		=> 'You only need to specify this if you are changing your e-mail address.',	'CONFIRM_EXPLAIN'			=> 'To prevent automated registrations the board requires you to enter a confirmation code. The code is displayed in the image you should see below. If you are visually impaired or cannot otherwise read this code please contact the %sBoard Administrator%s.',	'VC_REFRESH'				=> 'Refresh confirmation code',	'VC_REFRESH_EXPLAIN'		=> 'If you cannot read the code you can request a new one by clicking the button.',	'CONFIRM_PASSWORD'			=> 'Confirm password',	'CONFIRM_PASSWORD_EXPLAIN'	=> 'You only need to confirm your password if you changed it above.',	'COPPA_BIRTHDAY'			=> 'To continue with the registration procedure please tell us when you were born.',	'COPPA_COMPLIANCE'			=> 'COPPA compliance',	'COPPA_EXPLAIN'				=> 'Please note that clicking submit will create your account. However it cannot be activated until a parent or guardian approves your registration. You will be emailed a copy of the necessary form with details of where to send it.',	'CREATE_FOLDER'				=> 'Add folder',	'CURRENT_IMAGE'				=> 'Current image',	'CURRENT_PASSWORD'			=> 'Current password',	'CURRENT_PASSWORD_EXPLAIN'	=> 'You must confirm your current password if you wish to change it, alter your e-mail address or username.',	'CUR_PASSWORD_EMPTY'		=> 'You did not enter your current password.',	'CUR_PASSWORD_ERROR'		=> 'The current password you entered is incorrect.',	'CUSTOM_DATEFORMAT'			=> 'Custom',	'DEFAULT_ACTION'			=> 'Default action',	'DEFAULT_ACTION_EXPLAIN'	=> 'This action will be triggered if none of the above is applicable.',	'DEFAULT_ADD_SIG'			=> 'Attach my signature by default',	'DEFAULT_BBCODE'			=> 'Enable BBCode by default',	'DEFAULT_NOTIFY'			=> 'Notify me upon replies by default',	'DEFAULT_SMILIES'			=> 'Enable smilies by default',	'DEFINED_RULES'				=> 'Defined rules',	'DELETED_TOPIC'				=> 'Topic has been removed.',	'DELETE_ATTACHMENT'			=> 'Delete attachment',	'DELETE_ATTACHMENTS'		=> 'Delete attachments',	'DELETE_ATTACHMENT_CONFIRM'	=> 'Are you sure you want to delete this attachment?',	'DELETE_ATTACHMENTS_CONFIRM'=> 'Are you sure you want to delete these attachments?',	'DELETE_AVATAR'				=> 'Delete image',	'DELETE_COOKIES_CONFIRM'	=> 'Are you sure you want to delete all cookies set by this board?',	'DELETE_MARKED_PM'			=> 'Delete marked messages',	'DELETE_MARKED_PM_CONFIRM'	=> 'Are you sure you want to delete all marked messages?',	'DELETE_OLDEST_MESSAGES'	=> 'Delete oldest messages',	'DELETE_MESSAGE'			=> 'Delete message',	'DELETE_MESSAGE_CONFIRM'	=> 'Are you sure you want to delete this private message?',	'DELETE_MESSAGES_IN_FOLDER'	=> 'Delete all messages within removed folder',	'DELETE_RULE'				=> 'Delete rule',	'DELETE_RULE_CONFIRM'		=> 'Are you sure you want to delete this rule?',	'DEMOTE_SELECTED'			=> 'Demote selected',	'DISABLE_CENSORS'			=> 'Enable word censoring',	'DISPLAY_GALLERY'			=> 'Display gallery',	'DOMAIN_NO_MX_RECORD_EMAIL'	=> 'The entered e-mail domain has no valid MX record.',	'DOWNLOADS'					=> 'Downloads',	'DRAFTS_DELETED'			=> 'All selected drafts were successfully deleted.',	'DRAFTS_EXPLAIN'			=> 'Here you can view, edit and delete your saved drafts.',	'DRAFT_UPDATED'				=> 'Draft successfully updated.',	'EDIT_DRAFT_EXPLAIN'		=> 'Here you are able to edit your draft. Drafts do not contain attachment and poll information.',	'EMAIL_BANNED_EMAIL'		=> 'The e-mail address you entered is not allowed to be used.',	'EMAIL_INVALID_EMAIL'		=> 'The e-mail address you entered is invalid.',	'EMAIL_REMIND'				=> 'This must be the e-mail address associated with your account. If you have not changed this via your user control panel then it is the e-mail address you registered your account with.',	'EMAIL_TAKEN_EMAIL'			=> 'The entered e-mail address is already in use.',	'EMPTY_DRAFT'				=> 'You must enter a message to submit your changes.',	'EMPTY_DRAFT_TITLE'			=> 'You must enter a draft title.',	'EXPORT_AS_XML'				=> 'Export as XML',	'EXPORT_AS_CSV'				=> 'Export as CSV',	'EXPORT_AS_CSV_EXCEL'		=> 'Export as CSV (Excel)',	'EXPORT_AS_TXT'				=> 'Export as TXT',	'EXPORT_AS_MSG'				=> 'Export as MSG',	'EXPORT_FOLDER'				=> 'Export this view',	'FIELD_REQUIRED'					=> 'The field %s must be completed.',	'FIELD_TOO_SHORT'					=> 'The field %1$s is too short, a minimum of %2$d characters is required.',	'FIELD_TOO_LONG'					=> 'The field %1$s is too long, a maximum of %2$d characters is allowed.',	'FIELD_TOO_SMALL'					=> 'The value of %1$s is too small, a minimum value of %2$d is required.',	'FIELD_TOO_LARGE'					=> 'The value of %1$s is too large, a maximum value of %2$d is allowed.',	'FIELD_INVALID_CHARS_NUMBERS_ONLY'	=> 'The field %s has invalid characters, only numbers are allowed.',	'FIELD_INVALID_CHARS_ALPHA_ONLY'	=> 'The field %s has invalid characters, only alphanumeric characters are allowed.',	'FIELD_INVALID_CHARS_SPACERS_ONLY'	=> 'The field %s has invalid characters, only alphanumeric, space or -+_[] characters are allowed.',	'FIELD_INVALID_DATE'				=> 'The field %s has an invalid date.',	'FIELD_INVALID_VALUE'				=> 'The field %s has an invalid value.',	'FOE_MESSAGE'				=> 'Message from foe',	'FOES_EXPLAIN'				=> 'Foes are users which will be ignored by default. Posts by these users will not be fully visible. Personal messages from foes are still permitted. Please note that you cannot ignore moderators or administrators.',	'FOES_UPDATED'				=> 'Your foes list has been updated successfully.',	'FOLDER_ADDED'				=> 'Folder successfully added.',	'FOLDER_MESSAGE_STATUS'		=> '%1$d from %2$d messages stored',	'FOLDER_NAME_EMPTY'			=> 'You must enter a name for this folder.',	'FOLDER_NAME_EXIST'			=> 'Folder <strong>%s</strong> already exists.',	'FOLDER_OPTIONS'			=> 'Folder options',	'FOLDER_RENAMED'			=> 'Folder successfully renamed.',	'FOLDER_REMOVED'			=> 'Folder successfully removed.',	'FOLDER_STATUS_MSG'			=> 'Folder is %1$d%% full (%2$d from %3$d messages stored)',	'FORWARD_PM'				=> 'Forward PM',	'FORCE_PASSWORD_EXPLAIN'	=> 'Before you may continue browsing the board you are required to change your password.',	'FRIEND_MESSAGE'			=> 'Message from friend',	'FRIENDS'					=> 'Friends',	'FRIENDS_EXPLAIN'			=> 'Friends enable you quick access to members you communicate with frequently. If the template has relevant support any posts made by a friend may be highlighted.',	'FRIENDS_OFFLINE'			=> 'Offline',	'FRIENDS_ONLINE'			=> 'Online',	'FRIENDS_UPDATED'			=> 'Your friends list has been updated successfully.',	'FULL_FOLDER_OPTION_CHANGED'=> 'The action to take when a folder is full has been changed successfully.',	'FWD_ORIGINAL_MESSAGE'		=> '-------- Original Message --------',	'FWD_SUBJECT'				=> 'Subject: %s',	'FWD_DATE'					=> 'Date: %s',	'FWD_FROM'					=> 'From: %s',	'FWD_TO'					=> 'To: %s',	'GLOBAL_ANNOUNCEMENT'		=> 'Global announcement',	'HIDE_ONLINE'				=> 'Hide my online status',	'HIDE_ONLINE_EXPLAIN'		=> 'Changing this setting wont become effective until your next visit to the board.',	'HOLD_NEW_MESSAGES'			=> 'Do not accept new messages (New messages will be held back until enough space is available)',	'HOLD_NEW_MESSAGES_SHORT'	=> 'New messages will be held back',	'IF_FOLDER_FULL'			=> 'If folder is full',	'IMPORTANT_NEWS'			=> 'Important announcements',	'INVALID_USER_BIRTHDAY'			=> 'The entered birthday is not a valid date.',	'INVALID_CHARS_USERNAME'	=> 'The username contains forbidden characters.',	'INVALID_CHARS_NEW_PASSWORD'=> 'The password does not contain the required characters.',	'ITEMS_REQUIRED'			=> 'The items marked with * are required profile fields and need to be filled out.',	'JOIN_SELECTED'				=> 'Join selected',	'LANGUAGE'					=> 'Language',	'LINK_REMOTE_AVATAR'		=> 'Link off-site',	'LINK_REMOTE_AVATAR_EXPLAIN'=> 'Enter the URL of the location containing the avatar image you wish to link to.',	'LINK_REMOTE_SIZE'			=> 'Avatar dimensions',	'LINK_REMOTE_SIZE_EXPLAIN'	=> 'Specify the width and height of the avatar, leave blank to attempt automatic verification.',	'LOGIN_EXPLAIN_UCP'			=> 'Please login in order to access the User Control Panel.',	'LOGIN_REDIRECT'			=> 'You have been successfully logged in.',	'LOGOUT_FAILED'				=> 'You were not logged out, as the request did not match your session. Please contact the board administrator if you continue to experience problems.',	'LOGOUT_REDIRECT'			=> 'You have been successfully logged out.',	'MARK_IMPORTANT'				=> 'Mark/Unmark as important',	'MARKED_MESSAGE'				=> 'Marked message',	'MAX_FOLDER_REACHED'			=> 'Maximum number of allowed user defined folders reached.',	'MESSAGE_BY_AUTHOR'				=> 'by',	'MESSAGE_COLOURS'				=> 'Message colours',	'MESSAGE_DELETED'				=> 'Message successfully deleted.',	'MESSAGE_HISTORY'				=> 'Message history',	'MESSAGE_REMOVED_FROM_OUTBOX'	=> 'This message has been removed by its author before it was delivered.',	'MESSAGE_SENT_ON'				=> 'on',	'MESSAGE_STORED'				=> 'This message has been sent successfully.',	'MESSAGE_TO'					=> 'To',	'MESSAGES_DELETED'				=> 'Messages successfully deleted',	'MOVE_DELETED_MESSAGES_TO'		=> 'Move messages from removed folder to',	'MOVE_DOWN'						=> 'Move down',	'MOVE_MARKED_TO_FOLDER'			=> 'Move marked to %s',	'MOVE_PM_ERROR'					=> 'An error occurred while moving the messages to the new folder, only %1d from %2d messages were moved.',	'MOVE_TO_FOLDER'				=> 'Move to folder',	'MOVE_UP'						=> 'Move up',	'NEW_EMAIL_CONFIRM_EMPTY'		=> 'You did not enter a confirm e-mail address.',	'NEW_EMAIL_ERROR'				=> 'The e-mail addresses you entered do not match.',	'NEW_FOLDER_NAME'				=> 'New folder name',	'NEW_PASSWORD'					=> 'New password',	'NEW_PASSWORD_CONFIRM_EMPTY'	=> 'You did not enter a confirm password.',	'NEW_PASSWORD_ERROR'			=> 'The passwords you entered do not match.',	'NOTIFY_METHOD'					=> 'Notification method',	'NOTIFY_METHOD_BOTH'			=> 'Both',	'NOTIFY_METHOD_EMAIL'			=> 'E-mail only',	'NOTIFY_METHOD_EXPLAIN'			=> 'Method for sending messages sent via this board.',	'NOTIFY_METHOD_IM'				=> 'Jabber only',	'NOTIFY_ON_PM'					=> 'Notify me on new private messages',	'NOT_ADDED_FRIENDS_ANONYMOUS'	=> 'You cannot add the anonymous user to your friends list.',	'NOT_ADDED_FRIENDS_BOTS'		=> 'You cannot add bots to your friends list.',	'NOT_ADDED_FRIENDS_FOES'		=> 'You cannot add users to your friends list who are on your foes list.',	'NOT_ADDED_FRIENDS_SELF'		=> 'You cannot add yourself to the friends list.',	'NOT_ADDED_FOES_MOD_ADMIN'		=> 'You cannot add administrators and moderators to your foes list.',	'NOT_ADDED_FOES_ANONYMOUS'		=> 'You cannot add the anonymous user to your foes list.',	'NOT_ADDED_FOES_BOTS'			=> 'You cannot add bots to your foes list.',	'NOT_ADDED_FOES_FRIENDS'		=> 'You cannot add users to your foes list who are on your friends list.',	'NOT_ADDED_FOES_SELF'			=> 'You cannot add yourself to the foes list.',	'NOT_AGREE'						=> 'I do not agree to these terms',	'NOT_ENOUGH_SPACE_FOLDER'		=> 'The destination folder %s seems to be full. The requested action has not been taken.',	'NOT_MOVED_MESSAGE'				=> 'You have 1 private message currently on hold because of full folder.',	'NOT_MOVED_MESSAGES'			=> 'You have %d private messages currently on hold because of full folder.',	'NO_ACTION_MODE'				=> 'No message action specified.',	'NO_AUTHOR'						=> 'No author defined for this message',	'NO_AVATAR_CATEGORY'			=> 'None',	'NO_AUTH_DELETE_MESSAGE'		=> 'You are not authorised to delete private messages.',	'NO_AUTH_EDIT_MESSAGE'			=> 'You are not authorised to edit private messages.',	'NO_AUTH_FORWARD_MESSAGE'		=> 'You are not authorised to forward private messages.',	'NO_AUTH_GROUP_MESSAGE'			=> 'You are not authorised to send private messages to groups.',	'NO_AUTH_PASSWORD_REMINDER'		=> 'You are not authorised to request a new password.',	'NO_AUTH_READ_HOLD_MESSAGE'		=> 'You are not authorised to read private messages that are on hold.',	'NO_AUTH_READ_MESSAGE'			=> 'You are not authorised to read private messages.',	'NO_AUTH_READ_REMOVED_MESSAGE'	=> 'You are not able to read this message because it was removed by the author.',	'NO_AUTH_SEND_MESSAGE'			=> 'You are not authorised to send private messages.',	'NO_AUTH_SIGNATURE'				=> 'You are not authorised to define a signature.',	'NO_BCC_RECIPIENT'			=> 'None',	'NO_BOOKMARKS'				=> 'You have no bookmarks.',	'NO_BOOKMARKS_SELECTED'		=> 'You have selected no bookmarks.',	'NO_EDIT_READ_MESSAGE'		=> 'Private message cannot be edited because it has already been read.',	'NO_EMAIL_USER'				=> 'The e-mail/username information submitted could not be found.',	'NO_FOES'					=> 'No foes currently defined',	'NO_FRIENDS'				=> 'No friends currently defined',	'NO_FRIENDS_OFFLINE'		=> 'No friends offline',	'NO_FRIENDS_ONLINE'			=> 'No friends online',	'NO_GROUP_SELECTED'			=> 'No group specified.',	'NO_IMPORTANT_NEWS'			=> 'No important announcements present.',	'NO_MESSAGE'				=> 'Private message could not be found.',	'NO_NEW_FOLDER_NAME'		=> 'You have to specify a new folder name.',	'NO_NEWER_PM'				=> 'No newer messages.',	'NO_OLDER_PM'				=> 'No older messages.',	'NO_PASSWORD_SUPPLIED'		=> 'You cannot login without a password.',	'NO_RECIPIENT'				=> 'No recipient defined.',	'NO_RULES_DEFINED'			=> 'No rules defined.',	'NO_SAVED_DRAFTS'			=> 'No drafts saved.',	'NO_TO_RECIPIENT'			=> 'None',	'NO_WATCHED_FORUMS'			=> 'You are not subscribed to any forums.',	'NO_WATCHED_SELECTED'		=> 'You have not selected any subscribed topics or forums.',	'NO_WATCHED_TOPICS'			=> 'You are not subscribed to any topics.',	'PASS_TYPE_ALPHA_EXPLAIN'	=> 'Password must be between %1$d and %2$d characters long, must contain letters in mixed case and must contain numbers.',	'PASS_TYPE_ANY_EXPLAIN'		=> 'Must be between %1$d and %2$d characters.',	'PASS_TYPE_CASE_EXPLAIN'	=> 'Password must be between %1$d and %2$d characters long and must contain letters in mixed case.',	'PASS_TYPE_SYMBOL_EXPLAIN'	=> 'Password must be between %1$d and %2$d characters long, must contain letters in mixed case, must contain numbers and must contain symbols.',	'PASSWORD'					=> 'Password',	'PASSWORD_ACTIVATED'		=> 'Your new password has been activated.',	'PASSWORD_UPDATED'			=> 'A new password was sent to your registered e-mail address.',	'PERMISSIONS_RESTORED'		=> 'Successfully restored original permissions.',	'PERMISSIONS_TRANSFERRED'	=> 'Successfully transferred permissions from <strong>%s</strong>, you are now able to browse the board with this users permissions.<br />Please note that admin permissions were not transferred. You are able to revert to your permission set at any time.',	'PM_DISABLED'				=> 'Private messaging has been disabled on this board.',	'PM_FROM'					=> 'From',	'PM_FROM_REMOVED_AUTHOR'	=> 'This message was sent by a user no longer registered.',	'PM_ICON'					=> 'PM icon',	'PM_INBOX'					=> 'Inbox',	'PM_NO_USERS'				=> 'The requested users to be added do not exist.',	'PM_OUTBOX'					=> 'Outbox',	'PM_SENTBOX'				=> 'Sent messages',	'PM_SUBJECT'				=> 'Message subject',	'PM_TO'						=> 'Send to',	'PM_USERS_REMOVED_NO_PM'	=> 'Some users couldnt be added as they have disabled private message receipt.',	'POPUP_ON_PM'				=> 'Pop up window on new private message',	'POST_EDIT_PM'				=> 'Edit message',	'POST_FORWARD_PM'			=> 'Forward message',	'POST_NEW_PM'				=> 'Compose message',	'POST_PM_LOCKED'			=> 'Private messaging is locked.',	'POST_PM_POST'				=> 'Quote post',	'POST_QUOTE_PM'				=> 'Quote message',	'POST_REPLY_PM'				=> 'Reply to message',	'PRINT_PM'					=> 'Print view',	'PREFERENCES_UPDATED'		=> 'Your preferences have been updated.',	'PROFILE_INFO_NOTICE'		=> 'Please note that this information may be viewable to other members. Be careful when including any personal details. Any fields marked with a * must be completed.',	'PROFILE_UPDATED'			=> 'Your profile has been updated.',	'RECIPIENT'							=> 'Recipient',	'RECIPIENTS'						=> 'Recipients',	'REGISTRATION'						=> 'Registration',	'RELEASE_MESSAGES'					=> '%sRelease all on-hold messages%s they will be re-sorted into the appropriate folder if enough space is made available.',	'REMOVE_ADDRESS'					=> 'Remove address',	'REMOVE_SELECTED_BOOKMARKS'			=> 'Remove selected bookmarks',	'REMOVE_SELECTED_BOOKMARKS_CONFIRM'	=> 'Are you sure you want to delete all selected bookmarks?',	'REMOVE_BOOKMARK_MARKED'			=> 'Remove marked bookmarks',	'REMOVE_FOLDER'						=> 'Remove folder',	'REMOVE_FOLDER_CONFIRM'				=> 'Are you sure you want to remove this folder?',	'RENAME'							=> 'Rename',	'RENAME_FOLDER'						=> 'Rename folder',	'REPLIED_MESSAGE'					=> 'Replied to message',	'REPLY_TO_ALL'						=> 'Reply to sender and all recipients.',	'REPORT_PM'							=> 'Report private message',	'RESIGN_SELECTED'					=> 'Resign selected',	'RETURN_FOLDER'						=> '%1$sReturn to previous folder%2$s',	'RETURN_UCP'						=> '%sReturn to the User Control Panel%s',	'RULE_ADDED'						=> 'Rule successfully added.',	'RULE_ALREADY_DEFINED'				=> 'This rule was defined previously.',	'RULE_DELETED'						=> 'Rule successfully removed.',	'RULE_NOT_DEFINED'					=> 'Rule not correctly specified.',	'RULE_REMOVED_MESSAGE'				=> 'One private message had been removed due to private message filters.',	'RULE_REMOVED_MESSAGES'				=> '%d private messages were removed due to private message filters.',	'SAME_PASSWORD_ERROR'		=> 'The new password you entered is the same as your current password.',	'SEARCH_YOUR_POSTS'			=> 'Show your posts',	'SEND_PASSWORD'				=> 'Send password',	'SENT_AT'					=> 'Sent',			// Used before dates in private messages	'SHOW_EMAIL'				=> 'Users can contact me by e-mail',	'SIGNATURE_EXPLAIN'			=> 'This is a block of text that can be added to posts you make. There is a %d character limit.',	'SIGNATURE_PREVIEW'			=> 'Your signature will appear like this in posts',	'SIGNATURE_TOO_LONG'		=> 'Your signature is too long.',	'SORT'						=> 'Sort',	'SORT_COMMENT'				=> 'File comment',	'SORT_DOWNLOADS'			=> 'Downloads',	'SORT_EXTENSION'			=> 'Extension',	'SORT_FILENAME'				=> 'Filename',	'SORT_POST_TIME'			=> 'Post time',	'SORT_SIZE'					=> 'File size',	'TIMEZONE'					=> 'Timezone',	'TO'						=> 'To',	'TOO_MANY_RECIPIENTS'		=> 'You tried to send a private message to too many recipients.',	'TOO_MANY_REGISTERS'		=> 'You have exceeded the maximum number of registration attempts for this session. Please try again later.',	'UCP'						=> 'User Control Panel',	'UCP_ACTIVATE'				=> 'Activate account',	'UCP_ADMIN_ACTIVATE'		=> 'Please note that you will need to enter a valid e-mail address before your account is activated. The administrator will review your account and if approved you will receive an e-mail at the address you specified.',	'UCP_AIM'					=> 'AOL Instant Messenger',	'UCP_ATTACHMENTS'			=> 'Attachments',	'UCP_COPPA_BEFORE'			=> 'Before %s',	'UCP_COPPA_ON_AFTER'		=> 'On or after %s',	'UCP_EMAIL_ACTIVATE'		=> 'Please note that you will need to enter a valid e-mail address before your account is activated. You will receive an e-mail at the address you provide that contains an account activation link.',	'UCP_ICQ'					=> 'ICQ number',	'UCP_JABBER'				=> 'Jabber address',	'UCP_MAIN'					=> 'Overview',	'UCP_MAIN_ATTACHMENTS'		=> 'Manage attachments',	'UCP_MAIN_BOOKMARKS'		=> 'Manage bookmarks',	'UCP_MAIN_DRAFTS'			=> 'Manage drafts',	'UCP_MAIN_FRONT'			=> 'Front page',	'UCP_MAIN_SUBSCRIBED'		=> 'Manage subscriptions',	'UCP_MSNM'					=> 'WL/MSN Messenger',	'UCP_NO_ATTACHMENTS'		=> 'You have posted no files.',	'UCP_PREFS'					=> 'Board preferences',	'UCP_PREFS_PERSONAL'		=> 'Edit global settings',	'UCP_PREFS_POST'			=> 'Edit posting defaults',	'UCP_PREFS_VIEW'			=> 'Edit display options',	'UCP_PM'					=> 'Private messages',	'UCP_PM_COMPOSE'			=> 'Compose message',	'UCP_PM_DRAFTS'				=> 'Manage PM drafts',	'UCP_PM_OPTIONS'			=> 'Rules, folders &amp; settings',	'UCP_PM_POPUP'				=> 'Private messages',	'UCP_PM_POPUP_TITLE'		=> 'Private message popup',	'UCP_PM_UNREAD'				=> 'Unread messages',	'UCP_PM_VIEW'				=> 'View messages',	'UCP_PROFILE'				=> 'Profile',	'UCP_PROFILE_AVATAR'		=> 'Edit avatar',	'UCP_PROFILE_PROFILE_INFO'	=> 'Edit profile',	'UCP_PROFILE_REG_DETAILS'	=> 'Edit account settings',	'UCP_PROFILE_SIGNATURE'		=> 'Edit signature',	'UCP_USERGROUPS'			=> 'Usergroups',	'UCP_USERGROUPS_MEMBER'		=> 'Edit memberships',	'UCP_USERGROUPS_MANAGE'		=> 'Manage groups',	'UCP_REGISTER_DISABLE'			=> 'Creating a new account is currently not possible.',	'UCP_REMIND'					=> 'Send password',	'UCP_RESEND'					=> 'Send activation e-mail',	'UCP_WELCOME'					=> 'Welcome to the User Control Panel. From here you can monitor, view and update your profile, preferences, subscribed forums and topics. You can also send messages to other users (if permitted). Please ensure you read any announcements before continuing.',	'UCP_YIM'						=> 'Yahoo Messenger',	'UCP_ZEBRA'						=> 'Friends &amp; Foes',	'UCP_ZEBRA_FOES'				=> 'Manage foes',	'UCP_ZEBRA_FRIENDS'				=> 'Manage friends',	'UNDISCLOSED_RECIPIENT'			=> 'Undisclosed Recipient',	'UNKNOWN_FOLDER'				=> 'Unknown folder',	'UNWATCH_MARKED'				=> 'Unwatch marked',	'UPLOAD_AVATAR_FILE'			=> 'Upload from your machine',	'UPLOAD_AVATAR_URL'				=> 'Upload from a URL',	'UPLOAD_AVATAR_URL_EXPLAIN'		=> 'Enter the URL of the location containing the image. The image will be copied to this site.',	'USERNAME_ALPHA_ONLY_EXPLAIN'	=> 'Username must be between %1$d and %2$d chars long and use only alphanumeric characters.',	'USERNAME_ALPHA_SPACERS_EXPLAIN'=> 'Username must be between %1$d and %2$d chars long and use alphanumeric, space or -+_[] characters.',	'USERNAME_ASCII_EXPLAIN'		=> 'Username must be between %1$d and %2$d chars long and use only ASCII characters, so no special symbols.',	'USERNAME_LETTER_NUM_EXPLAIN'	=> 'Username must be between %1$d and %2$d chars long and use only letter or number characters.',	'USERNAME_LETTER_NUM_SPACERS_EXPLAIN'=> 'Username must be between %1$d and %2$d chars long and use letter, number, space or -+_[] characters.',	'USERNAME_CHARS_ANY_EXPLAIN'	=> 'Length must be between %1$d and %2$d characters.',	'USERNAME_TAKEN_USERNAME'		=> 'The username you entered is already in use, please select an alternative.',	'USERNAME_DISALLOWED_USERNAME'	=> 'The username you entered has been disallowed or contains a disallowed word. Please choose a different name.',	'USER_NOT_FOUND_OR_INACTIVE'	=> 'The usernames you specified could either not be found or are not activated users.',	'VIEW_AVATARS'				=> 'Display avatars',	'VIEW_EDIT'					=> 'View/Edit',	'VIEW_FLASH'				=> 'Display Flash animations',	'VIEW_IMAGES'				=> 'Display images within posts',	'VIEW_NEXT_HISTORY'			=> 'Next PM in history',	'VIEW_NEXT_PM'				=> 'Next PM',	'VIEW_PM'					=> 'View message',	'VIEW_PM_INFO'				=> 'Message details',	'VIEW_PM_MESSAGE'			=> '1 message',	'VIEW_PM_MESSAGES'			=> '%d messages',	'VIEW_PREVIOUS_HISTORY'		=> 'Previous PM in history',	'VIEW_PREVIOUS_PM'			=> 'Previous PM',	'VIEW_SIGS'					=> 'Display signatures',	'VIEW_SMILIES'				=> 'Display smilies as images',	'VIEW_TOPICS_DAYS'			=> 'Display topics from previous days',	'VIEW_TOPICS_DIR'			=> 'Display topic order direction',	'VIEW_TOPICS_KEY'			=> 'Display topics ordering by',	'VIEW_POSTS_DAYS'			=> 'Display posts from previous days',	'VIEW_POSTS_DIR'			=> 'Display post order direction',	'VIEW_POSTS_KEY'			=> 'Display posts ordering by',	'WATCHED_EXPLAIN'			=> 'Below is a list of forums and topics you are subscribed to. You will be notified of new posts in either. To unsubscribe mark the forum or topic and then press the <em>Unwatch marked</em> button.',	'WATCHED_FORUMS'			=> 'Watched forums',	'WATCHED_TOPICS'			=> 'Watched topics',	'WRONG_ACTIVATION'			=> 'The activation key you supplied does not match any in the database.',	'YOUR_DETAILS'				=> 'Your activity',	'YOUR_FOES'					=> 'Your foes',	'YOUR_FOES_EXPLAIN'			=> 'To remove usernames select them and click submit.',	'YOUR_FRIENDS'				=> 'Your friends',	'YOUR_FRIENDS_EXPLAIN'		=> 'To remove usernames select them and click submit.',	'YOUR_WARNINGS'				=> 'Your warning level',	'PM_ACTION' => array(		'PLACE_INTO_FOLDER'	=> 'Place into folder',		'MARK_AS_READ'		=> 'Mark as read',		'MARK_AS_IMPORTANT'	=> 'Mark message',		'DELETE_MESSAGE'	=> 'Delete message'	),	'PM_CHECK' => array(		'SUBJECT'	=> 'Subject',		'SENDER'	=> 'Sender',		'MESSAGE'	=> 'Message',		'STATUS'	=> 'Message status',		'TO'		=> 'Sent To'	),	'PM_RULE' => array(		'IS_LIKE'		=> 'is like',		'IS_NOT_LIKE'	=> 'is not like',		'IS'			=> 'is',		'IS_NOT'		=> 'is not',		'BEGINS_WITH'	=> 'begins with',		'ENDS_WITH'		=> 'ends with',		'IS_FRIEND'		=> 'is friend',		'IS_FOE'		=> 'is foe',		'IS_USER'		=> 'is user',		'IS_GROUP'		=> 'is in usergroup',		'ANSWERED'		=> 'answered',		'FORWARDED'		=> 'forwarded',		'TO_GROUP'		=> 'to my default usergroup',		'TO_ME'			=> 'to me'	),	'GROUPS_EXPLAIN'	=> 'Usergroups enable board admins to better administer users. By default you will be placed in a specific group, this is your default group. This group defines how you may appear to other users, for example your username colouration, avatar, rank, etc. Depending on whether the administrator allows it you may be allowed to change your default group. You may also be placed in or allowed to join other groups. Some groups may give you additional permissions to view content or increase your capabilities in other areas.',	'GROUP_LEADER'		=> 'Leaderships',	'GROUP_MEMBER'		=> 'Memberships',	'GROUP_PENDING'		=> 'Pending memberships',	'GROUP_NONMEMBER'	=> 'Non-memberships',	'GROUP_DETAILS'		=> 'Group details',	'NO_LEADER'		=> 'No group leaderships',	'NO_MEMBER'		=> 'No group memberships',	'NO_PENDING'	=> 'No pending memberships',	'NO_NONMEMBER'	=> 'No non-member groups',));?>
<?php/**** @package phpBB3* @version $Id$* @copyright (c) 2009, 2010 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** This script will check your database for potentially dangerous flash BBCode tags*///// Security message://// This script is potentially dangerous.// Remove or comment the next line (die(".... ) to enable this script.// Do NOT FORGET to either remove this script or disable it after you have used it.//die("Please read the first lines of this script for instructions on how to enable it\n");/***/define('IN_PHPBB', true);$phpbb_root_path = (defined('PHPBB_ROOT_PATH')) ? PHPBB_ROOT_PATH : './';$phpEx = substr(strrchr(__FILE__, '.'), 1);include($phpbb_root_path . 'common.' . $phpEx);if (php_sapi_name() != 'cli'){	header('Content-Type: text/plain');}check_table_flash_bbcodes(POSTS_TABLE, 'post_id', 'post_text', 'bbcode_uid', 'bbcode_bitfield');check_table_flash_bbcodes(PRIVMSGS_TABLE, 'msg_id', 'message_text', 'bbcode_uid', 'bbcode_bitfield');check_table_flash_bbcodes(USERS_TABLE, 'user_id', 'user_sig', 'user_sig_bbcode_uid', 'user_sig_bbcode_bitfield');check_table_flash_bbcodes(FORUMS_TABLE, 'forum_id', 'forum_desc', 'forum_desc_uid', 'forum_desc_bitfield');check_table_flash_bbcodes(FORUMS_TABLE, 'forum_id', 'forum_rules', 'forum_rules_uid', 'forum_rules_bitfield');check_table_flash_bbcodes(GROUPS_TABLE, 'group_id', 'group_desc', 'group_desc_uid', 'group_desc_bitfield');echo "If potentially dangerous flash bbcodes were found, please reparse the posts using the Support Toolkit (http://www.phpbb.com/support/stk/) and/or file a ticket in the Incident Tracker (http://www.phpbb.com/incidents/).\n";function check_table_flash_bbcodes($table_name, $id_field, $content_field, $uid_field, $bitfield_field){	echo "Checking $content_field on $table_name\n";	$ids = get_table_flash_bbcode_pkids($table_name, $id_field, $content_field, $uid_field, $bitfield_field);	$size = sizeof($ids);	if ($size)	{		echo "Found $size potentially dangerous flash bbcodes.\n";		echo "$id_field: " . implode(', ', $ids) . "\n";	}	else	{		echo "No potentially dangerous flash bbcodes found.\n";	}	echo "\n";}function get_table_flash_bbcode_pkids($table_name, $id_field, $content_field, $uid_field, $bitfield_field){	global $db;	$ids = array();	$sql = "SELECT $id_field, $content_field, $uid_field, $bitfield_field		FROM $table_name		WHERE $content_field LIKE '%[/flash:%'			AND $bitfield_field <> ''";	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$uid = $row[$uid_field];		// thanks support toolkit		$content = html_entity_decode_utf8($row[$content_field]);		set_var($content, $content, 'string', true);		$content = utf8_normalize_nfc($content);		$bitfield_data = $row[$bitfield_field];		if (!is_valid_flash_bbcode($content, $uid) && has_flash_enabled($bitfield_data))		{			$ids[] = (int) $row[$id_field];		}	}	$db->sql_freeresult($result);	return $ids;}function get_flash_regex($uid){	return "#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#";}// extract all valid flash bbcodes// check if the bbcode content is a valid URL for each matchfunction is_valid_flash_bbcode($cleaned_content, $uid){	$regex = get_flash_regex($uid);	$url_regex = get_preg_expression('url');	$www_url_regex = get_preg_expression('www_url');	if (preg_match_all($regex, $cleaned_content, $matches))	{		foreach ($matches[3] as $flash_url)		{			if (!preg_match("#^($url_regex|$www_url_regex)$#i", $flash_url))			{				return false;			}		}	}	return true;}// check if a bitfield includes flash// 11 = flash bitfunction has_flash_enabled($bitfield_data){	$bitfield = new bitfield($bitfield_data);	return $bitfield->get(11);}// taken from support toolkitfunction html_entity_decode_utf8($string){	static $trans_tbl;	// replace numeric entities	$string = preg_replace('~&#x([0-9a-f]+);~ei', 'code2utf8(hexdec("\\1"))', $string);	$string = preg_replace('~&#([0-9]+);~e', 'code2utf8(\\1)', $string);	// replace literal entities	if (!isset($trans_tbl))	{		$trans_tbl = array();		foreach (get_html_translation_table(HTML_ENTITIES) as $val=>$key)			$trans_tbl[$key] = utf8_encode($val);	}	return strtr($string, $trans_tbl);}// taken from support toolkit// Returns the utf string corresponding to the unicode value (from php.net, courtesy - romans@void.lv)function code2utf8($num){	if ($num < 128) return chr($num);	if ($num < 2048) return chr(($num >> 6) + 192) . chr(($num & 63) + 128);	if ($num < 65536) return chr(($num >> 12) + 224) . chr((($num >> 6) & 63) + 128) . chr(($num & 63) + 128);	if ($num < 2097152) return chr(($num >> 18) + 240) . chr((($num >> 12) & 63) + 128) . chr((($num >> 6) & 63) + 128) . chr(($num & 63) + 128);	return '';}
<?php/**** @package dbal* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** @ignore*/if (!defined('IN_PHPBB')){	exit;}/*** Database Abstraction Layer* @package dbal*/class dbal{	var $db_connect_id;	var $query_result;	var $return_on_error = false;	var $transaction = false;	var $sql_time = 0;	var $num_queries = array();	var $open_queries = array();	var $curtime = 0;	var $query_hold = '';	var $html_hold = '';	var $sql_report = '';	var $persistency = false;	var $user = '';	var $server = '';	var $dbname = '';	// Set to true if error triggered	var $sql_error_triggered = false;	// Holding the last sql query on sql error	var $sql_error_sql = '';	// Holding the error information - only populated if sql_error_triggered is set	var $sql_error_returned = array();	// Holding transaction count	var $transactions = 0;	// Supports multi inserts?	var $multi_insert = false;	/**	* Current sql layer	*/	var $sql_layer = '';	/**	* Wildcards for matching any (%) or exactly one (_) character within LIKE expressions	*/	var $any_char;	var $one_char;	/**	* Exact version of the DBAL, directly queried	*/	var $sql_server_version = false;	/**	* Constructor	*/	function dbal()	{		$this->num_queries = array(			'cached'		=> 0,			'normal'		=> 0,			'total'			=> 0,		);		// Fill default sql layer based on the class being called.		// This can be changed by the specified layer itself later if needed.		$this->sql_layer = substr(get_class($this), 5);		// Do not change this please! This variable is used to easy the use of it - and is hardcoded.		$this->any_char = chr(0) . '%';		$this->one_char = chr(0) . '_';	}	/**	* return on error or display error message	*/	function sql_return_on_error($fail = false)	{		$this->sql_error_triggered = false;		$this->sql_error_sql = '';		$this->return_on_error = $fail;	}	/**	* Return number of sql queries and cached sql queries used	*/	function sql_num_queries($cached = false)	{		return ($cached) ? $this->num_queries['cached'] : $this->num_queries['normal'];	}	/**	* Add to query count	*/	function sql_add_num_queries($cached = false)	{		$this->num_queries['cached'] += ($cached !== false) ? 1 : 0;		$this->num_queries['normal'] += ($cached !== false) ? 0 : 1;		$this->num_queries['total'] += 1;	}	/**	* DBAL garbage collection, close sql connection	*/	function sql_close()	{		if (!$this->db_connect_id)		{			return false;		}		if ($this->transaction)		{			do			{				$this->sql_transaction('commit');			}			while ($this->transaction);		}		foreach ($this->open_queries as $query_id)		{			$this->sql_freeresult($query_id);		}		// Connection closed correctly. Set db_connect_id to false to prevent errors		if ($result = $this->_sql_close())		{			$this->db_connect_id = false;		}		return $result;	}	/**	* Build LIMIT query	* Doing some validation here.	*/	function sql_query_limit($query, $total, $offset = 0, $cache_ttl = 0)	{		if (empty($query))		{			return false;		}		// Never use a negative total or offset		$total = ($total < 0) ? 0 : $total;		$offset = ($offset < 0) ? 0 : $offset;		return $this->_sql_query_limit($query, $total, $offset, $cache_ttl);	}	/**	* Fetch all rows	*/	function sql_fetchrowset($query_id = false)	{		if ($query_id === false)		{			$query_id = $this->query_result;		}		if ($query_id !== false)		{			$result = array();			while ($row = $this->sql_fetchrow($query_id))			{				$result[] = $row;			}			return $result;		}		return false;	}	/**	* Fetch field	* if rownum is false, the current row is used, else it is pointing to the row (zero-based)	*/	function sql_fetchfield($field, $rownum = false, $query_id = false)	{		global $cache;		if ($query_id === false)		{			$query_id = $this->query_result;		}		if ($query_id !== false)		{			if ($rownum !== false)			{				$this->sql_rowseek($rownum, $query_id);			}			if (!is_object($query_id) && isset($cache->sql_rowset[$query_id]))			{				return $cache->sql_fetchfield($query_id, $field);			}			$row = $this->sql_fetchrow($query_id);			return (isset($row[$field])) ? $row[$field] : false;		}		return false;	}	/**	* Correctly adjust LIKE expression for special characters	* Some DBMS are handling them in a different way	*	* @param string $expression The expression to use. Every wildcard is escaped, except $this->any_char and $this->one_char	* @return string LIKE expression including the keyword!	*/	function sql_like_expression($expression)	{		$expression = utf8_str_replace(array('_', '%'), array("\_", "\%"), $expression);		$expression = utf8_str_replace(array(chr(0) . "\_", chr(0) . "\%"), array('_', '%'), $expression);		return $this->_sql_like_expression('LIKE \'' . $this->sql_escape($expression) . '\'');	}	/**	* Returns whether results of a query need to be buffered to run a transaction while iterating over them.	*	* @return bool Whether buffering is required.	*/	function sql_buffer_nested_transactions()	{		return false;	}	/**	* SQL Transaction	* @access private	*/	function sql_transaction($status = 'begin')	{		switch ($status)		{			case 'begin':				// If we are within a transaction we will not open another one, but enclose the current one to not loose data (prevening auto commit)				if ($this->transaction)				{					$this->transactions++;					return true;				}				$result = $this->_sql_transaction('begin');				if (!$result)				{					$this->sql_error();				}				$this->transaction = true;			break;			case 'commit':				// If there was a previously opened transaction we do not commit yet... but count back the number of inner transactions				if ($this->transaction && $this->transactions)				{					$this->transactions--;					return true;				}				// Check if there is a transaction (no transaction can happen if there was an error, with a combined rollback and error returning enabled)				// This implies we have transaction always set for autocommit db's				if (!$this->transaction)				{					return false;				}				$result = $this->_sql_transaction('commit');				if (!$result)				{					$this->sql_error();				}				$this->transaction = false;				$this->transactions = 0;			break;			case 'rollback':				$result = $this->_sql_transaction('rollback');				$this->transaction = false;				$this->transactions = 0;			break;			default:				$result = $this->_sql_transaction($status);			break;		}		return $result;	}	/**	* Build sql statement from array for insert/update/select statements	*	* Idea for this from Ikonboard	* Possible query values: INSERT, INSERT_SELECT, UPDATE, SELECT	*	*/	function sql_build_array($query, $assoc_ary = false)	{		if (!is_array($assoc_ary))		{			return false;		}		$fields = $values = array();		if ($query == 'INSERT' || $query == 'INSERT_SELECT')		{			foreach ($assoc_ary as $key => $var)			{				$fields[] = $key;				if (is_array($var) && is_string($var[0]))				{					// This is used for INSERT_SELECT(s)					$values[] = $var[0];				}				else				{					$values[] = $this->_sql_validate_value($var);				}			}			$query = ($query == 'INSERT') ? ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')' : ' (' . implode(', ', $fields) . ') SELECT ' . implode(', ', $values) . ' ';		}		else if ($query == 'MULTI_INSERT')		{			trigger_error('The MULTI_INSERT query value is no longer supported. Please use sql_multi_insert() instead.', E_USER_ERROR);		}		else if ($query == 'UPDATE' || $query == 'SELECT')		{			$values = array();			foreach ($assoc_ary as $key => $var)			{				$values[] = "$key = " . $this->_sql_validate_value($var);			}			$query = implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);		}		return $query;	}	/**	* Build IN or NOT IN sql comparison string, uses <> or = on single element	* arrays to improve comparison speed	*	* @access public	* @param	string	$field				name of the sql column that shall be compared	* @param	array	$array				array of values that are allowed (IN) or not allowed (NOT IN)	* @param	bool	$negate				true for NOT IN (), false for IN () (default)	* @param	bool	$allow_empty_set	If true, allow $array to be empty, this function will return 1=1 or 1=0 then. Default to false.	*/	function sql_in_set($field, $array, $negate = false, $allow_empty_set = false)	{		if (!sizeof($array))		{			if (!$allow_empty_set)			{				// Print the backtrace to help identifying the location of the problematic code				$this->sql_error('No values specified for SQL IN comparison');			}			else			{				// NOT IN () actually means everything so use a tautology				if ($negate)				{					return '1=1';				}				// IN () actually means nothing so use a contradiction				else				{					return '1=0';				}			}		}		if (!is_array($array))		{			$array = array($array);		}		if (sizeof($array) == 1)		{			@reset($array);			$var = current($array);			return $field . ($negate ? ' <> ' : ' = ') . $this->_sql_validate_value($var);		}		else		{			return $field . ($negate ? ' NOT IN ' : ' IN ') . '(' . implode(', ', array_map(array($this, '_sql_validate_value'), $array)) . ')';		}	}	/**	* Run binary AND operator on DB column.	* Results in sql statement: "{$column_name} & (1 << {$bit}) {$compare}"	*	* @param string $column_name The column name to use	* @param int $bit The value to use for the AND operator, will be converted to (1 << $bit). Is used by options, using the number schema... 0, 1, 2...29	* @param string $compare Any custom SQL code after the check (for example "= 0")	*/	function sql_bit_and($column_name, $bit, $compare = '')	{		if (method_exists($this, '_sql_bit_and'))		{			return $this->_sql_bit_and($column_name, $bit, $compare);		}		return $column_name . ' & ' . (1 << $bit) . (($compare) ? ' ' . $compare : '');	}	/**	* Run binary OR operator on DB column.	* Results in sql statement: "{$column_name} | (1 << {$bit}) {$compare}"	*	* @param string $column_name The column name to use	* @param int $bit The value to use for the OR operator, will be converted to (1 << $bit). Is used by options, using the number schema... 0, 1, 2...29	* @param string $compare Any custom SQL code after the check (for example "= 0")	*/	function sql_bit_or($column_name, $bit, $compare = '')	{		if (method_exists($this, '_sql_bit_or'))		{			return $this->_sql_bit_or($column_name, $bit, $compare);		}		return $column_name . ' | ' . (1 << $bit) . (($compare) ? ' ' . $compare : '');	}	/**	* Run more than one insert statement.	*	* @param string $table table name to run the statements on	* @param array &$sql_ary multi-dimensional array holding the statement data.	*	* @return bool false if no statements were executed.	* @access public	*/	function sql_multi_insert($table, &$sql_ary)	{		if (!sizeof($sql_ary))		{			return false;		}		if ($this->multi_insert)		{			$ary = array();			foreach ($sql_ary as $id => $_sql_ary)			{				// If by accident the sql array is only one-dimensional we build a normal insert statement				if (!is_array($_sql_ary))				{					return $this->sql_query('INSERT INTO ' . $table . ' ' . $this->sql_build_array('INSERT', $sql_ary));				}				$values = array();				foreach ($_sql_ary as $key => $var)				{					$values[] = $this->_sql_validate_value($var);				}				$ary[] = '(' . implode(', ', $values) . ')';			}			return $this->sql_query('INSERT INTO ' . $table . ' ' . ' (' . implode(', ', array_keys($sql_ary[0])) . ') VALUES ' . implode(', ', $ary));		}		else		{			foreach ($sql_ary as $ary)			{				if (!is_array($ary))				{					return false;				}				$result = $this->sql_query('INSERT INTO ' . $table . ' ' . $this->sql_build_array('INSERT', $ary));				if (!$result)				{					return false;				}			}		}		return true;	}	/**	* Function for validating values	* @access private	*/	function _sql_validate_value($var)	{		if (is_null($var))		{			return 'NULL';		}		else if (is_string($var))		{			return "'" . $this->sql_escape($var) . "'";		}		else		{			return (is_bool($var)) ? intval($var) : $var;		}	}	/**	* Build sql statement from array for select and select distinct statements	*	* Possible query values: SELECT, SELECT_DISTINCT	*/	function sql_build_query($query, $array)	{		$sql = '';		switch ($query)		{			case 'SELECT':			case 'SELECT_DISTINCT';				$sql = str_replace('_', ' ', $query) . ' ' . $array['SELECT'] . ' FROM ';				// Build table array. We also build an alias array for later checks.				$table_array = $aliases = array();				$used_multi_alias = false;				foreach ($array['FROM'] as $table_name => $alias)				{					if (is_array($alias))					{						$used_multi_alias = true;						foreach ($alias as $multi_alias)						{							$table_array[] = $table_name . ' ' . $multi_alias;							$aliases[] = $multi_alias;						}					}					else					{						$table_array[] = $table_name . ' ' . $alias;						$aliases[] = $alias;					}				}				// We run the following code to determine if we need to re-order the table array. ;)				// The reason for this is that for multi-aliased tables (two equal tables) in the FROM statement the last table need to match the first comparison.				// DBMS who rely on this: Oracle, PostgreSQL and MSSQL. For all other DBMS it makes absolutely no difference in which order the table is.				if (!empty($array['LEFT_JOIN']) && sizeof($array['FROM']) > 1 && $used_multi_alias !== false)				{					// Take first LEFT JOIN					$join = current($array['LEFT_JOIN']);					// Determine the table used there (even if there are more than one used, we only want to have one					preg_match('/(' . implode('|', $aliases) . ')\.[^\s]+/U', str_replace(array('(', ')', 'AND', 'OR', ' '), '', $join['ON']), $matches);					// If there is a first join match, we need to make sure the table order is correct					if (!empty($matches[1]))					{						$first_join_match = trim($matches[1]);						$table_array = $last = array();						foreach ($array['FROM'] as $table_name => $alias)						{							if (is_array($alias))							{								foreach ($alias as $multi_alias)								{									($multi_alias === $first_join_match) ? $last[] = $table_name . ' ' . $multi_alias : $table_array[] = $table_name . ' ' . $multi_alias;								}							}							else							{								($alias === $first_join_match) ? $last[] = $table_name . ' ' . $alias : $table_array[] = $table_name . ' ' . $alias;							}						}						$table_array = array_merge($table_array, $last);					}				}				$sql .= $this->_sql_custom_build('FROM', implode(' CROSS JOIN ', $table_array));				if (!empty($array['LEFT_JOIN']))				{					foreach ($array['LEFT_JOIN'] as $join)					{						$sql .= ' LEFT JOIN ' . key($join['FROM']) . ' ' . current($join['FROM']) . ' ON (' . $join['ON'] . ')';					}				}				if (!empty($array['WHERE']))				{					$sql .= ' WHERE ' . $this->_sql_custom_build('WHERE', $array['WHERE']);				}				if (!empty($array['GROUP_BY']))				{					$sql .= ' GROUP BY ' . $array['GROUP_BY'];				}				if (!empty($array['ORDER_BY']))				{					$sql .= ' ORDER BY ' . $array['ORDER_BY'];				}			break;		}		return $sql;	}	/**	* display sql error page	*/	function sql_error($sql = '')	{		global $auth, $user, $config;		// Set var to retrieve errored status		$this->sql_error_triggered = true;		$this->sql_error_sql = $sql;		$this->sql_error_returned = $this->_sql_error();		if (!$this->return_on_error)		{			$message = 'SQL ERROR [ ' . $this->sql_layer . ' ]<br /><br />' . $this->sql_error_returned['message'] . ' [' . $this->sql_error_returned['code'] . ']';			// Show complete SQL error and path to administrators only			// Additionally show complete error on installation or if extended debug mode is enabled			// The DEBUG_EXTRA constant is for development only!			if ((isset($auth) && $auth->acl_get('a_')) || defined('IN_INSTALL') || defined('DEBUG_EXTRA'))			{				// Print out a nice backtrace...				$backtrace = get_backtrace();				$message .= ($sql) ? '<br /><br />SQL<br /><br />' . htmlspecialchars($sql) : '';				$message .= ($backtrace) ? '<br /><br />BACKTRACE<br />' . $backtrace : '';				$message .= '<br />';			}			else			{				// If error occurs in initiating the session we need to use a pre-defined language string				// This could happen if the connection could not be established for example (then we are not able to grab the default language)				if (!isset($user->lang['SQL_ERROR_OCCURRED']))				{					$message .= '<br /><br />An sql error occurred while fetching this page. Please contact an administrator if this problem persists.';				}				else				{					if (!empty($config['board_contact']))					{						$message .= '<br /><br />' . sprintf($user->lang['SQL_ERROR_OCCURRED'], '<a href="mailto:' . htmlspecialchars($config['board_contact']) . '">', '</a>');					}					else					{						$message .= '<br /><br />' . sprintf($user->lang['SQL_ERROR_OCCURRED'], '', '');					}				}			}			if ($this->transaction)			{				$this->sql_transaction('rollback');			}			if (strlen($message) > 1024)			{				// We need to define $msg_long_text here to circumvent text stripping.				global $msg_long_text;				$msg_long_text = $message;				trigger_error(false, E_USER_ERROR);			}			trigger_error($message, E_USER_ERROR);		}		if ($this->transaction)		{			$this->sql_transaction('rollback');		}		return $this->sql_error_returned;	}	/**	* Explain queries	*/	function sql_report($mode, $query = '')	{		global $cache, $starttime, $phpbb_root_path, $user;		if (empty($_REQUEST['explain']))		{			return false;		}		if (!$query && $this->query_hold != '')		{			$query = $this->query_hold;		}		switch ($mode)		{			case 'display':				if (!empty($cache))				{					$cache->unload();				}				$this->sql_close();				$mtime = explode(' ', microtime());				$totaltime = $mtime[0] + $mtime[1] - $starttime;				echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">					<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">					<head>						<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />						<meta http-equiv="Content-Style-Type" content="text/css" />						<meta http-equiv="imagetoolbar" content="no" />						<title>SQL Report</title>						<link href="' . $phpbb_root_path . 'adm/style/admin.css" rel="stylesheet" type="text/css" media="screen" />					</head>					<body id="errorpage">					<div id="wrap">						<div id="page-header">							<a href="' . build_url('explain') . '">Return to previous page</a>						</div>						<div id="page-body">							<div id="acp">							<div class="panel">								<span class="corners-top"><span></span></span>								<div id="content">									<h1>SQL Report</h1>									<br />									<p><b>Page generated in ' . round($totaltime, 4) . " seconds with {$this->num_queries['normal']} queries" . (($this->num_queries['cached']) ? " + {$this->num_queries['cached']} " . (($this->num_queries['cached'] == 1) ? 'query' : 'queries') . ' returning data from cache' : '') . '</b></p>									<p>Time spent on ' . $this->sql_layer . ' queries: <b>' . round($this->sql_time, 5) . 's</b> | Time spent on PHP: <b>' . round($totaltime - $this->sql_time, 5) . 's</b></p>									<br /><br />									' . $this->sql_report . '								</div>								<span class="corners-bottom"><span></span></span>							</div>							</div>						</div>						<div id="page-footer">							Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group						</div>					</div>					</body>					</html>';				exit_handler();			break;			case 'stop':				$endtime = explode(' ', microtime());				$endtime = $endtime[0] + $endtime[1];				$this->sql_report .= '					<table cellspacing="1">					<thead>					<tr>						<th>Query #' . $this->num_queries['total'] . '</th>					</tr>					</thead>					<tbody>					<tr>						<td class="row3"><textarea style="font-family:\'Courier New\',monospace;width:99%" rows="5" cols="10">' . preg_replace('/\t(AND|OR)(\W)/', "\$1\$2", htmlspecialchars(preg_replace('/[\s]*[\n\r\t]+[\n\r\s\t]*/', "\n", $query))) . '</textarea></td>					</tr>					</tbody>					</table>					' . $this->html_hold . '					<p style="text-align: center;">				';				if ($this->query_result)				{					if (preg_match('/^(UPDATE|DELETE|REPLACE)/', $query))					{						$this->sql_report .= 'Affected rows: <b>' . $this->sql_affectedrows($this->query_result) . '</b> | ';					}					$this->sql_report .= 'Before: ' . sprintf('%.5f', $this->curtime - $starttime) . 's | After: ' . sprintf('%.5f', $endtime - $starttime) . 's | Elapsed: <b>' . sprintf('%.5f', $endtime - $this->curtime) . 's</b>';				}				else				{					$error = $this->sql_error();					$this->sql_report .= '<b style="color: red">FAILED</b> - ' . $this->sql_layer . ' Error ' . $error['code'] . ': ' . htmlspecialchars($error['message']);				}				$this->sql_report .= '</p><br /><br />';				$this->sql_time += $endtime - $this->curtime;			break;			case 'start':				$this->query_hold = $query;				$this->html_hold = '';				$this->_sql_report($mode, $query);				$this->curtime = explode(' ', microtime());				$this->curtime = $this->curtime[0] + $this->curtime[1];			break;			case 'add_select_row':				$html_table = func_get_arg(2);				$row = func_get_arg(3);				if (!$html_table && sizeof($row))				{					$html_table = true;					$this->html_hold .= '<table cellspacing="1"><tr>';					foreach (array_keys($row) as $val)					{						$this->html_hold .= '<th>' . (($val) ? ucwords(str_replace('_', ' ', $val)) : '&nbsp;') . '</th>';					}					$this->html_hold .= '</tr>';				}				$this->html_hold .= '<tr>';				$class = 'row1';				foreach (array_values($row) as $val)				{					$class = ($class == 'row1') ? 'row2' : 'row1';					$this->html_hold .= '<td class="' . $class . '">' . (($val) ? $val : '&nbsp;') . '</td>';				}				$this->html_hold .= '</tr>';				return $html_table;			break;			case 'fromcache':				$this->_sql_report($mode, $query);			break;			case 'record_fromcache':				$endtime = func_get_arg(2);				$splittime = func_get_arg(3);				$time_cache = $endtime - $this->curtime;				$time_db = $splittime - $endtime;				$color = ($time_db > $time_cache) ? 'green' : 'red';				$this->sql_report .= '<table cellspacing="1"><thead><tr><th>Query results obtained from the cache</th></tr></thead><tbody><tr>';				$this->sql_report .= '<td class="row3"><textarea style="font-family:\'Courier New\',monospace;width:99%" rows="5" cols="10">' . preg_replace('/\t(AND|OR)(\W)/', "\$1\$2", htmlspecialchars(preg_replace('/[\s]*[\n\r\t]+[\n\r\s\t]*/', "\n", $query))) . '</textarea></td></tr></tbody></table>';				$this->sql_report .= '<p style="text-align: center;">';				$this->sql_report .= 'Before: ' . sprintf('%.5f', $this->curtime - $starttime) . 's | After: ' . sprintf('%.5f', $endtime - $starttime) . 's | Elapsed [cache]: <b style="color: ' . $color . '">' . sprintf('%.5f', ($time_cache)) . 's</b> | Elapsed [db]: <b>' . sprintf('%.5f', $time_db) . 's</b></p><br /><br />';				// Pad the start time to not interfere with page timing				$starttime += $time_db;			break;			default:				$this->_sql_report($mode, $query);			break;		}		return true;	}}/*** This variable holds the class name to use later*/$sql_db = (!empty($dbms)) ? 'dbal_' . basename($dbms) : 'dbal';?>
<?php/**** @package install* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//***/if (!defined('IN_INSTALL')){	// Someone has tried to access the file direct. This is not a good idea, so exit	exit;}if (!empty($setmodules)){	// If phpBB is already installed we do not include this module	if (@file_exists($phpbb_root_path . 'config.' . $phpEx) && !file_exists($phpbb_root_path . 'cache/install_lock'))	{		include_once($phpbb_root_path . 'config.' . $phpEx);		if (defined('PHPBB_INSTALLED'))		{			return;		}	}	$module[] = array(		'module_type'		=> 'install',		'module_title'		=> 'INSTALL',		'module_filename'	=> substr(basename(__FILE__), 0, -strlen($phpEx)-1),		'module_order'		=> 10,		'module_subs'		=> '',		'module_stages'		=> array('INTRO', 'REQUIREMENTS', 'DATABASE', 'ADMINISTRATOR', 'CONFIG_FILE', 'ADVANCED', 'CREATE_TABLE', 'FINAL'),		'module_reqs'		=> ''	);}/*** Installation* @package install*/class install_install extends module{	function install_install(&$p_master)	{		$this->p_master = &$p_master;	}	function main($mode, $sub)	{		global $lang, $template, $language, $phpbb_root_path;		switch ($sub)		{			case 'intro':				$this->page_title = $lang['SUB_INTRO'];				$template->assign_vars(array(					'TITLE'			=> $lang['INSTALL_INTRO'],					'BODY'			=> $lang['INSTALL_INTRO_BODY'],					'L_SUBMIT'		=> $lang['NEXT_STEP'],					'S_LANG_SELECT'	=> '<select id="language" name="language">' . $this->p_master->inst_language_select($language) . '</select>',					'U_ACTION'		=> $this->p_master->module_url . "?mode=$mode&amp;sub=requirements&amp;language=$language",				));			break;			case 'requirements':				$this->check_server_requirements($mode, $sub);			break;			case 'database':				$this->obtain_database_settings($mode, $sub);			break;			case 'administrator':				$this->obtain_admin_settings($mode, $sub);			break;			case 'config_file':				$this->create_config_file($mode, $sub);			break;			case 'advanced':				$this->obtain_advanced_settings($mode, $sub);			break;			case 'create_table':				$this->load_schema($mode, $sub);			break;			case 'final':				$this->build_search_index($mode, $sub);				$this->add_modules($mode, $sub);				$this->add_language($mode, $sub);				$this->add_bots($mode, $sub);				$this->email_admin($mode, $sub);				// Remove the lock file				@unlink($phpbb_root_path . 'cache/install_lock');			break;		}		$this->tpl_name = 'install_install';	}	/**	* Checks that the server we are installing on meets the requirements for running phpBB	*/	function check_server_requirements($mode, $sub)	{		global $lang, $template, $phpbb_root_path, $phpEx, $language;		$this->page_title = $lang['STAGE_REQUIREMENTS'];		$template->assign_vars(array(			'TITLE'		=> $lang['REQUIREMENTS_TITLE'],			'BODY'		=> $lang['REQUIREMENTS_EXPLAIN'],		));		$passed = array('php' => false, 'db' => false, 'files' => false, 'pcre' => false, 'imagesize' => false,);		// Test for basic PHP settings		$template->assign_block_vars('checks', array(			'S_LEGEND'			=> true,			'LEGEND'			=> $lang['PHP_SETTINGS'],			'LEGEND_EXPLAIN'	=> $lang['PHP_SETTINGS_EXPLAIN'],		));		// Test the minimum PHP version		$php_version = PHP_VERSION;		if (version_compare($php_version, '4.3.3') < 0)		{			$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';		}		else		{			$passed['php'] = true;			// We also give feedback on whether we're running in safe mode			$result = '<strong style="color:green">' . $lang['YES'];			if (@ini_get('safe_mode') == '1' || strtolower(@ini_get('safe_mode')) == 'on')			{				$result .= ', ' . $lang['PHP_SAFE_MODE'];			}			$result .= '</strong>';		}		$template->assign_block_vars('checks', array(			'TITLE'			=> $lang['PHP_VERSION_REQD'],			'RESULT'		=> $result,			'S_EXPLAIN'		=> false,			'S_LEGEND'		=> false,		));		// Check for register_globals being enabled		if (@ini_get('register_globals') == '1' || strtolower(@ini_get('register_globals')) == 'on')		{			$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';		}		else		{			$result = '<strong style="color:green">' . $lang['YES'] . '</strong>';		}		$template->assign_block_vars('checks', array(			'TITLE'			=> $lang['PHP_REGISTER_GLOBALS'],			'TITLE_EXPLAIN'	=> $lang['PHP_REGISTER_GLOBALS_EXPLAIN'],			'RESULT'		=> $result,			'S_EXPLAIN'		=> true,			'S_LEGEND'		=> false,		));		// Check for url_fopen		if (@ini_get('allow_url_fopen') == '1' || strtolower(@ini_get('allow_url_fopen')) == 'on')		{			$result = '<strong style="color:green">' . $lang['YES'] . '</strong>';		}		else		{			$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';		}		$template->assign_block_vars('checks', array(			'TITLE'			=> $lang['PHP_URL_FOPEN_SUPPORT'],			'TITLE_EXPLAIN'	=> $lang['PHP_URL_FOPEN_SUPPORT_EXPLAIN'],			'RESULT'		=> $result,			'S_EXPLAIN'		=> true,			'S_LEGEND'		=> false,		));		// Check for getimagesize		if (@function_exists('getimagesize'))		{			$passed['imagesize'] = true;			$result = '<strong style="color:green">' . $lang['YES'] . '</strong>';		}		else		{			$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';		}		$template->assign_block_vars('checks', array(			'TITLE'			=> $lang['PHP_GETIMAGESIZE_SUPPORT'],			'TITLE_EXPLAIN'	=> $lang['PHP_GETIMAGESIZE_SUPPORT_EXPLAIN'],			'RESULT'		=> $result,			'S_EXPLAIN'		=> true,			'S_LEGEND'		=> false,		));		// Check for PCRE UTF-8 support		if (@preg_match('//u', ''))		{			$passed['pcre'] = true;			$result = '<strong style="color:green">' . $lang['YES'] . '</strong>';		}		else		{			$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';		}		$template->assign_block_vars('checks', array(			'TITLE'			=> $lang['PCRE_UTF_SUPPORT'],			'TITLE_EXPLAIN'	=> $lang['PCRE_UTF_SUPPORT_EXPLAIN'],			'RESULT'		=> $result,			'S_EXPLAIN'		=> true,			'S_LEGEND'		=> false,		));/***		Better not enabling and adding to the loaded extensions due to the specific requirements needed		if (!@extension_loaded('mbstring'))		{			can_load_dll('mbstring');		}*/		$passed['mbstring'] = true;		if (@extension_loaded('mbstring'))		{			// Test for available database modules			$template->assign_block_vars('checks', array(				'S_LEGEND'			=> true,				'LEGEND'			=> $lang['MBSTRING_CHECK'],				'LEGEND_EXPLAIN'	=> $lang['MBSTRING_CHECK_EXPLAIN'],			));			$checks = array(				array('func_overload', '&', MB_OVERLOAD_MAIL|MB_OVERLOAD_STRING),				array('encoding_translation', '!=', 0),				array('http_input', '!=', 'pass'),				array('http_output', '!=', 'pass')			);			foreach ($checks as $mb_checks)			{				$ini_val = @ini_get('mbstring.' . $mb_checks[0]);				switch ($mb_checks[1])				{					case '&':						if (intval($ini_val) & $mb_checks[2])						{							$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';							$passed['mbstring'] = false;						}						else						{							$result = '<strong style="color:green">' . $lang['YES'] . '</strong>';						}					break;					case '!=':						if ($ini_val != $mb_checks[2])						{							$result = '<strong style="color:red">' . $lang['NO'] . '</strong>';							$passed['mbstring'] = false;						}						else						{							$result = '<strong style="color:green">' . $lang['YES'] . '</strong>';						}					break;				}				$template->assign_block_vars('checks', array(					'TITLE'			=> $lang['MBSTRING_' . strtoupper($mb_checks[0])],					'TITLE_EXPLAIN'	=> $lang['MBSTRING_' . strtoupper($mb_checks[0]) . '_EXPLAIN'],					'RESULT'		=> $result,					'S_EXPLAIN'		=> true,					'S_LEGEND'		=> false,				));			}		}		// Test for available database modules		$template->assign_block_vars('checks', array(			'S_LEGEND'			=> true,			'LEGEND'			=> $lang['PHP_SUPPORTED_DB'],			'LEGEND_EXPLAIN'	=> $lang['PHP_SUPPORTED_DB_EXPLAIN'],		));		$available_dbms = get_available_dbms(false, true);		$passed['db'] = $available_dbms['ANY_DB_SUPPORT'];		unset($available_dbms['ANY_DB_SUPPORT']);		foreach ($available_dbms as $db_name => $db_ary)		{			if (!$db_ary['AVAILABLE'])			{				$template->assign_block_vars('checks', array(					'TITLE'		=> $lang['DLL_' . strtoupper($db_name)],					'RESULT'	=> '<span style="color:red">' . $lang['UNAVAILABLE'] . '</span>',					'S_EXPLAIN'	=> false,					'S_LEGEND'	=> false,				));			}			else			{				$template->assign_block_vars('checks', array(					'TITLE'		=> $lang['DLL_' . strtoupper($db_name)],					'RESULT'	=> '<strong style="color:green">' . $lang['AVAILABLE'] . '</strong>',					'S_EXPLAIN'	=> false,					'S_LEGEND'	=> false,				));			}		}		// Test for other modules		$template->assign_block_vars('checks', array(			'S_LEGEND'			=> true,			'LEGEND'			=> $lang['PHP_OPTIONAL_MODULE'],			'LEGEND_EXPLAIN'	=> $lang['PHP_OPTIONAL_MODULE_EXPLAIN'],		));		foreach ($this->php_dlls_other as $dll)		{			if (!@extension_loaded($dll))			{				if (!can_load_dll($dll))				{					$template->assign_block_vars('checks', array(						'TITLE'		=> $lang['DLL_' . strtoupper($dll)],						'RESULT'	=> '<strong style="color:red">' . $lang['UNAVAILABLE'] . '</strong>',						'S_EXPLAIN'	=> false,						'S_LEGEND'	=> false,					));					continue;				}			}			$template->assign_block_vars('checks', array(				'TITLE'		=> $lang['DLL_' . strtoupper($dll)],				'RESULT'	=> '<strong style="color:green">' . $lang['AVAILABLE'] . '</strong>',				'S_EXPLAIN'	=> false,				'S_LEGEND'	=> false,			));		}		// Can we find Imagemagick anywhere on the system?		$exe = (DIRECTORY_SEPARATOR == '\\') ? '.exe' : '';		$magic_home = getenv('MAGICK_HOME');		$img_imagick = '';		if (empty($magic_home))		{			$locations = array('C:/WINDOWS/', 'C:/WINNT/', 'C:/WINDOWS/SYSTEM/', 'C:/WINNT/SYSTEM/', 'C:/WINDOWS/SYSTEM32/', 'C:/WINNT/SYSTEM32/', '/usr/bin/', '/usr/sbin/', '/usr/local/bin/', '/usr/local/sbin/', '/opt/', '/usr/imagemagick/', '/usr/bin/imagemagick/');			$path_locations = str_replace('\\', '/', (explode(($exe) ? ';' : ':', getenv('PATH'))));			$locations = array_merge($path_locations, $locations);			foreach ($locations as $location)			{				// The path might not end properly, fudge it				if (substr($location, -1, 1) !== '/')				{					$location .= '/';				}				if (@file_exists($location) && @is_readable($location . 'mogrify' . $exe) && @filesize($location . 'mogrify' . $exe) > 3000)				{					$img_imagick = str_replace('\\', '/', $location);					continue;				}			}		}		else		{			$img_imagick = str_replace('\\', '/', $magic_home);		}		$template->assign_block_vars('checks', array(			'TITLE'		=> $lang['APP_MAGICK'],			'RESULT'	=> ($img_imagick) ? '<strong style="color:green">' . $lang['AVAILABLE'] . ', ' . $img_imagick . '</strong>' : '<strong style="color:blue">' . $lang['NO_LOCATION'] . '</strong>',			'S_EXPLAIN'	=> false,			'S_LEGEND'	=> false,		));		// Check permissions on files/directories we need access to		$template->assign_block_vars('checks', array(			'S_LEGEND'			=> true,			'LEGEND'			=> $lang['FILES_REQUIRED'],			'LEGEND_EXPLAIN'	=> $lang['FILES_REQUIRED_EXPLAIN'],		));		$directories = array('cache/', 'files/', 'store/');		umask(0);		$passed['files'] = true;		foreach ($directories as $dir)		{			$exists = $write = false;			// Try to create the directory if it does not exist			if (!file_exists($phpbb_root_path . $dir))			{				@mkdir($phpbb_root_path . $dir, 0777);				phpbb_chmod($phpbb_root_path . $dir, CHMOD_READ | CHMOD_WRITE);			}			// Now really check			if (file_exists($phpbb_root_path . $dir) && is_dir($phpbb_root_path . $dir))			{				phpbb_chmod($phpbb_root_path . $dir, CHMOD_READ | CHMOD_WRITE);				$exists = true;			}			// Now check if it is writable by storing a simple file			$fp = @fopen($phpbb_root_path . $dir . 'test_lock', 'wb');			if ($fp !== false)			{				$write = true;			}			@fclose($fp);			@unlink($phpbb_root_path . $dir . 'test_lock');			$passed['files'] = ($exists && $write && $passed['files']) ? true : false;			$exists = ($exists) ? '<strong style="color:green">' . $lang['FOUND'] . '</strong>' : '<strong style="color:red">' . $lang['NOT_FOUND'] . '</strong>';			$write = ($write) ? ', <strong style="color:green">' . $lang['WRITABLE'] . '</strong>' : (($exists) ? ', <strong style="color:red">' . $lang['UNWRITABLE'] . '</strong>' : '');			$template->assign_block_vars('checks', array(				'TITLE'		=> $dir,				'RESULT'	=> $exists . $write,				'S_EXPLAIN'	=> false,				'S_LEGEND'	=> false,			));		}		// Check permissions on files/directories it would be useful access to		$template->assign_block_vars('checks', array(			'S_LEGEND'			=> true,			'LEGEND'			=> $lang['FILES_OPTIONAL'],			'LEGEND_EXPLAIN'	=> $lang['FILES_OPTIONAL_EXPLAIN'],		));		$directories = array('config.' . $phpEx, 'images/avatars/upload/');		foreach ($directories as $dir)		{			$write = $exists = true;			if (file_exists($phpbb_root_path . $dir))			{				if (!phpbb_is_writable($phpbb_root_path . $dir))				{					$write = false;				}			}			else			{				$write = $exists = false;			}			$exists_str = ($exists) ? '<strong style="color:green">' . $lang['FOUND'] . '</strong>' : '<strong style="color:red">' . $lang['NOT_FOUND'] . '</strong>';			$write_str = ($write) ? ', <strong style="color:green">' . $lang['WRITABLE'] . '</strong>' : (($exists) ? ', <strong style="color:red">' . $lang['UNWRITABLE'] . '</strong>' : '');			$template->assign_block_vars('checks', array(				'TITLE'		=> $dir,				'RESULT'	=> $exists_str . $write_str,				'S_EXPLAIN'	=> false,				'S_LEGEND'	=> false,			));		}		// And finally where do we want to go next (well today is taken isn't it :P)		$s_hidden_fields = ($img_imagick) ? '<input type="hidden" name="img_imagick" value="' . addslashes($img_imagick) . '" />' : '';		$url = (!in_array(false, $passed)) ? $this->p_master->module_url . "?mode=$mode&amp;sub=database&amp;language=$language" : $this->p_master->module_url . "?mode=$mode&amp;sub=requirements&amp;language=$language	";		$submit = (!in_array(false, $passed)) ? $lang['INSTALL_START'] : $lang['INSTALL_TEST'];		$template->assign_vars(array(			'L_SUBMIT'	=> $submit,			'S_HIDDEN'	=> $s_hidden_fields,			'U_ACTION'	=> $url,		));	}	/**	* Obtain the information required to connect to the database	*/	function obtain_database_settings($mode, $sub)	{		global $lang, $template, $phpEx;		$this->page_title = $lang['STAGE_DATABASE'];		// Obtain any submitted data		$data = $this->get_submitted_data();		$connect_test = false;		$error = array();		$available_dbms = get_available_dbms(false, true);		// Has the user opted to test the connection?		if (isset($_POST['testdb']))		{			if (!isset($available_dbms[$data['dbms']]) || !$available_dbms[$data['dbms']]['AVAILABLE'])			{				$error[] = $lang['INST_ERR_NO_DB'];				$connect_test = false;			}			else if (!preg_match(get_preg_expression('table_prefix'), $data['table_prefix']))			{				$error[] = $lang['INST_ERR_DB_INVALID_PREFIX'];				$connect_test = false;			}			else			{				$connect_test = connect_check_db(true, $error, $available_dbms[$data['dbms']], $data['table_prefix'], $data['dbhost'], $data['dbuser'], htmlspecialchars_decode($data['dbpasswd']), $data['dbname'], $data['dbport']);			}			$template->assign_block_vars('checks', array(				'S_LEGEND'			=> true,				'LEGEND'			=> $lang['DB_CONNECTION'],				'LEGEND_EXPLAIN'	=> false,			));			if ($connect_test)			{				$template->assign_block_vars('checks', array(					'TITLE'		=> $lang['DB_TEST'],					'RESULT'	=> '<strong style="color:green">' . $lang['SUCCESSFUL_CONNECT'] . '</strong>',					'S_EXPLAIN'	=> false,					'S_LEGEND'	=> false,				));			}			else			{				$template->assign_block_vars('checks', array(					'TITLE'		=> $lang['DB_TEST'],					'RESULT'	=> '<strong style="color:red">' . implode('<br />', $error) . '</strong>',					'S_EXPLAIN'	=> false,					'S_LEGEND'	=> false,				));			}		}		if (!$connect_test)		{			// Update the list of available DBMS modules to only contain those which can be used			$available_dbms_temp = array();			foreach ($available_dbms as $type => $dbms_ary)			{				if (!$dbms_ary['AVAILABLE'])				{					continue;				}				$available_dbms_temp[$type] = $dbms_ary;			}			$available_dbms = &$available_dbms_temp;			// And now for the main part of this page			$data['table_prefix'] = (!empty($data['table_prefix']) ? $data['table_prefix'] : 'phpbb_');			foreach ($this->db_config_options as $config_key => $vars)			{				if (!is_array($vars) && strpos($config_key, 'legend') === false)				{					continue;				}				if (strpos($config_key, 'legend') !== false)				{					$template->assign_block_vars('options', array(						'S_LEGEND'		=> true,						'LEGEND'		=> $lang[$vars])					);					continue;				}				$options = isset($vars['options']) ? $vars['options'] : '';				$template->assign_block_vars('options', array(					'KEY'			=> $config_key,					'TITLE'			=> $lang[$vars['lang']],					'S_EXPLAIN'		=> $vars['explain'],					'S_LEGEND'		=> false,					'TITLE_EXPLAIN'	=> ($vars['explain']) ? $lang[$vars['lang'] . '_EXPLAIN'] : '',					'CONTENT'		=> $this->p_master->input_field($config_key, $vars['type'], $data[$config_key], $options),					)				);			}		}		// And finally where do we want to go next (well today is taken isn't it :P)		$s_hidden_fields = ($data['img_imagick']) ? '<input type="hidden" name="img_imagick" value="' . addslashes($data['img_imagick']) . '" />' : '';		$s_hidden_fields .= '<input type="hidden" name="language" value="' . $data['language'] . '" />';		if ($connect_test)		{			foreach ($this->db_config_options as $config_key => $vars)			{				if (!is_array($vars))				{					continue;				}				$s_hidden_fields .= '<input type="hidden" name="' . $config_key . '" value="' . $data[$config_key] . '" />';			}		}		$url = ($connect_test) ? $this->p_master->module_url . "?mode=$mode&amp;sub=administrator" : $this->p_master->module_url . "?mode=$mode&amp;sub=database";		$s_hidden_fields .= ($connect_test) ? '' : '<input type="hidden" name="testdb" value="true" />';		$submit = $lang['NEXT_STEP'];		$template->assign_vars(array(			'L_SUBMIT'	=> $submit,			'S_HIDDEN'	=> $s_hidden_fields,			'U_ACTION'	=> $url,		));	}	/**	* Obtain the administrator's name, password and email address	*/	function obtain_admin_settings($mode, $sub)	{		global $lang, $template, $phpEx;		$this->page_title = $lang['STAGE_ADMINISTRATOR'];		// Obtain any submitted data		$data = $this->get_submitted_data();		if ($data['dbms'] == '')		{			// Someone's been silly and tried calling this page direct			// So we send them back to the start to do it again properly			$this->p_master->redirect("index.$phpEx?mode=install");		}		$s_hidden_fields = ($data['img_imagick']) ? '<input type="hidden" name="img_imagick" value="' . addslashes($data['img_imagick']) . '" />' : '';		$passed = false;		$data['default_lang'] = ($data['default_lang'] !== '') ? $data['default_lang'] : $data['language'];		if (isset($_POST['check']))		{			$error = array();			// Check the entered email address and password			if ($data['admin_name'] == '' || $data['admin_pass1'] == '' || $data['admin_pass2'] == '' || $data['board_email1'] == '' || $data['board_email2'] == '')			{				$error[] = $lang['INST_ERR_MISSING_DATA'];			}			if ($data['admin_pass1'] != $data['admin_pass2'] && $data['admin_pass1'] != '')			{				$error[] = $lang['INST_ERR_PASSWORD_MISMATCH'];			}			// Test against the default username rules			if ($data['admin_name'] != '' && utf8_strlen($data['admin_name']) < 3)			{				$error[] = $lang['INST_ERR_USER_TOO_SHORT'];			}			if ($data['admin_name'] != '' && utf8_strlen($data['admin_name']) > 20)			{				$error[] = $lang['INST_ERR_USER_TOO_LONG'];			}			// Test against the default password rules			if ($data['admin_pass1'] != '' && utf8_strlen($data['admin_pass1']) < 6)			{				$error[] = $lang['INST_ERR_PASSWORD_TOO_SHORT'];			}			if ($data['admin_pass1'] != '' && utf8_strlen($data['admin_pass1']) > 30)			{				$error[] = $lang['INST_ERR_PASSWORD_TOO_LONG'];			}			if ($data['board_email1'] != $data['board_email2'] && $data['board_email1'] != '')			{				$error[] = $lang['INST_ERR_EMAIL_MISMATCH'];			}			if ($data['board_email1'] != '' && !preg_match('/^' . get_preg_expression('email') . '$/i', $data['board_email1']))			{				$error[] = $lang['INST_ERR_EMAIL_INVALID'];			}			$template->assign_block_vars('checks', array(				'S_LEGEND'			=> true,				'LEGEND'			=> $lang['STAGE_ADMINISTRATOR'],				'LEGEND_EXPLAIN'	=> false,			));			if (!sizeof($error))			{				$passed = true;				$template->assign_block_vars('checks', array(					'TITLE'		=> $lang['ADMIN_TEST'],					'RESULT'	=> '<strong style="color:green">' . $lang['TESTS_PASSED'] . '</strong>',					'S_EXPLAIN'	=> false,					'S_LEGEND'	=> false,				));			}			else			{				$template->assign_block_vars('checks', array(					'TITLE'		=> $lang['ADMIN_TEST'],					'RESULT'	=> '<strong style="color:red">' . implode('<br />', $error) . '</strong>',					'S_EXPLAIN'	=> false,					'S_LEGEND'	=> false,				));			}		}		if (!$passed)		{			foreach ($this->admin_config_options as $config_key => $vars)			{				if (!is_array($vars) && strpos($config_key, 'legend') === false)				{					continue;				}				if (strpos($config_key, 'legend') !== false)				{					$template->assign_block_vars('options', array(						'S_LEGEND'		=> true,						'LEGEND'		=> $lang[$vars])					);					continue;				}				$options = isset($vars['options']) ? $vars['options'] : '';				$template->assign_block_vars('options', array(					'KEY'			=> $config_key,					'TITLE'			=> $lang[$vars['lang']],					'S_EXPLAIN'		=> $vars['explain'],					'S_LEGEND'		=> false,					'TITLE_EXPLAIN'	=> ($vars['explain']) ? $lang[$vars['lang'] . '_EXPLAIN'] : '',					'CONTENT'		=> $this->p_master->input_field($config_key, $vars['type'], $data[$config_key], $options),					)				);			}		}		else		{			foreach ($this->admin_config_options as $config_key => $vars)			{				if (!is_array($vars))				{					continue;				}				$s_hidden_fields .= '<input type="hidden" name="' . $config_key . '" value="' . $data[$config_key] . '" />';			}		}		$s_hidden_fields .= ($data['img_imagick']) ? '<input type="hidden" name="img_imagick" value="' . addslashes($data['img_imagick']) . '" />' : '';		$s_hidden_fields .= '<input type="hidden" name="language" value="' . $data['language'] . '" />';		foreach ($this->db_config_options as $config_key => $vars)		{			if (!is_array($vars))			{				continue;			}			$s_hidden_fields .= '<input type="hidden" name="' . $config_key . '" value="' . $data[$config_key] . '" />';		}		$submit = $lang['NEXT_STEP'];		$url = ($passed) ? $this->p_master->module_url . "?mode=$mode&amp;sub=config_file" : $this->p_master->module_url . "?mode=$mode&amp;sub=administrator";		$s_hidden_fields .= ($passed) ? '' : '<input type="hidden" name="check" value="true" />';		$template->assign_vars(array(			'L_SUBMIT'	=> $submit,			'S_HIDDEN'	=> $s_hidden_fields,			'U_ACTION'	=> $url,		));	}	/**	* Writes the config file to disk, or if unable to do so offers alternative methods	*/	function create_config_file($mode, $sub)	{		global $lang, $template, $phpbb_root_path, $phpEx;		$this->page_title = $lang['STAGE_CONFIG_FILE'];		// Obtain any submitted data		$data = $this->get_submitted_data();		if ($data['dbms'] == '')		{			// Someone's been silly and tried calling this page direct			// So we send them back to the start to do it again properly			$this->p_master->redirect("index.$phpEx?mode=install");		}		$s_hidden_fields = ($data['img_imagick']) ? '<input type="hidden" name="img_imagick" value="' . addslashes($data['img_imagick']) . '" />' : '';		$s_hidden_fields .= '<input type="hidden" name="language" value="' . $data['language'] . '" />';		$written = false;		// Create a list of any PHP modules we wish to have loaded		$load_extensions = array();		$available_dbms = get_available_dbms($data['dbms']);		$check_exts = array_merge(array($available_dbms[$data['dbms']]['MODULE']), $this->php_dlls_other);		foreach ($check_exts as $dll)		{			if (!@extension_loaded($dll))			{				if (!can_load_dll($dll))				{					continue;				}				$load_extensions[] = $dll . '.' . PHP_SHLIB_SUFFIX;			}		}		// Create a lock file to indicate that there is an install in progress		$fp = @fopen($phpbb_root_path . 'cache/install_lock', 'wb');		if ($fp === false)		{			// We were unable to create the lock file - abort			$this->p_master->error($lang['UNABLE_WRITE_LOCK'], __LINE__, __FILE__);		}		@fclose($fp);		@chmod($phpbb_root_path . 'cache/install_lock', 0777);		$load_extensions = implode(',', $load_extensions);		// Time to convert the data provided into a config file		$config_data = "<?php\n";		$config_data .= "// phpBB 3.0.x auto-generated configuration file\n// Do not change anything in this file!\n";		$config_data_array = array(			'dbms'			=> $available_dbms[$data['dbms']]['DRIVER'],			'dbhost'		=> $data['dbhost'],			'dbport'		=> $data['dbport'],			'dbname'		=> $data['dbname'],			'dbuser'		=> $data['dbuser'],			'dbpasswd'		=> htmlspecialchars_decode($data['dbpasswd']),			'table_prefix'	=> $data['table_prefix'],			'acm_type'		=> 'file',			'load_extensions'	=> $load_extensions,		);		foreach ($config_data_array as $key => $value)		{			$config_data .= "\${$key} = '" . str_replace("'", "\\'", str_replace('\\', '\\\\', $value)) . "';\n";		}		unset($config_data_array);		$config_data .= "\n@define('PHPBB_INSTALLED', true);\n";		$config_data .= "// @define('DEBUG', true);\n";		$config_data .= "// @define('DEBUG_EXTRA', true);\n";		$config_data .= '?' . '>'; // Done this to prevent highlighting editors getting confused!		// Attempt to write out the config file directly. If it works, this is the easiest way to do it ...		if ((file_exists($phpbb_root_path . 'config.' . $phpEx) && phpbb_is_writable($phpbb_root_path . 'config.' . $phpEx)) || phpbb_is_writable($phpbb_root_path))		{			// Assume it will work ... if nothing goes wrong below			$written = true;			if (!($fp = @fopen($phpbb_root_path . 'config.' . $phpEx, 'w')))			{				// Something went wrong ... so let's try another method				$written = false;			}			if (!(@fwrite($fp, $config_data)))			{				// Something went wrong ... so let's try another method				$written = false;			}			@fclose($fp);			if ($written)			{				// We may revert back to chmod() if we see problems with users not able to change their config.php file directly				phpbb_chmod($phpbb_root_path . 'config.' . $phpEx, CHMOD_READ);			}		}		if (isset($_POST['dldone']))		{			// Do a basic check to make sure that the file has been uploaded			// Note that all we check is that the file has _something_ in it			// We don't compare the contents exactly - if they can't upload			// a single file correctly, it's likely they will have other problems....			if (filesize($phpbb_root_path . 'config.' . $phpEx) > 10)			{				$written = true;			}		}		$config_options = array_merge($this->db_config_options, $this->admin_config_options);		foreach ($config_options as $config_key => $vars)		{			if (!is_array($vars))			{				continue;			}			$s_hidden_fields .= '<input type="hidden" name="' . $config_key . '" value="' . $data[$config_key] . '" />';		}		if (!$written)		{			// OK, so it didn't work let's try the alternatives			if (isset($_POST['dlconfig']))			{				// They want a copy of the file to download, so send the relevant headers and dump out the data				header("Content-Type: text/x-delimtext; name=\"config.$phpEx\"");				header("Content-disposition: attachment; filename=config.$phpEx");				echo $config_data;				exit;			}			// The option to download the config file is always available, so output it here			$template->assign_vars(array(				'BODY'					=> $lang['CONFIG_FILE_UNABLE_WRITE'],				'L_DL_CONFIG'			=> $lang['DL_CONFIG'],				'L_DL_CONFIG_EXPLAIN'	=> $lang['DL_CONFIG_EXPLAIN'],				'L_DL_DONE'				=> $lang['DONE'],				'L_DL_DOWNLOAD'			=> $lang['DL_DOWNLOAD'],				'S_HIDDEN'				=> $s_hidden_fields,				'S_SHOW_DOWNLOAD'		=> true,				'U_ACTION'				=> $this->p_master->module_url . "?mode=$mode&amp;sub=config_file",			));			return;		}		else		{			$template->assign_vars(array(				'BODY'		=> $lang['CONFIG_FILE_WRITTEN'],				'L_SUBMIT'	=> $lang['NEXT_STEP'],				'S_HIDDEN'	=> $s_hidden_fields,				'U_ACTION'	=> $this->p_master->module_url . "?mode=$mode&amp;sub=advanced",			));			return;		}	}	/**	* Provide an opportunity to customise some advanced settings during the install	* in case it is necessary for them to be set to access later	*/	function obtain_advanced_settings($mode, $sub)	{		global $lang, $template, $phpEx;		$this->page_title = $lang['STAGE_ADVANCED'];		// Obtain any submitted data		$data = $this->get_submitted_data();		if ($data['dbms'] == '')		{			// Someone's been silly and tried calling this page direct			// So we send them back to the start to do it again properly			$this->p_master->redirect("index.$phpEx?mode=install");		}		$s_hidden_fields = ($data['img_imagick']) ? '<input type="hidden" name="img_imagick" value="' . addslashes($data['img_imagick']) . '" />' : '';		$s_hidden_fields .= '<input type="hidden" name="language" value="' . $data['language'] . '" />';		// HTTP_HOST is having the correct browser url in most cases...		$server_name = (!empty($_SERVER['HTTP_HOST'])) ? strtolower($_SERVER['HTTP_HOST']) : ((!empty($_SERVER['SERVER_NAME'])) ? $_SERVER['SERVER_NAME'] : getenv('SERVER_NAME'));		// HTTP HOST can carry a port number...		if (strpos($server_name, ':') !== false)		{			$server_name = substr($server_name, 0, strpos($server_name, ':'));		}		$data['email_enable'] = ($data['email_enable'] !== '') ? $data['email_enable'] : true;		$data['server_name'] = ($data['server_name'] !== '') ? $data['server_name'] : $server_name;		$data['server_port'] = ($data['server_port'] !== '') ? $data['server_port'] : ((!empty($_SERVER['SERVER_PORT'])) ? (int) $_SERVER['SERVER_PORT'] : (int) getenv('SERVER_PORT'));		$data['server_protocol'] = ($data['server_protocol'] !== '') ? $data['server_protocol'] : ((isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? 'https://' : 'http://');		$data['cookie_secure'] = ($data['cookie_secure'] !== '') ? $data['cookie_secure'] : ((isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? true : false);		if ($data['script_path'] === '')		{			$name = (!empty($_SERVER['PHP_SELF'])) ? $_SERVER['PHP_SELF'] : getenv('PHP_SELF');			if (!$name)			{				$name = (!empty($_SERVER['REQUEST_URI'])) ? $_SERVER['REQUEST_URI'] : getenv('REQUEST_URI');			}			// Replace backslashes and doubled slashes (could happen on some proxy setups)			$name = str_replace(array('\\', '//', '/install'), '/', $name);			$data['script_path'] = trim(dirname($name));		}		foreach ($this->advanced_config_options as $config_key => $vars)		{			if (!is_array($vars) && strpos($config_key, 'legend') === false)			{				continue;			}			if (strpos($config_key, 'legend') !== false)			{				$template->assign_block_vars('options', array(					'S_LEGEND'		=> true,					'LEGEND'		=> $lang[$vars])				);				continue;			}			$options = isset($vars['options']) ? $vars['options'] : '';			$template->assign_block_vars('options', array(				'KEY'			=> $config_key,				'TITLE'			=> $lang[$vars['lang']],				'S_EXPLAIN'		=> $vars['explain'],				'S_LEGEND'		=> false,				'TITLE_EXPLAIN'	=> ($vars['explain']) ? $lang[$vars['lang'] . '_EXPLAIN'] : '',				'CONTENT'		=> $this->p_master->input_field($config_key, $vars['type'], $data[$config_key], $options),				)			);		}		$config_options = array_merge($this->db_config_options, $this->admin_config_options);		foreach ($config_options as $config_key => $vars)		{			if (!is_array($vars))			{				continue;			}			$s_hidden_fields .= '<input type="hidden" name="' . $config_key . '" value="' . $data[$config_key] . '" />';		}		$submit = $lang['NEXT_STEP'];		$url = $this->p_master->module_url . "?mode=$mode&amp;sub=create_table";		$template->assign_vars(array(			'BODY'		=> $lang['STAGE_ADVANCED_EXPLAIN'],			'L_SUBMIT'	=> $submit,			'S_HIDDEN'	=> $s_hidden_fields,			'U_ACTION'	=> $url,		));	}	/**	* Load the contents of the schema into the database and then alter it based on what has been input during the installation	*/	function load_schema($mode, $sub)	{		global $db, $lang, $template, $phpbb_root_path, $phpEx;		$this->page_title = $lang['STAGE_CREATE_TABLE'];		$s_hidden_fields = '';		// Obtain any submitted data		$data = $this->get_submitted_data();		if ($data['dbms'] == '')		{			// Someone's been silly and tried calling this page direct			// So we send them back to the start to do it again properly			$this->p_master->redirect("index.$phpEx?mode=install");		}		// HTTP_HOST is having the correct browser url in most cases...		$server_name = (!empty($_SERVER['HTTP_HOST'])) ? strtolower($_SERVER['HTTP_HOST']) : ((!empty($_SERVER['SERVER_NAME'])) ? $_SERVER['SERVER_NAME'] : getenv('SERVER_NAME'));		$referer = (!empty($_SERVER['HTTP_REFERER'])) ? strtolower($_SERVER['HTTP_REFERER']) : getenv('HTTP_REFERER');		// HTTP HOST can carry a port number...		if (strpos($server_name, ':') !== false)		{			$server_name = substr($server_name, 0, strpos($server_name, ':'));		}		$cookie_domain = ($data['server_name'] != '') ? $data['server_name'] : $server_name;		// Try to come up with the best solution for cookie domain...		if (strpos($cookie_domain, 'www.') === 0)		{			$cookie_domain = str_replace('www.', '.', $cookie_domain);		}		// If we get here and the extension isn't loaded it should be safe to just go ahead and load it		$available_dbms = get_available_dbms($data['dbms']);		if (!isset($available_dbms[$data['dbms']]))		{			// Someone's been silly and tried providing a non-existant dbms			$this->p_master->redirect("index.$phpEx?mode=install");		}		$dbms = $available_dbms[$data['dbms']]['DRIVER'];		// Load the appropriate database class if not already loaded		include($phpbb_root_path . 'includes/db/' . $dbms . '.' . $phpEx);		// Instantiate the database		$db = new $sql_db();		$db->sql_connect($data['dbhost'], $data['dbuser'], htmlspecialchars_decode($data['dbpasswd']), $data['dbname'], $data['dbport'], false, false);		// NOTE: trigger_error does not work here.		$db->sql_return_on_error(true);		// If mysql is chosen, we need to adjust the schema filename slightly to reflect the correct version. ;)		if ($data['dbms'] == 'mysql')		{			if (version_compare($db->sql_server_info(true), '4.1.3', '>='))			{				$available_dbms[$data['dbms']]['SCHEMA'] .= '_41';			}			else			{				$available_dbms[$data['dbms']]['SCHEMA'] .= '_40';			}		}		// Ok we have the db info go ahead and read in the relevant schema		// and work on building the table		$dbms_schema = 'schemas/' . $available_dbms[$data['dbms']]['SCHEMA'] . '_schema.sql';		// How should we treat this schema?		$remove_remarks = $available_dbms[$data['dbms']]['COMMENTS'];		$delimiter = $available_dbms[$data['dbms']]['DELIM'];		$sql_query = @file_get_contents($dbms_schema);		$sql_query = preg_replace('#phpbb_#i', $data['table_prefix'], $sql_query);		$remove_remarks($sql_query);		$sql_query = split_sql_file($sql_query, $delimiter);		foreach ($sql_query as $sql)		{			//$sql = trim(str_replace('|', ';', $sql));			if (!$db->sql_query($sql))			{				$error = $db->sql_error();				$this->p_master->db_error($error['message'], $sql, __LINE__, __FILE__);			}		}		unset($sql_query);		// Ok tables have been built, let's fill in the basic information		$sql_query = file_get_contents('schemas/schema_data.sql');		// Deal with any special comments		switch ($data['dbms'])		{			case 'mssql':			case 'mssql_odbc':			case 'mssqlnative':				$sql_query = preg_replace('#\# MSSQL IDENTITY (phpbb_[a-z_]+) (ON|OFF) \##s', 'SET IDENTITY_INSERT \1 \2;', $sql_query);			break;			case 'postgres':				$sql_query = preg_replace('#\# POSTGRES (BEGIN|COMMIT) \##s', '\1; ', $sql_query);			break;		}		// Change prefix		$sql_query = preg_replace('# phpbb_([^\s]*) #i', ' ' . $data['table_prefix'] . '\1 ', $sql_query);		// Change language strings...		$sql_query = preg_replace_callback('#\{L_([A-Z0-9\-_]*)\}#s', 'adjust_language_keys_callback', $sql_query);		// Since there is only one schema file we know the comment style and are able to remove it directly with remove_remarks		remove_remarks($sql_query);		$sql_query = split_sql_file($sql_query, ';');		foreach ($sql_query as $sql)		{			//$sql = trim(str_replace('|', ';', $sql));			if (!$db->sql_query($sql))			{				$error = $db->sql_error();				$this->p_master->db_error($error['message'], $sql, __LINE__, __FILE__);			}		}		unset($sql_query);		$current_time = time();		$user_ip = (!empty($_SERVER['REMOTE_ADDR'])) ? htmlspecialchars($_SERVER['REMOTE_ADDR']) : '';		$user_ip = (stripos($user_ip, '::ffff:') === 0) ? substr($user_ip, 7) : $user_ip;		if ($data['script_path'] !== '/')		{			// Adjust destination path (no trailing slash)			if (substr($data['script_path'], -1) == '/')			{				$data['script_path'] = substr($data['script_path'], 0, -1);			}			$data['script_path'] = str_replace(array('../', './'), '', $data['script_path']);			if ($data['script_path'][0] != '/')			{				$data['script_path'] = '/' . $data['script_path'];			}		}		// Set default config and post data, this applies to all DB's		$sql_ary = array(			'INSERT INTO ' . $data['table_prefix'] . "config (config_name, config_value)				VALUES ('board_startdate', '$current_time')",			'INSERT INTO ' . $data['table_prefix'] . "config (config_name, config_value)				VALUES ('default_lang', '" . $db->sql_escape($data['default_lang']) . "')",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['img_imagick']) . "'				WHERE config_name = 'img_imagick'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['server_name']) . "'				WHERE config_name = 'server_name'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['server_port']) . "'				WHERE config_name = 'server_port'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['board_email1']) . "'				WHERE config_name = 'board_email'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['board_email1']) . "'				WHERE config_name = 'board_contact'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($cookie_domain) . "'				WHERE config_name = 'cookie_domain'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($lang['default_dateformat']) . "'				WHERE config_name = 'default_dateformat'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['email_enable']) . "'				WHERE config_name = 'email_enable'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['smtp_delivery']) . "'				WHERE config_name = 'smtp_delivery'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['smtp_host']) . "'				WHERE config_name = 'smtp_host'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['smtp_auth']) . "'				WHERE config_name = 'smtp_auth_method'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['smtp_user']) . "'				WHERE config_name = 'smtp_username'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['smtp_pass']) . "'				WHERE config_name = 'smtp_password'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['cookie_secure']) . "'				WHERE config_name = 'cookie_secure'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['force_server_vars']) . "'				WHERE config_name = 'force_server_vars'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['script_path']) . "'				WHERE config_name = 'script_path'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['server_protocol']) . "'				WHERE config_name = 'server_protocol'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($data['admin_name']) . "'				WHERE config_name = 'newest_username'",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . md5(mt_rand()) . "'				WHERE config_name = 'avatar_salt'",			'UPDATE ' . $data['table_prefix'] . "users				SET username = '" . $db->sql_escape($data['admin_name']) . "', user_password='" . $db->sql_escape(md5($data['admin_pass1'])) . "', user_ip = '" . $db->sql_escape($user_ip) . "', user_lang = '" . $db->sql_escape($data['default_lang']) . "', user_email='" . $db->sql_escape($data['board_email1']) . "', user_dateformat='" . $db->sql_escape($lang['default_dateformat']) . "', user_email_hash = " . $db->sql_escape(phpbb_email_hash($data['board_email1'])) . ", username_clean = '" . $db->sql_escape(utf8_clean_string($data['admin_name'])) . "'				WHERE username = 'Admin'",			'UPDATE ' . $data['table_prefix'] . "moderator_cache				SET username = '" . $db->sql_escape($data['admin_name']) . "'				WHERE username = 'Admin'",			'UPDATE ' . $data['table_prefix'] . "forums				SET forum_last_poster_name = '" . $db->sql_escape($data['admin_name']) . "'				WHERE forum_last_poster_name = 'Admin'",			'UPDATE ' . $data['table_prefix'] . "topics				SET topic_first_poster_name = '" . $db->sql_escape($data['admin_name']) . "', topic_last_poster_name = '" . $db->sql_escape($data['admin_name']) . "'				WHERE topic_first_poster_name = 'Admin'					OR topic_last_poster_name = 'Admin'",			'UPDATE ' . $data['table_prefix'] . "users				SET user_regdate = $current_time",			'UPDATE ' . $data['table_prefix'] . "posts				SET post_time = $current_time, poster_ip = '" . $db->sql_escape($user_ip) . "'",			'UPDATE ' . $data['table_prefix'] . "topics				SET topic_time = $current_time, topic_last_post_time = $current_time",			'UPDATE ' . $data['table_prefix'] . "forums				SET forum_last_post_time = $current_time",			'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '" . $db->sql_escape($db->sql_server_info(true)) . "'				WHERE config_name = 'dbms_version'",		);		if (@extension_loaded('gd') || can_load_dll('gd'))		{			$sql_ary[] = 'UPDATE ' . $data['table_prefix'] . "config				SET config_value = 'phpbb_captcha_gd'				WHERE config_name = 'captcha_plugin'";			$sql_ary[] = 'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '1'				WHERE config_name = 'captcha_gd'";		}		$ref = substr($referer, strpos($referer, '://') + 3);		if (!(stripos($ref, $server_name) === 0))		{			$sql_ary[] = 'UPDATE ' . $data['table_prefix'] . "config				SET config_value = '0'				WHERE config_name = 'referer_validation'";		}		// We set a (semi-)unique cookie name to bypass login issues related to the cookie name.		$cookie_name = 'phpbb3_';		$rand_str = md5(mt_rand());		$rand_str = str_replace('0', 'z', base_convert($rand_str, 16, 35));		$rand_str = substr($rand_str, 0, 5);		$cookie_name .= strtolower($rand_str);		$sql_ary[] = 'UPDATE ' . $data['table_prefix'] . "config			SET config_value = '" . $db->sql_escape($cookie_name) . "'			WHERE config_name = 'cookie_name'";		foreach ($sql_ary as $sql)		{			//$sql = trim(str_replace('|', ';', $sql));			if (!$db->sql_query($sql))			{				$error = $db->sql_error();				$this->p_master->db_error($error['message'], $sql, __LINE__, __FILE__);			}		}		$submit = $lang['NEXT_STEP'];		$url = $this->p_master->module_url . "?mode=$mode&amp;sub=final";		$template->assign_vars(array(			'BODY'		=> $lang['STAGE_CREATE_TABLE_EXPLAIN'],			'L_SUBMIT'	=> $submit,			'S_HIDDEN'	=> build_hidden_fields($data),			'U_ACTION'	=> $url,		));	}	/**	* Build the search index...	*/	function build_search_index($mode, $sub)	{		global $db, $lang, $phpbb_root_path, $phpEx, $config;		// Obtain any submitted data		$data = $this->get_submitted_data();		$table_prefix = $data['table_prefix'];		// If we get here and the extension isn't loaded it should be safe to just go ahead and load it		$available_dbms = get_available_dbms($data['dbms']);		if (!isset($available_dbms[$data['dbms']]))		{			// Someone's been silly and tried providing a non-existant dbms			$this->p_master->redirect("index.$phpEx?mode=install");		}		$dbms = $available_dbms[$data['dbms']]['DRIVER'];		// Load the appropriate database class if not already loaded		include($phpbb_root_path . 'includes/db/' . $dbms . '.' . $phpEx);		// Instantiate the database		$db = new $sql_db();		$db->sql_connect($data['dbhost'], $data['dbuser'], htmlspecialchars_decode($data['dbpasswd']), $data['dbname'], $data['dbport'], false, false);		// NOTE: trigger_error does not work here.		$db->sql_return_on_error(true);		include_once($phpbb_root_path . 'includes/constants.' . $phpEx);		include_once($phpbb_root_path . 'includes/search/fulltext_native.' . $phpEx);		// Fill the config array - it is needed by those functions we call		$sql = 'SELECT *			FROM ' . CONFIG_TABLE;		$result = $db->sql_query($sql);		$config = array();		while ($row = $db->sql_fetchrow($result))		{			$config[$row['config_name']] = $row['config_value'];		}		$db->sql_freeresult($result);		$error = false;		$search = new fulltext_native($error);		$sql = 'SELECT post_id, post_subject, post_text, poster_id, forum_id			FROM ' . POSTS_TABLE;		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$search->index('post', $row['post_id'], $row['post_text'], $row['post_subject'], $row['poster_id'], $row['forum_id']);		}		$db->sql_freeresult($result);	}	/**	* Populate the module tables	*/	function add_modules($mode, $sub)	{		global $db, $lang, $phpbb_root_path, $phpEx;		include_once($phpbb_root_path . 'includes/acp/acp_modules.' . $phpEx);		$_module = new acp_modules();		$module_classes = array('acp', 'mcp', 'ucp');		// Add categories		foreach ($module_classes as $module_class)		{			$categories = array();			// Set the module class			$_module->module_class = $module_class;			foreach ($this->module_categories[$module_class] as $cat_name => $subs)			{				$module_data = array(					'module_basename'	=> '',					'module_enabled'	=> 1,					'module_display'	=> 1,					'parent_id'			=> 0,					'module_class'		=> $module_class,					'module_langname'	=> $cat_name,					'module_mode'		=> '',					'module_auth'		=> '',				);				// Add category				$_module->update_module_data($module_data, true);				// Check for last sql error happened				if ($db->sql_error_triggered)				{					$error = $db->sql_error($db->sql_error_sql);					$this->p_master->db_error($error['message'], $db->sql_error_sql, __LINE__, __FILE__);				}				$categories[$cat_name]['id'] = (int) $module_data['module_id'];				$categories[$cat_name]['parent_id'] = 0;				// Create sub-categories...				if (is_array($subs))				{					foreach ($subs as $level2_name)					{						$module_data = array(							'module_basename'	=> '',							'module_enabled'	=> 1,							'module_display'	=> 1,							'parent_id'			=> (int) $categories[$cat_name]['id'],							'module_class'		=> $module_class,							'module_langname'	=> $level2_name,							'module_mode'		=> '',							'module_auth'		=> '',						);						$_module->update_module_data($module_data, true);						// Check for last sql error happened						if ($db->sql_error_triggered)						{							$error = $db->sql_error($db->sql_error_sql);							$this->p_master->db_error($error['message'], $db->sql_error_sql, __LINE__, __FILE__);						}						$categories[$level2_name]['id'] = (int) $module_data['module_id'];						$categories[$level2_name]['parent_id'] = (int) $categories[$cat_name]['id'];					}				}			}			// Get the modules we want to add... returned sorted by name			$module_info = $_module->get_module_infos('', $module_class);			foreach ($module_info as $module_basename => $fileinfo)			{				foreach ($fileinfo['modes'] as $module_mode => $row)				{					foreach ($row['cat'] as $cat_name)					{						if (!isset($categories[$cat_name]))						{							continue;						}						$module_data = array(							'module_basename'	=> $module_basename,							'module_enabled'	=> 1,							'module_display'	=> (isset($row['display'])) ? (int) $row['display'] : 1,							'parent_id'			=> (int) $categories[$cat_name]['id'],							'module_class'		=> $module_class,							'module_langname'	=> $row['title'],							'module_mode'		=> $module_mode,							'module_auth'		=> $row['auth'],						);						$_module->update_module_data($module_data, true);						// Check for last sql error happened						if ($db->sql_error_triggered)						{							$error = $db->sql_error($db->sql_error_sql);							$this->p_master->db_error($error['message'], $db->sql_error_sql, __LINE__, __FILE__);						}					}				}			}			// Move some of the modules around since the code above will put them in the wrong place			if ($module_class == 'acp')			{				// Move main module 4 up...				$sql = 'SELECT *					FROM ' . MODULES_TABLE . "					WHERE module_basename = 'main'						AND module_class = 'acp'						AND module_mode = 'main'";				$result = $db->sql_query($sql);				$row = $db->sql_fetchrow($result);				$db->sql_freeresult($result);				$_module->move_module_by($row, 'move_up', 4);				// Move permissions intro screen module 4 up...				$sql = 'SELECT *					FROM ' . MODULES_TABLE . "					WHERE module_basename = 'permissions'						AND module_class = 'acp'						AND module_mode = 'intro'";				$result = $db->sql_query($sql);				$row = $db->sql_fetchrow($result);				$db->sql_freeresult($result);				$_module->move_module_by($row, 'move_up', 4);				// Move manage users screen module 5 up...				$sql = 'SELECT *					FROM ' . MODULES_TABLE . "					WHERE module_basename = 'users'						AND module_class = 'acp'						AND module_mode = 'overview'";				$result = $db->sql_query($sql);				$row = $db->sql_fetchrow($result);				$db->sql_freeresult($result);				$_module->move_module_by($row, 'move_up', 5);			}			if ($module_class == 'ucp')			{				// Move attachment module 4 down...				$sql = 'SELECT *					FROM ' . MODULES_TABLE . "					WHERE module_basename = 'attachments'						AND module_class = 'ucp'						AND module_mode = 'attachments'";				$result = $db->sql_query($sql);				$row = $db->sql_fetchrow($result);				$db->sql_freeresult($result);				$_module->move_module_by($row, 'move_down', 4);			}			// And now for the special ones			// (these are modules which appear in multiple categories and thus get added manually to some for more control)			if (isset($this->module_extras[$module_class]))			{				foreach ($this->module_extras[$module_class] as $cat_name => $mods)				{					$sql = 'SELECT module_id, left_id, right_id						FROM ' . MODULES_TABLE . "						WHERE module_langname = '" . $db->sql_escape($cat_name) . "'							AND module_class = '" . $db->sql_escape($module_class) . "'";					$result = $db->sql_query_limit($sql, 1);					$row2 = $db->sql_fetchrow($result);					$db->sql_freeresult($result);					foreach ($mods as $mod_name)					{						$sql = 'SELECT *							FROM ' . MODULES_TABLE . "							WHERE module_langname = '" . $db->sql_escape($mod_name) . "'								AND module_class = '" . $db->sql_escape($module_class) . "'								AND module_basename <> ''";						$result = $db->sql_query_limit($sql, 1);						$row = $db->sql_fetchrow($result);						$db->sql_freeresult($result);						$module_data = array(							'module_basename'	=> $row['module_basename'],							'module_enabled'	=> (int) $row['module_enabled'],							'module_display'	=> (int) $row['module_display'],							'parent_id'			=> (int) $row2['module_id'],							'module_class'		=> $row['module_class'],							'module_langname'	=> $row['module_langname'],							'module_mode'		=> $row['module_mode'],							'module_auth'		=> $row['module_auth'],						);						$_module->update_module_data($module_data, true);						// Check for last sql error happened						if ($db->sql_error_triggered)						{							$error = $db->sql_error($db->sql_error_sql);							$this->p_master->db_error($error['message'], $db->sql_error_sql, __LINE__, __FILE__);						}					}				}			}			$_module->remove_cache_file();		}	}	/**	* Populate the language tables	*/	function add_language($mode, $sub)	{		global $db, $lang, $phpbb_root_path, $phpEx;		$dir = @opendir($phpbb_root_path . 'language');		if (!$dir)		{			$this->error('Unable to access the language directory', __LINE__, __FILE__);		}		while (($file = readdir($dir)) !== false)		{			$path = $phpbb_root_path . 'language/' . $file;			if ($file == '.' || $file == '..' || is_link($path) || is_file($path) || $file == 'CVS')			{				continue;			}			if (is_dir($path) && file_exists($path . '/iso.txt'))			{				$lang_file = file("$path/iso.txt");				$lang_pack = array(					'lang_iso'			=> basename($path),					'lang_dir'			=> basename($path),					'lang_english_name'	=> trim(htmlspecialchars($lang_file[0])),					'lang_local_name'	=> trim(htmlspecialchars($lang_file[1], ENT_COMPAT, 'UTF-8')),					'lang_author'		=> trim(htmlspecialchars($lang_file[2], ENT_COMPAT, 'UTF-8')),				);				$db->sql_query('INSERT INTO ' . LANG_TABLE . ' ' . $db->sql_build_array('INSERT', $lang_pack));				if ($db->sql_error_triggered)				{					$error = $db->sql_error($db->sql_error_sql);					$this->p_master->db_error($error['message'], $db->sql_error_sql, __LINE__, __FILE__);				}				$valid_localized = array(					'icon_back_top', 'icon_contact_aim', 'icon_contact_email', 'icon_contact_icq', 'icon_contact_jabber', 'icon_contact_msnm', 'icon_contact_pm', 'icon_contact_yahoo', 'icon_contact_www', 'icon_post_delete', 'icon_post_edit', 'icon_post_info', 'icon_post_quote', 'icon_post_report', 'icon_user_online', 'icon_user_offline', 'icon_user_profile', 'icon_user_search', 'icon_user_warn', 'button_pm_forward', 'button_pm_new', 'button_pm_reply', 'button_topic_locked', 'button_topic_new', 'button_topic_reply',				);				$sql_ary = array();				$sql = 'SELECT *					FROM ' . STYLES_IMAGESET_TABLE;				$result = $db->sql_query($sql);				while ($imageset_row = $db->sql_fetchrow($result))				{					if (@file_exists("{$phpbb_root_path}styles/{$imageset_row['imageset_path']}/imageset/{$lang_pack['lang_iso']}/imageset.cfg"))					{						$cfg_data_imageset_data = parse_cfg_file("{$phpbb_root_path}styles/{$imageset_row['imageset_path']}/imageset/{$lang_pack['lang_iso']}/imageset.cfg");						foreach ($cfg_data_imageset_data as $image_name => $value)						{							if (strpos($value, '*') !== false)							{								if (substr($value, -1, 1) === '*')								{									list($image_filename, $image_height) = explode('*', $value);									$image_width = 0;								}								else								{									list($image_filename, $image_height, $image_width) = explode('*', $value);								}							}							else							{								$image_filename = $value;								$image_height = $image_width = 0;							}							if (strpos($image_name, 'img_') === 0 && $image_filename)							{								$image_name = substr($image_name, 4);								if (in_array($image_name, $valid_localized))								{									$sql_ary[] = array(										'image_name'		=> (string) $image_name,										'image_filename'	=> (string) $image_filename,										'image_height'		=> (int) $image_height,										'image_width'		=> (int) $image_width,										'imageset_id'		=> (int) $imageset_row['imageset_id'],										'image_lang'		=> (string) $lang_pack['lang_iso'],									);								}							}						}					}				}				$db->sql_freeresult($result);				if (sizeof($sql_ary))				{					$db->sql_multi_insert(STYLES_IMAGESET_DATA_TABLE, $sql_ary);					if ($db->sql_error_triggered)					{						$error = $db->sql_error($db->sql_error_sql);						$this->p_master->db_error($error['message'], $db->sql_error_sql, __LINE__, __FILE__);					}				}			}		}		closedir($dir);	}	/**	* Add search robots to the database	*/	function add_bots($mode, $sub)	{		global $db, $lang, $phpbb_root_path, $phpEx, $config;		// Obtain any submitted data		$data = $this->get_submitted_data();		// Fill the config array - it is needed by those functions we call		$sql = 'SELECT *			FROM ' . CONFIG_TABLE;		$result = $db->sql_query($sql);		$config = array();		while ($row = $db->sql_fetchrow($result))		{			$config[$row['config_name']] = $row['config_value'];		}		$db->sql_freeresult($result);		$sql = 'SELECT group_id			FROM ' . GROUPS_TABLE . "			WHERE group_name = 'BOTS'";		$result = $db->sql_query($sql);		$group_id = (int) $db->sql_fetchfield('group_id');		$db->sql_freeresult($result);		if (!$group_id)		{			// If we reach this point then something has gone very wrong			$this->p_master->error($lang['NO_GROUP'], __LINE__, __FILE__);		}		if (!function_exists('user_add'))		{			include($phpbb_root_path . 'includes/functions_user.' . $phpEx);		}		foreach ($this->bot_list as $bot_name => $bot_ary)		{			$user_row = array(				'user_type'				=> USER_IGNORE,				'group_id'				=> $group_id,				'username'				=> $bot_name,				'user_regdate'			=> time(),				'user_password'			=> '',				'user_colour'			=> '9E8DA7',				'user_email'			=> '',				'user_lang'				=> $data['default_lang'],				'user_style'			=> 1,				'user_timezone'			=> 0,				'user_dateformat'		=> $lang['default_dateformat'],				'user_allow_massemail'	=> 0,			);			$user_id = user_add($user_row);			if (!$user_id)			{				// If we can't insert this user then continue to the next one to avoid inconsistent data				$this->p_master->db_error('Unable to insert bot into users table', $db->sql_error_sql, __LINE__, __FILE__, true);				continue;			}			$sql = 'INSERT INTO ' . BOTS_TABLE . ' ' . $db->sql_build_array('INSERT', array(				'bot_active'	=> 1,				'bot_name'		=> (string) $bot_name,				'user_id'		=> (int) $user_id,				'bot_agent'		=> (string) $bot_ary[0],				'bot_ip'		=> (string) $bot_ary[1],			));			$result = $db->sql_query($sql);		}	}	/**	* Sends an email to the board administrator with their password and some useful links	*/	function email_admin($mode, $sub)	{		global $auth, $config, $db, $lang, $template, $user, $phpbb_root_path, $phpEx;		$this->page_title = $lang['STAGE_FINAL'];		// Obtain any submitted data		$data = $this->get_submitted_data();		$sql = 'SELECT *			FROM ' . CONFIG_TABLE;		$result = $db->sql_query($sql);		$config = array();		while ($row = $db->sql_fetchrow($result))		{			$config[$row['config_name']] = $row['config_value'];		}		$db->sql_freeresult($result);		$user->session_begin();		$auth->login($data['admin_name'], $data['admin_pass1'], false, true, true);		// OK, Now that we've reached this point we can be confident that everything		// is installed and working......I hope :)		// So it's time to send an email to the administrator confirming the details		// they entered		if ($config['email_enable'])		{			include_once($phpbb_root_path . 'includes/functions_messenger.' . $phpEx);			$messenger = new messenger(false);			$messenger->template('installed', $data['language']);			$messenger->to($data['board_email1'], $data['admin_name']);			$messenger->anti_abuse_headers($config, $user);			$messenger->assign_vars(array(				'USERNAME'		=> htmlspecialchars_decode($data['admin_name']),				'PASSWORD'		=> htmlspecialchars_decode($data['admin_pass1']))			);			$messenger->send(NOTIFY_EMAIL);		}		// And finally, add a note to the log		add_log('admin', 'LOG_INSTALL_INSTALLED', $config['version']);		$template->assign_vars(array(			'TITLE'		=> $lang['INSTALL_CONGRATS'],			'BODY'		=> sprintf($lang['INSTALL_CONGRATS_EXPLAIN'], $config['version'], append_sid($phpbb_root_path . 'install/index.' . $phpEx, 'mode=convert&amp;language=' . $data['language']), '../docs/README.html'),			'L_SUBMIT'	=> $lang['INSTALL_LOGIN'],			'U_ACTION'	=> append_sid($phpbb_root_path . 'adm/index.' . $phpEx, 'i=send_statistics&amp;mode=send_statistics'),		));	}	/**	* Generate a list of available mail server authentication methods	*/	function mail_auth_select($selected_method)	{		global $lang;		$auth_methods = array('PLAIN', 'LOGIN', 'CRAM-MD5', 'DIGEST-MD5', 'POP-BEFORE-SMTP');		$s_smtp_auth_options = '';		foreach ($auth_methods as $method)		{			$s_smtp_auth_options .= '<option value="' . $method . '"' . (($selected_method == $method) ? ' selected="selected"' : '') . '>' . $lang['SMTP_' . str_replace('-', '_', $method)] . '</option>';		}		return $s_smtp_auth_options;	}	/**	* Get submitted data	*/	function get_submitted_data()	{		return array(			'language'		=> basename(request_var('language', '')),			'dbms'			=> request_var('dbms', ''),			'dbhost'		=> request_var('dbhost', ''),			'dbport'		=> request_var('dbport', ''),			'dbuser'		=> request_var('dbuser', ''),			'dbpasswd'		=> request_var('dbpasswd', '', true),			'dbname'		=> request_var('dbname', ''),			'table_prefix'	=> request_var('table_prefix', ''),			'default_lang'	=> basename(request_var('default_lang', '')),			'admin_name'	=> utf8_normalize_nfc(request_var('admin_name', '', true)),			'admin_pass1'	=> request_var('admin_pass1', '', true),			'admin_pass2'	=> request_var('admin_pass2', '', true),			'board_email1'	=> strtolower(request_var('board_email1', '')),			'board_email2'	=> strtolower(request_var('board_email2', '')),			'img_imagick'	=> request_var('img_imagick', ''),			'ftp_path'		=> request_var('ftp_path', ''),			'ftp_user'		=> request_var('ftp_user', ''),			'ftp_pass'		=> request_var('ftp_pass', ''),			'email_enable'	=> request_var('email_enable', ''),			'smtp_delivery'	=> request_var('smtp_delivery', ''),			'smtp_host'		=> request_var('smtp_host', ''),			'smtp_auth'		=> request_var('smtp_auth', ''),			'smtp_user'		=> request_var('smtp_user', ''),			'smtp_pass'		=> request_var('smtp_pass', ''),			'cookie_secure'	=> request_var('cookie_secure', ''),			'force_server_vars'	=> request_var('force_server_vars', ''),			'server_protocol'	=> request_var('server_protocol', ''),			'server_name'	=> request_var('server_name', ''),			'server_port'	=> request_var('server_port', ''),			'script_path'	=> request_var('script_path', ''),		);	}	/**	* The information below will be used to build the input fields presented to the user	*/	var $db_config_options = array(		'legend1'				=> 'DB_CONFIG',		'dbms'					=> array('lang' => 'DBMS',			'type' => 'select', 'options' => 'dbms_select(\'{VALUE}\')', 'explain' => false),		'dbhost'				=> array('lang' => 'DB_HOST',		'type' => 'text:25:100', 'explain' => true),		'dbport'				=> array('lang' => 'DB_PORT',		'type' => 'text:25:100', 'explain' => true),		'dbname'				=> array('lang' => 'DB_NAME',		'type' => 'text:25:100', 'explain' => false),		'dbuser'				=> array('lang' => 'DB_USERNAME',	'type' => 'text:25:100', 'explain' => false),		'dbpasswd'				=> array('lang' => 'DB_PASSWORD',	'type' => 'password:25:100', 'explain' => false),		'table_prefix'			=> array('lang' => 'TABLE_PREFIX',	'type' => 'text:25:100', 'explain' => true),	);	var $admin_config_options = array(		'legend1'				=> 'ADMIN_CONFIG',		'default_lang'			=> array('lang' => 'DEFAULT_LANG',				'type' => 'select', 'options' => '$this->module->inst_language_select(\'{VALUE}\')', 'explain' => false),		'admin_name'			=> array('lang' => 'ADMIN_USERNAME',			'type' => 'text:25:100', 'explain' => true),		'admin_pass1'			=> array('lang' => 'ADMIN_PASSWORD',			'type' => 'password:25:100', 'explain' => true),		'admin_pass2'			=> array('lang' => 'ADMIN_PASSWORD_CONFIRM',	'type' => 'password:25:100', 'explain' => false),		'board_email1'			=> array('lang' => 'CONTACT_EMAIL',				'type' => 'text:25:100', 'explain' => false),		'board_email2'			=> array('lang' => 'CONTACT_EMAIL_CONFIRM',		'type' => 'text:25:100', 'explain' => false),	);	var $advanced_config_options = array(		'legend1'				=> 'ACP_EMAIL_SETTINGS',		'email_enable'			=> array('lang' => 'ENABLE_EMAIL',		'type' => 'radio:enabled_disabled', 'explain' => true),		'smtp_delivery'			=> array('lang' => 'USE_SMTP',			'type' => 'radio:yes_no', 'explain' => true),		'smtp_host'				=> array('lang' => 'SMTP_SERVER',		'type' => 'text:25:50', 'explain' => false),		'smtp_auth'				=> array('lang' => 'SMTP_AUTH_METHOD',	'type' => 'select', 'options' => '$this->module->mail_auth_select(\'{VALUE}\')', 'explain' => true),		'smtp_user'				=> array('lang' => 'SMTP_USERNAME',		'type' => 'text:25:255', 'explain' => true),		'smtp_pass'				=> array('lang' => 'SMTP_PASSWORD',		'type' => 'password:25:255', 'explain' => true),		'legend2'				=> 'SERVER_URL_SETTINGS',		'cookie_secure'			=> array('lang' => 'COOKIE_SECURE',		'type' => 'radio:enabled_disabled', 'explain' => true),		'force_server_vars'		=> array('lang' => 'FORCE_SERVER_VARS',	'type' => 'radio:yes_no', 'explain' => true),		'server_protocol'		=> array('lang' => 'SERVER_PROTOCOL',	'type' => 'text:10:10', 'explain' => true),		'server_name'			=> array('lang' => 'SERVER_NAME',		'type' => 'text:40:255', 'explain' => true),		'server_port'			=> array('lang' => 'SERVER_PORT',		'type' => 'text:5:5', 'explain' => true),		'script_path'			=> array('lang' => 'SCRIPT_PATH',		'type' => 'text::255', 'explain' => true),	);	/**	* Specific PHP modules we may require for certain optional or extended features	*/	var $php_dlls_other = array('zlib', 'ftp', 'gd', 'xml');	/**	* A list of the web-crawlers/bots we recognise by default	*	* Candidates but not included:	* 'Accoona [Bot]'				'Accoona-AI-Agent/'	* 'ASPseek [Crawler]'			'ASPseek/'	* 'Boitho [Crawler]'			'boitho.com-dc/'	* 'Bunnybot [Bot]'				'powered by www.buncat.de'	* 'Cosmix [Bot]'				'cfetch/'	* 'Crawler Search [Crawler]'	'.Crawler-Search.de'	* 'Findexa [Crawler]'			'Findexa Crawler ('	* 'GBSpider [Spider]'			'GBSpider v'	* 'genie [Bot]'					'genieBot ('	* 'Hogsearch [Bot]'				'oegp v. 1.3.0'	* 'Insuranco [Bot]'				'InsurancoBot'	* 'IRLbot [Bot]'				'http://irl.cs.tamu.edu/crawler'	* 'ISC Systems [Bot]'			'ISC Systems iRc Search'	* 'Jyxobot [Bot]'				'Jyxobot/'	* 'Kraehe [Metasuche]'			'-DIE-KRAEHE- META-SEARCH-ENGINE/'	* 'LinkWalker'					'LinkWalker'	* 'MMSBot [Bot]'				'http://www.mmsweb.at/bot.html'	* 'Naver [Bot]'					'nhnbot@naver.com)'	* 'NetResearchServer'			'NetResearchServer/'	* 'Nimble [Crawler]'			'NimbleCrawler'	* 'Ocelli [Bot]'				'Ocelli/'	* 'Onsearch [Bot]'				'onCHECK-Robot'	* 'Orange [Spider]'				'OrangeSpider'	* 'Sproose [Bot]'				'http://www.sproose.com/bot'	* 'Susie [Sync]'				'!Susie (http://www.sync2it.com/susie)'	* 'Tbot [Bot]'					'Tbot/'	* 'Thumbshots [Capture]'		'thumbshots-de-Bot'	* 'Vagabondo [Crawler]'			'http://webagent.wise-guys.nl/'	* 'Walhello [Bot]'				'appie 1.1 (www.walhello.com)'	* 'WissenOnline [Bot]'			'WissenOnline-Bot'	* 'WWWeasel [Bot]'				'WWWeasel Robot v'	* 'Xaldon [Spider]'				'Xaldon WebSpider'	*/	var $bot_list = array(		'AdsBot [Google]'			=> array('AdsBot-Google', ''),		'Alexa [Bot]'				=> array('ia_archiver', ''),		'Alta Vista [Bot]'			=> array('Scooter/', ''),		'Ask Jeeves [Bot]'			=> array('Ask Jeeves', ''),		'Baidu [Spider]'			=> array('Baiduspider+(', ''),		'Bing [Bot]'                => array('bingbot/', ''),		'Exabot [Bot]'				=> array('Exabot/', ''),		'FAST Enterprise [Crawler]'	=> array('FAST Enterprise Crawler', ''),		'FAST WebCrawler [Crawler]'	=> array('FAST-WebCrawler/', ''),		'Francis [Bot]'				=> array('http://www.neomo.de/', ''),		'Gigabot [Bot]'				=> array('Gigabot/', ''),		'Google Adsense [Bot]'		=> array('Mediapartners-Google', ''),		'Google Desktop'			=> array('Google Desktop', ''),		'Google Feedfetcher'		=> array('Feedfetcher-Google', ''),		'Google [Bot]'				=> array('Googlebot', ''),		'Heise IT-Markt [Crawler]'	=> array('heise-IT-Markt-Crawler', ''),		'Heritrix [Crawler]'		=> array('heritrix/1.', ''),		'IBM Research [Bot]'		=> array('ibm.com/cs/crawler', ''),		'ICCrawler - ICjobs'		=> array('ICCrawler - ICjobs', ''),		'ichiro [Crawler]'			=> array('ichiro/', ''),		'Majestic-12 [Bot]'			=> array('MJ12bot/', ''),		'Metager [Bot]'				=> array('MetagerBot/', ''),		'MSN NewsBlogs'				=> array('msnbot-NewsBlogs/', ''),		'MSN [Bot]'					=> array('msnbot/', ''),		'MSNbot Media'				=> array('msnbot-media/', ''),		'NG-Search [Bot]'			=> array('NG-Search/', ''),		'Nutch [Bot]'				=> array('http://lucene.apache.org/nutch/', ''),		'Nutch/CVS [Bot]'			=> array('NutchCVS/', ''),		'OmniExplorer [Bot]'		=> array('OmniExplorer_Bot/', ''),		'Online link [Validator]'	=> array('online link validator', ''),		'psbot [Picsearch]'			=> array('psbot/0', ''),		'Seekport [Bot]'			=> array('Seekbot/', ''),		'Sensis [Crawler]'			=> array('Sensis Web Crawler', ''),		'SEO Crawler'				=> array('SEO search Crawler/', ''),		'Seoma [Crawler]'			=> array('Seoma [SEO Crawler]', ''),		'SEOSearch [Crawler]'		=> array('SEOsearch/', ''),		'Snappy [Bot]'				=> array('Snappy/1.1 ( http://www.urltrends.com/ )', ''),		'Steeler [Crawler]'			=> array('http://www.tkl.iis.u-tokyo.ac.jp/~crawler/', ''),		'Synoo [Bot]'				=> array('SynooBot/', ''),		'Telekom [Bot]'				=> array('crawleradmin.t-info@telekom.de', ''),		'TurnitinBot [Bot]'			=> array('TurnitinBot/', ''),		'Voyager [Bot]'				=> array('voyager/1.0', ''),		'W3 [Sitesearch]'			=> array('W3 SiteSearch Crawler', ''),		'W3C [Linkcheck]'			=> array('W3C-checklink/', ''),		'W3C [Validator]'			=> array('W3C_*Validator', ''),		'WiseNut [Bot]'				=> array('http://www.WISEnutbot.com', ''),		'YaCy [Bot]'				=> array('yacybot', ''),		'Yahoo MMCrawler [Bot]'		=> array('Yahoo-MMCrawler/', ''),		'Yahoo Slurp [Bot]'			=> array('Yahoo! DE Slurp', ''),		'Yahoo [Bot]'				=> array('Yahoo! Slurp', ''),		'YahooSeeker [Bot]'			=> array('YahooSeeker/', ''),	);	/**	* Define the module structure so that we can populate the database without	* needing to hard-code module_id values	*/	var $module_categories = array(		'acp'	=> array(			'ACP_CAT_GENERAL'		=> array(				'ACP_QUICK_ACCESS',				'ACP_BOARD_CONFIGURATION',				'ACP_CLIENT_COMMUNICATION',				'ACP_SERVER_CONFIGURATION',			),			'ACP_CAT_FORUMS'		=> array(				'ACP_MANAGE_FORUMS',				'ACP_FORUM_BASED_PERMISSIONS',			),			'ACP_CAT_POSTING'		=> array(				'ACP_MESSAGES',				'ACP_ATTACHMENTS',			),			'ACP_CAT_USERGROUP'		=> array(				'ACP_CAT_USERS',				'ACP_GROUPS',				'ACP_USER_SECURITY',			),			'ACP_CAT_PERMISSIONS'	=> array(				'ACP_GLOBAL_PERMISSIONS',				'ACP_FORUM_BASED_PERMISSIONS',				'ACP_PERMISSION_ROLES',				'ACP_PERMISSION_MASKS',			),			'ACP_CAT_STYLES'		=> array(				'ACP_STYLE_MANAGEMENT',				'ACP_STYLE_COMPONENTS',			),			'ACP_CAT_MAINTENANCE'	=> array(				'ACP_FORUM_LOGS',				'ACP_CAT_DATABASE',			),			'ACP_CAT_SYSTEM'		=> array(				'ACP_AUTOMATION',				'ACP_GENERAL_TASKS',				'ACP_MODULE_MANAGEMENT',			),			'ACP_CAT_DOT_MODS'		=> null,		),		'mcp'	=> array(			'MCP_MAIN'		=> null,			'MCP_QUEUE'		=> null,			'MCP_REPORTS'	=> null,			'MCP_NOTES'		=> null,			'MCP_WARN'		=> null,			'MCP_LOGS'		=> null,			'MCP_BAN'		=> null,		),		'ucp'	=> array(			'UCP_MAIN'			=> null,			'UCP_PROFILE'		=> null,			'UCP_PREFS'			=> null,			'UCP_PM'			=> null,			'UCP_USERGROUPS'	=> null,			'UCP_ZEBRA'			=> null,		),	);	var $module_extras = array(		'acp'	=> array(			'ACP_QUICK_ACCESS' => array(				'ACP_MANAGE_USERS',				'ACP_GROUPS_MANAGE',				'ACP_MANAGE_FORUMS',				'ACP_MOD_LOGS',				'ACP_BOTS',				'ACP_PHP_INFO',			),			'ACP_FORUM_BASED_PERMISSIONS' => array(				'ACP_FORUM_PERMISSIONS',				'ACP_FORUM_PERMISSIONS_COPY',				'ACP_FORUM_MODERATORS',				'ACP_USERS_FORUM_PERMISSIONS',				'ACP_GROUPS_FORUM_PERMISSIONS',			),		),	);}?>
<?php/**** @package phpBB3* @version $Id$* @copyright (c) 2005 phpBB Group* @license http://opensource.org/licenses/gpl-license.php GNU Public License**//*** @ignore*/if (!defined('IN_PHPBB')){	exit;}/*** Obtain user_ids from usernames or vice versa. Returns false on* success else the error string** @param array &$user_id_ary The user ids to check or empty if usernames used* @param array &$username_ary The usernames to check or empty if user ids used* @param mixed $user_type Array of user types to check, false if not restricting by user type*/function user_get_id_name(&$user_id_ary, &$username_ary, $user_type = false){	global $db;	// Are both arrays already filled? Yep, return else	// are neither array filled?	if ($user_id_ary && $username_ary)	{		return false;	}	else if (!$user_id_ary && !$username_ary)	{		return 'NO_USERS';	}	$which_ary = ($user_id_ary) ? 'user_id_ary' : 'username_ary';	if ($$which_ary && !is_array($$which_ary))	{		$$which_ary = array($$which_ary);	}	$sql_in = ($which_ary == 'user_id_ary') ? array_map('intval', $$which_ary) : array_map('utf8_clean_string', $$which_ary);	unset($$which_ary);	$user_id_ary = $username_ary = array();	// Grab the user id/username records	$sql_where = ($which_ary == 'user_id_ary') ? 'user_id' : 'username_clean';	$sql = 'SELECT user_id, username		FROM ' . USERS_TABLE . '		WHERE ' . $db->sql_in_set($sql_where, $sql_in);	if ($user_type !== false && !empty($user_type))	{		$sql .= ' AND ' . $db->sql_in_set('user_type', $user_type);	}	$result = $db->sql_query($sql);	if (!($row = $db->sql_fetchrow($result)))	{		$db->sql_freeresult($result);		return 'NO_USERS';	}	do	{		$username_ary[$row['user_id']] = $row['username'];		$user_id_ary[] = $row['user_id'];	}	while ($row = $db->sql_fetchrow($result));	$db->sql_freeresult($result);	return false;}/*** Get latest registered username and update database to reflect it*/function update_last_username(){	global $db;	// Get latest username	$sql = 'SELECT user_id, username, user_colour		FROM ' . USERS_TABLE . '		WHERE user_type IN (' . USER_NORMAL . ', ' . USER_FOUNDER . ')		ORDER BY user_id DESC';	$result = $db->sql_query_limit($sql, 1);	$row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if ($row)	{		set_config('newest_user_id', $row['user_id'], true);		set_config('newest_username', $row['username'], true);		set_config('newest_user_colour', $row['user_colour'], true);	}}/*** Updates a username across all relevant tables/fields** @param string $old_name the old/current username* @param string $new_name the new username*/function user_update_name($old_name, $new_name){	global $config, $db, $cache;	$update_ary = array(		FORUMS_TABLE			=> array('forum_last_poster_name'),		MODERATOR_CACHE_TABLE	=> array('username'),		POSTS_TABLE				=> array('post_username'),		TOPICS_TABLE			=> array('topic_first_poster_name', 'topic_last_poster_name'),	);	foreach ($update_ary as $table => $field_ary)	{		foreach ($field_ary as $field)		{			$sql = "UPDATE $table				SET $field = '" . $db->sql_escape($new_name) . "'				WHERE $field = '" . $db->sql_escape($old_name) . "'";			$db->sql_query($sql);		}	}	if ($config['newest_username'] == $old_name)	{		set_config('newest_username', $new_name, true);	}	// Because some tables/caches use username-specific data we need to purge this here.	$cache->destroy('sql', MODERATOR_CACHE_TABLE);}/*** Adds an user** @param mixed $user_row An array containing the following keys (and the appropriate values): username, group_id (the group to place the user in), user_email and the user_type(usually 0). Additional entries not overridden by defaults will be forwarded.* @param string $cp_data custom profile fields, see custom_profile::build_insert_sql_array* @return the new user's ID.*/function user_add($user_row, $cp_data = false){	global $db, $user, $auth, $config, $phpbb_root_path, $phpEx;	if (empty($user_row['username']) || !isset($user_row['group_id']) || !isset($user_row['user_email']) || !isset($user_row['user_type']))	{		return false;	}	$username_clean = utf8_clean_string($user_row['username']);	if (empty($username_clean))	{		return false;	}	$sql_ary = array(		'username'			=> $user_row['username'],		'username_clean'	=> $username_clean,		'user_password'		=> (isset($user_row['user_password'])) ? $user_row['user_password'] : '',		'user_pass_convert'	=> 0,		'user_email'		=> strtolower($user_row['user_email']),		'user_email_hash'	=> phpbb_email_hash($user_row['user_email']),		'group_id'			=> $user_row['group_id'],		'user_type'			=> $user_row['user_type'],	);	// These are the additional vars able to be specified	$additional_vars = array(		'user_permissions'	=> '',		'user_timezone'		=> $config['board_timezone'],		'user_dateformat'	=> $config['default_dateformat'],		'user_lang'			=> $config['default_lang'],		'user_style'		=> (int) $config['default_style'],		'user_actkey'		=> '',		'user_ip'			=> '',		'user_regdate'		=> time(),		'user_passchg'		=> time(),		'user_options'		=> 230271,		// We do not set the new flag here - registration scripts need to specify it		'user_new'			=> 0,		'user_inactive_reason'	=> 0,		'user_inactive_time'	=> 0,		'user_lastmark'			=> time(),		'user_lastvisit'		=> 0,		'user_lastpost_time'	=> 0,		'user_lastpage'			=> '',		'user_posts'			=> 0,		'user_dst'				=> (int) $config['board_dst'],		'user_colour'			=> '',		'user_occ'				=> '',		'user_interests'		=> '',		'user_avatar'			=> '',		'user_avatar_type'		=> 0,		'user_avatar_width'		=> 0,		'user_avatar_height'	=> 0,		'user_new_privmsg'		=> 0,		'user_unread_privmsg'	=> 0,		'user_last_privmsg'		=> 0,		'user_message_rules'	=> 0,		'user_full_folder'		=> PRIVMSGS_NO_BOX,		'user_emailtime'		=> 0,		'user_notify'			=> 0,		'user_notify_pm'		=> 1,		'user_notify_type'		=> NOTIFY_EMAIL,		'user_allow_pm'			=> 1,		'user_allow_viewonline'	=> 1,		'user_allow_viewemail'	=> 1,		'user_allow_massemail'	=> 1,		'user_sig'					=> '',		'user_sig_bbcode_uid'		=> '',		'user_sig_bbcode_bitfield'	=> '',		'user_form_salt'			=> unique_id(),	);	// Now fill the sql array with not required variables	foreach ($additional_vars as $key => $default_value)	{		$sql_ary[$key] = (isset($user_row[$key])) ? $user_row[$key] : $default_value;	}	// Any additional variables in $user_row not covered above?	$remaining_vars = array_diff(array_keys($user_row), array_keys($sql_ary));	// Now fill our sql array with the remaining vars	if (sizeof($remaining_vars))	{		foreach ($remaining_vars as $key)		{			$sql_ary[$key] = $user_row[$key];		}	}	$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary);	$db->sql_query($sql);	$user_id = $db->sql_nextid();	// Insert Custom Profile Fields	if ($cp_data !== false && sizeof($cp_data))	{		$cp_data['user_id'] = (int) $user_id;		if (!class_exists('custom_profile'))		{			include_once($phpbb_root_path . 'includes/functions_profile_fields.' . $phpEx);		}		$sql = 'INSERT INTO ' . PROFILE_FIELDS_DATA_TABLE . ' ' .			$db->sql_build_array('INSERT', custom_profile::build_insert_sql_array($cp_data));		$db->sql_query($sql);	}	// Place into appropriate group...	$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $db->sql_build_array('INSERT', array(		'user_id'		=> (int) $user_id,		'group_id'		=> (int) $user_row['group_id'],		'user_pending'	=> 0)	);	$db->sql_query($sql);	// Now make it the users default group...	group_set_user_default($user_row['group_id'], array($user_id), false);	// Add to newly registered users group if user_new is 1	if ($config['new_member_post_limit'] && $sql_ary['user_new'])	{		$sql = 'SELECT group_id			FROM ' . GROUPS_TABLE . "			WHERE group_name = 'NEWLY_REGISTERED'				AND group_type = " . GROUP_SPECIAL;		$result = $db->sql_query($sql);		$add_group_id = (int) $db->sql_fetchfield('group_id');		$db->sql_freeresult($result);		if ($add_group_id)		{			// Because these actions only fill the log unneccessarily we skip the add_log() entry with a little hack. :/			$GLOBALS['skip_add_log'] = true;			// Add user to "newly registered users" group and set to default group if admin specified so.			if ($config['new_member_group_default'])			{				group_user_add($add_group_id, $user_id, false, false, true);				$user_row['group_id'] = $add_group_id;			}			else			{				group_user_add($add_group_id, $user_id);			}			unset($GLOBALS['skip_add_log']);		}	}	// set the newest user and adjust the user count if the user is a normal user and no activation mail is sent	if ($user_row['user_type'] == USER_NORMAL || $user_row['user_type'] == USER_FOUNDER)	{		set_config('newest_user_id', $user_id, true);		set_config('newest_username', $user_row['username'], true);		set_config_count('num_users', 1, true);		$sql = 'SELECT group_colour			FROM ' . GROUPS_TABLE . '			WHERE group_id = ' . (int) $user_row['group_id'];		$result = $db->sql_query_limit($sql, 1);		$row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		set_config('newest_user_colour', $row['group_colour'], true);	}	return $user_id;}/*** Remove User*/function user_delete($mode, $user_id, $post_username = false){	global $cache, $config, $db, $user, $auth;	global $phpbb_root_path, $phpEx;	$sql = 'SELECT *		FROM ' . USERS_TABLE . '		WHERE user_id = ' . $user_id;	$result = $db->sql_query($sql);	$user_row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if (!$user_row)	{		return false;	}	// Before we begin, we will remove the reports the user issued.	$sql = 'SELECT r.post_id, p.topic_id		FROM ' . REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p		WHERE r.user_id = ' . $user_id . '			AND p.post_id = r.post_id';	$result = $db->sql_query($sql);	$report_posts = $report_topics = array();	while ($row = $db->sql_fetchrow($result))	{		$report_posts[] = $row['post_id'];		$report_topics[] = $row['topic_id'];	}	$db->sql_freeresult($result);	if (sizeof($report_posts))	{		$report_posts = array_unique($report_posts);		$report_topics = array_unique($report_topics);		// Get a list of topics that still contain reported posts		$sql = 'SELECT DISTINCT topic_id			FROM ' . POSTS_TABLE . '			WHERE ' . $db->sql_in_set('topic_id', $report_topics) . '				AND post_reported = 1				AND ' . $db->sql_in_set('post_id', $report_posts, true);		$result = $db->sql_query($sql);		$keep_report_topics = array();		while ($row = $db->sql_fetchrow($result))		{			$keep_report_topics[] = $row['topic_id'];		}		$db->sql_freeresult($result);		if (sizeof($keep_report_topics))		{			$report_topics = array_diff($report_topics, $keep_report_topics);		}		unset($keep_report_topics);		// Now set the flags back		$sql = 'UPDATE ' . POSTS_TABLE . '			SET post_reported = 0			WHERE ' . $db->sql_in_set('post_id', $report_posts);		$db->sql_query($sql);		if (sizeof($report_topics))		{			$sql = 'UPDATE ' . TOPICS_TABLE . '				SET topic_reported = 0				WHERE ' . $db->sql_in_set('topic_id', $report_topics);			$db->sql_query($sql);		}	}	// Remove reports	$db->sql_query('DELETE FROM ' . REPORTS_TABLE . ' WHERE user_id = ' . $user_id);	if ($user_row['user_avatar'] && $user_row['user_avatar_type'] == AVATAR_UPLOAD)	{		avatar_delete('user', $user_row);	}	switch ($mode)	{		case 'retain':			$db->sql_transaction('begin');			if ($post_username === false)			{				$post_username = $user->lang['GUEST'];			}			// If the user is inactive and newly registered we assume no posts from this user being there...			if ($user_row['user_type'] == USER_INACTIVE && $user_row['user_inactive_reason'] == INACTIVE_REGISTER && !$user_row['user_posts'])			{			}			else			{				$sql = 'UPDATE ' . FORUMS_TABLE . '					SET forum_last_poster_id = ' . ANONYMOUS . ", forum_last_poster_name = '" . $db->sql_escape($post_username) . "', forum_last_poster_colour = ''					WHERE forum_last_poster_id = $user_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . POSTS_TABLE . '					SET poster_id = ' . ANONYMOUS . ", post_username = '" . $db->sql_escape($post_username) . "'					WHERE poster_id = $user_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . POSTS_TABLE . '					SET post_edit_user = ' . ANONYMOUS . "					WHERE post_edit_user = $user_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . TOPICS_TABLE . '					SET topic_poster = ' . ANONYMOUS . ", topic_first_poster_name = '" . $db->sql_escape($post_username) . "', topic_first_poster_colour = ''					WHERE topic_poster = $user_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . TOPICS_TABLE . '					SET topic_last_poster_id = ' . ANONYMOUS . ", topic_last_poster_name = '" . $db->sql_escape($post_username) . "', topic_last_poster_colour = ''					WHERE topic_last_poster_id = $user_id";				$db->sql_query($sql);				$sql = 'UPDATE ' . ATTACHMENTS_TABLE . '					SET poster_id = ' . ANONYMOUS . "					WHERE poster_id = $user_id";				$db->sql_query($sql);				// Since we change every post by this author, we need to count this amount towards the anonymous user				// Update the post count for the anonymous user				if ($user_row['user_posts'])				{					$sql = 'UPDATE ' . USERS_TABLE . '						SET user_posts = user_posts + ' . $user_row['user_posts'] . '						WHERE user_id = ' . ANONYMOUS;					$db->sql_query($sql);				}			}			$db->sql_transaction('commit');		break;		case 'remove':			if (!function_exists('delete_posts'))			{				include($phpbb_root_path . 'includes/functions_admin.' . $phpEx);			}			// Delete posts, attachments, etc.			delete_posts('poster_id', $user_id);		break;	}	$db->sql_transaction('begin');	$table_ary = array(USERS_TABLE, USER_GROUP_TABLE, TOPICS_WATCH_TABLE, FORUMS_WATCH_TABLE, ACL_USERS_TABLE, TOPICS_TRACK_TABLE, TOPICS_POSTED_TABLE, FORUMS_TRACK_TABLE, PROFILE_FIELDS_DATA_TABLE, MODERATOR_CACHE_TABLE, DRAFTS_TABLE, BOOKMARKS_TABLE, SESSIONS_KEYS_TABLE, PRIVMSGS_FOLDER_TABLE, PRIVMSGS_RULES_TABLE);	foreach ($table_ary as $table)	{		$sql = "DELETE FROM $table			WHERE user_id = $user_id";		$db->sql_query($sql);	}	$cache->destroy('sql', MODERATOR_CACHE_TABLE);	// Delete user log entries about this user	$sql = 'DELETE FROM ' . LOG_TABLE . '		WHERE reportee_id = ' . $user_id;	$db->sql_query($sql);	// Change user_id to anonymous for this users triggered events	$sql = 'UPDATE ' . LOG_TABLE . '		SET user_id = ' . ANONYMOUS . '		WHERE user_id = ' . $user_id;	$db->sql_query($sql);	// Delete the user_id from the zebra table	$sql = 'DELETE FROM ' . ZEBRA_TABLE . '		WHERE user_id = ' . $user_id . '			OR zebra_id = ' . $user_id;	$db->sql_query($sql);	// Delete the user_id from the banlist	$sql = 'DELETE FROM ' . BANLIST_TABLE . '		WHERE ban_userid = ' . $user_id;	$db->sql_query($sql);	// Delete the user_id from the session table	$sql = 'DELETE FROM ' . SESSIONS_TABLE . '		WHERE session_user_id = ' . $user_id;	$db->sql_query($sql);	// Remove any undelivered mails...	$sql = 'SELECT msg_id, user_id		FROM ' . PRIVMSGS_TO_TABLE . '		WHERE author_id = ' . $user_id . '			AND folder_id = ' . PRIVMSGS_NO_BOX;	$result = $db->sql_query($sql);	$undelivered_msg = $undelivered_user = array();	while ($row = $db->sql_fetchrow($result))	{		$undelivered_msg[] = $row['msg_id'];		$undelivered_user[$row['user_id']][] = true;	}	$db->sql_freeresult($result);	if (sizeof($undelivered_msg))	{		$sql = 'DELETE FROM ' . PRIVMSGS_TABLE . '			WHERE ' . $db->sql_in_set('msg_id', $undelivered_msg);		$db->sql_query($sql);	}	$sql = 'DELETE FROM ' . PRIVMSGS_TO_TABLE . '		WHERE author_id = ' . $user_id . '			AND folder_id = ' . PRIVMSGS_NO_BOX;	$db->sql_query($sql);	// Delete all to-information	$sql = 'DELETE FROM ' . PRIVMSGS_TO_TABLE . '		WHERE user_id = ' . $user_id;	$db->sql_query($sql);	// Set the remaining author id to anonymous - this way users are still able to read messages from users being removed	$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . '		SET author_id = ' . ANONYMOUS . '		WHERE author_id = ' . $user_id;	$db->sql_query($sql);	$sql = 'UPDATE ' . PRIVMSGS_TABLE . '		SET author_id = ' . ANONYMOUS . '		WHERE author_id = ' . $user_id;	$db->sql_query($sql);	foreach ($undelivered_user as $_user_id => $ary)	{		if ($_user_id == $user_id)		{			continue;		}		$sql = 'UPDATE ' . USERS_TABLE . '			SET user_new_privmsg = user_new_privmsg - ' . sizeof($ary) . ',				user_unread_privmsg = user_unread_privmsg - ' . sizeof($ary) . '			WHERE user_id = ' . $_user_id;		$db->sql_query($sql);	}	$db->sql_transaction('commit');	// Reset newest user info if appropriate	if ($config['newest_user_id'] == $user_id)	{		update_last_username();	}	// Decrement number of users if this user is active	if ($user_row['user_type'] != USER_INACTIVE && $user_row['user_type'] != USER_IGNORE)	{		set_config_count('num_users', -1, true);	}	return false;}/*** Flips user_type from active to inactive and vice versa, handles group membership updates** @param string $mode can be flip for flipping from active/inactive, activate or deactivate*/function user_active_flip($mode, $user_id_ary, $reason = INACTIVE_MANUAL){	global $config, $db, $user, $auth;	$deactivated = $activated = 0;	$sql_statements = array();	if (!is_array($user_id_ary))	{		$user_id_ary = array($user_id_ary);	}	if (!sizeof($user_id_ary))	{		return;	}	$sql = 'SELECT user_id, group_id, user_type, user_inactive_reason		FROM ' . USERS_TABLE . '		WHERE ' . $db->sql_in_set('user_id', $user_id_ary);	$result = $db->sql_query($sql);	while ($row = $db->sql_fetchrow($result))	{		$sql_ary = array();		if ($row['user_type'] == USER_IGNORE || $row['user_type'] == USER_FOUNDER ||			($mode == 'activate' && $row['user_type'] != USER_INACTIVE) ||			($mode == 'deactivate' && $row['user_type'] == USER_INACTIVE))		{			continue;		}		if ($row['user_type'] == USER_INACTIVE)		{			$activated++;		}		else		{			$deactivated++;			// Remove the users session key...			$user->reset_login_keys($row['user_id']);		}		$sql_ary += array(			'user_type'				=> ($row['user_type'] == USER_NORMAL) ? USER_INACTIVE : USER_NORMAL,			'user_inactive_time'	=> ($row['user_type'] == USER_NORMAL) ? time() : 0,			'user_inactive_reason'	=> ($row['user_type'] == USER_NORMAL) ? $reason : 0,		);		$sql_statements[$row['user_id']] = $sql_ary;	}	$db->sql_freeresult($result);	if (sizeof($sql_statements))	{		foreach ($sql_statements as $user_id => $sql_ary)		{			$sql = 'UPDATE ' . USERS_TABLE . '				SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '				WHERE user_id = ' . $user_id;			$db->sql_query($sql);		}		$auth->acl_clear_prefetch(array_keys($sql_statements));	}	if ($deactivated)	{		set_config_count('num_users', $deactivated * (-1), true);	}	if ($activated)	{		set_config_count('num_users', $activated, true);	}	// Update latest username	update_last_username();}/*** Add a ban or ban exclusion to the banlist. Bans either a user, an IP or an email address** @param string $mode Type of ban. One of the following: user, ip, email* @param mixed $ban Banned entity. Either string or array with usernames, ips or email addresses* @param int $ban_len Ban length in minutes* @param string $ban_len_other Ban length as a date (YYYY-MM-DD)* @param boolean $ban_exclude Exclude these entities from banning?* @param string $ban_reason String describing the reason for this ban* @return boolean*/function user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason, $ban_give_reason = ''){	global $db, $user, $auth, $cache;	// Delete stale bans	$sql = 'DELETE FROM ' . BANLIST_TABLE . '		WHERE ban_end < ' . time() . '			AND ban_end <> 0';	$db->sql_query($sql);	$ban_list = (!is_array($ban)) ? array_unique(explode("\n", $ban)) : $ban;	$ban_list_log = implode(', ', $ban_list);	$current_time = time();	// Set $ban_end to the unix time when the ban should end. 0 is a permanent ban.	if ($ban_len)	{		if ($ban_len != -1 || !$ban_len_other)		{			$ban_end = max($current_time, $current_time + ($ban_len) * 60);		}		else		{			$ban_other = explode('-', $ban_len_other);			if (sizeof($ban_other) == 3 && ((int)$ban_other[0] < 9999) &&				(strlen($ban_other[0]) == 4) && (strlen($ban_other[1]) == 2) && (strlen($ban_other[2]) == 2))			{				$time_offset = (isset($user->timezone) && isset($user->dst)) ? (int) $user->timezone + (int) $user->dst : 0;				$ban_end = max($current_time, gmmktime(0, 0, 0, (int)$ban_other[1], (int)$ban_other[2], (int)$ban_other[0]) - $time_offset);			}			else			{				trigger_error('LENGTH_BAN_INVALID', E_USER_WARNING);			}		}	}	else	{		$ban_end = 0;	}	$founder = $founder_names = array();	if (!$ban_exclude)	{		// Create a list of founder...		$sql = 'SELECT user_id, user_email, username_clean			FROM ' . USERS_TABLE . '			WHERE user_type = ' . USER_FOUNDER;		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			$founder[$row['user_id']] = $row['user_email'];			$founder_names[$row['user_id']] = $row['username_clean'];		}		$db->sql_freeresult($result);	}	$banlist_ary = array();	switch ($mode)	{		case 'user':			$type = 'ban_userid';			// At the moment we do not support wildcard username banning			// Select the relevant user_ids.			$sql_usernames = array();			foreach ($ban_list as $username)			{				$username = trim($username);				if ($username != '')				{					$clean_name = utf8_clean_string($username);					if ($clean_name == $user->data['username_clean'])					{						trigger_error('CANNOT_BAN_YOURSELF', E_USER_WARNING);					}					if (in_array($clean_name, $founder_names))					{						trigger_error('CANNOT_BAN_FOUNDER', E_USER_WARNING);					}					$sql_usernames[] = $clean_name;				}			}			// Make sure we have been given someone to ban			if (!sizeof($sql_usernames))			{				trigger_error('NO_USER_SPECIFIED', E_USER_WARNING);			}			$sql = 'SELECT user_id				FROM ' . USERS_TABLE . '				WHERE ' . $db->sql_in_set('username_clean', $sql_usernames);			// Do not allow banning yourself, the guest account, or founders.			$non_bannable = array($user->data['user_id'], ANONYMOUS);			if (sizeof($founder))			{				$sql .= ' AND ' . $db->sql_in_set('user_id', array_merge(array_keys($founder), $non_bannable), true);			}			else			{				$sql .= ' AND ' . $db->sql_in_set('user_id', $non_bannable, true);			}			$result = $db->sql_query($sql);			if ($row = $db->sql_fetchrow($result))			{				do				{					$banlist_ary[] = (int) $row['user_id'];				}				while ($row = $db->sql_fetchrow($result));			}			else			{				$db->sql_freeresult($result);				trigger_error('NO_USERS', E_USER_WARNING);			}			$db->sql_freeresult($result);		break;		case 'ip':			$type = 'ban_ip';			foreach ($ban_list as $ban_item)			{				if (preg_match('#^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})[ ]*\-[ ]*([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$#', trim($ban_item), $ip_range_explode))				{					// This is an IP range					// Don't ask about all this, just don't ask ... !					$ip_1_counter = $ip_range_explode[1];					$ip_1_end = $ip_range_explode[5];					while ($ip_1_counter <= $ip_1_end)					{						$ip_2_counter = ($ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[2] : 0;						$ip_2_end = ($ip_1_counter < $ip_1_end) ? 254 : $ip_range_explode[6];						if ($ip_2_counter == 0 && $ip_2_end == 254)						{							$ip_2_counter = 256;							$ip_2_fragment = 256;							$banlist_ary[] = "$ip_1_counter.*";						}						while ($ip_2_counter <= $ip_2_end)						{							$ip_3_counter = ($ip_2_counter == $ip_range_explode[2] && $ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[3] : 0;							$ip_3_end = ($ip_2_counter < $ip_2_end || $ip_1_counter < $ip_1_end) ? 254 : $ip_range_explode[7];							if ($ip_3_counter == 0 && $ip_3_end == 254)							{								$ip_3_counter = 256;								$ip_3_fragment = 256;								$banlist_ary[] = "$ip_1_counter.$ip_2_counter.*";							}							while ($ip_3_counter <= $ip_3_end)							{								$ip_4_counter = ($ip_3_counter == $ip_range_explode[3] && $ip_2_counter == $ip_range_explode[2] && $ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[4] : 0;								$ip_4_end = ($ip_3_counter < $ip_3_end || $ip_2_counter < $ip_2_end) ? 254 : $ip_range_explode[8];								if ($ip_4_counter == 0 && $ip_4_end == 254)								{									$ip_4_counter = 256;									$ip_4_fragment = 256;									$banlist_ary[] = "$ip_1_counter.$ip_2_counter.$ip_3_counter.*";								}								while ($ip_4_counter <= $ip_4_end)								{									$banlist_ary[] = "$ip_1_counter.$ip_2_counter.$ip_3_counter.$ip_4_counter";									$ip_4_counter++;								}								$ip_3_counter++;							}							$ip_2_counter++;						}						$ip_1_counter++;					}				}				else if (preg_match('#^([0-9]{1,3})\.([0-9\*]{1,3})\.([0-9\*]{1,3})\.([0-9\*]{1,3})$#', trim($ban_item)) || preg_match('#^[a-f0-9:]+\*?$#i', trim($ban_item)))				{					// Normal IP address					$banlist_ary[] = trim($ban_item);				}				else if (preg_match('#^\*$#', trim($ban_item)))				{					// Ban all IPs					$banlist_ary[] = '*';				}				else if (preg_match('#^([\w\-_]\.?){2,}$#is', trim($ban_item)))				{					// hostname					$ip_ary = gethostbynamel(trim($ban_item));					if (!empty($ip_ary))					{						foreach ($ip_ary as $ip)						{							if ($ip)							{								if (strlen($ip) > 40)								{									continue;								}								$banlist_ary[] = $ip;							}						}					}				}				if (empty($banlist_ary))				{					trigger_error('NO_IPS_DEFINED', E_USER_WARNING);				}			}		break;		case 'email':			$type = 'ban_email';			foreach ($ban_list as $ban_item)			{				$ban_item = trim($ban_item);				if (preg_match('#^.*?@*|(([a-z0-9\-]+\.)+([a-z]{2,3}))$#i', $ban_item))				{					if (strlen($ban_item) > 100)					{						continue;					}					if (!sizeof($founder) || !in_array($ban_item, $founder))					{						$banlist_ary[] = $ban_item;					}				}			}			if (sizeof($ban_list) == 0)			{				trigger_error('NO_EMAILS_DEFINED', E_USER_WARNING);			}		break;		default:			trigger_error('NO_MODE', E_USER_WARNING);		break;	}	// Fetch currently set bans of the specified type and exclude state. Prevent duplicate bans.	$sql_where = ($type == 'ban_userid') ? 'ban_userid <> 0' : "$type <> ''";	$sql = "SELECT $type		FROM " . BANLIST_TABLE . "		WHERE $sql_where			AND ban_exclude = " . (int) $ban_exclude;	$result = $db->sql_query($sql);	// Reset $sql_where, because we use it later...	$sql_where = '';	if ($row = $db->sql_fetchrow($result))	{		$banlist_ary_tmp = array();		do		{			switch ($mode)			{				case 'user':					$banlist_ary_tmp[] = $row['ban_userid'];				break;				case 'ip':					$banlist_ary_tmp[] = $row['ban_ip'];				break;				case 'email':					$banlist_ary_tmp[] = $row['ban_email'];				break;			}		}		while ($row = $db->sql_fetchrow($result));		$banlist_ary_tmp = array_intersect($banlist_ary, $banlist_ary_tmp);		if (sizeof($banlist_ary_tmp))		{			// One or more entities are already banned/excluded, delete the existing bans, so they can be re-inserted with the given new length			$sql = 'DELETE FROM ' . BANLIST_TABLE . '				WHERE ' . $db->sql_in_set($type, $banlist_ary_tmp) . '					AND ban_exclude = ' . (int) $ban_exclude;			$db->sql_query($sql);		}		unset($banlist_ary_tmp);	}	$db->sql_freeresult($result);	// We have some entities to ban	if (sizeof($banlist_ary))	{		$sql_ary = array();		foreach ($banlist_ary as $ban_entry)		{			$sql_ary[] = array(				$type				=> $ban_entry,				'ban_start'			=> (int) $current_time,				'ban_end'			=> (int) $ban_end,				'ban_exclude'		=> (int) $ban_exclude,				'ban_reason'		=> (string) $ban_reason,				'ban_give_reason'	=> (string) $ban_give_reason,			);		}		$db->sql_multi_insert(BANLIST_TABLE, $sql_ary);		// If we are banning we want to logout anyone matching the ban		if (!$ban_exclude)		{			switch ($mode)			{				case 'user':					$sql_where = 'WHERE ' . $db->sql_in_set('session_user_id', $banlist_ary);				break;				case 'ip':					$sql_where = 'WHERE ' . $db->sql_in_set('session_ip', $banlist_ary);				break;				case 'email':					$banlist_ary_sql = array();					foreach ($banlist_ary as $ban_entry)					{						$banlist_ary_sql[] = (string) str_replace('*', '%', $ban_entry);					}					$sql = 'SELECT user_id						FROM ' . USERS_TABLE . '						WHERE ' . $db->sql_in_set('user_email', $banlist_ary_sql);					$result = $db->sql_query($sql);					$sql_in = array();					if ($row = $db->sql_fetchrow($result))					{						do						{							$sql_in[] = $row['user_id'];						}						while ($row = $db->sql_fetchrow($result));						$sql_where = 'WHERE ' . $db->sql_in_set('session_user_id', $sql_in);					}					$db->sql_freeresult($result);				break;			}			if (isset($sql_where) && $sql_where)			{				$sql = 'DELETE FROM ' . SESSIONS_TABLE . "					$sql_where";				$db->sql_query($sql);				if ($mode == 'user')				{					$sql = 'DELETE FROM ' . SESSIONS_KEYS_TABLE . ' ' . ((in_array('*', $banlist_ary)) ? '' : 'WHERE ' . $db->sql_in_set('user_id', $banlist_ary));					$db->sql_query($sql);				}			}		}		// Update log		$log_entry = ($ban_exclude) ? 'LOG_BAN_EXCLUDE_' : 'LOG_BAN_';		// Add to moderator log, admin log and user notes		add_log('admin', $log_entry . strtoupper($mode), $ban_reason, $ban_list_log);		add_log('mod', 0, 0, $log_entry . strtoupper($mode), $ban_reason, $ban_list_log);		if ($mode == 'user')		{			foreach ($banlist_ary as $user_id)			{				add_log('user', $user_id, $log_entry . strtoupper($mode), $ban_reason, $ban_list_log);			}		}		$cache->destroy('sql', BANLIST_TABLE);		return true;	}	// There was nothing to ban/exclude. But destroying the cache because of the removal of stale bans.	$cache->destroy('sql', BANLIST_TABLE);	return false;}/*** Unban User*/function user_unban($mode, $ban){	global $db, $user, $auth, $cache;	// Delete stale bans	$sql = 'DELETE FROM ' . BANLIST_TABLE . '		WHERE ban_end < ' . time() . '			AND ban_end <> 0';	$db->sql_query($sql);	if (!is_array($ban))	{		$ban = array($ban);	}	$unban_sql = array_map('intval', $ban);	if (sizeof($unban_sql))	{		// Grab details of bans for logging information later		switch ($mode)		{			case 'user':				$sql = 'SELECT u.username AS unban_info, u.user_id					FROM ' . USERS_TABLE . ' u, ' . BANLIST_TABLE . ' b					WHERE ' . $db->sql_in_set('b.ban_id', $unban_sql) . '						AND u.user_id = b.ban_userid';			break;			case 'email':				$sql = 'SELECT ban_email AS unban_info					FROM ' . BANLIST_TABLE . '					WHERE ' . $db->sql_in_set('ban_id', $unban_sql);			break;			case 'ip':				$sql = 'SELECT ban_ip AS unban_info					FROM ' . BANLIST_TABLE . '					WHERE ' . $db->sql_in_set('ban_id', $unban_sql);			break;		}		$result = $db->sql_query($sql);		$l_unban_list = '';		$user_ids_ary = array();		while ($row = $db->sql_fetchrow($result))		{			$l_unban_list .= (($l_unban_list != '') ? ', ' : '') . $row['unban_info'];			if ($mode == 'user')			{				$user_ids_ary[] = $row['user_id'];			}		}		$db->sql_freeresult($result);		$sql = 'DELETE FROM ' . BANLIST_TABLE . '			WHERE ' . $db->sql_in_set('ban_id', $unban_sql);		$db->sql_query($sql);		// Add to moderator log, admin log and user notes		add_log('admin', 'LOG_UNBAN_' . strtoupper($mode), $l_unban_list);		add_log('mod', 0, 0, 'LOG_UNBAN_' . strtoupper($mode), $l_unban_list);		if ($mode == 'user')		{			foreach ($user_ids_ary as $user_id)			{				add_log('user', $user_id, 'LOG_UNBAN_' . strtoupper($mode), $l_unban_list);			}		}	}	$cache->destroy('sql', BANLIST_TABLE);	return false;}/*** Internet Protocol Address Whois* RFC3912: WHOIS Protocol Specification** @param string $ip		Ip address, either IPv4 or IPv6.** @return string		Empty string if not a valid ip address.*						Otherwise make_clickable()'ed whois result.*/function user_ipwhois($ip){	if (empty($ip))	{		return '';	}	if (preg_match(get_preg_expression('ipv4'), $ip))	{		// IPv4 address		$whois_host = 'whois.arin.net.';	}	else if (preg_match(get_preg_expression('ipv6'), $ip))	{		// IPv6 address		$whois_host = 'whois.sixxs.net.';	}	else	{		return '';	}	$ipwhois = '';	if (($fsk = @fsockopen($whois_host, 43)))	{		// CRLF as per RFC3912		fputs($fsk, "$ip\r\n");		while (!feof($fsk))		{			$ipwhois .= fgets($fsk, 1024);		}		@fclose($fsk);	}	$match = array();	// Test for referrals from $whois_host to other whois databases, roll on rwhois	if (preg_match('#ReferralServer: whois://(.+)#im', $ipwhois, $match))	{		if (strpos($match[1], ':') !== false)		{			$pos	= strrpos($match[1], ':');			$server	= substr($match[1], 0, $pos);			$port	= (int) substr($match[1], $pos + 1);			unset($pos);		}		else		{			$server	= $match[1];			$port	= 43;		}		$buffer = '';		if (($fsk = @fsockopen($server, $port)))		{			fputs($fsk, "$ip\r\n");			while (!feof($fsk))			{				$buffer .= fgets($fsk, 1024);			}			@fclose($fsk);		}		// Use the result from $whois_host if we don't get any result here		$ipwhois = (empty($buffer)) ? $ipwhois : $buffer;	}	$ipwhois = htmlspecialchars($ipwhois);	// Magic URL ;)	return trim(make_clickable($ipwhois, false, ''));}/*** Data validation ... used primarily but not exclusively by ucp modules** "Master" function for validating a range of data types*/function validate_data($data, $val_ary){	global $user;	$error = array();	foreach ($val_ary as $var => $val_seq)	{		if (!is_array($val_seq[0]))		{			$val_seq = array($val_seq);		}		foreach ($val_seq as $validate)		{			$function = array_shift($validate);			array_unshift($validate, $data[$var]);			if ($result = call_user_func_array('validate_' . $function, $validate))			{				// Since errors are checked later for their language file existence, we need to make sure custom errors are not adjusted.				$error[] = (empty($user->lang[$result . '_' . strtoupper($var)])) ? $result : $result . '_' . strtoupper($var);			}		}	}	return $error;}/*** Validate String** @return	boolean|string	Either false if validation succeeded or a string which will be used as the error message (with the variable name appended)*/function validate_string($string, $optional = false, $min = 0, $max = 0){	if (empty($string) && $optional)	{		return false;	}	if ($min && utf8_strlen(htmlspecialchars_decode($string)) < $min)	{		return 'TOO_SHORT';	}	else if ($max && utf8_strlen(htmlspecialchars_decode($string)) > $max)	{		return 'TOO_LONG';	}	return false;}/*** Validate Number** @return	boolean|string	Either false if validation succeeded or a string which will be used as the error message (with the variable name appended)*/function validate_num($num, $optional = false, $min = 0, $max = 1E99){	if (empty($num) && $optional)	{		return false;	}	if ($num < $min)	{		return 'TOO_SMALL';	}	else if ($num > $max)	{		return 'TOO_LARGE';	}	return false;}/*** Validate Date* @param String $string a date in the dd-mm-yyyy format* @return	boolean*/function validate_date($date_string, $optional = false){	$date = explode('-', $date_string);	if ((empty($date) || sizeof($date) != 3) && $optional)	{		return false;	}	else if ($optional)	{		for ($field = 0; $field <= 1; $field++)		{			$date[$field] = (int) $date[$field];			if (empty($date[$field]))			{				$date[$field] = 1;			}		}		$date[2] = (int) $date[2];		// assume an arbitrary leap year		if (empty($date[2]))		{			$date[2] = 1980;		}	}	if (sizeof($date) != 3 || !checkdate($date[1], $date[0], $date[2]))	{		return 'INVALID';	}	return false;}/*** Validate Match** @return	boolean|string	Either false if validation succeeded or a string which will be used as the error message (with the variable name appended)*/function validate_match($string, $optional = false, $match = ''){	if (empty($string) && $optional)	{		return false;	}	if (empty($match))	{		return false;	}	if (!preg_match($match, $string))	{		return 'WRONG_DATA';	}	return false;}/*** Validate Language Pack ISO Name** Tests whether a language name is valid and installed** @param string $lang_iso	The language string to test** @return bool|string		Either false if validation succeeded or*							a string which will be used as the error message*							(with the variable name appended)*/function validate_language_iso_name($lang_iso){	global $db;	$sql = 'SELECT lang_id		FROM ' . LANG_TABLE . "		WHERE lang_iso = '" . $db->sql_escape($lang_iso) . "'";	$result = $db->sql_query($sql);	$lang_id = (int) $db->sql_fetchfield('lang_id');	$db->sql_freeresult($result);	return ($lang_id) ? false : 'WRONG_DATA';}/*** Check to see if the username has been taken, or if it is disallowed.* Also checks if it includes the " character, which we don't allow in usernames.* Used for registering, changing names, and posting anonymously with a username** @param string $username The username to check* @param string $allowed_username An allowed username, default being $user->data['username']** @return	mixed	Either false if validation succeeded or a string which will be used as the error message (with the variable name appended)*/function validate_username($username, $allowed_username = false){	global $config, $db, $user, $cache;	$clean_username = utf8_clean_string($username);	$allowed_username = ($allowed_username === false) ? $user->data['username_clean'] : utf8_clean_string($allowed_username);	if ($allowed_username == $clean_username)	{		return false;	}	// ... fast checks first.	if (strpos($username, '&quot;') !== false || strpos($username, '"') !== false || empty($clean_username))	{		return 'INVALID_CHARS';	}	$mbstring = $pcre = false;	// generic UTF-8 character types supported?	if ((version_compare(PHP_VERSION, '5.1.0', '>=') || (version_compare(PHP_VERSION, '5.0.0-dev', '<=') && version_compare(PHP_VERSION, '4.4.0', '>='))) && @preg_match('/\p{L}/u', 'a') !== false)	{		$pcre = true;	}	else if (function_exists('mb_ereg_match'))	{		mb_regex_encoding('UTF-8');		$mbstring = true;	}	switch ($config['allow_name_chars'])	{		case 'USERNAME_CHARS_ANY':			$pcre = true;			$regex = '.+';		break;		case 'USERNAME_ALPHA_ONLY':			$pcre = true;			$regex = '[A-Za-z0-9]+';		break;		case 'USERNAME_ALPHA_SPACERS':			$pcre = true;			$regex = '[A-Za-z0-9-[\]_+ ]+';		break;		case 'USERNAME_LETTER_NUM':			if ($pcre)			{				$regex = '[\p{Lu}\p{Ll}\p{N}]+';			}			else if ($mbstring)			{				$regex = '[[:upper:][:lower:][:digit:]]+';			}			else			{				$pcre = true;				$regex = '[a-zA-Z0-9]+';			}		break;		case 'USERNAME_LETTER_NUM_SPACERS':			if ($pcre)			{				$regex = '[-\]_+ [\p{Lu}\p{Ll}\p{N}]+';			}			else if ($mbstring)			{				$regex = '[-\]_+ \[[:upper:][:lower:][:digit:]]+';			}			else			{				$pcre = true;				$regex = '[-\]_+ [a-zA-Z0-9]+';			}		break;		case 'USERNAME_ASCII':		default:			$pcre = true;			$regex = '[\x01-\x7F]+';		break;	}	if ($pcre)	{		if (!preg_match('#^' . $regex . '$#u', $username))		{			return 'INVALID_CHARS';		}	}	else if ($mbstring)	{		mb_ereg_search_init($username, '^' . $regex . '$');		if (!mb_ereg_search())		{			return 'INVALID_CHARS';		}	}	$sql = 'SELECT username		FROM ' . USERS_TABLE . "		WHERE username_clean = '" . $db->sql_escape($clean_username) . "'";	$result = $db->sql_query($sql);	$row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if ($row)	{		return 'USERNAME_TAKEN';	}	$sql = 'SELECT group_name		FROM ' . GROUPS_TABLE . "		WHERE LOWER(group_name) = '" . $db->sql_escape(utf8_strtolower($username)) . "'";	$result = $db->sql_query($sql);	$row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if ($row)	{		return 'USERNAME_TAKEN';	}	$bad_usernames = $cache->obtain_disallowed_usernames();	foreach ($bad_usernames as $bad_username)	{		if (preg_match('#^' . $bad_username . '$#', $clean_username))		{			return 'USERNAME_DISALLOWED';		}	}	return false;}/*** Check to see if the password meets the complexity settings** @return	boolean|string	Either false if validation succeeded or a string which will be used as the error message (with the variable name appended)*/function validate_password($password){	global $config, $db, $user;	if ($password === '' || $config['pass_complex'] === 'PASS_TYPE_ANY')	{		// Password empty or no password complexity required.		return false;	}	$pcre = $mbstring = false;	// generic UTF-8 character types supported?	if ((version_compare(PHP_VERSION, '5.1.0', '>=') || (version_compare(PHP_VERSION, '5.0.0-dev', '<=') && version_compare(PHP_VERSION, '4.4.0', '>='))) && @preg_match('/\p{L}/u', 'a') !== false)	{		$upp = '\p{Lu}';		$low = '\p{Ll}';		$num = '\p{N}';		$sym = '[^\p{Lu}\p{Ll}\p{N}]';		$pcre = true;	}	else if (function_exists('mb_ereg_match'))	{		mb_regex_encoding('UTF-8');		$upp = '[[:upper:]]';		$low = '[[:lower:]]';		$num = '[[:digit:]]';		$sym = '[^[:upper:][:lower:][:digit:]]';		$mbstring = true;	}	else	{		$upp = '[A-Z]';		$low = '[a-z]';		$num = '[0-9]';		$sym = '[^A-Za-z0-9]';		$pcre = true;	}	$chars = array();	switch ($config['pass_complex'])	{		// No break statements below ...		// We require strong passwords in case pass_complex is not set or is invalid		default:		// Require mixed case letters, numbers and symbols		case 'PASS_TYPE_SYMBOL':			$chars[] = $sym;		// Require mixed case letters and numbers		case 'PASS_TYPE_ALPHA':			$chars[] = $num;		// Require mixed case letters		case 'PASS_TYPE_CASE':			$chars[] = $low;			$chars[] = $upp;	}	if ($pcre)	{		foreach ($chars as $char)		{			if (!preg_match('#' . $char . '#u', $password))			{				return 'INVALID_CHARS';			}		}	}	else if ($mbstring)	{		foreach ($chars as $char)		{			if (mb_ereg($char, $password) === false)			{				return 'INVALID_CHARS';			}		}	}	return false;}/*** Check to see if email address is banned or already present in the DB** @param string $email The email to check* @param string $allowed_email An allowed email, default being $user->data['user_email']** @return mixed Either false if validation succeeded or a string which will be used as the error message (with the variable name appended)*/function validate_email($email, $allowed_email = false){	global $config, $db, $user;	$email = strtolower($email);	$allowed_email = ($allowed_email === false) ? strtolower($user->data['user_email']) : strtolower($allowed_email);	if ($allowed_email == $email)	{		return false;	}	if (!preg_match('/^' . get_preg_expression('email') . '$/i', $email))	{		return 'EMAIL_INVALID';	}	// Check MX record.	// The idea for this is from reading the UseBB blog/announcement. :)	if ($config['email_check_mx'])	{		list(, $domain) = explode('@', $email);		if (phpbb_checkdnsrr($domain, 'A') === false && phpbb_checkdnsrr($domain, 'MX') === false)		{			return 'DOMAIN_NO_MX_RECORD';		}	}	if (($ban_reason = $user->check_ban(false, false, $email, true)) !== false)	{		return ($ban_reason === true) ? 'EMAIL_BANNED' : $ban_reason;	}	if (!$config['allow_emailreuse'])	{		$sql = 'SELECT user_email_hash			FROM ' . USERS_TABLE . "			WHERE user_email_hash = " . $db->sql_escape(phpbb_email_hash($email));		$result = $db->sql_query($sql);		$row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if ($row)		{			return 'EMAIL_TAKEN';		}	}	return false;}/*** Validate jabber address* Taken from the jabber class within flyspray (see author notes)** @author flyspray.org*/function validate_jabber($jid){	if (!$jid)	{		return false;	}	$seperator_pos = strpos($jid, '@');	if ($seperator_pos === false)	{		return 'WRONG_DATA';	}	$username = substr($jid, 0, $seperator_pos);	$realm = substr($jid, $seperator_pos + 1);	if (strlen($username) == 0 || strlen($realm) < 3)	{		return 'WRONG_DATA';	}	$arr = explode('.', $realm);	if (sizeof($arr) == 0)	{		return 'WRONG_DATA';	}	foreach ($arr as $part)	{		if (substr($part, 0, 1) == '-' || substr($part, -1, 1) == '-')		{			return 'WRONG_DATA';		}		if (!preg_match("@^[a-zA-Z0-9-.]+$@", $part))		{			return 'WRONG_DATA';		}	}	$boundary = array(array(0, 127), array(192, 223), array(224, 239), array(240, 247), array(248, 251), array(252, 253));	// Prohibited Characters RFC3454 + RFC3920	$prohibited = array(		// Table C.1.1		array(0x0020, 0x0020),		// SPACE		// Table C.1.2		array(0x00A0, 0x00A0),		// NO-BREAK SPACE		array(0x1680, 0x1680),		// OGHAM SPACE MARK		array(0x2000, 0x2001),		// EN QUAD		array(0x2001, 0x2001),		// EM QUAD		array(0x2002, 0x2002),		// EN SPACE		array(0x2003, 0x2003),		// EM SPACE		array(0x2004, 0x2004),		// THREE-PER-EM SPACE		array(0x2005, 0x2005),		// FOUR-PER-EM SPACE		array(0x2006, 0x2006),		// SIX-PER-EM SPACE		array(0x2007, 0x2007),		// FIGURE SPACE		array(0x2008, 0x2008),		// PUNCTUATION SPACE		array(0x2009, 0x2009),		// THIN SPACE		array(0x200A, 0x200A),		// HAIR SPACE		array(0x200B, 0x200B),		// ZERO WIDTH SPACE		array(0x202F, 0x202F),		// NARROW NO-BREAK SPACE		array(0x205F, 0x205F),		// MEDIUM MATHEMATICAL SPACE		array(0x3000, 0x3000),		// IDEOGRAPHIC SPACE		// Table C.2.1		array(0x0000, 0x001F),		// [CONTROL CHARACTERS]		array(0x007F, 0x007F),		// DELETE		// Table C.2.2		array(0x0080, 0x009F),		// [CONTROL CHARACTERS]		array(0x06DD, 0x06DD),		// ARABIC END OF AYAH		array(0x070F, 0x070F),		// SYRIAC ABBREVIATION MARK		array(0x180E, 0x180E),		// MONGOLIAN VOWEL SEPARATOR		array(0x200C, 0x200C), 		// ZERO WIDTH NON-JOINER		array(0x200D, 0x200D),		// ZERO WIDTH JOINER		array(0x2028, 0x2028),		// LINE SEPARATOR		array(0x2029, 0x2029),		// PARAGRAPH SEPARATOR		array(0x2060, 0x2060),		// WORD JOINER		array(0x2061, 0x2061),		// FUNCTION APPLICATION		array(0x2062, 0x2062),		// INVISIBLE TIMES		array(0x2063, 0x2063),		// INVISIBLE SEPARATOR		array(0x206A, 0x206F),		// [CONTROL CHARACTERS]		array(0xFEFF, 0xFEFF),		// ZERO WIDTH NO-BREAK SPACE		array(0xFFF9, 0xFFFC),		// [CONTROL CHARACTERS]		array(0x1D173, 0x1D17A),	// [MUSICAL CONTROL CHARACTERS]		// Table C.3		array(0xE000, 0xF8FF),		// [PRIVATE USE, PLANE 0]		array(0xF0000, 0xFFFFD),	// [PRIVATE USE, PLANE 15]		array(0x100000, 0x10FFFD),	// [PRIVATE USE, PLANE 16]		// Table C.4		array(0xFDD0, 0xFDEF),		// [NONCHARACTER CODE POINTS]		array(0xFFFE, 0xFFFF),		// [NONCHARACTER CODE POINTS]		array(0x1FFFE, 0x1FFFF),	// [NONCHARACTER CODE POINTS]		array(0x2FFFE, 0x2FFFF),	// [NONCHARACTER CODE POINTS]		array(0x3FFFE, 0x3FFFF),	// [NONCHARACTER CODE POINTS]		array(0x4FFFE, 0x4FFFF),	// [NONCHARACTER CODE POINTS]		array(0x5FFFE, 0x5FFFF),	// [NONCHARACTER CODE POINTS]		array(0x6FFFE, 0x6FFFF),	// [NONCHARACTER CODE POINTS]		array(0x7FFFE, 0x7FFFF),	// [NONCHARACTER CODE POINTS]		array(0x8FFFE, 0x8FFFF),	// [NONCHARACTER CODE POINTS]		array(0x9FFFE, 0x9FFFF),	// [NONCHARACTER CODE POINTS]		array(0xAFFFE, 0xAFFFF),	// [NONCHARACTER CODE POINTS]		array(0xBFFFE, 0xBFFFF),	// [NONCHARACTER CODE POINTS]		array(0xCFFFE, 0xCFFFF),	// [NONCHARACTER CODE POINTS]		array(0xDFFFE, 0xDFFFF),	// [NONCHARACTER CODE POINTS]		array(0xEFFFE, 0xEFFFF),	// [NONCHARACTER CODE POINTS]		array(0xFFFFE, 0xFFFFF),	// [NONCHARACTER CODE POINTS]		array(0x10FFFE, 0x10FFFF),	// [NONCHARACTER CODE POINTS]		// Table C.5		array(0xD800, 0xDFFF),		// [SURROGATE CODES]		// Table C.6		array(0xFFF9, 0xFFF9),		// INTERLINEAR ANNOTATION ANCHOR		array(0xFFFA, 0xFFFA),		// INTERLINEAR ANNOTATION SEPARATOR		array(0xFFFB, 0xFFFB),		// INTERLINEAR ANNOTATION TERMINATOR		array(0xFFFC, 0xFFFC),		// OBJECT REPLACEMENT CHARACTER		array(0xFFFD, 0xFFFD),		// REPLACEMENT CHARACTER		// Table C.7		array(0x2FF0, 0x2FFB),		// [IDEOGRAPHIC DESCRIPTION CHARACTERS]		// Table C.8		array(0x0340, 0x0340),		// COMBINING GRAVE TONE MARK		array(0x0341, 0x0341),		// COMBINING ACUTE TONE MARK		array(0x200E, 0x200E),		// LEFT-TO-RIGHT MARK		array(0x200F, 0x200F),		// RIGHT-TO-LEFT MARK		array(0x202A, 0x202A),		// LEFT-TO-RIGHT EMBEDDING		array(0x202B, 0x202B),		// RIGHT-TO-LEFT EMBEDDING		array(0x202C, 0x202C),		// POP DIRECTIONAL FORMATTING		array(0x202D, 0x202D),		// LEFT-TO-RIGHT OVERRIDE		array(0x202E, 0x202E),		// RIGHT-TO-LEFT OVERRIDE		array(0x206A, 0x206A),		// INHIBIT SYMMETRIC SWAPPING		array(0x206B, 0x206B),		// ACTIVATE SYMMETRIC SWAPPING		array(0x206C, 0x206C),		// INHIBIT ARABIC FORM SHAPING		array(0x206D, 0x206D),		// ACTIVATE ARABIC FORM SHAPING		array(0x206E, 0x206E),		// NATIONAL DIGIT SHAPES		array(0x206F, 0x206F),		// NOMINAL DIGIT SHAPES		// Table C.9		array(0xE0001, 0xE0001),	// LANGUAGE TAG		array(0xE0020, 0xE007F),	// [TAGGING CHARACTERS]		// RFC3920		array(0x22, 0x22),			// "		array(0x26, 0x26),			// &		array(0x27, 0x27),			// '		array(0x2F, 0x2F),			// /		array(0x3A, 0x3A),			// :		array(0x3C, 0x3C),			// <		array(0x3E, 0x3E),			// >		array(0x40, 0x40)			// @	);	$pos = 0;	$result = true;	while ($pos < strlen($username))	{		$len = $uni = 0;		for ($i = 0; $i <= 5; $i++)		{			if (ord($username[$pos]) >= $boundary[$i][0] && ord($username[$pos]) <= $boundary[$i][1])			{				$len = $i + 1;				$uni = (ord($username[$pos]) - $boundary[$i][0]) * pow(2, $i * 6);				for ($k = 1; $k < $len; $k++)				{					$uni += (ord($username[$pos + $k]) - 128) * pow(2, ($i - $k) * 6);				}				break;			}		}		if ($len == 0)		{			return 'WRONG_DATA';		}		foreach ($prohibited as $pval)		{			if ($uni >= $pval[0] && $uni <= $pval[1])			{				$result = false;				break 2;			}		}		$pos = $pos + $len;	}	if (!$result)	{		return 'WRONG_DATA';	}	return false;}/*** Remove avatar*/function avatar_delete($mode, $row, $clean_db = false){	global $phpbb_root_path, $config, $db, $user;	// Check if the users avatar is actually *not* a group avatar	if ($mode == 'user')	{		if (strpos($row['user_avatar'], 'g') === 0 || (((int)$row['user_avatar'] !== 0) && ((int)$row['user_avatar'] !== (int)$row['user_id'])))		{			return false;		}	}	if ($clean_db)	{		avatar_remove_db($row[$mode . '_avatar']);	}	$filename = get_avatar_filename($row[$mode . '_avatar']);	if (file_exists($phpbb_root_path . $config['avatar_path'] . '/' . $filename))	{		@unlink($phpbb_root_path . $config['avatar_path'] . '/' . $filename);		return true;	}	return false;}/*** Remote avatar linkage*/function avatar_remote($data, &$error){	global $config, $db, $user, $phpbb_root_path, $phpEx;	if (!preg_match('#^(http|https|ftp)://#i', $data['remotelink']))	{		$data['remotelink'] = 'http://' . $data['remotelink'];	}	if (!preg_match('#^(http|https|ftp)://(?:(.*?\.)*?[a-z0-9\-]+?\.[a-z]{2,4}|(?:\d{1,3}\.){3,5}\d{1,3}):?([0-9]*?).*?\.(gif|jpg|jpeg|png)$#i', $data['remotelink']))	{		$error[] = $user->lang['AVATAR_URL_INVALID'];		return false;	}	// Make sure getimagesize works...	if (($image_data = @getimagesize($data['remotelink'])) === false && (empty($data['width']) || empty($data['height'])))	{		$error[] = $user->lang['UNABLE_GET_IMAGE_SIZE'];		return false;	}	if (!empty($image_data) && ($image_data[0] < 2 || $image_data[1] < 2))	{		$error[] = $user->lang['AVATAR_NO_SIZE'];		return false;	}	$width = ($data['width'] && $data['height']) ? $data['width'] : $image_data[0];	$height = ($data['width'] && $data['height']) ? $data['height'] : $image_data[1];	if ($width < 2 || $height < 2)	{		$error[] = $user->lang['AVATAR_NO_SIZE'];		return false;	}	// Check image type	include_once($phpbb_root_path . 'includes/functions_upload.' . $phpEx);	$types = fileupload::image_types();	$extension = strtolower(filespec::get_extension($data['remotelink']));	if (!empty($image_data) && (!isset($types[$image_data[2]]) || !in_array($extension, $types[$image_data[2]])))	{		if (!isset($types[$image_data[2]]))		{			$error[] = $user->lang['UNABLE_GET_IMAGE_SIZE'];		}		else		{			$error[] = sprintf($user->lang['IMAGE_FILETYPE_MISMATCH'], $types[$image_data[2]][0], $extension);		}		return false;	}	if ($config['avatar_max_width'] || $config['avatar_max_height'])	{		if ($width > $config['avatar_max_width'] || $height > $config['avatar_max_height'])		{			$error[] = sprintf($user->lang['AVATAR_WRONG_SIZE'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height'], $width, $height);			return false;		}	}	if ($config['avatar_min_width'] || $config['avatar_min_height'])	{		if ($width < $config['avatar_min_width'] || $height < $config['avatar_min_height'])		{			$error[] = sprintf($user->lang['AVATAR_WRONG_SIZE'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height'], $width, $height);			return false;		}	}	return array(AVATAR_REMOTE, $data['remotelink'], $width, $height);}/*** Avatar upload using the upload class*/function avatar_upload($data, &$error){	global $phpbb_root_path, $config, $db, $user, $phpEx;	// Init upload class	include_once($phpbb_root_path . 'includes/functions_upload.' . $phpEx);	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height'], (isset($config['mime_triggers']) ? explode('|', $config['mime_triggers']) : false));	if (!empty($_FILES['uploadfile']['name']))	{		$file = $upload->form_upload('uploadfile');	}	else	{		$file = $upload->remote_upload($data['uploadurl']);	}	$prefix = $config['avatar_salt'] . '_';	$file->clean_filename('avatar', $prefix, $data['user_id']);	$destination = $config['avatar_path'];	// Adjust destination path (no trailing slash)	if (substr($destination, -1, 1) == '/' || substr($destination, -1, 1) == '\\')	{		$destination = substr($destination, 0, -1);	}	$destination = str_replace(array('../', '..\\', './', '.\\'), '', $destination);	if ($destination && ($destination[0] == '/' || $destination[0] == "\\"))	{		$destination = '';	}	// Move file and overwrite any existing image	$file->move_file($destination, true);	if (sizeof($file->error))	{		$file->remove();		$error = array_merge($error, $file->error);	}	return array(AVATAR_UPLOAD, $data['user_id'] . '_' . time() . '.' . $file->get('extension'), $file->get('width'), $file->get('height'));}/*** Generates avatar filename from the database entry*/function get_avatar_filename($avatar_entry){	global $config;	if ($avatar_entry[0] === 'g')	{		$avatar_group = true;		$avatar_entry = substr($avatar_entry, 1);	}	else	{		$avatar_group = false;	}	$ext 			= substr(strrchr($avatar_entry, '.'), 1);	$avatar_entry	= intval($avatar_entry);	return $config['avatar_salt'] . '_' . (($avatar_group) ? 'g' : '') . $avatar_entry . '.' . $ext;}/*** Avatar Gallery*/function avatar_gallery($category, $avatar_select, $items_per_column, $block_var = 'avatar_row'){	global $user, $cache, $template;	global $config, $phpbb_root_path;	$avatar_list = array();	$path = $phpbb_root_path . $config['avatar_gallery_path'];	if (!file_exists($path) || !is_dir($path))	{		$avatar_list = array($user->lang['NO_AVATAR_CATEGORY'] => array());	}	else	{		// Collect images		$dp = @opendir($path);		if (!$dp)		{			return array($user->lang['NO_AVATAR_CATEGORY'] => array());		}		while (($file = readdir($dp)) !== false)		{			if ($file[0] != '.' && preg_match('#^[^&"\'<>]+$#i', $file) && is_dir("$path/$file"))			{				$avatar_row_count = $avatar_col_count = 0;				if ($dp2 = @opendir("$path/$file"))				{					while (($sub_file = readdir($dp2)) !== false)					{						if (preg_match('#^[^&\'"<>]+\.(?:gif|png|jpe?g)$#i', $sub_file))						{							$avatar_list[$file][$avatar_row_count][$avatar_col_count] = array(								'file'		=> rawurlencode($file) . '/' . rawurlencode($sub_file),								'filename'	=> rawurlencode($sub_file),								'name'		=> ucfirst(str_replace('_', ' ', preg_replace('#^(.*)\..*$#', '\1', $sub_file))),							);							$avatar_col_count++;							if ($avatar_col_count == $items_per_column)							{								$avatar_row_count++;								$avatar_col_count = 0;							}						}					}					closedir($dp2);				}			}		}		closedir($dp);	}	if (!sizeof($avatar_list))	{		$avatar_list = array($user->lang['NO_AVATAR_CATEGORY'] => array());	}	@ksort($avatar_list);	$category = (!$category) ? key($avatar_list) : $category;	$avatar_categories = array_keys($avatar_list);	$s_category_options = '';	foreach ($avatar_categories as $cat)	{		$s_category_options .= '<option value="' . $cat . '"' . (($cat == $category) ? ' selected="selected"' : '') . '>' . $cat . '</option>';	}	$template->assign_vars(array(		'S_AVATARS_ENABLED'		=> true,		'S_IN_AVATAR_GALLERY'	=> true,		'S_CAT_OPTIONS'			=> $s_category_options)	);	$avatar_list = (isset($avatar_list[$category])) ? $avatar_list[$category] : array();	foreach ($avatar_list as $avatar_row_ary)	{		$template->assign_block_vars($block_var, array());		foreach ($avatar_row_ary as $avatar_col_ary)		{			$template->assign_block_vars($block_var . '.avatar_column', array(				'AVATAR_IMAGE'	=> $phpbb_root_path . $config['avatar_gallery_path'] . '/' . $avatar_col_ary['file'],				'AVATAR_NAME'	=> $avatar_col_ary['name'],				'AVATAR_FILE'	=> $avatar_col_ary['filename'])			);			$template->assign_block_vars($block_var . '.avatar_option_column', array(				'AVATAR_IMAGE'	=> $phpbb_root_path . $config['avatar_gallery_path'] . '/' . $avatar_col_ary['file'],				'S_OPTIONS_AVATAR'	=> $avatar_col_ary['filename'])			);		}	}	return $avatar_list;}/*** Tries to (re-)establish avatar dimensions*/function avatar_get_dimensions($avatar, $avatar_type, &$error, $current_x = 0, $current_y = 0){	global $config, $phpbb_root_path, $user;	switch ($avatar_type)	{		case AVATAR_REMOTE :			break;		case AVATAR_UPLOAD :			$avatar = $phpbb_root_path . $config['avatar_path'] . '/' . get_avatar_filename($avatar);			break;		case AVATAR_GALLERY :			$avatar = $phpbb_root_path . $config['avatar_gallery_path'] . '/' . $avatar ;			break;	}	// Make sure getimagesize works...	if (($image_data = @getimagesize($avatar)) === false)	{		$error[] = $user->lang['UNABLE_GET_IMAGE_SIZE'];		return false;	}	if ($image_data[0] < 2 || $image_data[1] < 2)	{		$error[] = $user->lang['AVATAR_NO_SIZE'];		return false;	}	// try to maintain ratio	if (!(empty($current_x) && empty($current_y)))	{		if ($current_x != 0)		{			$image_data[1] = (int) floor(($current_x / $image_data[0]) * $image_data[1]);			$image_data[1] = min($config['avatar_max_height'], $image_data[1]);			$image_data[1] = max($config['avatar_min_height'], $image_data[1]);		}		if ($current_y != 0)		{			$image_data[0] = (int) floor(($current_y / $image_data[1]) * $image_data[0]);			$image_data[0] = min($config['avatar_max_width'], $image_data[1]);			$image_data[0] = max($config['avatar_min_width'], $image_data[1]);		}	}	return array($image_data[0], $image_data[1]);}/*** Uploading/Changing user avatar*/function avatar_process_user(&$error, $custom_userdata = false, $can_upload = null){	global $config, $phpbb_root_path, $auth, $user, $db;	$data = array(		'uploadurl'		=> request_var('uploadurl', ''),		'remotelink'	=> request_var('remotelink', ''),		'width'			=> request_var('width', 0),		'height'		=> request_var('height', 0),	);	$error = validate_data($data, array(		'uploadurl'		=> array('string', true, 5, 255),		'remotelink'	=> array('string', true, 5, 255),		'width'			=> array('string', true, 1, 3),		'height'		=> array('string', true, 1, 3),	));	if (sizeof($error))	{		return false;	}	$sql_ary = array();	if ($custom_userdata === false)	{		$userdata = &$user->data;	}	else	{		$userdata = &$custom_userdata;	}	$data['user_id'] = $userdata['user_id'];	$change_avatar = ($custom_userdata === false) ? $auth->acl_get('u_chgavatar') : true;	$avatar_select = basename(request_var('avatar_select', ''));	// Can we upload?	if (is_null($can_upload))	{		$can_upload = ($config['allow_avatar_upload'] && file_exists($phpbb_root_path . $config['avatar_path']) && phpbb_is_writable($phpbb_root_path . $config['avatar_path']) && $change_avatar && (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on')) ? true : false;	}	if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) && $can_upload)	{		list($sql_ary['user_avatar_type'], $sql_ary['user_avatar'], $sql_ary['user_avatar_width'], $sql_ary['user_avatar_height']) = avatar_upload($data, $error);	}	else if ($data['remotelink'] && $change_avatar && $config['allow_avatar_remote'])	{		list($sql_ary['user_avatar_type'], $sql_ary['user_avatar'], $sql_ary['user_avatar_width'], $sql_ary['user_avatar_height']) = avatar_remote($data, $error);	}	else if ($avatar_select && $change_avatar && $config['allow_avatar_local'])	{		$category = basename(request_var('category', ''));		$sql_ary['user_avatar_type'] = AVATAR_GALLERY;		$sql_ary['user_avatar'] = $avatar_select;		// check avatar gallery		if (!is_dir($phpbb_root_path . $config['avatar_gallery_path'] . '/' . $category))		{			$sql_ary['user_avatar'] = '';			$sql_ary['user_avatar_type'] = $sql_ary['user_avatar_width'] = $sql_ary['user_avatar_height'] = 0;		}		else		{			list($sql_ary['user_avatar_width'], $sql_ary['user_avatar_height']) = getimagesize($phpbb_root_path . $config['avatar_gallery_path'] . '/' . $category . '/' . urldecode($sql_ary['user_avatar']));			$sql_ary['user_avatar'] = $category . '/' . $sql_ary['user_avatar'];		}	}	else if (isset($_POST['delete']) && $change_avatar)	{		$sql_ary['user_avatar'] = '';		$sql_ary['user_avatar_type'] = $sql_ary['user_avatar_width'] = $sql_ary['user_avatar_height'] = 0;	}	else if (!empty($userdata['user_avatar']))	{		// Only update the dimensions		if (empty($data['width']) || empty($data['height']))		{			if ($dims = avatar_get_dimensions($userdata['user_avatar'], $userdata['user_avatar_type'], $error, $data['width'], $data['height']))			{				list($guessed_x, $guessed_y) = $dims;				if (empty($data['width']))				{					$data['width'] = $guessed_x;				}				if (empty($data['height']))				{					$data['height'] = $guessed_y;				}			}		}		if (($config['avatar_max_width'] || $config['avatar_max_height']) &&			(($data['width'] != $userdata['user_avatar_width']) || $data['height'] != $userdata['user_avatar_height']))		{			if ($data['width'] > $config['avatar_max_width'] || $data['height'] > $config['avatar_max_height'])			{				$error[] = sprintf($user->lang['AVATAR_WRONG_SIZE'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height'], $data['width'], $data['height']);			}		}		if (!sizeof($error))		{			if ($config['avatar_min_width'] || $config['avatar_min_height'])			{				if ($data['width'] < $config['avatar_min_width'] || $data['height'] < $config['avatar_min_height'])				{					$error[] = sprintf($user->lang['AVATAR_WRONG_SIZE'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height'], $data['width'], $data['height']);				}			}		}		if (!sizeof($error))		{			$sql_ary['user_avatar_width'] = $data['width'];			$sql_ary['user_avatar_height'] = $data['height'];		}	}	if (!sizeof($error))	{		// Do we actually have any data to update?		if (sizeof($sql_ary))		{			$ext_new = $ext_old = '';			if (isset($sql_ary['user_avatar']))			{				$userdata = ($custom_userdata === false) ? $user->data : $custom_userdata;				$ext_new = (empty($sql_ary['user_avatar'])) ? '' : substr(strrchr($sql_ary['user_avatar'], '.'), 1);				$ext_old = (empty($userdata['user_avatar'])) ? '' : substr(strrchr($userdata['user_avatar'], '.'), 1);				if ($userdata['user_avatar_type'] == AVATAR_UPLOAD)				{					// Delete old avatar if present					if ((!empty($userdata['user_avatar']) && empty($sql_ary['user_avatar']))					   || ( !empty($userdata['user_avatar']) && !empty($sql_ary['user_avatar']) && $ext_new !== $ext_old))					{						avatar_delete('user', $userdata);					}				}			}			$sql = 'UPDATE ' . USERS_TABLE . '				SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '				WHERE user_id = ' . (($custom_userdata === false) ? $user->data['user_id'] : $custom_userdata['user_id']);			$db->sql_query($sql);		}	}	return (sizeof($error)) ? false : true;}//// Usergroup functions///*** Add or edit a group. If we're editing a group we only update user* parameters such as rank, etc. if they are changed*/function group_create(&$group_id, $type, $name, $desc, $group_attributes, $allow_desc_bbcode = false, $allow_desc_urls = false, $allow_desc_smilies = false){	global $phpbb_root_path, $config, $db, $user, $file_upload;	$error = array();	// Attributes which also affect the users table	$user_attribute_ary = array('group_colour', 'group_rank', 'group_avatar', 'group_avatar_type', 'group_avatar_width', 'group_avatar_height');	// Check data. Limit group name length.	if (!utf8_strlen($name) || utf8_strlen($name) > 60)	{		$error[] = (!utf8_strlen($name)) ? $user->lang['GROUP_ERR_USERNAME'] : $user->lang['GROUP_ERR_USER_LONG'];	}	$err = group_validate_groupname($group_id, $name);	if (!empty($err))	{		$error[] = $user->lang[$err];	}	if (!in_array($type, array(GROUP_OPEN, GROUP_CLOSED, GROUP_HIDDEN, GROUP_SPECIAL, GROUP_FREE)))	{		$error[] = $user->lang['GROUP_ERR_TYPE'];	}	if (!sizeof($error))	{		$user_ary = array();		$sql_ary = array(			'group_name'			=> (string) $name,			'group_desc'			=> (string) $desc,			'group_desc_uid'		=> '',			'group_desc_bitfield'	=> '',			'group_type'			=> (int) $type,		);		// Parse description		if ($desc)		{			generate_text_for_storage($sql_ary['group_desc'], $sql_ary['group_desc_uid'], $sql_ary['group_desc_bitfield'], $sql_ary['group_desc_options'], $allow_desc_bbcode, $allow_desc_urls, $allow_desc_smilies);		}		if (sizeof($group_attributes))		{			// Merge them with $sql_ary to properly update the group			$sql_ary = array_merge($sql_ary, $group_attributes);		}		// Setting the log message before we set the group id (if group gets added)		$log = ($group_id) ? 'LOG_GROUP_UPDATED' : 'LOG_GROUP_CREATED';		$query = '';		if ($group_id)		{			$sql = 'SELECT user_id				FROM ' . USERS_TABLE . '				WHERE group_id = ' . $group_id;			$result = $db->sql_query($sql);			while ($row = $db->sql_fetchrow($result))			{				$user_ary[] = $row['user_id'];			}			$db->sql_freeresult($result);			if (isset($sql_ary['group_avatar']) && !$sql_ary['group_avatar'])			{				remove_default_avatar($group_id, $user_ary);			}			if (isset($sql_ary['group_rank']) && !$sql_ary['group_rank'])			{				remove_default_rank($group_id, $user_ary);			}			$sql = 'UPDATE ' . GROUPS_TABLE . '				SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "				WHERE group_id = $group_id";			$db->sql_query($sql);			// Since we may update the name too, we need to do this on other tables too...			$sql = 'UPDATE ' . MODERATOR_CACHE_TABLE . "				SET group_name = '" . $db->sql_escape($sql_ary['group_name']) . "'				WHERE group_id = $group_id";			$db->sql_query($sql);			// One special case is the group skip auth setting. If this was changed we need to purge permissions for this group			if (isset($group_attributes['group_skip_auth']))			{				// Get users within this group...				$sql = 'SELECT user_id					FROM ' . USER_GROUP_TABLE . '					WHERE group_id = ' . $group_id . '						AND user_pending = 0';				$result = $db->sql_query($sql);				$user_id_ary = array();				while ($row = $db->sql_fetchrow($result))				{					$user_id_ary[] = $row['user_id'];				}				$db->sql_freeresult($result);				if (!empty($user_id_ary))				{					global $auth;					// Clear permissions cache of relevant users					$auth->acl_clear_prefetch($user_id_ary);				}			}		}		else		{			$sql = 'INSERT INTO ' . GROUPS_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary);			$db->sql_query($sql);		}		if (!$group_id)		{			$group_id = $db->sql_nextid();			if (isset($sql_ary['group_avatar_type']) && $sql_ary['group_avatar_type'] == AVATAR_UPLOAD)			{				group_correct_avatar($group_id, $sql_ary['group_avatar']);			}		}		// Set user attributes		$sql_ary = array();		if (sizeof($group_attributes))		{			// Go through the user attributes array, check if a group attribute matches it and then set it. ;)			foreach ($user_attribute_ary as $attribute)			{				if (!isset($group_attributes[$attribute]))				{					continue;				}				// If we are about to set an avatar, we will not overwrite user avatars if no group avatar is set...				if (strpos($attribute, 'group_avatar') === 0 && !$group_attributes[$attribute])				{					continue;				}				$sql_ary[$attribute] = $group_attributes[$attribute];			}		}		if (sizeof($sql_ary) && sizeof($user_ary))		{			group_set_user_default($group_id, $user_ary, $sql_ary);		}		$name = ($type == GROUP_SPECIAL) ? $user->lang['G_' . $name] : $name;		add_log('admin', $log, $name);		group_update_listings($group_id);	}	return (sizeof($error)) ? $error : false;}/*** Changes a group avatar's filename to conform to the naming scheme*/function group_correct_avatar($group_id, $old_entry){	global $config, $db, $phpbb_root_path;	$group_id		= (int)$group_id;	$ext 			= substr(strrchr($old_entry, '.'), 1);	$old_filename 	= get_avatar_filename($old_entry);	$new_filename 	= $config['avatar_salt'] . "_g$group_id.$ext";	$new_entry 		= 'g' . $group_id . '_' . substr(time(), -5) . ".$ext";	$avatar_path = $phpbb_root_path . $config['avatar_path'];	if (@rename($avatar_path . '/'. $old_filename, $avatar_path . '/' . $new_filename))	{		$sql = 'UPDATE ' . GROUPS_TABLE . '			SET group_avatar = \'' . $db->sql_escape($new_entry) . "'			WHERE group_id = $group_id";		$db->sql_query($sql);	}}/*** Remove avatar also for users not having the group as default*/function avatar_remove_db($avatar_name){	global $config, $db;	$sql = 'UPDATE ' . USERS_TABLE . "		SET user_avatar = '',		user_avatar_type = 0		WHERE user_avatar = '" . $db->sql_escape($avatar_name) . '\'';	$db->sql_query($sql);}/*** Group Delete*/function group_delete($group_id, $group_name = false){	global $db, $phpbb_root_path, $phpEx;	if (!$group_name)	{		$group_name = get_group_name($group_id);	}	$start = 0;	do	{		$user_id_ary = $username_ary = array();		// Batch query for group members, call group_user_del		$sql = 'SELECT u.user_id, u.username			FROM ' . USER_GROUP_TABLE . ' ug, ' . USERS_TABLE . " u			WHERE ug.group_id = $group_id				AND u.user_id = ug.user_id";		$result = $db->sql_query_limit($sql, 200, $start);		if ($row = $db->sql_fetchrow($result))		{			do			{				$user_id_ary[] = $row['user_id'];				$username_ary[] = $row['username'];				$start++;			}			while ($row = $db->sql_fetchrow($result));			group_user_del($group_id, $user_id_ary, $username_ary, $group_name);		}		else		{			$start = 0;		}		$db->sql_freeresult($result);	}	while ($start);	// Delete group	$sql = 'DELETE FROM ' . GROUPS_TABLE . "		WHERE group_id = $group_id";	$db->sql_query($sql);	// Delete auth entries from the groups table	$sql = 'DELETE FROM ' . ACL_GROUPS_TABLE . "		WHERE group_id = $group_id";	$db->sql_query($sql);	// Re-cache moderators	if (!function_exists('cache_moderators'))	{		include($phpbb_root_path . 'includes/functions_admin.' . $phpEx);	}	cache_moderators();	add_log('admin', 'LOG_GROUP_DELETE', $group_name);	// Return false - no error	return false;}/*** Add user(s) to group** @return mixed false if no errors occurred, else the user lang string for the relevant error, for example 'NO_USER'*/function group_user_add($group_id, $user_id_ary = false, $username_ary = false, $group_name = false, $default = false, $leader = 0, $pending = 0, $group_attributes = false){	global $db, $auth;	// We need both username and user_id info	$result = user_get_id_name($user_id_ary, $username_ary);	if (!sizeof($user_id_ary) || $result !== false)	{		return 'NO_USER';	}	// Remove users who are already members of this group	$sql = 'SELECT user_id, group_leader		FROM ' . USER_GROUP_TABLE . '		WHERE ' . $db->sql_in_set('user_id', $user_id_ary) . "			AND group_id = $group_id";	$result = $db->sql_query($sql);	$add_id_ary = $update_id_ary = array();	while ($row = $db->sql_fetchrow($result))	{		$add_id_ary[] = (int) $row['user_id'];		if ($leader && !$row['group_leader'])		{			$update_id_ary[] = (int) $row['user_id'];		}	}	$db->sql_freeresult($result);	// Do all the users exist in this group?	$add_id_ary = array_diff($user_id_ary, $add_id_ary);	// If we have no users	if (!sizeof($add_id_ary) && !sizeof($update_id_ary))	{		return 'GROUP_USERS_EXIST';	}	$db->sql_transaction('begin');	// Insert the new users	if (sizeof($add_id_ary))	{		$sql_ary = array();		foreach ($add_id_ary as $user_id)		{			$sql_ary[] = array(				'user_id'		=> (int) $user_id,				'group_id'		=> (int) $group_id,				'group_leader'	=> (int) $leader,				'user_pending'	=> (int) $pending,			);		}		$db->sql_multi_insert(USER_GROUP_TABLE, $sql_ary);	}	if (sizeof($update_id_ary))	{		$sql = 'UPDATE ' . USER_GROUP_TABLE . '			SET group_leader = 1			WHERE ' . $db->sql_in_set('user_id', $update_id_ary) . "				AND group_id = $group_id";		$db->sql_query($sql);	}	if ($default)	{		group_user_attributes('default', $group_id, $user_id_ary, false, $group_name, $group_attributes);	}	$db->sql_transaction('commit');	// Clear permissions cache of relevant users	$auth->acl_clear_prefetch($user_id_ary);	if (!$group_name)	{		$group_name = get_group_name($group_id);	}	$log = ($leader) ? 'LOG_MODS_ADDED' : (($pending) ? 'LOG_USERS_PENDING' : 'LOG_USERS_ADDED');	add_log('admin', $log, $group_name, implode(', ', $username_ary));	group_update_listings($group_id);	// Return false - no error	return false;}/*** Remove a user/s from a given group. When we remove users we update their* default group_id. We do this by examining which "special" groups they belong* to. The selection is made based on a reasonable priority system** @return false if no errors occurred, else the user lang string for the relevant error, for example 'NO_USER'*/function group_user_del($group_id, $user_id_ary = false, $username_ary = false, $group_name = false){	global $db, $auth, $config;	if ($config['coppa_enable'])	{		$group_order = array('ADMINISTRATORS', 'GLOBAL_MODERATORS', 'NEWLY_REGISTERED', 'REGISTERED_COPPA', 'REGISTERED', 'BOTS', 'GUESTS');	}	else	{		$group_order = array('ADMINISTRATORS', 'GLOBAL_MODERATORS', 'NEWLY_REGISTERED', 'REGISTERED', 'BOTS', 'GUESTS');	}	// We need both username and user_id info	$result = user_get_id_name($user_id_ary, $username_ary);	if (!sizeof($user_id_ary) || $result !== false)	{		return 'NO_USER';	}	$sql = 'SELECT *		FROM ' . GROUPS_TABLE . '		WHERE ' . $db->sql_in_set('group_name', $group_order);	$result = $db->sql_query($sql);	$group_order_id = $special_group_data = array();	while ($row = $db->sql_fetchrow($result))	{		$group_order_id[$row['group_name']] = $row['group_id'];		$special_group_data[$row['group_id']] = array(			'group_colour'			=> $row['group_colour'],			'group_rank'				=> $row['group_rank'],		);		// Only set the group avatar if one is defined...		if ($row['group_avatar'])		{			$special_group_data[$row['group_id']] = array_merge($special_group_data[$row['group_id']], array(				'group_avatar'			=> $row['group_avatar'],				'group_avatar_type'		=> $row['group_avatar_type'],				'group_avatar_width'		=> $row['group_avatar_width'],				'group_avatar_height'	=> $row['group_avatar_height'])			);		}	}	$db->sql_freeresult($result);	// Get users default groups - we only need to reset default group membership if the group from which the user gets removed is set as default	$sql = 'SELECT user_id, group_id		FROM ' . USERS_TABLE . '		WHERE ' . $db->sql_in_set('user_id', $user_id_ary);	$result = $db->sql_query($sql);	$default_groups = array();	while ($row = $db->sql_fetchrow($result))	{		$default_groups[$row['user_id']] = $row['group_id'];	}	$db->sql_freeresult($result);	// What special group memberships exist for these users?	$sql = 'SELECT g.group_id, g.group_name, ug.user_id		FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . ' g		WHERE ' . $db->sql_in_set('ug.user_id', $user_id_ary) . "			AND g.group_id = ug.group_id			AND g.group_id <> $group_id			AND g.group_type = " . GROUP_SPECIAL . '		ORDER BY ug.user_id, g.group_id';	$result = $db->sql_query($sql);	$temp_ary = array();	while ($row = $db->sql_fetchrow($result))	{		if ($default_groups[$row['user_id']] == $group_id && (!isset($temp_ary[$row['user_id']]) || $group_order_id[$row['group_name']] < $temp_ary[$row['user_id']]))		{			$temp_ary[$row['user_id']] = $row['group_id'];		}	}	$db->sql_freeresult($result);	// sql_where_ary holds the new default groups and their users	$sql_where_ary = array();	foreach ($temp_ary as $uid => $gid)	{		$sql_where_ary[$gid][] = $uid;	}	unset($temp_ary);	foreach ($special_group_data as $gid => $default_data_ary)	{		if (isset($sql_where_ary[$gid]) && sizeof($sql_where_ary[$gid]))		{			remove_default_rank($group_id, $sql_where_ary[$gid]);			remove_default_avatar($group_id, $sql_where_ary[$gid]);			group_set_user_default($gid, $sql_where_ary[$gid], $default_data_ary);		}	}	unset($special_group_data);	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . "		WHERE group_id = $group_id			AND " . $db->sql_in_set('user_id', $user_id_ary);	$db->sql_query($sql);	// Clear permissions cache of relevant users	$auth->acl_clear_prefetch($user_id_ary);	if (!$group_name)	{		$group_name = get_group_name($group_id);	}	$log = 'LOG_GROUP_REMOVE';	if ($group_name)	{		add_log('admin', $log, $group_name, implode(', ', $username_ary));	}	group_update_listings($group_id);	// Return false - no error	return false;}/*** Removes the group avatar of the default group from the users in user_ids who have that group as default.*/function remove_default_avatar($group_id, $user_ids){	global $db;	if (!is_array($user_ids))	{		$user_ids = array($user_ids);	}	if (empty($user_ids))	{		return false;	}	$user_ids = array_map('intval', $user_ids);	$sql = 'SELECT *		FROM ' . GROUPS_TABLE . '		WHERE group_id = ' . (int)$group_id;	$result = $db->sql_query($sql);	if (!$row = $db->sql_fetchrow($result))	{		$db->sql_freeresult($result);		return false;	}	$db->sql_freeresult($result);	$sql = 'UPDATE ' . USERS_TABLE . "		SET user_avatar = '',			user_avatar_type = 0,			user_avatar_width = 0,			user_avatar_height = 0		WHERE group_id = " . (int) $group_id . "		AND user_avatar = '" . $db->sql_escape($row['group_avatar']) . "'		AND " . $db->sql_in_set('user_id', $user_ids);	$db->sql_query($sql);}/*** Removes the group rank of the default group from the users in user_ids who have that group as default.*/function remove_default_rank($group_id, $user_ids){	global $db;	if (!is_array($user_ids))	{		$user_ids = array($user_ids);	}	if (empty($user_ids))	{		return false;	}	$user_ids = array_map('intval', $user_ids);	$sql = 'SELECT *		FROM ' . GROUPS_TABLE . '		WHERE group_id = ' . (int)$group_id;	$result = $db->sql_query($sql);	if (!$row = $db->sql_fetchrow($result))	{		$db->sql_freeresult($result);		return false;	}	$db->sql_freeresult($result);	$sql = 'UPDATE ' . USERS_TABLE . '		SET user_rank = 0		WHERE group_id = ' . (int)$group_id . '		AND user_rank <> 0		AND user_rank = ' . (int)$row['group_rank'] . '		AND ' . $db->sql_in_set('user_id', $user_ids);	$db->sql_query($sql);}/*** This is used to promote (to leader), demote or set as default a member/s*/function group_user_attributes($action, $group_id, $user_id_ary = false, $username_ary = false, $group_name = false, $group_attributes = false){	global $db, $auth, $phpbb_root_path, $phpEx, $config;	// We need both username and user_id info	$result = user_get_id_name($user_id_ary, $username_ary);	if (!sizeof($user_id_ary) || $result !== false)	{		return 'NO_USERS';	}	if (!$group_name)	{		$group_name = get_group_name($group_id);	}	switch ($action)	{		case 'demote':		case 'promote':			$sql = 'SELECT user_id FROM ' . USER_GROUP_TABLE . "				WHERE group_id = $group_id					AND user_pending = 1					AND " . $db->sql_in_set('user_id', $user_id_ary);			$result = $db->sql_query_limit($sql, 1);			$not_empty = ($db->sql_fetchrow($result));			$db->sql_freeresult($result);			if ($not_empty)			{				return 'NO_VALID_USERS';			}			$sql = 'UPDATE ' . USER_GROUP_TABLE . '				SET group_leader = ' . (($action == 'promote') ? 1 : 0) . "				WHERE group_id = $group_id					AND user_pending = 0					AND " . $db->sql_in_set('user_id', $user_id_ary);			$db->sql_query($sql);			$log = ($action == 'promote') ? 'LOG_GROUP_PROMOTED' : 'LOG_GROUP_DEMOTED';		break;		case 'approve':			// Make sure we only approve those which are pending ;)			$sql = 'SELECT u.user_id, u.user_email, u.username, u.username_clean, u.user_notify_type, u.user_jabber, u.user_lang				FROM ' . USERS_TABLE . ' u, ' . USER_GROUP_TABLE . ' ug				WHERE ug.group_id = ' . $group_id . '					AND ug.user_pending = 1					AND ug.user_id = u.user_id					AND ' . $db->sql_in_set('ug.user_id', $user_id_ary);			$result = $db->sql_query($sql);			$user_id_ary = $email_users = array();			while ($row = $db->sql_fetchrow($result))			{				$user_id_ary[] = $row['user_id'];				$email_users[] = $row;			}			$db->sql_freeresult($result);			if (!sizeof($user_id_ary))			{				return false;			}			$sql = 'UPDATE ' . USER_GROUP_TABLE . "				SET user_pending = 0				WHERE group_id = $group_id					AND " . $db->sql_in_set('user_id', $user_id_ary);			$db->sql_query($sql);			// Send approved email to users...			include_once($phpbb_root_path . 'includes/functions_messenger.' . $phpEx);			$messenger = new messenger();			foreach ($email_users as $row)			{				$messenger->template('group_approved', $row['user_lang']);				$messenger->to($row['user_email'], $row['username']);				$messenger->im($row['user_jabber'], $row['username']);				$messenger->assign_vars(array(					'USERNAME'		=> htmlspecialchars_decode($row['username']),					'GROUP_NAME'	=> htmlspecialchars_decode($group_name),					'U_GROUP'		=> generate_board_url() . "/ucp.$phpEx?i=groups&mode=membership")				);				$messenger->send($row['user_notify_type']);			}			$messenger->save_queue();			$log = 'LOG_USERS_APPROVED';		break;		case 'default':			// We only set default group for approved members of the group			$sql = 'SELECT user_id				FROM ' . USER_GROUP_TABLE . "				WHERE group_id = $group_id					AND user_pending = 0					AND " . $db->sql_in_set('user_id', $user_id_ary);			$result = $db->sql_query($sql);			$user_id_ary = $username_ary = array();			while ($row = $db->sql_fetchrow($result))			{				$user_id_ary[] = $row['user_id'];			}			$db->sql_freeresult($result);			$result = user_get_id_name($user_id_ary, $username_ary);			if (!sizeof($user_id_ary) || $result !== false)			{				return 'NO_USERS';			}			$sql = 'SELECT user_id, group_id FROM ' . USERS_TABLE . '				WHERE ' . $db->sql_in_set('user_id', $user_id_ary, false, true);			$result = $db->sql_query($sql);			$groups = array();			while ($row = $db->sql_fetchrow($result))			{				if (!isset($groups[$row['group_id']]))				{					$groups[$row['group_id']] = array();				}				$groups[$row['group_id']][] = $row['user_id'];			}			$db->sql_freeresult($result);			foreach ($groups as $gid => $uids)			{				remove_default_rank($gid, $uids);				remove_default_avatar($gid, $uids);			}			group_set_user_default($group_id, $user_id_ary, $group_attributes);			$log = 'LOG_GROUP_DEFAULTS';		break;	}	// Clear permissions cache of relevant users	$auth->acl_clear_prefetch($user_id_ary);	add_log('admin', $log, $group_name, implode(', ', $username_ary));	group_update_listings($group_id);	return false;}/*** A small version of validate_username to check for a group name's existence. To be called directly.*/function group_validate_groupname($group_id, $group_name){	global $config, $db;	$group_name =  utf8_clean_string($group_name);	if (!empty($group_id))	{		$sql = 'SELECT group_name			FROM ' . GROUPS_TABLE . '			WHERE group_id = ' . (int) $group_id;		$result = $db->sql_query($sql);		$row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$row)		{			return false;		}		$allowed_groupname = utf8_clean_string($row['group_name']);		if ($allowed_groupname == $group_name)		{			return false;		}	}	$sql = 'SELECT group_name		FROM ' . GROUPS_TABLE . "		WHERE LOWER(group_name) = '" . $db->sql_escape(utf8_strtolower($group_name)) . "'";	$result = $db->sql_query($sql);	$row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if ($row)	{		return 'GROUP_NAME_TAKEN';	}	return false;}/*** Set users default group** @access private*/function group_set_user_default($group_id, $user_id_ary, $group_attributes = false, $update_listing = false){	global $cache, $db;	if (empty($user_id_ary))	{		return;	}	$attribute_ary = array(		'group_colour'			=> 'string',		'group_rank'			=> 'int',		'group_avatar'			=> 'string',		'group_avatar_type'		=> 'int',		'group_avatar_width'	=> 'int',		'group_avatar_height'	=> 'int',	);	$sql_ary = array(		'group_id'		=> $group_id	);	// Were group attributes passed to the function? If not we need to obtain them	if ($group_attributes === false)	{		$sql = 'SELECT ' . implode(', ', array_keys($attribute_ary)) . '			FROM ' . GROUPS_TABLE . "			WHERE group_id = $group_id";		$result = $db->sql_query($sql);		$group_attributes = $db->sql_fetchrow($result);		$db->sql_freeresult($result);	}	foreach ($attribute_ary as $attribute => $type)	{		if (isset($group_attributes[$attribute]))		{			// If we are about to set an avatar or rank, we will not overwrite with empty, unless we are not actually changing the default group			if ((strpos($attribute, 'group_avatar') === 0 || strpos($attribute, 'group_rank') === 0) && !$group_attributes[$attribute])			{				continue;			}			settype($group_attributes[$attribute], $type);			$sql_ary[str_replace('group_', 'user_', $attribute)] = $group_attributes[$attribute];		}	}	// Before we update the user attributes, we will make a list of those having now the group avatar assigned	if (isset($sql_ary['user_avatar']))	{		// Ok, get the original avatar data from users having an uploaded one (we need to remove these from the filesystem)		$sql = 'SELECT user_id, group_id, user_avatar			FROM ' . USERS_TABLE . '			WHERE ' . $db->sql_in_set('user_id', $user_id_ary) . '				AND user_avatar_type = ' . AVATAR_UPLOAD;		$result = $db->sql_query($sql);		while ($row = $db->sql_fetchrow($result))		{			avatar_delete('user', $row);		}		$db->sql_freeresult($result);	}	else	{		unset($sql_ary['user_avatar_type']);		unset($sql_ary['user_avatar_height']);		unset($sql_ary['user_avatar_width']);	}	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $db->sql_build_array('UPDATE', $sql_ary) . '		WHERE ' . $db->sql_in_set('user_id', $user_id_ary);	$db->sql_query($sql);	if (isset($sql_ary['user_colour']))	{		// Update any cached colour information for these users		$sql = 'UPDATE ' . FORUMS_TABLE . " SET forum_last_poster_colour = '" . $db->sql_escape($sql_ary['user_colour']) . "'			WHERE " . $db->sql_in_set('forum_last_poster_id', $user_id_ary);		$db->sql_query($sql);		$sql = 'UPDATE ' . TOPICS_TABLE . " SET topic_first_poster_colour = '" . $db->sql_escape($sql_ary['user_colour']) . "'			WHERE " . $db->sql_in_set('topic_poster', $user_id_ary);		$db->sql_query($sql);		$sql = 'UPDATE ' . TOPICS_TABLE . " SET topic_last_poster_colour = '" . $db->sql_escape($sql_ary['user_colour']) . "'			WHERE " . $db->sql_in_set('topic_last_poster_id', $user_id_ary);		$db->sql_query($sql);		global $config;		if (in_array($config['newest_user_id'], $user_id_ary))		{			set_config('newest_user_colour', $sql_ary['user_colour'], true);		}	}	if ($update_listing)	{		group_update_listings($group_id);	}	// Because some tables/caches use usercolour-specific data we need to purge this here.	$cache->destroy('sql', MODERATOR_CACHE_TABLE);}/*** Get group name*/function get_group_name($group_id){	global $db, $user;	$sql = 'SELECT group_name, group_type		FROM ' . GROUPS_TABLE . '		WHERE group_id = ' . (int) $group_id;	$result = $db->sql_query($sql);	$row = $db->sql_fetchrow($result);	$db->sql_freeresult($result);	if (!$row || ($row['group_type'] == GROUP_SPECIAL && empty($user->lang)))	{		return '';	}	return ($row['group_type'] == GROUP_SPECIAL) ? $user->lang['G_' . $row['group_name']] : $row['group_name'];}/*** Obtain either the members of a specified group, the groups the specified user is subscribed to* or checking if a specified user is in a specified group. This function does not return pending memberships.** Note: Never use this more than once... first group your users/groups*/function group_memberships($group_id_ary = false, $user_id_ary = false, $return_bool = false){	global $db;	if (!$group_id_ary && !$user_id_ary)	{		return true;	}	if ($user_id_ary)	{		$user_id_ary = (!is_array($user_id_ary)) ? array($user_id_ary) : $user_id_ary;	}	if ($group_id_ary)	{		$group_id_ary = (!is_array($group_id_ary)) ? array($group_id_ary) : $group_id_ary;	}	$sql = 'SELECT ug.*, u.username, u.username_clean, u.user_email		FROM ' . USER_GROUP_TABLE . ' ug, ' . USERS_TABLE . ' u		WHERE ug.user_id = u.user_id			AND ug.user_pending = 0 AND ';	if ($group_id_ary)	{		$sql .= ' ' . $db->sql_in_set('ug.group_id', $group_id_ary);	}	if ($user_id_ary)	{		$sql .= ($group_id_ary) ? ' AND ' : ' ';		$sql .= $db->sql_in_set('ug.user_id', $user_id_ary);	}	$result = ($return_bool) ? $db->sql_query_limit($sql, 1) : $db->sql_query($sql);	$row = $db->sql_fetchrow($result);	if ($return_bool)	{		$db->sql_freeresult($result);		return ($row) ? true : false;	}	if (!$row)	{		return false;	}	$return = array();	do	{		$return[] = $row;	}	while ($row = $db->sql_fetchrow($result));	$db->sql_freeresult($result);	return $return;}/*** Re-cache moderators and foes if group has a_ or m_ permissions*/function group_update_listings($group_id){	global $auth;	$hold_ary = $auth->acl_group_raw_data($group_id, array('a_', 'm_'));	if (!sizeof($hold_ary))	{		return;	}	$mod_permissions = $admin_permissions = false;	foreach ($hold_ary as $g_id => $forum_ary)	{		foreach ($forum_ary as $forum_id => $auth_ary)		{			foreach ($auth_ary as $auth_option => $setting)			{				if ($mod_permissions && $admin_permissions)				{					break 3;				}				if ($setting != ACL_YES)				{					continue;				}				if ($auth_option == 'm_')				{					$mod_permissions = true;				}				if ($auth_option == 'a_')				{					$admin_permissions = true;				}			}		}	}	if ($mod_permissions)	{		if (!function_exists('cache_moderators'))		{			global $phpbb_root_path, $phpEx;			include($phpbb_root_path . 'includes/functions_admin.' . $phpEx);		}		cache_moderators();	}	if ($mod_permissions || $admin_permissions)	{		if (!function_exists('update_foes'))		{			global $phpbb_root_path, $phpEx;			include($phpbb_root_path . 'includes/functions_admin.' . $phpEx);		}		update_foes(array($group_id));	}}/*** Funtion to make a user leave the NEWLY_REGISTERED system group.* @access public* @param $user_id The id of the user to remove from the group*/function remove_newly_registered($user_id, $user_data = false){	global $db;	if ($user_data === false)	{		$sql = 'SELECT *			FROM ' . USERS_TABLE . '			WHERE user_id = ' . $user_id;		$result = $db->sql_query($sql);		$user_row = $db->sql_fetchrow($result);		$db->sql_freeresult($result);		if (!$user_row)		{			return false;		}		else		{			$user_data  = $user_row;		}	}	if (empty($user_data['user_new']))	{		return false;	}	$sql = 'SELECT group_id		FROM ' . GROUPS_TABLE . "		WHERE group_name = 'NEWLY_REGISTERED'			AND group_type = " . GROUP_SPECIAL;	$result = $db->sql_query($sql);	$group_id = (int) $db->sql_fetchfield('group_id');	$db->sql_freeresult($result);	if (!$group_id)	{		return false;	}	// We need to call group_user_del here, because this function makes sure everything is correctly changed.	// A downside for a call within the session handler is that the language is not set up yet - so no log entry	group_user_del($group_id, $user_id);	// Set user_new to 0 to let this not be triggered again	$sql = 'UPDATE ' . USERS_TABLE . '		SET user_new = 0		WHERE user_id = ' . $user_id;	$db->sql_query($sql);	// The new users group was the users default group?	if ($user_data['group_id'] == $group_id)	{		// Which group is now the users default one?		$sql = 'SELECT group_id			FROM ' . USERS_TABLE . '			WHERE user_id = ' . $user_id;		$result = $db->sql_query($sql);		$user_data['group_id'] = $db->sql_fetchfield('group_id');		$db->sql_freeresult($result);	}	return $user_data['group_id'];}?>
