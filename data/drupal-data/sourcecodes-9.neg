<?php// $Id$?><div class="comment<?php print ' '. $status; ?>">  <?php if ($picture) : ?>    <?php print $picture ?>  <?php endif; ?>  <h3 class="title"><?php print $title ?></h3>  <div class="submitted"><?php print $submitted ?><?php if ($comment->new) : ?><span class="new"> *<?php print $new ?></span><?php endif; ?></div>  <div class="content">    <?php print $content ?>    <?php if ($signature): ?>      <div class="clear-block">        <div></div>        <?php print $signature ?>      </div>    <?php endif; ?>  </div>  <!-- BEGIN: links -->  <div class="links">&raquo; <?php print $links ?></div>  <!-- END: links --></div>
<?php// $Id$/** * @file box.tpl.php * * Theme implementation to display a box. * * Available variables: * - $title: Box title. * - $content: Box content. * * @see template_preprocess() */?><div class="box"><?php if ($title): ?>  <h2><?php print $title ?></h2><?php endif; ?>  <div class="content"><?php print $content ?></div></div>
<?php// $Id$/** * @file * Allows configuration of congestion control auto-throttle mechanism. */function throttle_menu() {  $items['admin/settings/throttle'] = array(    'title' => 'Throttle',    'description' => 'Control how your site cuts out content during heavy load.',    'page callback' => 'drupal_get_form',    'page arguments' => array('throttle_admin_settings'),    'access arguments' => array('administer site configuration'),    'file' => 'throttle.admin.inc',  );  return $items;}/** * Determine the current load on the site. * * Call the throttle_status() function from your own modules, themes, blocks, * etc. as follows: * *   $throttle = module_invoke('throttle', 'status'); * * to determine the current throttle status. Use module_invoke() so the * call will still work if the throttle module is disabled. For example, in * your theme you might choose to disable pictures when your site is too busy * (reducing bandwidth), or in your modules you might choose to disable * some complicated logic when your site is too busy (reducing CPU utilization). * * @return *   0 or 1. 0 means that the throttle is currently disabled. 1 means that *   the throttle is currently enabled. When the throttle is enabled, CPU *   and bandwidth intensive functionality should be disabled. */function throttle_status() {  return variable_get('throttle_level', 0);}/** * Implementation of hook_exit(). * * Changes the current throttle level based on page hits. */function throttle_exit() {  // The following logic determines what the current throttle level should  //  be, and can be disabled by the admin. If enabled, the mt_rand() function  //  returns a number between 0 and N, N being specified by the admin. If  //  0 is returned, the throttle logic is run, adding two additional database  //  queries. Otherwise, the following logic is skipped. This mechanism is  //  referred to in the admin page as the 'probability limiter', roughly  //  limiting throttle related database calls to 1 in N.  if (!mt_rand(0, variable_get('throttle_probability_limiter', 9))) {    // Count users with activity in the past n seconds.    // This value is defined in the user module Who's Online block.    $time_period = variable_get('user_block_seconds_online', 900);    // When determining throttle status in your own module or theme, use    // $throttle = module_invoke('throttle', 'status');    // as that will still work when throttle.module is disabled.    // Clearly here the module is enabled so we call throttle_status() directly.    $throttle = throttle_status();    if ($max_guests = variable_get('throttle_anonymous', 0)) {      $guests = sess_count(time() - $time_period, TRUE);    }    else {      $guests = 0;    }    if ($max_users = variable_get('throttle_user', 0)) {      $users = sess_count(time() - $time_period, FALSE);    }    else {      $users = 0;    }    // update the throttle status    $message = '';    if ($max_users && $users > $max_users) {      if (!$throttle) {        variable_set('throttle_level', 1);        $message = format_plural($users,                                 '1 user accessing site; throttle enabled.',                                 '@count users accessing site; throttle enabled.');      }    }    elseif ($max_guests && $guests > $max_guests) {      if (!$throttle) {        variable_set('throttle_level', 1);        $message = format_plural($guests,                                 '1 guest accessing site; throttle enabled.',                                 '@count guests accessing site; throttle enabled.');      }    }    else {      if ($throttle) {        variable_set('throttle_level', 0);        // Note: unorthodox format_plural() usage due to Gettext plural limitations.        $message = format_plural($users, '1 user', '@count users') .', ';        $message .= format_plural($guests, '1 guest accessing site; throttle disabled', '@count guests accessing site; throttle disabled');      }    }    if ($message) {      cache_clear_all();      watchdog('throttle', 'Throttle: %message', array('%message' => $message));    }  }}/** * Implementation of hook_help(). */function throttle_help($path, $arg) {  switch ($path) {    case 'admin/help#throttle':      $output = '<p>'. t('The throttle module provides a congestion control mechanism that automatically adjusts to a surge in incoming traffic. If your site is referenced by a popular website, or experiences a "Denial of Service" (DoS) attack, your webserver might become overwhelmed. The throttle mechanism is utilized by modules to temporarily disable CPU-intensive functionality, increasing performance. For instance, via the throttle module, modules may choose to disable resource-intensive blocks or the code within the site theme may temporarily disable user pictures in posts.') .'</p>';      $output .= '<p>'. t('The congestion control throttle can be automatically enabled when the number of anonymous or authenticated users currently visiting the site exceeds a specified threshold.') .'</p>';      $output .= '<p>'. t('For more information, see the online handbook entry for <a href="@throttle">Throttle module</a>.', array('@throttle' => 'http://drupal.org/handbook/modules/throttle/')) .'</p>';      return $output;    case 'admin/settings/throttle':      return '<p>'. t('The throttle module provides a congestion control mechanism that automatically adjusts to a surge in incoming traffic. If your site is referenced by a popular website, or experiences a "Denial of Service" (DoS) attack, your webserver might become overwhelmed. The throttle mechanism is utilized by modules to temporarily disable CPU-intensive functionality, increasing performance.') .'</p>';  }}
<?php// $Id$/** * @file * Admin page callbacks for the throttle module. *//** * Form builder; Configure the throttle system. * * @ingroup forms * @see system_settings_form() * @see throttle_admin_settings_validate() */function throttle_admin_settings() {  $probabilities = array(0 => '100%', 1 => '50%', 2 => '33.3%', 3 => '25%', 4 => '20%', 5 => '16.6%', 7 => '12.5%', 9 => '10%', 19 => '5%', 99 => '1%', 199 => '.5%', 399 => '.25%', 989 => '.1%');  $form['throttle_anonymous'] = array(    '#type' => 'textfield',    '#title' => t('Auto-throttle on anonymous users'),    '#default_value' => variable_get('throttle_anonymous', 0),    '#size' => 5,    '#maxlength' => 6,    '#description' => t('The congestion control throttle can be automatically enabled when the number of anonymous users currently visiting your site exceeds the specified threshold. For example, to start the throttle when your site has 250 anonymous users online at once, enter \'250\' in this field. Leave this value blank or set to "0" if you do not wish to auto-throttle on anonymous users. You can inspect the current number of anonymous users using the "Who\'s online" block.')  );  $form['throttle_user'] = array(    '#type' => 'textfield',    '#title' => t('Auto-throttle on authenticated users'),    '#default_value' => variable_get('throttle_user', 0),    '#size' => 5,    '#maxlength' => 6,    '#description' => t('The congestion control throttle can be automatically enabled when the number of authenticated users currently visiting your site exceeds the specified threshold. For example, to start the throttle when your site has 50 registered users online at once, enter \'50\' in this field. Leave this value blank or set to "0" if you do not wish to auto-throttle on authenticated users. You can inspect the current number of authenticated users using the "Who\'s online" block.')  );  $form['throttle_probability_limiter'] = array(    '#type' => 'select',    '#title' => t('Auto-throttle probability limiter'),    '#default_value' => variable_get('throttle_probability_limiter', 9),    '#options' => $probabilities,    '#description' => t('The auto-throttle probability limiter is an efficiency mechanism to statistically reduce the overhead of the auto-throttle. The limiter is expressed as a percentage of page views, so for example if set to the default of 10% we only perform the extra database queries to update the throttle status 1 out of every 10 page views. The busier your site, the lower you should set the limiter value.')  );  $form['#validate'] = array('throttle_admin_settings_validate');  return system_settings_form($form);}function throttle_admin_settings_validate($form, &$form_state) {  if (!is_numeric($form_state['values']['throttle_anonymous']) || $form_state['values']['throttle_anonymous'] < 0) {    form_set_error('throttle_anonymous', t("%value is not a valid auto-throttle setting. Please enter a positive numeric value.", array('%value' => $form_state['values']['throttle_anonymous'])));  }  if (!is_numeric($form_state['values']['throttle_user']) || $form_state['values']['throttle_user'] < 0) {    form_set_error('throttle_user', t("%value is not a valid auto-throttle setting. Please enter a positive numeric value.", array('%value' => $form_state['values']['throttle_user'])));  }}
<?php// $Id$/** * @file forums.tpl.php * Default theme implementation to display a forum which may contain forum * containers as well as forum topics. * * Variables available: * - $links: An array of links that allow a user to post new forum topics. *   It may also contain a string telling a user they must log in in order *   to post. * - $forums: The forums to display (as processed by forum-list.tpl.php) * - $topics: The topics to display (as processed by forum-topic-list.tpl.php) * - $forums_defined: A flag to indicate that the forums are configured. * * @see template_preprocess_forums() * @see theme_forums() */?><?php if ($forums_defined): ?><div id="forum">  <?php print theme('links', $links); ?>  <?php print $forums; ?>  <?php print $topics; ?></div><?php endif; ?>
<?php// $Id$/** * @file * Alerts other sites that your site has been updated. *//** * Implementation of hook_help(). */function ping_help($path, $arg) {  switch ($path) {    case 'admin/help#ping':      $output = '<p>'. t('The ping module is useful for notifying interested sites that your site has changed. It automatically sends notifications, or "pings", to the <a href="@external-http-pingomatic-com">pingomatic</a> service about new or updated content. In turn, <a href="@external-http-pingomatic-com">pingomatic</a> notifies other popular services, including weblogs.com, Technorati, blo.gs, BlogRolling, Feedster.com, and Moreover.', array('@external-http-pingomatic-com' => 'http://pingomatic.com/')) .'</p>';      $output .= '<p>'. t('The ping module requires a correctly configured <a href="@cron">cron maintenance task</a>.', array('@cron' => url('admin/reports/status'))) .'</p>';      $output .= '<p>'. t('For more information, see the online handbook entry for <a href="@ping">Ping module</a>.', array('@ping' => 'http://drupal.org/handbook/modules/ping/')) .'</p>';      return $output;  }}/** * Implementation of hook_cron(). * * Fire off notifications of updates to remote sites. */function ping_cron() {  global $base_url;  if (variable_get('site_name', 0)) {    $cron_last = variable_get('cron_last', time());    // Query changed first since usually changed >= created.    if (db_result(db_query('SELECT COUNT(*) FROM {node} WHERE status = 1 AND changed > %d', $cron_last)) || db_result(db_query('SELECT COUNT(*) FROM {node} WHERE status = 1 AND created > %d', $cron_last))) {      _ping_notify(variable_get('site_name', ''), $base_url);    }  }}/** * Call hook_ping() in all modules to notify remote sites that there is * new content at this one. */function _ping_notify($name, $url) {  module_invoke_all('ping', $name, $url);}/** * Implementation of hook_ping(). * * Notifies pingomatic.com, blo.gs, and technorati.com of changes at this site. */function ping_ping($name = '', $url = '') {  $result = xmlrpc('http://rpc.pingomatic.com', 'weblogUpdates.ping', $name, $url);  if ($result === FALSE) {    watchdog('directory ping', 'Failed to notify pingomatic.com (site).', array(), WATCHDOG_WARNING);  }}
<?php// $Id$/** * @file aggregator-feed-source.tpl.php * Default theme implementation to present the source of the feed. * * The contents are render above feed listings when browsing source feeds. * For example, "example.com/aggregator/sources/1". * * Available variables: * - $source_icon: Feed icon linked to the source. Rendered through *   theme_feed_icon(). * - $source_image: Image set by the feed source. * - $source_description: Description set by the feed source. * - $source_url: URL to the feed source. * - $last_checked: How long ago the feed was checked locally. * * @see template_preprocess() * @see template_preprocess_aggregator_feed_source() */?><div class="feed-source">  <?php print $source_icon; ?>  <?php print $source_image; ?>  <div class="feed-description">    <?php print $source_description; ?>  </div>  <div class="feed-url">    <em><?php print t('URL:'); ?></em> <a href="<?php print $source_url; ?>"><?php print $source_url; ?></a>  </div>  <div class="feed-updated">    <em><?php print t('Updated:'); ?></em> <?php print $last_checked; ?>  </div></div>
<?php// $Id$// Global variables to track parsing state$xrds_open_elements = array();$xrds_services = array();$xrds_current_service = array();/** * Main entry point for parsing XRDS documents */function xrds_parse($xml) {  global $xrds_services;  $parser = xml_parser_create_ns();  xml_set_element_handler($parser, '_xrds_element_start', '_xrds_element_end');  xml_set_character_data_handler($parser, '_xrds_cdata');  xml_parse($parser, $xml);  xml_parser_free($parser);  return $xrds_services;}/** * Parser callback functions */function _xrds_element_start(&$parser, $name, $attribs) {  global $xrds_open_elements;  $xrds_open_elements[] = _xrds_strip_namespace($name);}function _xrds_element_end(&$parser, $name) {  global $xrds_open_elements, $xrds_services, $xrds_current_service;  $name = _xrds_strip_namespace($name);  if ($name == 'SERVICE') {    if (in_array(OPENID_NS_2_0 .'/signon', $xrds_current_service['types']) ||        in_array(OPENID_NS_2_0 .'/server', $xrds_current_service['types'])) {      $xrds_current_service['version'] = 2;    }    elseif (in_array(OPENID_NS_1_1, $xrds_current_service['types']) ||            in_array(OPENID_NS_1_0, $xrds_current_service['types'])) {      $xrds_current_service['version'] = 1;    }    if (!empty($xrds_current_service['version'])) {      $xrds_services[] = $xrds_current_service;    }    $xrds_current_service = array();  }  array_pop($xrds_open_elements);}function _xrds_cdata(&$parser, $data) {  global $xrds_open_elements, $xrds_services, $xrds_current_service;  $path = strtoupper(implode('/', $xrds_open_elements));  switch ($path) {    case 'XRDS/XRD/SERVICE/TYPE':      $xrds_current_service['types'][] = $data;      break;    case 'XRDS/XRD/SERVICE/URI':      $xrds_current_service['uri'] = $data;      break;    case 'XRDS/XRD/SERVICE/DELEGATE':      $xrds_current_service['delegate'] = $data;      break;    case 'XRDS/XRD/SERVICE/LOCALID':      $xrds_current_service['localid'] = $data;      break;  }}function _xrds_strip_namespace($name) {  // Strip namespacing.  $pos = strrpos($name, ':');  if ($pos !== FALSE) {    $name = substr($name, $pos + 1, strlen($name));  }  return $name;}
<?php// $Id$/** * @file poll-results-block.tpl.php * Display the poll results in a block. * * Variables available: * - $title: The title of the poll. * - $results: The results of the poll. * - $votes: The total results in the poll. * - $links: Links in the poll. * - $nid: The nid of the poll * - $cancel_form: A form to cancel the user's vote, if allowed. * - $raw_links: The raw array of links. Should be run through theme('links') *   if used. * - $vote: The choice number of the current user's vote. * * @see template_preprocess_poll_results() */?><div class="poll">  <div class="title"><?php print $title ?></div>  <?php print $results ?>  <div class="total">    <?php print t('Total votes: @votes', array('@votes' => $votes)); ?>  </div></div><div class="links"><?php print $links; ?></div>
<?php// $Id$/** * @file * Drupal site-specific configuration file. * * IMPORTANT NOTE: * This file may have been set to read-only by the Drupal installation * program. If you make changes to this file, be sure to protect it again * after making your modifications. Failure to remove write permissions * to this file is a security risk. * * The configuration file to be loaded is based upon the rules below. * * The configuration directory will be discovered by stripping the * website's hostname from left to right and pathname from right to * left. The first configuration file found will be used and any * others will be ignored. If no other configuration file is found * then the default configuration file at 'sites/default' will be used. * * For example, for a fictitious site installed at * http://www.drupal.org/mysite/test/, the 'settings.php' * is searched in the following directories: * *  1. sites/www.drupal.org.mysite.test *  2. sites/drupal.org.mysite.test *  3. sites/org.mysite.test * *  4. sites/www.drupal.org.mysite *  5. sites/drupal.org.mysite *  6. sites/org.mysite * *  7. sites/www.drupal.org *  8. sites/drupal.org *  9. sites/org * * 10. sites/default * * If you are installing on a non-standard port number, prefix the * hostname with that number. For example, * http://www.drupal.org:8080/mysite/test/ could be loaded from * sites/8080.www.drupal.org.mysite.test/. *//** * Database settings: * * Note that the $db_url variable gets parsed using PHP's built-in * URL parser (i.e. using the "parse_url()" function) so make sure * not to confuse the parser. If your username, password * or database name contain characters used to delineate * $db_url parts, you can escape them via URI hex encodings: * *   : = %3a   / = %2f   @ = %40 *   + = %2b   ( = %28   ) = %29 *   ? = %3f   = = %3d   & = %26 * * To specify multiple connections to be used in your site (i.e. for * complex custom modules) you can also specify an associative array * of $db_url variables with the 'default' element used until otherwise * requested. * * You can optionally set prefixes for some or all database table names * by using the $db_prefix setting. If a prefix is specified, the table * name will be prepended with its value. Be sure to use valid database * characters only, usually alphanumeric and underscore. If no prefixes * are desired, leave it as an empty string ''. * * To have all database names prefixed, set $db_prefix as a string: * *   $db_prefix = 'main_'; * * To provide prefixes for specific tables, set $db_prefix as an array. * The array's keys are the table names and the values are the prefixes. * The 'default' element holds the prefix for any tables not specified * elsewhere in the array. Example: * *   $db_prefix = array( *     'default'   => 'main_', *     'users'     => 'shared_', *     'sessions'  => 'shared_', *     'role'      => 'shared_', *     'authmap'   => 'shared_', *   ); * * Database URL format: *   $db_url = 'mysql://username:password@localhost/databasename'; *   $db_url = 'mysqli://username:password@localhost/databasename'; *   $db_url = 'pgsql://username:password@localhost/databasename'; */$db_url = 'mysql://username:password@localhost/databasename';$db_prefix = '';/** * Access control for update.php script * * If you are updating your Drupal installation using the update.php script * being not logged in as administrator, you will need to modify the access * check statement below. Change the FALSE to a TRUE to disable the access * check. After finishing the upgrade, be sure to open this file again * and change the TRUE back to a FALSE! */$update_free_access = FALSE;/** * Base URL (optional). * * If you are experiencing issues with different site domains, * uncomment the Base URL statement below (remove the leading hash sign) * and fill in the absolute URL to your Drupal installation. * * You might also want to force users to use a given domain. * See the .htaccess file for more information. * * Examples: *   $base_url = 'http://www.example.com'; *   $base_url = 'http://www.example.com:8888'; *   $base_url = 'http://www.example.com/drupal'; *   $base_url = 'https://www.example.com:8888/drupal'; * * It is not allowed to have a trailing slash; Drupal will add it * for you. */# $base_url = 'http://www.example.com';  // NO trailing slash!/** * PHP settings: * * To see what PHP settings are possible, including whether they can * be set at runtime (ie., when ini_set() occurs), read the PHP * documentation at http://www.php.net/manual/en/ini.php#ini.list * and take a look at the .htaccess file to see which non-runtime * settings are used there. Settings defined here should not be * duplicated there so as to avoid conflict issues. */ini_set('arg_separator.output',     '&amp;');ini_set('magic_quotes_runtime',     0);ini_set('magic_quotes_sybase',      0);ini_set('session.cache_expire',     200000);ini_set('session.cache_limiter',    'none');ini_set('session.cookie_lifetime',  2000000);ini_set('session.gc_maxlifetime',   200000);ini_set('session.save_handler',     'user');ini_set('session.use_cookies',      1);ini_set('session.use_only_cookies', 1);ini_set('session.use_trans_sid',    0);ini_set('url_rewriter.tags',        '');/** * If you encounter a situation where users post a large amount of text, and * the result is stripped out upon viewing but can still be edited, Drupal's * output filter may not have sufficient memory to process it. If you * experience this issue, you may wish to uncomment the following two lines * and increase the limits of these variables. For more information, see * http://php.net/manual/en/pcre.configuration.php. */# ini_set('pcre.backtrack_limit', 200000);# ini_set('pcre.recursion_limit', 200000);/** * Drupal automatically generates a unique session cookie name for each site * based on on its full domain name. If you have multiple domains pointing at * the same Drupal site, you can either redirect them all to a single domain * (see comment in .htaccess), or uncomment the line below and specify their * shared base domain. Doing so assures that users remain logged in as they * cross between your various domains. */# $cookie_domain = 'example.com';/** * Variable overrides: * * To override specific entries in the 'variable' table for this site, * set them here. You usually don't need to use this feature. This is * useful in a configuration file for a vhost or directory, rather than * the default settings.php. Any configuration setting from the 'variable' * table can be given a new value. Note that any values you provide in * these variable overrides will not be modifiable from the Drupal * administration interface. * * Remove the leading hash signs to enable. */# $conf = array(#   'site_name' => 'My Drupal site',#   'theme_default' => 'minnelli',#   'anonymous' => 'Visitor',/** * A custom theme can be set for the off-line page. This applies when the site * is explicitly set to off-line mode through the administration page or when * the database is inactive due to an error. It can be set through the * 'maintenance_theme' key. The template file should also be copied into the * theme. It is located inside 'modules/system/maintenance-page.tpl.php'. * Note: This setting does not apply to installation and update pages. */#   'maintenance_theme' => 'minnelli',/** * reverse_proxy accepts a boolean value. * * Enable this setting to determine the correct IP address of the remote * client by examining information stored in the X-Forwarded-For headers. * X-Forwarded-For headers are a standard mechanism for identifying client * systems connecting through a reverse proxy server, such as Squid or * Pound. Reverse proxy servers are often used to enhance the performance * of heavily visited sites and may also provide other site caching, * security or encryption benefits. If this Drupal installation operates * behind a reverse proxy, this setting should be enabled so that correct * IP address information is captured in Drupal's session management, * logging, statistics and access management systems; if you are unsure * about this setting, do not have a reverse proxy, or Drupal operates in * a shared hosting environment, this setting should be set to disabled. */#   'reverse_proxy' => TRUE,/** * reverse_proxy accepts an array of IP addresses. * * Each element of this array is the IP address of any of your reverse * proxies. Filling this array Drupal will trust the information stored * in the X-Forwarded-For headers only if Remote IP address is one of * these, that is the request reaches the web server from one of your * reverse proxies. Otherwise, the client could directly connect to * your web server spoofing the X-Forwarded-For headers. */#   'reverse_proxy_addresses' => array('a.b.c.d', ...),# );/** * String overrides: * * To override specific strings on your site with or without enabling locale * module, add an entry to this list. This functionality allows you to change * a small number of your site's default English language interface strings. * * Remove the leading hash signs to enable. */# $conf['locale_custom_strings_en'] = array(#   'forum'      => 'Discussion board',#   '@count min' => '@count minutes',# );
<?php// $Id$/** * @file * User page callbacks for the filter module. *//** * Menu callback; show a page with long filter tips. */function filter_tips_long() {  $format = arg(2);  if ($format) {    $output = theme('filter_tips', _filter_tips($format, TRUE), TRUE);  }  else {    $output = theme('filter_tips', _filter_tips(-1, TRUE), TRUE);  }  return $output;}/** * Format a set of filter tips. * * @ingroup themeable */function theme_filter_tips($tips, $long = FALSE, $extra = '') {  $output = '';  $multiple = count($tips) > 1;  if ($multiple) {    $output = t('input formats') .':';  }  if (count($tips)) {    if ($multiple) {      $output .= '<ul>';    }    foreach ($tips as $name => $tiplist) {      if ($multiple) {        $output .= '<li>';        $output .= '<strong>'. $name .'</strong>:<br />';      }      if (count($tiplist) > 0) {        $output .= '<ul class="tips">';        foreach ($tiplist as $tip) {          $output .= '<li'. ($long ? ' id="filter-'. str_replace("/", "-", $tip['id']) .'">' : '>') . $tip['tip'] .'</li>';        }        $output .= '</ul>';      }      if ($multiple) {        $output .= '</li>';      }    }    if ($multiple) {      $output .= '</ul>';    }  }  return $output;}
<?php// $Id$?>  <div class="node<?php if ($sticky) { print " sticky"; } ?><?php if (!$status) { print " node-unpublished"; } ?>">    <?php if ($picture) {      print $picture;    }?>    <?php if ($page == 0) { ?><h2 class="title"><a href="<?php print $node_url?>"><?php print $title?></a></h2><?php }; ?>    <span class="submitted"><?php print $submitted?></span>    <div class="taxonomy"><?php print $terms?></div>    <div class="content"><?php print $content?></div>    <?php if ($links) { ?><div class="links">&raquo; <?php print $links?></div><?php }; ?>  </div>
<?php// $Id$?><div class="node<?php if ($sticky) { print " sticky"; } ?><?php if (!$status) { print " node-unpublished"; } ?>">  <?php print $picture ?>  <?php if ($page == 0): ?>    <h1 class="title"><a href="<?php print $node_url ?>"><?php print $title ?></a></h1>  <?php endif; ?>    <span class="submitted"><?php print $submitted ?></span>    <div class="taxonomy"><?php print $terms ?></div>    <div class="content"><?php print $content ?></div>    <?php if ($links): ?>    <div class="links">&raquo; <?php print $links ?></div>    <?php endif; ?></div>
<?php// $Id$// PostgreSQL specific install functions/** * Check if PostgreSQL is available. * * @return *  TRUE/FALSE */function pgsql_is_available() {  return function_exists('pg_connect');}/** * Check if we can connect to PostgreSQL. * * @return *  TRUE/FALSE */function drupal_test_pgsql($url, &$success) {  if (!pgsql_is_available()) {    drupal_set_message(st('PHP PostgreSQL support not enabled.'), 'error');    return FALSE;  }  $url = parse_url($url);  $conn_string = '';  // Decode url-encoded information in the db connection string  if (isset($url['user'])) {    $conn_string .= ' user='. urldecode($url['user']);  }  if (isset($url['pass'])) {    $conn_string .= ' password='. urldecode($url['pass']);  }  if (isset($url['host'])) {    $conn_string .= ' host='. urldecode($url['host']);  }  if (isset($url['path'])) {    $conn_string .= ' dbname='. substr(urldecode($url['path']), 1);  }  if (isset($url['port'])) {    $conn_string .= ' port='. urldecode($url['port']);  }  // Test connecting to the database.  $connection = @pg_connect($conn_string);  if (!$connection) {    drupal_set_message(st('Failed to connect to your PostgreSQL database server. PostgreSQL reports the following message: %error.<ul><li>Are you sure you have the correct username and password?</li><li>Are you sure that you have typed the correct database hostname?</li><li>Are you sure that the database server is running?</li><li>Are you sure you typed the correct database name?</li></ul>For more help, see the <a href="http://drupal.org/node/258">Installation and upgrading handbook</a>. If you are unsure what these terms mean you should probably contact your hosting provider.', array('%error' => 'Connection failed. See log file for failure reason')), 'error');    return FALSE;  }  $success = array('CONNECT');  // Test CREATE.  $query = 'CREATE TABLE drupal_install_test (id integer NOT NULL)';  $result = pg_query($connection, $query);  if ($error = pg_result_error($result)) {    drupal_set_message(st('Failed to create a test table on your PostgreSQL database server with the command %query. PostgreSQL reports the following message: %error.<ul><li>Are you sure the configured username has the necessary PostgreSQL permissions to create tables in the database?</li></ul>For more help, see the <a href="http://drupal.org/node/258">Installation and upgrading handbook</a>. If you are unsure what these terms mean you should probably contact your hosting provider.', array('%query' => $query, '%error' => $error)), 'error');    return FALSE;  }  $err = FALSE;  $success[] = 'SELECT';  $success[] = 'CREATE';  // Test INSERT.  $query = 'INSERT INTO drupal_install_test (id) VALUES (1)';  $result = pg_query($connection, $query);  if ($error = pg_result_error($result)) {    drupal_set_message(st('Failed to insert a value into a test table on your PostgreSQL database server. We tried inserting a value with the command %query and PostgreSQL reported the following error: %error.', array('%query' => $query, '%error' => $error)), 'error');    $err = TRUE;  }  else {    $success[] = 'INSERT';  }  // Test UPDATE.  $query = 'UPDATE drupal_install_test SET id = 2';  $result = pg_query($connection, $query);  if ($error = pg_result_error($result)) {    drupal_set_message(st('Failed to update a value in a test table on your PostgreSQL database server. We tried updating a value with the command %query and PostgreSQL reported the following error: %error.', array('%query' => $query, '%error' => $error)), 'error');    $err = TRUE;  }  else {    $success[] = 'UPDATE';  }  // Test LOCK.  $query = 'BEGIN; LOCK drupal_install_test IN SHARE ROW EXCLUSIVE MODE';  $result = pg_query($connection, $query);  if ($error = pg_result_error($result)) {    drupal_set_message(st('Failed to lock a test table on your PostgreSQL database server. We tried locking a table with the command %query and PostgreSQL reported the following error: %error.', array('%query' => $query, '%error' => $error)), 'error');    $err = TRUE;  }  else {    $success[] = 'LOCK';  }  // Test UNLOCK, which is done automatically upon transaction end in PostgreSQL  $query = 'COMMIT';  $result = pg_query($connection, $query);  if ($error = pg_result_error()) {    drupal_set_message(st('Failed to unlock a test table on your PostgreSQL database server. We tried unlocking a table with the command %query and PostgreSQL reported the following error: %error.', array('%query' => $query, '%error' => $error)), 'error');    $err = TRUE;  }  else {    $success[] = 'UNLOCK';  }  // Test DELETE.  $query = 'DELETE FROM drupal_install_test';  $result = pg_query($connection, $query);  if ($error = pg_result_error()) {    drupal_set_message(st('Failed to delete a value from a test table on your PostgreSQL database server. We tried deleting a value with the command %query and PostgreSQL reported the following error: %error.', array('%query' => $query, '%error' => $error)), 'error');    $err = TRUE;  }  else {    $success[] = 'DELETE';  }  // Test DROP.  $query = 'DROP TABLE drupal_install_test';  $result = pg_query($connection, $query);  if ($error = pg_result_error()) {    drupal_set_message(st('Failed to drop a test table from your PostgreSQL database server. We tried dropping a table with the command %query and PostgreSQL reported the following error %error.', array('%query' => $query, '%error' => $error)), 'error');    $err = TRUE;  }  else {    $success[] = 'DROP';  }  if ($err) {    return FALSE;  }  pg_close($connection);  return TRUE;}
<?php// $Id$?><div class="box">  <?php if ($title): ?>  <h2 class="title"><?php print $title ?></h2>  <?php endif; ?>  <div class="content"><?php print $content ?></div></div>
<?php// $Id$/** * @file book-all-books-block.tpl.php * Default theme implementation for rendering book outlines within a block. * This template is used only when the block is configured to "show block on * all pages" which presents Multiple independent books on all pages. * * Available variables: * - $book_menus: Array of book outlines rendered as an unordered list. It is *   keyed to the parent book ID which is also the ID of the parent node *   containing an entire outline. * * @see template_preprocess_book_all_books_block() */?><?php foreach ($book_menus as $book_id => $menu) : ?><div id="book-block-menu-<?php print $book_id; ?>" class="book-block-menu">  <?php print $menu; ?></div><?php endforeach; ?>
<?php// $Id$/** * @file block-admin-display-form.tpl.php * Default theme implementation to configure blocks. * * Available variables: * - $block_regions: An array of regions. Keyed by name with the title as value. * - $block_listing: An array of blocks keyed by region and then delta. * - $form_submit: Form submit button. * - $throttle: TRUE or FALSE depending on throttle module being enabled. * * Each $block_listing[$region] contains an array of blocks for that region. * * Each $data in $block_listing[$region] contains: * - $data->region_title: Region title for the listed block. * - $data->block_title: Block title. * - $data->region_select: Drop-down menu for assigning a region. * - $data->weight_select: Drop-down menu for setting weights. * - $data->throttle_check: Checkbox to enable throttling. * - $data->configure_link: Block configuration link. * - $data->delete_link: For deleting user added blocks. * * @see template_preprocess_block_admin_display_form() * @see theme_block_admin_display() */?><?php  // Add table javascript.  drupal_add_js('misc/tableheader.js');  drupal_add_js(drupal_get_path('module', 'block') .'/block.js');  foreach ($block_regions as $region => $title) {    drupal_add_tabledrag('blocks', 'match', 'sibling', 'block-region-select', 'block-region-'. $region, NULL, FALSE);    drupal_add_tabledrag('blocks', 'order', 'sibling', 'block-weight', 'block-weight-'. $region);  }?><table id="blocks" class="sticky-enabled">  <thead>    <tr>      <th><?php print t('Block'); ?></th>      <th><?php print t('Region'); ?></th>      <th><?php print t('Weight'); ?></th>      <?php if ($throttle): ?>        <th><?php print t('Throttle'); ?></th>      <?php endif; ?>      <th colspan="2"><?php print t('Operations'); ?></th>    </tr>  </thead>  <tbody>    <?php $row = 0; ?>    <?php foreach ($block_regions as $region => $title): ?>      <tr class="region region-<?php print $region?>">        <td colspan="<?php print $throttle ? '6' : '5'; ?>" class="region"><?php print $title; ?></td>      </tr>      <tr class="region-message region-<?php print $region?>-message <?php print empty($block_listing[$region]) ? 'region-empty' : 'region-populated'; ?>">        <td colspan="<?php print $throttle ? '6' : '5'; ?>"><em><?php print t('No blocks in this region'); ?></em></td>      </tr>      <?php foreach ($block_listing[$region] as $delta => $data): ?>      <tr class="draggable <?php print $row % 2 == 0 ? 'odd' : 'even'; ?><?php print $data->row_class ? ' '. $data->row_class : ''; ?>">        <td class="block"><?php print $data->block_title; ?></td>        <td><?php print $data->region_select; ?></td>        <td><?php print $data->weight_select; ?></td>        <?php if ($throttle): ?>          <td><?php print $data->throttle_check; ?></td>        <?php endif; ?>        <td><?php print $data->configure_link; ?></td>        <td><?php print $data->delete_link; ?></td>      </tr>      <?php $row++; ?>      <?php endforeach; ?>    <?php endforeach; ?>  </tbody></table><?php print $form_submit; ?>
<?php// $Id$/** * @file search-block-form.tpl.php * Default theme implementation for displaying a search form within a block region. * * Available variables: * - $search_form: The complete search form ready for print. * - $search: Array of keyed search elements. Can be used to print each form *   element separately. * * Default keys within $search: * - $search['search_block_form']: Text input area wrapped in a div. * - $search['submit']: Form submit button. * - $search['hidden']: Hidden form elements. Used to validate forms when submitted. * * Since $search is keyed, a direct print of the form element is possible. * Modules can add to the search form so it is recommended to check for their * existance before printing. The default keys will always exist. * *   <?php if (isset($search['extra_field'])): ?> *     <div class="extra-field"> *       <?php print $search['extra_field']; ?> *     </div> *   <?php endif; ?> * * To check for all available data within $search, use the code below. * *   <?php print '<pre>'. check_plain(print_r($search, 1)) .'</pre>'; ?> * * @see template_preprocess_search_block_form() */?><div class="container-inline">  <?php print $search_form; ?></div>
<?php// $Id$/** * @file * User page callbacks for the aggregator module. *//** * Menu callback; displays the most recent items gathered from any feed. * * @return *   The items HTML. */function aggregator_page_last() {  drupal_add_feed(url('aggregator/rss'), variable_get('site_name', 'Drupal') .' '. t('aggregator'));  $items = aggregator_feed_items_load('SELECT i.*, f.title AS ftitle, f.link AS flink FROM {aggregator_item} i INNER JOIN {aggregator_feed} f ON i.fid = f.fid ORDER BY i.timestamp DESC, i.iid DESC');  return _aggregator_page_list($items, arg(1));}/** * Menu callback; displays all the items captured from a particular feed. * * If there are two arguments then this function is the categorize form. * * @param $arg1 *   If there are two arguments then $arg1 is $form_state. Otherwise, $arg1 is $feed. * @param $arg2 *   If there are two arguments then $arg2 is feed. * @return *   The items HTML. */function aggregator_page_source($arg1, $arg2 = NULL) {  // If there are two arguments then this function is the categorize form, and  // $arg1 is $form_state and $arg2 is $feed. Otherwise, $arg1 is $feed.  $feed = is_array($arg2) ? $arg2 : $arg1;  $feed = (object)$feed;  drupal_set_title(check_plain($feed->title));  $feed_source = theme('aggregator_feed_source', $feed);  // It is safe to include the fid in the query because it's loaded from the  // database by aggregator_feed_load.  $items = aggregator_feed_items_load('SELECT * FROM {aggregator_item} WHERE fid = '. $feed->fid .' ORDER BY timestamp DESC, iid DESC');  return _aggregator_page_list($items, arg(3), $feed_source);}/** * Menu callback; displays all the items aggregated in a particular category. * * If there are two arguments then this function is called as a form. * * @param $arg1 *   If there are two arguments then $arg1 is $form_state. Otherwise, $arg1 is $category. * @param $arg2 *   If there are two arguments then $arg2 is $category. * @return *   The items HTML. */function aggregator_page_category($arg1, $arg2 = NULL) {  // If there are two arguments then we are called as a form, $arg1 is  // $form_state and $arg2 is $category. Otherwise, $arg1 is $category.  $category = is_array($arg2) ? $arg2 : $arg1;  drupal_add_feed(url('aggregator/rss/'. $category['cid']), variable_get('site_name', 'Drupal') .' '. t('aggregator - @title', array('@title' => $category['title'])));  // It is safe to include the cid in the query because it's loaded from the  // database by aggregator_category_load.  $items = aggregator_feed_items_load('SELECT i.*, f.title AS ftitle, f.link AS flink FROM {aggregator_category_item} c LEFT JOIN {aggregator_item} i ON c.iid = i.iid LEFT JOIN {aggregator_feed} f ON i.fid = f.fid WHERE cid = '. $category['cid'] .' ORDER BY timestamp DESC, i.iid DESC');  return _aggregator_page_list($items, arg(3));}/** * Load feed items by passing a SQL query. * * @param $sql *   The query to be executed. * @return *   An array of the feed items. */function aggregator_feed_items_load($sql) {  $items = array();  if (isset($sql)) {    $result = pager_query($sql, 20);    while ($item = db_fetch_object($result)) {      $result_category = db_query('SELECT c.title, c.cid FROM {aggregator_category_item} ci LEFT JOIN {aggregator_category} c ON ci.cid = c.cid WHERE ci.iid = %d ORDER BY c.title', $item->iid);      $item->categories = array();      while ($item_categories = db_fetch_object($result_category)) {        $item->categories[] = $item_categories;      }      $items[$item->iid] = $item;    }  }  return $items;}/** * Prints an aggregator page listing a number of feed items. * * Various menu callbacks use this function to print their feeds. * * @param $items *   The items to be listed. * @param $op *   Which form should be added to the items. Only 'categorize' is now recognized. * @param $feed_source *   The feed source URL. * @return *   The items HTML. */function _aggregator_page_list($items, $op, $feed_source = '') {  if (user_access('administer news feeds') && ($op == 'categorize')) {    // Get form data.    $output = aggregator_categorize_items($items, $feed_source);  }  else {    // Assemble themed output.    $output = $feed_source;    foreach ($items as $item) {      $output .= theme('aggregator_item', $item);    }    $output = theme('aggregator_wrapper', $output);  }  return $output;}/** * Form builder; build the page list form. * * @param $items *   An array of the feed items. * @param $feed_source *   The feed source URL. * @return *   The form structure. * @ingroup forms * @see aggregator_categorize_items_validate() * @see aggregator_categorize_items_submit() */function aggregator_categorize_items($items, $feed_source = '') {  $form['#submit'][] = 'aggregator_categorize_items_submit';  $form['#validate'][] = 'aggregator_categorize_items_validate';  $form['#theme'] = 'aggregator_categorize_items';  $form['feed_source'] = array('#value' => $feed_source);  $categories = array();  $done = FALSE;  $form['items'] = array();  $form['categories'] = array('#tree' => TRUE);  foreach ($items as $item) {    $form['items'][$item->iid] = array('#value' => theme('aggregator_item', $item));    $form['categories'][$item->iid] = array();    $categories_result = db_query('SELECT c.cid, c.title, ci.iid FROM {aggregator_category} c LEFT JOIN {aggregator_category_item} ci ON c.cid = ci.cid AND ci.iid = %d', $item->iid);    $selected = array();    while ($category = db_fetch_object($categories_result)) {      if (!$done) {        $categories[$category->cid] = check_plain($category->title);      }      if ($category->iid) {        $selected[] = $category->cid;      }    }    $done = TRUE;    $form['categories'][$item->iid] = array(      '#type' => variable_get('aggregator_category_selector', 'checkboxes'),      '#default_value' => $selected,      '#options' => $categories,      '#size' => 10,      '#multiple' => TRUE    );  }  $form['submit'] = array('#type' => 'submit', '#value' => t('Save categories'));  return $form;}/** * Validate aggregator_categorize_items form submissions. */function aggregator_categorize_items_validate($form, &$form_state) {  if (!user_access('administer news feeds')) {    form_error($form, t('You are not allowed to categorize this feed item.'));  }}/** * Process aggregator_categorize_items form submissions. */function aggregator_categorize_items_submit($form, &$form_state) {  if (!empty($form_state['values']['categories'])) {    foreach ($form_state['values']['categories'] as $iid => $selection) {      db_query('DELETE FROM {aggregator_category_item} WHERE iid = %d', $iid);      foreach ($selection as $cid) {        if ($cid) {          db_query('INSERT INTO {aggregator_category_item} (cid, iid) VALUES (%d, %d)', $cid, $iid);        }      }    }  }  drupal_set_message(t('The categories have been saved.'));}/** * Theme the page list form for assigning categories. * * @param $form *   An associative array containing the structure of the form. * @return *   The output HTML. * @ingroup themeable */function theme_aggregator_categorize_items($form) {  $output = drupal_render($form['feed_source']);  $rows = array();  if ($form['items']) {    foreach (element_children($form['items']) as $key) {      if (is_array($form['items'][$key])) {        $rows[] = array(          drupal_render($form['items'][$key]),          array('data' => drupal_render($form['categories'][$key]), 'class' => 'categorize-item'),        );      }    }  }  $output .= theme('table', array('', t('Categorize')), $rows);  $output .= drupal_render($form['submit']);  $output .= drupal_render($form);  return theme('aggregator_wrapper', $output);}/** * Process variables for aggregator-wrapper.tpl.php. * * @see aggregator-wrapper.tpl.php */function template_preprocess_aggregator_wrapper(&$variables) {  $variables['pager'] = theme('pager', NULL, 20, 0);}/** * Process variables for aggregator-item.tpl.php. * * @see aggregator-item.tpl.php */function template_preprocess_aggregator_item(&$variables) {  $item = $variables['item'];  $variables['feed_url'] = check_url($item->link);  $variables['feed_title'] = check_plain($item->title);  $variables['content'] = aggregator_filter_xss($item->description);  $variables['source_url'] = '';  $variables['source_title'] = '';  if (isset($item->ftitle) && isset($item->fid)) {    $variables['source_url'] = url("aggregator/sources/$item->fid");    $variables['source_title'] = check_plain($item->ftitle);  }  if (date('Ymd', $item->timestamp) == date('Ymd')) {    $variables['source_date'] = t('%ago ago', array('%ago' => format_interval(time() - $item->timestamp)));  }  else {    $variables['source_date'] = format_date($item->timestamp, 'custom', variable_get('date_format_medium', 'D, m/d/Y - H:i'));  }  $variables['categories'] = array();  foreach ($item->categories as $category) {    $variables['categories'][$category->cid] = l($category->title, 'aggregator/categories/'. $category->cid);  }}/** * Menu callback; displays all the feeds used by the aggregator. */function aggregator_page_sources() {  $result = db_query('SELECT f.fid, f.title, f.description, f.image, MAX(i.timestamp) AS last FROM {aggregator_feed} f LEFT JOIN {aggregator_item} i ON f.fid = i.fid GROUP BY f.fid, f.title, f.description, f.image ORDER BY last DESC, f.title');  $output = '';  while ($feed = db_fetch_object($result)) {    // Most recent items:    $summary_items = array();    if (variable_get('aggregator_summary_items', 3)) {      $items = db_query_range('SELECT i.title, i.timestamp, i.link FROM {aggregator_item} i WHERE i.fid = %d ORDER BY i.timestamp DESC', $feed->fid, 0, variable_get('aggregator_summary_items', 3));      while ($item = db_fetch_object($items)) {        $summary_items[] = theme('aggregator_summary_item', $item);      }    }    $feed->url = url('aggregator/sources/'. $feed->fid);    $output .= theme('aggregator_summary_items', $summary_items, $feed);  }  $output .= theme('feed_icon', url('aggregator/opml'), t('OPML feed'));  return theme('aggregator_wrapper', $output);}/** * Menu callback; displays all the categories used by the aggregator. */function aggregator_page_categories() {  $result = db_query('SELECT c.cid, c.title, c.description FROM {aggregator_category} c LEFT JOIN {aggregator_category_item} ci ON c.cid = ci.cid LEFT JOIN {aggregator_item} i ON ci.iid = i.iid GROUP BY c.cid, c.title, c.description');  $output = '';  while ($category = db_fetch_object($result)) {    if (variable_get('aggregator_summary_items', 3)) {      $summary_items = array();      $items = db_query_range('SELECT i.title, i.timestamp, i.link, f.title as feed_title, f.link as feed_link FROM {aggregator_category_item} ci LEFT JOIN {aggregator_item} i ON i.iid = ci.iid LEFT JOIN {aggregator_feed} f ON i.fid = f.fid WHERE ci.cid = %d ORDER BY i.timestamp DESC', $category->cid, 0, variable_get('aggregator_summary_items', 3));      while ($item = db_fetch_object($items)) {        $summary_items[] = theme('aggregator_summary_item', $item);      }    }    $category->url = url('aggregator/categories/'. $category->cid);    $output .= theme('aggregator_summary_items', $summary_items, $category);  }  return theme('aggregator_wrapper', $output);}/** * Menu callback; generate an RSS 0.92 feed of aggregator items or categories. */function aggregator_page_rss() {  $result = NULL;  // arg(2) is the passed cid, only select for that category  if (arg(2)) {    $category = db_fetch_object(db_query('SELECT cid, title FROM {aggregator_category} WHERE cid = %d', arg(2)));    $sql = 'SELECT i.*, f.title AS ftitle, f.link AS flink FROM {aggregator_category_item} c LEFT JOIN {aggregator_item} i ON c.iid = i.iid LEFT JOIN {aggregator_feed} f ON i.fid = f.fid WHERE cid = %d ORDER BY timestamp DESC, i.iid DESC';    $result = db_query_range($sql, $category->cid, 0, variable_get('feed_default_items', 10));  }  // or, get the default aggregator items  else {    $category = NULL;    $sql = 'SELECT i.*, f.title AS ftitle, f.link AS flink FROM {aggregator_item} i INNER JOIN {aggregator_feed} f ON i.fid = f.fid ORDER BY i.timestamp DESC, i.iid DESC';    $result = db_query_range($sql, 0, variable_get('feed_default_items', 10));  }  $feeds = array();  while ($item = db_fetch_object($result)) {    $feeds[] = $item;  }  return theme('aggregator_page_rss', $feeds, $category);}/** * Theme the RSS output. * * @param $feeds *   An array of the feeds to theme. * @param $category *   A common category, if any, for all the feeds. * @ingroup themeable */function theme_aggregator_page_rss($feeds, $category = NULL) {  drupal_set_header('Content-Type: application/rss+xml; charset=utf-8');  $items = '';  $feed_length = variable_get('feed_item_length', 'teaser');  foreach ($feeds as $feed) {    switch ($feed_length) {      case 'teaser':        $teaser = node_teaser($feed->description);        if ($teaser != $feed->description) {          $teaser .= '<p><a href="'. check_url($feed->link) .'">'. t('read more') ."</a></p>\n";        }        $feed->description = $teaser;        break;      case 'title':        $feed->description = '';        break;    }    $items .= format_rss_item($feed->ftitle .': '. $feed->title, $feed->link, $feed->description, array('pubDate' => date('r', $feed->timestamp)));  }  $site_name = variable_get('site_name', 'Drupal');  $url = url((isset($category) ? 'aggregator/categories/'. $category->cid : 'aggregator'), array('absolute' => TRUE));  $description = isset($category) ? t('@site_name - aggregated feeds in category @title', array('@site_name' => $site_name, '@title' => $category->title)) : t('@site_name - aggregated feeds', array('@site_name' => $site_name));  $output = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n";  $output .= "<rss version=\"2.0\">\n";  $output .= format_rss_channel(t('@site_name aggregator', array('@site_name' => $site_name)), $url, $description, $items);  $output .= "</rss>\n";  print $output;}/** * Menu callback; generates an OPML representation of all feeds. * * @param $cid *   If set, feeds are exported only from a category with this ID. Otherwise, all feeds are exported. * @return *   The output XML. */function aggregator_page_opml($cid = NULL) {  if ($cid) {    $result = db_query('SELECT f.title, f.url FROM {aggregator_feed} f LEFT JOIN {aggregator_category_feed} c on f.fid = c.fid WHERE c.cid = %d ORDER BY title', $cid);  }  else {    $result = db_query('SELECT * FROM {aggregator_feed} ORDER BY title');  }  $feeds = array();  while ($item = db_fetch_object($result)) {    $feeds[] = $item;  }  return theme('aggregator_page_opml', $feeds);}/** * Theme the OPML feed output. * * @param $feeds *   An array of the feeds to theme. * @ingroup themeable */function theme_aggregator_page_opml($feeds) {  drupal_set_header('Content-Type: text/xml; charset=utf-8');  $output = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n";  $output .= "<opml version=\"1.1\">\n";  $output .= "<head>\n";  $output .= '<title>'. check_plain(variable_get('site_name', 'Drupal')) ."</title>\n";  $output .= '<dateModified>'. gmdate('r') ."</dateModified>\n";  $output .= "</head>\n";  $output .= "<body>\n";  foreach ($feeds as $feed) {    $output .= '<outline text="'. check_plain($feed->title) .'" xmlUrl="'. check_url($feed->url) ."\" />\n";  }  $output .= "</body>\n";  $output .= "</opml>\n";  print $output;}/** * Process variables for aggregator-summary-items.tpl.php. * * @see aggregator-summary-item.tpl.php */function template_preprocess_aggregator_summary_items(&$variables) {  $variables['title'] = check_plain($variables['source']->title);  $variables['summary_list'] = theme('item_list', $variables['summary_items']);  $variables['source_url'] = $variables['source']->url;}/** * Process variables for aggregator-summary-item.tpl.php. * * @see aggregator-summary-item.tpl.php */function template_preprocess_aggregator_summary_item(&$variables) {  $item = $variables['item'];  $variables['feed_url'] = check_url($item->link);  $variables['feed_title'] = check_plain($item->title);  $variables['feed_age'] = t('%age old', array('%age' => format_interval(time() - $item->timestamp)));  $variables['source_url'] = '';  $variables['source_title'] = '';  if (!empty($item->feed_link)) {    $variables['source_url'] = check_url($item->feed_link);    $variables['source_title'] = check_plain($item->feed_title);  }}/** * Process variables for aggregator-feed-source.tpl.php. * * @see aggregator-feed-source.tpl.php */function template_preprocess_aggregator_feed_source(&$variables) {  $feed = $variables['feed'];  $variables['source_icon'] = theme('feed_icon', $feed->url, t('!title feed', array('!title' => $feed->title)));  $variables['source_image'] = $feed->image;  $variables['source_description'] = aggregator_filter_xss($feed->description);  $variables['source_url'] = check_url(url($feed->link, array('absolute' => TRUE)));  if ($feed->checked) {    $variables['last_checked'] = t('@time ago', array('@time' => format_interval(time() - $feed->checked)));  }  else {    $variables['last_checked'] = t('never');  }  if (user_access('administer news feeds')) {    $variables['last_checked'] = l($variables['last_checked'], 'admin/content/aggregator');  }}
<?php// $Id$/** * @file * Code required only for the update status settings form. *//** * Form builder for the update settings tab. */function update_settings() {  $form = array();  $notify_emails = variable_get('update_notify_emails', array());  $form['update_notify_emails'] = array(    '#type' => 'textarea',    '#title' => t('E-mail addresses to notify when updates are available'),    '#rows' => 4,    '#default_value' => implode("\n", $notify_emails),    '#description' => t('Whenever your site checks for available updates and finds new releases, it can notify a list of users via e-mail. Put each address on a separate line. If blank, no e-mails will be sent.'),  );  $form['update_check_frequency'] = array(    '#type' => 'radios',    '#title' => t('Check for updates'),    '#default_value' => variable_get('update_check_frequency', 1),    '#options' => array(      '1' => t('Daily'),      '7' => t('Weekly'),    ),    '#description' => t('Select how frequently you want to automatically check for new releases of your currently installed modules and themes.'),  );  $form['update_notification_threshold'] = array(    '#type' => 'radios',    '#title' => t('E-mail notification threshold'),    '#default_value' => variable_get('update_notification_threshold', 'all'),    '#options' => array(      'all' => t('All newer versions'),      'security' => t('Only security updates'),    ),    '#description' => t('You can choose to send e-mail only if a security update is available, or to be notified about all newer versions. If there are updates available of Drupal core or any of your installed modules and themes, your site will always print a message on the <a href="@status_report">status report</a> page, and will also display an error message on administration pages if there is a security update.', array('@status_report' => url('admin/reports/status')))  );  $form = system_settings_form($form);  // Custom valiation callback for the email notification setting.  $form['#validate'][] = 'update_settings_validate';  // We need to call our own submit callback first, not the one from  // system_settings_form(), so that we can process and save the emails.  unset($form['#submit']);  return $form;}/** * Validation callback for the settings form. * * Validates the email addresses and ensures the field is formatted correctly. */function update_settings_validate($form, &$form_state) {  if (!empty($form_state['values']['update_notify_emails'])) {    $valid = array();    $invalid = array();    foreach (explode("\n", trim($form_state['values']['update_notify_emails'])) as $email) {      $email = trim($email);      if (!empty($email)) {        if (valid_email_address($email)) {          $valid[] = $email;        }        else {          $invalid[] = $email;        }      }    }    if (empty($invalid)) {      $form_state['notify_emails'] = $valid;    }    elseif (count($invalid) == 1) {      form_set_error('update_notify_emails', t('%email is not a valid e-mail address.', array('%email' => reset($invalid))));    }    else {      form_set_error('update_notify_emails', t('%emails are not valid e-mail addresses.', array('%emails' => implode(', ', $invalid))));    }  }}/** * Submit handler for the settings tab. */function update_settings_submit($form, $form_state) {  $op = $form_state['values']['op'];  if ($op == t('Reset to defaults')) {    unset($form_state['notify_emails']);  }  else {    if (empty($form_state['notify_emails'])) {      variable_del('update_notify_emails');    }    else {      variable_set('update_notify_emails', $form_state['notify_emails']);    }    unset($form_state['notify_emails']);    unset($form_state['values']['update_notify_emails']);  }  system_settings_form_submit($form, $form_state);}
<?php// $Id$/** * @file comment-folded.tpl.php * Default theme implementation for folded comments. * * Available variables: * - $title: Linked title to full comment. * - $new: New comment marker. * - $author: Comment author. Can be link or plain text. * - $date: Date and time of posting. * - $comment: Full comment object. * * @see template_preprocess_comment_folded() * @see theme_comment_folded() */?><div class="comment-folded">  <span class="subject"><?php print $title .' '. $new; ?></span><span class="credit"><?php print t('by') .' '. $author; ?></span></div>
<?php// $Id$/** * @file profile-wrapper.tpl.php * Default theme implementation for wrapping member listings and their * profiles. * * This template is used when viewing a list of users. It can be a general * list for viewing all users with the url of "example.com/profile" or when * viewing a set of users who share a specific value for a profile such * as "example.com/profile/country/belgium". * * Available variables: * - $content: User account profiles iterated through profile-listing.tpl.php. * - $current_field: The named field being browsed. Provided here for context. *   The above example would result in "last_name". An alternate template name *   is also based on this, e.g., "profile-wrapper-last_name.tpl.php". * * @see template_preprocess_profile_wrapper() */?><div id="profile">  <?php print $content; ?></div>
<?php// $Id$/** * @file book-export-html.tpl.php * Default theme implementation for printed version of book outline. * * Available variables: * - $title: Top level node title. * - $head: Header tags. * - $language: Language code. e.g. "en" for english. * - $language_rtl: TRUE or FALSE depending on right to left language scripts. * - $base_url: URL to home page. * - $content: Nodes within the current outline rendered through *   book-node-export-html.tpl.php. * * @see template_preprocess_book_export_html() */?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="<?php print $language->language; ?>" xml:lang="<?php print $language->language; ?>">  <head>    <?php print $head; ?>    <title><?php print $title; ?></title>    <base href="<?php print $base_url; ?>" />    <link type="text/css" rel="stylesheet" href="misc/print.css" />    <?php if ($language_rtl): ?>      <link type="text/css" rel="stylesheet" href="misc/print-rtl.css" />    <?php endif; ?>  </head>  <body>    <?php    /**     * The given node is /embedded to its absolute depth in a top level     * section/. For example, a child node with depth 2 in the hierarchy is     * contained in (otherwise empty) &lt;div&gt; elements corresponding to     * depth 0 and depth 1. This is intended to support WYSIWYG output - e.g.,     * level 3 sections always look like level 3 sections, no matter their     * depth relative to the node selected to be exported as printer-friendly     * HTML.     */    $div_close = '';    ?>    <?php for ($i = 1; $i < $depth; $i++) : ?>      <div class="section-<?php print $i; ?>">      <?php $div_close .= '</div>'; ?>    <?php endfor; ?>    <?php print $contents; ?>    <?php print $div_close; ?>  </body></html>
<?php// $Id$/** * @file poll-bar.tpl.php * Display the bar for a single choice in a poll * * Variables available: * - $title: The title of the poll. * - $votes: The number of votes for this choice * - $total_votes: The number of votes for this choice * - $percentage: The percentage of votes for this choice. * - $vote: The choice number of the current user's vote. * - $voted: Set to TRUE if the user voted for this choice. * * @see template_preprocess_poll_bar() */?><div class="text"><?php print $title; ?></div><div class="bar">  <div style="width: <?php print $percentage; ?>%;" class="foreground"></div></div><div class="percent">  <?php print $percentage; ?>% (<?php print format_plural($votes, '1 vote', '@count votes'); ?>)</div>
<?php// $Id$/** * @file profile-block.tpl.php * Default theme implementation for displaying a users profile within a * block. It only shows in relation to a node displayed as a full page. * * Available variables: * - $picture: Image configured for the account linking to the users page. * - $profile: Keyed array of all profile fields that have a value. * * Each $field in $profile contains: * - $field->title: Title of the profile field. * - $field->value: Value of the profile field. * - $field->type: Type of the profile field, i.e., checkbox, textfield, *   textarea, selection, list, url or date. * * Since $profile is keyed, a direct print of the field is possible. Not * all accounts may have a value for a profile so do a check first. If a field * of "last_name" was set for the site, the following can be used. * *  <?php if (isset($profile['last_name'])): ?> *    <div class="field last-name"> *      <?php print $profile['last_name']->title; ?>:<br /> *      <?php print $profile['last_name']->value; ?> *    </div> *  <?php endif; ?> * * @see template_preprocess_profile_block() */?><?php print $picture; ?><?php foreach ($profile as $field) : ?>  <p>    <?php if ($field->type != 'checkbox') : ?>      <strong><?php print $field->title; ?></strong><br />    <?php endif; ?>    <?php print $field->value; ?>  </p><?php endforeach; ?>
<?php// $Id$/** * @file comment-wrapper.tpl.php * Default theme implementation to wrap comments. * * Available variables: * - $content: All comments for a given page. Also contains sorting controls *   and comment forms if the site is configured for it. * * The following variables are provided for contextual information. * - $node: Node object the comments are attached to. * The constants below the variables show the possible values and should be * used for comparison. * - $display_mode *   - COMMENT_MODE_FLAT_COLLAPSED *   - COMMENT_MODE_FLAT_EXPANDED *   - COMMENT_MODE_THREADED_COLLAPSED *   - COMMENT_MODE_THREADED_EXPANDED * - $display_order *   - COMMENT_ORDER_NEWEST_FIRST *   - COMMENT_ORDER_OLDEST_FIRST * - $comment_controls_state *   - COMMENT_CONTROLS_ABOVE *   - COMMENT_CONTROLS_BELOW *   - COMMENT_CONTROLS_ABOVE_BELOW *   - COMMENT_CONTROLS_HIDDEN * * @see template_preprocess_comment_wrapper() * @see theme_comment_wrapper() */?><div id="comments">  <?php print $content; ?></div>
<?php// $Id$/** * @file * PHP page for handling incoming XML-RPC requests from clients. */include_once './includes/bootstrap.inc';drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);include_once './includes/xmlrpc.inc';include_once './includes/xmlrpcs.inc';xmlrpc_server(module_invoke_all('xmlrpc'));
<?php// $Id$?><div class="<?php print "block block-$block->module" ?>" id="<?php print "block-$block->module-$block->delta"; ?>">  <div class="title"><h3><?php print $block->subject ?></h3></div>  <div class="content"><?php print $block->content ?></div></div>
<?php// $Id$/** * @file forum-list.tpl.php * Default theme implementation to display a list of forums and containers. * * Available variables: * - $forums: An array of forums and containers to display. It is keyed to the *   numeric id's of all child forums and containers. * - $forum_id: Forum id for the current forum. Parent to all items within *   the $forums array. * * Each $forum in $forums contains: * - $forum->is_container: Is TRUE if the forum can contain other forums. Is *   FALSE if the forum can contain only topics. * - $forum->depth: How deep the forum is in the current hierarchy. * - $forum->zebra: 'even' or 'odd' string used for row class. * - $forum->name: The name of the forum. * - $forum->link: The URL to link to this forum. * - $forum->description: The description of this forum. * - $forum->new_topics: True if the forum contains unread posts. * - $forum->new_url: A URL to the forum's unread posts. * - $forum->new_text: Text for the above URL which tells how many new posts. * - $forum->old_topics: A count of posts that have already been read. * - $forum->num_posts: The total number of posts in the forum. * - $forum->last_reply: Text representing the last time a forum was posted or *   commented in. * * @see template_preprocess_forum_list() * @see theme_forum_list() */?><table id="forum-<?php print $forum_id; ?>">  <thead>    <tr>      <th><?php print t('Forum'); ?></th>      <th><?php print t('Topics');?></th>      <th><?php print t('Posts'); ?></th>      <th><?php print t('Last post'); ?></th>    </tr>  </thead>  <tbody>  <?php foreach ($forums as $child_id => $forum): ?>    <tr id="forum-list-<?php print $child_id; ?>" class="<?php print $forum->zebra; ?>">      <td <?php print $forum->is_container ? 'colspan="4" class="container"' : 'class="forum"'; ?>>        <?php /* Enclose the contents of this cell with X divs, where X is the               * depth this forum resides at. This will allow us to use CSS               * left-margin for indenting.               */ ?>        <?php print str_repeat('<div class="indent">', $forum->depth); ?>          <div class="name"><a href="<?php print $forum->link; ?>"><?php print $forum->name; ?></a></div>          <?php if ($forum->description): ?>            <div class="description"><?php print $forum->description; ?></div>          <?php endif; ?>        <?php print str_repeat('</div>', $forum->depth); ?>      </td>      <?php if (!$forum->is_container): ?>        <td class="topics">          <?php print $forum->num_topics ?>          <?php if ($forum->new_topics): ?>            <br />            <a href="<?php print $forum->new_url; ?>"><?php print $forum->new_text; ?></a>          <?php endif; ?>        </td>        <td class="posts"><?php print $forum->num_posts ?></td>        <td class="last-reply"><?php print $forum->last_reply ?></td>      <?php endif; ?>    </tr>  <?php endforeach; ?>  </tbody></table>
<?php// $Id$/** * @file * The PHP page that serves all page requests on a Drupal installation. * * The routines here dispatch control to the appropriate handler, which then * prints the appropriate page. * * All Drupal code is released under the GNU General Public License. * See COPYRIGHT.txt and LICENSE.txt. */require_once './includes/bootstrap.inc';drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);$return = menu_execute_active_handler();// Menu status constants are integers; page content is a string.if (is_int($return)) {  switch ($return) {    case MENU_NOT_FOUND:      drupal_not_found();      break;    case MENU_ACCESS_DENIED:      drupal_access_denied();      break;    case MENU_SITE_OFFLINE:      drupal_site_offline();      break;  }}elseif (isset($return)) {  // Print any value (including an empty string) except NULL or undefined:  print theme('page', $return);}drupal_page_footer();
<?php// $Id$/** * @file * Database interface code for MySQL database servers using the mysqli client libraries. mysqli is included in PHP 5 by default and allows developers to use the advanced features of MySQL 4.1.x, 5.0.x and beyond. */ // Maintainers of this file should consult: // http://www.php.net/manual/en/ref.mysqli.php/** * @ingroup database * @{ */// Include functions shared between mysql and mysqli.require_once './includes/database.mysql-common.inc';/** * Report database status. */function db_status_report($phase) {  $t = get_t();  $version = db_version();  $form['mysql'] = array(    'title' => $t('MySQL database'),    'value' => ($phase == 'runtime') ? l($version, 'admin/reports/status/sql') : $version,  );  if (version_compare($version, DRUPAL_MINIMUM_MYSQL) < 0) {    $form['mysql']['severity'] = REQUIREMENT_ERROR;    $form['mysql']['description'] = $t('Your MySQL Server is too old. Drupal requires at least MySQL %version.', array('%version' => DRUPAL_MINIMUM_MYSQL));  }  return $form;}/** * Returns the version of the database server currently in use. * * @return Database server version */function db_version() {  global $active_db;  list($version) = explode('-', mysqli_get_server_info($active_db));  return $version;}/** * Initialise a database connection. * * Note that mysqli does not support persistent connections. */function db_connect($url) {  // Check if MySQLi support is present in PHP  if (!function_exists('mysqli_init') && !extension_loaded('mysqli')) {    _db_error_page('Unable to use the MySQLi database because the MySQLi extension for PHP is not installed. Check your <code>php.ini</code> to see how you can enable it.');  }  $url = parse_url($url);  // Decode url-encoded information in the db connection string  $url['user'] = urldecode($url['user']);  // Test if database url has a password.  $url['pass'] = isset($url['pass']) ? urldecode($url['pass']) : '';  $url['host'] = urldecode($url['host']);  $url['path'] = urldecode($url['path']);  if (!isset($url['port'])) {    $url['port'] = NULL;  }  $connection = mysqli_init();  @mysqli_real_connect($connection, $url['host'], $url['user'], $url['pass'], substr($url['path'], 1), $url['port'], NULL, MYSQLI_CLIENT_FOUND_ROWS);  if (mysqli_connect_errno() > 0) {    _db_error_page(mysqli_connect_error());  }  // Force UTF-8.  mysqli_query($connection, 'SET NAMES "utf8"');  return $connection;}/** * Helper function for db_query(). */function _db_query($query, $debug = 0) {  global $active_db, $queries, $user;  if (variable_get('dev_query', 0)) {    list($usec, $sec) = explode(' ', microtime());    $timer = (float)$usec + (float)$sec;    // If devel.module query logging is enabled, prepend a comment with the username and calling function    // to the SQL string. This is useful when running mysql's SHOW PROCESSLIST to learn what exact    // code is issueing the slow query.    $bt = debug_backtrace();    // t() may not be available yet so we don't wrap 'Anonymous'    $name = $user->uid ? $user->name : variable_get('anonymous', 'Anonymous');    // str_replace() to prevent SQL injection via username or anonymous name.    $name = str_replace(array('*', '/'), '', $name);    $query = '/* '. $name .' : '. $bt[2]['function'] .' */ '. $query;  }  $result = mysqli_query($active_db, $query);  if (variable_get('dev_query', 0)) {    $query = $bt[2]['function'] ."\n". $query;    list($usec, $sec) = explode(' ', microtime());    $stop = (float)$usec + (float)$sec;    $diff = $stop - $timer;    $queries[] = array($query, $diff);  }  if ($debug) {    print '<p>query: '. $query .'<br />error:'. mysqli_error($active_db) .'</p>';  }  if (!mysqli_errno($active_db)) {    return $result;  }  else {    // Indicate to drupal_error_handler that this is a database error.    ${DB_ERROR} = TRUE;    trigger_error(check_plain(mysqli_error($active_db) ."\nquery: ". $query), E_USER_WARNING);    return FALSE;  }}/** * Fetch one result row from the previous query as an object. * * @param $result *   A database query result resource, as returned from db_query(). * @return *   An object representing the next row of the result, or FALSE. The attributes *   of this object are the table fields selected by the query. */function db_fetch_object($result) {  if ($result) {    $object = mysqli_fetch_object($result);    return isset($object) ? $object : FALSE;  }}/** * Fetch one result row from the previous query as an array. * * @param $result *   A database query result resource, as returned from db_query(). * @return *   An associative array representing the next row of the result, or FALSE. *   The keys of this object are the names of the table fields selected by the *   query, and the values are the field values for this result row. */function db_fetch_array($result) {  if ($result) {    $array = mysqli_fetch_array($result, MYSQLI_ASSOC);    return isset($array) ? $array : FALSE;  }}/** * Return an individual result field from the previous query. * * Only use this function if exactly one field is being selected; otherwise, * use db_fetch_object() or db_fetch_array(). * * @param $result *   A database query result resource, as returned from db_query(). * @return *   The resulting field or FALSE. */function db_result($result) {  if ($result && mysqli_num_rows($result) > 0) {    // The mysqli_fetch_row function has an optional second parameter $row    // but that can't be used for compatibility with Oracle, DB2, etc.    $array = mysqli_fetch_row($result);    return $array[0];  }  return FALSE;}/** * Determine whether the previous query caused an error. */function db_error() {  global $active_db;  return mysqli_errno($active_db);}/** * Determine the number of rows changed by the preceding query. */function db_affected_rows() {  global $active_db; /* mysqli connection resource */  return mysqli_affected_rows($active_db);}/** * Runs a limited-range query in the active database. * * Use this as a substitute for db_query() when a subset of the query is to be * returned. * User-supplied arguments to the query should be passed in as separate parameters * so that they can be properly escaped to avoid SQL injection attacks. * * @param $query *   A string containing an SQL query. * @param ... *   A variable number of arguments which are substituted into the query *   using printf() syntax. The query arguments can be enclosed in one *   array instead. *   Valid %-modifiers are: %s, %d, %f, %b (binary data, do not enclose *   in '') and %%. * *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0, *   and TRUE values to decimal 1. * * @param $from *   The first result row to return. * @param $count *   The maximum number of result rows to return. * @return *   A database query result resource, or FALSE if the query was not executed *   correctly. */function db_query_range($query) {  $args = func_get_args();  $count = array_pop($args);  $from = array_pop($args);  array_shift($args);  $query = db_prefix_tables($query);  if (isset($args[0]) and is_array($args[0])) { // 'All arguments in one array' syntax    $args = $args[0];  }  _db_query_callback($args, TRUE);  $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);  $query .= ' LIMIT '. (int)$from .', '. (int)$count;  return _db_query($query);}/** * Runs a SELECT query and stores its results in a temporary table. * * Use this as a substitute for db_query() when the results need to stored * in a temporary table. Temporary tables exist for the duration of the page * request. * User-supplied arguments to the query should be passed in as separate parameters * so that they can be properly escaped to avoid SQL injection attacks. * * Note that if you need to know how many results were returned, you should do * a SELECT COUNT(*) on the temporary table afterwards. db_affected_rows() does * not give consistent result across different database types in this case. * * @param $query *   A string containing a normal SELECT SQL query. * @param ... *   A variable number of arguments which are substituted into the query *   using printf() syntax. The query arguments can be enclosed in one *   array instead. *   Valid %-modifiers are: %s, %d, %f, %b (binary data, do not enclose *   in '') and %%. * *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0, *   and TRUE values to decimal 1. * * @param $table *   The name of the temporary table to select into. This name will not be *   prefixed as there is no risk of collision. * @return *   A database query result resource, or FALSE if the query was not executed *   correctly. */function db_query_temporary($query) {  $args = func_get_args();  $tablename = array_pop($args);  array_shift($args);  $query = preg_replace('/^SELECT/i', 'CREATE TEMPORARY TABLE '. $tablename .' Engine=HEAP SELECT', db_prefix_tables($query));  if (isset($args[0]) and is_array($args[0])) { // 'All arguments in one array' syntax    $args = $args[0];  }  _db_query_callback($args, TRUE);  $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);  return _db_query($query);}/** * Returns a properly formatted Binary Large Object value. * * @param $data *   Data to encode. * @return *  Encoded data. */function db_encode_blob($data) {  global $active_db;  return "'". mysqli_real_escape_string($active_db, $data) ."'";}/** * Returns text from a Binary Large OBject value. * * @param $data *   Data to decode. * @return *  Decoded data. */function db_decode_blob($data) {  return $data;}/** * Prepare user input for use in a database query, preventing SQL injection attacks. */function db_escape_string($text) {  global $active_db;  return mysqli_real_escape_string($active_db, $text);}/** * Lock a table. */function db_lock_table($table) {  db_query('LOCK TABLES {'. db_escape_table($table) .'} WRITE');}/** * Unlock all locked tables. */function db_unlock_tables() {  db_query('UNLOCK TABLES');}/** * Check if a table exists. */function db_table_exists($table) {  return (bool) db_fetch_object(db_query("SHOW TABLES LIKE '{". db_escape_table($table) ."}'"));}/** * Check if a column exists in the given table. */function db_column_exists($table, $column) {  return (bool) db_fetch_object(db_query("SHOW COLUMNS FROM {". db_escape_table($table) ."} LIKE '". db_escape_table($column) ."'"));}/** * @} End of "ingroup database". */
<?php// $Id$?>  <div class="box">    <?php if ($title) { ?><h2 class="title"><?php print $title; ?></h2><?php } ?>    <div class="content"><?php print $content; ?></div> </div>
<?php// $Id$?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="<?php print $language->language ?>" xml:lang="<?php print $language->language ?>" dir="<?php print $language->dir ?>"><head>  <meta http-equiv="Content-Style-Type" content="text/css" />  <?php print $head ?>  <title><?php print $head_title ?></title>  <?php print $styles ?>  <?php print $scripts ?></head><body><div class="hide"><a href="#content" title="<?php print t('Skip navigation') ?>." accesskey="2"><?php print t('Skip navigation') ?></a>.</div><table id="primary-menu" summary="Navigation elements." border="0" cellpadding="0" cellspacing="0" width="100%">  <tr>    <td id="home" width="10%">      <?php if ($logo) : ?>        <a href="<?php print $front_page ?>" title="<?php print t('Home') ?>"><img src="<?php print($logo) ?>" alt="<?php print t('Home') ?>" border="0" /></a>      <?php endif; ?>    </td>    <td id="site-info" width="20%">      <?php if ($site_name) : ?>        <div class='site-name'><a href="<?php print $front_page ?>" title="<?php print t('Home') ?>"><?php print($site_name) ?></a></div>      <?php endif;?>      <?php if ($site_slogan) : ?>        <div class='site-slogan'><?php print($site_slogan) ?></div>      <?php endif;?>    </td>    <td class="primary-links" width="70%" align="center" valign="middle">      <?php print theme('links', $primary_links, array('class' => 'links', 'id' => 'navlist')) ?>    </td>  </tr></table><table id="secondary-menu" summary="Navigation elements." border="0" cellpadding="0" cellspacing="0" width="100%">  <tr>    <td class="secondary-links" width="75%"  align="center" valign="middle">      <?php print theme('links', $secondary_links, array('class' => 'links', 'id' => 'subnavlist')) ?>    </td>    <td width="25%" align="center" valign="middle">      <?php print $search_box ?>    </td>  </tr>  <tr>    <td colspan="2"><div><?php print $header ?></div></td>  </tr></table><table id="content" border="0" cellpadding="15" cellspacing="0" width="100%">  <tr>    <?php if ($left != ""): ?>    <td id="sidebar-left">      <?php print $left ?>    </td>    <?php endif; ?>    <td valign="top">      <?php if ($mission != ""): ?>      <div id="mission"><?php print $mission ?></div>      <?php endif; ?>      <div id="main">        <?php if ($title != ""): ?>          <?php print $breadcrumb ?>          <h1 class="title"><?php print $title ?></h1>          <?php if ($tabs != ""): ?>            <div class="tabs"><?php print $tabs ?></div>          <?php endif; ?>        <?php endif; ?>        <?php if ($show_messages && $messages != ""): ?>          <?php print $messages ?>        <?php endif; ?>        <?php if ($help != ""): ?>            <div id="help"><?php print $help ?></div>        <?php endif; ?>      <!-- start main content -->      <?php print $content; ?>      <?php print $feed_icons; ?>      <!-- end main content -->      </div><!-- main -->    </td>    <?php if ($right != ""): ?>    <td id="sidebar-right">      <?php print $right ?>    </td>    <?php endif; ?>  </tr></table><table id="footer-menu" summary="Navigation elements." border="0" cellpadding="0" cellspacing="0" width="100%">  <tr>    <td align="center" valign="middle">    <?php if (isset($primary_links)) : ?>      <?php print theme('links', $primary_links, array('class' => 'links primary-links')) ?>    <?php endif; ?>    <?php if (isset($secondary_links)) : ?>      <?php print theme('links', $secondary_links, array('class' => 'links secondary-links')) ?>    <?php endif; ?>    </td>  </tr></table><?php if ($footer_message || $footer) : ?><div id="footer-message">    <?php print $footer_message . $footer;?></div><?php endif; ?><?php print $closure;?></body></html>
<?php// $Id$/** * @file * Handles incoming requests to fire off regularly-scheduled tasks (cron jobs). */include_once './includes/bootstrap.inc';drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);drupal_cron_run();
<?php// $Id$/** * @file poll-bar-block.tpl.php * Display the bar for a single choice in a poll * * Variables available: * - $title: The title of the poll. * - $votes: The number of votes for this choice * - $total_votes: The number of votes for this choice * - $percentage: The percentage of votes for this choice. * - $vote: The choice number of the current user's vote. * - $voted: Set to TRUE if the user voted for this choice. * * @see template_preprocess_poll_bar() */?><div class="text"><?php print $title; ?></div><div class="bar">  <div style="width: <?php print $percentage; ?>%;" class="foreground"></div></div><div class="percent">  <?php print $percentage; ?>%</div>
<?php// $Id$/** * @file user-profile.tpl.php * Default theme implementation to present all user profile data. * * This template is used when viewing a registered member's profile page, * e.g., example.com/user/123. 123 being the users ID. * * By default, all user profile data is printed out with the $user_profile * variable. If there is a need to break it up you can use $profile instead. * It is keyed to the name of each category or other data attached to the * account. If it is a category it will contain all the profile items. By * default $profile['summary'] is provided which contains data on the user's * history. Other data can be included by modules. $profile['user_picture'] is * available by default showing the account picture. * * Also keep in mind that profile items and their categories can be defined by * site administrators. They are also available within $profile. For example, * if a site is configured with a category of "contact" with * fields for of addresses, phone numbers and other related info, then doing a * straight print of $profile['contact'] will output everything in the * category. This is useful for altering source order and adding custom * markup for the group. * * To check for all available data within $profile, use the code below. * @code *   print '<pre>'. check_plain(print_r($profile, 1)) .'</pre>'; * @endcode * * Available variables: *   - $user_profile: All user profile data. Ready for print. *   - $profile: Keyed array of profile categories and their items or other data *     provided by modules. * * @see user-profile-category.tpl.php *   Where the html is handled for the group. * @see user-profile-item.tpl.php *   Where the html is handled for each item in the group. * @see template_preprocess_user_profile() */?><div class="profile">  <?php print $user_profile; ?></div>
<?php// $Id$/** * @file search-result.tpl.php * Default theme implementation for displaying a single search result. * * This template renders a single search result and is collected into * search-results.tpl.php. This and the parent template are * dependent to one another sharing the markup for definition lists. * * Available variables: * - $url: URL of the result. * - $title: Title of the result. * - $snippet: A small preview of the result. Does not apply to user searches. * - $info: String of all the meta information ready for print. Does not apply *   to user searches. * - $info_split: Contains same data as $info, split into a keyed array. * - $type: The type of search, e.g., "node" or "user". * * Default keys within $info_split: * - $info_split['type']: Node type. * - $info_split['user']: Author of the node linked to users profile. Depends *   on permission. * - $info_split['date']: Last update of the node. Short formatted. * - $info_split['comment']: Number of comments output as "% comments", % *   being the count. Depends on comment.module. * - $info_split['upload']: Number of attachments output as "% attachments", % *   being the count. Depends on upload.module. * * Since $info_split is keyed, a direct print of the item is possible. * This array does not apply to user searches so it is recommended to check * for their existance before printing. The default keys of 'type', 'user' and * 'date' always exist for node searches. Modules may provide other data. * *   <?php if (isset($info_split['comment'])) : ?> *     <span class="info-comment"> *       <?php print $info_split['comment']; ?> *     </span> *   <?php endif; ?> * * To check for all available data within $info_split, use the code below. * *   <?php print '<pre>'. check_plain(print_r($info_split, 1)) .'</pre>'; ?> * * @see template_preprocess_search_result() */?><dt class="title">  <a href="<?php print $url; ?>"><?php print $title; ?></a></dt><dd>  <?php if ($snippet) : ?>    <p class="search-snippet"><?php print $snippet; ?></p>  <?php endif; ?>  <?php if ($info) : ?>  <p class="search-info"><?php print $info; ?></p>  <?php endif; ?></dd>
<?php// $Id$/** * @file comment-wrapper.tpl.php * Default theme implementation to wrap aggregator content. * * Available variables: * - $content: All aggregator content. * - $page: Pager links rendered through theme_pager(). * * @see template_preprocess() * @see template_preprocess_comment_wrapper() */?><div id="aggregator">  <?php print $content; ?>  <?php print $pager; ?></div>
<?php// $Id$/** * @file * Functions shared between mysql and mysqli database engines. *//** * Runs a basic query in the active database. * * User-supplied arguments to the query should be passed in as separate * parameters so that they can be properly escaped to avoid SQL injection * attacks. * * @param $query *   A string containing an SQL query. * @param ... *   A variable number of arguments which are substituted into the query *   using printf() syntax. Instead of a variable number of query arguments, *   you may also pass a single array containing the query arguments. * *   Valid %-modifiers are: %s, %d, %f, %b (binary data, do not enclose *   in '') and %%. * *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0, *   and TRUE values to decimal 1. * * @return *   A database query result resource, or FALSE if the query was not *   executed correctly. */function db_query($query) {  $args = func_get_args();  array_shift($args);  $query = db_prefix_tables($query);  if (isset($args[0]) and is_array($args[0])) { // 'All arguments in one array' syntax    $args = $args[0];  }  _db_query_callback($args, TRUE);  $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);  return _db_query($query);}/** * @ingroup schemaapi * @{ *//** * Generate SQL to create a new table from a Drupal schema definition. * * @param $name *   The name of the table to create. * @param $table *   A Schema API table definition array. * @return *   An array of SQL statements to create the table. */function db_create_table_sql($name, $table) {  if (empty($table['mysql_suffix'])) {    $table['mysql_suffix'] = "/*!40100 DEFAULT CHARACTER SET UTF8 */";  }  $sql = "CREATE TABLE {". $name ."} (\n";  // Add the SQL statement for each field.  foreach ($table['fields'] as $field_name => $field) {    $sql .= _db_create_field_sql($field_name, _db_process_field($field)) .", \n";  }  // Process keys & indexes.  $keys = _db_create_keys_sql($table);  if (count($keys)) {    $sql .= implode(", \n", $keys) .", \n";  }  // Remove the last comma and space.  $sql = substr($sql, 0, -3) ."\n) ";  $sql .= $table['mysql_suffix'];  return array($sql);}function _db_create_keys_sql($spec) {  $keys = array();  if (!empty($spec['primary key'])) {    $keys[] = 'PRIMARY KEY ('. _db_create_key_sql($spec['primary key']) .')';  }  if (!empty($spec['unique keys'])) {    foreach ($spec['unique keys'] as $key => $fields) {      $keys[] = 'UNIQUE KEY '. $key .' ('. _db_create_key_sql($fields) .')';    }  }  if (!empty($spec['indexes'])) {    foreach ($spec['indexes'] as $index => $fields) {      $keys[] = 'INDEX '. $index .' ('. _db_create_key_sql($fields) .')';    }  }  return $keys;}function _db_create_key_sql($fields) {  $ret = array();  foreach ($fields as $field) {    if (is_array($field)) {      $ret[] = $field[0] .'('. $field[1] .')';    }    else {      $ret[] = $field;    }  }  return implode(', ', $ret);}/** * Set database-engine specific properties for a field. * * @param $field *   A field description array, as specified in the schema documentation. */function _db_process_field($field) {  if (!isset($field['size'])) {    $field['size'] = 'normal';  }  // Set the correct database-engine specific datatype.  if (!isset($field['mysql_type'])) {    $map = db_type_map();    $field['mysql_type'] = $map[$field['type'] .':'. $field['size']];  }  if ($field['type'] == 'serial') {    $field['auto_increment'] = TRUE;  }  return $field;}/** * Create an SQL string for a field to be used in table creation or alteration. * * Before passing a field out of a schema definition into this function it has * to be processed by _db_process_field(). * * @param $name *    Name of the field. * @param $spec *    The field specification, as per the schema data structure format. */function _db_create_field_sql($name, $spec) {  $sql = "`". $name ."` ". $spec['mysql_type'];  if (in_array($spec['type'], array('varchar', 'char', 'text')) && isset($spec['length'])) {    $sql .= '('. $spec['length'] .')';  }  elseif (isset($spec['precision']) && isset($spec['scale'])) {    $sql .= '('. $spec['precision'] .', '. $spec['scale'] .')';  }  if (!empty($spec['unsigned'])) {    $sql .= ' unsigned';  }  if (!empty($spec['not null'])) {    $sql .= ' NOT NULL';  }  if (!empty($spec['auto_increment'])) {    $sql .= ' auto_increment';  }  if (isset($spec['default'])) {    if (is_string($spec['default'])) {      $spec['default'] = "'". $spec['default'] ."'";    }    $sql .= ' DEFAULT '. $spec['default'];  }  if (empty($spec['not null']) && !isset($spec['default'])) {    $sql .= ' DEFAULT NULL';  }  return $sql;}/** * This maps a generic data type in combination with its data size * to the engine-specific data type. */function db_type_map() {  // Put :normal last so it gets preserved by array_flip.  This makes  // it much easier for modules (such as schema.module) to map  // database types back into schema types.  $map = array(    'varchar:normal'  => 'VARCHAR',    'char:normal'     => 'CHAR',    'text:tiny'       => 'TINYTEXT',    'text:small'      => 'TINYTEXT',    'text:medium'     => 'MEDIUMTEXT',    'text:big'        => 'LONGTEXT',    'text:normal'     => 'TEXT',    'serial:tiny'     => 'TINYINT',    'serial:small'    => 'SMALLINT',    'serial:medium'   => 'MEDIUMINT',    'serial:big'      => 'BIGINT',    'serial:normal'   => 'INT',    'int:tiny'        => 'TINYINT',    'int:small'       => 'SMALLINT',    'int:medium'      => 'MEDIUMINT',    'int:big'         => 'BIGINT',    'int:normal'      => 'INT',    'float:tiny'      => 'FLOAT',    'float:small'     => 'FLOAT',    'float:medium'    => 'FLOAT',    'float:big'       => 'DOUBLE',    'float:normal'    => 'FLOAT',    'numeric:normal'  => 'DECIMAL',    'blob:big'        => 'LONGBLOB',    'blob:normal'     => 'BLOB',    'datetime:normal' => 'DATETIME',  );  return $map;}/** * Rename a table. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be renamed. * @param $new_name *   The new name for the table. */function db_rename_table(&$ret, $table, $new_name) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} RENAME TO {'. $new_name .'}');}/** * Drop a table. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be dropped. */function db_drop_table(&$ret, $table) {  $ret[] = update_sql('DROP TABLE {'. $table .'}');}/** * Add a new field to a table. * * @param $ret *   Array to which query results will be added. * @param $table *   Name of the table to be altered. * @param $field *   Name of the field to be added. * @param $spec *   The field specification array, as taken from a schema definition. *   The specification may also contain the key 'initial', the newly *   created field will be set to the value of the key in all rows. *   This is most useful for creating NOT NULL columns with no default *   value in existing tables. * @param $keys_new *   Optional keys and indexes specification to be created on the *   table along with adding the field. The format is the same as a *   table specification but without the 'fields' element.  If you are *   adding a type 'serial' field, you MUST specify at least one key *   or index including it in this array. @see db_change_field for more *   explanation why. */function db_add_field(&$ret, $table, $field, $spec, $keys_new = array()) {  $fixnull = FALSE;  if (!empty($spec['not null']) && !isset($spec['default'])) {    $fixnull = TRUE;    $spec['not null'] = FALSE;  }  $query = 'ALTER TABLE {'. $table .'} ADD ';  $query .= _db_create_field_sql($field, _db_process_field($spec));  if (count($keys_new)) {    $query .= ', ADD '. implode(', ADD ', _db_create_keys_sql($keys_new));  }  $ret[] = update_sql($query);  if (isset($spec['initial'])) {    // All this because update_sql does not support %-placeholders.    $sql = 'UPDATE {'. $table .'} SET '. $field .' = '. db_type_placeholder($spec['type']);    $result = db_query($sql, $spec['initial']);    $ret[] = array('success' => $result !== FALSE, 'query' => check_plain($sql .' ('. $spec['initial'] .')'));  }  if ($fixnull) {    $spec['not null'] = TRUE;    db_change_field($ret, $table, $field, $field, $spec);  }}/** * Drop a field. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $field *   The field to be dropped. */function db_drop_field(&$ret, $table, $field) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP '. $field);}/** * Set the default value for a field. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $field *   The field to be altered. * @param $default *   Default value to be set. NULL for 'default NULL'. */function db_field_set_default(&$ret, $table, $field, $default) {  if ($default === NULL) {    $default = 'NULL';  }  else {    $default = is_string($default) ? "'$default'" : $default;  }  $ret[] = update_sql('ALTER TABLE {'. $table .'} ALTER COLUMN '. $field .' SET DEFAULT '. $default);}/** * Set a field to have no default value. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $field *   The field to be altered. */function db_field_set_no_default(&$ret, $table, $field) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} ALTER COLUMN '. $field .' DROP DEFAULT');}/** * Add a primary key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $fields *   Fields for the primary key. */function db_add_primary_key(&$ret, $table, $fields) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} ADD PRIMARY KEY ('.    _db_create_key_sql($fields) .')');}/** * Drop the primary key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. */function db_drop_primary_key(&$ret, $table) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP PRIMARY KEY');}/** * Add a unique key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the key. * @param $fields *   An array of field names. */function db_add_unique_key(&$ret, $table, $name, $fields) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} ADD UNIQUE KEY '.    $name .' ('. _db_create_key_sql($fields) .')');}/** * Drop a unique key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the key. */function db_drop_unique_key(&$ret, $table, $name) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP KEY '. $name);}/** * Add an index. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the index. * @param $fields *   An array of field names. */function db_add_index(&$ret, $table, $name, $fields) {  $query = 'ALTER TABLE {'. $table .'} ADD INDEX '. $name .' ('. _db_create_key_sql($fields) .')';  $ret[] = update_sql($query);}/** * Drop an index. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the index. */function db_drop_index(&$ret, $table, $name) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP INDEX '. $name);}/** * Change a field definition. * * IMPORTANT NOTE: To maintain database portability, you have to explicitly * recreate all indices and primary keys that are using the changed field. * * That means that you have to drop all affected keys and indexes with * db_drop_{primary_key,unique_key,index}() before calling db_change_field(). * To recreate the keys and indices, pass the key definitions as the * optional $keys_new argument directly to db_change_field(). * * For example, suppose you have: * @code * $schema['foo'] = array( *   'fields' => array( *     'bar' => array('type' => 'int', 'not null' => TRUE) *   ), *   'primary key' => array('bar') * ); * @endcode * and you want to change foo.bar to be type serial, leaving it as the * primary key.  The correct sequence is: * @code * db_drop_primary_key($ret, 'foo'); * db_change_field($ret, 'foo', 'bar', 'bar', *   array('type' => 'serial', 'not null' => TRUE), *   array('primary key' => array('bar'))); * @endcode * * The reasons for this are due to the different database engines: * * On PostgreSQL, changing a field definition involves adding a new field * and dropping an old one which* causes any indices, primary keys and * sequences (from serial-type fields) that use the changed field to be dropped. * * On MySQL, all type 'serial' fields must be part of at least one key * or index as soon as they are created.  You cannot use * db_add_{primary_key,unique_key,index}() for this purpose because * the ALTER TABLE command will fail to add the column without a key * or index specification.  The solution is to use the optional * $keys_new argument to create the key or index at the same time as * field. * * You could use db_add_{primary_key,unique_key,index}() in all cases * unless you are converting a field to be type serial. You can use * the $keys_new argument in all cases. * * @param $ret *   Array to which query results will be added. * @param $table *   Name of the table. * @param $field *   Name of the field to change. * @param $field_new *   New name for the field (set to the same as $field if you don't want to change the name). * @param $spec *   The field specification for the new field. * @param $keys_new *   Optional keys and indexes specification to be created on the *   table along with changing the field. The format is the same as a *   table specification but without the 'fields' element. */function db_change_field(&$ret, $table, $field, $field_new, $spec, $keys_new = array()) {  $sql = 'ALTER TABLE {'. $table .'} CHANGE `'. $field .'` '.    _db_create_field_sql($field_new, _db_process_field($spec));  if (count($keys_new)) {    $sql .= ', ADD '. implode(', ADD ', _db_create_keys_sql($keys_new));  }  $ret[] = update_sql($sql);}/** * Returns the last insert id. * * @param $table *   The name of the table you inserted into. * @param $field *   The name of the autoincrement field. */function db_last_insert_id($table, $field) {  return db_result(db_query('SELECT LAST_INSERT_ID()'));}
<?php// $Id$/** * @file * Admin page callbacks for the comment module. *//** * Menu callback; present an administrative comment listing. */function comment_admin($type = 'new') {  $edit = $_POST;  if (isset($edit['operation']) && ($edit['operation'] == 'delete') && isset($edit['comments']) && $edit['comments']) {    return drupal_get_form('comment_multiple_delete_confirm');  }  else {    return drupal_get_form('comment_admin_overview', $type, arg(4));  }}/** * Form builder; Builds the comment overview form for the admin. * * @param $type *   Not used. * @param $arg *   Current path's fourth component deciding the form type (Published comments/Approval queue) * @return *   The form structure. * @ingroup forms * @see comment_admin_overview_validate() * @see comment_admin_overview_submit() * @see theme_comment_admin_overview() */function comment_admin_overview($type = 'new', $arg) {  // build an 'Update options' form  $form['options'] = array(    '#type' => 'fieldset', '#title' => t('Update options'),    '#prefix' => '<div class="container-inline">', '#suffix' => '</div>'  );  $options = array();  foreach (comment_operations($arg == 'approval' ? 'publish' : 'unpublish') as $key => $value) {    $options[$key] = $value[0];  }  $form['options']['operation'] = array('#type' => 'select', '#options' => $options, '#default_value' => 'publish');  $form['options']['submit'] = array('#type' => 'submit', '#value' => t('Update'));  // load the comments that we want to display  $status = ($arg == 'approval') ? COMMENT_NOT_PUBLISHED : COMMENT_PUBLISHED;  $form['header'] = array('#type' => 'value', '#value' => array(    theme('table_select_header_cell'),    array('data' => t('Subject'), 'field' => 'subject'),    array('data' => t('Author'), 'field' => 'name'),    array('data' => t('Posted in'), 'field' => 'node_title'),    array('data' => t('Time'), 'field' => 'timestamp', 'sort' => 'desc'),    array('data' => t('Operations'))  ));  $result = pager_query('SELECT c.subject, c.nid, c.cid, c.comment, c.timestamp, c.status, c.name, c.homepage, u.name AS registered_name, u.uid, n.title as node_title FROM {comments} c INNER JOIN {users} u ON u.uid = c.uid INNER JOIN {node} n ON n.nid = c.nid WHERE c.status = %d'. tablesort_sql($form['header']['#value']), 50, 0, NULL, $status);  // build a table listing the appropriate comments  $destination = drupal_get_destination();  while ($comment = db_fetch_object($result)) {    $comments[$comment->cid] = '';    $comment->name = $comment->uid ? $comment->registered_name : $comment->name;    $form['subject'][$comment->cid] = array('#value' => l($comment->subject, 'node/'. $comment->nid, array('attributes' => array('title' => truncate_utf8($comment->comment, 128)), 'fragment' => 'comment-'. $comment->cid)));    $form['username'][$comment->cid] = array('#value' => theme('username', $comment));    $form['node_title'][$comment->cid] = array('#value' => l($comment->node_title, 'node/'. $comment->nid));    $form['timestamp'][$comment->cid] = array('#value' => format_date($comment->timestamp, 'small'));    $form['operations'][$comment->cid] = array('#value' => l(t('edit'), 'comment/edit/'. $comment->cid, array('query' => $destination)));  }  $form['comments'] = array('#type' => 'checkboxes', '#options' => isset($comments) ? $comments: array());  $form['pager'] = array('#value' => theme('pager', NULL, 50, 0));  return $form;}/** * Validate comment_admin_overview form submissions. * * We can't execute any 'Update options' if no comments were selected. */function comment_admin_overview_validate($form, &$form_state) {  $form_state['values']['comments'] = array_diff($form_state['values']['comments'], array(0));  if (count($form_state['values']['comments']) == 0) {    form_set_error('', t('Please select one or more comments to perform the update on.'));  }}/** * Process comment_admin_overview form submissions. * * Execute the chosen 'Update option' on the selected comments, such as * publishing, unpublishing or deleting. */function comment_admin_overview_submit($form, &$form_state) {  $operations = comment_operations();  if (!empty($operations[$form_state['values']['operation']][1])) {    // extract the appropriate database query operation    $query = $operations[$form_state['values']['operation']][1];    foreach ($form_state['values']['comments'] as $cid => $value) {      if ($value) {        // perform the update action, then refresh node statistics        db_query($query, $cid);        $comment = _comment_load($cid);        _comment_update_node_statistics($comment->nid);        // Allow modules to respond to the updating of a comment.        comment_invoke_comment($comment, $form_state['values']['operation']);        // Add an entry to the watchdog log.        watchdog('content', 'Comment: updated %subject.', array('%subject' => $comment->subject), WATCHDOG_NOTICE, l(t('view'), 'node/'. $comment->nid, array('fragment' => 'comment-'. $comment->cid)));      }    }    cache_clear_all();    drupal_set_message(t('The update has been performed.'));    $form_state['redirect'] = 'admin/content/comment';  }}/** * Theme the comment admin form. * * @param $form *   An associative array containing the structure of the form. * @ingroup themeable */function theme_comment_admin_overview($form) {  $output = drupal_render($form['options']);  if (isset($form['subject']) && is_array($form['subject'])) {    foreach (element_children($form['subject']) as $key) {      $row = array();      $row[] = drupal_render($form['comments'][$key]);      $row[] = drupal_render($form['subject'][$key]);      $row[] = drupal_render($form['username'][$key]);      $row[] = drupal_render($form['node_title'][$key]);      $row[] = drupal_render($form['timestamp'][$key]);      $row[] = drupal_render($form['operations'][$key]);      $rows[] = $row;    }  }  else {    $rows[] = array(array('data' => t('No comments available.'), 'colspan' => '6'));  }  $output .= theme('table', $form['header']['#value'], $rows);  if ($form['pager']['#value']) {    $output .= drupal_render($form['pager']);  }  $output .= drupal_render($form);  return $output;}/** * List the selected comments and verify that the admin really wants to delete * them. * * @param $form_state *   An associative array containing the current state of the form. * @return *   TRUE if the comments should be deleted, FALSE otherwise. * @ingroup forms * @see comment_multiple_delete_confirm_submit() */function comment_multiple_delete_confirm(&$form_state) {  $edit = $form_state['post'];  $form['comments'] = array('#prefix' => '<ul>', '#suffix' => '</ul>', '#tree' => TRUE);  // array_filter() returns only elements with actual values  $comment_counter = 0;  foreach (array_filter($edit['comments']) as $cid => $value) {    $comment = _comment_load($cid);    if (is_object($comment) && is_numeric($comment->cid)) {      $subject = db_result(db_query('SELECT subject FROM {comments} WHERE cid = %d', $cid));      $form['comments'][$cid] = array('#type' => 'hidden', '#value' => $cid, '#prefix' => '<li>', '#suffix' => check_plain($subject) .'</li>');      $comment_counter++;    }  }  $form['operation'] = array('#type' => 'hidden', '#value' => 'delete');  if (!$comment_counter) {    drupal_set_message(t('There do not appear to be any comments to delete or your selected comment was deleted by another administrator.'));    drupal_goto('admin/content/comment');  }  else {    return confirm_form($form,                        t('Are you sure you want to delete these comments and all their children?'),                        'admin/content/comment', t('This action cannot be undone.'),                        t('Delete comments'), t('Cancel'));  }}/** * Process comment_multiple_delete_confirm form submissions. * * Perform the actual comment deletion. */function comment_multiple_delete_confirm_submit($form, &$form_state) {  if ($form_state['values']['confirm']) {    foreach ($form_state['values']['comments'] as $cid => $value) {      $comment = _comment_load($cid);      _comment_delete_thread($comment);      _comment_update_node_statistics($comment->nid);    }    cache_clear_all();    drupal_set_message(t('The comments have been deleted.'));  }  $form_state['redirect'] = 'admin/content/comment';}/** * Menu callback; delete a comment. * * @param $cid *   The comment do be deleted. */function comment_delete($cid = NULL) {  $comment = db_fetch_object(db_query('SELECT c.*, u.name AS registered_name, u.uid FROM {comments} c INNER JOIN {users} u ON u.uid = c.uid WHERE c.cid = %d', $cid));  $comment->name = $comment->uid ? $comment->registered_name : $comment->name;  $output = '';  if (is_object($comment) && is_numeric($comment->cid)) {    $output = drupal_get_form('comment_confirm_delete', $comment);  }  else {    drupal_set_message(t('The comment no longer exists.'));  }  return $output;}/** * Form builder; Builds the confirmation form for deleting a single comment. * * @ingroup forms * @see comment_confirm_delete_submit() */function comment_confirm_delete(&$form_state, $comment) {  $form = array();  $form['#comment'] = $comment;  return confirm_form(    $form,    t('Are you sure you want to delete the comment %title?', array('%title' => $comment->subject)),    'node/'. $comment->nid,    t('Any replies to this comment will be lost. This action cannot be undone.'),    t('Delete'),    t('Cancel'),    'comment_confirm_delete');}/** * Process comment_confirm_delete form submissions. */function comment_confirm_delete_submit($form, &$form_state) {  drupal_set_message(t('The comment and all its replies have been deleted.'));  $comment = $form['#comment'];  // Delete comment and its replies.  _comment_delete_thread($comment);  _comment_update_node_statistics($comment->nid);  // Clear the cache so an anonymous user sees that his comment was deleted.  cache_clear_all();  $form_state['redirect'] = "node/$comment->nid";}/** * Perform the actual deletion of a comment and all its replies. * * @param $comment *   An associative array describing the comment to be deleted. */function _comment_delete_thread($comment) {  if (!is_object($comment) || !is_numeric($comment->cid)) {    watchdog('content', 'Cannot delete non-existent comment.', array(), WATCHDOG_WARNING);    return;  }  // Delete the comment:  db_query('DELETE FROM {comments} WHERE cid = %d', $comment->cid);  watchdog('content', 'Comment: deleted %subject.', array('%subject' => $comment->subject));  comment_invoke_comment($comment, 'delete');  // Delete the comment's replies  $result = db_query('SELECT c.*, u.name AS registered_name, u.uid FROM {comments} c INNER JOIN {users} u ON u.uid = c.uid WHERE pid = %d', $comment->cid);  while ($comment = db_fetch_object($result)) {    $comment->name = $comment->uid ? $comment->registered_name : $comment->name;    _comment_delete_thread($comment);  }}
<?php// $Id$/** * @file block.tpl.php * * Theme implementation to display a block. * * Available variables: * - $block->subject: Block title. * - $block->content: Block content. * - $block->module: Module that generated the block. * - $block->delta: This is a numeric id connected to each module. * - $block->region: The block region embedding the current block. * * Helper variables: * - $block_zebra: Outputs 'odd' and 'even' dependent on each block region. * - $zebra: Same output as $block_zebra but independent of any block region. * - $block_id: Counter dependent on each block region. * - $id: Same output as $block_id but independent of any block region. * - $is_front: Flags true when presented in the front page. * - $logged_in: Flags true when the current user is a logged-in member. * - $is_admin: Flags true when the current user is an administrator. * * @see template_preprocess() * @see template_preprocess_block() */?><div id="block-<?php print $block->module .'-'. $block->delta; ?>" class="block block-<?php print $block->module ?>"><?php if ($block->subject): ?>  <h2><?php print $block->subject ?></h2><?php endif;?>  <div class="content">    <?php print $block->content ?>  </div></div>
<?php// $Id$/** * @file poll-vote.tpl.php * Voting form for a poll. * * - $choice: The radio buttons for the choices in the poll. * - $title: The title of the poll. * - $block: True if this is being displayed as a block. * - $vote: The vote button * - $rest: Anything else in the form that may have been added via *   form_alter hooks. * * @see template_preprocess_poll_vote() */?><div class="poll">  <div class="vote-form">    <div class="choices">      <?php if ($block): ?>        <div class="title"><?php print $title; ?>:</div>      <?php endif; ?>      <?php print $choice; ?>    </div>    <?php print $vote; ?>  </div>  <?php // This is the 'rest' of the form, in case items have been added. ?>  <?php print $rest ?></div>
<?php// $Id$/** * @file * GD2 toolkit for image manipulation within Drupal. *//** * @ingroup image * @{ *//** * Retrieve information about the toolkit. */function image_gd_info() {  return array('name' => 'gd', 'title' => t('GD2 image manipulation toolkit'));}/** * Retrieve settings for the GD2 toolkit. */function image_gd_settings() {  if (image_gd_check_settings()) {    $form = array();    $form['status'] = array(      '#value' => t('The GD toolkit is installed and working properly.')    );    $form['image_jpeg_quality'] = array(      '#type' => 'textfield',      '#title' => t('JPEG quality'),      '#description' => t('Define the image quality for JPEG manipulations. Ranges from 0 to 100. Higher values mean better image quality but bigger files.'),      '#size' => 10,      '#maxlength' => 3,      '#default_value' => variable_get('image_jpeg_quality', 75),      '#field_suffix' => t('%'),    );    $form['#element_validate'] = array('image_gd_settings_validate');        return $form;  }  else {    form_set_error('image_toolkit', t('The GD image toolkit requires that the GD module for PHP be installed and configured properly. For more information see <a href="@url">PHP\'s image documentation</a>.', array('@url' => 'http://php.net/image')));    return FALSE;  }}/** * Validate the submitted GD settings. */function image_gd_settings_validate($form, &$form_state) {  // Validate image quality range.  $value = $form_state['values']['image_jpeg_quality'];  if (!is_numeric($value) || $value < 0 || $value > 100) {    form_set_error('image_jpeg_quality', t('JPEG quality must be a number between 0 and 100.'));  }}/** * Verify GD2 settings (that the right version is actually installed). * * @return *   A boolean indicating if the GD toolkit is avaiable on this machine. */function image_gd_check_settings() {  if ($check = get_extension_funcs('gd')) {    if (in_array('imagegd2', $check)) {      // GD2 support is available.      return TRUE;    }  }  return FALSE;}/** * Scale an image to the specified size using GD. */function image_gd_resize($source, $destination, $width, $height) {  if (!file_exists($source)) {    return FALSE;  }  $info = image_get_info($source);  if (!$info) {    return FALSE;  }  $im = image_gd_open($source, $info['extension']);  if (!$im) {    return FALSE;  }  $res = imagecreatetruecolor($width, $height);  if ($info['extension'] == 'png') {    $transparency = imagecolorallocatealpha($res, 0, 0, 0, 127);    imagealphablending($res, FALSE);    imagefilledrectangle($res, 0, 0, $width, $height, $transparency);    imagealphablending($res, TRUE);    imagesavealpha($res, TRUE);  }  elseif ($info['extension'] == 'gif') {    // If we have a specific transparent color.    $transparency_index = imagecolortransparent($im);    if ($transparency_index >= 0) {      // Get the original image's transparent color's RGB values.      $transparent_color = imagecolorsforindex($im, $transparency_index);      // Allocate the same color in the new image resource.      $transparency_index = imagecolorallocate($res, $transparent_color['red'], $transparent_color['green'], $transparent_color['blue']);      // Completely fill the background of the new image with allocated color.      imagefill($res, 0, 0, $transparency_index);      // Set the background color for new image to transparent.      imagecolortransparent($res, $transparency_index);      // Find number of colors in the images palette.      $number_colors = imagecolorstotal($im);      // Convert from true color to palette to fix transparency issues.      imagetruecolortopalette($res, TRUE, $number_colors);    }  }  imagecopyresampled($res, $im, 0, 0, 0, 0, $width, $height, $info['width'], $info['height']);  $result = image_gd_close($res, $destination, $info['extension']);  imagedestroy($res);  imagedestroy($im);  return $result;}/** * Rotate an image the given number of degrees. */function image_gd_rotate($source, $destination, $degrees, $background = 0x000000) {  if (!function_exists('imageRotate')) {    return FALSE;  }  $info = image_get_info($source);  if (!$info) {    return FALSE;  }  $im = image_gd_open($source, $info['extension']);  if (!$im) {    return FALSE;  }  $res = imageRotate($im, $degrees, $background);  $result = image_gd_close($res, $destination, $info['extension']);  return $result;}/** * Crop an image using the GD toolkit. */function image_gd_crop($source, $destination, $x, $y, $width, $height) {  $info = image_get_info($source);  if (!$info) {    return FALSE;  }  $im = image_gd_open($source, $info['extension']);  $res = imageCreateTrueColor($width, $height);  imageCopy($res, $im, 0, 0, $x, $y, $width, $height);  $result = image_gd_close($res, $destination, $info['extension']);  imageDestroy($res);  imageDestroy($im);  return $result;}/** * GD helper function to create an image resource from a file. * * @param $file *   A string file path where the iamge should be saved. * @param $extension *   A string containing one of the following extensions: gif, jpg, jpeg, png. * @return *   An image resource, or FALSE on error. */function image_gd_open($file, $extension) {  $extension = str_replace('jpg', 'jpeg', $extension);  $open_func = 'imageCreateFrom'. $extension;  if (!function_exists($open_func)) {    return FALSE;  }  return $open_func($file);}/** * GD helper to write an image resource to a destination file. * * @param $res *   An image resource created with image_gd_open(). * @param $destination *   A string file path where the iamge should be saved. * @param $extension *   A string containing one of the following extensions: gif, jpg, jpeg, png. * @return *   Boolean indicating success. */function image_gd_close($res, $destination, $extension) {  $extension = str_replace('jpg', 'jpeg', $extension);  $close_func = 'image'. $extension;  if (!function_exists($close_func)) {    return FALSE;  }  if ($extension == 'jpeg') {    return $close_func($res, $destination, variable_get('image_jpeg_quality', 75));  }  else {    return $close_func($res, $destination);  }}/** * @} End of "ingroup image". */
<?php/* $Id$ */function color_requirements($phase) {  $requirements = array();  if ($phase == 'runtime') {    // Check GD library    if (function_exists('imagegd2')) {      $info = gd_info();      $requirements['gd'] = array(        'value' => $info['GD Version'],      );      // Check PNG support      if (function_exists('imagecreatefrompng')) {        $requirements['gd']['severity'] = REQUIREMENT_OK;      }      else {        $requirements['gd']['severity'] = REQUIREMENT_ERROR;        $requirements['gd']['description'] = t('The GD library for PHP is enabled, but was compiled without PNG support. Please check the <a href="@url">PHP image documentation</a> for information on how to correct this.', array('@url' => 'http://www.php.net/manual/en/ref.image.php'));      }    }    else {      $requirements['gd'] = array(        'value' => t('Not installed'),        'severity' => REQUIREMENT_ERROR,        'description' => t('The GD library for PHP is missing or outdated. Please check the <a href="@url">PHP image documentation</a> for information on how to correct this.', array('@url' => 'http://www.php.net/manual/en/ref.image.php')),      );    }    $requirements['gd']['title'] = t('GD library');  }  return $requirements;}
<?php// $Id$/** * @file * Database interface code for PostgreSQL database servers. *//** * @ingroup database * @{ *//** * Report database status. */function db_status_report() {  $t = get_t();  $version = db_version();  $form['pgsql'] = array(    'title' => $t('PostgreSQL database'),    'value' => $version,  );  if (version_compare($version, DRUPAL_MINIMUM_PGSQL) < 0) {    $form['pgsql']['severity'] = REQUIREMENT_ERROR;    $form['pgsql']['description'] = $t('Your PostgreSQL Server is too old. Drupal requires at least PostgreSQL %version.', array('%version' => DRUPAL_MINIMUM_PGSQL));  }  return $form;}/** * Returns the version of the database server currently in use. * * @return Database server version */function db_version() {  return db_result(db_query("SHOW SERVER_VERSION"));}/** * Initialize a database connection. */function db_connect($url) {  // Check if PostgreSQL support is present in PHP  if (!function_exists('pg_connect')) {    _db_error_page('Unable to use the PostgreSQL database because the PostgreSQL extension for PHP is not installed. Check your <code>php.ini</code> to see how you can enable it.');  }  $url = parse_url($url);  $conn_string = '';  // Decode url-encoded information in the db connection string  if (isset($url['user'])) {    $conn_string .= ' user='. urldecode($url['user']);  }  if (isset($url['pass'])) {    $conn_string .= ' password='. urldecode($url['pass']);  }  if (isset($url['host'])) {    $conn_string .= ' host='. urldecode($url['host']);  }  if (isset($url['path'])) {    $conn_string .= ' dbname='. substr(urldecode($url['path']), 1);  }  if (isset($url['port'])) {    $conn_string .= ' port='. urldecode($url['port']);  }  // pg_last_error() does not return a useful error message for database  // connection errors. We must turn on error tracking to get at a good error  // message, which will be stored in $php_errormsg.  $track_errors_previous = ini_get('track_errors');  ini_set('track_errors', 1);  $connection = @pg_connect($conn_string);  if (!$connection) {    require_once './includes/unicode.inc';    _db_error_page(decode_entities($php_errormsg));  }  // Restore error tracking setting  ini_set('track_errors', $track_errors_previous);  pg_query($connection, "set client_encoding=\"UTF8\"");  return $connection;}/** * Runs a basic query in the active database. * * User-supplied arguments to the query should be passed in as separate * parameters so that they can be properly escaped to avoid SQL injection * attacks. * * @param $query *   A string containing an SQL query. * @param ... *   A variable number of arguments which are substituted into the query *   using printf() syntax. Instead of a variable number of query arguments, *   you may also pass a single array containing the query arguments. * *   Valid %-modifiers are: %s, %d, %f, %b (binary data, do not enclose *   in '') and %%. * *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0, *   and TRUE values to decimal 1. * * @return *   A database query result resource, or FALSE if the query was not *   executed correctly. */function db_query($query) {  $args = func_get_args();  array_shift($args);  $query = db_prefix_tables($query);  if (isset($args[0]) and is_array($args[0])) { // 'All arguments in one array' syntax    $args = $args[0];  }  _db_query_callback($args, TRUE);  $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);  return _db_query($query);}/** * Helper function for db_query(). */function _db_query($query, $debug = 0) {  global $active_db, $last_result, $queries;  if (variable_get('dev_query', 0)) {    list($usec, $sec) = explode(' ', microtime());    $timer = (float)$usec + (float)$sec;  }  $last_result = pg_query($active_db, $query);  if (variable_get('dev_query', 0)) {    $bt = debug_backtrace();    $query = $bt[2]['function'] ."\n". $query;    list($usec, $sec) = explode(' ', microtime());    $stop = (float)$usec + (float)$sec;    $diff = $stop - $timer;    $queries[] = array($query, $diff);  }  if ($debug) {    print '<p>query: '. $query .'<br />error:'. pg_last_error($active_db) .'</p>';  }  if ($last_result !== FALSE) {    return $last_result;  }  else {    // Indicate to drupal_error_handler that this is a database error.    ${DB_ERROR} = TRUE;    trigger_error(check_plain(pg_last_error($active_db) ."\nquery: ". $query), E_USER_WARNING);    return FALSE;  }}/** * Fetch one result row from the previous query as an object. * * @param $result *   A database query result resource, as returned from db_query(). * @return *   An object representing the next row of the result, or FALSE. The attributes *   of this object are the table fields selected by the query. */function db_fetch_object($result) {  if ($result) {    return pg_fetch_object($result);  }}/** * Fetch one result row from the previous query as an array. * * @param $result *   A database query result resource, as returned from db_query(). * @return *   An associative array representing the next row of the result, or FALSE. *   The keys of this object are the names of the table fields selected by the *   query, and the values are the field values for this result row. */function db_fetch_array($result) {  if ($result) {    return pg_fetch_assoc($result);  }}/** * Return an individual result field from the previous query. * * Only use this function if exactly one field is being selected; otherwise, * use db_fetch_object() or db_fetch_array(). * * @param $result *   A database query result resource, as returned from db_query(). * @return *   The resulting field or FALSE. */function db_result($result) {  if ($result && pg_num_rows($result) > 0) {    $array = pg_fetch_row($result);    return $array[0];  }  return FALSE;}/** * Determine whether the previous query caused an error. */function db_error() {  global $active_db;  return pg_last_error($active_db);}/** * Returns the last insert id. This function is thread safe. * * @param $table *   The name of the table you inserted into. * @param $field *   The name of the autoincrement field. */function db_last_insert_id($table, $field) {  return db_result(db_query("SELECT CURRVAL('{". db_escape_table($table) ."}_". db_escape_table($field) ."_seq')"));}/** * Determine the number of rows changed by the preceding query. */function db_affected_rows() {  global $last_result;  return empty($last_result) ? 0 : pg_affected_rows($last_result);}/** * Runs a limited-range query in the active database. * * Use this as a substitute for db_query() when a subset of the query * is to be returned. * User-supplied arguments to the query should be passed in as separate * parameters so that they can be properly escaped to avoid SQL injection * attacks. * * @param $query *   A string containing an SQL query. * @param ... *   A variable number of arguments which are substituted into the query *   using printf() syntax. Instead of a variable number of query arguments, *   you may also pass a single array containing the query arguments. *   Valid %-modifiers are: %s, %d, %f, %b (binary data, do not enclose *   in '') and %%. * *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0, *   and TRUE values to decimal 1. * * @param $from *   The first result row to return. * @param $count *   The maximum number of result rows to return. * @return *   A database query result resource, or FALSE if the query was not executed *   correctly. */function db_query_range($query) {  $args = func_get_args();  $count = array_pop($args);  $from = array_pop($args);  array_shift($args);  $query = db_prefix_tables($query);  if (isset($args[0]) and is_array($args[0])) { // 'All arguments in one array' syntax    $args = $args[0];  }  _db_query_callback($args, TRUE);  $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);  $query .= ' LIMIT '. (int)$count .' OFFSET '. (int)$from;  return _db_query($query);}/** * Runs a SELECT query and stores its results in a temporary table. * * Use this as a substitute for db_query() when the results need to stored * in a temporary table. Temporary tables exist for the duration of the page * request. * User-supplied arguments to the query should be passed in as separate parameters * so that they can be properly escaped to avoid SQL injection attacks. * * Note that if you need to know how many results were returned, you should do * a SELECT COUNT(*) on the temporary table afterwards. db_affected_rows() does * not give consistent result across different database types in this case. * * @param $query *   A string containing a normal SELECT SQL query. * @param ... *   A variable number of arguments which are substituted into the query *   using printf() syntax. The query arguments can be enclosed in one *   array instead. *   Valid %-modifiers are: %s, %d, %f, %b (binary data, do not enclose *   in '') and %%. * *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0, *   and TRUE values to decimal 1. * * @param $table *   The name of the temporary table to select into. This name will not be *   prefixed as there is no risk of collision. * @return *   A database query result resource, or FALSE if the query was not executed *   correctly. */function db_query_temporary($query) {  $args = func_get_args();  $tablename = array_pop($args);  array_shift($args);  $query = preg_replace('/^SELECT/i', 'CREATE TEMPORARY TABLE '. $tablename .' AS SELECT', db_prefix_tables($query));  if (isset($args[0]) and is_array($args[0])) { // 'All arguments in one array' syntax    $args = $args[0];  }  _db_query_callback($args, TRUE);  $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);  return _db_query($query);}/** * Returns a properly formatted Binary Large OBject value. * In case of PostgreSQL encodes data for insert into bytea field. * * @param $data *   Data to encode. * @return *  Encoded data. */function db_encode_blob($data) {  return "'". pg_escape_bytea($data) ."'";}/** * Returns text from a Binary Large OBject value. * In case of PostgreSQL decodes data after select from bytea field. * * @param $data *   Data to decode. * @return *  Decoded data. */function db_decode_blob($data) {  return pg_unescape_bytea($data);}/** * Prepare user input for use in a database query, preventing SQL injection attacks. * Note: This function requires PostgreSQL 7.2 or later. */function db_escape_string($text) {  return pg_escape_string($text);}/** * Lock a table. * This function automatically starts a transaction. */function db_lock_table($table) {  db_query('BEGIN; LOCK TABLE {'. db_escape_table($table) .'} IN EXCLUSIVE MODE');}/** * Unlock all locked tables. * This function automatically commits a transaction. */function db_unlock_tables() {  db_query('COMMIT');}/** * Check if a table exists. */function db_table_exists($table) {  return (bool) db_result(db_query("SELECT COUNT(*) FROM pg_class WHERE relname = '{". db_escape_table($table) ."}'"));}/** * Check if a column exists in the given table. */function db_column_exists($table, $column) {  return (bool) db_result(db_query("SELECT COUNT(pg_attribute.attname) FROM pg_class, pg_attribute WHERE pg_attribute.attrelid = pg_class.oid AND pg_class.relname = '{". db_escape_table($table) ."}' AND attname = '". db_escape_table($column) ."'"));}/** * Verify if the database is set up correctly. */function db_check_setup() {  $t = get_t();  $encoding = db_result(db_query('SHOW server_encoding'));  if (!in_array(strtolower($encoding), array('unicode', 'utf8'))) {    drupal_set_message($t('Your PostgreSQL database is set up with the wrong character encoding (%encoding). It is possible it will not work as expected. It is advised to recreate it with UTF-8/Unicode encoding. More information can be found in the <a href="@url">PostgreSQL documentation</a>.', array('%encoding' => $encoding, '@url' => 'http://www.postgresql.org/docs/7.4/interactive/multibyte.html')), 'status');  }}/** * @} End of "ingroup database". *//** * @ingroup schemaapi * @{ *//** * This maps a generic data type in combination with its data size * to the engine-specific data type. */function db_type_map() {  // Put :normal last so it gets preserved by array_flip.  This makes  // it much easier for modules (such as schema.module) to map  // database types back into schema types.  $map = array(    'varchar:normal' => 'varchar',    'char:normal' => 'character',    'text:tiny' => 'text',    'text:small' => 'text',    'text:medium' => 'text',    'text:big' => 'text',    'text:normal' => 'text',    'int:tiny' => 'smallint',    'int:small' => 'smallint',    'int:medium' => 'int',    'int:big' => 'bigint',    'int:normal' => 'int',    'float:tiny' => 'real',    'float:small' => 'real',    'float:medium' => 'real',    'float:big' => 'double precision',    'float:normal' => 'real',    'numeric:normal' => 'numeric',    'blob:big' => 'bytea',    'blob:normal' => 'bytea',    'datetime:normal' => 'timestamp without time zone',    'serial:tiny' => 'serial',    'serial:small' => 'serial',    'serial:medium' => 'serial',    'serial:big' => 'bigserial',    'serial:normal' => 'serial',  );  return $map;}/** * Generate SQL to create a new table from a Drupal schema definition. * * @param $name *   The name of the table to create. * @param $table *   A Schema API table definition array. * @return *   An array of SQL statements to create the table. */function db_create_table_sql($name, $table) {  $sql_fields = array();  foreach ($table['fields'] as $field_name => $field) {    $sql_fields[] = _db_create_field_sql($field_name, _db_process_field($field));  }  $sql_keys = array();  if (isset($table['primary key']) && is_array($table['primary key'])) {    $sql_keys[] = 'PRIMARY KEY ('. implode(', ', $table['primary key']) .')';  }  if (isset($table['unique keys']) && is_array($table['unique keys'])) {    foreach ($table['unique keys'] as $key_name => $key) {      $sql_keys[] = 'CONSTRAINT {'. $name .'}_'. $key_name .'_key UNIQUE ('. implode(', ', $key) .')';    }  }  $sql = "CREATE TABLE {". $name ."} (\n\t";  $sql .= implode(",\n\t", $sql_fields);  if (count($sql_keys) > 0) {    $sql .= ",\n\t";  }  $sql .= implode(",\n\t", $sql_keys);  $sql .= "\n)";  $statements[] = $sql;  if (isset($table['indexes']) && is_array($table['indexes'])) {    foreach ($table['indexes'] as $key_name => $key) {      $statements[] = _db_create_index_sql($name, $key_name, $key);    }  }  return $statements;}function _db_create_index_sql($table, $name, $fields) {  $query = 'CREATE INDEX {'. $table .'}_'. $name .'_idx ON {'. $table .'} (';  $query .= _db_create_key_sql($fields) .')';  return $query;}function _db_create_key_sql($fields) {  $ret = array();  foreach ($fields as $field) {    if (is_array($field)) {      $ret[] = 'substr('. $field[0] .', 1, '. $field[1] .')';    }    else {      $ret[] = $field;    }  }  return implode(', ', $ret);}function _db_create_keys(&$ret, $table, $new_keys) {  if (isset($new_keys['primary key'])) {    db_add_primary_key($ret, $table, $new_keys['primary key']);  }  if (isset($new_keys['unique keys'])) {    foreach ($new_keys['unique keys'] as $name => $fields) {      db_add_unique_key($ret, $table, $name, $fields);    }  }  if (isset($new_keys['indexes'])) {    foreach ($new_keys['indexes'] as $name => $fields) {      db_add_index($ret, $table, $name, $fields);    }  }}/** * Set database-engine specific properties for a field. * * @param $field *   A field description array, as specified in the schema documentation. */function _db_process_field($field) {  if (!isset($field['size'])) {    $field['size'] = 'normal';  }  // Set the correct database-engine specific datatype.  if (!isset($field['pgsql_type'])) {    $map = db_type_map();    $field['pgsql_type'] = $map[$field['type'] .':'. $field['size']];  }  if ($field['type'] == 'serial') {    unset($field['not null']);  }  return $field;}/** * Create an SQL string for a field to be used in table creation or alteration. * * Before passing a field out of a schema definition into this function it has * to be processed by _db_process_field(). * * @param $name *    Name of the field. * @param $spec *    The field specification, as per the schema data structure format. */function _db_create_field_sql($name, $spec) {  $sql = $name .' '. $spec['pgsql_type'];  if ($spec['type'] == 'serial') {    unset($spec['not null']);  }  if (!empty($spec['unsigned'])) {    if ($spec['type'] == 'serial') {      $sql .= " CHECK ($name >= 0)";    }    else {      $sql .= '_unsigned';    }  }  if (in_array($spec['type'], array('varchar', 'char', 'text')) && isset($spec['length'])) {    $sql .= '('. $spec['length'] .')';  }  elseif (isset($spec['precision']) && isset($spec['scale'])) {    $sql .= '('. $spec['precision'] .', '. $spec['scale'] .')';  }  if (isset($spec['not null']) && $spec['not null']) {    $sql .= ' NOT NULL';  }  if (isset($spec['default'])) {    $default = is_string($spec['default']) ? "'". $spec['default'] ."'" : $spec['default'];    $sql .= " default $default";  }  return $sql;}/** * Rename a table. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be renamed. * @param $new_name *   The new name for the table. */function db_rename_table(&$ret, $table, $new_name) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} RENAME TO {'. $new_name .'}');}/** * Drop a table. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be dropped. */function db_drop_table(&$ret, $table) {  $ret[] = update_sql('DROP TABLE {'. $table .'}');}/** * Add a new field to a table. * * @param $ret *   Array to which query results will be added. * @param $table *   Name of the table to be altered. * @param $field *   Name of the field to be added. * @param $spec *   The field specification array, as taken from a schema definition. *   The specification may also contain the key 'initial', the newly *   created field will be set to the value of the key in all rows. *   This is most useful for creating NOT NULL columns with no default *   value in existing tables. * @param $keys_new *   Optional keys and indexes specification to be created on the *   table along with adding the field. The format is the same as a *   table specification but without the 'fields' element.  If you are *   adding a type 'serial' field, you MUST specify at least one key *   or index including it in this array. @see db_change_field for more *   explanation why. */function db_add_field(&$ret, $table, $field, $spec, $new_keys = array()) {  $fixnull = FALSE;  if (!empty($spec['not null']) && !isset($spec['default'])) {    $fixnull = TRUE;    $spec['not null'] = FALSE;  }  $query = 'ALTER TABLE {'. $table .'} ADD COLUMN ';  $query .= _db_create_field_sql($field, _db_process_field($spec));  $ret[] = update_sql($query);  if (isset($spec['initial'])) {    // All this because update_sql does not support %-placeholders.    $sql = 'UPDATE {'. $table .'} SET '. $field .' = '. db_type_placeholder($spec['type']);    $result = db_query($sql, $spec['initial']);    $ret[] = array('success' => $result !== FALSE, 'query' => check_plain($sql .' ('. $spec['initial'] .')'));  }  if ($fixnull) {    $ret[] = update_sql("ALTER TABLE {". $table ."} ALTER $field SET NOT NULL");  }  if (isset($new_keys)) {    _db_create_keys($ret, $table, $new_keys);  }}/** * Drop a field. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $field *   The field to be dropped. */function db_drop_field(&$ret, $table, $field) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP COLUMN '. $field);}/** * Set the default value for a field. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $field *   The field to be altered. * @param $default *   Default value to be set. NULL for 'default NULL'. */function db_field_set_default(&$ret, $table, $field, $default) {  if ($default == NULL) {    $default = 'NULL';  }  else {    $default = is_string($default) ? "'$default'" : $default;  }  $ret[] = update_sql('ALTER TABLE {'. $table .'} ALTER COLUMN '. $field .' SET DEFAULT '. $default);}/** * Set a field to have no default value. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $field *   The field to be altered. */function db_field_set_no_default(&$ret, $table, $field) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} ALTER COLUMN '. $field .' DROP DEFAULT');}/** * Add a primary key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $fields *   Fields for the primary key. */function db_add_primary_key(&$ret, $table, $fields) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} ADD PRIMARY KEY ('.    implode(',', $fields) .')');}/** * Drop the primary key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. */function db_drop_primary_key(&$ret, $table) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP CONSTRAINT {'. $table .'}_pkey');}/** * Add a unique key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the key. * @param $fields *   An array of field names. */function db_add_unique_key(&$ret, $table, $name, $fields) {  $name = '{'. $table .'}_'. $name .'_key';  $ret[] = update_sql('ALTER TABLE {'. $table .'} ADD CONSTRAINT '.    $name .' UNIQUE ('. implode(',', $fields) .')');}/** * Drop a unique key. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the key. */function db_drop_unique_key(&$ret, $table, $name) {  $name = '{'. $table .'}_'. $name .'_key';  $ret[] = update_sql('ALTER TABLE {'. $table .'} DROP CONSTRAINT '. $name);}/** * Add an index. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the index. * @param $fields *   An array of field names. */function db_add_index(&$ret, $table, $name, $fields) {  $ret[] = update_sql(_db_create_index_sql($table, $name, $fields));}/** * Drop an index. * * @param $ret *   Array to which query results will be added. * @param $table *   The table to be altered. * @param $name *   The name of the index. */function db_drop_index(&$ret, $table, $name) {  $name = '{'. $table .'}_'. $name .'_idx';  $ret[] = update_sql('DROP INDEX '. $name);}/** * Change a field definition. * * IMPORTANT NOTE: To maintain database portability, you have to explicitly * recreate all indices and primary keys that are using the changed field. * * That means that you have to drop all affected keys and indexes with * db_drop_{primary_key,unique_key,index}() before calling db_change_field(). * To recreate the keys and indices, pass the key definitions as the * optional $new_keys argument directly to db_change_field(). * * For example, suppose you have: * @code * $schema['foo'] = array( *   'fields' => array( *     'bar' => array('type' => 'int', 'not null' => TRUE) *   ), *   'primary key' => array('bar') * ); * @endcode * and you want to change foo.bar to be type serial, leaving it as the * primary key.  The correct sequence is: * @code * db_drop_primary_key($ret, 'foo'); * db_change_field($ret, 'foo', 'bar', 'bar', *   array('type' => 'serial', 'not null' => TRUE), *   array('primary key' => array('bar'))); * @endcode * * The reasons for this are due to the different database engines: * * On PostgreSQL, changing a field definition involves adding a new field * and dropping an old one which* causes any indices, primary keys and * sequences (from serial-type fields) that use the changed field to be dropped. * * On MySQL, all type 'serial' fields must be part of at least one key * or index as soon as they are created.  You cannot use * db_add_{primary_key,unique_key,index}() for this purpose because * the ALTER TABLE command will fail to add the column without a key * or index specification.  The solution is to use the optional * $new_keys argument to create the key or index at the same time as * field. * * You could use db_add_{primary_key,unique_key,index}() in all cases * unless you are converting a field to be type serial. You can use * the $new_keys argument in all cases. * * @param $ret *   Array to which query results will be added. * @param $table *   Name of the table. * @param $field *   Name of the field to change. * @param $field_new *   New name for the field (set to the same as $field if you don't want to change the name). * @param $spec *   The field specification for the new field. * @param $new_keys *   Optional keys and indexes specification to be created on the *   table along with changing the field. The format is the same as a *   table specification but without the 'fields' element. */function db_change_field(&$ret, $table, $field, $field_new, $spec, $new_keys = array()) {  $ret[] = update_sql('ALTER TABLE {'. $table .'} RENAME "'. $field .'" TO "'. $field .'_old"');  $not_null = isset($spec['not null']) ? $spec['not null'] : FALSE;  unset($spec['not null']);  if (!array_key_exists('size', $spec)) {    $spec['size'] = 'normal';  }  db_add_field($ret, $table, "$field_new", $spec);  // We need to type cast the new column to best transfer the data  // db_type_map will return possiblities that are not 'cast-able'  // such as serial - they must be made 'int' instead.  $map =  db_type_map();  $typecast = $map[$spec['type'] .':'. $spec['size']];  if (in_array($typecast, array('serial', 'bigserial', 'numeric'))) {    $typecast = 'int';  }  $ret[] = update_sql('UPDATE {'. $table .'} SET '. $field_new .' = CAST('. $field .'_old AS '. $typecast .')');  if ($not_null) {    $ret[] = update_sql("ALTER TABLE {". $table ."} ALTER $field_new SET NOT NULL");  }  db_drop_field($ret, $table, $field .'_old');  if (isset($new_keys)) {    _db_create_keys($ret, $table, $new_keys);  }}/** * @} End of "ingroup schemaapi". */
<?php// $Id$/** * @file search-results.tpl.php * Default theme implementation for displaying search results. * * This template collects each invocation of theme_search_result(). This and * the child template are dependant to one another sharing the markup for * definition lists. * * Note that modules may implement their own search type and theme function * completely bypassing this template. * * Available variables: * - $search_results: All results as it is rendered through *   search-result.tpl.php * - $type: The type of search, e.g., "node" or "user". * * * @see template_preprocess_search_results() */?><dl class="search-results <?php print $type; ?>-results">  <?php print $search_results; ?></dl><?php print $pager; ?>
<?php// $Id$/** * @file search-theme-form.tpl.php * Default theme implementation for displaying a search form directly into the * theme layout. Not to be confused with the search block or the search page. * * Available variables: * - $search_form: The complete search form ready for print. * - $search: Array of keyed search elements. Can be used to print each form *   element separately. * * Default keys within $search: * - $search['search_theme_form']: Text input area wrapped in a div. * - $search['submit']: Form submit button. * - $search['hidden']: Hidden form elements. Used to validate forms when submitted. * * Since $search is keyed, a direct print of the form element is possible. * Modules can add to the search form so it is recommended to check for their * existance before printing. The default keys will always exist. * *   <?php if (isset($search['extra_field'])): ?> *     <div class="extra-field"> *       <?php print $search['extra_field']; ?> *     </div> *   <?php endif; ?> * * To check for all available data within $search, use the code below. * *   <?php print '<pre>'. check_plain(print_r($search, 1)) .'</pre>'; ?> * * @see template_preprocess_search_theme_form() */?><div id="search" class="container-inline">  <?php print $search_form; ?></div>
