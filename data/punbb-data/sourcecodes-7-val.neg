<?php/*** @version $Id: ord.php,v 1.4 2006/09/11 15:22:54 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to ord* Returns the unicode ordinal for a character* @param string UTF-8 encoded character* @return int unicode ordinal for the character* @see http://www.php.net/ord* @see http://www.php.net/manual/en/function.ord.php#46267*/function utf8_ord($chr) {    $ord0 = ord($chr);    if ( $ord0 >= 0 && $ord0 <= 127 ) {        return $ord0;    }    if ( !isset($chr{1}) ) {        trigger_error('Short sequence - at least 2 bytes expected, only 1 seen');        return FALSE;    }    $ord1 = ord($chr{1});    if ( $ord0 >= 192 && $ord0 <= 223 ) {        return ( $ord0 - 192 ) * 64             + ( $ord1 - 128 );    }    if ( !isset($chr{2}) ) {        trigger_error('Short sequence - at least 3 bytes expected, only 2 seen');        return FALSE;    }    $ord2 = ord($chr{2});    if ( $ord0 >= 224 && $ord0 <= 239 ) {        return ($ord0-224)*4096             + ($ord1-128)*64                 + ($ord2-128);    }    if ( !isset($chr{3}) ) {        trigger_error('Short sequence - at least 4 bytes expected, only 3 seen');        return FALSE;    }    $ord3 = ord($chr{3});    if ($ord0>=240 && $ord0<=247) {        return ($ord0-240)*262144             + ($ord1-128)*4096                 + ($ord2-128)*64                     + ($ord3-128);    }    if ( !isset($chr{4}) ) {        trigger_error('Short sequence - at least 5 bytes expected, only 4 seen');        return FALSE;    }    $ord4 = ord($chr{4});    if ($ord0>=248 && $ord0<=251) {        return ($ord0-248)*16777216             + ($ord1-128)*262144                 + ($ord2-128)*4096                     + ($ord3-128)*64                         + ($ord4-128);    }    if ( !isset($chr{5}) ) {        trigger_error('Short sequence - at least 6 bytes expected, only 5 seen');        return FALSE;    }    if ($ord0>=252 && $ord0<=253) {        return ($ord0-252) * 1073741824             + ($ord1-128)*16777216                 + ($ord2-128)*262144                     + ($ord3-128)*4096                         + ($ord4-128)*64                             + (ord($c{5})-128);    }    if ( $ord0 >= 254 && $ord0 <= 255 ) {         trigger_error('Invalid UTF-8 with surrogate ordinal '.$ord0);        return FALSE;    }}
<?php// Language definitions used in all admin files$lang_admin_groups = array(// admin_groups'Group settings heading'		=>	'Group\'s default permission that apply when no forum specific permissions are set','Group title label'				=>	'Group title','User title label'				=>	'User title','Group title head'				=>	'Group and user title','Group title legend'			=>	'Set titles','Group perms head'				=>	'Group permissions','Group flood head'				=>	'Group flood protection settings','User title help'				=>	'This title will override any rank users in this group have attained. Leave blank to use default title or rank.','Remove group legend'			=>	'Remove group','Permissions'					=>	'Permissions','Moderation'					=>	'Moderation','Allow moderate label'			=>	'Allow users moderator privileges.','Allow mod edit profiles label'	=>	'Allow moderators to edit user profiles.','Allow mod edit username label'	=>	'Allow moderators to rename users.','Allow mod change pass label'	=>	'Allow moderators to change user passwords.','Allow mod bans label'			=>	'Allow moderators to ban users.','Allow read board label'		=>	'Allow users to view the board.','Allow read board help'			=>	'This setting applies to every aspect of the board and can, if disabled, not be overridden by forum specific read permissions. If this is disabled, users in this group will only be able to login/logout and register.','Allow view users label'		=>	'Allow users to view the user list and user profiles.','Allow post replies label'		=>	'Allow users to post replies in topics.','Allow post topics label'		=>	'Allow users to post new topics.','Allow edit posts label'		=>	'Allow users to edit their own posts.','Allow delete posts label'		=>	'Allow users to delete their own posts.','Allow delete topics label'		=>	'Allow users to delete their own topics (including any replies).','Allow set user title label'	=>	'Allow users to set their own user titles.','Allow use search label'		=>	'Allow users to use the search feature.','Allow search users label'		=>	'Allow users to freetext search for users in the user list.','Allow send email label'		=>	'Allow users to send emails to other users.','Restrictions'					=>	'Restrictions','Mod permissions'				=>	'Moderator permissions','User permissions'				=>	'User permissions','Flood interval label'			=>	'Post flood interval','Flood interval help'			=>	'Number of seconds that users in this group have to wait between posts. Set to 0 to disable.','Search interval label'			=>	'Search flood interval','Search interval help'			=>	'Number of seconds that users in this group have to wait between searches. Set to 0 to disable.','Email flood interval label'	=>	'Email flood interval','Email flood interval help'		=>	'Number of seconds that users in this group have to wait between emails. Set to 0 to disable.','Allow moderate help'			=>	'In order for a user in this group to have moderator abilities, he/she must be assigned to moderate one or more forums. This is done via the user administration page of the user\'s profile.','Remove group'					=>	'Remove this group','Edit group'					=>	'Edit this group','default'						=>	'(default)','Cannot remove group'			=>	'This group cannot be removed.','Cannot remove default'			=>	'To remove this group you must assign a new default group.','Remove group head'				=>	'Remove "%s" group which contains %s members','Remove group help'				=>	'(Transfer current members to this group)','Move users to'					=>	'Move users to','Cannot remove default group'	=>	'The default group cannot be removed. In order to delete this group, you must first setup a different group as the default.','Add group heading'				=>	'Add new group (will inherit the permissions of the group it is based on)','Add group legend'				=>	'Add new group','Edit group heading'			=>	'Edit existing group','Base new group label'			=>	'Base new group on','Add group'						=>	'Add new group','Default group heading'			=>	'Default group for new users (administrator/moderator groups not available for security reasons)','Default group legend'			=>	'Set default group for new users','Default group label'			=>	'Default group','Set default'					=>	'Set default group','Existing groups heading'		=>	'Existing groups','Existing groups intro'			=>	'The pre-defined groups Guests and Administrators cannot be removed. They can however be edited. Please note though, that in some groups, certain options are unavailable (e.g. the "edit posts" permission for guests). Administrators always have full permissions.','Group removed'					=>	'Group removed.','Default group set'				=>	'Default group set.','Group added'					=>	'Group added.','Group edited'					=>	'Group edited.','Update group'					=>	'Update group','Must enter group message'		=>	'You must enter a group title.','Already a group message'		=>	'There is already a group with the title <strong>"%s"</strong>.','Moderator default group'		=>	'This is the default group for new users and therefore cannot be assigned moderator privileges.',);
<?php/*** @version $Id: strcasecmp.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to strcasecmp* A case insensivite string comparison* Note: requires utf8_strtolower* @param string* @param string* @return int* @see http://www.php.net/strcasecmp* @see utf8_strtolower* @package utf8* @subpackage strings*/function utf8_strcasecmp($strX, $strY) {    $strX = utf8_strtolower($strX);    $strY = utf8_strtolower($strY);    return strcmp($strX, $strY);}
<?php/*** This is the dynamic loader for the library. It checks whether you have* the mbstring extension available and includes relevant files* on that basis, falling back to the native (as in written in PHP) version* if mbstring is unavailabe.** It's probably easiest to use this, if you don't want to understand* the dependencies involved, in conjunction with PHP versions etc. At* the same time, you might get better performance by managing loading* yourself. The smartest way to do this, bearing in mind performance,* is probably to "load on demand" - i.e. just before you use these* functions in your code, load the version you need.** It makes sure the the following functions are available;* utf8_strlen, utf8_strpos, utf8_strrpos, utf8_substr,* utf8_strtolower, utf8_strtoupper* Other functions in the ./native directory depend on these* six functions being available* * @license http://www.gnu.org/copyleft/lesser.html LGPL* @see http://sourceforge.net/projects/phputf8* @package utf8*//*** Put the current directory in this constant*/if ( !defined('UTF8') ) {    define('UTF8',dirname(__FILE__));}/*** If string overloading is active, it will break many of the* native implementations. mbstring.func_overload must be set* to 0, 1 or 4 in php.ini (string overloading disabled).* Also need to check we have the correct internal mbstring* encoding*/if ( extension_loaded('mbstring')) {    if ( ini_get('mbstring.func_overload') & MB_OVERLOAD_STRING ) {        trigger_error('String functions are overloaded by mbstring',E_USER_ERROR);    }    mb_internal_encoding('UTF-8');}/*** Check whether PCRE has been compiled with UTF-8 support*/$UTF8_ar = array();if ( preg_match('/^.{1}$/u',"",$UTF8_ar) != 1 ) {    trigger_error('PCRE is not compiled with UTF-8 support',E_USER_ERROR);}unset($UTF8_ar);/*** Load the smartest implementations of utf8_strpos, utf8_strrpos* and utf8_substr*/if ( !defined('UTF8_CORE') ) {    if ( function_exists('mb_substr') ) {        require_once UTF8 . '/mbstring/core.php';    } else {        require_once UTF8 . '/utils/unicode.php';        require_once UTF8 . '/native/core.php';    }}/*** Load the native implementation of utf8_substr_replace*/require_once UTF8 . '/substr_replace.php';/*** You should now be able to use all the other utf_* string functions*/
<?php// Language definitions used in admin-categories$lang_admin_forums = array('Edit forum head'				=>	'Edit forum: %s','Edit or delete'				=>	'%s or %s','Edit'							=>	'Edit','Delete'						=>	'Delete','Forum name'					=>	'Forum name','Position label'				=>	'Position','Delete forum'					=>	'Delete forum','Delete forum warning'			=>	'<strong>WARNING!</strong> Deleting a forum will delete all posts (if any) in that forum!','Edit forum'					=>	'Edit forum','Edit forum details legend'		=>	'Forum details','Category assignment'			=>	'Assign to category','Forums in category'			=>	'Forums in category: %s','Edit forum perms legend'		=>	'Forum group permissions (non default permissions are suffixed "(S)"','Forum name label'				=>	'Forum name','Position label'				=>	'Position','Add to category label'			=>	'Add to category','Forum description'				=>	'Description','Forum description help'		=>	'(You may use HTML in your description)','Sort topics by'				=>	'Sort topics by','Sort last post'				=>	'Last post','Sort topic start'				=>	'Topic start','Redirect URL'					=>	'Redirect URL','Only for empty forums'			=>	'Only available in empty forums','Edit forums head'				=>	'Edit, delete or change the position of forums','Edit forum details head'		=>	'Edit forum details','Edit forum perms head'			=>	'Edit forum permissions','Post replies'					=>	'Post replies','Post topics'					=>	'Post topics','User groups'					=>	'User groups','Confirm delete forum'			=>	'You are deleting the forum "%s"','Forum perms read info'			=>	'The "Read forum" permission checkbox will be disabled if the group in question lacks the "Read board" permission.','Forum perms redirect info'		=>	'This is a redirect forum. Only the "Read forum" permission is editable.','Forum perms restore info'		=>	'Permissions can be restored to default settings using the "Default permissions" button below.','Forum perms groups info'		=>	'Permissions are the defaults as set in %s unless suffixed "(S)"','Forum perms admins info'		=>	'Forum Administrators always have full permissions which cannot be restricted.','Not default'					=>	'(S)','Read forum'					=>	'Read&#160;forum','Restore defaults'				=>	'Default permissions','Add forum'						=>	'Add forum','Add forum head'				=>	'Add a new forum to the selected category at the specified position','Add forum legend'				=>	'Add forum','Add to category'				=>	'Add to category','Update positions'				=>	'Update positions','Forum added'					=>	'Forum added.','Forum deleted'					=>	'Forum deleted.','Forums updated'				=>	'Forums updated.','Forum updated'					=>	'Forum updated.','Permissions reverted'			=>	'Permissions reverted to defaults.','Must enter forum message'		=>	'You must enter a forum name.',);
<?php/** * SEF URLs that use a file-like layout. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure no one attempts to run this script "directly"if (!defined('FORUM'))	exit;// These are the simple file based SEF URLs$forum_url = array(	'insertion_find'				=>  '.html',	'insertion_replace'				=>  '-$1.html',	'change_email'					=>	'change-email$1.html',	'change_email_key'				=>	'change-email$1-$2.html',	'change_password'				=>	'change-password$1.html',	'change_password_key'			=>	'change-password$1-$2.html',	'delete_user'					=>	'delete-user$1.html',	'delete'						=>	'delete$1.html',	'delete_avatar'					=>	'delete-avatar$1-$2.html',	'edit'							=>	'edit$1.html',	'email'							=>	'email$1.html',	'forum'							=>	'forum$1.html',	'forum_rss'						=>	'feed-rss-forum$1.xml',	'forum_atom'					=>	'feed-atom-forum$1.xml',	'help'							=>	'help-$1.html',	'index'							=>	'',	'index_rss'						=>	'feed-rss.xml',	'index_atom'					=>	'feed-atom.xml',	'login'							=>	'login.html',	'logout'						=>	'logout$1-$2.html',	'mark_read'						=>	'mark-read-$1.html',	'mark_forum_read'				=>	'mark-forum$1-read-$2.html',	'new_topic'						=>	'new-topic$1.html',	'new_reply'						=>	'new-reply$1.html',	'post'							=>	'post$1.html#p$1',	'profile_about'					=>	'user$1-about.html',	'profile_identity'				=>	'user$1-identity.html',	'profile_settings'				=>	'user$1-settings.html',	'profile_avatar'				=>	'user$1-avatar.html',	'profile_signature'				=>	'user$1-signature.html',	'profile_admin'					=>	'user$1-admin.html',	'quote'							=>	'new-reply$1quote$2.html',	'register'						=>	'register.html',	'report'						=>	'report$1.html',	'request_password'				=>	'request-password.html',	'rules'							=>	'rules.html',	'search'						=>	'search.html',	'search_advanced'				=>	'search-advanced.html',	'search_resultft'				=>	'search-k$1-$4-a$3-$5-$6-$2-$7.html',	'search_results'				=>	'search$1.html',	'search_new'					=>	'search-new.html',	'search_new_results'			=>	'search-new-$1.html',	'search_recent'					=>	'search-recent.html',	'search_recent_results'			=>	'search-recent-$1.html',	'search_unanswered'				=>	'search-unanswered.html',	'search_subscriptions'			=>	'search-subscriptions$1.html',	'search_user_posts'				=>	'search-posts-user$1.html',	'search_user_topics'			=>	'search-topics-user$1.html',	'subscribe'						=>	'subscribe$1-$2.html',	'topic'							=>	'topic$1.html',	'topic_rss'						=>	'feed-rss-topic$1.xml',	'topic_atom'					=>	'feed-atom-topic$1.xml',	'topic_new_posts'				=>	'topic$1new-posts.html',	'topic_last_post'				=>	'topic$1last-post.html',	'unsubscribe'					=>	'unsubscribe$1-$2.html',	'user'							=>	'user$1.html',	'users'							=>	'users.html',	'users_browse'					=>	'users/$4/$1$2-$3.html',	'page'							=>	'p$1',	'moderate_forum'				=>	'moderate$1.html',	'get_host'						=>	'get_host$1.html',	'move'							=>	'move_topics$1-$2.html',	'open'							=>	'open$1-$2-$3.html',	'close'							=>	'close$1-$2-$3.html',	'stick'							=>	'stick$1-$2-$3.html',	'unstick'						=>	'unstick$1-$2-$3.html',	'moderate_topic'				=>	'moderate$1-$2.html',	'admin_index'					=>	'admin/index.php',	'admin_bans'					=>	'admin/bans.php?sort_by=1',	'admin_categories'				=>	'admin/categories.php',	'admin_censoring'				=>	'admin/censoring.php',	'admin_extensions_manage'		=>	'admin/extensions.php?section=manage',	'admin_extensions_hotfixes'		=>	'admin/extensions.php?section=hotfixes',	'admin_forums'					=>	'admin/forums.php',	'admin_groups'					=>	'admin/groups.php',	'admin_loader'					=>	'admin/loader.php',	'admin_reindex'					=>	'admin/reindex.php',	'admin_settings_setup'			=>	'admin/settings.php?section=setup',	'admin_settings_features'		=>	'admin/settings.php?section=features',	'admin_settings_content'		=>	'admin/settings.php?section=content',	'admin_settings_email'			=>	'admin/settings.php?section=email',	'admin_settings_announcements'	=>	'admin/settings.php?section=announcements',	'admin_settings_registration'	=>	'admin/settings.php?section=registration',	'admin_settings_communications'	=>	'admin/settings.php?section=communications',	'admin_settings_maintenance'	=>	'admin/settings.php?section=maintenance',	'admin_prune'					=>	'admin/prune.php',	'admin_ranks'					=>	'admin/ranks.php',	'admin_reports'					=>	'admin/reports.php',	'admin_users'					=>	'admin/users.php');
<?php$forum_loader->add_css('style/Oxygen/min/Oxygen.min.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen'));//$forum_loader->add_css('style/Oxygen/Oxygen.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen'));//$forum_loader->add_css('style/Oxygen/Oxygen_mobile.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen'));//$forum_loader->add_css('style/Oxygen/Oxygen_cs.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen'));// IE$forum_loader->add_css('style/Oxygen/min/Oxygen_ie6.min.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen', 'browsers' => array('IE' => 'lte IE 6', '!IE' => false)));$forum_loader->add_css('style/Oxygen/min/Oxygen_ie7.min.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen', 'browsers' => array('IE' => 'IE 7', '!IE' => false)));$forum_loader->add_css('style/Oxygen/min/Oxygen_ie8.min.css', array('type' => 'file', 'group' => FORUM_CSS_GROUP_SYSTEM, 'media' => 'screen', 'browsers' => array('IE' => 'IE 8', '!IE' => false)));?>
<?php/** * Regular URL scheme. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure no one attempts to run this script "directly"if (!defined('FORUM'))	exit;// These are the regular, "non-SEF" URLs (you probably don't want to edit these)$forum_url = array(	'change_email'					=>	'profile.php?action=change_email&amp;id=$1',	'change_email_key'				=>	'profile.php?action=change_email&amp;id=$1&amp;key=$2',	'change_password'				=>	'profile.php?action=change_pass&amp;id=$1',	'change_password_key'			=>	'profile.php?action=change_pass&amp;id=$1&amp;key=$2',	'delete_user'					=>	'profile.php?action=delete_user&amp;id=$1',	'delete'						=>	'delete.php?id=$1',	'delete_avatar'					=>	'profile.php?action=delete_avatar&amp;id=$1&amp;csrf_token=$2',	'edit'							=>	'edit.php?id=$1',	'email'							=>	'misc.php?email=$1',	'forum'							=>	'viewforum.php?id=$1',	'forum_rss'						=>	'extern.php?action=feed&amp;fid=$1&amp;type=rss',	'forum_atom'					=>	'extern.php?action=feed&amp;fid=$1&amp;type=atom',	'help'							=>	'help.php?section=$1',	'index'							=>	'index.php',	'index_rss'						=>	'extern.php?action=feed&amp;type=rss',	'index_atom'					=>	'extern.php?action=feed&amp;type=atom',	'login'							=>	'login.php',	'logout'						=>	'login.php?action=out&amp;id=$1&amp;csrf_token=$2',	'mark_read'						=>	'misc.php?action=markread&amp;csrf_token=$1',	'mark_forum_read'				=>	'misc.php?action=markforumread&amp;fid=$1&amp;csrf_token=$2',	'new_topic'						=>	'post.php?fid=$1',	'new_reply'						=>	'post.php?tid=$1',	'post'							=>	'viewtopic.php?pid=$1#p$1',	'profile_about'					=>	'profile.php?section=about&amp;id=$1',	'profile_identity'				=>	'profile.php?section=identity&amp;id=$1',	'profile_settings'				=>	'profile.php?section=settings&amp;id=$1',	'profile_avatar'				=>	'profile.php?section=avatar&amp;id=$1',	'profile_signature'				=>	'profile.php?section=signature&amp;id=$1',	'profile_admin'					=>	'profile.php?section=admin&amp;id=$1',	'quote'							=>	'post.php?tid=$1&amp;qid=$2',	'register'						=>	'register.php',	'report'						=>	'misc.php?report=$1',	'request_password'				=>	'login.php?action=forget',	'rules'							=>	'misc.php?action=rules',	'search'						=>	'search.php',	'search_advanced'				=>	'search.php?advanced=1',	'search_resultft'				=>	'search.php?action=search&amp;keywords=$1&amp;author=$3&amp;forum=$2&amp;search_in=$4&amp;sort_by=$5&amp;sort_dir=$6&amp;show_as=$7',	'search_results'				=>	'search.php?search_id=$1',	'search_new'					=>	'search.php?action=show_new',	'search_new_results'			=>	'search.php?action=show_new&amp;forum=$1',	'search_recent'					=>	'search.php?action=show_recent',	'search_recent_results'			=>	'search.php?action=show_recent&amp;value=$1',	'search_unanswered'				=>	'search.php?action=show_unanswered',	'search_subscriptions'			=>	'search.php?action=show_subscriptions&amp;user_id=$1',	'search_user_posts'				=>	'search.php?action=show_user_posts&amp;user_id=$1',	'search_user_topics'			=>	'search.php?action=show_user_topics&amp;user_id=$1',	'subscribe'						=>	'misc.php?subscribe=$1&amp;csrf_token=$2',	'topic'							=>	'viewtopic.php?id=$1',	'topic_rss'						=>	'extern.php?action=feed&amp;tid=$1&amp;type=rss',	'topic_atom'					=>	'extern.php?action=feed&amp;tid=$1&amp;type=atom',	'topic_new_posts'				=>	'viewtopic.php?id=$1&amp;action=new',	'topic_last_post'				=>	'viewtopic.php?id=$1&amp;action=last',	'unsubscribe'					=>	'misc.php?unsubscribe=$1&amp;csrf_token=$2',	'user'							=>	'profile.php?id=$1',	'users'							=>	'userlist.php',	'users_browse'					=>	'userlist.php?show_group=$1&amp;sort_by=$2&amp;sort_dir=$3&amp;username=$4',	'page'							=>	'&amp;p=$1',	'moderate_forum'				=>	'moderate.php?fid=$1',	'get_host'						=>	'moderate.php?get_host=$1',	'move'							=>	'moderate.php?fid=$1&amp;move_topics=$2',	'open'							=>	'moderate.php?fid=$1&amp;open=$2&amp;csrf_token=$3',	'close'							=>	'moderate.php?fid=$1&amp;close=$2&amp;csrf_token=$3',	'stick'							=>	'moderate.php?fid=$1&amp;stick=$2&amp;csrf_token=$3',	'unstick'						=>	'moderate.php?fid=$1&amp;unstick=$2&amp;csrf_token=$3',	'moderate_topic'				=>	'moderate.php?fid=$1&amp;tid=$2',	'admin_index'					=>	'admin/index.php',	'admin_bans'					=>	'admin/bans.php?sort_by=1',	'admin_categories'				=>	'admin/categories.php',	'admin_censoring'				=>	'admin/censoring.php',	'admin_extensions_manage'		=>	'admin/extensions.php?section=manage',	'admin_extensions_hotfixes'		=>	'admin/extensions.php?section=hotfixes',	'admin_forums'					=>	'admin/forums.php',	'admin_groups'					=>	'admin/groups.php',	'admin_loader'					=>	'admin/loader.php',	'admin_reindex'					=>	'admin/reindex.php',	'admin_settings_setup'			=>	'admin/settings.php?section=setup',	'admin_settings_features'		=>	'admin/settings.php?section=features',	'admin_settings_content'		=>	'admin/settings.php?section=content',	'admin_settings_email'			=>	'admin/settings.php?section=email',	'admin_settings_announcements'	=>	'admin/settings.php?section=announcements',	'admin_settings_registration'	=>	'admin/settings.php?section=registration',	'admin_settings_communications'	=>	'admin/settings.php?section=communications',	'admin_settings_maintenance'	=>	'admin/settings.php?section=maintenance',	'admin_prune'					=>	'admin/prune.php',	'admin_ranks'					=>	'admin/ranks.php',	'admin_reports'					=>	'admin/reports.php',	'admin_users'					=>	'admin/users.php');
<?php/** * SEF URLs that use a folder-like layout. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure no one attempts to run this script "directly"if (!defined('FORUM'))	exit;// These are the simple folder based SEF URLs$forum_url = array(	'change_email'					=>	'change/email/$1/',	'change_email_key'				=>	'change/email/$1/$2/',	'change_password'				=>	'change/password/$1/',	'change_password_key'			=>	'change/password/$1/$2/',	'delete'						=>	'delete/$1/',	'delete_avatar'					=>	'delete/avatar/$1/$2/',	'delete_user'					=>	'delete/user/$1/',	'edit'							=>	'edit/$1/',	'email'							=>	'email/$1/',	'forum'							=>	'forum/$1/',	'forum_rss'						=>	'feed/rss/forum/$1/',	'forum_atom'					=>	'feed/atom/forum/$1/',	'help'							=>	'help/$1/',	'index'							=>	'',	'index_rss'						=>	'feed/rss/',	'index_atom'					=>	'feed/atom/',	'login'							=>	'login/',	'logout'						=>	'logout/$1/$2/',	'mark_read'						=>	'mark/read/$1/',	'mark_forum_read'				=>	'mark/forum/$1/read/$2/',	'new_topic'						=>	'new/topic/$1/',	'new_reply'						=>	'new/reply/$1/',	'post'							=>	'post/$1/#p$1',	'profile_about'					=>	'user/$1/about/',	'profile_identity'				=>	'user/$1/identity/',	'profile_settings'				=>	'user/$1/settings/',	'profile_avatar'				=>	'user/$1/avatar/',	'profile_signature'				=>	'user/$1/signature/',	'profile_admin'					=>	'user/$1/admin/',	'quote'							=>	'new/reply/$1/quote/$2/',	'register'						=>	'register/',	'report'						=>	'report/$1/',	'request_password'				=>	'request/password/',	'rules'							=>	'rules/',	'search'						=>	'search/',	'search_advanced'				=>	'search/advanced/',	'search_resultft'				=>	'search/k$1/$2/a$3/$4/$5/$6/$7/',	'search_results'				=>	'search/$1/',	'search_new'					=>	'search/new/',	'search_new_results'			=>	'search/new/$1/',	'search_recent'					=>	'search/recent/',	'search_recent_results'			=>	'search/recent/$1/',	'search_unanswered'				=>	'search/unanswered/',	'search_subscriptions'			=>	'search/subscriptions/$1/',	'search_user_posts'				=>	'search/posts/user/$1/',	'search_user_topics'			=>	'search/topics/user/$1/',	'subscribe'						=>	'subscribe/$1/$2/',	'topic'							=>	'topic/$1/',	'topic_rss'						=>	'feed/rss/topic/$1/',	'topic_atom'					=>	'feed/atom/topic/$1/',	'topic_new_posts'				=>	'topic/$1/new/posts/',	'topic_last_post'				=>	'topic/$1/last/post/',	'unsubscribe'					=>	'unsubscribe/$1/$2/',	'user'							=>	'user/$1/',	'users'							=>	'users/',	'users_browse'					=>	'users/$4/$1/$2/$3/',	'page'							=>	'page/$1/',	'moderate_forum'				=>	'moderate/$1/',	'get_host'						=>	'get_host/$1/',	'move'							=>	'move_topics/$1/$2/',	'open'							=>	'open/$1/$2/$3/',	'close'							=>	'close/$1/$2/$3/',	'stick'							=>	'stick/$1/$2/$3/',	'unstick'						=>	'unstick/$1/$2/$3/',	'moderate_topic'				=>	'moderate/$1/$2/',	'admin_index'					=>	'admin/index.php',	'admin_bans'					=>	'admin/bans.php?sort_by=1',	'admin_categories'				=>	'admin/categories.php',	'admin_censoring'				=>	'admin/censoring.php',	'admin_extensions_manage'		=>	'admin/extensions.php?section=manage',	'admin_extensions_hotfixes'		=>	'admin/extensions.php?section=hotfixes',	'admin_forums'					=>	'admin/forums.php',	'admin_groups'					=>	'admin/groups.php',	'admin_loader'					=>	'admin/loader.php',	'admin_reindex'					=>	'admin/reindex.php',	'admin_settings_setup'			=>	'admin/settings.php?section=setup',	'admin_settings_features'		=>	'admin/settings.php?section=features',	'admin_settings_content'		=>	'admin/settings.php?section=content',	'admin_settings_email'			=>	'admin/settings.php?section=email',	'admin_settings_announcements'	=>	'admin/settings.php?section=announcements',	'admin_settings_registration'	=>	'admin/settings.php?section=registration',	'admin_settings_communications'	=>	'admin/settings.php?section=communications',	'admin_settings_maintenance'	=>	'admin/settings.php?section=maintenance',	'admin_prune'					=>	'admin/prune.php',	'admin_ranks'					=>	'admin/ranks.php',	'admin_reports'					=>	'admin/reports.php',	'admin_users'					=>	'admin/users.php');
<?php/*** @version $Id: strrev.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to strrev* Reverse a string* @param string UTF-8 encoded* @return string characters in string reverses* @see http://www.php.net/strrev* @package utf8* @subpackage strings*/function utf8_strrev($str){    preg_match_all('/./us', $str, $ar);    return join('',array_reverse($ar[0]));}
<?php/** * A database layer class that relies on the MySQL PHP extension. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure we have built in support for MySQLif (!function_exists('mysql_connect'))	exit('This PHP environment doesn\'t have MySQL support built in. MySQL support is required if you want to use a MySQL database to run this forum. Consult the PHP documentation for further assistance.');class DBLayer{	var $prefix;	var $link_id;	var $query_result;	var $in_transaction = 0;	var $saved_queries = array();	var $num_queries = 0;	var $datatype_transformations = array(		'/^SERIAL$/'	=>	'INT(10) UNSIGNED AUTO_INCREMENT'	);	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)	{		$this->prefix = $db_prefix;		if ($p_connect)			$this->link_id = @mysql_pconnect($db_host, $db_username, $db_password);		else			$this->link_id = @mysql_connect($db_host, $db_username, $db_password);		if ($this->link_id)		{			if (!@mysql_select_db($db_name, $this->link_id))				error('Unable to select database. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		}		else			error('Unable to connect to MySQL server. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		// Setup the client-server character set (UTF-8)		if (!defined('FORUM_NO_SET_NAMES'))			$this->set_names('utf8');		return $this->link_id;	}	function start_transaction()	{		++$this->in_transaction;		return mysql_query('START TRANSACTION', $this->link_id);	}	function end_transaction()	{		--$this->in_transaction;		if (mysql_query('COMMIT', $this->link_id))			return true;		else		{			mysql_query('ROLLBACK', $this->link_id);			return false;		}	}	function query($sql, $unbuffered = false)	{		if (strlen($sql) > 140000)			exit('Insane query. Aborting.');		if (defined('FORUM_SHOW_QUERIES'))			$q_start = forum_microtime();		if ($unbuffered)			$this->query_result = @mysql_unbuffered_query($sql, $this->link_id);		else			$this->query_result = @mysql_query($sql, $this->link_id);		if ($this->query_result)		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, sprintf('%.5f', forum_microtime() - $q_start));			++$this->num_queries;			return $this->query_result;		}		else		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, 0);			if ($this->in_transaction)				mysql_query('ROLLBACK', $this->link_id);			--$this->in_transaction;			return false;		}	}	function query_build($query, $return_query_string = false, $unbuffered = false)	{		$sql = '';		if (isset($query['SELECT']))		{			$sql = 'SELECT '.$query['SELECT'].' FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['FROM'];			if (isset($query['JOINS']))			{				foreach ($query['JOINS'] as $cur_join)					$sql .= ' '.key($cur_join).' '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).current($cur_join).' ON '.$cur_join['ON'];			}			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];			if (!empty($query['GROUP BY']))				$sql .= ' GROUP BY '.$query['GROUP BY'];			if (!empty($query['HAVING']))				$sql .= ' HAVING '.$query['HAVING'];			if (!empty($query['ORDER BY']))				$sql .= ' ORDER BY '.$query['ORDER BY'];			if (!empty($query['LIMIT']))				$sql .= ' LIMIT '.$query['LIMIT'];		}		else if (isset($query['INSERT']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['INSERT']))				$sql .= ' ('.$query['INSERT'].')';			if (is_array($query['VALUES']))				$sql .= ' VALUES('.implode('),(', $query['VALUES']).')';			else				$sql .= ' VALUES('.$query['VALUES'].')';		}		else if (isset($query['UPDATE']))		{			$query['UPDATE'] = (isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['UPDATE'];			$sql = 'UPDATE '.$query['UPDATE'].' SET '.$query['SET'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['DELETE']))		{			$sql = 'DELETE FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['DELETE'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['REPLACE']))		{			$sql = 'REPLACE INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['REPLACE']))				$sql .= ' ('.$query['REPLACE'].')';			$sql .= ' VALUES('.$query['VALUES'].')';		}		return ($return_query_string) ? $sql : $this->query($sql, $unbuffered);	}	function result($query_id = 0, $row = 0, $col = 0)	{		return ($query_id) ? @mysql_result($query_id, $row, $col) : false;	}	function fetch_assoc($query_id = 0)	{		return ($query_id) ? @mysql_fetch_assoc($query_id) : false;	}	function fetch_row($query_id = 0)	{		return ($query_id) ? @mysql_fetch_row($query_id) : false;	}	function num_rows($query_id = 0)	{		return ($query_id) ? @mysql_num_rows($query_id) : false;	}	function affected_rows()	{		return ($this->link_id) ? @mysql_affected_rows($this->link_id) : false;	}	function insert_id()	{		return ($this->link_id) ? @mysql_insert_id($this->link_id) : false;	}	function get_num_queries()	{		return $this->num_queries;	}	function get_saved_queries()	{		return $this->saved_queries;	}	function free_result($query_id = false)	{		return ($query_id) ? @mysql_free_result($query_id) : false;	}	function escape($str)	{		if (is_array($str))			return '';		else if (function_exists('mysql_real_escape_string'))			return mysql_real_escape_string($str, $this->link_id);		else			return mysql_escape_string($str);	}	function error()	{		$result['error_sql'] = @current(@end($this->saved_queries));		$result['error_no'] = @mysql_errno($this->link_id);		$result['error_msg'] = @mysql_error($this->link_id);		return $result;	}	function close()	{		if ($this->link_id)		{			if ($this->query_result)				@mysql_free_result($this->query_result);			return @mysql_close($this->link_id);		}		else			return false;	}	function set_names($names)	{		return $this->query('SET NAMES \''.$this->escape($names).'\'');	}	function get_version()	{		$result = $this->query('SELECT VERSION()');		return array(			'name'		=> 'MySQL Standard (InnoDB)',			'version'	=> preg_replace('/^([^-]+).*$/', '\\1', $this->result($result))		);	}	function table_exists($table_name, $no_prefix = false)	{		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');		return $this->num_rows($result) > 0;	}	function field_exists($table_name, $field_name, $no_prefix = false)	{		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');		return $this->num_rows($result) > 0;	}	function index_exists($table_name, $index_name, $no_prefix = false)	{		$exists = false;		$result = $this->query('SHOW INDEX FROM '.($no_prefix ? '' : $this->prefix).$table_name);		while ($cur_index = $this->fetch_assoc($result))		{			if ($cur_index['Key_name'] == ($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name)			{				$exists = true;				break;			}		}		return $exists;	}	function create_table($table_name, $schema, $no_prefix = false)	{		if ($this->table_exists($table_name, $no_prefix))			return;		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";		// Go through every schema element and add it to the query		foreach ($schema['FIELDS'] as $field_name => $field_data)		{			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);			$query .= $field_name.' '.$field_data['datatype'];			if (isset($field_data['collation']))				$query .= 'CHARACTER SET utf8 COLLATE utf8_'.$field_data['collation'];			if (!$field_data['allow_null'])				$query .= ' NOT NULL';			if (isset($field_data['default']))				$query .= ' DEFAULT '.$field_data['default'];			$query .= ",\n";		}		// If we have a primary key, add it		if (isset($schema['PRIMARY KEY']))			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";		// Add unique keys		if (isset($schema['UNIQUE KEYS']))		{			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)				$query .= 'UNIQUE KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$key_name.'('.implode(',', $key_fields).'),'."\n";		}		// Add indexes		if (isset($schema['INDEXES']))		{			foreach ($schema['INDEXES'] as $index_name => $index_fields)				$query .= 'KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.'('.implode(',', $index_fields).'),'."\n";		}		// We remove the last two characters (a newline and a comma) and add on the ending		$query = substr($query, 0, strlen($query) - 2)."\n".') ENGINE = '.(isset($schema['ENGINE']) ? $schema['ENGINE'] : 'InnoDB').' CHARACTER SET utf8';		$this->query($query) or error(__FILE__, __LINE__);	}	function drop_table($table_name, $no_prefix = false)	{		if (!$this->table_exists($table_name, $no_prefix))			return;		$this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) or error(__FILE__, __LINE__);	}	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if ($this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' MODIFY '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function drop_field($table_name, $field_name, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) or error(__FILE__, __LINE__);	}	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)	{		if ($this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ('.implode(',', $index_fields).')') or error(__FILE__, __LINE__);	}	function drop_index($table_name, $index_name, $no_prefix = false)	{		if (!$this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) or error(__FILE__, __LINE__);	}}
<?php/** * Lists the topics in the specified forum. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', './');require FORUM_ROOT.'include/common.php';($hook = get_hook('vf_start')) ? eval($hook) : null;if ($forum_user['g_read_board'] == '0')	message($lang_common['No view']);// Load the viewforum.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/forum.php';$id = isset($_GET['id']) ? intval($_GET['id']) : 0;if ($id < 1)	message($lang_common['Bad request']);// Fetch some info about the forum$query = array(	'SELECT'	=> 'f.forum_name, f.redirect_url, f.moderators, f.num_topics, f.sort_by, fp.post_topics',	'FROM'		=> 'forums AS f',	'JOINS'		=> array(		array(			'LEFT JOIN'		=> 'forum_perms AS fp',			'ON'			=> '(fp.forum_id=f.id AND fp.group_id='.$forum_user['g_id'].')'		)	),	'WHERE'		=> '(fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$id);($hook = get_hook('vf_qr_get_forum_info')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$cur_forum = $forum_db->fetch_assoc($result);if (!$cur_forum)	message($lang_common['Bad request']);($hook = get_hook('vf_modify_forum_info')) ? eval($hook) : null;// Is this a redirect forum? In that case, redirect!if ($cur_forum['redirect_url'] != ''){	($hook = get_hook('vf_redirect_forum_pre_redirect')) ? eval($hook) : null;	header('Location: '.$cur_forum['redirect_url']);	exit;}// Sort out who the moderators are and if we are currently a moderator (or an admin)$mods_array = ($cur_forum['moderators'] != '') ? unserialize($cur_forum['moderators']) : array();$forum_page['is_admmod'] = ($forum_user['g_id'] == FORUM_ADMIN || ($forum_user['g_moderator'] == '1' && array_key_exists($forum_user['username'], $mods_array))) ? true : false;// Sort out whether or not this user can post$forum_user['may_post'] = (($cur_forum['post_topics'] == '' && $forum_user['g_post_topics'] == '1') || $cur_forum['post_topics'] == '1' || $forum_page['is_admmod']) ? true : false;// Get topic/forum tracking dataif (!$forum_user['is_guest'])	$tracked_topics = get_tracked_topics();// Determine the topic offset (based on $_GET['p'])$forum_page['num_pages'] = ceil($cur_forum['num_topics'] / $forum_user['disp_topics']);$forum_page['page'] = (!isset($_GET['p']) || !is_numeric($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $forum_page['num_pages']) ? 1 : $_GET['p'];$forum_page['start_from'] = $forum_user['disp_topics'] * ($forum_page['page'] - 1);$forum_page['finish_at'] = min(($forum_page['start_from'] + $forum_user['disp_topics']), ($cur_forum['num_topics']));$forum_page['items_info'] = generate_items_info($lang_forum['Topics'], ($forum_page['start_from'] + 1), $cur_forum['num_topics']);($hook = get_hook('vf_modify_page_details')) ? eval($hook) : null;// Navigation links for header and page numbering for title/meta descriptionif ($forum_page['page'] < $forum_page['num_pages']){	$forum_page['nav']['last'] = '<link rel="last" href="'.forum_sublink($forum_url['forum'], $forum_url['page'], $forum_page['num_pages'], array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' '.$forum_page['num_pages'].'" />';	$forum_page['nav']['next'] = '<link rel="next" href="'.forum_sublink($forum_url['forum'], $forum_url['page'], ($forum_page['page'] + 1), array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' '.($forum_page['page'] + 1).'" />';}if ($forum_page['page'] > 1){	$forum_page['nav']['prev'] = '<link rel="prev" href="'.forum_sublink($forum_url['forum'], $forum_url['page'], ($forum_page['page'] - 1), array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' '.($forum_page['page'] - 1).'" />';	$forum_page['nav']['first'] = '<link rel="first" href="'.forum_link($forum_url['forum'], array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' 1" />';}/* * Fetch list of topics * EXT DEVELOPERS * If you modify SELECT of this query - than add same columns in next query (has posted) in GROUP BY*/$query = array(	'SELECT'	=> 't.id, t.poster, t.subject, t.posted, t.first_post_id, t.last_post, t.last_post_id, t.last_poster, t.num_views, t.num_replies, t.closed, t.sticky, t.moved_to',	'FROM'		=> 'topics AS t',	'WHERE'		=> 't.forum_id='.$id,	'ORDER BY'	=> 't.sticky DESC, '.(($cur_forum['sort_by'] == '1') ? 't.posted' : 't.last_post').' DESC',	'LIMIT'		=> $forum_page['start_from'].', '.$forum_user['disp_topics']);// With "has posted" indicationif (!$forum_user['is_guest'] && $forum_config['o_show_dot'] == '1'){	$query['SELECT'] .= ', COALESCE(p.id, 0) AS has_posted';	$query['JOINS'][]	= array(		'LEFT JOIN'		=> 'posts AS p',		'ON'			=> '(p.poster_id='.$forum_user['id'].' AND p.topic_id=t.id)'	);	// Must have same columns as in prev SELECT	$query['GROUP BY'] = 'p.id, t.id, t.poster, t.subject, t.posted, t.first_post_id, t.last_post, t.last_post_id, t.last_poster, t.num_views, t.num_replies, t.closed, t.sticky, t.moved_to';	($hook = get_hook('vf_qr_get_has_posted')) ? eval($hook) : null;}($hook = get_hook('vf_qr_get_topics')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$topics = array();while ($cur_topic = $forum_db->fetch_assoc($result)){	$topics[] = $cur_topic;}// Generate paging/posting links$forum_page['page_post']['paging'] = '<p class="paging"><span class="pages">'.$lang_common['Pages'].'</span> '.paginate($forum_page['num_pages'], $forum_page['page'], $forum_url['forum'], $lang_common['Paging separator'], array($id, sef_friendly($cur_forum['forum_name']))).'</p>';if ($forum_user['may_post'])	$forum_page['page_post']['posting'] = '<p class="posting"><a class="newpost" href="'.forum_link($forum_url['new_topic'], $id).'"><span>'.$lang_forum['Post topic'].'</span></a></p>';else if ($forum_user['is_guest'])	$forum_page['page_post']['posting'] = '<p class="posting">'.sprintf($lang_forum['Login to post'], '<a href="'.forum_link($forum_url['login']).'">'.$lang_common['login'].'</a>', '<a href="'.forum_link($forum_url['register']).'">'.$lang_common['register'].'</a>').'</p>';else	$forum_page['page_post']['posting'] = '<p class="posting">'.$lang_forum['No permission'].'</p>';// Setup main options$forum_page['main_head_options'] = array(	'feed'	=> '<span class="feed first-item"><a class="feed" href="'.forum_link($forum_url['forum_rss'], $id).'">'.$lang_forum['RSS forum feed'].'</a></span>');$forum_page['main_foot_options'] = array();if (!$forum_user['is_guest'] && !empty($topics)){	$forum_page['main_foot_options']['mark_read'] = '<span class="first-item"><a href="'.forum_link($forum_url['mark_forum_read'], array($id, generate_form_token('markforumread'.$id.$forum_user['id']))).'">'.$lang_forum['Mark forum read'].'</a></span>';	if ($forum_page['is_admmod'])		$forum_page['main_foot_options']['moderate'] = '<span'.(empty($forum_page['main_foot_options']) ? ' class="first-item"' : '').'><a href="'.forum_sublink($forum_url['moderate_forum'], $forum_url['page'], $forum_page['page'], $id).'">'.$lang_forum['Moderate forum'].'</a></span>';}// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($cur_forum['forum_name'], forum_link($forum_url['forum'], array($id, sef_friendly($cur_forum['forum_name'])))));// Setup main header$forum_page['main_title'] = '<a class="permalink" href="'.forum_link($forum_url['forum'], array($id, sef_friendly($cur_forum['forum_name']))).'" rel="bookmark" title="'.$lang_forum['Permalink forum'].'">'.forum_htmlencode($cur_forum['forum_name']).'</a>';if ($forum_page['num_pages'] > 1)	$forum_page['main_head_pages'] = sprintf($lang_common['Page info'], $forum_page['page'], $forum_page['num_pages']);($hook = get_hook('vf_pre_header_load')) ? eval($hook) : null;define('FORUM_ALLOW_INDEX', 1);define('FORUM_PAGE', 'viewforum');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();$forum_page['item_header'] = array();$forum_page['item_header']['subject']['title'] = '<strong class="subject-title">'.$lang_forum['Topics'].'</strong>';$forum_page['item_header']['info']['replies'] = '<strong class="info-replies">'.$lang_forum['replies'].'</strong>';if ($forum_config['o_topic_views'] == '1')	$forum_page['item_header']['info']['views'] = '<strong class="info-views">'.$lang_forum['views'].'</strong>';$forum_page['item_header']['info']['lastpost'] = '<strong class="info-lastpost">'.$lang_forum['last post'].'</strong>';($hook = get_hook('vf_main_output_start')) ? eval($hook) : null;// If there are topics in this forumif (!empty($topics)){?>	<div class="main-head"><?php	if (!empty($forum_page['main_head_options']))		echo "\n\t\t".'<p class="options">'.implode(' ', $forum_page['main_head_options']).'</p>';?>		<h2 class="hn"><span><?php echo $forum_page['items_info'] ?></span></h2>	</div>	<div class="main-subhead">		<p class="item-summary<?php echo ($forum_config['o_topic_views'] == '1') ? ' forum-views' : ' forum-noview' ?>"><span><?php printf($lang_forum['Forum subtitle'], implode(' ', $forum_page['item_header']['subject']), implode(', ', $forum_page['item_header']['info'])) ?></span></p>	</div>	<div id="forum<?php echo $id ?>" class="main-content main-forum<?php echo ($forum_config['o_topic_views'] == '1') ? ' forum-views' : ' forum-noview' ?>"><?php	($hook = get_hook('vf_pre_topic_loop_start')) ? eval($hook) : null;	$forum_page['item_count'] = 0;	foreach ($topics as $cur_topic)	{		($hook = get_hook('vf_topic_loop_start')) ? eval($hook) : null;		++$forum_page['item_count'];		// Start from scratch		$forum_page['item_subject'] = $forum_page['item_body'] = $forum_page['item_status'] = $forum_page['item_nav'] = $forum_page['item_title'] = $forum_page['item_title_status'] = array();		if ($forum_config['o_censoring'] == '1')			$cur_topic['subject'] = censor_words($cur_topic['subject']);		$forum_page['item_subject']['starter'] = '<span class="item-starter">'.sprintf($lang_forum['Topic starter'], forum_htmlencode($cur_topic['poster'])).'</span>';		if ($cur_topic['moved_to'] != null)		{			$forum_page['item_status']['moved'] = 'moved';			$forum_page['item_title']['link'] = '<span class="item-status"><em class="moved">'.sprintf($lang_forum['Item status'], $lang_forum['Moved']).'</em></span> <a href="'.forum_link($forum_url['topic'], array($cur_topic['moved_to'], sef_friendly($cur_topic['subject']))).'">'.forum_htmlencode($cur_topic['subject']).'</a>';			// Combine everything to produce the Topic heading			$forum_page['item_body']['subject']['title'] = '<h3 class="hn"><span class="item-num">'.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span>'.$forum_page['item_title']['link'].'</h3>';			($hook = get_hook('vf_topic_loop_moved_topic_pre_item_subject_merge')) ? eval($hook) : null;			$forum_page['item_body']['info']['replies'] = '<li class="info-replies"><span class="label">'.$lang_forum['No replies info'].'</span></li>';			if ($forum_config['o_topic_views'] == '1')				$forum_page['item_body']['info']['views'] = '<li class="info-views"><span class="label">'.$lang_forum['No views info'].'</span></li>';			$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><span class="label">'.$lang_forum['No lastpost info'].'</span></li>';		}		else		{			// Assemble the Topic heading			// Should we display the dot or not? :)			if (!$forum_user['is_guest'] && $forum_config['o_show_dot'] == '1' && $cur_topic['has_posted'] > 0)			{				$forum_page['item_title']['posted'] = '<span class="posted-mark">'.$lang_forum['You posted indicator'].'</span>';				$forum_page['item_status']['posted'] = 'posted';			}			if ($cur_topic['sticky'] == '1')			{				$forum_page['item_title_status']['sticky'] = '<em class="sticky">'.$lang_forum['Sticky'].'</em>';				$forum_page['item_status']['sticky'] = 'sticky';			}			if ($cur_topic['closed'] == '1')			{				$forum_page['item_title_status']['closed'] = '<em class="closed">'.$lang_forum['Closed'].'</em>';				$forum_page['item_status']['closed'] = 'closed';			}			($hook = get_hook('vf_topic_loop_normal_topic_pre_item_title_status_merge')) ? eval($hook) : null;			if (!empty($forum_page['item_title_status']))				$forum_page['item_title']['status'] = '<span class="item-status">'.sprintf($lang_forum['Item status'], implode(', ', $forum_page['item_title_status'])).'</span>';			$forum_page['item_title']['link'] = '<a href="'.forum_link($forum_url['topic'], array($cur_topic['id'], sef_friendly($cur_topic['subject']))).'">'.forum_htmlencode($cur_topic['subject']).'</a>';			($hook = get_hook('vf_topic_loop_normal_topic_pre_item_title_merge')) ? eval($hook) : null;			$forum_page['item_body']['subject']['title'] = '<h3 class="hn"><span class="item-num">'.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span> '.implode(' ', $forum_page['item_title']).'</h3>';			if (empty($forum_page['item_status']))				$forum_page['item_status']['normal'] = 'normal';			$forum_page['item_pages'] = ceil(($cur_topic['num_replies'] + 1) / $forum_user['disp_posts']);			if ($forum_page['item_pages'] > 1)				$forum_page['item_nav']['pages'] = '<span>'.$lang_forum['Pages'].'&#160;</span>'.paginate($forum_page['item_pages'], -1, $forum_url['topic'], $lang_common['Page separator'], array($cur_topic['id'], sef_friendly($cur_topic['subject'])));			// Does this topic contain posts we haven't read? If so, tag it accordingly.			if (!$forum_user['is_guest'] && $cur_topic['last_post'] > $forum_user['last_visit'] && (!isset($tracked_topics['topics'][$cur_topic['id']]) || $tracked_topics['topics'][$cur_topic['id']] < $cur_topic['last_post']) && (!isset($tracked_topics['forums'][$id]) || $tracked_topics['forums'][$id] < $cur_topic['last_post']))			{				$forum_page['item_nav']['new'] = '<em class="item-newposts"><a href="'.forum_link($forum_url['topic_new_posts'], array($cur_topic['id'], sef_friendly($cur_topic['subject']))).'">'.$lang_forum['New posts'].'</a></em>';				$forum_page['item_status']['new'] = 'new';			}			($hook = get_hook('vf_topic_loop_normal_topic_pre_item_nav_merge')) ? eval($hook) : null;			if (!empty($forum_page['item_nav']))				$forum_page['item_subject']['nav'] = '<span class="item-nav">'.sprintf($lang_forum['Topic navigation'], implode('&#160;&#160;', $forum_page['item_nav'])).'</span>';			// Assemble the Topic subject			$forum_page['item_body']['info']['replies'] = '<li class="info-replies"><strong>'.forum_number_format($cur_topic['num_replies']).'</strong> <span class="label">'.(($cur_topic['num_replies'] == 1) ? $lang_forum['reply'] : $lang_forum['replies']).'</span></li>';			if ($forum_config['o_topic_views'] == '1')				$forum_page['item_body']['info']['views'] = '<li class="info-views"><strong>'.forum_number_format($cur_topic['num_views']).'</strong> <span class="label">'.(($cur_topic['num_views'] == 1) ? $lang_forum['view'] : $lang_forum['views']).'</span></li>';			$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><span class="label">'.$lang_forum['Last post'].'</span> <strong><a href="'.forum_link($forum_url['post'], $cur_topic['last_post_id']).'">'.format_time($cur_topic['last_post']).'</a></strong> <cite>'.sprintf($lang_forum['by poster'], forum_htmlencode($cur_topic['last_poster'])).'</cite></li>';		}		($hook = get_hook('vf_row_pre_item_subject_merge')) ? eval($hook) : null;		$forum_page['item_body']['subject']['desc'] = '<p>'.implode(' ', $forum_page['item_subject']).'</p>';		($hook = get_hook('vf_row_pre_item_status_merge')) ? eval($hook) : null;		$forum_page['item_style'] = (($forum_page['item_count'] % 2 != 0) ? ' odd' : ' even').(($forum_page['item_count'] == 1) ? ' main-first-item' : '').((!empty($forum_page['item_status'])) ? ' '.implode(' ', $forum_page['item_status']) : '');		($hook = get_hook('vf_row_pre_display')) ? eval($hook) : null;?>		<div id="topic<?php echo $cur_topic['id'] ?>" class="main-item<?php echo $forum_page['item_style'] ?>">			<span class="icon <?php echo implode(' ', $forum_page['item_status']) ?>"><!-- --></span>			<div class="item-subject">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['subject'])."\n" ?>			</div>			<ul class="item-info">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['info'])."\n" ?>			</ul>		</div><?php	}?>	</div>	<div class="main-foot"><?php	if (!empty($forum_page['main_foot_options']))		echo "\n\t\t\t".'<p class="options">'.implode(' ', $forum_page['main_foot_options']).'</p>';?>		<h2 class="hn"><span><?php echo $forum_page['items_info'] ?></span></h2>	</div><?php}// Else there are no topics in this forumelse{	$forum_page['item_body']['subject']['title'] = '<h3 class="hn">'.$lang_forum['No topics'].'</h3>';	$forum_page['item_body']['subject']['desc'] = '<p>'.$lang_forum['First topic nag'].'</p>';	($hook = get_hook('vf_no_results_row_pre_display')) ? eval($hook) : null;?>	<div class="main-head">		<h2 class="hn"><span><?php echo $lang_forum['Empty forum'] ?></span></h2>	</div>	<div id="forum<?php echo $id ?>" class="main-content main-forum">		<div class="main-item empty main-first-item">			<span class="icon empty"><!-- --></span>			<div class="item-subject">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['subject'])."\n" ?>			</div>		</div>	</div>	<div class="main-foot">		<h2 class="hn"><span><?php echo $lang_forum['Empty forum'] ?></span></h2>	</div><?php}($hook = get_hook('vf_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->$forum_id = $id;require FORUM_ROOT.'footer.php';
<?php/** * Loads the regular expressions used to match SEF URL requests to their proper URLs. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */$forum_rewrite_rules = array(	'/^topic[\/_-]?([0-9]+).*(new|last)[\/_-]?(posts?)(\.html?|\/)?$/i'														=>	'viewtopic.php?id=$1&action=$2',	'/^post[\/_-]?([0-9]+)(\.html?|\/)?$/i'																					=>	'viewtopic.php?pid=$1',	'/^(forum|topic)[\/_-]?([0-9]+).*[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'											=>	'view$1.php?id=$2&p=$4',	'/^feed[\/_-]?(rss|atom)[\/_-]?(f|t)(orum|opic)[\/_-]?([0-9]+)[\/_-]?(\.xml?|\/)?$/i'									=>	'extern.php?action=feed&$2id=$4&type=$1',	'/^(forum|topic)[\/_-]?([0-9]+).*(\.html?|\/)?$/i'																		=>	'view$1.php?id=$2',	'/^new[\/_-]?reply[\/_-]?([0-9]+)(\.html?|\/)?$/i'																		=>	'post.php?tid=$1',	'/^new[\/_-]?reply[\/_-]?([0-9]+)[\/_-]?quote[\/_-]?([0-9]+)(\.html?|\/)?$/i'											=>	'post.php?tid=$1&qid=$2',	'/^new[\/_-]?topic[\/_-]?([0-9]+)(\.html?|\/)?$/i'																		=>	'post.php?fid=$1',	'/^(delete|edit)[\/_-]?([0-9]+)(\.html?|\/)?$/i'																		=>	'$1.php?id=$2',	'/^(login|search|register)(\.html?|\/)?$/i'																				=>	'$1.php',	'/^logout[\/_-]?([0-9]+)[\/_-]([a-z0-9]+)(\.html?|\/)?$/i'																=>	'login.php?action=out&id=$1&csrf_token=$2',	'/^request[\/_-]?password(\.html?|\/)?$/i'																				=>	'login.php?action=forget',	'/^user[\/_-]?([0-9]+)(\.html?|\/)?$/i'																					=>	'profile.php?id=$1',	'/^user[\/_-]?([0-9]+)[\/_-]?([a-z]+)(\.html?|\/)?$/i'																	=>	'profile.php?section=$2&id=$1',	'/^(delete)[\/_-]?(avatar|user)?[\/_-]?([0-9]+)[\/_-]?([a-z0-9]+)?(\.html?|\/)?$/i'										=>	'profile.php?action=$1_$2&id=$3&csrf_token=$4',	'/^change[\/_-]?(email|pass)(word)?[\/_-]?([0-9]+)[\/_-]([a-zA-Z0-9]+)(\.html?|\/)?$/i'									=>	'profile.php?action=change_$1&id=$3&key=$4',	'/^change[\/_-]?(email|pass)(word)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'														=>	'profile.php?action=change_$1&id=$3',	'/^search[\/_-]?advanced(\.html?|\/)?$/i'																				=>	'search.php?advanced=1',	'/^search[\/_-]?(new)[\/_-]([0-9-]+)(\.html?|\/)?$/i'																	=>	'search.php?action=show_new&forum=$2',	'/^search[\/_-]?(new)[\/_-]([0-9-]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'										=>	'search.php?action=show_new&forum=$2&p=$4',	'/^search[\/_-]?(recent)[\/_-]([0-9]+)(\.html?|\/)?$/i'																	=>	'search.php?action=show_recent&value=$2',	'/^search[\/_-]?(recent)[\/_-]([0-9]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'										=>	'search.php?action=show_recent&value=$2&p=$4',	'/^search[\/_-]?(new|recent|unanswered)(\.html?|\/)?$/i'																=>	'search.php?action=show_$1',	'/^search[\/_-]?(new|recent|unanswered)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'									=>	'search.php?action=show_$1&p=$3',	'/^search[\/_-]?subscriptions[\/_-]?([0-9]+)(\.html?|\/)?$/i'															=>	'search.php?action=show_subscriptions&user_id=$1',	'/^search[\/_-]?subscriptions[\/_-]?([0-9]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'								=>	'search.php?action=show_subscriptions&user_id=$1&p=$3',	'/^search[\/_-]?([0-9]+)(\.html?|\/)?$/i'																				=>	'search.php?search_id=$1',	'/^search[\/_-]?([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'													=>	'search.php?search_id=$1&p=$3',	'/^search[\/_-]?(posts|topics)[\/_-]?user[\/_-]?([0-9]+)(\.html?|\/)?$/i'												=>	'search.php?action=show_user_$1&user_id=$2',	'/^search[\/_-]?(posts|topics)[\/_-]?user[\/_-]?([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'					=>	'search.php?action=show_user_$1&user_id=$2&p=$4',	'/^search\/k(.*)\/([0-9-]+)\/a(.*)\/(message|subject|all)\/([0-9]+)\/(ASC|DESC)\/(posts|topics)\/?$/i'					=>	'search.php?action=search&keywords=$1&author=$3&forum=$2&search_in=$4&sort_by=$5&sort_dir=$6&show_as=$7',	'/^search\/k(.*)\/([0-9-]+)\/a(.*)\/(message|subject|all)\/([0-9]+)\/(ASC|DESC)\/(posts|topics)\/page\/([0-9]+)\/?$/i'	=>	'search.php?action=search&keywords=$1&author=$3&forum=$2&search_in=$4&sort_by=$5&sort_dir=$6&show_as=$7&p=$8',	'/^search-k(.*)-([0-9-]+)-a(.*)-(message|subject|all)-([0-9]+)-(ASC|DESC)-(posts|topics).html?$/i'						=>	'search.php?action=search&keywords=$1&author=$3&forum=$2&search_in=$4&sort_by=$5&sort_dir=$6&show_as=$7',	'/^search-k(.*)-(message|subject|all)-a(.*)-([0-9]+)-(ASC|DESC)-([0-9-]+)-(posts|topics)-p([0-9]+).html?$/i'			=>	'search.php?action=search&keywords=$1&author=$3&forum=$6&search_in=$2&sort_by=$4&sort_dir=$5&show_as=$7&p=$8',	'/^users(\.html?|\/)?$/i'																								=>	'userlist.php',	'/^users\/(.*)\/([0-9-]+)\/?([a-z_]+)[\/_-]([a-zA-Z]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'						=>	'userlist.php?username=$1&show_group=$2&sort_by=$3&sort_dir=$4&p=$6',	'/^users\/(.*)\/([0-9-]+)\/?([a-z_]+)[\/_-]([a-zA-Z]+)(\.html?|\/)?$/i'													=>	'userlist.php?username=$1&show_group=$2&sort_by=$3&sort_dir=$4',	'/^(email|report|subscribe|unsubscribe)[\/_-]?([0-9]+)[\/_-]?([a-z0-9]+)?(\.html?|\/)?$/i'								=>	'misc.php?$1=$2&csrf_token=$3',	'/^(mark|rules)[\/_-]?(read)?[\/_-]?([a-z0-9]+)?(\.html?|\/)?$/i'														=>	'misc.php?action=$1$2&csrf_token=$3',	'/^mark[\/_-](forum)[\/_-]?([0-9]+)[\/_-](read)[\/_-]([a-z0-9]+)(\.html?|\/)?$/i'										=>	'misc.php?action=markforumread&fid=$2&csrf_token=$4',	'/^help[\/_-]([a-z]+)(\.html?|\/)?$/i'																					=>	'help.php?section=$1',	'/^moderate[\/_-]?([0-9]+)(\.html?|\/)?$/i'																				=>	'moderate.php?fid=$1',	'/^move_topics[\/_-]?([0-9]+)[\/_-]([0-9]+)(\.html?|\/)?$/i'															=>	'moderate.php?fid=$1&move_topics=$2',	'/^(open|close|stick|unstick)[\/_-]?([0-9]+)[\/_-]([0-9]+)[\/_-]([a-z0-9]+)(\.html?|\/)?$/i'							=>	'moderate.php?fid=$2&$1=$3&csrf_token=$4',	'/^moderate[\/_-]?([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'												=>	'moderate.php?fid=$1&p=$3',	'/^moderate[\/_-]?([0-9]+)[\/_-]([0-9]+)(\.html?|\/)?$/i'																=>	'moderate.php?fid=$1&tid=$2',	'/^moderate[\/_-]?([0-9]+)[\/_-]([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'									=>	'moderate.php?fid=$1&tid=$2&p=$4',	'/^get_host[\/_-]?([0-9]+|[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})(\.html?|\/)?$/i'								=>	'moderate.php?get_host=$1',	'/^feed[\/_-]?(rss|atom)(\.xml?|\/)?$/i'																				=>	'extern.php?action=feed&type=$1');
<?php// Language definitions used in help.php$lang_help = array('Help'					=>	'Help','Help with'				=>	'Help with %s','produces'				=>	'produces','BBCode info'			=>	'Administrators have the ability to enable or disable BBCode. If BBCode is enabled a link to BBCode help will appear when you compose/edit a post or your signature. BBCode is a collection of formatting tags that are used to change the look of text in this forum. BBCode is based on the same principal as, and is very similar to, HTML. Below is a list of all the available BBCodes and instructions on how to use them.','Image info'			=>	'Administrators have the ability to enable or disable the display of images in posts and/or signatures. If image display is enabled a link to Image help will appear when you compose/edit a post or your signature. Images are inserted using the BBCode [img] tag. The text appearing after the "=" sign in the opening tag is used for the alt attribute and should be included whenever possible.','Text style'			=>	'Text appearance can be changed with the following tags which can be nested.','Bold text'				=>	'Bold text','Underlined text'		=>	'Underlined text','Italic text'			=>	'Italic text','Red text'				=>	'Red text','Blue text'				=>	'Blue text','Heading text'			=>	'Heading text','Links info'			=>	'You can create links to other documents or to email addresses using the following tags:','My e-mail address'		=>	'My email address','Quotes info'			=>	'To quote someone use the quote tag. You can use the quote tag without specifying a name.','Quote text'			=>	'This is the text I want to quote.','produces named'		=>	'produces a quote box citing the person being quoted.','produces unnamed'		=>	'produces a bare quote box.','Code info'				=>	'When displaying source code you should make sure that you use the code tag. Text displayed with the code tag will use a monospaced font and will not be affected by other tags. Long items of code will cause the text to scroll.','Code text'				=>	'This is some code.','Code text long'		=>	'This is a long piece of code. This is a long piece of code. This is a long piece of code. This is a long piece of code. This is a long piece of code.','produces code box'		=>	'produces a code box.','produces scroll box'	=>	'produces a scrolling code box.','List info'				=>	'To create a list you can use the list tag. You can create 3 types of lists using the list tag.','List text 1'			=>	'Example list item 1.','List text 2'			=>	'Example list item 2.','List text 3'			=>	'Example list item 3.','produces list'			=>	'produces a bulleted list.','produces decimal list'	=>	'produces a numbered list.','produces alpha list'	=>	'produces an alphabetically labelled list.','Bold, underlined text'	=>	'Bold, underlined text','Smilies info'			=>	'If you like (and if it is enabled), the forum can convert a selection of smilies to image representations of those smilies. This forum recognizes the smilies listed below and replaces them with images.');
<?php/*** @version $Id: ucwords.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to ucwords* Uppercase the first character of each word in a string* Note: requires utf8_substr_replace and utf8_strtoupper* @param string* @return string with first char of each word uppercase* @see http://www.php.net/ucwords* @package utf8* @subpackage strings*/function utf8_ucwords($str) {    // Note: [\x0c\x09\x0b\x0a\x0d\x20] matches;    // form feeds, horizontal tabs, vertical tabs, linefeeds and carriage returns    // This corresponds to the definition of a "word" defined at http://www.php.net/ucwords    $pattern = '/(^|([\x0c\x09\x0b\x0a\x0d\x20]+))([^\x0c\x09\x0b\x0a\x0d\x20]{1})[^\x0c\x09\x0b\x0a\x0d\x20]*/u';    return preg_replace_callback($pattern, 'utf8_ucwords_callback',$str);}//---------------------------------------------------------------/*** Callback function for preg_replace_callback call in utf8_ucwords* You don't need to call this yourself* @param array of matches corresponding to a single word* @return string with first char of the word in uppercase* @see utf8_ucwords* @see utf8_strtoupper* @package utf8* @subpackage strings*/function utf8_ucwords_callback($matches) {    $leadingws = $matches[2];    $ucfirst = utf8_strtoupper($matches[3]);    $ucword = utf8_substr_replace(ltrim($matches[0]),$ucfirst,0,1);    return $leadingws . $ucword;}
<?php/** * Ban management page. * * Allows administrators and moderators to create, modify, and delete bans. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('aba_start')) ? eval($hook) : null;if ($forum_user['g_id'] != FORUM_ADMIN && ($forum_user['g_moderator'] != '1' || $forum_user['g_mod_ban_users'] == '0'))	message($lang_common['No permission']);// Load the admin.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_bans.php';// Add/edit a ban (stage 1)if (isset($_REQUEST['add_ban']) || isset($_GET['edit_ban'])){	if (isset($_GET['add_ban']) || isset($_POST['add_ban']))	{		// If the id of the user to ban was provided through GET (a link from profile.php)		if (isset($_GET['add_ban']))		{			$add_ban = intval($_GET['add_ban']);			if ($add_ban < 2)				message($lang_common['Bad request']);			$user_id = $add_ban;			($hook = get_hook('aba_add_ban_selected')) ? eval($hook) : null;			$query = array(				'SELECT'	=> 'u.group_id, u.username, u.email, u.registration_ip',				'FROM'		=> 'users AS u',				'WHERE'		=> 'u.id='.$user_id			);			($hook = get_hook('aba_add_ban_qr_get_user_by_id')) ? eval($hook) : null;			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);			$banned_user_info = $forum_db->fetch_row($result);			if (!$banned_user_info)			{				message($lang_admin_bans['No user id message']);			}			list($group_id, $ban_user, $ban_email, $ban_ip) = $banned_user_info;		}		else	// Otherwise the username is in POST		{			$ban_user = forum_trim($_POST['new_ban_user']);			($hook = get_hook('aba_add_ban_form_submitted')) ? eval($hook) : null;			if ($ban_user != '')			{				$query = array(					'SELECT'	=> 'u.id, u.group_id, u.username, u.email, u.registration_ip',					'FROM'		=> 'users AS u',					'WHERE'		=> 'u.username=\''.$forum_db->escape($ban_user).'\' AND u.id>1'				);				($hook = get_hook('aba_add_ban_qr_get_user_by_username')) ? eval($hook) : null;				$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);				$banned_user_info = $forum_db->fetch_row($result);				if (!$banned_user_info)				{					message($lang_admin_bans['No user username message']);				}				list($user_id, $group_id, $ban_user, $ban_email, $ban_ip) = $banned_user_info;			}		}		// Make sure we're not banning an admin		if (isset($group_id) && $group_id == FORUM_ADMIN)			message($lang_admin_bans['User is admin message']);		// If we have a $user_id, we can try to find the last known IP of that user		if (isset($user_id))		{			$query = array(				'SELECT'	=> 'p.poster_ip',				'FROM'		=> 'posts AS p',				'WHERE'		=> 'p.poster_id='.$user_id,				'ORDER BY'	=> 'p.posted DESC',				'LIMIT'		=> '1'			);			($hook = get_hook('aba_add_ban_qr_get_last_known_ip')) ? eval($hook) : null;			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);			$ban_ip_from_db = $forum_db->result($result);			if ($ban_ip_from_db)			{				$ban_ip = $ban_ip_from_db;			}		}		$mode = 'add';	}	else	// We are editing a ban	{		$ban_id = intval($_GET['edit_ban']);		if ($ban_id < 1)			message($lang_common['Bad request']);		($hook = get_hook('aba_edit_ban_selected')) ? eval($hook) : null;		$query = array(			'SELECT'	=> 'b.username, b.ip, b.email, b.message, b.expire',			'FROM'		=> 'bans AS b',			'WHERE'		=> 'b.id='.$ban_id		);		($hook = get_hook('aba_edit_ban_qr_get_ban_data')) ? eval($hook) : null;		$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);		$banned_user_info = $forum_db->fetch_row($result);		if (!$banned_user_info)		{			message($lang_common['Bad request']);		}		list($ban_user, $ban_ip, $ban_email, $ban_message, $ban_expire) = $banned_user_info;		// We just use GMT for expire dates, as its a date rather than a day I don't think its worth worrying about		$ban_expire = ($ban_expire != '') ? gmdate('Y-m-d', $ban_expire) : '';		$mode = 'edit';	}	// Setup the form	$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;	// Setup breadcrumbs	$forum_page['crumbs'] = array(		array($forum_config['o_board_title'], forum_link($forum_url['index'])),		array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index']))	);	if ($forum_user['g_id'] == FORUM_ADMIN)		$forum_page['crumbs'][] = array($lang_admin_common['Users'], forum_link($forum_url['admin_users']));	$forum_page['crumbs'][] = array($lang_admin_common['Bans'], forum_link($forum_url['admin_bans']));	$forum_page['crumbs'][] = $lang_admin_bans['Ban advanced'];	($hook = get_hook('aba_add_edit_ban_pre_header_load')) ? eval($hook) : null;	define('FORUM_PAGE_SECTION', 'users');	define('FORUM_PAGE', 'admin-bans');	require FORUM_ROOT.'header.php';	// START SUBST - <!-- forum_main -->	ob_start();	($hook = get_hook('aba_add_edit_ban_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_bans['Ban advanced heading'] ?></span></h2>	</div>	<div class="main-content main-frm">		<div class="ct-box warn-box">			<p class="warn"><?php echo $lang_admin_bans['Ban IP warning'] ?></p>		</div>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_bans']) ?>">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_bans'])) ?>" />				<input type="hidden" name="mode" value="<?php echo $mode ?>" /><?php if ($mode == 'edit'): ?>				<input type="hidden" name="ban_id" value="<?php echo $ban_id ?>" /><?php endif; ?>			</div><?php ($hook = get_hook('aba_add_edit_ban_pre_criteria_fieldset')) ? eval($hook) : null; ?>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_bans['Ban criteria legend'] ?></span></legend><?php ($hook = get_hook('aba_add_edit_ban_pre_username')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Username to ban label'] ?></span></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_user" size="40" maxlength="25" value="<?php if (isset($ban_user)) echo forum_htmlencode($ban_user); ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_email')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['E-mail/domain to ban label'] ?></span> <small><?php echo $lang_admin_bans['E-mail/domain help'] ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_email" size="40" maxlength="80" value="<?php if (isset($ban_email)) echo forum_htmlencode(strtolower($ban_email)); ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_ip')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['IP-addresses to ban label'] ?></span> <small><?php echo $lang_admin_bans['IP-addresses help']; if ($ban_user != '' && isset($user_id)) echo ' '.$lang_admin_bans['IP-addresses help stats'].'<a href="'.forum_link($forum_url['admin_users']).'?ip_stats='.$user_id.'">'.$lang_admin_bans['IP-addresses help link'].'</a>' ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_ip" size="40" maxlength="255" value="<?php if (isset($ban_ip)) echo $ban_ip; ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_message')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Ban message label'] ?></span> <small><?php echo $lang_admin_bans['Ban message help'] ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_message" size="40" maxlength="255" value="<?php if (isset($ban_message)) echo forum_htmlencode($ban_message); ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_expire')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Expire date label'] ?></span> <small><?php echo $lang_admin_bans['Expire date help'] ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_expire" size="20" maxlength="10" value="<?php if (isset($ban_expire)) echo $ban_expire; ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_criteria_pre_fieldset_end')) ? eval($hook) : null; ?>			</fieldset><?php ($hook = get_hook('aba_add_edit_ban_criteria_fieldset_end')) ? eval($hook) : null; ?>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="add_edit_ban" value=" <?php echo $lang_admin_bans['Save ban'] ?>" /></span>			</div>		</form>	</div><?php	($hook = get_hook('aba_add_edit_ban_end')) ? eval($hook) : null;	$tpl_temp = forum_trim(ob_get_contents());	$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);	ob_end_clean();	// END SUBST - <!-- forum_main -->	require FORUM_ROOT.'footer.php';}// Add/edit a ban (stage 2)else if (isset($_POST['add_edit_ban'])){	$ban_user = forum_trim($_POST['ban_user']);	$ban_ip = forum_trim($_POST['ban_ip']);	$ban_email = strtolower(forum_trim($_POST['ban_email']));	$ban_message = forum_trim($_POST['ban_message']);	$ban_expire = forum_trim($_POST['ban_expire']);	if ($ban_user == '' && $ban_ip == '' && $ban_email == '')		message($lang_admin_bans['Must enter message']);	else if (strtolower($ban_user) == 'guest')		message($lang_admin_bans['Can\'t ban guest user']);	($hook = get_hook('aba_add_edit_ban_form_submitted')) ? eval($hook) : null;	// Validate IP/IP range (it's overkill, I know)	if ($ban_ip != '')	{		$ban_ip = preg_replace('/[\s]{2,}/', ' ', $ban_ip);		$addresses = explode(' ', $ban_ip);		$addresses = array_map('trim', $addresses);		for ($i = 0; $i < count($addresses); ++$i)		{			if (strpos($addresses[$i], ':') !== false)			{				$octets = explode(':', $addresses[$i]);				for ($c = 0; $c < count($octets); ++$c)				{					$octets[$c] = ltrim($octets[$c], "0");					if ($c > 7 || (!empty($octets[$c]) && !ctype_xdigit($octets[$c])) || intval($octets[$c], 16) > 65535)						message($lang_admin_bans['Invalid IP message']);				}				$cur_address = implode(':', $octets);				$addresses[$i] = $cur_address;			}			else			{				$octets = explode('.', $addresses[$i]);				for ($c = 0; $c < count($octets); ++$c)				{					$octets[$c] = (strlen($octets[$c]) > 1) ? ltrim($octets[$c], "0") : $octets[$c];					if ($c > 3 || !ctype_digit($octets[$c]) || intval($octets[$c]) > 255)						message($lang_admin_bans['Invalid IP message']);				}				$cur_address = implode('.', $octets);				$addresses[$i] = $cur_address;			}		}		$ban_ip = implode(' ', $addresses);	}	if (!defined('FORUM_EMAIL_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/email.php';	if ($ban_email != '' && !is_valid_email($ban_email))	{		if (!preg_match('/^[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/', $ban_email))			message($lang_admin_bans['Invalid e-mail message']);	}	if ($ban_expire != '' && $ban_expire != 'Never')	{		$ban_expire = strtotime($ban_expire);		if ($ban_expire == -1 || $ban_expire <= time())			message($lang_admin_bans['Invalid expire message']);	}	else		$ban_expire = 'NULL';	$ban_user = ($ban_user != '') ? '\''.$forum_db->escape($ban_user).'\'' : 'NULL';	$ban_ip = ($ban_ip != '') ? '\''.$forum_db->escape($ban_ip).'\'' : 'NULL';	$ban_email = ($ban_email != '') ? '\''.$forum_db->escape($ban_email).'\'' : 'NULL';	$ban_message = ($ban_message != '') ? '\''.$forum_db->escape($ban_message).'\'' : 'NULL';	if ($_POST['mode'] == 'add')	{		$query = array(			'INSERT'	=> 'username, ip, email, message, expire, ban_creator',			'INTO'		=> 'bans',			'VALUES'	=> $ban_user.', '.$ban_ip.', '.$ban_email.', '.$ban_message.', '.$ban_expire.', '.$forum_user['id']		);		($hook = get_hook('aba_add_edit_ban_qr_add_ban')) ? eval($hook) : null;		$forum_db->query_build($query) or error(__FILE__, __LINE__);	}	else	{		$query = array(			'UPDATE'	=> 'bans',			'SET'		=> 'username='.$ban_user.', ip='.$ban_ip.', email='.$ban_email.', message='.$ban_message.', expire='.$ban_expire,			'WHERE'		=> 'id='.intval($_POST['ban_id'])		);		($hook = get_hook('aba_qr_update_ban')) ? eval($hook) : null;		$forum_db->query_build($query) or error(__FILE__, __LINE__);	}	// Regenerate the bans cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_bans_cache();	($hook = get_hook('aba_add_edit_ban_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_bans']), (($_POST['mode'] == 'edit') ? $lang_admin_bans['Ban edited'] : $lang_admin_bans['Ban added']));}// Remove a banelse if (isset($_GET['del_ban'])){	$ban_id = intval($_GET['del_ban']);	if ($ban_id < 1)		message($lang_common['Bad request']);	// Validate the CSRF token	if (!isset($_POST['csrf_token']) && (!isset($_GET['csrf_token']) || $_GET['csrf_token'] !== generate_form_token('del_ban'.$ban_id)))		csrf_confirm_form();	($hook = get_hook('aba_del_ban_form_submitted')) ? eval($hook) : null;	$query = array(		'DELETE'	=> 'bans',		'WHERE'		=> 'id='.$ban_id	);	($hook = get_hook('aba_del_ban_qr_delete_ban')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the bans cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_bans_cache();	($hook = get_hook('aba_del_ban_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_bans']), $lang_admin_bans['Ban removed'].' '. $lang_admin_common['Redirect']);}// Setup the form$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;$forum_page['form_action'] = forum_link($forum_url['admin_bans']).'&amp;action=more';$forum_page['hidden_fields'] = array(	'csrf_token'	=> '<input type="hidden" name="csrf_token" value="'.generate_form_token($forum_page['form_action']).'" />');// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])));if ($forum_user['g_id'] == FORUM_ADMIN)	$forum_page['crumbs'][] = array($lang_admin_common['Users'], forum_link($forum_url['admin_users']));$forum_page['crumbs'][] = array($lang_admin_common['Bans'], forum_link($forum_url['admin_bans']));// Fetch user count$query = array(	'SELECT'	=>	'COUNT(id)',	'FROM'		=>	'bans');$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$forum_page['num_bans'] = $forum_db->result($result);$forum_page['num_pages'] = ceil($forum_page['num_bans'] / $forum_user['disp_topics']);$forum_page['page'] = (!isset($_GET['p']) || !is_numeric($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $forum_page['num_pages']) ? 1 : intval($_GET['p']);$forum_page['start_from'] = $forum_user['disp_topics'] * ($forum_page['page'] - 1);$forum_page['finish_at'] = min(($forum_page['start_from'] + $forum_user['disp_topics']), ($forum_page['num_bans']));// Generate paging$forum_page['page_post']['paging']='<p class="paging"><span class="pages">'.$lang_common['Pages'].'</span> '.paginate($forum_page['num_pages'], $forum_page['page'], $forum_url['admin_bans'], $lang_common['Paging separator'], null, true).'</p>';// Navigation links for header and page numbering for title/meta descriptionif ($forum_page['page'] < $forum_page['num_pages']){	$forum_page['nav']['last'] = '<link rel="last" href="'.forum_sublink($forum_url['admin_bans'], $forum_url['page'], $forum_page['num_pages']).'" title="'.$lang_common['Page'].' '.$forum_page['num_pages'].'" />';	$forum_page['nav']['next'] = '<link rel="next" href="'.forum_sublink($forum_url['admin_bans'], $forum_url['page'], ($forum_page['page'] + 1)).'" title="'.$lang_common['Page'].' '.($forum_page['page'] + 1).'" />';}if ($forum_page['page'] > 1){	$forum_page['nav']['prev'] = '<link rel="prev" href="'.forum_sublink($forum_url['admin_bans'], $forum_url['page'], ($forum_page['page'] - 1)).'" title="'.$lang_common['Page'].' '.($forum_page['page'] - 1).'" />';	$forum_page['nav']['first'] = '<link rel="first" href="'.forum_link($forum_url['admin_bans']).'" title="'.$lang_common['Page'].' 1" />';}($hook = get_hook('aba_pre_header_load')) ? eval($hook) : null;define('FORUM_PAGE_SECTION', 'users');define('FORUM_PAGE', 'admin-bans');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('aba_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_bans['New ban heading'] ?></span></h2>	</div>	<div class="main-content main-frm">		<div class="ct-box">			<p><?php echo $lang_admin_bans['Advanced ban info'] ?></p>		</div>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo $forum_page['form_action'] ?>">			<div class="hidden">				<?php echo implode("\n\t\t\t\t", $forum_page['hidden_fields'])."\n" ?>			</div>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><strong><?php echo $lang_admin_bans['New ban legend'] ?></strong></legend>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Username to ban label'] ?></span></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="new_ban_user" size="25" maxlength="25" /></span>					</div>				</div>			</fieldset>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="add_ban" value=" <?php echo $lang_admin_bans['Add ban'] ?> " /></span>			</div>		</form>	</div><?php// Reset counters$forum_page['group_count'] = $forum_page['item_count'] = 0;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_bans['Existing bans heading'] ?></span></h2>	</div>	<div class="main-content main-frm"><?phpif ($forum_page['num_bans'] > 0){?>		<div class="ct-group"><?php	// Grab the bans	$query = array(		'SELECT'	=> 'b.*, u.username AS ban_creator_username',		'FROM'		=> 'bans AS b',		'JOINS'		=> array(			array(				'LEFT JOIN'		=> 'users AS u',				'ON'			=> 'u.id=b.ban_creator'			)		),		'ORDER BY'	=> 'b.id',		'LIMIT'		=> $forum_page['start_from'].', '.$forum_page['finish_at']	);	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$forum_page['item_num'] = 0;	while ($cur_ban = $forum_db->fetch_assoc($result))	{		$forum_page['ban_info'] = array();		$forum_page['ban_creator'] = ($cur_ban['ban_creator_username'] != '') ? '<a href="'.forum_link($forum_url['user'], $cur_ban['ban_creator']).'">'.forum_htmlencode($cur_ban['ban_creator_username']).'</a>' : $lang_admin_common['Unknown'];		if ($cur_ban['username'] != '')			$forum_page['ban_info']['username'] = '<li><span>'.$lang_admin_bans['Username'].'</span> <strong>'.forum_htmlencode($cur_ban['username']).'</strong></li>';		if ($cur_ban['email'] != '')			$forum_page['ban_info']['email'] = '<li><span>'.$lang_admin_bans['E-mail'].'</span> <strong>'.forum_htmlencode($cur_ban['email']).'</strong></li>';		if ($cur_ban['ip'] != '')			$forum_page['ban_info']['ip'] = '<li><span>'.$lang_admin_bans['IP-ranges'].'</span> <strong>'.$cur_ban['ip'].'</strong></li>';		if ($cur_ban['expire'] != '')			$forum_page['ban_info']['expire'] = '<li><span>'.$lang_admin_bans['Expires'].'</span> <strong>'.format_time($cur_ban['expire'], 1).'</strong></li>';		if ($cur_ban['message'] != '')			$forum_page['ban_info']['message'] ='<li><span>'.$lang_admin_bans['Message'].'</span> <strong>'.forum_htmlencode($cur_ban['message']).'</strong></li>';		($hook = get_hook('aba_view_ban_pre_display')) ? eval($hook) : null;?>			<div class="ct-set set<?php echo ++$forum_page['item_num'] ?>">				<div class="ct-box">					<div class="ct-legend">						<h3 class=""><span><?php printf($lang_admin_bans['Current ban head'], $forum_page['ban_creator']) ?></span></h3>						<p><?php printf($lang_admin_bans['Edit or remove'], '<a href="'.forum_link($forum_url['admin_bans']).'&amp;edit_ban='.$cur_ban['id'].'">'.$lang_admin_bans['Edit ban'].'</a>', '<a href="'.forum_link($forum_url['admin_bans']).'&amp;del_ban='.$cur_ban['id'].'&amp;csrf_token='.generate_form_token('del_ban'.$cur_ban['id']).'">'.$lang_admin_bans['Remove ban'].'</a>') ?></p>					</div><?php if (!empty($forum_page['ban_info'])): ?>				<ul>					<?php echo implode("\n", $forum_page['ban_info'])."\n" ?>					</ul><?php endif; ?>				</div>			</div><?php	}?>		</div><?php}else{?>		<div class="ct-box">			<p><?php echo $lang_admin_bans['No bans'] ?></p>		</div><?php}?>	</div><?php($hook = get_hook('aba_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->require FORUM_ROOT.'footer.php';
<?php// Language definitions for frequently used strings$lang_common = array(// Text orientation and encoding'lang_direction'			=>	'ltr',	// ltr (Left-To-Right) or rtl (Right-To-Left)'lang_identifier'			=>	'en',// Number formatting'lang_decimal_point'		=>	'.','lang_thousands_sep'		=>	',',// Notices'Bad request'				=>	'Bad request. The link you followed is incorrect or outdated.','No view'					=>	'You do not have permission to view these forums.','No permission'				=>	'You do not have permission to access this page.','CSRF token mismatch'		=>	'Unable to confirm security token. A likely cause for this is that some time passed between when you first entered the page and when you submitted a form or clicked a link. If that is the case and you would like to continue with your action, please click the Confirm button. Otherwise, you should click the Cancel button to return to where you were.','No cookie'					=>	'You appear to have logged in successfully, however a cookie has not been set. Please check your settings and if applicable, enable cookies for this website.',// Miscellaneous'Forum index'				=>	'Forum index','Submit'					=>	'Submit',	// "name" of submit buttons'Cancel'					=>	'Cancel', // "name" of cancel buttons'Preview'					=>	'Preview',	// submit button to preview message'Delete'					=>	'Delete','Split'						=>	'Split','Ban message'				=>	'You are banned from this forum.','Ban message 2'				=>	'The ban expires at the end of %s.','Ban message 3'				=>	'The administrator or moderator that banned you left the following message:','Ban message 4'				=>	'Please direct any inquiries to the forum administrator at %s.','Never'						=>	'Never','Today'						=>	'Today','Yesterday'					=>	'Yesterday','Forum message'				=>	'Forum message','Maintenance warning'		=>	'<strong>WARNING! %s Enabled.</strong> DO NOT LOGOUT as you will be unable to login again.','Maintenance mode'			=>	'Maintenance Mode','Redirecting'				=>	' Redirecting', // With space!'Forwarding info'			=>	'You should automatically be forwarded to a new page in %s %s.','second'					=>	'second',	// singular'seconds'					=>	'seconds',	// plural'Click redirect'			=>	'Click here if you do not want to wait any longer (or if your browser does not automatically forward you)','Invalid e-mail'			=>	'The email address you entered is invalid.','New posts'					=>	'New posts',	// the link that leads to the first new post'New posts title'			=>	'Find topics containing posts made since your last visit.',	// the popup text for new posts links'Active topics'				=>	'Active topics','Active topics title'		=>	'Find topics which contain recent posts.','Unanswered topics'			=>	'Unanswered topics','Unanswered topics title'	=>	'Find topics which have not been replied to.','Username'					=>	'Username','Registered'				=>	'Registered','Write message'				=>	'Write message','Forum'						=>	'Forum','Posts'						=>	'Posts','Pages'						=>	'Pages','Page'						=>	'Page','BBCode'					=>	'BBCode',	// You probably shouldn't change this'Smilies'					=>	'Smilies','Images'					=>	'Images','You may use'				=>	'You may use: %s','and'						=>	'and','Image link'				=>	'image',	// This is displayed (i.e. <image>) instead of images when "Show images" is disabled in the profile'wrote'						=>	'wrote',	// For [quote]'s (e.g., User wrote:)'Code'						=>	'Code',		// For [code]'s'Forum mailer'				=>	'%s Mailer',	// As in "MyForums Mailer" in the signature of outgoing e-mails'Write message legend'		=>	'Compose your post','Required information'		=>	'Required information','Reqmark'					=>	'*','Required'					=>	'(Required)','Required warn'				=>	'All fields labelled %s must be completed before the form is submitted.','Crumb separator'			=>	' &rarr;&#160;', // The character or text that separates links in breadcrumbs'Title separator'			=>	'  ','Page separator'			=>	'&#160;', //The character or text that separates page numbers'Spacer'					=>	'', // Ellipsis for paginate'Paging separator'			=>	' ', //The character or text that separates page numbers for page navigation generally'Previous'					=>	'Previous','Next'						=>	'Next','Cancel redirect'			=>	'Operation cancelled.','No confirm redirect'		=>	'No confirmation provided. Operation cancelled.','Please confirm'			=>	'Please confirm:','Help page'					=>	'Help with: %s','Re'						=>	'Re:','Page info'					=>	'(Page %1$s of %2$s)','Item info single'			=>	'%s: %s','Item info plural'			=>	'%s: %s to %s of %s', // e.g. Topics [ 10 to 20 of 30 ]'Info separator'			=>	' ', // e.g. 1 Page | 10 Topics'Powered by'				=>	'Powered by %s, supported by %s.','Maintenance'				=>	'Maintenance','Installed extension'		=>	'The %s official extension is installed. Copyright &copy; 2003&ndash;2011 <a href="http://punbb.informer.com/">PunBB</a>.','Installed extensions'		=>	'Currently installed <span id="extensions-used" title="%s">%s official extensions</span>. Copyright &copy; 2003&ndash;2011 <a href="http://punbb.informer.com/">PunBB</a>.',// CSRF confirmation form'Confirm'					=>	'Confirm',	// Button'Confirm action'			=>	'Confirm action','Confirm action head'		=>	'Please confirm or cancel your last action',// Title'Title'						=>	'Title','Member'					=>	'Member',	// Default title'Moderator'					=>	'Moderator','Administrator'				=>	'Administrator','Banned'					=>	'Banned','Guest'						=>	'Guest',// Stuff for include/parser.php'BBCode error 1'			=>	'[/%1$s] was found without a matching [%1$s]','BBCode error 2'			=>	'[%s] tag is empty','BBCode error 3'			=>	'[%1$s] was opened within [%2$s], this is not allowed','BBCode error 4'			=>	'[%s] was opened within itself, this is not allowed','BBCode error 5'			=>	'[%1$s] was found without a matching [/%1$s]','BBCode error 6'			=>	'[%s] tag had an empty attribute section','BBCode nested list'		=>	'[list] tags cannot be nested','BBCode code problem'		=>	'There is a problem with your [code] tags',// Stuff for the navigator (top of every page)'Index'						=>	'Index','User list'					=>	'User list','Rules'						=>  'Rules','Search'					=>  'Search','Register'					=>  'Register','register'					=>	'register','Login'						=>  'Login','login'						=>	'login','Not logged in'				=>  'You are not logged in.','Profile'					=>	'Profile','Logout'					=>	'Logout','Logged in as'				=>	'Logged in as %s.','Admin'						=>	'Administration','Last visit'				=>	'Last visit %s','Mark all as read'			=>	'Mark all topics as read','Login nag'					=>	'Please login or register.','New reports'				=>	'New reports',// Alerts'New alerts'				=>	'New Alerts','Maintenance alert'			=>	'<strong>WARNING! Maintenance mode enabled.</strong> This board is currently in maintenance mode. <em>DO NOT</em> logout, if you do you will not be able to login again.','Updates'					=>	'PunBB updates:','Updates failed'			=>	'The latest attempt at checking for updates against the punbb.informer.com updates service failed. This probably just means that the service is temporarily overloaded or out of order. However, if this alert does not disappear within a day or two, you should disable the automatic check for updates and check for updates manually in the future.','Updates version n hf'		=>	'A newer version of PunBB, version %s, is available for download at <a href="http://punbb.informer.com/">punbb.informer.com</a>. Furthermore, one or more hotfixes are available for install on the <a href="%s">Manage hotfixes</a> tab of the admin interface.','Updates version'			=>	'A newer version of PunBB, version %s, is available for download at <a href="http://punbb.informer.com/">punbb.informer.com</a>.','Updates hf'				=>	'One or more hotfixes are available for install on the <a href="%s">Manage hotfixes</a> tab of the admin interface.','Database mismatch'			=>	'Database version mismatch','Database mismatch alert'	=>	'Your PunBB database is meant to be used in conjunction with a newer version of the PunBB code. This mismatch can lead to your forum not working properly. It is suggested that you upgrade your forum to the newest version of PunBB.',// Stuff for Jump Menu'Go'						=>	'Go',		// submit button in forum jump'Jump to'					=>	'Jump to forum:',// For extern.php RSS feed'RSS description'			=>	'The most recent topics at %s.','RSS description topic'		=>	'The most recent posts in %s.','RSS reply'					=>	'Re: ',	// The topic subject will be appended to this string (to signify a reply)// Accessibility'Skip to content'			=>	'Skip to forum content',// Debug information'Querytime'					=>	'Generated in %1$s seconds, %2$s queries executed','Debug table'				=>	'Debug information','Debug summary'				=>	'Database query performance information','Query times'				=>	'Time (s)','Query'						=>	'Query','Total query time'			=>	'Total query time',);
<?php// The contents of this file are very much inspired by the file i18n-ascii.txt// from the CMS software Textpattern (http://textpattern.com/). // Replacements done by sef_friendly function$lang_url_replace = array('' => 'A','' => 'A','' => 'A','' => 'A','' => 'Ae','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'C','' => 'C','' => 'C','' => 'C','' => 'C','' => 'D','' => 'D','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'G','' => 'G','' => 'G','' => 'G','' => 'H','' => 'H','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'IJ','' => 'J','' => 'K','' => 'K','' => 'K','' => 'K','' => 'K','' => 'L','' => 'N','' => 'N','' => 'N','' => 'N','' => 'N','' => 'O','' => 'O','' => 'O','' => 'O','' => 'Oe','' => 'O','' => 'O','' => 'O','' => 'O','' => 'OE','' => 'R','' => 'R','' => 'R','' => 'S','' => 'S','' => 'S','' => 'S','' => 'S','' => 'T','' => 'T','' => 'T','' => 'T','' => 'U','' => 'U','' => 'U','' => 'Ue','' => 'U','' => 'U','' => 'U','' => 'U','' => 'U','' => 'U','' => 'W','' => 'Y','' => 'Y','' => 'Y','' => 'Z','' => 'Z','' => 'Z','' => 'a','' => 'a','' => 'a','' => 'a','' => 'ae','' => 'a','' => 'a','' => 'a','' => 'a','' => 'ae','' => 'c','' => 'c','' => 'c','' => 'c','' => 'c','' => 'd','' => 'd','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'f','' => 'g','' => 'g','' => 'g','' => 'g','' => 'h','' => 'h','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'ij','' => 'j','' => 'k','' => 'k','' => 'l','' => 'l','' => 'l','' => 'l','' => 'l','' => 'n','' => 'n','' => 'n','' => 'n','' => 'n','' => 'n','' => 'o','' => 'o','' => 'o','' => 'o','' => 'oe','' => 'o','' => 'o','' => 'o','' => 'o','' => 'oe','' => 'r','' => 'r','' => 'r','' => 's','' => 's','' => 't','' => 'u','' => 'u','' => 'u','' => 'ue','' => 'u','' => 'u','' => 'u','' => 'u','' => 'u','' => 'u','' => 'w','' => 'y','' => 'y','' => 'y','' => 'z','' => 'z','' => 'z','' => 'ss','' => 'ss','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'A','' => 'B','' => 'G','' => 'D','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'E','' => 'Z','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'TH','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'I','' => 'K','' => 'L','' => 'M','' => 'N','' => 'KS','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'P','' => 'R','' => 'R','' => 'S','' => 'T','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'Y','' => 'F','' => 'X','' => 'PS','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'O','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'a','' => 'b','' => 'g','' => 'd','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'e','' => 'z','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'th','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'i','' => 'k','' => 'l','' => 'm','' => 'n','' => 'ks','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'p','' => 'r','' => 'r','' => 'r','' => 's','' => 's','' => 't','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'y','' => 'f','' => 'x','' => 'ps','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => 'o','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => '','' => 'A','' => 'B','' => 'V','' => 'G','' => 'D','' => 'E','' => 'E','' => 'ZH','' => 'Z','' => 'I','' => 'I','' => 'K','' => 'L','' => 'M','' => 'N','' => 'O','' => 'P','' => 'R','' => 'S','' => 'T','' => 'U','' => 'F','' => 'KH','' => 'TS','' => 'CH','' => 'SH','' => 'SHCH','' => 'Y','' => 'E','' => 'YU','' => 'YA','' => 'A','' => 'B','' => 'V','' => 'G','' => 'D','' => 'E','' => 'E','' => 'ZH','' => 'Z','' => 'I','' => 'I','' => 'K','' => 'L','' => 'M','' => 'N','' => 'O','' => 'P','' => 'R','' => 'S','' => 'T','' => 'U','' => 'F','' => 'KH','' => 'TS','' => 'CH','' => 'SH','' => 'SHCH','' => 'Y','' => 'E','' => 'YU','' => 'YA','' => '','' => '','' => '','' => '','' => 'YE','' => 'YE','' => 'YI','' => 'YI','' => 'KG','' => 'KG','' => 'd','' => 'D','' => 'th','' => 'TH',);
<?php/** * A database layer class that relies on the MySQL PHP extension. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure we have built in support for MySQLif (!function_exists('mysql_connect'))	exit('This PHP environment doesn\'t have MySQL support built in. MySQL support is required if you want to use a MySQL database to run this forum. Consult the PHP documentation for further assistance.');class DBLayer{	var $prefix;	var $link_id;	var $query_result;	var $saved_queries = array();	var $num_queries = 0;	var $datatype_transformations = array(		'/^SERIAL$/'	=>	'INT(10) UNSIGNED AUTO_INCREMENT'	);	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)	{		$this->prefix = $db_prefix;		if ($p_connect)			$this->link_id = @mysql_pconnect($db_host, $db_username, $db_password);		else			$this->link_id = @mysql_connect($db_host, $db_username, $db_password);		if ($this->link_id)		{			if (!@mysql_select_db($db_name, $this->link_id))				error('Unable to select database. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		}		else			error('Unable to connect to MySQL server. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		// Setup the client-server character set (UTF-8)		if (!defined('FORUM_NO_SET_NAMES'))			$this->set_names('utf8');		return $this->link_id;	}	function start_transaction()	{		return;	}	function end_transaction()	{		return;	}	function query($sql, $unbuffered = false)	{		if (strlen($sql) > 140000)			exit('Insane query. Aborting.');		if (defined('FORUM_SHOW_QUERIES'))			$q_start = forum_microtime();		if ($unbuffered)			$this->query_result = @mysql_unbuffered_query($sql, $this->link_id);		else			$this->query_result = @mysql_query($sql, $this->link_id);		if ($this->query_result)		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, sprintf('%.5f', forum_microtime() - $q_start));			++$this->num_queries;			return $this->query_result;		}		else		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, 0);			return false;		}	}	function query_build($query, $return_query_string = false, $unbuffered = false)	{		$sql = '';		if (isset($query['SELECT']))		{			$sql = 'SELECT '.$query['SELECT'].' FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['FROM'];			if (isset($query['JOINS']))			{				foreach ($query['JOINS'] as $cur_join)					$sql .= ' '.key($cur_join).' '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).current($cur_join).' ON '.$cur_join['ON'];			}			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];			if (!empty($query['GROUP BY']))				$sql .= ' GROUP BY '.$query['GROUP BY'];			if (!empty($query['HAVING']))				$sql .= ' HAVING '.$query['HAVING'];			if (!empty($query['ORDER BY']))				$sql .= ' ORDER BY '.$query['ORDER BY'];			if (!empty($query['LIMIT']))				$sql .= ' LIMIT '.$query['LIMIT'];		}		else if (isset($query['INSERT']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['INSERT']))				$sql .= ' ('.$query['INSERT'].')';			if (is_array($query['VALUES']))				$sql .= ' VALUES('.implode('),(', $query['VALUES']).')';			else				$sql .= ' VALUES('.$query['VALUES'].')';		}		else if (isset($query['UPDATE']))		{			$query['UPDATE'] = (isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['UPDATE'];			$sql = 'UPDATE '.$query['UPDATE'].' SET '.$query['SET'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['DELETE']))		{			$sql = 'DELETE FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['DELETE'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['REPLACE']))		{			$sql = 'REPLACE INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['REPLACE']))				$sql .= ' ('.$query['REPLACE'].')';			$sql .= ' VALUES('.$query['VALUES'].')';		}		return ($return_query_string) ? $sql : $this->query($sql, $unbuffered);	}	function result($query_id = 0, $row = 0, $col = 0)	{		return ($query_id) ? @mysql_result($query_id, $row, $col) : false;	}	function fetch_assoc($query_id = 0)	{		return ($query_id) ? @mysql_fetch_assoc($query_id) : false;	}	function fetch_row($query_id = 0)	{		return ($query_id) ? @mysql_fetch_row($query_id) : false;	}	function num_rows($query_id = 0)	{		return ($query_id) ? @mysql_num_rows($query_id) : false;	}	function affected_rows()	{		return ($this->link_id) ? @mysql_affected_rows($this->link_id) : false;	}	function insert_id()	{		return ($this->link_id) ? @mysql_insert_id($this->link_id) : false;	}	function get_num_queries()	{		return $this->num_queries;	}	function get_saved_queries()	{		return $this->saved_queries;	}	function free_result($query_id = false)	{		return ($query_id) ? @mysql_free_result($query_id) : false;	}	function escape($str)	{		if (is_array($str))			return '';		else if (function_exists('mysql_real_escape_string'))			return mysql_real_escape_string($str, $this->link_id);		else			return mysql_escape_string($str);	}	function error()	{		$result['error_sql'] = @current(@end($this->saved_queries));		$result['error_no'] = @mysql_errno($this->link_id);		$result['error_msg'] = @mysql_error($this->link_id);		return $result;	}	function close()	{		if ($this->link_id)		{			if ($this->query_result)				@mysql_free_result($this->query_result);			return @mysql_close($this->link_id);		}		else			return false;	}	function set_names($names)	{		return $this->query('SET NAMES \''.$this->escape($names).'\'');	}	function get_version()	{		$result = $this->query('SELECT VERSION()');		return array(			'name'		=> 'MySQL Standard',			'version'	=> preg_replace('/^([^-]+).*$/', '\\1', $this->result($result))		);	}	function table_exists($table_name, $no_prefix = false)	{		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');		return $this->num_rows($result) > 0;	}	function field_exists($table_name, $field_name, $no_prefix = false)	{		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');		return $this->num_rows($result) > 0;	}	function index_exists($table_name, $index_name, $no_prefix = false)	{		$exists = false;		$result = $this->query('SHOW INDEX FROM '.($no_prefix ? '' : $this->prefix).$table_name);		while ($cur_index = $this->fetch_assoc($result))		{			if ($cur_index['Key_name'] == ($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name)			{				$exists = true;				break;			}		}		return $exists;	}	function create_table($table_name, $schema, $no_prefix = false)	{		if ($this->table_exists($table_name, $no_prefix))			return;		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";		// Go through every schema element and add it to the query		foreach ($schema['FIELDS'] as $field_name => $field_data)		{			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);			$query .= $field_name.' '.$field_data['datatype'];			if (isset($field_data['collation']))				$query .= 'CHARACTER SET utf8 COLLATE utf8_'.$field_data['collation'];			if (!$field_data['allow_null'])				$query .= ' NOT NULL';			if (isset($field_data['default']))				$query .= ' DEFAULT '.$field_data['default'];			$query .= ",\n";		}		// If we have a primary key, add it		if (isset($schema['PRIMARY KEY']))			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";		// Add unique keys		if (isset($schema['UNIQUE KEYS']))		{			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)				$query .= 'UNIQUE KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$key_name.'('.implode(',', $key_fields).'),'."\n";		}		// Add indexes		if (isset($schema['INDEXES']))		{			foreach ($schema['INDEXES'] as $index_name => $index_fields)				$query .= 'KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.'('.implode(',', $index_fields).'),'."\n";		}		// We remove the last two characters (a newline and a comma) and add on the ending		$query = substr($query, 0, strlen($query) - 2)."\n".') ENGINE = '.(isset($schema['ENGINE']) ? $schema['ENGINE'] : 'MyISAM').' CHARACTER SET utf8';		$this->query($query) or error(__FILE__, __LINE__);	}	function drop_table($table_name, $no_prefix = false)	{		if (!$this->table_exists($table_name, $no_prefix))			return;		$this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) or error(__FILE__, __LINE__);	}	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if ($this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' MODIFY '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function drop_field($table_name, $field_name, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) or error(__FILE__, __LINE__);	}	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)	{		if ($this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ('.implode(',', $index_fields).')') or error(__FILE__, __LINE__);	}	function drop_index($table_name, $index_name, $no_prefix = false)	{		if (!$this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) or error(__FILE__, __LINE__);	}}
<?php/*** @version $Id: substr_replace.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware substr_replace.* Note: requires utf8_substr to be loaded* @see http://www.php.net/substr_replace* @see utf8_strlen* @see utf8_substr*/function utf8_substr_replace($str, $repl, $start , $length = NULL ) {    preg_match_all('/./us', $str, $ar);    preg_match_all('/./us', $repl, $rar);    if( $length === NULL ) {        $length = utf8_strlen($str);    }    array_splice( $ar[0], $start, $length, $rar[0] );    return join('',$ar[0]);}
<?php/*** PCRE Regular expressions for UTF-8. Note this file is not actually used by* the rest of the library but these regular expressions can be useful to have* available.* @version $Id: patterns.php,v 1.1 2006/02/25 14:20:02 harryf Exp $* @see http://www.w3.org/International/questions/qa-forms-utf-8* @package utf8* @subpackage patterns*///--------------------------------------------------------------------/*** PCRE Pattern to check a UTF-8 string is valid* Comes from W3 FAQ: Multilingual Forms* Note: modified to include full ASCII range including control chars* @see http://www.w3.org/International/questions/qa-forms-utf-8* @package utf8* @subpackage patterns*/$UTF8_VALID = '^('.    '[\x00-\x7F]'.                          # ASCII (including control chars)    '|[\xC2-\xDF][\x80-\xBF]'.              # non-overlong 2-byte    '|\xE0[\xA0-\xBF][\x80-\xBF]'.          # excluding overlongs    '|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}'.   # straight 3-byte    '|\xED[\x80-\x9F][\x80-\xBF]'.          # excluding surrogates    '|\xF0[\x90-\xBF][\x80-\xBF]{2}'.       # planes 1-3    '|[\xF1-\xF3][\x80-\xBF]{3}'.           # planes 4-15    '|\xF4[\x80-\x8F][\x80-\xBF]{2}'.       # plane 16    ')*$';//--------------------------------------------------------------------/*** PCRE Pattern to match single UTF-8 characters* Comes from W3 FAQ: Multilingual Forms* Note: modified to include full ASCII range including control chars* @see http://www.w3.org/International/questions/qa-forms-utf-8* @package utf8* @subpackage patterns*/$UTF8_MATCH =    '([\x00-\x7F])'.                          # ASCII (including control chars)    '|([\xC2-\xDF][\x80-\xBF])'.              # non-overlong 2-byte    '|(\xE0[\xA0-\xBF][\x80-\xBF])'.          # excluding overlongs    '|([\xE1-\xEC\xEE\xEF][\x80-\xBF]{2})'.   # straight 3-byte    '|(\xED[\x80-\x9F][\x80-\xBF])'.          # excluding surrogates    '|(\xF0[\x90-\xBF][\x80-\xBF]{2})'.       # planes 1-3    '|([\xF1-\xF3][\x80-\xBF]{3})'.           # planes 4-15    '|(\xF4[\x80-\x8F][\x80-\xBF]{2})';       # plane 16//--------------------------------------------------------------------/*** PCRE Pattern to locate bad bytes in a UTF-8 string* Comes from W3 FAQ: Multilingual Forms* Note: modified to include full ASCII range including control chars* @see http://www.w3.org/International/questions/qa-forms-utf-8* @package utf8* @subpackage patterns*/$UTF8_BAD =    '([\x00-\x7F]'.                          # ASCII (including control chars)    '|[\xC2-\xDF][\x80-\xBF]'.               # non-overlong 2-byte    '|\xE0[\xA0-\xBF][\x80-\xBF]'.           # excluding overlongs    '|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}'.    # straight 3-byte    '|\xED[\x80-\x9F][\x80-\xBF]'.           # excluding surrogates    '|\xF0[\x90-\xBF][\x80-\xBF]{2}'.        # planes 1-3    '|[\xF1-\xF3][\x80-\xBF]{3}'.            # planes 4-15    '|\xF4[\x80-\x8F][\x80-\xBF]{2}'.        # plane 16    '|(.{1}))';                              # invalid byte
<?php// Language definitions used in all admin files$lang_admin_ranks = array('Rank head'						=>	'Add, edit or remove ranks','Rank'							=>	'Rank','Rank added'					=>	'Rank added.','Title message'					=>	'You must enter a rank title.','Min posts message'				=>	'Minimum posts must be a positive integer value.','Min posts occupied message'	=>	'There is already a rank with a minimum posts value of %s.','Rank updated'					=>	'Rank updated.','Rank removed'					=>	'Rank removed.','Add rank intro'				=>	'Enter a rank and the minimum number of posts that a user has to have to acquire the rank. Different ranks cannot have the same value for minimum posts. If a title is set for a user, the title will be displayed instead of any rank. For this to have any effect "<strong>User ranks</strong>" must be enabled in %s.','Add rank'						=>	'Add rank','Add rank legend'				=>	'New rank details','Rank title label'				=>	'Rank title','Min posts label'				=>	'Minimum posts','Existing ranks legend'			=>	'Edit or remove existing user ranks','No ranks'						=>	'No ranks in list.','Update'						=>	'Update','Remove'						=>	'Remove','New rank'						=>	'Add new rank','Existing rank'					=>	'Existing rank',);
<?php/** * Loads the reserved strings used to transform problematic strings in URLs. * These are matched against the whole string after all other transformations. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */$forum_reserved_strings = array(	''				=>	'view',	'newpost'		=>	'view',	'newposts'		=>	'view',	'new-post'		=>	'view',	'new-posts'		=>	'view',	'lastpost'		=>	'view',	'lastposts'		=>	'view',	'last-post'		=>	'view',	'last-posts'	=>	'view',);
<?php/** * Topic pruning page. * * Allows administrators to delete older topics from the site. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('apr_start')) ? eval($hook) : null;if ($forum_user['g_id'] != FORUM_ADMIN)	message($lang_common['No permission']);// Load the admin.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_prune.php';if (isset($_GET['action']) || isset($_POST['prune']) || isset($_POST['prune_comply'])){	if (isset($_POST['prune_comply']))	{		$prune_from = $_POST['prune_from'];		$prune_days = intval($_POST['prune_days']);		$prune_date = ($prune_days) ? time() - ($prune_days*86400) : -1;		($hook = get_hook('apr_prune_comply_form_submitted')) ? eval($hook) : null;		@set_time_limit(0);		if ($prune_from == 'all')		{			$query = array(				'SELECT'	=> 'f.id',				'FROM'		=> 'forums AS f'			);			($hook = get_hook('apr_prune_comply_qr_get_all_forums')) ? eval($hook) : null;			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);			while ($cur_forum_id = $forum_db->fetch_row($result)) {				prune($cur_forum_id[0], $_POST['prune_sticky'], $prune_date);				sync_forum($cur_forum_id[0]);			}		}		else		{			$prune_from = intval($prune_from);			prune($prune_from, $_POST['prune_sticky'], $prune_date);			sync_forum($prune_from);		}		delete_orphans();		$forum_flash->add_info($lang_admin_prune['Prune done']);		($hook = get_hook('apr_prune_pre_redirect')) ? eval($hook) : null;		redirect(forum_link($forum_url['admin_prune']), $lang_admin_prune['Prune done']);	}	$prune_days = intval($_POST['req_prune_days']);	if ($prune_days < 0)		message($lang_admin_prune['Days to prune message']);	$prune_date = time() - ($prune_days * 86400);	$prune_from = $_POST['prune_from'];	if ($prune_from != 'all')	{		$prune_from = intval($prune_from);		// Fetch the forum name (just for cosmetic reasons)		$query = array(			'SELECT'	=> 'f.forum_name',			'FROM'		=> 'forums AS f',			'WHERE'		=> 'f.id='.$prune_from		);		($hook = get_hook('apr_prune_comply_qr_get_forum_name')) ? eval($hook) : null;		$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);		$forum = forum_htmlencode($forum_db->result($result));	}	else		$forum = 'all forums';	// Count the number of topics to prune	$query = array(		'SELECT'	=> 'COUNT(t.id)',		'FROM'		=> 'topics AS t',		'WHERE'		=> 't.last_post<'.$prune_date.' AND t.moved_to IS NULL'	);	if ($prune_from != 'all')		$query['WHERE'] .= ' AND t.forum_id='.$prune_from;	if (!isset($_POST['prune_sticky']))		$query['WHERE'] .= ' AND t.sticky=0';	($hook = get_hook('apr_prune_comply_qr_get_topic_count')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$num_topics = $forum_db->result($result);	if (!$num_topics)		message($lang_admin_prune['No days old message']);	// Setup breadcrumbs	$forum_page['crumbs'] = array(		array($forum_config['o_board_title'], forum_link($forum_url['index'])),		array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),		array($lang_admin_common['Management'], forum_link($forum_url['admin_reports'])),		array($lang_admin_prune['Prune topics'], forum_link($forum_url['admin_prune'])),		$lang_admin_prune['Confirm prune heading']	);	($hook = get_hook('apr_prune_comply_pre_header_load')) ? eval($hook) : null;	define('FORUM_PAGE_SECTION', 'management');	define('FORUM_PAGE', 'admin-prune');	require FORUM_ROOT.'header.php';	// START SUBST - <!-- forum_main -->	ob_start();	($hook = get_hook('apr_prune_comply_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php printf($lang_admin_prune['Prune details head'], ($forum == 'all forums') ? $lang_admin_prune['All forums'] : $forum ) ?></span></h2>	</div>	<div class="main-content main-frm">		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_prune']) ?>?action=foo">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_prune']).'?action=foo') ?>" />				<input type="hidden" name="prune_days" value="<?php echo $prune_days ?>" />				<input type="hidden" name="prune_sticky" value="<?php echo intval($_POST['prune_sticky']) ?>" />				<input type="hidden" name="prune_from" value="<?php echo $prune_from ?>" />			</div>			<div class="ct-box">				<p class="warn"><span><?php printf($lang_admin_prune['Prune topics info 1'], $num_topics, isset($_POST['prune_sticky']) ? ' ('.$lang_admin_prune['Include sticky'].')' : '') ?></span></p>				<p class="warn"><span><?php printf($lang_admin_prune['Prune topics info 2'], $prune_days) ?></span></p>			</div><?php ($hook = get_hook('apr_prune_comply_pre_buttons')) ? eval($hook) : null; ?>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="prune_comply" value="<?php echo $lang_admin_prune['Prune topics'] ?>" /></span>			</div>		</form>	</div><?php	($hook = get_hook('apr_prune_comply_end')) ? eval($hook) : null;	$tpl_temp = forum_trim(ob_get_contents());	$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);	ob_end_clean();	// END SUBST - <!-- forum_main -->	require FORUM_ROOT.'footer.php';}else{	// Setup form	$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;	// Setup breadcrumbs	$forum_page['crumbs'] = array(		array($forum_config['o_board_title'], forum_link($forum_url['index'])),		array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),		array($lang_admin_common['Management'], forum_link($forum_url['admin_reports'])),		array($lang_admin_common['Prune topics'], forum_link($forum_url['admin_prune']))	);	($hook = get_hook('apr_pre_header_load')) ? eval($hook) : null;	define('FORUM_PAGE_SECTION', 'management');	define('FORUM_PAGE', 'admin-prune');	require FORUM_ROOT.'header.php';	// START SUBST - <!-- forum_main -->	ob_start();	($hook = get_hook('apr_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_prune['Prune settings head'] ?></span></h2>	</div>	<div class="main-content main-frm">		<div class="ct-box">			<p><?php echo $lang_admin_prune['Prune intro'] ?></p>			<p class="important"><?php echo $lang_admin_prune['Prune caution'] ?></p>		</div>		<div id="req-msg" class="req-warn ct-box error-box">			<p class="important"><?php printf($lang_admin_common['Required warn'], '<em>'.$lang_admin_common['Required'].'</em>') ?></p>		</div>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_prune']) ?>?action=foo">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_prune']).'?action=foo') ?>" />				<input type="hidden" name="form_sent" value="1" />			</div><?php ($hook = get_hook('apr_pre_prune_fieldset')) ? eval($hook) : null; ?>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_prune['Prune legend'] ?></span></legend><?php ($hook = get_hook('apr_pre_prune_from')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box select">					<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_prune['Prune from'] ?></span></label><br />						<span class="fld-input"><select id="fld<?php echo $forum_page['fld_count'] ?>" name="prune_from">							<option value="all"><?php echo $lang_admin_prune['All forums'] ?></option><?php	$query = array(		'SELECT'	=> 'c.id AS cid, c.cat_name, f.id AS fid, f.forum_name',		'FROM'		=> 'categories AS c',		'JOINS'		=> array(			array(				'INNER JOIN'	=> 'forums AS f',				'ON'			=> 'c.id=f.cat_id'			)		),		'WHERE'		=> 'f.redirect_url IS NULL',		'ORDER BY'	=> 'c.disp_position, c.id, f.disp_position'	);	($hook = get_hook('apr_qr_get_forum_list')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$cur_category = 0;	while ($forum = $forum_db->fetch_assoc($result))	{		if ($forum['cid'] != $cur_category)	// Are we still in the same category?		{			if ($cur_category)				echo "\t\t\t\t\t\t\t\t".'</optgroup>'."\n";			echo "\t\t\t\t\t\t\t\t".'<optgroup label="'.forum_htmlencode($forum['cat_name']).'">'."\n";			$cur_category = $forum['cid'];		}		echo "\t\t\t\t\t\t\t\t\t".'<option value="'.$forum['fid'].'">'.forum_htmlencode($forum['forum_name']).'</option>'."\n";	}?>						</optgroup>						</select></span>					</div>				</div><?php ($hook = get_hook('apr_pre_prune_days')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text required">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_prune['Days old'] ?></span></label><br />						<span class="fld-input"><input type="number" id="fld<?php echo $forum_page['fld_count'] ?>" name="req_prune_days" size="4" maxlength="4" required /></span>					</div>				</div><?php ($hook = get_hook('apr_pre_prune_sticky')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box checkbox">						<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="prune_sticky" value="1" checked="checked" /></span>						<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_admin_prune['Prune sticky'] ?></span> <?php echo $lang_admin_prune['Prune sticky enable'] ?></label>					</div>				</div><?php ($hook = get_hook('apr_pre_prune_fieldset_end')) ? eval($hook) : null; ?>			</fieldset><?php ($hook = get_hook('apr_prune_fieldset_end')) ? eval($hook) : null; ?>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="prune" value="<?php echo $lang_admin_prune['Prune topics'] ?>" /></span>			</div>		</form>	</div><?php	($hook = get_hook('apr_end')) ? eval($hook) : null;	$tpl_temp = forum_trim(ob_get_contents());	$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);	ob_end_clean();	// END SUBST - <!-- forum_main -->	require FORUM_ROOT.'footer.php';}
<?php/** * Administration panel index page. * * Gives an overview of some statistics to administrators and moderators. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('ain_start')) ? eval($hook) : null;if (!$forum_user['is_admmod'])	message($lang_common['No permission']);// Load the admin.php language filesrequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_index.php';// Show phpinfo() outputif (isset($_GET['action']) && $_GET['action'] == 'phpinfo' && $forum_user['g_id'] == FORUM_ADMIN){	($hook = get_hook('ain_phpinfo_selected')) ? eval($hook) : null;	// Is phpinfo() a disabled function?	if (strpos(strtolower((string)@ini_get('disable_functions')), 'phpinfo') !== false)		message($lang_admin_index['phpinfo disabled']);	phpinfo();	exit;}// Generate check for updates text blockif ($forum_user['g_id'] == FORUM_ADMIN){	if ($forum_config['o_check_for_updates'] == '1')		$punbb_updates = $lang_admin_index['Check for updates enabled'];	else	{		// Get a list of installed hotfix extensions		$query = array(			'SELECT'	=> 'e.id',			'FROM'		=> 'extensions AS e',			'WHERE'		=> 'e.id LIKE \'hotfix_%\''		);		($hook = get_hook('ain_update_check_qr_get_hotfixes')) ? eval($hook) : null;		$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);		$hotfixes = array();		while ($row = $forum_db->fetch_row($result))		{			$hotfixes[] = urlencode($row[0]);		}		$punbb_updates = '<a href="http://punbb.informer.com/update/?version='.urlencode($forum_config['o_cur_version']).'&amp;hotfixes='.implode(',', $hotfixes).'">'.$lang_admin_index['Check for updates manual'].'</a>';	}}// Get the server load averages (if possible)if (function_exists('sys_getloadavg') && is_array(sys_getloadavg())){	$load_averages = sys_getloadavg();	array_walk($load_averages, create_function('&$v', '$v = round($v, 3);'));	$server_load = $load_averages[0].' '.$load_averages[1].' '.$load_averages[2];}else if (@is_readable('/proc/loadavg')){	// We use @ just in case	$fh = @fopen('/proc/loadavg', 'r');	$load_averages = @fread($fh, 64);	@fclose($fh);	$load_averages = empty($load_averages) ? array() : explode(' ', $load_averages);	$server_load = isset($load_averages[2]) ? $load_averages[0].' '.$load_averages[1].' '.$load_averages[2] : 'Not available';}else if (!in_array(PHP_OS, array('WINNT', 'WIN32')) && preg_match('/averages?: ([0-9\.]+),[\s]+([0-9\.]+),[\s]+([0-9\.]+)/i', @exec('uptime'), $load_averages))	$server_load = $load_averages[1].' '.$load_averages[2].' '.$load_averages[3];else	$server_load = $lang_admin_index['Not available'];// Get number of current visitors$query = array(	'SELECT'	=> 'COUNT(o.user_id)',	'FROM'		=> 'online AS o',	'WHERE'		=> 'o.idle=0');($hook = get_hook('ain_qr_get_users_online')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$num_online = $forum_db->result($result);// Get the database system version$db_version = $forum_db->get_version();// Collect some additional info about MySQLif (in_array($db_type, array('mysql', 'mysqli', 'mysql_innodb', 'mysqli_innodb'))){	$db_version = 'MySQL '.$db_version;	// Calculate total db size/row count	$result = $forum_db->query('SHOW TABLE STATUS FROM `'.$db_name.'` LIKE \''.$db_prefix.'%\'') or error(__FILE__, __LINE__);	$total_records = $total_size = 0;	while ($status = $forum_db->fetch_assoc($result))	{		$total_records += $status['Rows'];		$total_size += $status['Data_length'] + $status['Index_length'];	}	$total_size = $total_size / 1024;	if ($total_size > 1024)		$total_size = forum_number_format($total_size / 1024, 2).' MB';	else		$total_size = forum_number_format($total_size, 2).' KB';}// Check for the existance of various PHP opcode caches/optimizersif (function_exists('mmcache'))	$php_accelerator = '<a href="http://turck-mmcache.sourceforge.net/">Turck MMCache</a>';else if (isset($_PHPA))	$php_accelerator = '<a href="http://www.php-accelerator.co.uk/">ionCube PHP Accelerator</a>';else if (ini_get('apc.enabled'))	$php_accelerator ='<a href="http://www.php.net/apc/">Alternative PHP Cache (APC)</a>';else if (ini_get('zend_optimizer.optimization_level'))	$php_accelerator = '<a href="http://www.zend.com/products/zend_optimizer/">Zend Optimizer</a>';else if (ini_get('eaccelerator.enable'))	$php_accelerator = '<a href="http://eaccelerator.net/">eAccelerator</a>';else if (ini_get('xcache.cacher'))	$php_accelerator = '<a href="http://xcache.lighttpd.net/">XCache</a>';else	$php_accelerator = $lang_admin_index['Not applicable'];// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])));if ($forum_user['g_id'] == FORUM_ADMIN)	$forum_page['crumbs'][] = array($lang_admin_common['Start'], forum_link($forum_url['admin_index']));$forum_page['crumbs'][] = array($lang_admin_common['Information'], forum_link($forum_url['admin_index']));($hook = get_hook('ain_pre_header_load')) ? eval($hook) : null;define('FORUM_PAGE_SECTION', 'start');define('FORUM_PAGE', 'admin-information');require FORUM_ROOT.'header.php';$forum_page['item_count'] = 0;// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('ain_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_index['Information head'] ?></span></h2>	</div>	<div class="main-content main-frm"><?php if (!empty($alert_items)): ?>		<div id="admin-alerts" class="ct-set warn-set">			<div class="ct-box warn-box">				<h3 class="ct-legend hn warn"><span><?php echo $lang_admin_index['Alerts'] ?></span></h3>				<?php echo implode(' ', $alert_items)."\n" ?>			</div>		</div><?php endif; ?>		<div class="ct-group"><?php ($hook = get_hook('ain_pre_version')) ? eval($hook) : null; ?>			<div class="ct-set group-item<?php echo ++$forum_page['item_count'] ?>">				<div class="ct-box">					<h3 class="ct-legend hn"><span><?php echo $lang_admin_index['PunBB version'] ?></span></h3>					<ul class="data-list">						<li><span>PunBB <?php echo $forum_config['o_cur_version'] ?></span></li>						<li><span><?php echo $lang_admin_index['Copyright message'] ?></span></li><?php if (isset($punbb_updates)): ?>						<li><span><?php echo $punbb_updates ?></span></li><?php endif; ?>					</ul>				</div>			</div><?php ($hook = get_hook('ain_pre_community')) ? eval($hook) : null; ?>			<div class="ct-set group-item<?php echo ++$forum_page['item_count'] ?>">				<div class="ct-box">					<h3 class="ct-legend hn"><span><?php echo $lang_admin_index['PunBB community'] ?></span></h3>					<ul class="data-list">						<li><span><?php echo $lang_admin_index['Forums'] ?>: <a href="http://punbb.informer.com/forums/">Forums</a></span></li>						<li><span><?php echo $lang_admin_index['Twitter'] ?>: <a href="https://twitter.com/punbb_forum">@punbb_forum</a></span></li>						<li><span><?php echo $lang_admin_index['Development'] ?>: <a href="https://github.com/punbb/punbb">https://github.com/punbb</a></span></li>					</ul>				</div>			</div><?php ($hook = get_hook('ain_pre_server_load')) ? eval($hook) : null; ?>			<div class="ct-set group-item<?php echo ++$forum_page['item_count'] ?>">				<div class="ct-box">					<h3 class="ct-legend hn"><span><?php echo $lang_admin_index['Server load'] ?></span></h3>					<p><span><?php echo $server_load ?> (<?php echo $num_online.' '.$lang_admin_index['users online']?>)</span></p>				</div>			</div><?php ($hook = get_hook('ain_pre_environment')) ? eval($hook) : null; if ($forum_user['g_id'] == FORUM_ADMIN): ?>			<div class="ct-set group-item<?php echo ++$forum_page['item_count'] ?>">				<div class="ct-box">					<h3 class="ct-legend hn"><span><?php echo $lang_admin_index['Environment'] ?></span></h3>					<ul class="data-list">						<li><span><?php echo $lang_admin_index['Operating system'] ?>: <?php echo PHP_OS ?></span></li>						<li><span>PHP: <?php echo PHP_VERSION ?> - <a href="<?php echo forum_link($forum_url['admin_index']) ?>?action=phpinfo"><?php echo $lang_admin_index['Show info'] ?></a></span></li>						<li><span><?php echo $lang_admin_index['Accelerator'] ?>: <?php echo $php_accelerator ?></span></li>					</ul>				</div>			</div><?php ($hook = get_hook('ain_pre_database')) ? eval($hook) : null; ?>			<div class="ct-set group-item<?php echo ++$forum_page['item_count'] ?>">				<div class="ct-box">					<h3 class="ct-legend hn"><span><?php echo $lang_admin_index['Database'] ?></span></h3>					<ul class="data-list">						<li><span><?php echo implode(' ', $forum_db->get_version()) ?></span></li><?php if (isset($total_records) && isset($total_size)): ?>						<li><span><?php echo $lang_admin_index['Rows'] ?>: <?php echo forum_number_format($total_records) ?></span></li>						<li><span><?php echo $lang_admin_index['Size'] ?>: <?php echo $total_size ?></span></li><?php endif; ?>					</ul>				</div>			</div><?php endif; ($hook = get_hook('ain_items_end')) ? eval($hook) : null; ?>		</div>	</div><?php($hook = get_hook('ain_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->require FORUM_ROOT.'footer.php';
<?php// Language definitions used in all admin files$lang_admin_users = array(// admin_users'Search head'					=>	'Find users','User search head'				=>	'Enter one or more criteria. Use wildcard character <strong>*</strong> for partial matches.','Searches personal legend'		=>	'Personal details','Username label'				=>	'Username','Title label'					=>	'Title','Real name label'				=>	'Real name','Location label'				=>	'Location','Signature label'				=>	'Signature','Admin note label'				=>	'Admin note','Searches contact legend'		=>	'Contact details','E-mail address label'			=>	'Email address','Website label'					=>	'Website','Searches activity legend'		=>	'User activity','More posts label'				=>	'More posts than','Less posts label'				=>	'Less posts than','Number of posts help'			=>	'(Number of posts)','Last post after label'			=>	'Last post is after','Last post before label'		=>	'Last post is before','Registered after label'		=>	'Registered after','Registered before label'		=>	'Registered before','Date format help'				=>	'[ yyyy-mm-dd hh:mm:ss ]','Jabber label'					=>	'Jabber','ICQ label'						=>	'ICQ','MSN Messenger label'			=>	'MSN Messenger','AOL IM label'					=>	'AOL IM','Yahoo Messenger label'			=>	'Yahoo! Messenger','User results head'				=>	'Sort user search results','User results legend'			=>	'Search results','Order by label'				=>	'Order by','Sort order label'				=>	'Sort order','User group label'				=>	'User group','IP search head'				=>	'Find a specific IP address in the post database','IP search legend'				=>	'Enter IP to search for','IP address label'				=>	'IP address','User information'				=>	'User information','IP address'					=>	'IP address','Username'						=>	'Username','E-mail'						=>	'Email','Admin note'					=>	'Admin note','Invalid IP address'			=>	'The IP address you entered is not correctly formatted.','Users matching criteria'		=>	'Results matching user search criteria','User IP stats'					=>	'IP statistics for user','IP matching criteria'			=>	'Results matching IP address','Users found'					=>	'Users found [ %s ]','IP addresses found'			=>	'IP addresses found [ %s ]','Moderate users'				=>	'Moderate users','Submit search'					=>	'Submit search','Not verified'					=>	'Not verified','Registered'					=>	'Registered','Last post'						=>	'Last post','Ascending'						=>	'Ascending','Descending'					=>	'Descending','All groups'					=>	'All groups','Unverified users'				=>	'Unverified users','Non numeric value message'		=>	'You entered a non-numeric value into a numeric only column.','Invalid date/time message'		=>	'You entered an invalid date/time.','No search terms message'		=>	'You didn\'t enter any search terms.','Delete users'					=>	'Delete users','Delete warning'				=>	'<strong>WARNING!</strong> Deleted users and/or posts cannot be restored. If you choose not to delete the posts made by these users, the posts can only be deleted manually at a later time.','Delete posts legend'			=>	'You may choose to delete posts these users have made','Confirm delete'				=>	'Confirm delete','Delete posts'					=>	'Delete posts','Delete posts label'			=>	'Enable to delete all posts and topics these users have made.','Users deleted'					=>	'Users deleted.','Ban'							=>	'Ban','Ban users'						=>	'Ban users','Change group'					=>	'Change group','Delete admin message'			=>	'Administrators cannot be deleted. In order to delete an administrator, you must first move him/her to a different user group.','Ban admin message'				=>	'One of the selected users is an administrator and can\'t be banned. If you want to ban an administrator, you must first move him/her to any other user group.','Users banned'					=>	'Users banned.','Mass ban info'					=>	'You may set a message to be displayed to the banned users and set the date their bans are to expire.','Ban settings legend'			=> 	'Ban users','Change group head'				=>	'Move the selected users to a new group','User groups updated'			=>	'User groups updated.','Move users legend'				=>	'Move users','No users selected'				=>	'No users selected.','Move users to label'			=>	'Move users to group',// admin_users tables'Username column'				=>	'Username  Email  Admin notes','Title column'					=>	'Title  Status','Posts'							=>	'Posts','Actions'						=>	'Action(s)','View IP stats'					=>	'View IP stats','Show posts'					=>	'Show posts','Last used'						=>	'Last used','Times found'					=>	'Times found','Find more users'				=>	'Find more users for this IP','No posts by user'				=>	'There are currently no posts by that user in the forum.','Guest'							=>	'Guest','Cannot find IP'				=>	'The supplied IP address could not be found in the database.','Not verified'					=>	'Not verified','No match'						=>	'No match','User search results'			=>	'User search results');
<?php/*** @version $Id: core.php,v 1.9 2007/08/12 01:11:33 harryf Exp $* @package utf8* @subpackage strings*//*** Define UTF8_CORE as required*/if ( !defined('UTF8_CORE') ) {    define('UTF8_CORE',TRUE);}//--------------------------------------------------------------------/*** Unicode aware replacement for strlen(). Returns the number* of characters in the string (not the number of bytes), replacing* multibyte characters with a single byte equivalent* utf8_decode() converts characters that are not in ISO-8859-1* to '?', which, for the purpose of counting, is alright - It's* much faster than iconv_strlen* Note: this function does not count bad UTF-8 bytes in the string* - these are simply ignored* @author <chernyshevsky at hotmail dot com>* @link   http://www.php.net/manual/en/function.strlen.php* @link   http://www.php.net/manual/en/function.utf8-decode.php* @param string UTF-8 string* @return int number of UTF-8 characters in string* @package utf8* @subpackage strings*/function utf8_strlen($str){    return strlen(utf8_decode($str));}//--------------------------------------------------------------------/*** UTF-8 aware alternative to strpos* Find position of first occurrence of a string* Note: This will get alot slower if offset is used* Note: requires utf8_strlen and utf8_substr to be loaded* @param string haystack* @param string needle (you should validate this with utf8_is_valid)* @param integer offset in characters (from left)* @return mixed integer position or FALSE on failure* @see http://www.php.net/strpos* @see utf8_strlen* @see utf8_substr* @package utf8* @subpackage strings*/function utf8_strpos($str, $needle, $offset = NULL) {    if ( is_null($offset) ) {        $ar = explode($needle, $str, 2);        if ( count($ar) > 1 ) {            return utf8_strlen($ar[0]);        }        return FALSE;    } else {        if ( !is_int($offset) ) {            trigger_error('utf8_strpos: Offset must be an integer',E_USER_ERROR);            return FALSE;        }        $str = utf8_substr($str, $offset);        if ( FALSE !== ( $pos = utf8_strpos($str, $needle) ) ) {            return $pos + $offset;        }        return FALSE;    }}//--------------------------------------------------------------------/*** UTF-8 aware alternative to strrpos* Find position of last occurrence of a char in a string* Note: This will get alot slower if offset is used* Note: requires utf8_substr and utf8_strlen to be loaded* @param string haystack* @param string needle (you should validate this with utf8_is_valid)* @param integer (optional) offset (from left)* @return mixed integer position or FALSE on failure* @see http://www.php.net/strrpos* @see utf8_substr* @see utf8_strlen* @package utf8* @subpackage strings*/function utf8_strrpos($str, $needle, $offset = NULL) {    if ( is_null($offset) ) {        $ar = explode($needle, $str);        if ( count($ar) > 1 ) {            // Pop off the end of the string where the last match was made            array_pop($ar);            $str = join($needle,$ar);            return utf8_strlen($str);        }        return FALSE;    } else {        if ( !is_int($offset) ) {            trigger_error('utf8_strrpos expects parameter 3 to be long',E_USER_WARNING);            return FALSE;        }        $str = utf8_substr($str, $offset);        if ( FALSE !== ( $pos = utf8_strrpos($str, $needle) ) ) {            return $pos + $offset;        }        return FALSE;    }}//--------------------------------------------------------------------/*** UTF-8 aware alternative to substr* Return part of a string given character offset (and optionally length)** Note arguments: comparied to substr - if offset or length are* not integers, this version will not complain but rather massages them* into an integer.** Note on returned values: substr documentation states false can be* returned in some cases (e.g. offset > string length)* mb_substr never returns false, it will return an empty string instead.* This adopts the mb_substr approach** Note on implementation: PCRE only supports repetitions of less than* 65536, in order to accept up to MAXINT values for offset and length,* we'll repeat a group of 65535 characters when needed.** Note on implementation: calculating the number of characters in the* string is a relatively expensive operation, so we only carry it out when* necessary. It isn't necessary for +ve offsets and no specified length** @author Chris Smith<chris@jalakai.co.uk>* @param string* @param integer number of UTF-8 characters offset (from left)* @param integer (optional) length in UTF-8 characters from offset* @return mixed string or FALSE if failure* @package utf8* @subpackage strings*/function utf8_substr($str, $offset, $length = NULL) {    // generates E_NOTICE    // for PHP4 objects, but not PHP5 objects    $str = (string)$str;    $offset = (int)$offset;    if (!is_null($length)) $length = (int)$length;    // handle trivial cases    if ($length === 0) return '';    if ($offset < 0 && $length < 0 && $length < $offset)        return '';    // normalise negative offsets (we could use a tail    // anchored pattern, but they are horribly slow!)    if ($offset < 0) {        // see notes        $strlen = strlen(utf8_decode($str));        $offset = $strlen + $offset;        if ($offset < 0) $offset = 0;    }    $Op = '';    $Lp = '';    // establish a pattern for offset, a    // non-captured group equal in length to offset    if ($offset > 0) {        $Ox = (int)($offset/65535);        $Oy = $offset%65535;        if ($Ox) {            $Op = '(?:.{65535}){'.$Ox.'}';        }        $Op = '^(?:'.$Op.'.{'.$Oy.'})';    } else {        // offset == 0; just anchor the pattern        $Op = '^';    }    // establish a pattern for length    if (is_null($length)) {        // the rest of the string        $Lp = '(.*)$';    } else {        if (!isset($strlen)) {            // see notes            $strlen = strlen(utf8_decode($str));        }        // another trivial case        if ($offset > $strlen) return '';        if ($length > 0) {            // reduce any length that would            // go passed the end of the string            $length = min($strlen-$offset, $length);            $Lx = (int)( $length / 65535 );            $Ly = $length % 65535;            // negative length requires a captured group            // of length characters            if ($Lx) $Lp = '(?:.{65535}){'.$Lx.'}';            $Lp = '('.$Lp.'.{'.$Ly.'})';        } else if ($length < 0) {            if ( $length < ($offset - $strlen) ) {                return '';            }            $Lx = (int)((-$length)/65535);            $Ly = (-$length)%65535;            // negative length requires ... capture everything            // except a group of  -length characters            // anchored at the tail-end of the string            if ($Lx) $Lp = '(?:.{65535}){'.$Lx.'}';            $Lp = '(.*)(?:'.$Lp.'.{'.$Ly.'})$';        }    }    if (!preg_match( '#'.$Op.$Lp.'#us',$str, $match )) {        return '';    }    return $match[1];}//---------------------------------------------------------------/*** UTF-8 aware alternative to strtolower* Make a string lowercase* Note: The concept of a characters "case" only exists is some alphabets* such as Latin, Greek, Cyrillic, Armenian and archaic Georgian - it does* not exist in the Chinese alphabet, for example. See Unicode Standard* Annex #21: Case Mappings* Note: requires utf8_to_unicode and utf8_from_unicode* @author Andreas Gohr <andi@splitbrain.org>* @param string* @return mixed either string in lowercase or FALSE is UTF-8 invalid* @see http://www.php.net/strtolower* @see utf8_to_unicode* @see utf8_from_unicode* @see http://www.unicode.org/reports/tr21/tr21-5.html* @see http://dev.splitbrain.org/view/darcs/dokuwiki/inc/utf8.php* @package utf8* @subpackage strings*/function utf8_strtolower($string){    static $UTF8_UPPER_TO_LOWER = NULL;    if ( is_null($UTF8_UPPER_TO_LOWER) ) {        $UTF8_UPPER_TO_LOWER = array(    0x0041=>0x0061, 0x03A6=>0x03C6, 0x0162=>0x0163, 0x00C5=>0x00E5, 0x0042=>0x0062,    0x0139=>0x013A, 0x00C1=>0x00E1, 0x0141=>0x0142, 0x038E=>0x03CD, 0x0100=>0x0101,    0x0490=>0x0491, 0x0394=>0x03B4, 0x015A=>0x015B, 0x0044=>0x0064, 0x0393=>0x03B3,    0x00D4=>0x00F4, 0x042A=>0x044A, 0x0419=>0x0439, 0x0112=>0x0113, 0x041C=>0x043C,    0x015E=>0x015F, 0x0143=>0x0144, 0x00CE=>0x00EE, 0x040E=>0x045E, 0x042F=>0x044F,    0x039A=>0x03BA, 0x0154=>0x0155, 0x0049=>0x0069, 0x0053=>0x0073, 0x1E1E=>0x1E1F,    0x0134=>0x0135, 0x0427=>0x0447, 0x03A0=>0x03C0, 0x0418=>0x0438, 0x00D3=>0x00F3,    0x0420=>0x0440, 0x0404=>0x0454, 0x0415=>0x0435, 0x0429=>0x0449, 0x014A=>0x014B,    0x0411=>0x0431, 0x0409=>0x0459, 0x1E02=>0x1E03, 0x00D6=>0x00F6, 0x00D9=>0x00F9,    0x004E=>0x006E, 0x0401=>0x0451, 0x03A4=>0x03C4, 0x0423=>0x0443, 0x015C=>0x015D,    0x0403=>0x0453, 0x03A8=>0x03C8, 0x0158=>0x0159, 0x0047=>0x0067, 0x00C4=>0x00E4,    0x0386=>0x03AC, 0x0389=>0x03AE, 0x0166=>0x0167, 0x039E=>0x03BE, 0x0164=>0x0165,    0x0116=>0x0117, 0x0108=>0x0109, 0x0056=>0x0076, 0x00DE=>0x00FE, 0x0156=>0x0157,    0x00DA=>0x00FA, 0x1E60=>0x1E61, 0x1E82=>0x1E83, 0x00C2=>0x00E2, 0x0118=>0x0119,    0x0145=>0x0146, 0x0050=>0x0070, 0x0150=>0x0151, 0x042E=>0x044E, 0x0128=>0x0129,    0x03A7=>0x03C7, 0x013D=>0x013E, 0x0422=>0x0442, 0x005A=>0x007A, 0x0428=>0x0448,    0x03A1=>0x03C1, 0x1E80=>0x1E81, 0x016C=>0x016D, 0x00D5=>0x00F5, 0x0055=>0x0075,    0x0176=>0x0177, 0x00DC=>0x00FC, 0x1E56=>0x1E57, 0x03A3=>0x03C3, 0x041A=>0x043A,    0x004D=>0x006D, 0x016A=>0x016B, 0x0170=>0x0171, 0x0424=>0x0444, 0x00CC=>0x00EC,    0x0168=>0x0169, 0x039F=>0x03BF, 0x004B=>0x006B, 0x00D2=>0x00F2, 0x00C0=>0x00E0,    0x0414=>0x0434, 0x03A9=>0x03C9, 0x1E6A=>0x1E6B, 0x00C3=>0x00E3, 0x042D=>0x044D,    0x0416=>0x0436, 0x01A0=>0x01A1, 0x010C=>0x010D, 0x011C=>0x011D, 0x00D0=>0x00F0,    0x013B=>0x013C, 0x040F=>0x045F, 0x040A=>0x045A, 0x00C8=>0x00E8, 0x03A5=>0x03C5,    0x0046=>0x0066, 0x00DD=>0x00FD, 0x0043=>0x0063, 0x021A=>0x021B, 0x00CA=>0x00EA,    0x0399=>0x03B9, 0x0179=>0x017A, 0x00CF=>0x00EF, 0x01AF=>0x01B0, 0x0045=>0x0065,    0x039B=>0x03BB, 0x0398=>0x03B8, 0x039C=>0x03BC, 0x040C=>0x045C, 0x041F=>0x043F,    0x042C=>0x044C, 0x00DE=>0x00FE, 0x00D0=>0x00F0, 0x1EF2=>0x1EF3, 0x0048=>0x0068,    0x00CB=>0x00EB, 0x0110=>0x0111, 0x0413=>0x0433, 0x012E=>0x012F, 0x00C6=>0x00E6,    0x0058=>0x0078, 0x0160=>0x0161, 0x016E=>0x016F, 0x0391=>0x03B1, 0x0407=>0x0457,    0x0172=>0x0173, 0x0178=>0x00FF, 0x004F=>0x006F, 0x041B=>0x043B, 0x0395=>0x03B5,    0x0425=>0x0445, 0x0120=>0x0121, 0x017D=>0x017E, 0x017B=>0x017C, 0x0396=>0x03B6,    0x0392=>0x03B2, 0x0388=>0x03AD, 0x1E84=>0x1E85, 0x0174=>0x0175, 0x0051=>0x0071,    0x0417=>0x0437, 0x1E0A=>0x1E0B, 0x0147=>0x0148, 0x0104=>0x0105, 0x0408=>0x0458,    0x014C=>0x014D, 0x00CD=>0x00ED, 0x0059=>0x0079, 0x010A=>0x010B, 0x038F=>0x03CE,    0x0052=>0x0072, 0x0410=>0x0430, 0x0405=>0x0455, 0x0402=>0x0452, 0x0126=>0x0127,    0x0136=>0x0137, 0x012A=>0x012B, 0x038A=>0x03AF, 0x042B=>0x044B, 0x004C=>0x006C,    0x0397=>0x03B7, 0x0124=>0x0125, 0x0218=>0x0219, 0x00DB=>0x00FB, 0x011E=>0x011F,    0x041E=>0x043E, 0x1E40=>0x1E41, 0x039D=>0x03BD, 0x0106=>0x0107, 0x03AB=>0x03CB,    0x0426=>0x0446, 0x00DE=>0x00FE, 0x00C7=>0x00E7, 0x03AA=>0x03CA, 0x0421=>0x0441,    0x0412=>0x0432, 0x010E=>0x010F, 0x00D8=>0x00F8, 0x0057=>0x0077, 0x011A=>0x011B,    0x0054=>0x0074, 0x004A=>0x006A, 0x040B=>0x045B, 0x0406=>0x0456, 0x0102=>0x0103,    0x039B=>0x03BB, 0x00D1=>0x00F1, 0x041D=>0x043D, 0x038C=>0x03CC, 0x00C9=>0x00E9,    0x00D0=>0x00F0, 0x0407=>0x0457, 0x0122=>0x0123,            );    }    $uni = utf8_to_unicode($string);    if ( !$uni ) {        return FALSE;    }    $cnt = count($uni);    for ($i=0; $i < $cnt; $i++){        if ( isset($UTF8_UPPER_TO_LOWER[$uni[$i]]) ) {            $uni[$i] = $UTF8_UPPER_TO_LOWER[$uni[$i]];        }    }    return utf8_from_unicode($uni);}//---------------------------------------------------------------/*** UTF-8 aware alternative to strtoupper* Make a string uppercase* Note: The concept of a characters "case" only exists is some alphabets* such as Latin, Greek, Cyrillic, Armenian and archaic Georgian - it does* not exist in the Chinese alphabet, for example. See Unicode Standard* Annex #21: Case Mappings* Note: requires utf8_to_unicode and utf8_from_unicode* @author Andreas Gohr <andi@splitbrain.org>* @param string* @return mixed either string in lowercase or FALSE is UTF-8 invalid* @see http://www.php.net/strtoupper* @see utf8_to_unicode* @see utf8_from_unicode* @see http://www.unicode.org/reports/tr21/tr21-5.html* @see http://dev.splitbrain.org/view/darcs/dokuwiki/inc/utf8.php* @package utf8* @subpackage strings*/function utf8_strtoupper($string){    static $UTF8_LOWER_TO_UPPER = NULL;    if ( is_null($UTF8_LOWER_TO_UPPER) ) {        $UTF8_LOWER_TO_UPPER = array(    0x0061=>0x0041, 0x03C6=>0x03A6, 0x0163=>0x0162, 0x00E5=>0x00C5, 0x0062=>0x0042,    0x013A=>0x0139, 0x00E1=>0x00C1, 0x0142=>0x0141, 0x03CD=>0x038E, 0x0101=>0x0100,    0x0491=>0x0490, 0x03B4=>0x0394, 0x015B=>0x015A, 0x0064=>0x0044, 0x03B3=>0x0393,    0x00F4=>0x00D4, 0x044A=>0x042A, 0x0439=>0x0419, 0x0113=>0x0112, 0x043C=>0x041C,    0x015F=>0x015E, 0x0144=>0x0143, 0x00EE=>0x00CE, 0x045E=>0x040E, 0x044F=>0x042F,    0x03BA=>0x039A, 0x0155=>0x0154, 0x0069=>0x0049, 0x0073=>0x0053, 0x1E1F=>0x1E1E,    0x0135=>0x0134, 0x0447=>0x0427, 0x03C0=>0x03A0, 0x0438=>0x0418, 0x00F3=>0x00D3,    0x0440=>0x0420, 0x0454=>0x0404, 0x0435=>0x0415, 0x0449=>0x0429, 0x014B=>0x014A,    0x0431=>0x0411, 0x0459=>0x0409, 0x1E03=>0x1E02, 0x00F6=>0x00D6, 0x00F9=>0x00D9,    0x006E=>0x004E, 0x0451=>0x0401, 0x03C4=>0x03A4, 0x0443=>0x0423, 0x015D=>0x015C,    0x0453=>0x0403, 0x03C8=>0x03A8, 0x0159=>0x0158, 0x0067=>0x0047, 0x00E4=>0x00C4,    0x03AC=>0x0386, 0x03AE=>0x0389, 0x0167=>0x0166, 0x03BE=>0x039E, 0x0165=>0x0164,    0x0117=>0x0116, 0x0109=>0x0108, 0x0076=>0x0056, 0x00FE=>0x00DE, 0x0157=>0x0156,    0x00FA=>0x00DA, 0x1E61=>0x1E60, 0x1E83=>0x1E82, 0x00E2=>0x00C2, 0x0119=>0x0118,    0x0146=>0x0145, 0x0070=>0x0050, 0x0151=>0x0150, 0x044E=>0x042E, 0x0129=>0x0128,    0x03C7=>0x03A7, 0x013E=>0x013D, 0x0442=>0x0422, 0x007A=>0x005A, 0x0448=>0x0428,    0x03C1=>0x03A1, 0x1E81=>0x1E80, 0x016D=>0x016C, 0x00F5=>0x00D5, 0x0075=>0x0055,    0x0177=>0x0176, 0x00FC=>0x00DC, 0x1E57=>0x1E56, 0x03C3=>0x03A3, 0x043A=>0x041A,    0x006D=>0x004D, 0x016B=>0x016A, 0x0171=>0x0170, 0x0444=>0x0424, 0x00EC=>0x00CC,    0x0169=>0x0168, 0x03BF=>0x039F, 0x006B=>0x004B, 0x00F2=>0x00D2, 0x00E0=>0x00C0,    0x0434=>0x0414, 0x03C9=>0x03A9, 0x1E6B=>0x1E6A, 0x00E3=>0x00C3, 0x044D=>0x042D,    0x0436=>0x0416, 0x01A1=>0x01A0, 0x010D=>0x010C, 0x011D=>0x011C, 0x00F0=>0x00D0,    0x013C=>0x013B, 0x045F=>0x040F, 0x045A=>0x040A, 0x00E8=>0x00C8, 0x03C5=>0x03A5,    0x0066=>0x0046, 0x00FD=>0x00DD, 0x0063=>0x0043, 0x021B=>0x021A, 0x00EA=>0x00CA,    0x03B9=>0x0399, 0x017A=>0x0179, 0x00EF=>0x00CF, 0x01B0=>0x01AF, 0x0065=>0x0045,    0x03BB=>0x039B, 0x03B8=>0x0398, 0x03BC=>0x039C, 0x045C=>0x040C, 0x043F=>0x041F,    0x044C=>0x042C, 0x00FE=>0x00DE, 0x00F0=>0x00D0, 0x1EF3=>0x1EF2, 0x0068=>0x0048,    0x00EB=>0x00CB, 0x0111=>0x0110, 0x0433=>0x0413, 0x012F=>0x012E, 0x00E6=>0x00C6,    0x0078=>0x0058, 0x0161=>0x0160, 0x016F=>0x016E, 0x03B1=>0x0391, 0x0457=>0x0407,    0x0173=>0x0172, 0x00FF=>0x0178, 0x006F=>0x004F, 0x043B=>0x041B, 0x03B5=>0x0395,    0x0445=>0x0425, 0x0121=>0x0120, 0x017E=>0x017D, 0x017C=>0x017B, 0x03B6=>0x0396,    0x03B2=>0x0392, 0x03AD=>0x0388, 0x1E85=>0x1E84, 0x0175=>0x0174, 0x0071=>0x0051,    0x0437=>0x0417, 0x1E0B=>0x1E0A, 0x0148=>0x0147, 0x0105=>0x0104, 0x0458=>0x0408,    0x014D=>0x014C, 0x00ED=>0x00CD, 0x0079=>0x0059, 0x010B=>0x010A, 0x03CE=>0x038F,    0x0072=>0x0052, 0x0430=>0x0410, 0x0455=>0x0405, 0x0452=>0x0402, 0x0127=>0x0126,    0x0137=>0x0136, 0x012B=>0x012A, 0x03AF=>0x038A, 0x044B=>0x042B, 0x006C=>0x004C,    0x03B7=>0x0397, 0x0125=>0x0124, 0x0219=>0x0218, 0x00FB=>0x00DB, 0x011F=>0x011E,    0x043E=>0x041E, 0x1E41=>0x1E40, 0x03BD=>0x039D, 0x0107=>0x0106, 0x03CB=>0x03AB,    0x0446=>0x0426, 0x00FE=>0x00DE, 0x00E7=>0x00C7, 0x03CA=>0x03AA, 0x0441=>0x0421,    0x0432=>0x0412, 0x010F=>0x010E, 0x00F8=>0x00D8, 0x0077=>0x0057, 0x011B=>0x011A,    0x0074=>0x0054, 0x006A=>0x004A, 0x045B=>0x040B, 0x0456=>0x0406, 0x0103=>0x0102,    0x03BB=>0x039B, 0x00F1=>0x00D1, 0x043D=>0x041D, 0x03CC=>0x038C, 0x00E9=>0x00C9,    0x00F0=>0x00D0, 0x0457=>0x0407, 0x0123=>0x0122,            );    }    $uni = utf8_to_unicode($string);    if ( !$uni ) {        return FALSE;    }    $cnt = count($uni);    for ($i=0; $i < $cnt; $i++){        if( isset($UTF8_LOWER_TO_UPPER[$uni[$i]]) ) {            $uni[$i] = $UTF8_LOWER_TO_UPPER[$uni[$i]];        }    }    return utf8_from_unicode($uni);}
<?php/** * Search index rebuilding script. * * Allows administrators to rebuild the index used to search the posts and topics. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');// Tell common.php that we don't want output bufferingdefine('FORUM_DISABLE_BUFFERING', 1);require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('ari_start')) ? eval($hook) : null;if ($forum_user['g_id'] != FORUM_ADMIN)	message($lang_common['No permission']);// Load the admin.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_reindex.php';if (isset($_GET['i_per_page']) && isset($_GET['i_start_at'])){	$per_page = intval($_GET['i_per_page']);	$start_at = intval($_GET['i_start_at']);	if ($per_page < 1 || $start_at < 1)		message($lang_common['Bad request']);	// We validate the CSRF token. If it's set in POST and we're at this point, the token is valid.	// If it's in GET, we need to make sure it's valid.	if (!isset($_POST['csrf_token']) && (!isset($_GET['csrf_token']) || $_GET['csrf_token'] !== generate_form_token('reindex'.$forum_user['id'])))		csrf_confirm_form();	($hook = get_hook('ari_cycle_start')) ? eval($hook) : null;	@set_time_limit(0);	// If this is the first cycle of posts we empty the search index before we proceed	if (isset($_GET['i_empty_index']))	{		$query = array(			'DELETE'	=> 'search_matches'		);		($hook = get_hook('ari_cycle_qr_empty_search_matches')) ? eval($hook) : null;		$forum_db->query_build($query) or error(__FILE__, __LINE__);		$query = array(			'DELETE'	=> 'search_words'		);		($hook = get_hook('ari_cycle_qr_empty_search_words')) ? eval($hook) : null;		$forum_db->query_build($query) or error(__FILE__, __LINE__);		// Reset the sequence for the search words (not needed for SQLite)		switch ($db_type)		{			case 'mysql':			case 'mysql_innodb':			case 'mysqli':			case 'mysqli_innodb':				$result = $forum_db->query('ALTER TABLE '.$forum_db->prefix.'search_words auto_increment=1') or error(__FILE__, __LINE__);				break;			case 'pgsql';				$result = $forum_db->query('SELECT setval(\''.$forum_db->prefix.'search_words_id_seq\', 1, false)') or error(__FILE__, __LINE__);		}	}	// Setup breadcrumbs	$forum_page['crumbs'] = array(		array($forum_config['o_board_title'], forum_link($forum_url['index'])),		array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),		array($lang_admin_common['Management'], forum_link($forum_url['admin_reports'])),		$lang_admin_reindex['Rebuilding index title']	);?><!DOCTYPE html><html lang="<?php $lang_common['lang_identifier'] ?>" dir="<?php echo $lang_common['lang_direction'] ?>"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title><?php echo generate_crumbs(true) ?></title><style type="text/css">body {	font: 68.75% Verdana, Arial, Helvetica, sans-serif;	color: #333333;	background-color: #FFFFFF}</style></head><body><p><?php echo $lang_admin_reindex['Rebuilding index'] ?></p><?php	if (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/search_idx.php';	// Fetch posts to process	$query = array(		'SELECT'	=> 'p.id, p.message, t.id, t.subject, t.first_post_id',		'FROM'		=> 'posts AS p',		'JOINS'		=> array(			array(				'INNER JOIN'	=> 'topics AS t',				'ON'			=> 't.id=p.topic_id'			)		),		'WHERE'		=> 'p.id>='.$start_at,		'ORDER BY'	=> 'p.id',		'LIMIT'		=> $per_page	);	($hook = get_hook('ari_cycle_qr_fetch_posts')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$post_id = 0;	echo '<p>';	while ($cur_post = $forum_db->fetch_row($result))	{		echo sprintf($lang_admin_reindex['Processing post'], $cur_post[0], $cur_post[2]).'<br />'."\n";		if ($cur_post[0] == $cur_post[4])	// This is the "topic post" so we have to index the subject as well			update_search_index('post', $cur_post[0], $cur_post[1], $cur_post[3]);		else			update_search_index('post', $cur_post[0], $cur_post[1]);		$post_id = $cur_post[0];	}	echo '</p>';	// Check if there is more work to do	$query = array(		'SELECT'	=> 'COUNT(p.id)',		'FROM'		=> 'posts AS p',		'WHERE'		=> 'p.id>'.$post_id,		'ORDER BY'	=> 'p.id',		'LIMIT'		=> '1'	);	($hook = get_hook('ari_cycle_qr_find_next_post')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$num_posts_to_proced = $forum_db->result($result);	$query_str = '';	if ($num_posts_to_proced !== false && $num_posts_to_proced > 0)	{		$query_str = '?i_per_page='.$per_page.'&i_start_at='.$num_posts_to_proced.'&csrf_token='.generate_form_token('reindex'.$forum_user['id']);	}	($hook = get_hook('ari_cycle_end')) ? eval($hook) : null;	$forum_db->end_transaction();	$forum_db->close();	exit('<script type="text/javascript">window.location="'.forum_link($forum_url['admin_reindex']).$query_str.'"</script><br />'.$lang_admin_reindex['Javascript redirect'].' <a href="'.forum_link($forum_url['admin_reindex']).$query_str.'">'.$lang_admin_reindex['Click to continue'].'</a>.');}// Get the first post ID from the db$query = array(	'SELECT'	=> 'p.id',	'FROM'		=> 'posts AS p',	'ORDER BY'	=> 'p.id',	'LIMIT'		=> '1');($hook = get_hook('ari_qr_find_lowest_post_id')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$first_id = $forum_db->result($result);if (is_null($first_id) || $first_id === false){	unset($first_id);}// Setup form$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),	array($lang_admin_common['Management'], forum_link($forum_url['admin_reports'])),	array($lang_admin_common['Rebuild index'], forum_link($forum_url['admin_reindex'])));($hook = get_hook('ari_pre_header_load')) ? eval($hook) : null;define('FORUM_PAGE_SECTION', 'management');define('FORUM_PAGE', 'admin-reindex');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('ari_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_reindex['Reindex heading'] ?></span></h2>	</div>	<div class="main-content main-frm">		<div class="ct-box">			<p><?php echo $lang_admin_reindex['Reindex info'] ?></p>		</div>		<form class="frm-form" method="get" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_reindex']) ?>">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token('reindex'.$forum_user['id']) ?>" />			</div><?php ($hook = get_hook('ari_pre_rebuild_fieldset')) ? eval($hook) : null; ?>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_reindex['Rebuild index legend'] ?></span></legend><?php ($hook = get_hook('ari_pre_rebuild_per_page')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_reindex['Posts per cycle'] ?></span> <small><?php echo $lang_admin_reindex['Posts per cycle info'] ?></small></label><br />						<span class="fld-input"><input type="number" id="fld<?php echo $forum_page['fld_count'] ?>" name="i_per_page" size="7" maxlength="7" value="100" /></span>					</div>				</div><?php ($hook = get_hook('ari_pre_rebuild_start_post')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_reindex['Starting post'] ?></span> <small><?php echo $lang_admin_reindex['Starting post info'] ?></small></label><br />						<span class="fld-input"><input type="number" id="fld<?php echo $forum_page['fld_count'] ?>" name="i_start_at" size="7" maxlength="7" value="<?php echo (isset($first_id)) ? $first_id : 0 ?>" /></span>					</div>				</div><?php ($hook = get_hook('ari_pre_rebuild_empty_index')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box checkbox">						<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="i_empty_index" value="1" checked="checked" /></span>						<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_admin_reindex['Empty index'] ?></span> <?php echo $lang_admin_reindex['Empty index info'] ?></label>					</div>				</div><?php ($hook = get_hook('ari_pre_rebuild_fieldset_end')) ? eval($hook) : null; ?>			</fieldset><?php ($hook = get_hook('ari_rebuild_fieldset_end')) ? eval($hook) : null; ?>			<div class="ct-box warn-box">				<p class="important"><?php echo $lang_admin_reindex['Reindex warning'] ?></p>				<p class="warn"><?php echo $lang_admin_reindex['Empty index warning'] ?></p>			</div>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="rebuild_index" value="<?php echo $lang_admin_reindex['Rebuild index'] ?>" /></span>			</div>		</form>	</div><?php($hook = get_hook('ari_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->require FORUM_ROOT.'footer.php';
<?php/** * Loads the regular expressions used to match SEF URL requests to their proper URLs. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */$forum_rewrite_rules = array(	'/^topic[\/_-]?([0-9]+).*(new|last)[\/_-]?(posts?)(\.html?|\/)?$/i'														=>	'viewtopic.php?id=$1&action=$2',	'/^post[\/_-]?([0-9]+)(\.html?|\/)?$/i'																					=>	'viewtopic.php?pid=$1',	'/^(forum|topic)[\/_-]?([0-9]+).*[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'											=>	'view$1.php?id=$2&p=$4',	'/^feed[\/_-]?(rss|atom)[\/_-]?(f|t)(orum|opic)[\/_-]?([0-9]+)[\/_-]?(\.xml?|\/)?$/i'									=>	'extern.php?action=feed&$2id=$4&type=$1',	'/^(forum|topic)[\/_-]?([0-9]+).*(\.html?|\/)?$/i'																		=>	'view$1.php?id=$2',	'/^new[\/_-]?reply[\/_-]?([0-9]+)(\.html?|\/)?$/i'																		=>	'post.php?tid=$1',	'/^new[\/_-]?reply[\/_-]?([0-9]+)[\/_-]?quote[\/_-]?([0-9]+)(\.html?|\/)?$/i'											=>	'post.php?tid=$1&qid=$2',	'/^new[\/_-]?topic[\/_-]?([0-9]+)(\.html?|\/)?$/i'																		=>	'post.php?fid=$1',	'/^(delete|edit)[\/_-]?([0-9]+)(\.html?|\/)?$/i'																		=>	'$1.php?id=$2',	'/^(login|search|register)(\.html?|\/)?$/i'																				=>	'$1.php',	'/^logout[\/_-]?([0-9]+)[\/_-]([a-z0-9]+)(\.html?|\/)?$/i'																=>	'login.php?action=out&id=$1&csrf_token=$2',	'/^request[\/_-]?password(\.html?|\/)?$/i'																				=>	'login.php?action=forget',	'/^user[\/_-]?([0-9]+)(\.html?|\/)?$/i'																					=>	'profile.php?id=$1',	'/^user[\/_-]?([0-9]+)[\/_-]?([a-z]+)(\.html?|\/)?$/i'																	=>	'profile.php?section=$2&id=$1',	'/^(delete)[\/_-]?(avatar|user)?[\/_-]?([0-9]+)[\/_-]?([a-z0-9]+)?(\.html?|\/)?$/i'										=>	'profile.php?action=$1_$2&id=$3&csrf_token=$4',	'/^change[\/_-]?(email|pass)(word)?[\/_-]?([0-9]+)[\/_-]([a-zA-Z0-9]+)(\.html?|\/)?$/i'									=>	'profile.php?action=change_$1&id=$3&key=$4',	'/^change[\/_-]?(email|pass)(word)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'														=>	'profile.php?action=change_$1&id=$3',	'/^search[\/_-]?advanced(\.html?|\/)?$/i'																				=>	'search.php?advanced=1',	'/^search[\/_-]?(new)[\/_-]([0-9-]+)(\.html?|\/)?$/i'																	=>	'search.php?action=show_new&forum=$2',	'/^search[\/_-]?(new)[\/_-]([0-9-]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'										=>	'search.php?action=show_new&forum=$2&p=$4',	'/^search[\/_-]?(recent)[\/_-]([0-9]+)(\.html?|\/)?$/i'																	=>	'search.php?action=show_recent&value=$2',	'/^search[\/_-]?(recent)[\/_-]([0-9]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'										=>	'search.php?action=show_recent&value=$2&p=$4',	'/^search[\/_-]?(new|recent|unanswered)(\.html?|\/)?$/i'																=>	'search.php?action=show_$1',	'/^search[\/_-]?(new|recent|unanswered)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'									=>	'search.php?action=show_$1&p=$3',	'/^search[\/_-]?subscriptions[\/_-]?([0-9]+)(\.html?|\/)?$/i'															=>	'search.php?action=show_subscriptions&user_id=$1',	'/^search[\/_-]?subscriptions[\/_-]?([0-9]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'								=>	'search.php?action=show_subscriptions&user_id=$1&p=$3',	'/^search[\/_-]?([0-9]+)(\.html?|\/)?$/i'																				=>	'search.php?search_id=$1',	'/^search[\/_-]?([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'													=>	'search.php?search_id=$1&p=$3',	'/^search[\/_-]?(posts|topics)[\/_-]?user[\/_-]?([0-9]+)(\.html?|\/)?$/i'												=>	'search.php?action=show_user_$1&user_id=$2',	'/^search[\/_-]?(posts|topics)[\/_-]?user[\/_-]?([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'					=>	'search.php?action=show_user_$1&user_id=$2&p=$4',	'/^search\/k(.*)\/([0-9-]+)\/a(.*)\/(message|subject|all)\/([0-9]+)\/(ASC|DESC)\/(posts|topics)\/?$/i'					=>	'search.php?action=search&keywords=$1&author=$3&forum=$2&search_in=$4&sort_by=$5&sort_dir=$6&show_as=$7',	'/^search\/k(.*)\/([0-9-]+)\/a(.*)\/(message|subject|all)\/([0-9]+)\/(ASC|DESC)\/(posts|topics)\/page\/([0-9]+)\/?$/i'	=>	'search.php?action=search&keywords=$1&author=$3&forum=$2&search_in=$4&sort_by=$5&sort_dir=$6&show_as=$7&p=$8',	'/^search-k(.*)-([0-9-]+)-a(.*)-(message|subject|all)-([0-9]+)-(ASC|DESC)-(posts|topics).html?$/i'						=>	'search.php?action=search&keywords=$1&author=$3&forum=$2&search_in=$4&sort_by=$5&sort_dir=$6&show_as=$7',	'/^search-k(.*)-(message|subject|all)-a(.*)-([0-9]+)-(ASC|DESC)-([0-9-]+)-(posts|topics)-p([0-9]+).html?$/i'			=>	'search.php?action=search&keywords=$1&author=$3&forum=$6&search_in=$2&sort_by=$4&sort_dir=$5&show_as=$7&p=$8',	'/^users(\.html?|\/)?$/i'																								=>	'userlist.php',	'/^users\/(.*)\/([0-9-]+)\/?([a-z_]+)[\/_-]([a-zA-Z]+)[\/_-]p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'						=>	'userlist.php?username=$1&show_group=$2&sort_by=$3&sort_dir=$4&p=$6',	'/^users\/(.*)\/([0-9-]+)\/?([a-z_]+)[\/_-]([a-zA-Z]+)(\.html?|\/)?$/i'													=>	'userlist.php?username=$1&show_group=$2&sort_by=$3&sort_dir=$4',	'/^(email|report|subscribe|unsubscribe)[\/_-]?([0-9]+)[\/_-]?([a-z0-9]+)?(\.html?|\/)?$/i'								=>	'misc.php?$1=$2&csrf_token=$3',	'/^(mark|rules)[\/_-]?(read)?[\/_-]?([a-z0-9]+)?(\.html?|\/)?$/i'														=>	'misc.php?action=$1$2&csrf_token=$3',	'/^mark[\/_-](forum)[\/_-]?([0-9]+)[\/_-](read)[\/_-]([a-z0-9]+)(\.html?|\/)?$/i'										=>	'misc.php?action=markforumread&fid=$2&csrf_token=$4',	'/^help[\/_-]([a-z]+)(\.html?|\/)?$/i'																					=>	'help.php?section=$1',	'/^moderate[\/_-]?([0-9]+)(\.html?|\/)?$/i'																				=>	'moderate.php?fid=$1',	'/^move_topics[\/_-]?([0-9]+)[\/_-]([0-9]+)(\.html?|\/)?$/i'															=>	'moderate.php?fid=$1&move_topics=$2',	'/^(open|close|stick|unstick)[\/_-]?([0-9]+)[\/_-]([0-9]+)[\/_-]([a-z0-9]+)(\.html?|\/)?$/i'							=>	'moderate.php?fid=$2&$1=$3&csrf_token=$4',	'/^moderate[\/_-]?([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'												=>	'moderate.php?fid=$1&p=$3',	'/^moderate[\/_-]?([0-9]+)[\/_-]([0-9]+)(\.html?|\/)?$/i'																=>	'moderate.php?fid=$1&tid=$2',	'/^moderate[\/_-]?([0-9]+)[\/_-]([0-9]+)[\/_-]?p(age)?[\/_-]?([0-9]+)(\.html?|\/)?$/i'									=>	'moderate.php?fid=$1&tid=$2&p=$4',	'/^get_host[\/_-]?([0-9]+|[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})(\.html?|\/)?$/i'								=>	'moderate.php?get_host=$1',	'/^feed[\/_-]?(rss|atom)(\.xml?|\/)?$/i'																				=>	'extern.php?action=feed&type=$1');
