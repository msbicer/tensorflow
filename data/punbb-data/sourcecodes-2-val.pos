<?php/*** @version $Id: str_ireplace.php,v 1.2 2007/08/12 01:20:46 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to str_ireplace* Case-insensitive version of str_replace* Note: requires utf8_strtolower* Note: it's not fast and gets slower if $search / $replace is array* Notes: it's based on the assumption that the lower and uppercase* versions of a UTF-8 character will have the same length in bytes* which is currently true given the hash table to strtolower* @param string* @return string* @see http://www.php.net/str_ireplace* @see utf8_strtolower* @package utf8* @subpackage strings*/function utf8_ireplace($search, $replace, $str, $count = NULL){    if ( !is_array($search) ) {        $slen = strlen($search);        if ( $slen == 0 ) {            return $str;        }        $lendif = strlen($replace) - strlen($search);        $search = utf8_strtolower($search);        $search = preg_quote($search);        $lstr = utf8_strtolower($str);        $i = 0;        $matched = 0;        while ( preg_match('/(.*)'.$search.'/Us',$lstr, $matches) ) {            if ( $i === $count ) {                break;            }            $mlen = strlen($matches[0]);            $lstr = substr($lstr, $mlen);            $str = substr_replace($str, $replace, $matched+strlen($matches[1]), $slen);            $matched += $mlen + $lendif;            $i++;        }        return $str;    } else {        foreach ( array_keys($search) as $k ) {            if ( is_array($replace) ) {                if ( array_key_exists($k,$replace) ) {                    $str = utf8_ireplace($search[$k], $replace[$k], $str, $count);                } else {                    $str = utf8_ireplace($search[$k], '', $str, $count);                }            } else {                $str = utf8_ireplace($search[$k], $replace, $str, $count);            }        }        return $str;    }}
<?php/*** @version $Id: substr_replace.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware substr_replace.* Note: requires utf8_substr to be loaded* @see http://www.php.net/substr_replace* @see utf8_strlen* @see utf8_substr*/function utf8_substr_replace($str, $repl, $start , $length = NULL ) {    preg_match_all('/./us', $str, $ar);    preg_match_all('/./us', $repl, $rar);    if( $length === NULL ) {        $length = utf8_strlen($str);    }    array_splice( $ar[0], $start, $length, $rar[0] );    return join('',$ar[0]);}
<?php/** * A database layer class that relies on the MySQL PHP extension. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure we have built in support for MySQLif (!function_exists('mysql_connect'))	exit('This PHP environment doesn\'t have MySQL support built in. MySQL support is required if you want to use a MySQL database to run this forum. Consult the PHP documentation for further assistance.');class DBLayer{	var $prefix;	var $link_id;	var $query_result;	var $saved_queries = array();	var $num_queries = 0;	var $datatype_transformations = array(		'/^SERIAL$/'	=>	'INT(10) UNSIGNED AUTO_INCREMENT'	);	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)	{		$this->prefix = $db_prefix;		if ($p_connect)			$this->link_id = @mysql_pconnect($db_host, $db_username, $db_password);		else			$this->link_id = @mysql_connect($db_host, $db_username, $db_password);		if ($this->link_id)		{			if (!@mysql_select_db($db_name, $this->link_id))				error('Unable to select database. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		}		else			error('Unable to connect to MySQL server. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		// Setup the client-server character set (UTF-8)		if (!defined('FORUM_NO_SET_NAMES'))			$this->set_names('utf8');		return $this->link_id;	}	function start_transaction()	{		return;	}	function end_transaction()	{		return;	}	function query($sql, $unbuffered = false)	{		if (strlen($sql) > 140000)			exit('Insane query. Aborting.');		if (defined('FORUM_SHOW_QUERIES'))			$q_start = forum_microtime();		if ($unbuffered)			$this->query_result = @mysql_unbuffered_query($sql, $this->link_id);		else			$this->query_result = @mysql_query($sql, $this->link_id);		if ($this->query_result)		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, sprintf('%.5f', forum_microtime() - $q_start));			++$this->num_queries;			return $this->query_result;		}		else		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, 0);			return false;		}	}	function query_build($query, $return_query_string = false, $unbuffered = false)	{		$sql = '';		if (isset($query['SELECT']))		{			$sql = 'SELECT '.$query['SELECT'].' FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['FROM'];			if (isset($query['JOINS']))			{				foreach ($query['JOINS'] as $cur_join)					$sql .= ' '.key($cur_join).' '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).current($cur_join).' ON '.$cur_join['ON'];			}			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];			if (!empty($query['GROUP BY']))				$sql .= ' GROUP BY '.$query['GROUP BY'];			if (!empty($query['HAVING']))				$sql .= ' HAVING '.$query['HAVING'];			if (!empty($query['ORDER BY']))				$sql .= ' ORDER BY '.$query['ORDER BY'];			if (!empty($query['LIMIT']))				$sql .= ' LIMIT '.$query['LIMIT'];		}		else if (isset($query['INSERT']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['INSERT']))				$sql .= ' ('.$query['INSERT'].')';			if (is_array($query['VALUES']))				$sql .= ' VALUES('.implode('),(', $query['VALUES']).')';			else				$sql .= ' VALUES('.$query['VALUES'].')';		}		else if (isset($query['UPDATE']))		{			$query['UPDATE'] = (isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['UPDATE'];			$sql = 'UPDATE '.$query['UPDATE'].' SET '.$query['SET'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['DELETE']))		{			$sql = 'DELETE FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['DELETE'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['REPLACE']))		{			$sql = 'REPLACE INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['REPLACE']))				$sql .= ' ('.$query['REPLACE'].')';			$sql .= ' VALUES('.$query['VALUES'].')';		}		return ($return_query_string) ? $sql : $this->query($sql, $unbuffered);	}	function result($query_id = 0, $row = 0, $col = 0)	{		return ($query_id) ? @mysql_result($query_id, $row, $col) : false;	}	function fetch_assoc($query_id = 0)	{		return ($query_id) ? @mysql_fetch_assoc($query_id) : false;	}	function fetch_row($query_id = 0)	{		return ($query_id) ? @mysql_fetch_row($query_id) : false;	}	function num_rows($query_id = 0)	{		return ($query_id) ? @mysql_num_rows($query_id) : false;	}	function affected_rows()	{		return ($this->link_id) ? @mysql_affected_rows($this->link_id) : false;	}	function insert_id()	{		return ($this->link_id) ? @mysql_insert_id($this->link_id) : false;	}	function get_num_queries()	{		return $this->num_queries;	}	function get_saved_queries()	{		return $this->saved_queries;	}	function free_result($query_id = false)	{		return ($query_id) ? @mysql_free_result($query_id) : false;	}	function escape($str)	{		if (is_array($str))			return '';		else if (function_exists('mysql_real_escape_string'))			return mysql_real_escape_string($str, $this->link_id);		else			return mysql_escape_string($str);	}	function error()	{		$result['error_sql'] = @current(@end($this->saved_queries));		$result['error_no'] = @mysql_errno($this->link_id);		$result['error_msg'] = @mysql_error($this->link_id);		return $result;	}	function close()	{		if ($this->link_id)		{			if ($this->query_result)				@mysql_free_result($this->query_result);			return @mysql_close($this->link_id);		}		else			return false;	}	function set_names($names)	{		return $this->query('SET NAMES \''.$this->escape($names).'\'');	}	function get_version()	{		$result = $this->query('SELECT VERSION()');		return array(			'name'		=> 'MySQL Standard',			'version'	=> preg_replace('/^([^-]+).*$/', '\\1', $this->result($result))		);	}	function table_exists($table_name, $no_prefix = false)	{		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');		return $this->num_rows($result) > 0;	}	function field_exists($table_name, $field_name, $no_prefix = false)	{		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');		return $this->num_rows($result) > 0;	}	function index_exists($table_name, $index_name, $no_prefix = false)	{		$exists = false;		$result = $this->query('SHOW INDEX FROM '.($no_prefix ? '' : $this->prefix).$table_name);		while ($cur_index = $this->fetch_assoc($result))		{			if ($cur_index['Key_name'] == ($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name)			{				$exists = true;				break;			}		}		return $exists;	}	function create_table($table_name, $schema, $no_prefix = false)	{		if ($this->table_exists($table_name, $no_prefix))			return;		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";		// Go through every schema element and add it to the query		foreach ($schema['FIELDS'] as $field_name => $field_data)		{			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);			$query .= $field_name.' '.$field_data['datatype'];			if (isset($field_data['collation']))				$query .= 'CHARACTER SET utf8 COLLATE utf8_'.$field_data['collation'];			if (!$field_data['allow_null'])				$query .= ' NOT NULL';			if (isset($field_data['default']))				$query .= ' DEFAULT '.$field_data['default'];			$query .= ",\n";		}		// If we have a primary key, add it		if (isset($schema['PRIMARY KEY']))			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";		// Add unique keys		if (isset($schema['UNIQUE KEYS']))		{			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)				$query .= 'UNIQUE KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$key_name.'('.implode(',', $key_fields).'),'."\n";		}		// Add indexes		if (isset($schema['INDEXES']))		{			foreach ($schema['INDEXES'] as $index_name => $index_fields)				$query .= 'KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.'('.implode(',', $index_fields).'),'."\n";		}		// We remove the last two characters (a newline and a comma) and add on the ending		$query = substr($query, 0, strlen($query) - 2)."\n".') ENGINE = '.(isset($schema['ENGINE']) ? $schema['ENGINE'] : 'MyISAM').' CHARACTER SET utf8';		$this->query($query) or error(__FILE__, __LINE__);	}	function drop_table($table_name, $no_prefix = false)	{		if (!$this->table_exists($table_name, $no_prefix))			return;		$this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) or error(__FILE__, __LINE__);	}	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if ($this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' MODIFY '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function drop_field($table_name, $field_name, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) or error(__FILE__, __LINE__);	}	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)	{		if ($this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ('.implode(',', $index_fields).')') or error(__FILE__, __LINE__);	}	function drop_index($table_name, $index_name, $no_prefix = false)	{		if (!$this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) or error(__FILE__, __LINE__);	}}
<?php/** * Rewrites SEF URLs to their actual files. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */define('FORUM_ROOT', './');require FORUM_ROOT.'include/essentials.php';// Bring in all the rewrite rulesif (file_exists(FORUM_ROOT.'include/url/'.$forum_config['o_sef'].'/rewrite_rules.php'))	require FORUM_ROOT.'include/url/'.$forum_config['o_sef'].'/rewrite_rules.php';else	require FORUM_ROOT.'include/url/Default/rewrite_rules.php';// Allow extensions to create their own rewrite rules/modify existing rules($hook = get_hook('re_rewrite_rules')) ? eval($hook) : null;// If query string is not set properly, create one and set $_GET// E.g. lighttpd's 404 handler does not pass query stringif ((!isset($_SERVER['QUERY_STRING']) || empty($_SERVER['QUERY_STRING'])) && strpos($_SERVER['REQUEST_URI'], '?') !== false){	$_SERVER['QUERY_STRING'] = parse_url('http://'.$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI']);	$_SERVER['QUERY_STRING'] = isset($_SERVER['QUERY_STRING']['query']) ? $_SERVER['QUERY_STRING']['query'] : '';	parse_str($_SERVER['QUERY_STRING'], $_GET);}// We determine the path to the script, since we need to separate the path from the data to be rewritten$path_to_script = str_replace('\\', '/', dirname($_SERVER['SCRIPT_NAME']));if (substr($path_to_script, -1) != '/')	$path_to_script  = $path_to_script.'/';// We create our own request URI with the path removed and only the parts to rewrite included$request_uri = substr(urldecode($_SERVER['REQUEST_URI']), strlen($path_to_script));if (strpos($request_uri, '?') !== false)	$request_uri = substr($request_uri, 0, strpos($request_uri, '?'));$rewritten_url = '';$url_parts = array();// We go through every rewrite ruleforeach ($forum_rewrite_rules as $rule => $rewrite_to){	// We have a match!	if (preg_match($rule, $request_uri))	{		$rewritten_url = preg_replace($rule, $rewrite_to, $request_uri);		$url_parts = explode('?', $rewritten_url);		// If there is a query string		if (isset($url_parts[1]))		{			$query_string = explode('&', $url_parts[1]);			// Set $_GET properly for all of the variables			// We also set $_REQUEST if it's not already set			foreach ($query_string as $cur_param)			{				$param_data = explode('=', $cur_param);				// Sometimes, parameters don't set a value (eg: script.php?foo), so we set them to null				$param_data[1] = isset($param_data[1]) ? $param_data[1] : null;				// We don't want to be overwriting values in $_REQUEST that were set in POST or COOKIE				if (!isset($_POST[$param_data[0]]) && !isset($_COOKIE[$param_data[0]]))					$_REQUEST[$param_data[0]] = urldecode($param_data[1]);				$_GET[$param_data[0]] = urldecode($param_data[1]);			}		}		break;	}}// If we don't know what to rewrite to, we show a bad request messsageif (empty($rewritten_url)){	define('FORUM_HTTP_RESPONSE_CODE_SET', 1);	header('HTTP/1.1 404 Not Found');	// Allow an extension to override the "Bad request" message with a custom 404 page	($hook = get_hook('re_page_not_found')) ? eval($hook) : null;	error('Page Not found (Error 404): The requested page <em>'.forum_htmlencode($request_uri).'</em> could not be found.');}// We change $_SERVER['PHP_SELF'] so that it reflects the file we're actually loading$_SERVER['PHP_SELF'] = str_replace('rewrite.php', $url_parts[0], $_SERVER['PHP_SELF']);require FORUM_ROOT.$url_parts[0];
<?php/** * Rank management page. * * Allows administrators to control the tags given to posters based on their post count. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('ark_start')) ? eval($hook) : null;if ($forum_user['g_id'] != FORUM_ADMIN)	message($lang_common['No permission']);// Load the admin.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_ranks.php';// Add a rankif (isset($_POST['add_rank'])){	$rank = forum_trim($_POST['new_rank']);	$min_posts = intval($_POST['new_min_posts']);	if ($rank == '')		message($lang_admin_ranks['Title message']);	if ($min_posts < 0)		message($lang_admin_ranks['Min posts message']);	($hook = get_hook('ark_add_rank_form_submitted')) ? eval($hook) : null;	// Make sure there isn't already a rank with the same min_posts value	$query = array(		'SELECT'	=> 'COUNT(r.id)',		'FROM'		=> 'ranks AS r',		'WHERE'		=> 'min_posts='.$min_posts	);	($hook = get_hook('ark_add_rank_qr_check_rank_collision')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$rank_num_min_posts = $forum_db->result($result);	if ($rank_num_min_posts !== false && $rank_num_min_posts > 0)		message(sprintf($lang_admin_ranks['Min posts occupied message'], $min_posts));	$query = array(		'INSERT'	=> 'rank, min_posts',		'INTO'		=> 'ranks',		'VALUES'	=> '\''.$forum_db->escape($rank).'\', '.$min_posts	);	($hook = get_hook('ark_add_rank_qr_add_rank')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the ranks cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_ranks_cache();	// Add flash message	$forum_flash->add_info($lang_admin_ranks['Rank added']);	($hook = get_hook('ark_add_rank_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_ranks']), $lang_admin_ranks['Rank added']);}// Update a rankelse if (isset($_POST['update'])){	$id = intval(key($_POST['update']));	$rank = forum_trim($_POST['rank'][$id]);	$min_posts = intval($_POST['min_posts'][$id]);	if ($rank == '')		message($lang_admin_ranks['Title message']);	if ($min_posts < 0)		message($lang_admin_ranks['Min posts message']);	($hook = get_hook('ark_update_form_submitted')) ? eval($hook) : null;	// Make sure there isn't already a rank with the same min_posts value	$query = array(		'SELECT'	=> 'COUNT(r.id)',		'FROM'		=> 'ranks AS r',		'WHERE'		=> 'id!='.$id.' AND min_posts='.$min_posts	);	($hook = get_hook('ark_update_qr_check_rank_collision')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$rank_num_min_posts = $forum_db->result($result);	if ($rank_num_min_posts !== false && $rank_num_min_posts > 0)		message(sprintf($lang_admin_ranks['Min posts occupied message'], $min_posts));	$query = array(		'UPDATE'	=> 'ranks',		'SET'		=> 'rank=\''.$forum_db->escape($rank).'\', min_posts='.$min_posts,		'WHERE'		=> 'id='.$id	);	($hook = get_hook('ark_update_qr_update_rank')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the ranks cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_ranks_cache();	// Add flash message	$forum_flash->add_info($lang_admin_ranks['Rank updated']);	($hook = get_hook('ark_update_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_ranks']), $lang_admin_ranks['Rank updated']);}// Remove a rankelse if (isset($_POST['remove'])){	$id = intval(key($_POST['remove']));	($hook = get_hook('ark_remove_form_submitted')) ? eval($hook) : null;	$query = array(		'DELETE'	=> 'ranks',		'WHERE'		=> 'id='.$id	);	($hook = get_hook('ark_remove_qr_delete_rank')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the ranks cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_ranks_cache();	// Add flash message	$forum_flash->add_info($lang_admin_ranks['Rank removed']);	($hook = get_hook('ark_remove_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_ranks']), $lang_admin_ranks['Rank removed']);}// Load the cached ranksif (file_exists(FORUM_CACHE_DIR.'cache_ranks.php'))	include FORUM_CACHE_DIR.'cache_ranks.php';if (!defined('FORUM_RANKS_LOADED')){	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_ranks_cache();	require FORUM_CACHE_DIR.'cache_ranks.php';}// Setup the form$forum_page['fld_count'] = $forum_page['item_count'] = $forum_page['group_count'] = 0;// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),	array($lang_admin_common['Users'], forum_link($forum_url['admin_users'])),	array($lang_admin_common['Ranks'], forum_link($forum_url['admin_ranks'])));($hook = get_hook('ark_pre_header_load')) ? eval($hook) : null;define('FORUM_PAGE_SECTION', 'users');define('FORUM_PAGE', 'admin-ranks');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('ark_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_ranks['Rank head'] ?></span></h2>	</div>	<div class="main-content main-frm">		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_ranks']) ?>?action=foo">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_ranks']).'?action=foo') ?>" />			</div>			<div class="ct-box" id="info-ranks-intro">				<p><?php printf($lang_admin_ranks['Add rank intro'], '<strong><a href="'.forum_link($forum_url['admin_settings_features']).'">'.$lang_admin_common['Settings'].' - '.$lang_admin_common['Features'].'</a></strong>') ?></p>			</div>			<fieldset class="frm-group frm-hdgroup group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><strong><?php echo $lang_admin_ranks['Add rank legend'] ?></strong></legend><?php ($hook = get_hook('ark_pre_add_rank_fieldset')) ? eval($hook) : null; ?>				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?><?php echo ($forum_page['item_count'] == 1) ? ' mf-head' : ' mf-extra' ?>">					<legend><span><?php echo $lang_admin_ranks['New rank'] ?></span></legend>					<div class="mf-box"><?php ($hook = get_hook('ark_pre_add_rank_title')) ? eval($hook) : null; ?>						<div class="mf-field mf-field1 text">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_ranks['Rank title label'] ?></span></label><br />							<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="new_rank" size="24" maxlength="50" required /></span>						</div><?php ($hook = get_hook('ark_pre_add_rank_min_posts')) ? eval($hook) : null; ?>						<div class="mf-field text">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_ranks['Min posts label'] ?></span></label><br />							<span class="fld-input"><input type="number" id="fld<?php echo $forum_page['fld_count'] ?>" name="new_min_posts" size="7" maxlength="7" required /></span>						</div><?php ($hook = get_hook('ark_pre_add_rank_submit')) ? eval($hook) : null; ?>						<div class="mf-field text">							<span class="submit"><input type="submit" name="add_rank" value="<?php echo $lang_admin_ranks['Add rank'] ?>" /></span>						</div>					</div><?php ($hook = get_hook('ark_pre_add_rank_fieldset_end')) ? eval($hook) : null; ?>				</fieldset><?php ($hook = get_hook('ark_add_rank_fieldset_end')) ? eval($hook) : null; ?>			</fieldset>		</form><?phpif (!empty($forum_ranks)){	// Reset fieldset counter	$forum_page['group_count'] = $forum_page['item_count'] = 0;?>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_ranks']) ?>?action=foo">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_ranks']).'?action=foo') ?>" />			</div>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_ranks['Existing ranks legend'] ?></span></legend><?php	foreach ($forum_ranks as $rank_key => $cur_rank)	{	?><?php ($hook = get_hook('ark_pre_edit_cur_rank_fieldset')) ? eval($hook) : null; ?>				<fieldset class="mf-set mf-extra set<?php echo ++$forum_page['item_count'] ?>">					<legend><span><?php echo $lang_admin_ranks['Existing rank'] ?></span></legend>					<div class="mf-box"><?php ($hook = get_hook('ark_pre_edit_cur_rank_title')) ? eval($hook) : null; ?>						<div class="mf-field text mf-field1">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_ranks['Rank title label'] ?></span></label><br />							<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="rank[<?php echo $cur_rank['id'] ?>]" value="<?php echo forum_htmlencode($cur_rank['rank']) ?>" size="24" maxlength="50" required /></span>						</div><?php ($hook = get_hook('ark_pre_edit_cur_rank_min_posts')) ? eval($hook) : null; ?>						<div class="mf-field text">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_ranks['Min posts label'] ?></span></label><br />							<span class="fld-input"><input type="number" id="fld<?php echo $forum_page['fld_count'] ?>" name="min_posts[<?php echo $cur_rank['id'] ?>]" value="<?php echo $cur_rank['min_posts'] ?>" size="7" maxlength="7" required /></span>						</div><?php ($hook = get_hook('ark_pre_edit_cur_rank_submit')) ? eval($hook) : null; ?>						<div class="mf-field text">							<span class="submit"><input type="submit" name="update[<?php echo $cur_rank['id'] ?>]" value="<?php echo $lang_admin_ranks['Update'] ?>" /> <input type="submit" name="remove[<?php echo $cur_rank['id'] ?>]" value="<?php echo $lang_admin_ranks['Remove'] ?>" /></span>						</div>					</div><?php ($hook = get_hook('ark_pre_edit_cur_rank_fieldset_end')) ? eval($hook) : null; ?>				</fieldset><?php		($hook = get_hook('ark_edit_cur_rank_fieldset_end')) ? eval($hook) : null;	}?>			</fieldset>		</form>	</div><?php}else{?>		<div class="frm-form">			<div class="ct-box">				<p><?php echo $lang_admin_ranks['No ranks'] ?></p>			</div>		</div>	</div><?php}($hook = get_hook('ark_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->require FORUM_ROOT.'footer.php';
<?php// Language definitions for frequently used strings$lang_common = array(// Text orientation and encoding'lang_direction'			=>	'ltr',	// ltr (Left-To-Right) or rtl (Right-To-Left)'lang_identifier'			=>	'en',// Number formatting'lang_decimal_point'		=>	'.','lang_thousands_sep'		=>	',',// Notices'Bad request'				=>	'Bad request. The link you followed is incorrect or outdated.','No view'					=>	'You do not have permission to view these forums.','No permission'				=>	'You do not have permission to access this page.','CSRF token mismatch'		=>	'Unable to confirm security token. A likely cause for this is that some time passed between when you first entered the page and when you submitted a form or clicked a link. If that is the case and you would like to continue with your action, please click the Confirm button. Otherwise, you should click the Cancel button to return to where you were.','No cookie'					=>	'You appear to have logged in successfully, however a cookie has not been set. Please check your settings and if applicable, enable cookies for this website.',// Miscellaneous'Forum index'				=>	'Forum index','Submit'					=>	'Submit',	// "name" of submit buttons'Cancel'					=>	'Cancel', // "name" of cancel buttons'Preview'					=>	'Preview',	// submit button to preview message'Delete'					=>	'Delete','Split'						=>	'Split','Ban message'				=>	'You are banned from this forum.','Ban message 2'				=>	'The ban expires at the end of %s.','Ban message 3'				=>	'The administrator or moderator that banned you left the following message:','Ban message 4'				=>	'Please direct any inquiries to the forum administrator at %s.','Never'						=>	'Never','Today'						=>	'Today','Yesterday'					=>	'Yesterday','Forum message'				=>	'Forum message','Maintenance warning'		=>	'<strong>WARNING! %s Enabled.</strong> DO NOT LOGOUT as you will be unable to login again.','Maintenance mode'			=>	'Maintenance Mode','Redirecting'				=>	' Redirecting', // With space!'Forwarding info'			=>	'You should automatically be forwarded to a new page in %s %s.','second'					=>	'second',	// singular'seconds'					=>	'seconds',	// plural'Click redirect'			=>	'Click here if you do not want to wait any longer (or if your browser does not automatically forward you)','Invalid e-mail'			=>	'The email address you entered is invalid.','New posts'					=>	'New posts',	// the link that leads to the first new post'New posts title'			=>	'Find topics containing posts made since your last visit.',	// the popup text for new posts links'Active topics'				=>	'Active topics','Active topics title'		=>	'Find topics which contain recent posts.','Unanswered topics'			=>	'Unanswered topics','Unanswered topics title'	=>	'Find topics which have not been replied to.','Username'					=>	'Username','Registered'				=>	'Registered','Write message'				=>	'Write message','Forum'						=>	'Forum','Posts'						=>	'Posts','Pages'						=>	'Pages','Page'						=>	'Page','BBCode'					=>	'BBCode',	// You probably shouldn't change this'Smilies'					=>	'Smilies','Images'					=>	'Images','You may use'				=>	'You may use: %s','and'						=>	'and','Image link'				=>	'image',	// This is displayed (i.e. <image>) instead of images when "Show images" is disabled in the profile'wrote'						=>	'wrote',	// For [quote]'s (e.g., User wrote:)'Code'						=>	'Code',		// For [code]'s'Forum mailer'				=>	'%s Mailer',	// As in "MyForums Mailer" in the signature of outgoing e-mails'Write message legend'		=>	'Compose your post','Required information'		=>	'Required information','Reqmark'					=>	'*','Required'					=>	'(Required)','Required warn'				=>	'All fields labelled %s must be completed before the form is submitted.','Crumb separator'			=>	' &rarr;&#160;', // The character or text that separates links in breadcrumbs'Title separator'			=>	'  ','Page separator'			=>	'&#160;', //The character or text that separates page numbers'Spacer'					=>	'', // Ellipsis for paginate'Paging separator'			=>	' ', //The character or text that separates page numbers for page navigation generally'Previous'					=>	'Previous','Next'						=>	'Next','Cancel redirect'			=>	'Operation cancelled.','No confirm redirect'		=>	'No confirmation provided. Operation cancelled.','Please confirm'			=>	'Please confirm:','Help page'					=>	'Help with: %s','Re'						=>	'Re:','Page info'					=>	'(Page %1$s of %2$s)','Item info single'			=>	'%s: %s','Item info plural'			=>	'%s: %s to %s of %s', // e.g. Topics [ 10 to 20 of 30 ]'Info separator'			=>	' ', // e.g. 1 Page | 10 Topics'Powered by'				=>	'Powered by %s, supported by %s.','Maintenance'				=>	'Maintenance','Installed extension'		=>	'The %s official extension is installed. Copyright &copy; 2003&ndash;2011 <a href="http://punbb.informer.com/">PunBB</a>.','Installed extensions'		=>	'Currently installed <span id="extensions-used" title="%s">%s official extensions</span>. Copyright &copy; 2003&ndash;2011 <a href="http://punbb.informer.com/">PunBB</a>.',// CSRF confirmation form'Confirm'					=>	'Confirm',	// Button'Confirm action'			=>	'Confirm action','Confirm action head'		=>	'Please confirm or cancel your last action',// Title'Title'						=>	'Title','Member'					=>	'Member',	// Default title'Moderator'					=>	'Moderator','Administrator'				=>	'Administrator','Banned'					=>	'Banned','Guest'						=>	'Guest',// Stuff for include/parser.php'BBCode error 1'			=>	'[/%1$s] was found without a matching [%1$s]','BBCode error 2'			=>	'[%s] tag is empty','BBCode error 3'			=>	'[%1$s] was opened within [%2$s], this is not allowed','BBCode error 4'			=>	'[%s] was opened within itself, this is not allowed','BBCode error 5'			=>	'[%1$s] was found without a matching [/%1$s]','BBCode error 6'			=>	'[%s] tag had an empty attribute section','BBCode nested list'		=>	'[list] tags cannot be nested','BBCode code problem'		=>	'There is a problem with your [code] tags',// Stuff for the navigator (top of every page)'Index'						=>	'Index','User list'					=>	'User list','Rules'						=>  'Rules','Search'					=>  'Search','Register'					=>  'Register','register'					=>	'register','Login'						=>  'Login','login'						=>	'login','Not logged in'				=>  'You are not logged in.','Profile'					=>	'Profile','Logout'					=>	'Logout','Logged in as'				=>	'Logged in as %s.','Admin'						=>	'Administration','Last visit'				=>	'Last visit %s','Mark all as read'			=>	'Mark all topics as read','Login nag'					=>	'Please login or register.','New reports'				=>	'New reports',// Alerts'New alerts'				=>	'New Alerts','Maintenance alert'			=>	'<strong>WARNING! Maintenance mode enabled.</strong> This board is currently in maintenance mode. <em>DO NOT</em> logout, if you do you will not be able to login again.','Updates'					=>	'PunBB updates:','Updates failed'			=>	'The latest attempt at checking for updates against the punbb.informer.com updates service failed. This probably just means that the service is temporarily overloaded or out of order. However, if this alert does not disappear within a day or two, you should disable the automatic check for updates and check for updates manually in the future.','Updates version n hf'		=>	'A newer version of PunBB, version %s, is available for download at <a href="http://punbb.informer.com/">punbb.informer.com</a>. Furthermore, one or more hotfixes are available for install on the <a href="%s">Manage hotfixes</a> tab of the admin interface.','Updates version'			=>	'A newer version of PunBB, version %s, is available for download at <a href="http://punbb.informer.com/">punbb.informer.com</a>.','Updates hf'				=>	'One or more hotfixes are available for install on the <a href="%s">Manage hotfixes</a> tab of the admin interface.','Database mismatch'			=>	'Database version mismatch','Database mismatch alert'	=>	'Your PunBB database is meant to be used in conjunction with a newer version of the PunBB code. This mismatch can lead to your forum not working properly. It is suggested that you upgrade your forum to the newest version of PunBB.',// Stuff for Jump Menu'Go'						=>	'Go',		// submit button in forum jump'Jump to'					=>	'Jump to forum:',// For extern.php RSS feed'RSS description'			=>	'The most recent topics at %s.','RSS description topic'		=>	'The most recent posts in %s.','RSS reply'					=>	'Re: ',	// The topic subject will be appended to this string (to signify a reply)// Accessibility'Skip to content'			=>	'Skip to forum content',// Debug information'Querytime'					=>	'Generated in %1$s seconds, %2$s queries executed','Debug table'				=>	'Debug information','Debug summary'				=>	'Database query performance information','Query times'				=>	'Time (s)','Query'						=>	'Query','Total query time'			=>	'Total query time',);
<?php/*** @version $Id: stristr.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to stristr* Find first occurrence of a string using case insensitive comparison* Note: requires utf8_strtolower* @param string* @param string* @return int* @see http://www.php.net/strcasecmp* @see utf8_strtolower* @package utf8* @subpackage strings*/function utf8_stristr($str, $search) {    if ( strlen($search) == 0 ) {        return $str;    }    $lstr = utf8_strtolower($str);    $lsearch = utf8_strtolower($search);    preg_match('/^(.*)'.preg_quote($lsearch).'/Us',$lstr, $matches);    if ( count($matches) == 2 ) {        return substr($str, strlen($matches[1]));    }    return FALSE;}
<?php/** * SEF URLs that use a folder-like layout and include topic name and forum name * where applicable. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure no one attempts to run this script "directly"if (!defined('FORUM'))	exit;// These are the "fancy" folder based SEF URLs$forum_url = array(	'change_email'					=>	'change/email/$1/',	'change_email_key'				=>	'change/email/$1/$2/',	'change_password'				=>	'change/password/$1/',	'change_password_key'			=>	'change/password/$1/$2/',	'delete'						=>	'delete/$1/',	'delete_avatar'					=>	'delete/avatar/$1/$2/',	'delete_user'					=>	'delete/user/$1/',	'edit'							=>	'edit/$1/',	'email'							=>	'email/$1/',	'forum'							=>	'forum/$1/$2/',	'forum_rss'						=>	'feed/rss/forum/$1/',	'forum_atom'					=>	'feed/atom/forum/$1/',	'help'							=>	'help/$1/',	'index'							=>	'',	'index_rss'						=>	'feed/rss/',	'index_atom'					=>	'feed/atom/',	'login'							=>	'login/',	'logout'						=>	'logout/$1/$2/',	'mark_read'						=>	'mark/read/$1/',	'mark_forum_read'				=>	'mark/forum/$1/read/$2/',	'new_topic'						=>	'new/topic/$1/',	'new_reply'						=>	'new/reply/$1/',	'post'							=>	'post/$1/#p$1',	'profile_about'					=>	'user/$1/about/',	'profile_identity'				=>	'user/$1/identity/',	'profile_settings'				=>	'user/$1/settings/',	'profile_avatar'				=>	'user/$1/avatar/',	'profile_signature'				=>	'user/$1/signature/',	'profile_admin'					=>	'user/$1/admin/',	'quote'							=>	'new/reply/$1/quote/$2/',	'register'						=>	'register/',	'report'						=>	'report/$1/',	'request_password'				=>	'request/password/',	'rules'							=>	'rules/',	'search'						=>	'search/',	'search_advanced'				=>	'search/advanced/',	'search_resultft'				=>	'search/k$1/$2/a$3/$4/$5/$6/$7/',	'search_results'				=>	'search/$1/',	'search_new'					=>	'search/new/',	'search_new_results'			=>	'search/new/$1/',	'search_recent'					=>	'search/recent/',	'search_recent_results'			=>	'search/recent/$1/',	'search_unanswered'				=>	'search/unanswered/',	'search_subscriptions'			=>	'search/subscriptions/$1/',	'search_user_posts'				=>	'search/posts/user/$1/',	'search_user_topics'			=>	'search/topics/user/$1/',	'subscribe'						=>	'subscribe/$1/$2/',	'topic'							=>	'topic/$1/$2/',	'topic_rss'						=>	'feed/rss/topic/$1/',	'topic_atom'					=>	'feed/atom/topic/$1/',	'topic_new_posts'				=>	'topic/$1/$2/new/posts/',	'topic_last_post'				=>	'topic/$1/last/post/',	'unsubscribe'					=>	'unsubscribe/$1/$2/',	'user'							=>	'user/$1/',	'users'							=>	'users/',	'users_browse'					=>	'users/$4/$1/$2/$3/',	'page'							=>	'page/$1/',	'moderate_forum'				=>	'moderate/$1/',	'get_host'						=>	'get_host/$1/',	'move'							=>	'move_topics/$1/$2/',	'open'							=>	'open/$1/$2/$3/',	'close'							=>	'close/$1/$2/$3/',	'stick'							=>	'stick/$1/$2/$3/',	'unstick'						=>	'unstick/$1/$2/$3/',	'moderate_topic'				=>	'moderate/$1/$2/',	'admin_index'					=>	'admin/index.php',	'admin_bans'					=>	'admin/bans.php?sort_by=1',	'admin_categories'				=>	'admin/categories.php',	'admin_censoring'				=>	'admin/censoring.php',	'admin_extensions_manage'		=>	'admin/extensions.php?section=manage',	'admin_extensions_hotfixes'		=>	'admin/extensions.php?section=hotfixes',	'admin_forums'					=>	'admin/forums.php',	'admin_groups'					=>	'admin/groups.php',	'admin_loader'					=>	'admin/loader.php',	'admin_reindex'					=>	'admin/reindex.php',	'admin_settings_setup'			=>	'admin/settings.php?section=setup',	'admin_settings_features'		=>	'admin/settings.php?section=features',	'admin_settings_content'		=>	'admin/settings.php?section=content',	'admin_settings_email'			=>	'admin/settings.php?section=email',	'admin_settings_announcements'	=>	'admin/settings.php?section=announcements',	'admin_settings_registration'	=>	'admin/settings.php?section=registration',	'admin_settings_communications'	=>	'admin/settings.php?section=communications',	'admin_settings_maintenance'	=>	'admin/settings.php?section=maintenance',	'admin_prune'					=>	'admin/prune.php',	'admin_ranks'					=>	'admin/ranks.php',	'admin_reports'					=>	'admin/reports.php',	'admin_users'					=>	'admin/users.php');
<?php/** * Loader class for inject CSS and JS files. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// JS groupsdefine('FORUM_JS_GROUP_SYSTEM', -100);define('FORUM_JS_GROUP_DEFAULT', 0);define('FORUM_JS_GROUP_COUNTER', 100);// CSS groupsdefine('FORUM_CSS_GROUP_SYSTEM', -100);define('FORUM_CSS_GROUP_DEFAULT', 0);class Loader{	private $libs;	// Class instance    private static $instance;	// Start of life	private function __construct() {		$this->libs = array();		$this->libs['js'] = array();		$this->libs['css'] = array();	}	// The end	public function __destruct() {		unset($this->libs);	}	// Singleton    public static function singleton() {        if (!isset(self::$instance)) {            $c = __CLASS__;            self::$instance = new $c;        }        return self::$instance;    }    // Clone forbiden    public function __clone() {        trigger_error('Clone is forbiden.', E_USER_ERROR);    }	// Add JS url or file to load	public function add_js($data = NULL, $options = NULL)	{		$return = ($hook = get_hook('ld_fn_add_js_start')) ? eval($hook) : null;		if ($return != null)			return $return;		if (is_null($options) || !is_array($options))		{			$options = array();		}		// Default options		$default_options = array(			// external, inline, file			'type'		=> array(				'default'	=> 'external',			),			//			'async'			=> array(				'default'	=> false,			),			//			'weight'		=> array(				'default'	=> 100,			),			//			'group'			=> array(				'default'	=> FORUM_JS_GROUP_DEFAULT,			),			//			'every_page'	=> array(				'default'	=> false,			),			//			'defer'			=> array(				'default'	=> false,			),			//			'preprocess'	=> array(				'default'	=> true,			)		);		$length = count($default_options);		$keys = array_keys($default_options);		for ($i = 0; $i < $length; $i++)		{			$key = $keys[$i];			if (!isset($options[$key]))			{				$default_options[$keys[$i]] = $default_options[$keys[$i]]['default'];				continue;			}			$default_options[$keys[$i]] = $options[$key];		}		// Check data  url or inline code		$default_options['data'] = forum_trim($data);		if (empty($default_options['data']) || utf8_strlen($default_options['data']) < 1)		{			return FALSE;		}		// Check type		if ($default_options['type'] == 'file')		{			$default_options['data'] = $this->create_url_from_file(forum_trim($data));		}		// Tweak weight		$default_options['weight'] += count($this->libs['js']) / 1000;		($hook = get_hook('ld_fn_add_js_pre_merge')) ? eval($hook) : null;		// Add to libs		if ($default_options['type'] != 'inline')		{			$this->libs['js'][$default_options['data']] = $default_options;		}		else		{			$this->libs['js'][] = $default_options;		}		($hook = get_hook('ld_fn_add_js_end')) ? eval($hook) : null;		return $this->libs['js'];	}	//	public function render_js()	{		$output = '';		$return = ($hook = get_hook('ld_fn_render_js_start')) ? eval($hook) : null;		if ($return != null)			return $return;		if (empty($this->libs['js']))			return $output;		// Sorts the scripts into correct order		uasort($this->libs['js'], array('Loader', 'sort_libs'));		return $this->render_js_labjs();	}	// Add CSS url or file to load	public function add_css($data = NULL, $options = NULL)	{		$return = ($hook = get_hook('ld_fn_add_css_start')) ? eval($hook) : null;		if ($return != null)			return $return;		if (is_null($options) || !is_array($options))		{			$options = array();		}		// Default options		$default_options = array(			//			'type'		=> array(				'default'	=> 'external',			),			//			'weight'		=> array(				'default'	=> 100,			),			//			'group'			=> array(				'default'	=> FORUM_CSS_GROUP_DEFAULT,			),			// screen, all, print			'media'			=> array(				'default'	=> 'all',			),			//			'every_page'	=> array(				'default'	=> false,			),			//			'preprocess'	=> array(				'default'	=> true,			),			'browsers'		=> array(				'default'	=> array(),			),		);		$length = count($default_options);		$keys = array_keys($default_options);		for ($i = 0; $i < $length; $i++)		{			$key = $keys[$i];			if (!isset($options[$key]))			{				$default_options[$keys[$i]] = $default_options[$keys[$i]]['default'];				continue;			}			$default_options[$keys[$i]] = $options[$key];		}		// Check data  url or inline code		$default_options['data'] = forum_trim($data);		if (empty($default_options['data']) || utf8_strlen($default_options['data']) < 1)		{			return FALSE;		}		// Check type		if ($default_options['type'] == 'file')		{			$default_options['data'] = $this->create_url_from_file(forum_trim($data));		}		// Tweak weight		$default_options['weight'] += count($this->libs['css']) / 1000;		($hook = get_hook('ld_fn_add_css_pre_merge')) ? eval($hook) : null;		// Add to libs		if ($default_options['type'] != 'inline')		{			$this->libs['css'][$default_options['data']] = $default_options;		}		else		{			$this->libs['css'][] = $default_options;		}		($hook = get_hook('ld_fn_add_css_end')) ? eval($hook) : null;		return $this->libs['css'];	}	// Render CSS libs	public function render_css()	{		$output = '';		$return = ($hook = get_hook('ld_fn_render_css_start')) ? eval($hook) : null;		if ($return != null)			return $return;		if (empty($this->libs['css']))			return $output;		// Sorts the scripts into correct order		uasort($this->libs['css'], array('Loader', 'sort_libs'));		return $this->render_css_simple();	}	// Render for CSS  use link tags method	private function render_css_simple()	{		$output = '';		$libs = $this->libs['css'];		$return = ($hook = get_hook('ld_fn_render_css_simple_start')) ? eval($hook) : null;		if ($return != null)			return $return;		foreach ($libs as $key => $lib)		{			if ($lib['type'] == 'inline')			{				$output .= forum_trim($this->check_conditional_comments($lib, '<style>'.$lib['data'].'</style>'))."\n";				unset($libs[$key]);				continue;			}			else if ($lib['type'] == 'external' || $lib['type'] == 'file')			{				$output .= forum_trim($this->check_conditional_comments($lib, '<link rel="stylesheet" type="text/css" media="'.$lib['media'].'" href="'.$lib['data'].'" />'))."\n";				unset($libs[$key]);				continue;			}		}		($hook = get_hook('ld_fn_render_css_simple_end')) ? eval($hook) : null;		return $output;	}	// Render for JS  use default script tags method	private function render_js_simple()	{		$output = '';		$libs = $this->libs['js'];		$return = ($hook = get_hook('ld_fn_render_js_simple_start')) ? eval($hook) : null;		if ($return != null)			return $return;		foreach ($libs as $key => $lib)		{			if ($lib['type'] == 'inline')			{				$output .= '<script>'.$lib['data'].'</script>'."\n";				unset($libs[$key]);				continue;			}			else if ($lib['type'] == 'external' || $lib['type'] == 'file')			{				$output .= '<script'.(($lib['async']) ? " async" : "").(($lib['defer']) ? " defer=\"true\"" : "").' src="'.$lib['data'].'"></script>'."\n";				unset($libs[$key]);				continue;			}		}		($hook = get_hook('ld_fn_render_js_simple_end')) ? eval($hook) : null;		return $output;	}	// Render for JS  use LABjs method	private function render_js_labjs()	{		$output_system = $output_counter = $output_default = '';		$libs = $this->libs['js'];		$return = ($hook = get_hook('ld_fn_render_js_labjs_start')) ? eval($hook) : null;		if ($return != null)			return $return;		foreach ($libs as $key => $lib)		{			if ($lib['data'] === FALSE)			{				continue;			}			if ($lib['type'] == 'inline')			{				if ($lib['group'] == FORUM_JS_GROUP_SYSTEM)				{					$output_system .= '<script>'.$lib['data'].'</script>'."\n";				}				else if ($lib['group'] == FORUM_JS_GROUP_COUNTER)				{					$output_counter .= '<script>'.$lib['data'].'</script>'."\n";				}				else				{					$output_default .= "\n\t".'.wait(function () { '.$lib['data'].' })';				}				unset($libs[$key]);				continue;			}			else if ($lib['type'] == 'external' || $lib['type'] == 'file')			{				if ($lib['group'] == FORUM_JS_GROUP_SYSTEM)				{					$output_system .= '<script src="'.$lib['data'].'"'.(($lib['async']) ? " async" : "").(($lib['defer']) ? " defer=\"true\"" : "").'></script>'."\n";				}				else if ($lib['group'] == FORUM_JS_GROUP_COUNTER)				{					$output_counter .= '<script src="'.$lib['data'].'"'.(($lib['async']) ? " async" : "").(($lib['defer']) ? " defer=\"true\"" : "").'></script>'."\n";				}				else				{					$output_default .= "\n\t".'.script("'.$lib['data'].'")';				}				unset($libs[$key]);				continue;			}		}		// Wrap default to LABjs parameters		if ($output_default != '')		{			$output_default = '<script>'."\n\t".'$LAB.setOptions({AlwaysPreserveOrder:true})'.$output_default.';'."\n".'</script>';		}		($hook = get_hook('ld_fn_render_js_labjs_end')) ? eval($hook) : null;		return $output_system.$output_default.$output_counter;	}	// Sort libs	private static function sort_libs($a, $b)	{		$return = ($hook = get_hook('ld_fn_sort_libs_start')) ? eval($hook) : null;		if ($return != null)			return $return;		// 1. Sort by group  system first		if ($a['group'] < $b['group'])		{			return -1;		}		elseif ($a['group'] > $b['group'])		{			return 1;		}		// 2. Within a group, order all infrequently needed, page-specific files after		// common files needed throughout the website. Separating this way allows for		// the aggregate file generated for all of the common files to be reused		// across a site visit without being cut by a page using a less common file.		elseif ($a['every_page'] && !$b['every_page'])		{			return -1;		}		elseif (!$a['every_page'] && $b['every_page'])		{			return 1;		}		// 3. Sort by weight		elseif ($a['weight'] < $b['weight'])		{			return -1;		}		elseif ($a['weight'] > $b['weight'])		{		    return 1;		}		else		{			return 0;		}	}	// Try a get uri scheme (based on Drupal)	private function get_file_uri_scheme($uri)	{		$position = strpos($uri, '://');		return $position ? substr($uri, 0, $position) : FALSE;	}	//	private function encode_path($path)	{		return str_replace('%2F', '/', rawurlencode($path));	}	// Creates a web-accessible URL for local file. (based on Drupal)	private function create_url_from_file($uri)	{		global $base_url;		$scheme = $this->get_file_uri_scheme($uri);		if (!$scheme)		{		    // Allow for:		    // - root-relative URIs (e.g. /foo.jpg in http://example.com/foo.jpg)		    // - protocol-relative URIs (e.g. //bar.jpg, which is expanded to		    //   http://example.com/bar.jpg by the browser when viewing a page over		    //   HTTP and to https://example.com/bar.jpg when viewing a HTTPS page)		    // Both types of relative URIs are characterized by a leading slash, hence		    // we can use a single check.		    if (utf8_substr($uri, 0, 1) == '/')		    {				return $uri;		    }		    else		    {				// If this is not a properly formatted stream, then it is a shipped file.				// Therefore, return the urlencoded URI with the base URL prepended.				return $base_url.'/'.$this->encode_path($uri);		    }		}		else if ($scheme == 'http' || $scheme == 'https')		{			// Check for http so that we don't have to implement getExternalUrl() for			// the http wrapper.			return $uri;		}		else		{			return FALSE;		}	}	// Helper func for render_*  wrap lib in IE-conditional comments	private function check_conditional_comments($element, $data)	{		$return = ($hook = get_hook('ld_fn_check_conditional_comments_start')) ? eval($hook) : null;		if ($return != null)			return $return;		$browsers = (isset($element['browsers']) && is_array($element['browsers'])) ? $element['browsers'] : array();		$browsers += array('IE' => TRUE, '!IE' => TRUE);		// If rendering in all browsers, no need for conditional comments.		if ($browsers['IE'] === true && $browsers['!IE'])		{			return $data;		}		// Determine the conditional comment expression for Internet Explorer to evaluate.		if ($browsers['IE'] === TRUE)		{			$expression = 'IE';		}		elseif ($browsers['IE'] === FALSE)		{			$expression = '!IE';		}		else		{			$expression = $browsers['IE'];		}		if (!$browsers['!IE'])		{			// "downlevel-hidden".			$data = "\n<!--[if $expression]>".$data."<![endif]-->";		}		else		{		    // "downlevel-revealed".		    $data = "\n<!--[if $expression]><!-->".$data."<!--<![endif]-->";		}		return $data;	}}// Create the loader adapter object$forum_loader = Loader::singleton();?>
<?php// Language definitions used in the index page of the admin panel$lang_admin_index = array('Information head'				=>	'Welcome to PunBB administration control panel','Alerts'						=>	'Administrator Alerts','Check for updates enabled'		=>	'This board is setup to automatically check for updates and hotfixes against the punbb.informer.com updates service.','Check for updates manual'		=>	'Check for updates',	// Link text'Copyright message'				=>	'&copy; 2008-2011 <a href="http://punbb.informer.com/">PunBB</a>, partially based on code &copy; 2008-2009 <a href="http://fluxbb.org/">FluxBB</a>','PunBB version'					=>	'PunBB version','PunBB community'				=>	'Community','Forums'						=>	'Forums','Twitter'						=>	'Twitter','Development'					=>	'Development','Not available'					=>	'Not available','Not applicable'				=>	'N/A','Server load'					=>	'Server load','users online'					=>	'users online','Environment'					=>	'Environment','Operating system'				=>	'Operating system','Show info'						=>	'Show info','Accelerator'					=>	'Accelerator','Database'						=>	'Database','Rows'							=>	'Rows','Size'							=>	'Size','phpinfo disabled'				=>	'The PHP function phpinfo() has been disabled on this server.',);
<?php/** * A database layer class that relies on the SQLite PHP extension. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure we have built in support for SQLiteif (!class_exists('SQLite3'))	exit('This PHP environment doesn\'t have SQLite3 support built in. SQLite3 support is required if you want to use a SQLite3 database to run this forum. Consult the PHP documentation for further assistance.');class DBLayer{	var $prefix;	var $link_id;	var $query_result;	var $in_transaction = 0;	var $saved_queries = array();	var $num_queries = 0;	var $error_no = false;	var $error_msg = 'Unknown';	var $datatype_transformations = array(		'/^SERIAL$/'															=>	'INTEGER',		'/^(TINY|SMALL|MEDIUM|BIG)?INT( )?(\\([0-9]+\\))?( )?(UNSIGNED)?$/i'	=>	'INTEGER',		'/^(TINY|MEDIUM|LONG)?TEXT$/i'											=>	'TEXT'	);	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)	{		// Prepend $db_name with the path to the forum root directory		$db_name = FORUM_ROOT.$db_name;		$this->prefix = $db_prefix;		if (!file_exists($db_name))		{			@/**/touch($db_name);			@/**/chmod($db_name, 0666);			if (!file_exists($db_name))				error('Unable to create new database \''.$db_name.'\'. Permission denied.', __FILE__, __LINE__);		}		if (!is_readable($db_name))			error('Unable to open database \''.$db_name.'\' for reading. Permission denied.', __FILE__, __LINE__);		if (!is_writable($db_name))			error('Unable to open database \''.$db_name.'\' for writing. Permission denied.', __FILE__, __LINE__);		@/**/$this->link_id = new SQLite3($db_name, SQLITE3_OPEN_READWRITE);		if (!$this->link_id)			error('Unable to open database \''.$db_name.'\'.', __FILE__, __LINE__);		else			return $this->link_id;	}	function start_transaction()	{		++$this->in_transaction;		return ($this->link_id->exec('BEGIN TRANSACTION')) ? true : false;	}	function end_transaction()	{		--$this->in_transaction;		if ($this->link_id->exec('COMMIT'))			return true;		else		{			$this->link_id->exec('ROLLBACK');			return false;		}	}	function query($sql, $unbuffered = false)	{		if (strlen($sql) > 140000)			exit('Insane query. Aborting.');		if (defined('FORUM_SHOW_QUERIES'))			$q_start = forum_microtime();		$this->query_result = $this->link_id->query($sql);		if ($this->query_result)		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, sprintf('%.5f', forum_microtime() - $q_start));			++$this->num_queries;			return $this->query_result;		}		else		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, 0);			$this->error_no = $this->link_id->lastErrorCode();			$this->error_msg = $this->link_id->lastErrorMsg();			if ($this->in_transaction)				$this->link_id->exec('ROLLBACK');			--$this->in_transaction;			return false;		}	}	function query_build($query, $return_query_string = false, $unbuffered = false)	{		$sql = '';		if (isset($query['SELECT']))		{			$sql = 'SELECT '.$query['SELECT'].' FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['FROM'];			if (isset($query['JOINS']))			{				foreach ($query['JOINS'] as $cur_join)					$sql .= ' '.key($cur_join).' '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).current($cur_join).' ON '.$cur_join['ON'];			}			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];			if (!empty($query['GROUP BY']))				$sql .= ' GROUP BY '.$query['GROUP BY'];			if (!empty($query['HAVING']))				$sql .= ' HAVING '.$query['HAVING'];			if (!empty($query['ORDER BY']))				$sql .= ' ORDER BY '.$query['ORDER BY'];			if (!empty($query['LIMIT']))				$sql .= ' LIMIT '.$query['LIMIT'];		}		else if (isset($query['INSERT']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['INSERT']))				$sql .= ' ('.$query['INSERT'].')';			if (is_array($query['VALUES']))			{				$new_query = $query;				if ($return_query_string)				{					$query_set = array();					foreach ($query['VALUES'] as $cur_values)					{						$new_query['VALUES'] = $cur_values;						$query_set[] = $this->query_build($new_query, true, $unbuffered);					}					$sql = implode('; ', $query_set);				}				else				{					$result_set = null;					foreach ($query['VALUES'] as $cur_values)					{						$new_query['VALUES'] = $cur_values;						$result_set = $this->query_build($new_query, false, $unbuffered);					}					return $result_set;				}			}			else				$sql .= ' VALUES('.$query['VALUES'].')';		}		else if (isset($query['UPDATE']))		{			$query['UPDATE'] = (isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['UPDATE'];			$sql = 'UPDATE '.$query['UPDATE'].' SET '.$query['SET'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['DELETE']))		{			$sql = 'DELETE FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['DELETE'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['REPLACE']))		{			$sql = 'REPLACE INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['REPLACE']))				$sql .= ' ('.$query['REPLACE'].')';			$sql .= ' VALUES('.$query['VALUES'].')';		}		return ($return_query_string) ? $sql : $this->query($sql, $unbuffered);	}	function result($query_id = 0, $row = 0, $col = 0)	{		if ($query_id)		{			if ($row != 0)			{				$result_rows = array();				while ($cur_result_row = @/**/$query_id->fetchArray(SQLITE3_NUM))				{					$result_rows[] = $cur_result_row;				}				$cur_row = array_slice($result_rows, $row);			}			else				$cur_row = @/**/$query_id->fetchArray(SQLITE3_NUM);			return $cur_row[$col];		}		else			return false;	}	function fetch_assoc($query_id = 0)	{		if ($query_id)		{			$cur_row = @/**/$query_id->fetchArray(SQLITE3_ASSOC);			if ($cur_row)			{				// Horrible hack to get rid of table names and table aliases from the array keys				foreach ($cur_row as $key => $value)				{					$dot_spot = strpos($key, '.');					if ($dot_spot !== false)					{						unset($cur_row[$key]);						$key = substr($key, $dot_spot+1);						$cur_row[$key] = $value;					}				}			}			return $cur_row;		}		else			return false;	}	function fetch_row($query_id = 0)	{		return ($query_id) ? @/**/$query_id->fetchArray(SQLITE3_NUM) : false;	}	function num_rows($query_id = 0)	{		return false;	}	function affected_rows()	{		return ($this->query_result) ? $this->link_id->changes() : false;	}	function insert_id()	{		return ($this->link_id) ? $this->link_id->lastInsertRowID() : false;	}	function get_num_queries()	{		return $this->num_queries;	}	function get_saved_queries()	{		return $this->saved_queries;	}	function free_result($query_id = false)	{		if ($query_id)		{			@/**/$query_id->finalize();		}		return true;	}	function escape($str)	{		return is_array($str) ? '' : $this->link_id->escapeString($str);	}	function error()	{		$result['error_sql'] = @/**/current(@/**/end($this->saved_queries));		$result['error_no'] = $this->error_no;		$result['error_msg'] = $this->error_msg;		return $result;	}	function close()	{		if ($this->link_id)		{			if ($this->in_transaction)			{				if (defined('FORUM_SHOW_QUERIES'))					$this->saved_queries[] = array('COMMIT', 0);				$this->link_id->exec('COMMIT');			}			return @/**/$this->link_id->close();		}		else			return false;	}	function set_names($names)	{		return;	}	function get_version()	{		$info = SQLite3::version();		return array(			'name'		=> 'SQLite3',			'version'	=> $info['versionString']		);	}	function table_exists($table_name, $no_prefix = false)	{		$result = $this->query('SELECT COUNT(type) FROM sqlite_master WHERE name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND type=\'table\'');		return (intval($this->result($result)) > 0);	}	function field_exists($table_name, $field_name, $no_prefix = false)	{		$result = $this->query('SELECT sql FROM sqlite_master WHERE name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND type=\'table\'');		$sql = $this->result($result);		if (is_null($sql) || $sql === false)			return false;		return (preg_match('/[\r\n]'.preg_quote($field_name).' /', $sql) === 1);	}	function index_exists($table_name, $index_name, $no_prefix = false)	{		$result = $this->query('SELECT COUNT(type) FROM sqlite_master WHERE tbl_name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_'.$this->escape($index_name).'\' AND type=\'index\'');		return (intval($this->result($result)) > 0);	}	function create_table($table_name, $schema, $no_prefix = false)	{		if ($this->table_exists($table_name, $no_prefix))			return;		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";		// Go through every schema element and add it to the query		foreach ($schema['FIELDS'] as $field_name => $field_data)		{			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);			$query .= $field_name.' '.$field_data['datatype'];			if (!$field_data['allow_null'])				$query .= ' NOT NULL';			if (isset($field_data['default']))				$query .= ' DEFAULT '.$field_data['default'];			$query .= ",\n";		}		// If we have a primary key, add it		if (isset($schema['PRIMARY KEY']))			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";		// Add unique keys		if (isset($schema['UNIQUE KEYS']))		{			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)				$query .= 'UNIQUE ('.implode(',', $key_fields).'),'."\n";		}		// We remove the last two characters (a newline and a comma) and add on the ending		$query = substr($query, 0, strlen($query) - 2)."\n".')';		$this->query($query) or error(__FILE__, __LINE__);		// Add indexes		if (isset($schema['INDEXES']))		{			foreach ($schema['INDEXES'] as $index_name => $index_fields)				$this->add_index($table_name, $index_name, $index_fields, false, $no_prefix);		}	}	function drop_table($table_name, $no_prefix = false)	{		if (!$this->table_exists($table_name, $no_prefix))			return;		$this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) or error(__FILE__, __LINE__);	}	function get_table_info($table_name, $no_prefix = false)	{		// Grab table info		$result = $this->query('SELECT sql FROM sqlite_master WHERE tbl_name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' ORDER BY type DESC') or error(__FILE__, __LINE__);		$table = array();		$table['indices'] = array();		$num_rows = 0;		while ($cur_index = $this->fetch_assoc($result))		{			if (!isset($table['sql']))				$table['sql'] = $cur_index['sql'];			else				$table['indices'][] = $cur_index['sql'];			++$num_rows;		}		// Check for empty		if ($num_rows < 1)			return;		// Work out the columns in the table currently		$table_lines = explode("\n", $table['sql']);		$table['columns'] = array();		foreach ($table_lines as $table_line)		{			$table_line = forum_trim($table_line);			if (substr($table_line, 0, 12) == 'CREATE TABLE')				continue;			else if (substr($table_line, 0, 11) == 'PRIMARY KEY')				$table['primary_key'] = $table_line;			else if (substr($table_line, 0, 6) == 'UNIQUE')				$table['unique'] = $table_line;			else if (substr($table_line, 0, strpos($table_line, ' ')) != '')				$table['columns'][substr($table_line, 0, strpos($table_line, ' '))] = forum_trim(substr($table_line, strpos($table_line, ' ')));		}		return $table;	}	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = 0, $no_prefix = false)	{		if ($this->field_exists($table_name, $field_name, $no_prefix))			return;		$table = $this->get_table_info($table_name, $no_prefix);		// Create temp table		$now = time();		$tmptable = str_replace('CREATE TABLE '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).' (', 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_t'.$now.' (', $table['sql']);		$this->query($tmptable) or error(__FILE__, __LINE__);		$this->query('INSERT INTO '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_t'.$now.' SELECT * FROM '.($no_prefix ? '' : $this->prefix).$this->escape($table_name)) or error(__FILE__, __LINE__);		// Create new table sql		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		$query = $field_type;		if (!$allow_null)			$query .= ' NOT NULL';		if ($default_value === null || $default_value === '')			$default_value = '\'\'';		$query .= ' DEFAULT '.$default_value;		$old_columns = array_keys($table['columns']);		array_insert($table['columns'], $after_field, $query.',', $field_name);		$new_table = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).' (';		foreach ($table['columns'] as $cur_column => $column_details)			$new_table .= "\n".$cur_column.' '.$column_details;		if (isset($table['unique']))			$new_table .= "\n".$table['unique'].',';		if (isset($table['primary_key']))			$new_table .= "\n".$table['primary_key'];		$new_table = trim($new_table, ',')."\n".');';		// Drop old table		$this->drop_table($table_name, $no_prefix);		// Create new table		$this->query($new_table) or error(__FILE__, __LINE__);		// Recreate indexes		if (!empty($table['indices']))		{			foreach ($table['indices'] as $cur_index)				$this->query($cur_index) or error(__FILE__, __LINE__);		}		//Copy content back		$this->query('INSERT INTO '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).' ('.implode(', ', $old_columns).') SELECT * FROM '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_t'.$now) or error(__FILE__, __LINE__);		// Drop temp table		$this->drop_table($table_name.'_t'.$now, $no_prefix);	}	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = 0, $no_prefix = false)	{		return;	}	function drop_field($table_name, $field_name, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$table = $this->get_table_info($table_name, $no_prefix);		// Create temp table		$now = time();		$tmptable = str_replace('CREATE TABLE '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).' (', 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_t'.$now.' (', $table['sql']);		$this->query($tmptable) or error(__FILE__, __LINE__);		$this->query('INSERT INTO '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_t'.$now.' SELECT * FROM '.($no_prefix ? '' : $this->prefix).$this->escape($table_name)) or error(__FILE__, __LINE__);		// Work out the columns we need to keep and the sql for the new table		unset($table['columns'][$field_name]);		$new_columns = array_keys($table['columns']);		$new_table = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).' (';		foreach ($table['columns'] as $cur_column => $column_details)			$new_table .= "\n".$cur_column.' '.$column_details;		if (isset($table['unique']))			$new_table .= "\n".$table['unique'].',';		if (isset($table['primary_key']))			$new_table .= "\n".$table['primary_key'];		$new_table = trim($new_table, ',')."\n".');';		// Drop old table		$this->drop_table($table_name, $no_prefix);		// Create new table		$this->query($new_table) or error(__FILE__, __LINE__);		// Recreate indexes		if (!empty($table['indices']))		{			foreach ($table['indices'] as $cur_index)				if (!preg_match('#\(.*'.$field_name.'.*\)#', $cur_index))					$this->query($cur_index) or error(__FILE__, __LINE__);		}		//Copy content back		$this->query('INSERT INTO '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).' SELECT '.implode(', ', $new_columns).' FROM '.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_t'.$now) or error(__FILE__, __LINE__);		// Drop temp table		$this->drop_table($table_name.'_t'.$now, $no_prefix);	}	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)	{		if ($this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('CREATE '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ON '.($no_prefix ? '' : $this->prefix).$table_name.'('.implode(',', $index_fields).')') or error(__FILE__, __LINE__);	}	function drop_index($table_name, $index_name, $no_prefix = false)	{		if (!$this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) or error(__FILE__, __LINE__);	}}
<?php/** * Ban management page. * * Allows administrators and moderators to create, modify, and delete bans. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('aba_start')) ? eval($hook) : null;if ($forum_user['g_id'] != FORUM_ADMIN && ($forum_user['g_moderator'] != '1' || $forum_user['g_mod_ban_users'] == '0'))	message($lang_common['No permission']);// Load the admin.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_bans.php';// Add/edit a ban (stage 1)if (isset($_REQUEST['add_ban']) || isset($_GET['edit_ban'])){	if (isset($_GET['add_ban']) || isset($_POST['add_ban']))	{		// If the id of the user to ban was provided through GET (a link from profile.php)		if (isset($_GET['add_ban']))		{			$add_ban = intval($_GET['add_ban']);			if ($add_ban < 2)				message($lang_common['Bad request']);			$user_id = $add_ban;			($hook = get_hook('aba_add_ban_selected')) ? eval($hook) : null;			$query = array(				'SELECT'	=> 'u.group_id, u.username, u.email, u.registration_ip',				'FROM'		=> 'users AS u',				'WHERE'		=> 'u.id='.$user_id			);			($hook = get_hook('aba_add_ban_qr_get_user_by_id')) ? eval($hook) : null;			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);			$banned_user_info = $forum_db->fetch_row($result);			if (!$banned_user_info)			{				message($lang_admin_bans['No user id message']);			}			list($group_id, $ban_user, $ban_email, $ban_ip) = $banned_user_info;		}		else	// Otherwise the username is in POST		{			$ban_user = forum_trim($_POST['new_ban_user']);			($hook = get_hook('aba_add_ban_form_submitted')) ? eval($hook) : null;			if ($ban_user != '')			{				$query = array(					'SELECT'	=> 'u.id, u.group_id, u.username, u.email, u.registration_ip',					'FROM'		=> 'users AS u',					'WHERE'		=> 'u.username=\''.$forum_db->escape($ban_user).'\' AND u.id>1'				);				($hook = get_hook('aba_add_ban_qr_get_user_by_username')) ? eval($hook) : null;				$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);				$banned_user_info = $forum_db->fetch_row($result);				if (!$banned_user_info)				{					message($lang_admin_bans['No user username message']);				}				list($user_id, $group_id, $ban_user, $ban_email, $ban_ip) = $banned_user_info;			}		}		// Make sure we're not banning an admin		if (isset($group_id) && $group_id == FORUM_ADMIN)			message($lang_admin_bans['User is admin message']);		// If we have a $user_id, we can try to find the last known IP of that user		if (isset($user_id))		{			$query = array(				'SELECT'	=> 'p.poster_ip',				'FROM'		=> 'posts AS p',				'WHERE'		=> 'p.poster_id='.$user_id,				'ORDER BY'	=> 'p.posted DESC',				'LIMIT'		=> '1'			);			($hook = get_hook('aba_add_ban_qr_get_last_known_ip')) ? eval($hook) : null;			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);			$ban_ip_from_db = $forum_db->result($result);			if ($ban_ip_from_db)			{				$ban_ip = $ban_ip_from_db;			}		}		$mode = 'add';	}	else	// We are editing a ban	{		$ban_id = intval($_GET['edit_ban']);		if ($ban_id < 1)			message($lang_common['Bad request']);		($hook = get_hook('aba_edit_ban_selected')) ? eval($hook) : null;		$query = array(			'SELECT'	=> 'b.username, b.ip, b.email, b.message, b.expire',			'FROM'		=> 'bans AS b',			'WHERE'		=> 'b.id='.$ban_id		);		($hook = get_hook('aba_edit_ban_qr_get_ban_data')) ? eval($hook) : null;		$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);		$banned_user_info = $forum_db->fetch_row($result);		if (!$banned_user_info)		{			message($lang_common['Bad request']);		}		list($ban_user, $ban_ip, $ban_email, $ban_message, $ban_expire) = $banned_user_info;		// We just use GMT for expire dates, as its a date rather than a day I don't think its worth worrying about		$ban_expire = ($ban_expire != '') ? gmdate('Y-m-d', $ban_expire) : '';		$mode = 'edit';	}	// Setup the form	$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;	// Setup breadcrumbs	$forum_page['crumbs'] = array(		array($forum_config['o_board_title'], forum_link($forum_url['index'])),		array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index']))	);	if ($forum_user['g_id'] == FORUM_ADMIN)		$forum_page['crumbs'][] = array($lang_admin_common['Users'], forum_link($forum_url['admin_users']));	$forum_page['crumbs'][] = array($lang_admin_common['Bans'], forum_link($forum_url['admin_bans']));	$forum_page['crumbs'][] = $lang_admin_bans['Ban advanced'];	($hook = get_hook('aba_add_edit_ban_pre_header_load')) ? eval($hook) : null;	define('FORUM_PAGE_SECTION', 'users');	define('FORUM_PAGE', 'admin-bans');	require FORUM_ROOT.'header.php';	// START SUBST - <!-- forum_main -->	ob_start();	($hook = get_hook('aba_add_edit_ban_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_bans['Ban advanced heading'] ?></span></h2>	</div>	<div class="main-content main-frm">		<div class="ct-box warn-box">			<p class="warn"><?php echo $lang_admin_bans['Ban IP warning'] ?></p>		</div>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_bans']) ?>">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_bans'])) ?>" />				<input type="hidden" name="mode" value="<?php echo $mode ?>" /><?php if ($mode == 'edit'): ?>				<input type="hidden" name="ban_id" value="<?php echo $ban_id ?>" /><?php endif; ?>			</div><?php ($hook = get_hook('aba_add_edit_ban_pre_criteria_fieldset')) ? eval($hook) : null; ?>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_bans['Ban criteria legend'] ?></span></legend><?php ($hook = get_hook('aba_add_edit_ban_pre_username')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Username to ban label'] ?></span></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_user" size="40" maxlength="25" value="<?php if (isset($ban_user)) echo forum_htmlencode($ban_user); ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_email')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['E-mail/domain to ban label'] ?></span> <small><?php echo $lang_admin_bans['E-mail/domain help'] ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_email" size="40" maxlength="80" value="<?php if (isset($ban_email)) echo forum_htmlencode(strtolower($ban_email)); ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_ip')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['IP-addresses to ban label'] ?></span> <small><?php echo $lang_admin_bans['IP-addresses help']; if ($ban_user != '' && isset($user_id)) echo ' '.$lang_admin_bans['IP-addresses help stats'].'<a href="'.forum_link($forum_url['admin_users']).'?ip_stats='.$user_id.'">'.$lang_admin_bans['IP-addresses help link'].'</a>' ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_ip" size="40" maxlength="255" value="<?php if (isset($ban_ip)) echo $ban_ip; ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_message')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Ban message label'] ?></span> <small><?php echo $lang_admin_bans['Ban message help'] ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_message" size="40" maxlength="255" value="<?php if (isset($ban_message)) echo forum_htmlencode($ban_message); ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_pre_expire')) ? eval($hook) : null; ?>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Expire date label'] ?></span> <small><?php echo $lang_admin_bans['Expire date help'] ?></small></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="ban_expire" size="20" maxlength="10" value="<?php if (isset($ban_expire)) echo $ban_expire; ?>" /></span>					</div>				</div><?php ($hook = get_hook('aba_add_edit_ban_criteria_pre_fieldset_end')) ? eval($hook) : null; ?>			</fieldset><?php ($hook = get_hook('aba_add_edit_ban_criteria_fieldset_end')) ? eval($hook) : null; ?>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="add_edit_ban" value=" <?php echo $lang_admin_bans['Save ban'] ?>" /></span>			</div>		</form>	</div><?php	($hook = get_hook('aba_add_edit_ban_end')) ? eval($hook) : null;	$tpl_temp = forum_trim(ob_get_contents());	$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);	ob_end_clean();	// END SUBST - <!-- forum_main -->	require FORUM_ROOT.'footer.php';}// Add/edit a ban (stage 2)else if (isset($_POST['add_edit_ban'])){	$ban_user = forum_trim($_POST['ban_user']);	$ban_ip = forum_trim($_POST['ban_ip']);	$ban_email = strtolower(forum_trim($_POST['ban_email']));	$ban_message = forum_trim($_POST['ban_message']);	$ban_expire = forum_trim($_POST['ban_expire']);	if ($ban_user == '' && $ban_ip == '' && $ban_email == '')		message($lang_admin_bans['Must enter message']);	else if (strtolower($ban_user) == 'guest')		message($lang_admin_bans['Can\'t ban guest user']);	($hook = get_hook('aba_add_edit_ban_form_submitted')) ? eval($hook) : null;	// Validate IP/IP range (it's overkill, I know)	if ($ban_ip != '')	{		$ban_ip = preg_replace('/[\s]{2,}/', ' ', $ban_ip);		$addresses = explode(' ', $ban_ip);		$addresses = array_map('trim', $addresses);		for ($i = 0; $i < count($addresses); ++$i)		{			if (strpos($addresses[$i], ':') !== false)			{				$octets = explode(':', $addresses[$i]);				for ($c = 0; $c < count($octets); ++$c)				{					$octets[$c] = ltrim($octets[$c], "0");					if ($c > 7 || (!empty($octets[$c]) && !ctype_xdigit($octets[$c])) || intval($octets[$c], 16) > 65535)						message($lang_admin_bans['Invalid IP message']);				}				$cur_address = implode(':', $octets);				$addresses[$i] = $cur_address;			}			else			{				$octets = explode('.', $addresses[$i]);				for ($c = 0; $c < count($octets); ++$c)				{					$octets[$c] = (strlen($octets[$c]) > 1) ? ltrim($octets[$c], "0") : $octets[$c];					if ($c > 3 || !ctype_digit($octets[$c]) || intval($octets[$c]) > 255)						message($lang_admin_bans['Invalid IP message']);				}				$cur_address = implode('.', $octets);				$addresses[$i] = $cur_address;			}		}		$ban_ip = implode(' ', $addresses);	}	if (!defined('FORUM_EMAIL_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/email.php';	if ($ban_email != '' && !is_valid_email($ban_email))	{		if (!preg_match('/^[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/', $ban_email))			message($lang_admin_bans['Invalid e-mail message']);	}	if ($ban_expire != '' && $ban_expire != 'Never')	{		$ban_expire = strtotime($ban_expire);		if ($ban_expire == -1 || $ban_expire <= time())			message($lang_admin_bans['Invalid expire message']);	}	else		$ban_expire = 'NULL';	$ban_user = ($ban_user != '') ? '\''.$forum_db->escape($ban_user).'\'' : 'NULL';	$ban_ip = ($ban_ip != '') ? '\''.$forum_db->escape($ban_ip).'\'' : 'NULL';	$ban_email = ($ban_email != '') ? '\''.$forum_db->escape($ban_email).'\'' : 'NULL';	$ban_message = ($ban_message != '') ? '\''.$forum_db->escape($ban_message).'\'' : 'NULL';	if ($_POST['mode'] == 'add')	{		$query = array(			'INSERT'	=> 'username, ip, email, message, expire, ban_creator',			'INTO'		=> 'bans',			'VALUES'	=> $ban_user.', '.$ban_ip.', '.$ban_email.', '.$ban_message.', '.$ban_expire.', '.$forum_user['id']		);		($hook = get_hook('aba_add_edit_ban_qr_add_ban')) ? eval($hook) : null;		$forum_db->query_build($query) or error(__FILE__, __LINE__);	}	else	{		$query = array(			'UPDATE'	=> 'bans',			'SET'		=> 'username='.$ban_user.', ip='.$ban_ip.', email='.$ban_email.', message='.$ban_message.', expire='.$ban_expire,			'WHERE'		=> 'id='.intval($_POST['ban_id'])		);		($hook = get_hook('aba_qr_update_ban')) ? eval($hook) : null;		$forum_db->query_build($query) or error(__FILE__, __LINE__);	}	// Regenerate the bans cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_bans_cache();	($hook = get_hook('aba_add_edit_ban_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_bans']), (($_POST['mode'] == 'edit') ? $lang_admin_bans['Ban edited'] : $lang_admin_bans['Ban added']));}// Remove a banelse if (isset($_GET['del_ban'])){	$ban_id = intval($_GET['del_ban']);	if ($ban_id < 1)		message($lang_common['Bad request']);	// Validate the CSRF token	if (!isset($_POST['csrf_token']) && (!isset($_GET['csrf_token']) || $_GET['csrf_token'] !== generate_form_token('del_ban'.$ban_id)))		csrf_confirm_form();	($hook = get_hook('aba_del_ban_form_submitted')) ? eval($hook) : null;	$query = array(		'DELETE'	=> 'bans',		'WHERE'		=> 'id='.$ban_id	);	($hook = get_hook('aba_del_ban_qr_delete_ban')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the bans cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_bans_cache();	($hook = get_hook('aba_del_ban_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_bans']), $lang_admin_bans['Ban removed'].' '. $lang_admin_common['Redirect']);}// Setup the form$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;$forum_page['form_action'] = forum_link($forum_url['admin_bans']).'&amp;action=more';$forum_page['hidden_fields'] = array(	'csrf_token'	=> '<input type="hidden" name="csrf_token" value="'.generate_form_token($forum_page['form_action']).'" />');// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])));if ($forum_user['g_id'] == FORUM_ADMIN)	$forum_page['crumbs'][] = array($lang_admin_common['Users'], forum_link($forum_url['admin_users']));$forum_page['crumbs'][] = array($lang_admin_common['Bans'], forum_link($forum_url['admin_bans']));// Fetch user count$query = array(	'SELECT'	=>	'COUNT(id)',	'FROM'		=>	'bans');$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$forum_page['num_bans'] = $forum_db->result($result);$forum_page['num_pages'] = ceil($forum_page['num_bans'] / $forum_user['disp_topics']);$forum_page['page'] = (!isset($_GET['p']) || !is_numeric($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $forum_page['num_pages']) ? 1 : intval($_GET['p']);$forum_page['start_from'] = $forum_user['disp_topics'] * ($forum_page['page'] - 1);$forum_page['finish_at'] = min(($forum_page['start_from'] + $forum_user['disp_topics']), ($forum_page['num_bans']));// Generate paging$forum_page['page_post']['paging']='<p class="paging"><span class="pages">'.$lang_common['Pages'].'</span> '.paginate($forum_page['num_pages'], $forum_page['page'], $forum_url['admin_bans'], $lang_common['Paging separator'], null, true).'</p>';// Navigation links for header and page numbering for title/meta descriptionif ($forum_page['page'] < $forum_page['num_pages']){	$forum_page['nav']['last'] = '<link rel="last" href="'.forum_sublink($forum_url['admin_bans'], $forum_url['page'], $forum_page['num_pages']).'" title="'.$lang_common['Page'].' '.$forum_page['num_pages'].'" />';	$forum_page['nav']['next'] = '<link rel="next" href="'.forum_sublink($forum_url['admin_bans'], $forum_url['page'], ($forum_page['page'] + 1)).'" title="'.$lang_common['Page'].' '.($forum_page['page'] + 1).'" />';}if ($forum_page['page'] > 1){	$forum_page['nav']['prev'] = '<link rel="prev" href="'.forum_sublink($forum_url['admin_bans'], $forum_url['page'], ($forum_page['page'] - 1)).'" title="'.$lang_common['Page'].' '.($forum_page['page'] - 1).'" />';	$forum_page['nav']['first'] = '<link rel="first" href="'.forum_link($forum_url['admin_bans']).'" title="'.$lang_common['Page'].' 1" />';}($hook = get_hook('aba_pre_header_load')) ? eval($hook) : null;define('FORUM_PAGE_SECTION', 'users');define('FORUM_PAGE', 'admin-bans');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('aba_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_bans['New ban heading'] ?></span></h2>	</div>	<div class="main-content main-frm">		<div class="ct-box">			<p><?php echo $lang_admin_bans['Advanced ban info'] ?></p>		</div>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo $forum_page['form_action'] ?>">			<div class="hidden">				<?php echo implode("\n\t\t\t\t", $forum_page['hidden_fields'])."\n" ?>			</div>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><strong><?php echo $lang_admin_bans['New ban legend'] ?></strong></legend>				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">					<div class="sf-box text">						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_bans['Username to ban label'] ?></span></label><br />						<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="new_ban_user" size="25" maxlength="25" /></span>					</div>				</div>			</fieldset>			<div class="frm-buttons">				<span class="submit"><input type="submit" name="add_ban" value=" <?php echo $lang_admin_bans['Add ban'] ?> " /></span>			</div>		</form>	</div><?php// Reset counters$forum_page['group_count'] = $forum_page['item_count'] = 0;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_bans['Existing bans heading'] ?></span></h2>	</div>	<div class="main-content main-frm"><?phpif ($forum_page['num_bans'] > 0){?>		<div class="ct-group"><?php	// Grab the bans	$query = array(		'SELECT'	=> 'b.*, u.username AS ban_creator_username',		'FROM'		=> 'bans AS b',		'JOINS'		=> array(			array(				'LEFT JOIN'		=> 'users AS u',				'ON'			=> 'u.id=b.ban_creator'			)		),		'ORDER BY'	=> 'b.id',		'LIMIT'		=> $forum_page['start_from'].', '.$forum_page['finish_at']	);	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$forum_page['item_num'] = 0;	while ($cur_ban = $forum_db->fetch_assoc($result))	{		$forum_page['ban_info'] = array();		$forum_page['ban_creator'] = ($cur_ban['ban_creator_username'] != '') ? '<a href="'.forum_link($forum_url['user'], $cur_ban['ban_creator']).'">'.forum_htmlencode($cur_ban['ban_creator_username']).'</a>' : $lang_admin_common['Unknown'];		if ($cur_ban['username'] != '')			$forum_page['ban_info']['username'] = '<li><span>'.$lang_admin_bans['Username'].'</span> <strong>'.forum_htmlencode($cur_ban['username']).'</strong></li>';		if ($cur_ban['email'] != '')			$forum_page['ban_info']['email'] = '<li><span>'.$lang_admin_bans['E-mail'].'</span> <strong>'.forum_htmlencode($cur_ban['email']).'</strong></li>';		if ($cur_ban['ip'] != '')			$forum_page['ban_info']['ip'] = '<li><span>'.$lang_admin_bans['IP-ranges'].'</span> <strong>'.$cur_ban['ip'].'</strong></li>';		if ($cur_ban['expire'] != '')			$forum_page['ban_info']['expire'] = '<li><span>'.$lang_admin_bans['Expires'].'</span> <strong>'.format_time($cur_ban['expire'], 1).'</strong></li>';		if ($cur_ban['message'] != '')			$forum_page['ban_info']['message'] ='<li><span>'.$lang_admin_bans['Message'].'</span> <strong>'.forum_htmlencode($cur_ban['message']).'</strong></li>';		($hook = get_hook('aba_view_ban_pre_display')) ? eval($hook) : null;?>			<div class="ct-set set<?php echo ++$forum_page['item_num'] ?>">				<div class="ct-box">					<div class="ct-legend">						<h3 class=""><span><?php printf($lang_admin_bans['Current ban head'], $forum_page['ban_creator']) ?></span></h3>						<p><?php printf($lang_admin_bans['Edit or remove'], '<a href="'.forum_link($forum_url['admin_bans']).'&amp;edit_ban='.$cur_ban['id'].'">'.$lang_admin_bans['Edit ban'].'</a>', '<a href="'.forum_link($forum_url['admin_bans']).'&amp;del_ban='.$cur_ban['id'].'&amp;csrf_token='.generate_form_token('del_ban'.$cur_ban['id']).'">'.$lang_admin_bans['Remove ban'].'</a>') ?></p>					</div><?php if (!empty($forum_page['ban_info'])): ?>				<ul>					<?php echo implode("\n", $forum_page['ban_info'])."\n" ?>					</ul><?php endif; ?>				</div>			</div><?php	}?>		</div><?php}else{?>		<div class="ct-box">			<p><?php echo $lang_admin_bans['No bans'] ?></p>		</div><?php}?>	</div><?php($hook = get_hook('aba_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->require FORUM_ROOT.'footer.php';
<?php/*** @version $Id: core.php,v 1.5 2006/02/28 22:12:25 harryf Exp $* @package utf8* @subpackage strings*//*** Define UTF8_CORE as required*/if ( !defined('UTF8_CORE') ) {    define('UTF8_CORE',TRUE);}//--------------------------------------------------------------------/*** Wrapper round mb_strlen* Assumes you have mb_internal_encoding to UTF-8 already* Note: this function does not count bad bytes in the string - these* are simply ignored* @param string UTF-8 string* @return int number of UTF-8 characters in string* @package utf8* @subpackage strings*/function utf8_strlen($str){    return mb_strlen($str);}//--------------------------------------------------------------------/*** Assumes mbstring internal encoding is set to UTF-8* Wrapper around mb_strpos* Find position of first occurrence of a string* @param string haystack* @param string needle (you should validate this with utf8_is_valid)* @param integer offset in characters (from left)* @return mixed integer position or FALSE on failure* @package utf8* @subpackage strings*/function utf8_strpos($str, $search, $offset = FALSE){    if ( $offset === FALSE ) {        return mb_strpos($str, $search);    } else {        return mb_strpos($str, $search, $offset);    }}//--------------------------------------------------------------------/*** Assumes mbstring internal encoding is set to UTF-8* Wrapper around mb_strrpos* Find position of last occurrence of a char in a string* @param string haystack* @param string needle (you should validate this with utf8_is_valid)* @param integer (optional) offset (from left)* @return mixed integer position or FALSE on failure* @package utf8* @subpackage strings*/function utf8_strrpos($str, $search, $offset = FALSE){    if ( $offset === FALSE ) {        # Emulate behaviour of strrpos rather than raising warning        if ( empty($str) ) {            return FALSE;        }        return mb_strrpos($str, $search);    } else {        if ( !is_int($offset) ) {            trigger_error('utf8_strrpos expects parameter 3 to be long',E_USER_WARNING);            return FALSE;        }        $str = mb_substr($str, $offset);        if ( FALSE !== ( $pos = mb_strrpos($str, $search) ) ) {            return $pos + $offset;        }        return FALSE;    }}//--------------------------------------------------------------------/*** Assumes mbstring internal encoding is set to UTF-8* Wrapper around mb_substr* Return part of a string given character offset (and optionally length)* @param string* @param integer number of UTF-8 characters offset (from left)* @param integer (optional) length in UTF-8 characters from offset* @return mixed string or FALSE if failure* @package utf8* @subpackage strings*/function utf8_substr($str, $offset, $length = FALSE){    if ( $length === FALSE ) {        return mb_substr($str, $offset);    } else {        return mb_substr($str, $offset, $length);    }}//--------------------------------------------------------------------/*** Assumes mbstring internal encoding is set to UTF-8* Wrapper around mb_strtolower* Make a string lowercase* Note: The concept of a characters "case" only exists is some alphabets* such as Latin, Greek, Cyrillic, Armenian and archaic Georgian - it does* not exist in the Chinese alphabet, for example. See Unicode Standard* Annex #21: Case Mappings* @param string* @return mixed either string in lowercase or FALSE is UTF-8 invalid* @package utf8* @subpackage strings*/function utf8_strtolower($str){    return mb_strtolower($str);}//--------------------------------------------------------------------/*** Assumes mbstring internal encoding is set to UTF-8* Wrapper around mb_strtoupper* Make a string uppercase* Note: The concept of a characters "case" only exists is some alphabets* such as Latin, Greek, Cyrillic, Armenian and archaic Georgian - it does* not exist in the Chinese alphabet, for example. See Unicode Standard* Annex #21: Case Mappings* @param string* @return mixed either string in lowercase or FALSE is UTF-8 invalid* @package utf8* @subpackage strings*/function utf8_strtoupper($str){    return mb_strtoupper($str);}
<?php// Language definitions used in all admin files$lang_admin_bans = array('Ban advanced'					=>	'Ban advanced settings','Ban advanced heading'			=>	'Ban by username with IP and email or just ban by IP, by email or both','Ban criteria legend'			=>	'Ban criteria','Ban settings legend'			=>	'Ban settings','Ban IP warning'				=>	'<strong>Warning!</strong> You should be very careful when banning an IP-range because of the possibility of multiple users matching the same partial IP.','Current ban head'				=>	'Banned by %s','Username'						=>	'Username:','Username to ban label'			=>	'Username to ban','Ban creator'					=>	'Ban creator','IP-addresses to ban label'		=>	'IP-addresses to ban','IP-addresses help'				=>	'The IP or IP-ranges you wish to ban (e.g. 150.11.110.1 or 150.11.110). Separate addresses with spaces. If an IP is entered already it is the last known IP of this user in the database.','IP-addresses help stats'		=>	'Click the following link to see IP statistics for this user: ','IP-addresses help link'		=>	'User IP statistics','E-mail/domain to ban label'	=>	'Email or domain to ban','E-mail/domain help'			=>	'The email or email domain you wish to ban (e.g. someone@example.com or example.com). See "Allow registration with banned email addresses" in Settings/Registration for more info.','Ban message label'				=>	'Ban message','Ban message help'				=>	'Displayed to the banned user when he/she visits the forums','Expire date label'				=>	'Ban expiry date','Expire date help'				=>	'The date when this ban should be automatically removed (format: YYYY-MM-DD). Leave blank to remove manually.','Expires'						=>	'Expires:','Message'						=>	'Message:','New ban heading'				=>	'Ban specified username','New ban legend'				=>	'New ban','Advanced ban info'				=>	'The next page will let you enter a custom IP and email. If you just want to ban a specific IP/IP-range or email just leave the username on this page blank.','Existing bans heading'			=>	'Edit or remove existing bans','Add ban'						=>	'Add ban','Save ban'						=>	'Save ban','E-mail'						=>	'Email:','IP-ranges'						=>	'IP/IP-ranges:','Reason'						=>	'Reason','No bans'						=>	'No bans in list.','Edit ban'						=>	'Edit ban','Remove ban'					=>	'Remove ban','Edit or remove'				=>	'%s or %s','Ban removed'					=>	'Ban removed.','Ban added'						=>	'Ban added.','Ban edited'					=>	'Ban edited.','No user id message'			=>	'No user by that ID registered.','No user username message'		=>	'No user by that username registered. If you want to add a ban not tied to a specific username just leave the username blank.','User is admin message'			=>	'The user is an administrator and can\'t be banned. If you want to ban an administrator, you must first move him/her to any other user group.','Must enter message'			=>	'You must enter at least one of the following pieces of information: a username, an IP address or an email address.','Invalid IP message'			=>	'You entered an invalid IP/IP-range.','Can\'t ban guest user'			=>	'The guest user cannot be banned.','Invalid e-mail message'		=>	'The email address (e.g. user@example.com) or partial email address domain (e.g. example.com) you entered is invalid.','Invalid expire message'		=>	'You entered an invalid expire date. The format should be YYYY-MM-DD and the date must be at least one day in the future.',);
<?php/*** Tools to help with ASCII in UTF-8* @version $Id: ascii.php,v 1.5 2006/10/16 20:38:12 harryf Exp $* @package utf8* @subpackage ascii*///--------------------------------------------------------------------/*** Tests whether a string contains only 7bit ASCII bytes.* You might use this to conditionally check whether a string* needs handling as UTF-8 or not, potentially offering performance* benefits by using the native PHP equivalent if it's just ASCII e.g.;** <code>* if ( utf8_is_ascii($someString) ) {*     // It's just ASCII - use the native PHP version*     $someString = strtolower($someString);* } else {*     $someString = utf8_strtolower($someString);* }* </code>* * @param string* @return boolean TRUE if it's all ASCII* @package utf8* @subpackage ascii* @see utf8_is_ascii_ctrl*/function utf8_is_ascii($str) {    // Search for any bytes which are outside the ASCII range...    return (preg_match('/(?:[^\x00-\x7F])/',$str) !== 1);}//--------------------------------------------------------------------/*** Tests whether a string contains only 7bit ASCII bytes with device* control codes omitted. The device control codes can be found on the* second table here: http://www.w3schools.com/tags/ref_ascii.asp* * @param string* @return boolean TRUE if it's all ASCII without device control codes* @package utf8* @subpackage ascii* @see utf8_is_ascii*/function utf8_is_ascii_ctrl($str) {    if ( strlen($str) > 0 ) {        // Search for any bytes which are outside the ASCII range,        // or are device control codes        return (preg_match('/[^\x09\x0A\x0D\x20-\x7E]/',$str) !== 1);    }    return FALSE;}//--------------------------------------------------------------------/*** Strip out all non-7bit ASCII bytes* If you need to transmit a string to system which you know can only* support 7bit ASCII, you could use this function.* @param string* @return string with non ASCII bytes removed* @package utf8* @subpackage ascii* @see utf8_strip_non_ascii_ctrl*/function utf8_strip_non_ascii($str) {    ob_start();    while ( preg_match(        '/^([\x00-\x7F]+)|([^\x00-\x7F]+)/S',            $str, $matches) ) {        if ( !isset($matches[2]) ) {            echo $matches[0];        }        $str = substr($str, strlen($matches[0]));    }    $result = ob_get_contents();    ob_end_clean();    return $result;}//--------------------------------------------------------------------/*** Strip out device control codes in the ASCII range* which are not permitted in XML. Note that this leaves* multi-byte characters untouched - it only removes device* control codes* @see http://hsivonen.iki.fi/producing-xml/#controlchar* @param string* @return string control codes removed*/function utf8_strip_ascii_ctrl($str) {    ob_start();    while ( preg_match(        '/^([^\x00-\x08\x0B\x0C\x0E-\x1F\x7F]+)|([\x00-\x08\x0B\x0C\x0E-\x1F\x7F]+)/S',            $str, $matches) ) {        if ( !isset($matches[2]) ) {            echo $matches[0];        }        $str = substr($str, strlen($matches[0]));    }    $result = ob_get_contents();    ob_end_clean();    return $result;}//--------------------------------------------------------------------/*** Strip out all non 7bit ASCII bytes and ASCII device control codes.* For a list of ASCII device control codes see the 2nd table here:* http://www.w3schools.com/tags/ref_ascii.asp* * @param string* @return boolean TRUE if it's all ASCII* @package utf8* @subpackage ascii*/function utf8_strip_non_ascii_ctrl($str) {    ob_start();    while ( preg_match(        '/^([\x09\x0A\x0D\x20-\x7E]+)|([^\x09\x0A\x0D\x20-\x7E]+)/S',            $str, $matches) ) {        if ( !isset($matches[2]) ) {            echo $matches[0];        }        $str = substr($str, strlen($matches[0]));    }    $result = ob_get_contents();    ob_end_clean();    return $result;}//---------------------------------------------------------------/*** Replace accented UTF-8 characters by unaccented ASCII-7 "equivalents".* The purpose of this function is to replace characters commonly found in Latin* alphabets with something more or less equivalent from the ASCII range. This can* be useful for converting a UTF-8 to something ready for a filename, for example.* Following the use of this function, you would probably also pass the string* through utf8_strip_non_ascii to clean out any other non-ASCII chars* Use the optional parameter to just deaccent lower ($case = -1) or upper ($case = 1)* letters. Default is to deaccent both cases ($case = 0)** For a more complete implementation of transliteration, see the utf8_to_ascii package* available from the phputf8 project downloads:* http://prdownloads.sourceforge.net/phputf8** @param string UTF-8 string* @param int (optional) -1 lowercase only, +1 uppercase only, 1 both cases* @param string UTF-8 with accented characters replaced by ASCII chars* @return string accented chars replaced with ascii equivalents* @author Andreas Gohr <andi@splitbrain.org>* @package utf8* @subpackage ascii*/function utf8_accents_to_ascii( $str, $case=0 ){    static $UTF8_LOWER_ACCENTS = NULL;    static $UTF8_UPPER_ACCENTS = NULL;    if($case <= 0){        if ( is_null($UTF8_LOWER_ACCENTS) ) {            $UTF8_LOWER_ACCENTS = array(  '' => 'a', '' => 'o', '' => 'd', '' => 'f', '' => 'e', '' => 's', '' => 'o',  '' => 'ss', '' => 'a', '' => 'r', '' => 't', '' => 'n', '' => 'a', '' => 'k',  '' => 's', '' => 'y', '' => 'n', '' => 'l', '' => 'h', '' => 'p', '' => 'o',  '' => 'u', '' => 'e', '' => 'e', '' => 'c', '' => 'w', '' => 'c', '' => 'o',  '' => 's', '' => 'o', '' => 'g', '' => 't', '' => 's', '' => 'e', '' => 'c',  '' => 's', '' => 'i', '' => 'u', '' => 'c', '' => 'e', '' => 'w', '' => 't',  '' => 'u', '' => 'c', '' => 'oe', '' => 'e', '' => 'y', '' => 'a', '' => 'l',  '' => 'u', '' => 'u', '' => 's', '' => 'g', '' => 'l', '' => 'f', '' => 'z',  '' => 'w', '' => 'b', '' => 'a', '' => 'i', '' => 'i', '' => 'd', '' => 't',  '' => 'r', '' => 'ae', '' => 'i', '' => 'r', '' => 'e', '' => 'ue', '' => 'o',  '' => 'e', '' => 'n', '' => 'n', '' => 'h', '' => 'g', '' => 'd', '' => 'j',  '' => 'y', '' => 'u', '' => 'u', '' => 'u', '' => 't', '' => 'y', '' => 'o',  '' => 'a', '' => 'l', '' => 'w', '' => 'z', '' => 'i', '' => 'a', '' => 'g',  '' => 'm', '' => 'o', '' => 'i', '' => 'u', '' => 'i', '' => 'z', '' => 'a',  '' => 'u', '' => 'th', '' => 'dh', '' => 'ae', '' => 'u', '' => 'e',             );        }        $str = str_replace(                array_keys($UTF8_LOWER_ACCENTS),                array_values($UTF8_LOWER_ACCENTS),                $str            );    }    if($case >= 0){        if ( is_null($UTF8_UPPER_ACCENTS) ) {            $UTF8_UPPER_ACCENTS = array(  '' => 'A', '' => 'O', '' => 'D', '' => 'F', '' => 'E', '' => 'S', '' => 'O',  '' => 'A', '' => 'R', '' => 'T', '' => 'N', '' => 'A', '' => 'K',  '' => 'S', '' => 'Y', '' => 'N', '' => 'L', '' => 'H', '' => 'P', '' => 'O',  '' => 'U', '' => 'E', '' => 'E', '' => 'C', '' => 'W', '' => 'C', '' => 'O',  '' => 'S', '' => 'O', '' => 'G', '' => 'T', '' => 'S', '' => 'E', '' => 'C',  '' => 'S', '' => 'I', '' => 'U', '' => 'C', '' => 'E', '' => 'W', '' => 'T',  '' => 'U', '' => 'C', '' => 'Oe', '' => 'E', '' => 'Y', '' => 'A', '' => 'L',  '' => 'U', '' => 'U', '' => 'S', '' => 'G', '' => 'L', '' => 'F', '' => 'Z',  '' => 'W', '' => 'B', '' => 'A', '' => 'I', '' => 'I', '' => 'D', '' => 'T',  '' => 'R', '' => 'Ae', '' => 'I', '' => 'R', '' => 'E', '' => 'Ue', '' => 'O',  '' => 'E', '' => 'N', '' => 'N', '' => 'H', '' => 'G', '' => 'D', '' => 'J',  '' => 'Y', '' => 'U', '' => 'U', '' => 'U', '' => 'T', '' => 'Y', '' => 'O',  '' => 'A', '' => 'L', '' => 'W', '' => 'Z', '' => 'I', '' => 'A', '' => 'G',  '' => 'M', '' => 'O', '' => 'I', '' => 'U', '' => 'I', '' => 'Z', '' => 'A',  '' => 'U', '' => 'Th', '' => 'Dh', '' => 'Ae', '' => 'E',            );        }        $str = str_replace(                array_keys($UTF8_UPPER_ACCENTS),                array_values($UTF8_UPPER_ACCENTS),                $str            );    }    return $str;}
<?php// Language definitions used in all admin files$lang_admin_reports = array('No reports selected'			=>	'No reports were selected to be marked as read.','Reports marked read'			=>	'Reports marked as read.','New reports heading'			=>	'New reports (select and mark as read once dealt with)','Empty reports heading'			=>	'Reports are empty','Reported by'					=>	'By %s','Deleted forum'					=>	'Deleted forum','Deleted topic'					=>	'Deleted topic','Deleted post'					=>	'Deleted post','Deleted user'					=>	'Deleted user','Mark read'						=>	'Mark as read','Select report'					=>	'Select report','No new reports'				=>	'(there are no unread reports for you to view)','Read reports heading'			=>	'Last 10 reports marked as read','No reports'					=>	'There are no reports either read or unread for you to view.','Marked read by'				=>	'Read %s by %s',);
<?php/*** @version $Id: strspn.php,v 1.1 2006/02/25 13:50:17 harryf Exp $* @package utf8* @subpackage strings*///---------------------------------------------------------------/*** UTF-8 aware alternative to strspn* Find length of initial segment matching mask* Note: requires utf8_strlen and utf8_substr (if start, length are used)* @param string* @return int* @see http://www.php.net/strspn* @package utf8* @subpackage strings*/function utf8_strspn($str, $mask, $start = NULL, $length = NULL) {    $mask = preg_replace('!([\\\\\\-\\]\\[/^])!','\\\${1}',$mask);    if ( $start !== NULL || $length !== NULL ) {        $str = utf8_substr($str, $start, $length);    }    preg_match('/^['.$mask.']+/u',$str, $matches);    if ( isset($matches[0]) ) {        return utf8_strlen($matches[0]);    }    return 0;}
<?php// Language definitions used in viewforum.php$lang_forum = array('Forum subtitle'			=>	'%1$s in this forum with details of %2$s.','Search subtitle'			=>	'%1$s found with details of %2$s.','Topics'					=>	'Topics','topics'					=>	'topics','Reply'						=>	'Reply','Replies'					=>	'Replies','Forum'						=>	'Forum','reply'						=>	'reply','replies'					=>	'replies','View'						=>	'View','Views'						=>	'Views','views'						=>	'views','view'						=>	'view','Last post'					=>	'Last post','last post'					=>	'last post','Select topic'				=>	'Select topic: %s.','No replies info'			=>	'No reply information','No views info'				=>	'No viewing information','No lastpost info'			=>	'No last post information','by poster'					=>	'by %s','Item status'				=>	'%s:','Topic starter'				=>	'by <cite>%s</cite>','New posts'					=>	'New posts','Topic navigation'			=>	'( %s )','Location'					=>	'Found in forum: %s','Pages'						=>	'Pages','Post topic'				=>	'Post new topic','Login to post'				=>	'You must %1$s or %2$s to post a new topic','No permission'				=>	'Sorry! no permission to post new topics','Moved'						=>	'Moved','Sticky'					=>	'Sticky','Closed'					=>	'Closed','Empty forum'				=>	'Empty forum','No topics'					=>	'No topics have been posted','First topic nag'			=>	'Be the first to post a topic in this forum.','You posted indicator'		=>	'','Permalink forum'			=>	'Permanent link to this forum.','Forum options'				=>	'Forum options','Moderate forum'			=>	'Moderate forum','Mark forum read'			=>	'Mark forum as read','RSS forum feed'			=>	'RSS forum feed','New posts info'			=>	'Go to the first new post since your last visit.');
<?php/** * SEF URLs that use a file-like layout and include topic name and forum name * where applicable. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure no one attempts to run this script "directly"if (!defined('FORUM'))	exit;// These are the "fancy" file based SEF URLs$forum_url = array(	'insertion_find'				=>  '.html',	'insertion_replace'				=>  '-$1.html',	'change_email'					=>	'change-email$1.html',	'change_email_key'				=>	'change-email$1-$2.html',	'change_password'				=>	'change-password$1.html',	'change_password_key'			=>	'change-password$1-$2.html',	'delete_user'					=>	'delete-user$1.html',	'delete'						=>	'delete$1.html',	'delete_avatar'					=>	'delete-avatar$1-$2.html',	'edit'							=>	'edit$1.html',	'email'							=>	'email$1.html',	'forum'							=>	'forum$1-$2.html',	'forum_rss'						=>	'feed-rss-forum$1.xml',	'forum_atom'					=>	'feed-atom-forum$1.xml',	'help'							=>	'help-$1.html',	'index'							=>	'',	'index_rss'						=>	'feed-rss.xml',	'index_atom'					=>	'feed-atom.xml',	'login'							=>	'login.html',	'logout'						=>	'logout$1-$2.html',	'mark_read'						=>	'mark-read-$1.html',	'mark_forum_read'				=>	'mark-forum$1-read-$2.html',	'new_topic'						=>	'new-topic$1.html',	'new_reply'						=>	'new-reply$1.html',	'post'							=>	'post$1.html#p$1',	'profile_about'					=>	'user$1-about.html',	'profile_identity'				=>	'user$1-identity.html',	'profile_settings'				=>	'user$1-settings.html',	'profile_avatar'				=>	'user$1-avatar.html',	'profile_signature'				=>	'user$1-signature.html',	'profile_admin'					=>	'user$1-admin.html',	'quote'							=>	'new-reply$1quote$2.html',	'register'						=>	'register.html',	'report'						=>	'report$1.html',	'request_password'				=>	'request-password.html',	'rules'							=>	'rules.html',	'search'						=>	'search.html',	'search_advanced'				=>	'search-advanced.html',	'search_resultft'				=>	'search-k$1-$4-a$3-$5-$6-$2-$7.html',	'search_results'				=>	'search$1.html',	'search_new'					=>	'search-new.html',	'search_new_results'			=>	'search-new-$1.html',	'search_recent'					=>	'search-recent.html',	'search_recent_results'			=>	'search-recent-$1.html',	'search_unanswered'				=>	'search-unanswered.html',	'search_subscriptions'			=>	'search-subscriptions$1.html',	'search_user_posts'				=>	'search-posts-user$1.html',	'search_user_topics'			=>	'search-topics-user$1.html',	'subscribe'						=>	'subscribe$1-$2.html',	'topic'							=>	'topic$1-$2.html',	'topic_rss'						=>	'feed-rss-topic$1.xml',	'topic_atom'					=>	'feed-atom-topic$1.xml',	'topic_new_posts'				=>	'topic$1-$2-new-posts.html',	'topic_last_post'				=>	'topic$1last-post.html',	'unsubscribe'					=>	'unsubscribe$1-$2.html',	'user'							=>	'user$1.html',	'users'							=>	'users.html',	'users_browse'					=>	'users/$4/$1$2-$3.html',	'page'							=>	'p$1',	'moderate_forum'				=>	'moderate$1.html',	'get_host'						=>	'get_host$1.html',	'move'							=>	'move_topics$1-$2.html',	'open'							=>	'open$1-$2-$3.html',	'close'							=>	'close$1-$2-$3.html',	'stick'							=>	'stick$1-$2-$3.html',	'unstick'						=>	'unstick$1-$2-$3.html',	'moderate_topic'				=>	'moderate$1-$2.html',	'admin_index'					=>	'admin/index.php',	'admin_bans'					=>	'admin/bans.php?sort_by=1',	'admin_categories'				=>	'admin/categories.php',	'admin_censoring'				=>	'admin/censoring.php',	'admin_extensions_manage'		=>	'admin/extensions.php?section=manage',	'admin_extensions_hotfixes'		=>	'admin/extensions.php?section=hotfixes',	'admin_forums'					=>	'admin/forums.php',	'admin_groups'					=>	'admin/groups.php',	'admin_loader'					=>	'admin/loader.php',	'admin_reindex'					=>	'admin/reindex.php',	'admin_settings_setup'			=>	'admin/settings.php?section=setup',	'admin_settings_features'		=>	'admin/settings.php?section=features',	'admin_settings_content'		=>	'admin/settings.php?section=content',	'admin_settings_email'			=>	'admin/settings.php?section=email',	'admin_settings_announcements'	=>	'admin/settings.php?section=announcements',	'admin_settings_registration'	=>	'admin/settings.php?section=registration',	'admin_settings_communications'	=>	'admin/settings.php?section=communications',	'admin_settings_maintenance'	=>	'admin/settings.php?section=maintenance',	'admin_prune'					=>	'admin/prune.php',	'admin_ranks'					=>	'admin/ranks.php',	'admin_reports'					=>	'admin/reports.php',	'admin_users'					=>	'admin/users.php');
<?php/** * Lists the posts in the specified topic. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', './');require FORUM_ROOT.'include/common.php';($hook = get_hook('vt_start')) ? eval($hook) : null;if ($forum_user['g_read_board'] == '0')	message($lang_common['No view']);// Load the viewtopic.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/topic.php';$action = isset($_GET['action']) ? $_GET['action'] : null;$id = isset($_GET['id']) ? intval($_GET['id']) : 0;$pid = isset($_GET['pid']) ? intval($_GET['pid']) : 0;if ($id < 1 && $pid < 1)	message($lang_common['Bad request']);// If a post ID is specified we determine topic ID and page number so we can redirect to the correct messageif ($pid){	$query = array(		'SELECT'	=> 'p.topic_id, p.posted',		'FROM'		=> 'posts AS p',		'WHERE'		=> 'p.id='.$pid	);	($hook = get_hook('vt_qr_get_post_info')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$topic_info = $forum_db->fetch_row($result);	if (!$topic_info)	{		message($lang_common['Bad request']);	}	list($id, $posted) = $topic_info;	// Determine on what page the post is located (depending on $forum_user['disp_posts'])	$query = array(		'SELECT'	=> 'COUNT(p.id)',		'FROM'		=> 'posts AS p',		'WHERE'		=> 'p.topic_id='.$id.' AND p.posted<'.$posted	);	($hook = get_hook('vt_qr_get_post_page')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$num_posts = $forum_db->result($result) + 1;	$_GET['p'] = ceil($num_posts / $forum_user['disp_posts']);}// If action=new, we redirect to the first new post (if any)else if ($action == 'new'){	if (!$forum_user['is_guest'])	{		// We need to check if this topic has been viewed recently by the user		$tracked_topics = get_tracked_topics();		$last_viewed = isset($tracked_topics['topics'][$id]) ? $tracked_topics['topics'][$id] : $forum_user['last_visit'];		($hook = get_hook('vt_find_new_post')) ? eval($hook) : null;		$query = array(			'SELECT'	=> 'MIN(p.id)',			'FROM'		=> 'posts AS p',			'WHERE'		=> 'p.topic_id='.$id.' AND p.posted>'.$last_viewed		);		($hook = get_hook('vt_qr_get_first_new_post')) ? eval($hook) : null;		$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);		$first_new_post_id = $forum_db->result($result);		if ($first_new_post_id)		{			header('Location: '.str_replace('&amp;', '&', forum_link($forum_url['post'], $first_new_post_id)));			exit;		}	}	header('Location: '.str_replace('&amp;', '&', forum_link($forum_url['topic_last_post'], $id)));	exit;}// If action=last, we redirect to the last postelse if ($action == 'last'){	$query = array(		'SELECT'	=> 't.last_post_id',		'FROM'		=> 'topics AS t',		'WHERE'		=> 't.id='.$id	);	($hook = get_hook('vt_qr_get_last_post')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$last_post_id = $forum_db->result($result);	if ($last_post_id)	{		header('Location: '.str_replace('&amp;', '&', forum_link($forum_url['post'], $last_post_id)));		exit;	}}// Fetch some info about the topic$query = array(	'SELECT'	=> 't.subject, t.first_post_id, t.closed, t.num_replies, t.sticky, f.id AS forum_id, f.forum_name, f.moderators, fp.post_replies',	'FROM'		=> 'topics AS t',	'JOINS'		=> array(		array(			'INNER JOIN'	=> 'forums AS f',			'ON'			=> 'f.id=t.forum_id'		),		array(			'LEFT JOIN'		=> 'forum_perms AS fp',			'ON'			=> '(fp.forum_id=f.id AND fp.group_id='.$forum_user['g_id'].')'		)	),	'WHERE'		=> '(fp.read_forum IS NULL OR fp.read_forum=1) AND t.id='.$id.' AND t.moved_to IS NULL');if (!$forum_user['is_guest'] && $forum_config['o_subscriptions'] == '1'){	$query['SELECT'] .= ', s.user_id AS is_subscribed';	$query['JOINS'][] = array(		'LEFT JOIN'	=> 'subscriptions AS s',		'ON'		=> '(t.id=s.topic_id AND s.user_id='.$forum_user['id'].')'	);}($hook = get_hook('vt_qr_get_topic_info')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$cur_topic = $forum_db->fetch_assoc($result);if (!$cur_topic){	message($lang_common['Bad request']);}($hook = get_hook('vt_modify_topic_info')) ? eval($hook) : null;// Sort out who the moderators are and if we are currently a moderator (or an admin)$mods_array = ($cur_topic['moderators'] != '') ? unserialize($cur_topic['moderators']) : array();$forum_page['is_admmod'] = ($forum_user['g_id'] == FORUM_ADMIN || ($forum_user['g_moderator'] == '1' && array_key_exists($forum_user['username'], $mods_array))) ? true : false;// Can we or can we not post replies?if ($cur_topic['closed'] == '0' || $forum_page['is_admmod'])	$forum_user['may_post'] = (($cur_topic['post_replies'] == '' && $forum_user['g_post_replies'] == '1') || $cur_topic['post_replies'] == '1' || $forum_page['is_admmod']) ? true : false;else	$forum_user['may_post'] = false;// Add/update this topic in our list of tracked topicsif (!$forum_user['is_guest']){	$tracked_topics = get_tracked_topics();	$tracked_topics['topics'][$id] = time();	set_tracked_topics($tracked_topics);}// Determine the post offset (based on $_GET['p'])$forum_page['num_pages'] = ceil(($cur_topic['num_replies'] + 1) / $forum_user['disp_posts']);$forum_page['page'] = (!isset($_GET['p']) || !is_numeric($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $forum_page['num_pages']) ? 1 : $_GET['p'];$forum_page['start_from'] = $forum_user['disp_posts'] * ($forum_page['page'] - 1);$forum_page['finish_at'] = min(($forum_page['start_from'] + $forum_user['disp_posts']), ($cur_topic['num_replies'] + 1));$forum_page['items_info'] =  generate_items_info($lang_topic['Posts'], ($forum_page['start_from'] + 1), ($cur_topic['num_replies'] + 1));($hook = get_hook('vt_modify_page_details')) ? eval($hook) : null;// Navigation links for header and page numbering for title/meta descriptionif ($forum_page['page'] < $forum_page['num_pages']){	$forum_page['nav']['last'] = '<link rel="last" href="'.forum_sublink($forum_url['topic'], $forum_url['page'], $forum_page['num_pages'], array($id, sef_friendly($cur_topic['subject']))).'" title="'.$lang_common['Page'].' '.$forum_page['num_pages'].'" />';	$forum_page['nav']['next'] = '<link rel="next" href="'.forum_sublink($forum_url['topic'], $forum_url['page'], ($forum_page['page'] + 1), array($id, sef_friendly($cur_topic['subject']))).'" title="'.$lang_common['Page'].' '.($forum_page['page'] + 1).'" />';}if ($forum_page['page'] > 1){	$forum_page['nav']['prev'] = '<link rel="prev" href="'.forum_sublink($forum_url['topic'], $forum_url['page'], ($forum_page['page'] - 1), array($id, sef_friendly($cur_topic['subject']))).'" title="'.$lang_common['Page'].' '.($forum_page['page'] - 1).'" />';	$forum_page['nav']['first'] = '<link rel="first" href="'.forum_link($forum_url['topic'], array($id, sef_friendly($cur_topic['subject']))).'" title="'.$lang_common['Page'].' 1" />';}if ($forum_config['o_censoring'] == '1')	$cur_topic['subject'] = censor_words($cur_topic['subject']);// Generate paging and posting links$forum_page['page_post']['paging'] = '<p class="paging"><span class="pages">'.$lang_common['Pages'].'</span> '.paginate($forum_page['num_pages'], $forum_page['page'], $forum_url['topic'], $lang_common['Paging separator'], array($id, sef_friendly($cur_topic['subject']))).'</p>';if ($forum_user['may_post'])	$forum_page['page_post']['posting'] = '<p class="posting"><a class="newpost" href="'.forum_link($forum_url['new_reply'], $id).'"><span>'.$lang_topic['Post reply'].'</span></a></p>';else if ($forum_user['is_guest'])	$forum_page['page_post']['posting'] = '<p class="posting">'.sprintf($lang_topic['Login to post'], '<a href="'.forum_link($forum_url['login']).'">'.$lang_common['login'].'</a>', '<a href="'.forum_link($forum_url['register']).'">'.$lang_common['register'].'</a>').'</p>';else if ($cur_topic['closed'] == '1')	$forum_page['page_post']['posting'] = '<p class="posting">'.$lang_topic['Topic closed info'].'</p>';else	$forum_page['page_post']['posting'] = '<p class="posting">'.$lang_topic['No permission'].'</p>';// Setup main options$forum_page['main_title'] = $lang_topic['Topic options'];$forum_page['main_head_options'] = array(	'rss' => '<span class="feed first-item"><a class="feed" href="'.forum_link($forum_url['topic_rss'], $id).'">'.$lang_topic['RSS topic feed'].'</a></span>');if (!$forum_user['is_guest'] && $forum_config['o_subscriptions'] == '1'){	if ($cur_topic['is_subscribed'])		$forum_page['main_head_options']['unsubscribe'] = '<span><a class="sub-option" href="'.forum_link($forum_url['unsubscribe'], array($id, generate_form_token('unsubscribe'.$id.$forum_user['id']))).'"><em>'.$lang_topic['Unsubscribe'].'</em></a></span>';	else		$forum_page['main_head_options']['subscribe'] = '<span><a class="sub-option" href="'.forum_link($forum_url['subscribe'], array($id, generate_form_token('subscribe'.$id.$forum_user['id']))).'" title="'.$lang_topic['Subscribe info'].'">'.$lang_topic['Subscribe'].'</a></span>';}if ($forum_page['is_admmod']){	$forum_page['main_foot_options'] = array(		'move' => '<span class="first-item"><a class="mod-option" href="'.forum_link($forum_url['move'], array($cur_topic['forum_id'], $id)).'">'.$lang_topic['Move'].'</a></span>',		'delete' => '<span><a class="mod-option" href="'.forum_link($forum_url['delete'], $cur_topic['first_post_id']).'">'.$lang_topic['Delete topic'].'</a></span>',		'close' => (($cur_topic['closed'] == '1') ? '<span><a class="mod-option" href="'.forum_link($forum_url['open'], array($cur_topic['forum_id'], $id, generate_form_token('open'.$id))).'">'.$lang_topic['Open'].'</a></span>' : '<span><a class="mod-option" href="'.forum_link($forum_url['close'], array($cur_topic['forum_id'], $id, generate_form_token('close'.$id))).'">'.$lang_topic['Close'].'</a></span>'),		'sticky' => (($cur_topic['sticky'] == '1') ? '<span><a class="mod-option" href="'.forum_link($forum_url['unstick'], array($cur_topic['forum_id'], $id, generate_form_token('unstick'.$id))).'">'.$lang_topic['Unstick'].'</a></span>' : '<span><a class="mod-option" href="'.forum_link($forum_url['stick'], array($cur_topic['forum_id'], $id, generate_form_token('stick'.$id))).'">'.$lang_topic['Stick'].'</a></span>')	);	if ($cur_topic['num_replies'] != 0)		$forum_page['main_foot_options']['moderate_topic'] = '<span><a class="mod-option" href="'.forum_sublink($forum_url['moderate_topic'], $forum_url['page'], $forum_page['page'], array($cur_topic['forum_id'], $id)).'">'.$lang_topic['Moderate topic'].'</a></span>';}// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($cur_topic['forum_name'], forum_link($forum_url['forum'], array($cur_topic['forum_id'], sef_friendly($cur_topic['forum_name'])))),	array($cur_topic['subject'], forum_link($forum_url['topic'], array($id, sef_friendly($cur_topic['subject'])))));// Setup main heading$forum_page['main_title'] = (($cur_topic['closed'] == '1') ? $lang_topic['Topic closed'].' ' : '').'<a class="permalink" href="'.forum_link($forum_url['topic'], array($id, sef_friendly($cur_topic['subject']))).'" rel="bookmark" title="'.$lang_topic['Permalink topic'].'">'.forum_htmlencode($cur_topic['subject']).'</a>';if ($forum_page['num_pages'] > 1)	$forum_page['main_head_pages'] = sprintf($lang_common['Page info'], $forum_page['page'], $forum_page['num_pages']);($hook = get_hook('vt_pre_header_load')) ? eval($hook) : null;// Allow indexing if this is a permalinkif (!$pid)	define('FORUM_ALLOW_INDEX', 1);define('FORUM_PAGE', 'viewtopic');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('vt_main_output_start')) ? eval($hook) : null;?>	<div class="main-head"><?php	if (!empty($forum_page['main_head_options']))		echo "\t\t".'<p class="options">'.implode(' ', $forum_page['main_head_options']).'</p>'."\n";?>		<h2 class="hn"><span><?php echo $forum_page['items_info'] ?></span></h2>	</div>	<div id="forum<?php echo $cur_topic['forum_id'] ?>" class="main-content main-topic"><?phpif (!defined('FORUM_PARSER_LOADED'))	require FORUM_ROOT.'include/parser.php';$forum_page['item_count'] = 0;	// Keep track of post numbers// 1. Retrieve the posts ids$query = array(	'SELECT'	=> 'p.id',	'FROM'		=> 'posts AS p',	'WHERE'		=> 'p.topic_id='.$id,	'ORDER BY'	=> 'p.id',	'LIMIT'		=> $forum_page['start_from'].','.$forum_user['disp_posts']);($hook = get_hook('vt_qr_get_posts_id')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$posts_id = array();while ($row = $forum_db->fetch_row($result)) {	$posts_id[] = $row[0];}ksort($posts_id, SORT_NUMERIC);$posts_id = array_reverse($posts_id);if (!empty($posts_id)){	// 2. Retrieve the posts (and their respective poster/online status) by known id`s	$query = array(		'SELECT'	=> 'u.email, u.title, u.url, u.location, u.signature, u.email_setting, u.num_posts, u.registered, u.admin_note, u.avatar, u.avatar_width, u.avatar_height, p.id, p.poster AS username, p.poster_id, p.poster_ip, p.poster_email, p.message, p.hide_smilies, p.posted, p.edited, p.edited_by, g.g_id, g.g_user_title, o.user_id AS is_online',		'FROM'		=> 'posts AS p',		'JOINS'		=> array(			array(				'INNER JOIN'	=> 'users AS u',				'ON'			=> 'u.id=p.poster_id'			),			array(				'INNER JOIN'	=> 'groups AS g',				'ON'			=> 'g.g_id=u.group_id'			),			array(				'LEFT JOIN'		=> 'online AS o',				'ON'			=> '(o.user_id=u.id AND o.user_id!=1 AND o.idle=0)'			),		),		'WHERE'		=> 'p.id IN ('.implode(',', $posts_id).')'	);	($hook = get_hook('vt_qr_get_posts')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$user_data_cache = array();	while ($cur_post = $forum_db->fetch_assoc($result))	{		($hook = get_hook('vt_post_loop_start')) ? eval($hook) : null;		++$forum_page['item_count'];		$forum_page['post_ident'] = array();		$forum_page['author_ident'] = array();		$forum_page['author_info'] = array();		$forum_page['post_options'] = array();		$forum_page['post_contacts'] = array();		$forum_page['post_actions'] = array();		$forum_page['message'] = array();		// Generate the post heading		$forum_page['post_ident']['num'] = '<span class="post-num">'.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span>';		if ($cur_post['poster_id'] > 1)			$forum_page['post_ident']['byline'] = '<span class="post-byline">'.sprintf((($cur_post['id'] == $cur_topic['first_post_id']) ? $lang_topic['Topic byline'] : $lang_topic['Reply byline']), (($forum_user['g_view_users'] == '1') ? '<a title="'.sprintf($lang_topic['Go to profile'], forum_htmlencode($cur_post['username'])).'" href="'.forum_link($forum_url['user'], $cur_post['poster_id']).'">'.forum_htmlencode($cur_post['username']).'</a>' : '<strong>'.forum_htmlencode($cur_post['username']).'</strong>')).'</span>';		else			$forum_page['post_ident']['byline'] = '<span class="post-byline">'.sprintf((($cur_post['id'] == $cur_topic['first_post_id']) ? $lang_topic['Topic byline'] : $lang_topic['Reply byline']), '<strong>'.forum_htmlencode($cur_post['username']).'</strong>').'</span>';		$forum_page['post_ident']['link'] = '<span class="post-link"><a class="permalink" rel="bookmark" title="'.$lang_topic['Permalink post'].'" href="'.forum_link($forum_url['post'], $cur_post['id']).'">'.format_time($cur_post['posted']).'</a></span>';		($hook = get_hook('vt_row_pre_post_ident_merge')) ? eval($hook) : null;		if (isset($user_data_cache[$cur_post['poster_id']]['author_ident']))			$forum_page['author_ident'] = $user_data_cache[$cur_post['poster_id']]['author_ident'];		else		{			// Generate author identification			if ($cur_post['poster_id'] > 1)			{				if ($forum_config['o_avatars'] == '1' && $forum_user['show_avatars'] != '0')				{					$forum_page['avatar_markup'] = generate_avatar_markup($cur_post['poster_id'], $cur_post['avatar'], $cur_post['avatar_width'], $cur_post['avatar_height'], $cur_post['username']);					if (!empty($forum_page['avatar_markup']))						$forum_page['author_ident']['avatar'] = '<li class="useravatar">'.$forum_page['avatar_markup'].'</li>';				}				$forum_page['author_ident']['username'] = '<li class="username">'.(($forum_user['g_view_users'] == '1') ? '<a title="'.sprintf($lang_topic['Go to profile'], forum_htmlencode($cur_post['username'])).'" href="'.forum_link($forum_url['user'], $cur_post['poster_id']).'">'.forum_htmlencode($cur_post['username']).'</a>' : '<strong>'.forum_htmlencode($cur_post['username']).'</strong>').'</li>';				$forum_page['author_ident']['usertitle'] = '<li class="usertitle"><span>'.get_title($cur_post).'</span></li>';				if ($cur_post['is_online'] == $cur_post['poster_id'])					$forum_page['author_ident']['status'] = '<li class="userstatus"><span>'.$lang_topic['Online'].'</span></li>';				else					$forum_page['author_ident']['status'] = '<li class="userstatus"><span>'.$lang_topic['Offline'].'</span></li>';			}			else			{				$forum_page['author_ident']['username'] = '<li class="username"><strong>'.forum_htmlencode($cur_post['username']).'</strong></li>';				$forum_page['author_ident']['usertitle'] = '<li class="usertitle"><span>'.get_title($cur_post).'</span></li>';			}		}		if (isset($user_data_cache[$cur_post['poster_id']]['author_info']))			$forum_page['author_info'] = $user_data_cache[$cur_post['poster_id']]['author_info'];		else		{			// Generate author information			if ($cur_post['poster_id'] > 1)			{				if ($forum_config['o_show_user_info'] == '1')				{					if ($cur_post['location'] != '')					{						if ($forum_config['o_censoring'] == '1')							$cur_post['location'] = censor_words($cur_post['location']);						$forum_page['author_info']['from'] = '<li><span>'.$lang_topic['From'].' <strong>'.forum_htmlencode($cur_post['location']).'</strong></span></li>';					}					$forum_page['author_info']['registered'] = '<li><span>'.$lang_topic['Registered'].' <strong>'.format_time($cur_post['registered'], 1).'</strong></span></li>';					if ($forum_config['o_show_post_count'] == '1' || $forum_user['is_admmod'])						$forum_page['author_info']['posts'] = '<li><span>'.$lang_topic['Posts info'].' <strong>'.forum_number_format($cur_post['num_posts']).'</strong></span></li>';				}				if ($forum_user['is_admmod'])				{					if ($cur_post['admin_note'] != '')						$forum_page['author_info']['note'] = '<li><span>'.$lang_topic['Note'].' <strong>'.forum_htmlencode($cur_post['admin_note']).'</strong></span></li>';				}			}		}		// Generate IP information for moderators/administrators		if ($forum_user['is_admmod'])			$forum_page['author_info']['ip'] = '<li><span>'.$lang_topic['IP'].' <a href="'.forum_link($forum_url['get_host'], $cur_post['id']).'">'.$cur_post['poster_ip'].'</a></span></li>';		// Generate author contact details		if ($forum_config['o_show_user_info'] == '1')		{			if (isset($user_data_cache[$cur_post['poster_id']]['post_contacts']))				$forum_page['post_contacts'] = $user_data_cache[$cur_post['poster_id']]['post_contacts'];			else			{				if ($cur_post['poster_id'] > 1)				{					if ($cur_post['url'] != '')						$forum_page['post_contacts']['url'] = '<span class="user-url'.(empty($forum_page['post_contacts']) ? ' first-item' : '').'"><a class="external" href="'.forum_htmlencode(($forum_config['o_censoring'] == '1') ? censor_words($cur_post['url']) : $cur_post['url']).'">'.sprintf($lang_topic['Visit website'], '<span>'.sprintf($lang_topic['User possessive'], forum_htmlencode($cur_post['username'])).'</span>').'</a></span>';					if ((($cur_post['email_setting'] == '0' && !$forum_user['is_guest']) || $forum_user['is_admmod']) && $forum_user['g_send_email'] == '1')						$forum_page['post_contacts']['email'] = '<span class="user-email'.(empty($forum_page['post_contacts']) ? ' first-item' : '').'"><a href="mailto:'.forum_htmlencode($cur_post['email']).'">'.$lang_topic['E-mail'].'<span>&#160;'.forum_htmlencode($cur_post['username']).'</span></a></span>';					else if ($cur_post['email_setting'] == '1' && !$forum_user['is_guest'] && $forum_user['g_send_email'] == '1')						$forum_page['post_contacts']['email'] = '<span class="user-email'.(empty($forum_page['post_contacts']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['email'], $cur_post['poster_id']).'">'.$lang_topic['E-mail'].'<span>&#160;'.forum_htmlencode($cur_post['username']).'</span></a></span>';				}				else				{					if ($cur_post['poster_email'] != '' && $forum_user['is_admmod'] && $forum_user['g_send_email'] == '1')						$forum_page['post_contacts']['email'] = '<span class="user-email'.(empty($forum_page['post_contacts']) ? ' first-item' : '').'"><a href="mailto:'.forum_htmlencode($cur_post['poster_email']).'">'.$lang_topic['E-mail'].'<span>&#160;'.forum_htmlencode($cur_post['username']).'</span></a></span>';				}			}			($hook = get_hook('vt_row_pre_post_contacts_merge')) ? eval($hook) : null;			if (!empty($forum_page['post_contacts']))				$forum_page['post_options']['contacts'] = '<p class="post-contacts">'.implode(' ', $forum_page['post_contacts']).'</p>';		}		// Generate the post options links		if (!$forum_user['is_guest'])		{			$forum_page['post_actions']['report'] = '<span class="report-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['report'], $cur_post['id']).'">'.$lang_topic['Report'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';			if (!$forum_page['is_admmod'])			{				if ($cur_topic['closed'] == '0')				{					if ($cur_post['poster_id'] == $forum_user['id'])					{						if (($forum_page['start_from'] + $forum_page['item_count']) == 1 && $forum_user['g_delete_topics'] == '1')							$forum_page['post_actions']['delete'] = '<span class="delete-topic'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['delete'], $cur_topic['first_post_id']).'">'.$lang_topic['Delete topic'].'</a></span>';						if (($forum_page['start_from'] + $forum_page['item_count']) > 1 && $forum_user['g_delete_posts'] == '1')							$forum_page['post_actions']['delete'] = '<span class="delete-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['delete'], $cur_post['id']).'">'.$lang_topic['Delete'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';						if ($forum_user['g_edit_posts'] == '1')							$forum_page['post_actions']['edit'] = '<span class="edit-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['edit'], $cur_post['id']).'">'.$lang_topic['Edit'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';					}					if (($cur_topic['post_replies'] == '' && $forum_user['g_post_replies'] == '1') || $cur_topic['post_replies'] == '1')						$forum_page['post_actions']['quote'] = '<span class="quote-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['quote'], array($id, $cur_post['id'])).'">'.$lang_topic['Quote'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';				}			}			else			{				if (($forum_page['start_from'] + $forum_page['item_count']) == 1)					$forum_page['post_actions']['delete'] = '<span class="delete-topic'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['delete'], $cur_topic['first_post_id']).'">'.$lang_topic['Delete topic'].'</a></span>';				else					$forum_page['post_actions']['delete'] = '<span class="delete-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['delete'], $cur_post['id']).'">'.$lang_topic['Delete'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';				$forum_page['post_actions']['edit'] = '<span class="edit-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['edit'], $cur_post['id']).'">'.$lang_topic['Edit'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';				$forum_page['post_actions']['quote'] = '<span class="quote-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['quote'], array($id, $cur_post['id'])).'">'.$lang_topic['Quote'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';			}		}		else		{			if ($cur_topic['closed'] == '0')			{				if (($cur_topic['post_replies'] == '' && $forum_user['g_post_replies'] == '1') || $cur_topic['post_replies'] == '1')					$forum_page['post_actions']['quote'] = '<span class="report-post'.(empty($forum_page['post_actions']) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['quote'], array($id, $cur_post['id'])).'">'.$lang_topic['Quote'].'<span> '.$lang_topic['Post'].' '.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';			}		}		($hook = get_hook('vt_row_pre_post_actions_merge')) ? eval($hook) : null;		if (!empty($forum_page['post_actions']))			$forum_page['post_options']['actions'] = '<p class="post-actions">'.implode(' ', $forum_page['post_actions']).'</p>';		// Give the post some class		$forum_page['item_status'] = array(			'post',			($forum_page['item_count'] % 2 != 0) ? 'odd' : 'even'		);		if ($forum_page['item_count'] == 1)			$forum_page['item_status']['firstpost'] = 'firstpost';		if (($forum_page['start_from'] + $forum_page['item_count']) == $forum_page['finish_at'])			$forum_page['item_status']['lastpost'] = 'lastpost';		if ($cur_post['id'] == $cur_topic['first_post_id'])			$forum_page['item_status']['topicpost'] = 'topicpost';		else			$forum_page['item_status']['replypost'] = 'replypost';		// Generate the post title		if ($cur_post['id'] == $cur_topic['first_post_id'])			$forum_page['item_subject'] = sprintf($lang_topic['Topic title'], $cur_topic['subject']);		else			$forum_page['item_subject'] = sprintf($lang_topic['Reply title'], $cur_topic['subject']);		$forum_page['item_subject'] = forum_htmlencode($forum_page['item_subject']);		// Perform the main parsing of the message (BBCode, smilies, censor words etc)		$forum_page['message']['message'] = parse_message($cur_post['message'], $cur_post['hide_smilies']);		if ($cur_post['edited'] != '')			$forum_page['message']['edited'] = '<p class="lastedit"><em>'.sprintf($lang_topic['Last edited'], forum_htmlencode($cur_post['edited_by']), format_time($cur_post['edited'])).'</em></p>';		// Do signature parsing/caching		if ($cur_post['signature'] != '' && $forum_user['show_sig'] != '0' && $forum_config['o_signatures'] == '1')		{			if (!isset($signature_cache[$cur_post['poster_id']]))				$signature_cache[$cur_post['poster_id']] = parse_signature($cur_post['signature']);			$forum_page['message']['signature'] = '<div class="sig-content"><span class="sig-line"><!-- --></span>'.$signature_cache[$cur_post['poster_id']].'</div>';		}		($hook = get_hook('vt_row_pre_display')) ? eval($hook) : null;		// Do user data caching for the post		if ($cur_post['poster_id'] > 1 && !isset($user_data_cache[$cur_post['poster_id']]))		{			$user_data_cache[$cur_post['poster_id']] = array(				'author_ident'	=> $forum_page['author_ident'],				'author_info'	=> $forum_page['author_info'],				'post_contacts'	=> $forum_page['post_contacts']			);			($hook = get_hook('vt_row_add_user_data_cache')) ? eval($hook) : null;		}?>		<div class="<?php echo implode(' ', $forum_page['item_status']) ?>">			<div id="p<?php echo $cur_post['id'] ?>" class="posthead">				<h3 class="hn post-ident"><?php echo implode(' ', $forum_page['post_ident']) ?></h3>			</div>			<div class="postbody<?php echo ($cur_post['is_online'] == $cur_post['poster_id']) ? ' online' : '' ?>">				<div class="post-author">					<ul class="author-ident">						<?php echo implode("\n\t\t\t\t\t\t", $forum_page['author_ident'])."\n" ?>					</ul>					<ul class="author-info">						<?php echo implode("\n\t\t\t\t\t\t", $forum_page['author_info'])."\n" ?>					</ul>				</div>				<div class="post-entry">					<h4 id="pc<?php echo $cur_post['id'] ?>" class="entry-title hn"><?php echo $forum_page['item_subject'] ?></h4>					<div class="entry-content">						<?php echo implode("\n\t\t\t\t\t\t", $forum_page['message'])."\n" ?>					</div><?php ($hook = get_hook('vt_row_new_post_entry_data')) ? eval($hook) : null; ?>				</div>			</div><?php if (!empty($forum_page['post_options'])): ?>			<div class="postfoot">				<div class="post-options">					<?php echo implode("\n\t\t\t\t\t", $forum_page['post_options'])."\n" ?>				</div>			</div><?php endif; ?>		</div><?php	}}?>	</div>	<div class="main-foot"><?php	if (!empty($forum_page['main_foot_options']))		echo "\n\t\t\t".'<p class="options">'.implode(' ', $forum_page['main_foot_options']).'</p>';?>		<h2 class="hn"><span><?php echo $forum_page['items_info'] ?></span></h2>	</div><?php($hook = get_hook('vt_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->// Display quick post if enabledif ($forum_config['o_quickpost'] == '1' &&	!$forum_user['is_guest'] &&	($cur_topic['post_replies'] == '1' || ($cur_topic['post_replies'] == '' && $forum_user['g_post_replies'] == '1')) &&	($cur_topic['closed'] == '0' || $forum_page['is_admmod'])){// START SUBST - <!-- forum_qpost -->ob_start();($hook = get_hook('vt_qpost_output_start')) ? eval($hook) : null;// Setup form$forum_page['form_action'] = forum_link($forum_url['new_reply'], $id);$forum_page['form_attributes'] = array();$forum_page['hidden_fields'] = array(	'form_sent'		=> '<input type="hidden" name="form_sent" value="1" />',	'form_user'		=> '<input type="hidden" name="form_user" value="'.((!$forum_user['is_guest']) ? forum_htmlencode($forum_user['username']) : 'Guest').'" />',	'csrf_token'	=> '<input type="hidden" name="csrf_token" value="'.generate_form_token($forum_page['form_action']).'" />');if (!$forum_user['is_guest'] && $forum_config['o_subscriptions'] == '1' && ($forum_user['auto_notify'] == '1' || $cur_topic['is_subscribed']))	$forum_page['hidden_fields']['subscribe'] = '<input type="hidden" name="subscribe" value="1" />';// Setup help$forum_page['main_head_options'] = array();if ($forum_config['p_message_bbcode'] == '1')	$forum_page['text_options']['bbcode'] = '<span'.(empty($forum_page['text_options']) ? ' class="first-item"' : '').'><a class="exthelp" href="'.forum_link($forum_url['help'], 'bbcode').'" title="'.sprintf($lang_common['Help page'], $lang_common['BBCode']).'">'.$lang_common['BBCode'].'</a></span>';if ($forum_config['p_message_img_tag'] == '1')	$forum_page['text_options']['img'] = '<span'.(empty($forum_page['text_options']) ? ' class="first-item"' : '').'><a class="exthelp" href="'.forum_link($forum_url['help'], 'img').'" title="'.sprintf($lang_common['Help page'], $lang_common['Images']).'">'.$lang_common['Images'].'</a></span>';if ($forum_config['o_smilies'] == '1')	$forum_page['text_options']['smilies'] = '<span'.(empty($forum_page['text_options']) ? ' class="first-item"' : '').'><a class="exthelp" href="'.forum_link($forum_url['help'], 'smilies').'" title="'.sprintf($lang_common['Help page'], $lang_common['Smilies']).'">'.$lang_common['Smilies'].'</a></span>';($hook = get_hook('vt_quickpost_pre_display')) ? eval($hook) : null;?><div class="main-subhead">	<h2 class="hn"><span><?php echo $lang_topic['Quick post'] ?></span></h2></div><div id="brd-qpost" class="main-content main-frm"><?php if (!empty($forum_page['text_options'])) echo "\t".'<p class="content-options options">'.sprintf($lang_common['You may use'], implode(' ', $forum_page['text_options'])).'</p>'."\n" ?>	<div id="req-msg" class="req-warn ct-box error-box">		<p class="important"><?php echo $lang_topic['Required warn'] ?></p>	</div>	<form class="frm-form frm-ctrl-submit" method="post" accept-charset="utf-8" action="<?php echo $forum_page['form_action'] ?>"<?php if (!empty($forum_page['form_attributes'])) echo ' '.implode(' ', $forum_page['form_attributes']) ?>>		<div class="hidden">			<?php echo implode("\n\t\t\t\t", $forum_page['hidden_fields'])."\n" ?>		</div><?php ($hook = get_hook('vt_quickpost_pre_fieldset')) ? eval($hook) : null; ?>		<fieldset class="frm-group group1">			<legend class="group-legend"><strong><?php echo $lang_common['Write message legend'] ?></strong></legend><?php ($hook = get_hook('vt_quickpost_pre_message_box')) ? eval($hook) : null; ?>			<div class="txt-set set1">				<div class="txt-box textarea required">					<label for="fld1"><span><?php echo $lang_common['Write message'] ?></span></label>					<div class="txt-input"><span class="fld-input"><textarea id="fld1" name="req_message" rows="7" cols="95" required spellcheck="true" ></textarea></span></div>				</div>			</div><?php ($hook = get_hook('vt_quickpost_pre_fieldset_end')) ? eval($hook) : null; ?>		</fieldset><?php ($hook = get_hook('vt_quickpost_fieldset_end')) ? eval($hook) : null; ?>		<div class="frm-buttons">			<span class="submit primary"><input type="submit" name="submit_button" value="<?php echo $lang_common['Submit'] ?>" /></span>			<span class="submit"><input type="submit" name="preview" value="<?php echo $lang_common['Preview'] ?>" /></span>		</div>	</form></div><?php($hook = get_hook('vt_quickpost_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_qpost -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_qpost -->}// Increment "num_views" for topicif ($forum_config['o_topic_views'] == '1'){	$query = array(		'UPDATE'	=> 'topics',		'SET'		=> 'num_views=num_views+1',		'WHERE'		=> 'id='.$id,	);	($hook = get_hook('vt_qr_increment_num_views')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);}$forum_id = $cur_topic['forum_id'];require FORUM_ROOT.'footer.php';
<?php/** * Displays a list of the categories/forums that the current user can see, along with some statistics. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', './');require FORUM_ROOT.'include/common.php';($hook = get_hook('in_start')) ? eval($hook) : null;if ($forum_user['g_read_board'] == '0')	message($lang_common['No view']);// Load the index.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/index.php';// Get list of forums and topics with new posts since last visitif (!$forum_user['is_guest']){	$query = array(		'SELECT'	=> 't.forum_id, t.id, t.last_post',		'FROM'		=> 'topics AS t',		'JOINS'		=> array(			array(				'INNER JOIN'	=> 'forums AS f',				'ON'			=> 'f.id=t.forum_id'			),			array(				'LEFT JOIN'		=> 'forum_perms AS fp',				'ON'			=> '(fp.forum_id=f.id AND fp.group_id='.$forum_user['g_id'].')'			)		),		'WHERE'		=> '(fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.$forum_user['last_visit'].' AND t.moved_to IS NULL'	);	($hook = get_hook('in_qr_get_new_topics')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$new_topics = array();	while ($cur_topic = $forum_db->fetch_assoc($result))		$new_topics[$cur_topic['forum_id']][$cur_topic['id']] = $cur_topic['last_post'];	$tracked_topics = get_tracked_topics();}// Setup main heading$forum_page['main_title'] = forum_htmlencode($forum_config['o_board_title']);($hook = get_hook('in_pre_header_load')) ? eval($hook) : null;define('FORUM_ALLOW_INDEX', 1);define('FORUM_PAGE', 'index');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('in_main_output_start')) ? eval($hook) : null;// Print the categories and forums$query = array(	'SELECT'	=> 'c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.forum_desc, f.redirect_url, f.moderators, f.num_topics, f.num_posts, f.last_post, f.last_post_id, f.last_poster',	'FROM'		=> 'categories AS c',	'JOINS'		=> array(		array(			'INNER JOIN'	=> 'forums AS f',			'ON'			=> 'c.id=f.cat_id'		),		array(			'LEFT JOIN'		=> 'forum_perms AS fp',			'ON'			=> '(fp.forum_id=f.id AND fp.group_id='.$forum_user['g_id'].')'		)	),	'WHERE'		=> 'fp.read_forum IS NULL OR fp.read_forum=1',	'ORDER BY'	=> 'c.disp_position, c.id, f.disp_position');($hook = get_hook('in_qr_get_cats_and_forums')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$forum_page['cur_category'] = $forum_page['cat_count'] = $forum_page['item_count'] = 0;while ($cur_forum = $forum_db->fetch_assoc($result)){	($hook = get_hook('in_forum_loop_start')) ? eval($hook) : null;	++$forum_page['item_count'];	if ($cur_forum['cid'] != $forum_page['cur_category'])	// A new category since last iteration?	{		if ($forum_page['cur_category'] != 0)			echo "\t".'</div>'."\n";		++$forum_page['cat_count'];		$forum_page['item_count'] = 1;		$forum_page['item_header'] = array();		$forum_page['item_header']['subject']['title'] = '<strong class="subject-title">'.$lang_index['Forums'].'</strong>';		$forum_page['item_header']['info']['topics'] = '<strong class="info-topics">'.$lang_index['topics'].'</strong>';		$forum_page['item_header']['info']['post'] = '<strong class="info-posts">'.$lang_index['posts'].'</strong>';		$forum_page['item_header']['info']['lastpost'] = '<strong class="info-lastpost">'.$lang_index['last post'].'</strong>';		($hook = get_hook('in_forum_pre_cat_head')) ? eval($hook) : null;		$forum_page['cur_category'] = $cur_forum['cid'];?>	<div class="main-head">		<h2 class="hn"><span><?php echo forum_htmlencode($cur_forum['cat_name']) ?></span></h2>	</div>	<div class="main-subhead">		<p class="item-summary"><span><?php printf($lang_index['Category subtitle'], implode(' ', $forum_page['item_header']['subject']), implode(', ', $forum_page['item_header']['info'])) ?></span></p>	</div>	<div id="category<?php echo $forum_page['cat_count'] ?>" class="main-content main-category"><?php	}	// Reset arrays and globals for each forum	$forum_page['item_status'] = $forum_page['item_subject'] = $forum_page['item_body'] = $forum_page['item_title'] = array();	// Is this a redirect forum?	if ($cur_forum['redirect_url'] != '')	{		$forum_page['item_body']['subject']['title'] = '<h3 class="hn"><a class="external" href="'.forum_htmlencode($cur_forum['redirect_url']).'" title="'.sprintf($lang_index['Link to'], forum_htmlencode($cur_forum['redirect_url'])).'"><span>'.forum_htmlencode($cur_forum['forum_name']).'</span></a></h3>';		$forum_page['item_status']['redirect'] = 'redirect';		if ($cur_forum['forum_desc'] != '')			$forum_page['item_subject']['desc'] = $cur_forum['forum_desc'];		$forum_page['item_subject']['redirect'] = '<span>'.$lang_index['External forum'].'</span>';		($hook = get_hook('in_redirect_row_pre_item_subject_merge')) ? eval($hook) : null;		if (!empty($forum_page['item_subject']))			$forum_page['item_body']['subject']['desc'] = '<p>'.implode(' ', $forum_page['item_subject']).'</p>';		// Forum topic and post count		$forum_page['item_body']['info']['topics'] = '<li class="info-topics"><span class="label">'.$lang_index['No topic info'].'</span></li>';		$forum_page['item_body']['info']['posts'] = '<li class="info-posts"><span class="label">'.$lang_index['No post info'].'</span></li>';		$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><span class="label">'.$lang_index['No lastpost info'].'</span></li>';		($hook = get_hook('in_redirect_row_pre_display')) ? eval($hook) : null;	}	else	{		// Setup the title and link to the forum		$forum_page['item_title']['title'] = '<a href="'.forum_link($forum_url['forum'], array($cur_forum['fid'], sef_friendly($cur_forum['forum_name']))).'"><span>'.forum_htmlencode($cur_forum['forum_name']).'</span></a>';		// Are there new posts since our last visit?		if (!$forum_user['is_guest'] && $cur_forum['last_post'] > $forum_user['last_visit'] && (empty($tracked_topics['forums'][$cur_forum['fid']]) || $cur_forum['last_post'] > $tracked_topics['forums'][$cur_forum['fid']]))		{			// There are new posts in this forum, but have we read all of them already?			foreach ($new_topics[$cur_forum['fid']] as $check_topic_id => $check_last_post)			{				if ((empty($tracked_topics['topics'][$check_topic_id]) || $tracked_topics['topics'][$check_topic_id] < $check_last_post) && (empty($tracked_topics['forums'][$cur_forum['fid']]) || $tracked_topics['forums'][$cur_forum['fid']] < $check_last_post))				{					$forum_page['item_status']['new'] = 'new';					$forum_page['item_title']['status'] = '<small>'.sprintf($lang_index['Forum has new'], '<a href="'.forum_link($forum_url['search_new_results'], $cur_forum['fid']).'" title="'.$lang_index['New posts title'].'">'.$lang_index['Forum new posts'].'</a>').'</small>';					break;				}			}		}		($hook = get_hook('in_normal_row_pre_item_title_merge')) ? eval($hook) : null;		$forum_page['item_body']['subject']['title'] = '<h3 class="hn">'.implode(' ', $forum_page['item_title']).'</h3>';		// Setup the forum description and mod list		if ($cur_forum['forum_desc'] != '')			$forum_page['item_subject']['desc'] = $cur_forum['forum_desc'];		if ($forum_config['o_show_moderators'] == '1' && $cur_forum['moderators'] != '')		{			$forum_page['mods_array'] = unserialize($cur_forum['moderators']);			$forum_page['item_mods'] = array();			foreach ($forum_page['mods_array'] as $mod_username => $mod_id)				$forum_page['item_mods'][] = ($forum_user['g_view_users'] == '1') ? '<a href="'.forum_link($forum_url['user'], $mod_id).'">'.forum_htmlencode($mod_username).'</a>' : forum_htmlencode($mod_username);			($hook = get_hook('in_row_modify_modlist')) ? eval($hook) : null;			$forum_page['item_subject']['modlist'] = '<span class="modlist">'.sprintf($lang_index['Moderated by'], implode(', ', $forum_page['item_mods'])).'</span>';		}		($hook = get_hook('in_normal_row_pre_item_subject_merge')) ? eval($hook) : null;		if (!empty($forum_page['item_subject']))			$forum_page['item_body']['subject']['desc'] = '<p>'.implode(' ', $forum_page['item_subject']).'</p>';		// Setup forum topics, post count and last post		$forum_page['item_body']['info']['topics'] = '<li class="info-topics"><strong>'.forum_number_format($cur_forum['num_topics']).'</strong> <span class="label">'.(($cur_forum['num_topics'] == 1) ? $lang_index['topic'] : $lang_index['topics']).'</span></li>';		$forum_page['item_body']['info']['posts'] = '<li class="info-posts"><strong>'.forum_number_format($cur_forum['num_posts']).'</strong> <span class="label">'.(($cur_forum['num_posts'] == 1) ? $lang_index['post'] : $lang_index['posts']).'</span></li>';		if ($cur_forum['last_post'] != '')			$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><span class="label">'.$lang_index['Last post'].'</span> <strong><a href="'.forum_link($forum_url['post'], $cur_forum['last_post_id']).'">'.format_time($cur_forum['last_post']).'</a></strong> <cite>'.sprintf($lang_index['Last poster'], forum_htmlencode($cur_forum['last_poster'])).'</cite></li>';		else			$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><strong>'.$lang_common['Never'].'</strong></li>';		($hook = get_hook('in_normal_row_pre_display')) ? eval($hook) : null;	}	// Generate classes for this forum depending on its status	$forum_page['item_style'] = (($forum_page['item_count'] % 2 != 0) ? ' odd' : ' even').(($forum_page['item_count'] == 1) ? ' main-first-item' : '').((!empty($forum_page['item_status'])) ? ' '.implode(' ', $forum_page['item_status']) : '');	($hook = get_hook('in_row_pre_display')) ? eval($hook) : null;?>		<div id="forum<?php echo $cur_forum['fid'] ?>" class="main-item<?php echo $forum_page['item_style'] ?>">			<span class="icon <?php echo implode(' ', $forum_page['item_status']) ?>"><!-- --></span>			<div class="item-subject">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['subject'])."\n" ?>			</div>			<ul class="item-info">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['info'])."\n" ?>			</ul>		</div><?php}// Did we output any categories and forums?if ($forum_page['cur_category'] > 0){?>	</div><?php}else{?>	<div class="main-head">		<h2 class="hn"><span><?php echo $lang_common['Forum message']?></span></h2>	</div>	<div class="main-content main-message">		<p><?php echo $lang_index['Empty board'] ?></p>	</div><?php}($hook = get_hook('in_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->// START SUBST - <!-- forum_info -->ob_start();($hook = get_hook('in_info_output_start')) ? eval($hook) : null;if (file_exists(FORUM_CACHE_DIR.'cache_stats.php'))	include FORUM_CACHE_DIR.'cache_stats.php';// Regenerate cache only if the cache is more than 30 minutes oldif (!defined('FORUM_STATS_LOADED') || $forum_stats['cached'] < (time() - 1800)){	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_stats_cache();	require FORUM_CACHE_DIR.'cache_stats.php';}$stats_list['no_of_users'] = '<li class="st-users"><span>'.sprintf($lang_index['No of users'], '<strong>'.forum_number_format($forum_stats['total_users']).'</strong>').'</span></li>';$stats_list['newest_user'] = '<li class="st-users"><span>'.sprintf($lang_index['Newest user'], '<strong>'.($forum_user['g_view_users'] == '1' ? '<a href="'.forum_link($forum_url['user'], $forum_stats['last_user']['id']).'">'.forum_htmlencode($forum_stats['last_user']['username']).'</a>' : forum_htmlencode($forum_stats['last_user']['username'])).'</strong>').'</span></li>';$stats_list['no_of_topics'] = '<li class="st-activity"><span>'.sprintf($lang_index['No of topics'], '<strong>'.forum_number_format($forum_stats['total_topics']).'</strong>').'</span></li>';$stats_list['no_of_posts'] = '<li class="st-activity"><span>'.sprintf($lang_index['No of posts'], '<strong>'.forum_number_format($forum_stats['total_posts']).'</strong>').'</span></li>';($hook = get_hook('in_stats_pre_info_output')) ? eval($hook) : null;?><div id="brd-stats" class="gen-content">	<h2 class="hn"><span><?php echo $lang_index['Statistics'] ?></span></h2>	<ul>		<?php echo implode("\n\t\t", $stats_list)."\n" ?>	</ul></div><?php($hook = get_hook('in_stats_end')) ? eval($hook) : null;($hook = get_hook('in_users_online_start')) ? eval($hook) : null;if ($forum_config['o_users_online'] == '1'){	// Fetch users online info and generate strings for output	$query = array(		'SELECT'	=> 'o.user_id, o.ident',		'FROM'		=> 'online AS o',		'WHERE'		=> 'o.idle=0',		'ORDER BY'	=> 'o.ident'	);	($hook = get_hook('in_users_online_qr_get_online_info')) ? eval($hook) : null;	$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);	$forum_page['num_guests'] = $forum_page['num_users'] = 0;	$users = array();	while ($forum_user_online = $forum_db->fetch_assoc($result))	{		($hook = get_hook('in_users_online_add_online_user_loop')) ? eval($hook) : null;		if ($forum_user_online['user_id'] > 1)		{			$users[] = ($forum_user['g_view_users'] == '1') ? '<a href="'.forum_link($forum_url['user'], $forum_user_online['user_id']).'">'.forum_htmlencode($forum_user_online['ident']).'</a>' : forum_htmlencode($forum_user_online['ident']);			++$forum_page['num_users'];		}		else			++$forum_page['num_guests'];	}	$forum_page['online_info'] = array();	$forum_page['online_info']['guests'] = ($forum_page['num_guests'] == 0) ? $lang_index['Guests none'] : sprintf((($forum_page['num_guests'] == 1) ? $lang_index['Guests single'] : $lang_index['Guests plural']), forum_number_format($forum_page['num_guests']));	$forum_page['online_info']['users'] = ($forum_page['num_users'] == 0) ? $lang_index['Users none'] : sprintf((($forum_page['num_users'] == 1) ? $lang_index['Users single'] : $lang_index['Users plural']), forum_number_format($forum_page['num_users']));	($hook = get_hook('in_users_online_pre_online_info_output')) ? eval($hook) : null;?><div id="brd-online" class="gen-content">	<h3 class="hn"><span><?php printf($lang_index['Currently online'], implode($lang_index['Online stats separator'], $forum_page['online_info'])) ?></span></h3><?php if (!empty($users)): ?>	<p><?php echo implode($lang_index['Online list separator'], $users) ?></p><?php endif; ($hook = get_hook('in_new_online_data')) ? eval($hook) : null; ?></div><?php	($hook = get_hook('in_users_online_end')) ? eval($hook) : null;}($hook = get_hook('in_info_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_info -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_info -->require FORUM_ROOT.'footer.php';
<?php/** * A database layer class that relies on the MySQL PHP extension. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure we have built in support for MySQLif (!function_exists('mysql_connect'))	exit('This PHP environment doesn\'t have MySQL support built in. MySQL support is required if you want to use a MySQL database to run this forum. Consult the PHP documentation for further assistance.');class DBLayer{	var $prefix;	var $link_id;	var $query_result;	var $in_transaction = 0;	var $saved_queries = array();	var $num_queries = 0;	var $datatype_transformations = array(		'/^SERIAL$/'	=>	'INT(10) UNSIGNED AUTO_INCREMENT'	);	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)	{		$this->prefix = $db_prefix;		if ($p_connect)			$this->link_id = @mysql_pconnect($db_host, $db_username, $db_password);		else			$this->link_id = @mysql_connect($db_host, $db_username, $db_password);		if ($this->link_id)		{			if (!@mysql_select_db($db_name, $this->link_id))				error('Unable to select database. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		}		else			error('Unable to connect to MySQL server. MySQL reported: '.mysql_error(), __FILE__, __LINE__);		// Setup the client-server character set (UTF-8)		if (!defined('FORUM_NO_SET_NAMES'))			$this->set_names('utf8');		return $this->link_id;	}	function start_transaction()	{		++$this->in_transaction;		return mysql_query('START TRANSACTION', $this->link_id);	}	function end_transaction()	{		--$this->in_transaction;		if (mysql_query('COMMIT', $this->link_id))			return true;		else		{			mysql_query('ROLLBACK', $this->link_id);			return false;		}	}	function query($sql, $unbuffered = false)	{		if (strlen($sql) > 140000)			exit('Insane query. Aborting.');		if (defined('FORUM_SHOW_QUERIES'))			$q_start = forum_microtime();		if ($unbuffered)			$this->query_result = @mysql_unbuffered_query($sql, $this->link_id);		else			$this->query_result = @mysql_query($sql, $this->link_id);		if ($this->query_result)		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, sprintf('%.5f', forum_microtime() - $q_start));			++$this->num_queries;			return $this->query_result;		}		else		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, 0);			if ($this->in_transaction)				mysql_query('ROLLBACK', $this->link_id);			--$this->in_transaction;			return false;		}	}	function query_build($query, $return_query_string = false, $unbuffered = false)	{		$sql = '';		if (isset($query['SELECT']))		{			$sql = 'SELECT '.$query['SELECT'].' FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['FROM'];			if (isset($query['JOINS']))			{				foreach ($query['JOINS'] as $cur_join)					$sql .= ' '.key($cur_join).' '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).current($cur_join).' ON '.$cur_join['ON'];			}			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];			if (!empty($query['GROUP BY']))				$sql .= ' GROUP BY '.$query['GROUP BY'];			if (!empty($query['HAVING']))				$sql .= ' HAVING '.$query['HAVING'];			if (!empty($query['ORDER BY']))				$sql .= ' ORDER BY '.$query['ORDER BY'];			if (!empty($query['LIMIT']))				$sql .= ' LIMIT '.$query['LIMIT'];		}		else if (isset($query['INSERT']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['INSERT']))				$sql .= ' ('.$query['INSERT'].')';			if (is_array($query['VALUES']))				$sql .= ' VALUES('.implode('),(', $query['VALUES']).')';			else				$sql .= ' VALUES('.$query['VALUES'].')';		}		else if (isset($query['UPDATE']))		{			$query['UPDATE'] = (isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['UPDATE'];			$sql = 'UPDATE '.$query['UPDATE'].' SET '.$query['SET'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['DELETE']))		{			$sql = 'DELETE FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['DELETE'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['REPLACE']))		{			$sql = 'REPLACE INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['REPLACE']))				$sql .= ' ('.$query['REPLACE'].')';			$sql .= ' VALUES('.$query['VALUES'].')';		}		return ($return_query_string) ? $sql : $this->query($sql, $unbuffered);	}	function result($query_id = 0, $row = 0, $col = 0)	{		return ($query_id) ? @mysql_result($query_id, $row, $col) : false;	}	function fetch_assoc($query_id = 0)	{		return ($query_id) ? @mysql_fetch_assoc($query_id) : false;	}	function fetch_row($query_id = 0)	{		return ($query_id) ? @mysql_fetch_row($query_id) : false;	}	function num_rows($query_id = 0)	{		return ($query_id) ? @mysql_num_rows($query_id) : false;	}	function affected_rows()	{		return ($this->link_id) ? @mysql_affected_rows($this->link_id) : false;	}	function insert_id()	{		return ($this->link_id) ? @mysql_insert_id($this->link_id) : false;	}	function get_num_queries()	{		return $this->num_queries;	}	function get_saved_queries()	{		return $this->saved_queries;	}	function free_result($query_id = false)	{		return ($query_id) ? @mysql_free_result($query_id) : false;	}	function escape($str)	{		if (is_array($str))			return '';		else if (function_exists('mysql_real_escape_string'))			return mysql_real_escape_string($str, $this->link_id);		else			return mysql_escape_string($str);	}	function error()	{		$result['error_sql'] = @current(@end($this->saved_queries));		$result['error_no'] = @mysql_errno($this->link_id);		$result['error_msg'] = @mysql_error($this->link_id);		return $result;	}	function close()	{		if ($this->link_id)		{			if ($this->query_result)				@mysql_free_result($this->query_result);			return @mysql_close($this->link_id);		}		else			return false;	}	function set_names($names)	{		return $this->query('SET NAMES \''.$this->escape($names).'\'');	}	function get_version()	{		$result = $this->query('SELECT VERSION()');		return array(			'name'		=> 'MySQL Standard (InnoDB)',			'version'	=> preg_replace('/^([^-]+).*$/', '\\1', $this->result($result))		);	}	function table_exists($table_name, $no_prefix = false)	{		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');		return $this->num_rows($result) > 0;	}	function field_exists($table_name, $field_name, $no_prefix = false)	{		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');		return $this->num_rows($result) > 0;	}	function index_exists($table_name, $index_name, $no_prefix = false)	{		$exists = false;		$result = $this->query('SHOW INDEX FROM '.($no_prefix ? '' : $this->prefix).$table_name);		while ($cur_index = $this->fetch_assoc($result))		{			if ($cur_index['Key_name'] == ($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name)			{				$exists = true;				break;			}		}		return $exists;	}	function create_table($table_name, $schema, $no_prefix = false)	{		if ($this->table_exists($table_name, $no_prefix))			return;		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";		// Go through every schema element and add it to the query		foreach ($schema['FIELDS'] as $field_name => $field_data)		{			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);			$query .= $field_name.' '.$field_data['datatype'];			if (isset($field_data['collation']))				$query .= 'CHARACTER SET utf8 COLLATE utf8_'.$field_data['collation'];			if (!$field_data['allow_null'])				$query .= ' NOT NULL';			if (isset($field_data['default']))				$query .= ' DEFAULT '.$field_data['default'];			$query .= ",\n";		}		// If we have a primary key, add it		if (isset($schema['PRIMARY KEY']))			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";		// Add unique keys		if (isset($schema['UNIQUE KEYS']))		{			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)				$query .= 'UNIQUE KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$key_name.'('.implode(',', $key_fields).'),'."\n";		}		// Add indexes		if (isset($schema['INDEXES']))		{			foreach ($schema['INDEXES'] as $index_name => $index_fields)				$query .= 'KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.'('.implode(',', $index_fields).'),'."\n";		}		// We remove the last two characters (a newline and a comma) and add on the ending		$query = substr($query, 0, strlen($query) - 2)."\n".') ENGINE = '.(isset($schema['ENGINE']) ? $schema['ENGINE'] : 'InnoDB').' CHARACTER SET utf8';		$this->query($query) or error(__FILE__, __LINE__);	}	function drop_table($table_name, $no_prefix = false)	{		if (!$this->table_exists($table_name, $no_prefix))			return;		$this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) or error(__FILE__, __LINE__);	}	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if ($this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		if ($default_value !== null && !is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' MODIFY '.$field_name.' '.$field_type.($allow_null ? ' ' : ' NOT NULL').($default_value !== null ? ' DEFAULT '.$default_value : ' ').($after_field != null ? ' AFTER '.$after_field : '')) or error(__FILE__, __LINE__);	}	function drop_field($table_name, $field_name, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) or error(__FILE__, __LINE__);	}	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)	{		if ($this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ('.implode(',', $index_fields).')') or error(__FILE__, __LINE__);	}	function drop_index($table_name, $index_name, $no_prefix = false)	{		if (!$this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) or error(__FILE__, __LINE__);	}}
<?php/*** Utilities for processing "special" characters in UTF-8. "Special" largely means anything which would* be regarded as a non-word character, like ASCII control characters and punctuation. This has a "Roman"* bias - it would be unaware of modern Chinese "punctuation" characters for example.* Note: requires utils/unicode.php to be loaded* @version $Id: specials.php,v 1.2 2006/10/16 21:13:59 harryf Exp $* @package utf8* @subpackage utils* @see utf8_is_valid*///--------------------------------------------------------------------/*** Used internally. Builds a PCRE pattern from the $UTF8_SPECIAL_CHARS * array defined in this file* The $UTF8_SPECIAL_CHARS should contain all special characters (non-letter/non-digit)* defined in the various local charsets - it's not a complete list of* non-alphanum characters in UTF-8. It's not perfect but should match most* cases of special chars.* This function adds the control chars 0x00 to 0x19 to the array of* special chars (they are not included in $UTF8_SPECIAL_CHARS)* @package utf8* @subpackage utils* @return string* @see utf8_from_unicode* @see utf8_is_word_chars* @see utf8_strip_specials*/function utf8_specials_pattern() {    static $pattern = NULL;    if ( !$pattern ) {        $UTF8_SPECIAL_CHARS = array(    0x001a, 0x001b, 0x001c, 0x001d, 0x001e, 0x001f, 0x0020, 0x0021, 0x0022, 0x0023,    0x0024, 0x0025, 0x0026, 0x0027, 0x0028, 0x0029, 0x002a, 0x002b, 0x002c,    0x002f,         0x003b, 0x003c, 0x003d, 0x003e, 0x003f, 0x0040, 0x005b,    0x005c, 0x005d, 0x005e,         0x0060, 0x007b, 0x007c, 0x007d, 0x007e,    0x007f, 0x0080, 0x0081, 0x0082, 0x0083, 0x0084, 0x0085, 0x0086, 0x0087, 0x0088,    0x0089, 0x008a, 0x008b, 0x008c, 0x008d, 0x008e, 0x008f, 0x0090, 0x0091, 0x0092,    0x0093, 0x0094, 0x0095, 0x0096, 0x0097, 0x0098, 0x0099, 0x009a, 0x009b, 0x009c,    0x009d, 0x009e, 0x009f, 0x00a0, 0x00a1, 0x00a2, 0x00a3, 0x00a4, 0x00a5, 0x00a6,    0x00a7, 0x00a8, 0x00a9, 0x00aa, 0x00ab, 0x00ac, 0x00ad, 0x00ae, 0x00af, 0x00b0,    0x00b1, 0x00b2, 0x00b3, 0x00b4, 0x00b5, 0x00b6, 0x00b7, 0x00b8, 0x00b9, 0x00ba,    0x00bb, 0x00bc, 0x00bd, 0x00be, 0x00bf, 0x00d7, 0x00f7, 0x02c7, 0x02d8, 0x02d9,    0x02da, 0x02db, 0x02dc, 0x02dd, 0x0300, 0x0301, 0x0303, 0x0309, 0x0323, 0x0384,    0x0385, 0x0387, 0x03b2, 0x03c6, 0x03d1, 0x03d2, 0x03d5, 0x03d6, 0x05b0, 0x05b1,    0x05b2, 0x05b3, 0x05b4, 0x05b5, 0x05b6, 0x05b7, 0x05b8, 0x05b9, 0x05bb, 0x05bc,    0x05bd, 0x05be, 0x05bf, 0x05c0, 0x05c1, 0x05c2, 0x05c3, 0x05f3, 0x05f4, 0x060c,    0x061b, 0x061f, 0x0640, 0x064b, 0x064c, 0x064d, 0x064e, 0x064f, 0x0650, 0x0651,    0x0652, 0x066a, 0x0e3f, 0x200c, 0x200d, 0x200e, 0x200f, 0x2013, 0x2014, 0x2015,    0x2017, 0x2018, 0x2019, 0x201a, 0x201c, 0x201d, 0x201e, 0x2020, 0x2021, 0x2022,    0x2026, 0x2030, 0x2032, 0x2033, 0x2039, 0x203a, 0x2044, 0x20a7, 0x20aa, 0x20ab,    0x20ac, 0x2116, 0x2118, 0x2122, 0x2126, 0x2135, 0x2190, 0x2191, 0x2192, 0x2193,    0x2194, 0x2195, 0x21b5, 0x21d0, 0x21d1, 0x21d2, 0x21d3, 0x21d4, 0x2200, 0x2202,    0x2203, 0x2205, 0x2206, 0x2207, 0x2208, 0x2209, 0x220b, 0x220f, 0x2211, 0x2212,    0x2215, 0x2217, 0x2219, 0x221a, 0x221d, 0x221e, 0x2220, 0x2227, 0x2228, 0x2229,    0x222a, 0x222b, 0x2234, 0x223c, 0x2245, 0x2248, 0x2260, 0x2261, 0x2264, 0x2265,    0x2282, 0x2283, 0x2284, 0x2286, 0x2287, 0x2295, 0x2297, 0x22a5, 0x22c5, 0x2310,    0x2320, 0x2321, 0x2329, 0x232a, 0x2469, 0x2500, 0x2502, 0x250c, 0x2510, 0x2514,    0x2518, 0x251c, 0x2524, 0x252c, 0x2534, 0x253c, 0x2550, 0x2551, 0x2552, 0x2553,    0x2554, 0x2555, 0x2556, 0x2557, 0x2558, 0x2559, 0x255a, 0x255b, 0x255c, 0x255d,    0x255e, 0x255f, 0x2560, 0x2561, 0x2562, 0x2563, 0x2564, 0x2565, 0x2566, 0x2567,    0x2568, 0x2569, 0x256a, 0x256b, 0x256c, 0x2580, 0x2584, 0x2588, 0x258c, 0x2590,    0x2591, 0x2592, 0x2593, 0x25a0, 0x25b2, 0x25bc, 0x25c6, 0x25ca, 0x25cf, 0x25d7,    0x2605, 0x260e, 0x261b, 0x261e, 0x2660, 0x2663, 0x2665, 0x2666, 0x2701, 0x2702,    0x2703, 0x2704, 0x2706, 0x2707, 0x2708, 0x2709, 0x270c, 0x270d, 0x270e, 0x270f,    0x2710, 0x2711, 0x2712, 0x2713, 0x2714, 0x2715, 0x2716, 0x2717, 0x2718, 0x2719,    0x271a, 0x271b, 0x271c, 0x271d, 0x271e, 0x271f, 0x2720, 0x2721, 0x2722, 0x2723,    0x2724, 0x2725, 0x2726, 0x2727, 0x2729, 0x272a, 0x272b, 0x272c, 0x272d, 0x272e,    0x272f, 0x2730, 0x2731, 0x2732, 0x2733, 0x2734, 0x2735, 0x2736, 0x2737, 0x2738,    0x2739, 0x273a, 0x273b, 0x273c, 0x273d, 0x273e, 0x273f, 0x2740, 0x2741, 0x2742,    0x2743, 0x2744, 0x2745, 0x2746, 0x2747, 0x2748, 0x2749, 0x274a, 0x274b, 0x274d,    0x274f, 0x2750, 0x2751, 0x2752, 0x2756, 0x2758, 0x2759, 0x275a, 0x275b, 0x275c,    0x275d, 0x275e, 0x2761, 0x2762, 0x2763, 0x2764, 0x2765, 0x2766, 0x2767, 0x277f,    0x2789, 0x2793, 0x2794, 0x2798, 0x2799, 0x279a, 0x279b, 0x279c, 0x279d, 0x279e,    0x279f, 0x27a0, 0x27a1, 0x27a2, 0x27a3, 0x27a4, 0x27a5, 0x27a6, 0x27a7, 0x27a8,    0x27a9, 0x27aa, 0x27ab, 0x27ac, 0x27ad, 0x27ae, 0x27af, 0x27b1, 0x27b2, 0x27b3,    0x27b4, 0x27b5, 0x27b6, 0x27b7, 0x27b8, 0x27b9, 0x27ba, 0x27bb, 0x27bc, 0x27bd,    0x27be, 0xf6d9, 0xf6da, 0xf6db, 0xf8d7, 0xf8d8, 0xf8d9, 0xf8da, 0xf8db, 0xf8dc,    0xf8dd, 0xf8de, 0xf8df, 0xf8e0, 0xf8e1, 0xf8e2, 0xf8e3, 0xf8e4, 0xf8e5, 0xf8e6,    0xf8e7, 0xf8e8, 0xf8e9, 0xf8ea, 0xf8eb, 0xf8ec, 0xf8ed, 0xf8ee, 0xf8ef, 0xf8f0,    0xf8f1, 0xf8f2, 0xf8f3, 0xf8f4, 0xf8f5, 0xf8f6, 0xf8f7, 0xf8f8, 0xf8f9, 0xf8fa,    0xf8fb, 0xf8fc, 0xf8fd, 0xf8fe, 0xfe7c, 0xfe7d,            );        $pattern = preg_quote(utf8_from_unicode($UTF8_SPECIAL_CHARS), '/');        $pattern = '/[\x00-\x19'.$pattern.']/u';    }    return $pattern;}//--------------------------------------------------------------------/*** Checks a string for whether it contains only word characters. This* is logically equivalent to the \w PCRE meta character. Note that* this is not a 100% guarantee that the string only contains alpha /* numeric characters but just that common non-alphanumeric are not* in the string, including ASCII device control characters.* @package utf8* @subpackage utils* @param string to check* @return boolean TRUE if the string only contains word characters* @see utf8_specials_pattern*/function utf8_is_word_chars($str) {    return !(bool)preg_match(utf8_specials_pattern(),$str);}//--------------------------------------------------------------------/*** Removes special characters (nonalphanumeric) from a UTF-8 string* * This can be useful as a helper for sanitizing a string for use as* something like a file name or a unique identifier. Be warned though* it does not handle all possible non-alphanumeric characters and is* not intended is some kind of security / injection filter.** @package utf8* @subpackage utils* @author Andreas Gohr <andi@splitbrain.org>* @param string $string The UTF8 string to strip of special chars* @param string (optional) $repl   Replace special with this string* @return string with common non-alphanumeric characters removed* @see utf8_specials_pattern*/function utf8_strip_specials($string, $repl=''){    return preg_replace(utf8_specials_pattern(), $repl, $string);}
<?php/** * Lists the topics in the specified forum. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', './');require FORUM_ROOT.'include/common.php';($hook = get_hook('vf_start')) ? eval($hook) : null;if ($forum_user['g_read_board'] == '0')	message($lang_common['No view']);// Load the viewforum.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/forum.php';$id = isset($_GET['id']) ? intval($_GET['id']) : 0;if ($id < 1)	message($lang_common['Bad request']);// Fetch some info about the forum$query = array(	'SELECT'	=> 'f.forum_name, f.redirect_url, f.moderators, f.num_topics, f.sort_by, fp.post_topics',	'FROM'		=> 'forums AS f',	'JOINS'		=> array(		array(			'LEFT JOIN'		=> 'forum_perms AS fp',			'ON'			=> '(fp.forum_id=f.id AND fp.group_id='.$forum_user['g_id'].')'		)	),	'WHERE'		=> '(fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$id);($hook = get_hook('vf_qr_get_forum_info')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$cur_forum = $forum_db->fetch_assoc($result);if (!$cur_forum)	message($lang_common['Bad request']);($hook = get_hook('vf_modify_forum_info')) ? eval($hook) : null;// Is this a redirect forum? In that case, redirect!if ($cur_forum['redirect_url'] != ''){	($hook = get_hook('vf_redirect_forum_pre_redirect')) ? eval($hook) : null;	header('Location: '.$cur_forum['redirect_url']);	exit;}// Sort out who the moderators are and if we are currently a moderator (or an admin)$mods_array = ($cur_forum['moderators'] != '') ? unserialize($cur_forum['moderators']) : array();$forum_page['is_admmod'] = ($forum_user['g_id'] == FORUM_ADMIN || ($forum_user['g_moderator'] == '1' && array_key_exists($forum_user['username'], $mods_array))) ? true : false;// Sort out whether or not this user can post$forum_user['may_post'] = (($cur_forum['post_topics'] == '' && $forum_user['g_post_topics'] == '1') || $cur_forum['post_topics'] == '1' || $forum_page['is_admmod']) ? true : false;// Get topic/forum tracking dataif (!$forum_user['is_guest'])	$tracked_topics = get_tracked_topics();// Determine the topic offset (based on $_GET['p'])$forum_page['num_pages'] = ceil($cur_forum['num_topics'] / $forum_user['disp_topics']);$forum_page['page'] = (!isset($_GET['p']) || !is_numeric($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $forum_page['num_pages']) ? 1 : $_GET['p'];$forum_page['start_from'] = $forum_user['disp_topics'] * ($forum_page['page'] - 1);$forum_page['finish_at'] = min(($forum_page['start_from'] + $forum_user['disp_topics']), ($cur_forum['num_topics']));$forum_page['items_info'] = generate_items_info($lang_forum['Topics'], ($forum_page['start_from'] + 1), $cur_forum['num_topics']);($hook = get_hook('vf_modify_page_details')) ? eval($hook) : null;// Navigation links for header and page numbering for title/meta descriptionif ($forum_page['page'] < $forum_page['num_pages']){	$forum_page['nav']['last'] = '<link rel="last" href="'.forum_sublink($forum_url['forum'], $forum_url['page'], $forum_page['num_pages'], array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' '.$forum_page['num_pages'].'" />';	$forum_page['nav']['next'] = '<link rel="next" href="'.forum_sublink($forum_url['forum'], $forum_url['page'], ($forum_page['page'] + 1), array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' '.($forum_page['page'] + 1).'" />';}if ($forum_page['page'] > 1){	$forum_page['nav']['prev'] = '<link rel="prev" href="'.forum_sublink($forum_url['forum'], $forum_url['page'], ($forum_page['page'] - 1), array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' '.($forum_page['page'] - 1).'" />';	$forum_page['nav']['first'] = '<link rel="first" href="'.forum_link($forum_url['forum'], array($id, sef_friendly($cur_forum['forum_name']))).'" title="'.$lang_common['Page'].' 1" />';}/* * Fetch list of topics * EXT DEVELOPERS * If you modify SELECT of this query - than add same columns in next query (has posted) in GROUP BY*/$query = array(	'SELECT'	=> 't.id, t.poster, t.subject, t.posted, t.first_post_id, t.last_post, t.last_post_id, t.last_poster, t.num_views, t.num_replies, t.closed, t.sticky, t.moved_to',	'FROM'		=> 'topics AS t',	'WHERE'		=> 't.forum_id='.$id,	'ORDER BY'	=> 't.sticky DESC, '.(($cur_forum['sort_by'] == '1') ? 't.posted' : 't.last_post').' DESC',	'LIMIT'		=> $forum_page['start_from'].', '.$forum_user['disp_topics']);// With "has posted" indicationif (!$forum_user['is_guest'] && $forum_config['o_show_dot'] == '1'){	$query['SELECT'] .= ', COALESCE(p.id, 0) AS has_posted';	$query['JOINS'][]	= array(		'LEFT JOIN'		=> 'posts AS p',		'ON'			=> '(p.poster_id='.$forum_user['id'].' AND p.topic_id=t.id)'	);	// Must have same columns as in prev SELECT	$query['GROUP BY'] = 'p.id, t.id, t.poster, t.subject, t.posted, t.first_post_id, t.last_post, t.last_post_id, t.last_poster, t.num_views, t.num_replies, t.closed, t.sticky, t.moved_to';	($hook = get_hook('vf_qr_get_has_posted')) ? eval($hook) : null;}($hook = get_hook('vf_qr_get_topics')) ? eval($hook) : null;$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);$topics = array();while ($cur_topic = $forum_db->fetch_assoc($result)){	$topics[] = $cur_topic;}// Generate paging/posting links$forum_page['page_post']['paging'] = '<p class="paging"><span class="pages">'.$lang_common['Pages'].'</span> '.paginate($forum_page['num_pages'], $forum_page['page'], $forum_url['forum'], $lang_common['Paging separator'], array($id, sef_friendly($cur_forum['forum_name']))).'</p>';if ($forum_user['may_post'])	$forum_page['page_post']['posting'] = '<p class="posting"><a class="newpost" href="'.forum_link($forum_url['new_topic'], $id).'"><span>'.$lang_forum['Post topic'].'</span></a></p>';else if ($forum_user['is_guest'])	$forum_page['page_post']['posting'] = '<p class="posting">'.sprintf($lang_forum['Login to post'], '<a href="'.forum_link($forum_url['login']).'">'.$lang_common['login'].'</a>', '<a href="'.forum_link($forum_url['register']).'">'.$lang_common['register'].'</a>').'</p>';else	$forum_page['page_post']['posting'] = '<p class="posting">'.$lang_forum['No permission'].'</p>';// Setup main options$forum_page['main_head_options'] = array(	'feed'	=> '<span class="feed first-item"><a class="feed" href="'.forum_link($forum_url['forum_rss'], $id).'">'.$lang_forum['RSS forum feed'].'</a></span>');$forum_page['main_foot_options'] = array();if (!$forum_user['is_guest'] && !empty($topics)){	$forum_page['main_foot_options']['mark_read'] = '<span class="first-item"><a href="'.forum_link($forum_url['mark_forum_read'], array($id, generate_form_token('markforumread'.$id.$forum_user['id']))).'">'.$lang_forum['Mark forum read'].'</a></span>';	if ($forum_page['is_admmod'])		$forum_page['main_foot_options']['moderate'] = '<span'.(empty($forum_page['main_foot_options']) ? ' class="first-item"' : '').'><a href="'.forum_sublink($forum_url['moderate_forum'], $forum_url['page'], $forum_page['page'], $id).'">'.$lang_forum['Moderate forum'].'</a></span>';}// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($cur_forum['forum_name'], forum_link($forum_url['forum'], array($id, sef_friendly($cur_forum['forum_name'])))));// Setup main header$forum_page['main_title'] = '<a class="permalink" href="'.forum_link($forum_url['forum'], array($id, sef_friendly($cur_forum['forum_name']))).'" rel="bookmark" title="'.$lang_forum['Permalink forum'].'">'.forum_htmlencode($cur_forum['forum_name']).'</a>';if ($forum_page['num_pages'] > 1)	$forum_page['main_head_pages'] = sprintf($lang_common['Page info'], $forum_page['page'], $forum_page['num_pages']);($hook = get_hook('vf_pre_header_load')) ? eval($hook) : null;define('FORUM_ALLOW_INDEX', 1);define('FORUM_PAGE', 'viewforum');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();$forum_page['item_header'] = array();$forum_page['item_header']['subject']['title'] = '<strong class="subject-title">'.$lang_forum['Topics'].'</strong>';$forum_page['item_header']['info']['replies'] = '<strong class="info-replies">'.$lang_forum['replies'].'</strong>';if ($forum_config['o_topic_views'] == '1')	$forum_page['item_header']['info']['views'] = '<strong class="info-views">'.$lang_forum['views'].'</strong>';$forum_page['item_header']['info']['lastpost'] = '<strong class="info-lastpost">'.$lang_forum['last post'].'</strong>';($hook = get_hook('vf_main_output_start')) ? eval($hook) : null;// If there are topics in this forumif (!empty($topics)){?>	<div class="main-head"><?php	if (!empty($forum_page['main_head_options']))		echo "\n\t\t".'<p class="options">'.implode(' ', $forum_page['main_head_options']).'</p>';?>		<h2 class="hn"><span><?php echo $forum_page['items_info'] ?></span></h2>	</div>	<div class="main-subhead">		<p class="item-summary<?php echo ($forum_config['o_topic_views'] == '1') ? ' forum-views' : ' forum-noview' ?>"><span><?php printf($lang_forum['Forum subtitle'], implode(' ', $forum_page['item_header']['subject']), implode(', ', $forum_page['item_header']['info'])) ?></span></p>	</div>	<div id="forum<?php echo $id ?>" class="main-content main-forum<?php echo ($forum_config['o_topic_views'] == '1') ? ' forum-views' : ' forum-noview' ?>"><?php	($hook = get_hook('vf_pre_topic_loop_start')) ? eval($hook) : null;	$forum_page['item_count'] = 0;	foreach ($topics as $cur_topic)	{		($hook = get_hook('vf_topic_loop_start')) ? eval($hook) : null;		++$forum_page['item_count'];		// Start from scratch		$forum_page['item_subject'] = $forum_page['item_body'] = $forum_page['item_status'] = $forum_page['item_nav'] = $forum_page['item_title'] = $forum_page['item_title_status'] = array();		if ($forum_config['o_censoring'] == '1')			$cur_topic['subject'] = censor_words($cur_topic['subject']);		$forum_page['item_subject']['starter'] = '<span class="item-starter">'.sprintf($lang_forum['Topic starter'], forum_htmlencode($cur_topic['poster'])).'</span>';		if ($cur_topic['moved_to'] != null)		{			$forum_page['item_status']['moved'] = 'moved';			$forum_page['item_title']['link'] = '<span class="item-status"><em class="moved">'.sprintf($lang_forum['Item status'], $lang_forum['Moved']).'</em></span> <a href="'.forum_link($forum_url['topic'], array($cur_topic['moved_to'], sef_friendly($cur_topic['subject']))).'">'.forum_htmlencode($cur_topic['subject']).'</a>';			// Combine everything to produce the Topic heading			$forum_page['item_body']['subject']['title'] = '<h3 class="hn"><span class="item-num">'.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span>'.$forum_page['item_title']['link'].'</h3>';			($hook = get_hook('vf_topic_loop_moved_topic_pre_item_subject_merge')) ? eval($hook) : null;			$forum_page['item_body']['info']['replies'] = '<li class="info-replies"><span class="label">'.$lang_forum['No replies info'].'</span></li>';			if ($forum_config['o_topic_views'] == '1')				$forum_page['item_body']['info']['views'] = '<li class="info-views"><span class="label">'.$lang_forum['No views info'].'</span></li>';			$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><span class="label">'.$lang_forum['No lastpost info'].'</span></li>';		}		else		{			// Assemble the Topic heading			// Should we display the dot or not? :)			if (!$forum_user['is_guest'] && $forum_config['o_show_dot'] == '1' && $cur_topic['has_posted'] > 0)			{				$forum_page['item_title']['posted'] = '<span class="posted-mark">'.$lang_forum['You posted indicator'].'</span>';				$forum_page['item_status']['posted'] = 'posted';			}			if ($cur_topic['sticky'] == '1')			{				$forum_page['item_title_status']['sticky'] = '<em class="sticky">'.$lang_forum['Sticky'].'</em>';				$forum_page['item_status']['sticky'] = 'sticky';			}			if ($cur_topic['closed'] == '1')			{				$forum_page['item_title_status']['closed'] = '<em class="closed">'.$lang_forum['Closed'].'</em>';				$forum_page['item_status']['closed'] = 'closed';			}			($hook = get_hook('vf_topic_loop_normal_topic_pre_item_title_status_merge')) ? eval($hook) : null;			if (!empty($forum_page['item_title_status']))				$forum_page['item_title']['status'] = '<span class="item-status">'.sprintf($lang_forum['Item status'], implode(', ', $forum_page['item_title_status'])).'</span>';			$forum_page['item_title']['link'] = '<a href="'.forum_link($forum_url['topic'], array($cur_topic['id'], sef_friendly($cur_topic['subject']))).'">'.forum_htmlencode($cur_topic['subject']).'</a>';			($hook = get_hook('vf_topic_loop_normal_topic_pre_item_title_merge')) ? eval($hook) : null;			$forum_page['item_body']['subject']['title'] = '<h3 class="hn"><span class="item-num">'.forum_number_format($forum_page['start_from'] + $forum_page['item_count']).'</span> '.implode(' ', $forum_page['item_title']).'</h3>';			if (empty($forum_page['item_status']))				$forum_page['item_status']['normal'] = 'normal';			$forum_page['item_pages'] = ceil(($cur_topic['num_replies'] + 1) / $forum_user['disp_posts']);			if ($forum_page['item_pages'] > 1)				$forum_page['item_nav']['pages'] = '<span>'.$lang_forum['Pages'].'&#160;</span>'.paginate($forum_page['item_pages'], -1, $forum_url['topic'], $lang_common['Page separator'], array($cur_topic['id'], sef_friendly($cur_topic['subject'])));			// Does this topic contain posts we haven't read? If so, tag it accordingly.			if (!$forum_user['is_guest'] && $cur_topic['last_post'] > $forum_user['last_visit'] && (!isset($tracked_topics['topics'][$cur_topic['id']]) || $tracked_topics['topics'][$cur_topic['id']] < $cur_topic['last_post']) && (!isset($tracked_topics['forums'][$id]) || $tracked_topics['forums'][$id] < $cur_topic['last_post']))			{				$forum_page['item_nav']['new'] = '<em class="item-newposts"><a href="'.forum_link($forum_url['topic_new_posts'], array($cur_topic['id'], sef_friendly($cur_topic['subject']))).'">'.$lang_forum['New posts'].'</a></em>';				$forum_page['item_status']['new'] = 'new';			}			($hook = get_hook('vf_topic_loop_normal_topic_pre_item_nav_merge')) ? eval($hook) : null;			if (!empty($forum_page['item_nav']))				$forum_page['item_subject']['nav'] = '<span class="item-nav">'.sprintf($lang_forum['Topic navigation'], implode('&#160;&#160;', $forum_page['item_nav'])).'</span>';			// Assemble the Topic subject			$forum_page['item_body']['info']['replies'] = '<li class="info-replies"><strong>'.forum_number_format($cur_topic['num_replies']).'</strong> <span class="label">'.(($cur_topic['num_replies'] == 1) ? $lang_forum['reply'] : $lang_forum['replies']).'</span></li>';			if ($forum_config['o_topic_views'] == '1')				$forum_page['item_body']['info']['views'] = '<li class="info-views"><strong>'.forum_number_format($cur_topic['num_views']).'</strong> <span class="label">'.(($cur_topic['num_views'] == 1) ? $lang_forum['view'] : $lang_forum['views']).'</span></li>';			$forum_page['item_body']['info']['lastpost'] = '<li class="info-lastpost"><span class="label">'.$lang_forum['Last post'].'</span> <strong><a href="'.forum_link($forum_url['post'], $cur_topic['last_post_id']).'">'.format_time($cur_topic['last_post']).'</a></strong> <cite>'.sprintf($lang_forum['by poster'], forum_htmlencode($cur_topic['last_poster'])).'</cite></li>';		}		($hook = get_hook('vf_row_pre_item_subject_merge')) ? eval($hook) : null;		$forum_page['item_body']['subject']['desc'] = '<p>'.implode(' ', $forum_page['item_subject']).'</p>';		($hook = get_hook('vf_row_pre_item_status_merge')) ? eval($hook) : null;		$forum_page['item_style'] = (($forum_page['item_count'] % 2 != 0) ? ' odd' : ' even').(($forum_page['item_count'] == 1) ? ' main-first-item' : '').((!empty($forum_page['item_status'])) ? ' '.implode(' ', $forum_page['item_status']) : '');		($hook = get_hook('vf_row_pre_display')) ? eval($hook) : null;?>		<div id="topic<?php echo $cur_topic['id'] ?>" class="main-item<?php echo $forum_page['item_style'] ?>">			<span class="icon <?php echo implode(' ', $forum_page['item_status']) ?>"><!-- --></span>			<div class="item-subject">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['subject'])."\n" ?>			</div>			<ul class="item-info">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['info'])."\n" ?>			</ul>		</div><?php	}?>	</div>	<div class="main-foot"><?php	if (!empty($forum_page['main_foot_options']))		echo "\n\t\t\t".'<p class="options">'.implode(' ', $forum_page['main_foot_options']).'</p>';?>		<h2 class="hn"><span><?php echo $forum_page['items_info'] ?></span></h2>	</div><?php}// Else there are no topics in this forumelse{	$forum_page['item_body']['subject']['title'] = '<h3 class="hn">'.$lang_forum['No topics'].'</h3>';	$forum_page['item_body']['subject']['desc'] = '<p>'.$lang_forum['First topic nag'].'</p>';	($hook = get_hook('vf_no_results_row_pre_display')) ? eval($hook) : null;?>	<div class="main-head">		<h2 class="hn"><span><?php echo $lang_forum['Empty forum'] ?></span></h2>	</div>	<div id="forum<?php echo $id ?>" class="main-content main-forum">		<div class="main-item empty main-first-item">			<span class="icon empty"><!-- --></span>			<div class="item-subject">				<?php echo implode("\n\t\t\t\t", $forum_page['item_body']['subject'])."\n" ?>			</div>		</div>	</div>	<div class="main-foot">		<h2 class="hn"><span><?php echo $lang_forum['Empty forum'] ?></span></h2>	</div><?php}($hook = get_hook('vf_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->$forum_id = $id;require FORUM_ROOT.'footer.php';
<?php/*** This is the dynamic loader for the library. It checks whether you have* the mbstring extension available and includes relevant files* on that basis, falling back to the native (as in written in PHP) version* if mbstring is unavailabe.** It's probably easiest to use this, if you don't want to understand* the dependencies involved, in conjunction with PHP versions etc. At* the same time, you might get better performance by managing loading* yourself. The smartest way to do this, bearing in mind performance,* is probably to "load on demand" - i.e. just before you use these* functions in your code, load the version you need.** It makes sure the the following functions are available;* utf8_strlen, utf8_strpos, utf8_strrpos, utf8_substr,* utf8_strtolower, utf8_strtoupper* Other functions in the ./native directory depend on these* six functions being available* * @license http://www.gnu.org/copyleft/lesser.html LGPL* @see http://sourceforge.net/projects/phputf8* @package utf8*//*** Put the current directory in this constant*/if ( !defined('UTF8') ) {    define('UTF8',dirname(__FILE__));}/*** If string overloading is active, it will break many of the* native implementations. mbstring.func_overload must be set* to 0, 1 or 4 in php.ini (string overloading disabled).* Also need to check we have the correct internal mbstring* encoding*/if ( extension_loaded('mbstring')) {    if ( ini_get('mbstring.func_overload') & MB_OVERLOAD_STRING ) {        trigger_error('String functions are overloaded by mbstring',E_USER_ERROR);    }    mb_internal_encoding('UTF-8');}/*** Check whether PCRE has been compiled with UTF-8 support*/$UTF8_ar = array();if ( preg_match('/^.{1}$/u',"",$UTF8_ar) != 1 ) {    trigger_error('PCRE is not compiled with UTF-8 support',E_USER_ERROR);}unset($UTF8_ar);/*** Load the smartest implementations of utf8_strpos, utf8_strrpos* and utf8_substr*/if ( !defined('UTF8_CORE') ) {    if ( function_exists('mb_substr') ) {        require_once UTF8 . '/mbstring/core.php';    } else {        require_once UTF8 . '/utils/unicode.php';        require_once UTF8 . '/native/core.php';    }}/*** Load the native implementation of utf8_substr_replace*/require_once UTF8 . '/substr_replace.php';/*** You should now be able to use all the other utf_* string functions*/
<?php/** * Word censor management page. * * Allows administrators and moderators to add, modify, and delete the word censors used by the software when censoring is enabled. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */if (!defined('FORUM_ROOT'))	define('FORUM_ROOT', '../');require FORUM_ROOT.'include/common.php';require FORUM_ROOT.'include/common_admin.php';($hook = get_hook('acs_start')) ? eval($hook) : null;if (!$forum_user['is_admmod'])	message($lang_common['No permission']);// Load the admin.php language filerequire FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_censoring.php';// Add a censor wordif (isset($_POST['add_word'])){	$search_for = forum_trim($_POST['new_search_for']);	$replace_with = forum_trim($_POST['new_replace_with']);	if ($search_for == '' || $replace_with == '')		message($lang_admin_censoring['Must enter text message']);	($hook = get_hook('acs_add_word_form_submitted')) ? eval($hook) : null;	$query = array(		'INSERT'	=> 'search_for, replace_with',		'INTO'		=> 'censoring',		'VALUES'	=> '\''.$forum_db->escape($search_for).'\', \''.$forum_db->escape($replace_with).'\''	);	($hook = get_hook('acs_add_word_qr_add_censor')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the censor cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_censors_cache();	// Add flash message	$forum_flash->add_info($lang_admin_censoring['Censor word added']);	($hook = get_hook('acs_add_word_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_censoring']), $lang_admin_censoring['Censor word added']);}// Update a censor wordelse if (isset($_POST['update'])){	$id = intval(key($_POST['update']));	$search_for = forum_trim($_POST['search_for'][$id]);	$replace_with = forum_trim($_POST['replace_with'][$id]);	if ($search_for == '' || $replace_with == '')		message($lang_admin_censoring['Must enter text message']);	($hook = get_hook('acs_update_form_submitted')) ? eval($hook) : null;	$query = array(		'UPDATE'	=> 'censoring',		'SET'		=> 'search_for=\''.$forum_db->escape($search_for).'\', replace_with=\''.$forum_db->escape($replace_with).'\'',		'WHERE'		=> 'id='.$id	);	($hook = get_hook('acs_update_qr_update_censor')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the censor cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_censors_cache();	// Add flash message	$forum_flash->add_info($lang_admin_censoring['Censor word updated']);	($hook = get_hook('acs_update_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_censoring']), $lang_admin_censoring['Censor word updated']);}// Remove a censor wordelse if (isset($_POST['remove'])){	$id = intval(key($_POST['remove']));	($hook = get_hook('acs_remove_form_submitted')) ? eval($hook) : null;	$query = array(		'DELETE'	=> 'censoring',		'WHERE'		=> 'id='.$id	);	($hook = get_hook('acs_remove_qr_delete_censor')) ? eval($hook) : null;	$forum_db->query_build($query) or error(__FILE__, __LINE__);	// Regenerate the censor cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_censors_cache();	// Add flash message	$forum_flash->add_info($lang_admin_censoring['Censor word removed']);	($hook = get_hook('acs_remove_pre_redirect')) ? eval($hook) : null;	redirect(forum_link($forum_url['admin_censoring']), $lang_admin_censoring['Censor word removed']);}// Load the cached censorsif (file_exists(FORUM_CACHE_DIR.'cache_censors.php'))	include FORUM_CACHE_DIR.'cache_censors.php';if (!defined('FORUM_CENSORS_LOADED')){	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require FORUM_ROOT.'include/cache.php';	generate_censors_cache();	require FORUM_CACHE_DIR.'cache_censors.php';}// Setup the form$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['fld_count'] = 0;// Setup breadcrumbs$forum_page['crumbs'] = array(	array($forum_config['o_board_title'], forum_link($forum_url['index'])),	array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])));if ($forum_user['g_id'] == FORUM_ADMIN)	$forum_page['crumbs'][] = array($lang_admin_common['Settings'], forum_link($forum_url['admin_settings_setup']));$forum_page['crumbs'][] = array($lang_admin_common['Censoring'], forum_link($forum_url['admin_censoring']));($hook = get_hook('acs_pre_header_load')) ? eval($hook) : null;define('FORUM_PAGE_SECTION', 'settings');define('FORUM_PAGE', 'admin-censoring');require FORUM_ROOT.'header.php';// START SUBST - <!-- forum_main -->ob_start();($hook = get_hook('acs_main_output_start')) ? eval($hook) : null;?>	<div class="main-subhead">		<h2 class="hn"><span><?php echo $lang_admin_censoring['Censored word head'] ?></span></h2>	</div>	<div class="main-content main-frm">		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_censoring']) ?>?action=foo">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_censoring']).'?action=foo') ?>" />			</div>			<div class="ct-box" id="info-censored-intro">				<p><?php echo $lang_admin_censoring['Add censored word intro']; if ($forum_user['g_id'] == FORUM_ADMIN) printf(' '.$lang_admin_censoring['Add censored word extra'], '<strong><a href="'.forum_link($forum_url['admin_settings_features']).'">'.$lang_admin_common['Settings'].' - '.$lang_admin_common['Features'].'</a></strong>') ?></p>			</div>			<fieldset class="frm-group frm-hdgroup group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_censoring['Add censored word legend'] ?></span></legend><?php ($hook = get_hook('acs_pre_add_word_fieldset')) ? eval($hook) : null; ?>				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?><?php echo ($forum_page['item_count'] == 1) ? ' mf-head' : ' mf-extra' ?>">					<legend><span><?php echo $lang_admin_censoring['Add new word legend'] ?></span></legend>					<div class="mf-box"><?php ($hook = get_hook('acs_pre_add_search_for')) ? eval($hook) : null; ?>						<div class="mf-field mf-field1">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_censoring['Censored word label'] ?></span></label><br />							<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="new_search_for" size="24" maxlength="60" required /></span>						</div><?php ($hook = get_hook('acs_pre_add_replace_with')) ? eval($hook) : null; ?>						<div class="mf-field">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span class="fld-label"><?php echo $lang_admin_censoring['Replacement label'] ?></span></label><br />							<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="new_replace_with" size="24" maxlength="60" required /></span>						</div><?php ($hook = get_hook('acs_pre_add_submit')) ? eval($hook) : null; ?>						<div class="mf-field">							<span class="submit"><input type="submit" name="add_word" value=" <?php echo $lang_admin_censoring['Add word'] ?> " /></span>						</div>					</div><?php ($hook = get_hook('acs_pre_add_word_fieldset_end')) ? eval($hook) : null; ?>				</fieldset><?php ($hook = get_hook('acs_add_word_fieldset_end')) ? eval($hook) : null; ?>			</fieldset>		</form><?phpif (!empty($forum_censors)){	// Reset	$forum_page['group_count'] = $forum_page['item_count'] = 0;?>		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_link($forum_url['admin_censoring']) ?>?action=foo">			<div class="hidden">				<input type="hidden" name="csrf_token" value="<?php echo generate_form_token(forum_link($forum_url['admin_censoring']).'?action=foo') ?>" />			</div>			<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">				<legend class="group-legend"><span><?php echo $lang_admin_censoring['Edit censored word legend'] ?></span></legend><?php	foreach ($forum_censors as $censor_key => $cur_word)	{	?><?php ($hook = get_hook('acs_pre_edit_word_fieldset')) ? eval($hook) : null; ?>				<fieldset class="mf-set mf-extra set<?php echo ++$forum_page['item_count'] ?><?php echo ($forum_page['item_count'] == 1) ? ' mf-head' : ' mf-extra' ?>">					<legend><span><?php echo $lang_admin_censoring['Existing censored word legend'] ?></span></legend>					<div class="mf-box"><?php ($hook = get_hook('acs_pre_edit_search_for')) ? eval($hook) : null; ?>						<div class="mf-field mf-field1">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_censoring['Censored word label'] ?></span></label><br />							<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="search_for[<?php echo $cur_word['id'] ?>]" value="<?php echo forum_htmlencode($cur_word['search_for']) ?>" size="24" maxlength="60" required /></span>						</div><?php ($hook = get_hook('acs_pre_edit_replace_with')) ? eval($hook) : null; ?>						<div class="mf-field">							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_admin_censoring['Replacement label'] ?></span></label><br />							<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="replace_with[<?php echo $cur_word['id'] ?>]" value="<?php echo forum_htmlencode($cur_word['replace_with']) ?>" size="24" maxlength="60" required /></span>						</div><?php ($hook = get_hook('acs_pre_edit_submit')) ? eval($hook) : null; ?>						<div class="mf-field">							<span class="submit"><input type="submit" name="update[<?php echo $cur_word['id'] ?>]" value="<?php echo $lang_admin_common['Update'] ?>" /> <input type="submit" name="remove[<?php echo $cur_word['id'] ?>]" value="<?php echo $lang_admin_common['Remove'] ?>" formnovalidate /></span>						</div>					</div><?php ($hook = get_hook('acs_pre_edit_word_fieldset_end')) ? eval($hook) : null; ?>				</fieldset><?php ($hook = get_hook('acs_edit_word_fieldset_end')) ? eval($hook) : null; ?><?php	}?>			</fieldset>		</form>	</div><?php}else{?>		<div class="frm-form">			<div class="ct-box">				<p><?php echo $lang_admin_censoring['No censored words'] ?></p>			</div>		</div>	</div><?php}($hook = get_hook('acs_end')) ? eval($hook) : null;$tpl_temp = forum_trim(ob_get_contents());$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <!-- forum_main -->require FORUM_ROOT.'footer.php';
<?php/** * Loads various functions used in parsing XML (mostly for extensions). * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure no one attempts to run this script "directly"if (!defined('FORUM'))	exit;//// Parse XML data into an array//function xml_to_array($raw_xml){	$xml_parser = xml_parser_create();	xml_parser_set_option($xml_parser, XML_OPTION_CASE_FOLDING, 0);	xml_parser_set_option($xml_parser, XML_OPTION_SKIP_WHITE, 0);	xml_parse_into_struct($xml_parser, $raw_xml, $vals);	xml_parser_free($xml_parser);	$_tmp = '';	foreach ($vals as $xml_elem)	{		$x_tag = $xml_elem['tag'];		$x_level = $xml_elem['level'];		$x_type = $xml_elem['type'];		if ($x_level != 1 && $x_type == 'close')		{			if (isset($multi_key[$x_tag][$x_level]))				$multi_key[$x_tag][$x_level] = 1;			else				$multi_key[$x_tag][$x_level] = 0;		}		if ($x_level != 1 && $x_type == 'complete')		{			if ($_tmp == $x_tag)				$multi_key[$x_tag][$x_level] = 1;			$_tmp = $x_tag;		}	}	foreach ($vals as $xml_elem)	{		$x_tag = $xml_elem['tag'];		$x_level = $xml_elem['level'];		$x_type = $xml_elem['type'];		if ($x_type == 'open')			$level[$x_level] = $x_tag;		$start_level = 1;		$php_stmt = '$xml_array';		if ($x_type == 'close' && $x_level != 1)			$multi_key[$x_tag][$x_level]++;		while ($start_level < $x_level)		{			$php_stmt .= '[$level['.$start_level.']]';			if (isset($multi_key[$level[$start_level]][$start_level]) && $multi_key[$level[$start_level]][$start_level])				$php_stmt .= '['.($multi_key[$level[$start_level]][$start_level]-1).']';			++$start_level;		}		$add = '';		if (isset($multi_key[$x_tag][$x_level]) && $multi_key[$x_tag][$x_level] && ($x_type == 'open' || $x_type == 'complete'))		{			if (!isset($multi_key2[$x_tag][$x_level]))				$multi_key2[$x_tag][$x_level] = 0;			else				$multi_key2[$x_tag][$x_level]++;			$add = '['.$multi_key2[$x_tag][$x_level].']';		}		if (isset($xml_elem['value']) && forum_trim($xml_elem['value']) != '' && !array_key_exists('attributes', $xml_elem))		{			if ($x_type == 'open')				$php_stmt_main = $php_stmt.'[$x_type]'.$add.'[\'content\'] = $xml_elem[\'value\'];';			else				$php_stmt_main = $php_stmt.'[$x_tag]'.$add.' = $xml_elem[\'value\'];';			eval($php_stmt_main);		}		if (array_key_exists('attributes', $xml_elem))		{			if (isset($xml_elem['value']))			{				$php_stmt_main = $php_stmt.'[$x_tag]'.$add.'[\'content\'] = $xml_elem[\'value\'];';				eval($php_stmt_main);			}			foreach ($xml_elem['attributes'] as $key=>$value)			{				$php_stmt_att=$php_stmt.'[$x_tag]'.$add.'[\'attributes\'][$key] = $value;';				eval($php_stmt_att);			}		}	}	if (isset($xml_array))	{		// Make sure there's an array of notes (even if there is only one)		if (isset($xml_array['extension']['note']))		{			if (!is_array(current($xml_array['extension']['note'])))				$xml_array['extension']['note'] = array($xml_array['extension']['note']);		}		else			$xml_array['extension']['note'] = array();		// Make sure there's an array of hooks (even if there is only one)		if (isset($xml_array['extension']['hooks']) && isset($xml_array['extension']['hooks']['hook']))		{			if (!is_array(current($xml_array['extension']['hooks']['hook'])))				$xml_array['extension']['hooks']['hook'] = array($xml_array['extension']['hooks']['hook']);		}	}	return isset($xml_array) ? $xml_array : array();}//// Validate the syntax of an extension manifest file//function validate_manifest($xml_array, $folder_name){	global $lang_admin_ext, $forum_config;	$errors = array();	$return = ($hook = get_hook('xm_fn_validate_manifest_start')) ? eval($hook) : null;	if ($return != null)		return;	if (!isset($xml_array['extension']) || !is_array($xml_array['extension']))		$errors[] = $lang_admin_ext['extension root error'];	else	{		$ext = $xml_array['extension'];		if (!isset($ext['attributes']['engine']))			$errors[] = $lang_admin_ext['extension/engine error'];		else if ($ext['attributes']['engine'] != '1.0')			$errors[] = $lang_admin_ext['extension/engine error2'];		if (!isset($ext['id']) || $ext['id'] == '')			$errors[] = $lang_admin_ext['extension/id error'];		if ($ext['id'] != $folder_name)			$errors[] = $lang_admin_ext['extension/id error2'];		if (!isset($ext['title']) || $ext['title'] == '')			$errors[] = $lang_admin_ext['extension/title error'];		if (!isset($ext['version']) || $ext['version'] == '' || preg_match('/[^a-z0-9\- \.]+/i', $ext['version']))			$errors[] = $lang_admin_ext['extension/version error'];		if (!isset($ext['description']) || $ext['description'] == '')			$errors[] = $lang_admin_ext['extension/description error'];		if (!isset($ext['author']) || $ext['author'] == '')			$errors[] = $lang_admin_ext['extension/author error'];		if (!isset($ext['minversion']) || $ext['minversion'] == '')			$errors[] = $lang_admin_ext['extension/minversion error'];		if (isset($ext['minversion']) && version_compare(clean_version($forum_config['o_cur_version']), clean_version($ext['minversion']), '<'))			$errors[] = sprintf($lang_admin_ext['extension/minversion error2'], $ext['minversion']);		if (!isset($ext['maxtestedon']) || $ext['maxtestedon'] == '')			$errors[] = $lang_admin_ext['extension/maxtestedon error'];		if (isset($ext['note']))		{			foreach ($ext['note'] as $note)			{				if (!isset($note['content']) || $note['content'] == '')					$errors[] = $lang_admin_ext['extension/note error'];				if (!isset($note['attributes']['type']) || $note['attributes']['type'] == '')					$errors[] = $lang_admin_ext['extension/note error2'];			}		}		if (isset($ext['hooks']) && is_array($ext['hooks']))		{			if (!isset($ext['hooks']['hook']) || !is_array($ext['hooks']['hook']))				$errors[] = $lang_admin_ext['extension/hooks/hook error'];			else			{				foreach ($ext['hooks']['hook'] as $hook)				{					if (!isset($hook['content']) || $hook['content'] == '')						$errors[] = $lang_admin_ext['extension/hooks/hook error'];					if (!isset($hook['attributes']['id']) || $hook['attributes']['id'] == '')						$errors[] = $lang_admin_ext['extension/hooks/hook error2'];					if (isset($hook['attributes']['priority']) && (!ctype_digit($hook['attributes']['priority']) || $hook['attributes']['priority'] < 0 || $hook['attributes']['priority'] > 10))						$errors[] = $lang_admin_ext['extension/hooks/hook error3'];					$tokenized_hook = token_get_all('<?php '.$hook['content']);					$last_element = array_pop($tokenized_hook);					if (is_array($last_element) && $last_element[0] == T_INLINE_HTML)						$errors[] = $lang_admin_ext['extension/hooks/hook error4'];				}			}		}	}	($hook = get_hook('xm_fn_validate_manifest_end')) ? eval($hook) : null;	return $errors;}define('FORUM_XML_FUNCTIONS_LOADED', 1);
<?php/** * A database layer class that relies on the PostgreSQL PHP extension. * * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher * @package PunBB */// Make sure we have built in support for PostgreSQLif (!function_exists('pg_connect'))	exit('This PHP environment doesn\'t have PostgreSQL support built in. PostgreSQL support is required if you want to use a PostgreSQL database to run this forum. Consult the PHP documentation for further assistance.');class DBLayer{	var $prefix;	var $link_id;	var $query_result;	var $last_query_text = array();	var $in_transaction = 0;	var $saved_queries = array();	var $num_queries = 0;	var $error_no = false;	var $error_msg = 'Unknown';	var $datatype_transformations = array(		'/^(TINY|SMALL)INT( )?(\\([0-9]+\\))?( )?(UNSIGNED)?$/i'			=>	'SMALLINT',		'/^(MEDIUM)?INT( )?(\\([0-9]+\\))?( )?(UNSIGNED)?$/i'				=>	'INTEGER',		'/^BIGINT( )?(\\([0-9]+\\))?( )?(UNSIGNED)?$/i'						=>	'BIGINT',		'/^(TINY|MEDIUM|LONG)?TEXT$/i'										=>	'TEXT',		'/^DOUBLE( )?(\\([0-9,]+\\))?( )?(UNSIGNED)?$/i'					=>	'DOUBLE PRECISION',		'/^FLOAT( )?(\\([0-9]+\\))?( )?(UNSIGNED)?$/i'						=>	'REAL'	);	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)	{		$this->prefix = $db_prefix;		if ($db_host)		{			if (strpos($db_host, ':') !== false)			{				list($db_host, $dbport) = explode(':', $db_host);				$connect_str[] = 'host='.$db_host.' port='.$dbport;			}			else				$connect_str[] = 'host='.$db_host;		}		if ($db_name)			$connect_str[] = 'dbname='.$db_name;		if ($db_username)			$connect_str[] = 'user='.$db_username;		if ($db_password)			$connect_str[] = 'password='.$db_password;		if ($p_connect)			$this->link_id = @pg_pconnect(implode(' ', $connect_str));		else			$this->link_id = @pg_connect(implode(' ', $connect_str));		if (!$this->link_id)			error('Unable to connect to PostgreSQL server.', __FILE__, __LINE__);		// Setup the client-server character set (UTF-8)		if (!defined('FORUM_NO_SET_NAMES'))			$this->set_names('utf8');		return $this->link_id;	}	function start_transaction()	{		++$this->in_transaction;		return (@pg_query($this->link_id, 'BEGIN')) ? true : false;	}	function end_transaction()	{		--$this->in_transaction;		if (@pg_query($this->link_id, 'COMMIT'))			return true;		else		{			@pg_query($this->link_id, 'ROLLBACK');			return false;		}	}	function query($sql, $unbuffered = false)	// $unbuffered is ignored since there is no pgsql_unbuffered_query()	{		if (strlen($sql) > 140000)			exit('Insane query. Aborting.');		if (strrpos($sql, 'LIMIT') !== false)			$sql = preg_replace('#LIMIT ([0-9]+),([ 0-9]+)#', 'LIMIT \\2 OFFSET \\1', $sql);		if (defined('FORUM_SHOW_QUERIES'))			$q_start = forum_microtime();		@pg_send_query($this->link_id, $sql);		$this->query_result = @pg_get_result($this->link_id);		if (pg_result_status($this->query_result) != PGSQL_FATAL_ERROR)		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, sprintf('%.5f', forum_microtime() - $q_start));			++$this->num_queries;			$this->last_query_text[$this->query_result] = $sql;			return $this->query_result;		}		else		{			if (defined('FORUM_SHOW_QUERIES'))				$this->saved_queries[] = array($sql, 0);			$this->error_msg = @pg_result_error($this->query_result);			if ($this->in_transaction)				@pg_query($this->link_id, 'ROLLBACK');			--$this->in_transaction;			return false;		}	}	function query_build($query, $return_query_string = false, $unbuffered = false)	{		$sql = '';		if (isset($query['SELECT']))		{			$sql = 'SELECT '.$query['SELECT'].' FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['FROM'];			if (isset($query['JOINS']))			{				foreach ($query['JOINS'] as $cur_join)					$sql .= ' '.key($cur_join).' '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).current($cur_join).' ON '.$cur_join['ON'];			}			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];			if (!empty($query['GROUP BY']))				$sql .= ' GROUP BY '.$query['GROUP BY'];			if (!empty($query['HAVING']))				$sql .= ' HAVING '.$query['HAVING'];			if (!empty($query['ORDER BY']))				$sql .= ' ORDER BY '.$query['ORDER BY'];			if (!empty($query['LIMIT']))				$sql .= ' LIMIT '.$query['LIMIT'];		}		else if (isset($query['INSERT']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['INSERT']))				$sql .= ' ('.$query['INSERT'].')';			if (is_array($query['VALUES']))			{				$new_query = $query;				if ($return_query_string)				{					$query_set = array();					foreach ($query['VALUES'] as $cur_values)					{						$new_query['VALUES'] = $cur_values;						$query_set[] = $this->query_build($new_query, true, $unbuffered);					}					$sql = implode('; ', $query_set);				}				else				{					$result_set = null;					foreach ($query['VALUES'] as $cur_values)					{						$new_query['VALUES'] = $cur_values;						$result_set = $this->query_build($new_query, false, $unbuffered);					}					return $result_set;				}			}			else				$sql .= ' VALUES('.$query['VALUES'].')';		}		else if (isset($query['UPDATE']))		{			$query['UPDATE'] = (isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['UPDATE'];			$sql = 'UPDATE '.$query['UPDATE'].' SET '.$query['SET'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['DELETE']))		{			$sql = 'DELETE FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['DELETE'];			if (!empty($query['WHERE']))				$sql .= ' WHERE '.$query['WHERE'];		}		else if (isset($query['REPLACE']))		{			$sql = 'INSERT INTO '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'];			if (!empty($query['REPLACE']))				$sql .= ' ('.$query['REPLACE'].')';			$sql .= ' SELECT '.$query['VALUES'].' WHERE NOT EXISTS (SELECT 1 FROM '.(isset($query['PARAMS']['NO_PREFIX']) ? '' : $this->prefix).$query['INTO'].' WHERE '.$query['UNIQUE'].')';		}		return ($return_query_string) ? $sql : $this->query($sql, $unbuffered);	}	function result($query_id = 0, $row = 0, $col = 0)	{		return ($query_id) ? @pg_fetch_result($query_id, $row, $col) : false;	}	function fetch_assoc($query_id = 0)	{		return ($query_id) ? @pg_fetch_assoc($query_id) : false;	}	function fetch_row($query_id = 0)	{		return ($query_id) ? @pg_fetch_row($query_id) : false;	}	function num_rows($query_id = 0)	{		return ($query_id) ? @pg_num_rows($query_id) : false;	}	function affected_rows()	{		return ($this->query_result) ? @pg_affected_rows($this->query_result) : false;	}	function insert_id()	{		$query_id = $this->query_result;		if ($query_id && $this->last_query_text[$query_id] != '')		{			if (preg_match('/^INSERT INTO ([a-z0-9\_\-]+)/is', $this->last_query_text[$query_id], $table_name))			{				// Hack (don't ask)				if (substr($table_name[1], -6) == 'groups')					$table_name[1] .= '_g';				$temp_q_id = @pg_query($this->link_id, 'SELECT currval(\''.$table_name[1].'_id_seq\')');				return ($temp_q_id) ? intval(@pg_fetch_result($temp_q_id, 0)) : false;			}		}		return false;	}	function get_num_queries()	{		return $this->num_queries;	}	function get_saved_queries()	{		return $this->saved_queries;	}	function free_result($query_id = false)	{		if (!$query_id)			$query_id = $this->query_result;		return ($query_id) ? @pg_free_result($query_id) : false;	}	function escape($str)	{		return is_array($str) ? '' : pg_escape_string($str);	}	function error()	{		$result['error_sql'] = @current(@end($this->saved_queries));		$result['error_no'] = false;		$result['error_msg'] = $this->error_msg;		return $result;	}	function close()	{		if ($this->link_id)		{			if ($this->in_transaction)			{				if (defined('FORUM_SHOW_QUERIES'))					$this->saved_queries[] = array('COMMIT', 0);				@pg_query($this->link_id, 'COMMIT');			}			if ($this->query_result)				@pg_free_result($this->query_result);			return @pg_close($this->link_id);		}		else			return false;	}	function set_names($names)	{		return $this->query('SET NAMES \''.$this->escape($names).'\'');	}	function get_version()	{		$result = $this->query('SELECT VERSION()');		return array(			'name'		=> 'PostgreSQL',			'version'	=> preg_replace('/^[^0-9]+([^\s,-]+).*$/', '\\1', $this->result($result))		);	}	function table_exists($table_name, $no_prefix = false)	{		$result = $this->query('SELECT 1 FROM pg_class WHERE relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');		return $this->num_rows($result) > 0;	}	function field_exists($table_name, $field_name, $no_prefix = false)	{		$result = $this->query('SELECT 1 FROM pg_class c INNER JOIN pg_attribute a ON a.attrelid = c.oid WHERE c.relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND a.attname = \''.$this->escape($field_name).'\'');		return $this->num_rows($result) > 0;	}	function index_exists($table_name, $index_name, $no_prefix = false)	{		$result = $this->query('SELECT 1 FROM pg_index i INNER JOIN pg_class c1 ON c1.oid = i.indrelid INNER JOIN pg_class c2 ON c2.oid = i.indexrelid WHERE c1.relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND c2.relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_'.$this->escape($index_name).'\'');		return $this->num_rows($result) > 0;	}	function create_table($table_name, $schema, $no_prefix = false)	{		if ($this->table_exists($table_name, $no_prefix))			return;		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";		// Go through every schema element and add it to the query		foreach ($schema['FIELDS'] as $field_name => $field_data)		{			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);			$query .= $field_name.' '.$field_data['datatype'];			// The SERIAL datatype is a special case where we don't need to say not null			if (!$field_data['allow_null'] && $field_data['datatype'] != 'SERIAL')				$query .= ' NOT NULL';			if (isset($field_data['default']))				$query .= ' DEFAULT '.$field_data['default'];			$query .= ",\n";		}		// If we have a primary key, add it		if (isset($schema['PRIMARY KEY']))			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";		// Add unique keys		if (isset($schema['UNIQUE KEYS']))		{			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)				$query .= 'UNIQUE ('.implode(',', $key_fields).'),'."\n";		}		// We remove the last two characters (a newline and a comma) and add on the ending		$query = substr($query, 0, strlen($query) - 2)."\n".')';		$this->query($query) or error(__FILE__, __LINE__);		// Add indexes		if (isset($schema['INDEXES']))		{			foreach ($schema['INDEXES'] as $index_name => $index_fields)				$this->add_index($table_name, $index_name, $index_fields, false, $no_prefix);		}	}	function drop_table($table_name, $no_prefix = false)	{		if (!$this->table_exists($table_name, $no_prefix))			return;		$this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) or error(__FILE__, __LINE__);	}	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if ($this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type) or error(__FILE__, __LINE__);		if ($default_value !== null)		{			if (!is_int($default_value) && !is_float($default_value))				$default_value = '\''.$this->escape($default_value).'\'';			$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ALTER '.$field_name.' SET DEFAULT '.$default_value) or error(__FILE__, __LINE__);			$this->query('UPDATE '.($no_prefix ? '' : $this->prefix).$table_name.' SET '.$field_name.'='.$default_value) or error(__FILE__, __LINE__);		}		if (!$allow_null)			$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ALTER '.$field_name.' SET NOT NULL') or error(__FILE__, __LINE__);	}	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);		$this->add_field($table_name, 'tmp_'.$field_name, $field_type, $allow_null, $default_value, $after_field, $no_prefix);		$this->query('UPDATE '.($no_prefix ? '' : $this->prefix).$table_name.' SET tmp_'.$field_name.' = '.$field_name) or error(__FILE__, __LINE__);		$this->drop_field($table_name, $field_name, $no_prefix);		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' RENAME COLUMN tmp_'.$field_name.' TO '.$field_name) or error(__FILE__, __LINE__);		// Set the default value		if ($default_value === null)			$default_value = 'NULL';		else if (!is_int($default_value) && !is_float($default_value))			$default_value = '\''.$this->escape($default_value).'\'';		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ALTER '.$field_name.' SET DEFAULT '.$default_value) or error(__FILE__, __LINE__);		if (!$allow_null)			$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ALTER '.$field_name.' SET NOT NULL') or error(__FILE__, __LINE__);	}	function drop_field($table_name, $field_name, $no_prefix = false)	{		if (!$this->field_exists($table_name, $field_name, $no_prefix))			return;		$this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) or error(__FILE__, __LINE__);	}	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)	{		if ($this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('CREATE '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ON '.($no_prefix ? '' : $this->prefix).$table_name.'('.implode(',', $index_fields).')') or error(__FILE__, __LINE__);	}	function drop_index($table_name, $index_name, $no_prefix = false)	{		if (!$this->index_exists($table_name, $index_name, $no_prefix))			return;		$this->query('DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) or error(__FILE__, __LINE__);	}}
<?php// Language definitions used in admin-categories$lang_admin_categories = array('Add category head'				=>	'Add category (create a new category at the specified position)','Add category info'				=>	'Your new category will not appear on the board index page until at least one forum is added to it. To create a new forum in this category or to move an existing forum to it go to the %s page.','Add category info link text'	=>	'forums','Add category legend'			=>	'Add new category','Add category'					=>	'Add category','New category label'			=>	'New category name','Category name label'			=>	'Category name','Position label'				=>	'Position','Del category head'				=>	'Delete category (together with all forums and posts it contains)','Delete category'				=>	'Delete category',// submit button'Select category label'			=>	'Select category','Confirm delete cat'			=>	'You are deleting the category "%s"','Delete category warning'		=>	'<strong>WARNING!</strong> Deleting a category will delete all forums and posts (if any) in that category!','Edit categories head'			=>	'Edit categories (change category names and/or positions)','Edit categories legend'		=>	'Edit categories','Edit category legend'			=>	'Edit category%s','Update all categories'			=>	'Update all categories','Categories updated'			=>	'Categories updated.','Category added'				=>	'Category added.','Category deleted'				=>	'Category deleted.','Must name category'			=>	'You must enter a name for the category','Must be integer'				=>	'Position must be a positive integer value',);
