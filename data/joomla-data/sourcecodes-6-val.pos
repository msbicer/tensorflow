<?php/** * @package     Joomla.Administrator * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');JHtml::_('bootstrap.tooltip');JHtml::_('behavior.multiselect');JHtml::_('formbehavior.chosen', 'select');$app		= JFactory::getApplication();$user		= JFactory::getUser();$userId		= $user->get('id');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));$ordering 	= ($listOrder == 'a.lft');$canOrder	= $user->authorise('core.edit.state',	'com_tags');$saveOrder 	= ($listOrder == 'a.lft' && $listDirn == 'asc');if ($saveOrder){	$saveOrderingUrl = 'index.php?option=com_tags&task=tags.saveOrderAjax';	JHtml::_('sortablelist.sortable', 'categoryList', 'adminForm', strtolower($listDirn), $saveOrderingUrl, false, true);}$sortFields = $this->getSortFields();?><script type="text/javascript">	Joomla.orderTable = function() {		table = document.getElementById("sortTable");		direction = document.getElementById("directionTable");		order = table.options[table.selectedIndex].value;		if (order != '<?php echo $listOrder; ?>')		{			dirn = 'asc';		} else {			dirn = direction.options[direction.selectedIndex].value;		}		Joomla.tableOrdering(order, dirn, '');	}</script><form action="<?php echo JRoute::_('index.php?option=com_tags&view=tags');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)): ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<label for="filter_search" class="element-invisible"><?php echo JText::_('COM_TAGS_ITEMS_SEARCH_FILTER');?></label>				<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_TAGS_ITEMS_SEARCH_FILTER'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_TAGS_ITEMS_SEARCH_FILTER'); ?>" />			</div>			<div class="btn-group hidden-phone">				<button class="btn tip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button class="btn tip" type="button" onclick="document.id('filter_search').value='';this.form.submit();" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>"><i class="icon-remove"></i></button>			</div>			<div class="btn-group pull-right hidden-phone">				<label for="limit" class="element-invisible"><?php echo JText::_('JFIELD_PLG_SEARCH_SEARCHLIMIT_DESC');?></label>				<?php echo $this->pagination->getLimitBox(); ?>			</div>			<div class="btn-group pull-right hidden-phone">				<label for="directionTable" class="element-invisible"><?php echo JText::_('JFIELD_ORDERING_DESC');?></label>				<select name="directionTable" id="directionTable" class="input-medium" onchange="Joomla.orderTable()">					<option value=""><?php echo JText::_('JFIELD_ORDERING_DESC');?></option>					<option value="asc" <?php if ($listDirn == 'asc') echo 'selected="selected"'; ?>><?php echo JText::_('JGLOBAL_ORDER_ASCENDING');?></option>					<option value="desc" <?php if ($listDirn == 'desc') echo 'selected="selected"'; ?>><?php echo JText::_('JGLOBAL_ORDER_DESCENDING');?></option>				</select>			</div>			<div class="btn-group pull-right">				<label for="sortTable" class="element-invisible"><?php echo JText::_('JGLOBAL_SORT_BY');?></label>				<select name="sortTable" id="sortTable" class="input-medium" onchange="Joomla.orderTable()">					<option value=""><?php echo JText::_('JGLOBAL_SORT_BY');?></option>					<?php echo JHtml::_('select.options', $sortFields, 'value', 'text', $listOrder);?>				</select>			</div>			<div class="clearfix"></div>		</div>		<table class="table table-striped" id="categoryList">			<thead>				<tr>					<th width="1%" class="hidden-phone">						<?php echo JHtml::_('grid.sort', '<i class="icon-menu-2"></i>', 'a.ordering', $listDirn, $listOrder, null, 'asc', 'JGRID_HEADING_ORDERING'); ?>					</th>					<th width="1%" class="hidden-phone">						<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />					</th>					<th width="1%" class="nowrap center">						<?php echo JHtml::_('grid.sort', 'JSTATUS', 'a.published', $listDirn, $listOrder); ?>					</th>					<th>						<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>					</th>				<th width="10%" class="nowrap hidden-phone">					<?php echo JHtml::_('grid.sort',  'JGRID_HEADING_ACCESS', 'a.access', $listDirn, $listOrder); ?>				</th>				<th width="5%" class="nowrap hidden-phone">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_LANGUAGE', 'language', $this->state->get('list.direction'), $this->state->get('list.ordering')); ?>				</th>					<th width="1%" class="nowrap hidden-phone">						<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>					</th>				</tr>			</thead>			<tfoot>				<tr>					<td colspan="15">						<?php echo $this->pagination->getListFooter(); ?>					</td>				</tr>			</tfoot>			<tbody>			<?php			$originalOrders = array();			foreach ($this->items as $i => $item) :				$orderkey   = array_search($item->id, $this->ordering[$item->parent_id]);				$canCreate  = $user->authorise('core.create',     'com_tags');				$canEdit    = $user->authorise('core.edit',       'com_tags');				$canCheckin = $user->authorise('core.manage',     'com_checkin') || $item->checked_out == $user->get('id')|| $item->checked_out == 0;				$canChange  = $user->authorise('core.edit.state', 'com_tags') && $canCheckin;				// Get the parents of item for sorting				if ($item->level > 1)				{					$parentsStr = "";					$_currentParentId = $item->parent_id;					$parentsStr = " ".$_currentParentId;					for ($j = 0; $j < $item->level; $j++)					{						foreach ($this->ordering as $k => $v)						{							$v = implode("-", $v);							$v = "-" . $v . "-";							if (strpos($v, "-" . $_currentParentId . "-") !== false)							{								$parentsStr .= " " . $k;								$_currentParentId = $k;								break;							}						}					}				}				else				{					$parentsStr = "";				}				?>					<tr class="row<?php echo $i % 2; ?>" sortable-group-id="<?php echo $item->parent_id;?>" item-id="<?php echo $item->id?>" parents="<?php echo $parentsStr?>" level="<?php echo $item->level?>">						<td class="order nowrap center hidden-phone">						<?php if ($canChange) :							$disableClassName = '';							$disabledLabel    = '';							if (!$saveOrder) :								$disabledLabel    = JText::_('JORDERINGDISABLED');								$disableClassName = 'inactive tip-top';							endif; ?>							<span class="sortable-handler hasTooltip <?php echo $disableClassName?>" title="<?php echo $disabledLabel?>">								<i class="icon-menu"></i>							</span>						<?php else : ?>							<span class="sortable-handler inactive">								<i class="icon-menu"></i>							</span>						<?php endif; ?>							<input type="text" style="display:none" name="order[]" size="5" value="<?php echo $orderkey + 1;?>" />						</td>						<td class="center hidden-phone">							<?php echo JHtml::_('grid.id', $i, $item->id); ?>						</td>						<td class="center">							<?php echo JHtml::_('jgrid.published', $item->published, $i, 'tags.', $canChange);?>						</td>						<td>							<?php if ($item->level > 0): ?>							<?php echo str_repeat('<span class="gi">&mdash;</span>', $item->level - 1) ?>							<?php endif; ?>							<?php if ($item->checked_out) : ?>								<?php echo JHtml::_('jgrid.checkedout', $i, $item->editor, $item->checked_out_time, 'tags.', $canCheckin); ?>							<?php endif; ?>							<?php if ($canEdit || $canEditOwn) : ?>								<a href="<?php echo JRoute::_('index.php?option=com_tags&task=tag.edit&id='.$item->id);?>">									<?php echo $this->escape($item->title); ?></a>							<?php else : ?>								<?php echo $this->escape($item->title); ?>							<?php endif; ?>							<span class="small" title="<?php echo $this->escape($item->path); ?>">								<?php if (empty($item->note)) : ?>									<?php echo JText::sprintf('JGLOBAL_LIST_ALIAS', $this->escape($item->alias));?>								<?php else : ?>									<?php echo JText::sprintf('JGLOBAL_LIST_ALIAS_NOTE', $this->escape($item->alias), $this->escape($item->note));?>								<?php endif; ?>							</span>						</td>					<td class="small hidden-phone">						<?php echo $this->escape($item->access_title); ?>					</td>					<td class="small nowrap hidden-phone">					<?php if ($item->language == '*') : ?>						<?php echo JText::alt('JALL', 'language'); ?>						<?php else:?>							<?php echo $item->language_title ? $this->escape($item->language_title) : JText::_('JUNDEFINED'); ?>						<?php endif;?>						</td>						<td class="center hidden-phone">							<span title="<?php echo sprintf('%d-%d', $item->lft, $item->rgt); ?>">								<?php echo (int) $item->id; ?></span>						</td>					</tr>			<?php endforeach; ?>			</tbody>		</table>		<?php //Load the batch processing form. ?>		<?php echo $this->loadTemplate('batch'); ?>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<input type="hidden" name="original_order_values" value="<?php echo implode($originalOrders, ','); ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Openstreetmap * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Joomla Platform class for interact with Openstreetmap API. * * @package     Joomla.Platform * @subpackage  Openstreetmap * * @since       13.1 */class JOpenstreetmap{	/**	 * @var    JRegistry  Options for the Openstreetmap object.	 * @since  13.1	 */	protected $options;	/**	 * @var    JHttp      The HTTP client object to use in sending HTTP requests.	 * @since  13.1	 */	protected $client;	/**	 * @var   JOpenstreetmapOauth  The OAuth client.	 * @since 13.1	 */	protected $oauth;	/**	 * @var    JOpenstreetmapChangesets  Openstreetmap API object for changesets.	 * @since  13.1	 */	protected $changesets;	/**	 * @var    JOpenstreetmapElements  Openstreetmap API object for elements.	 * @since  13.1	 */	protected $elements;	/**	 * @var   JOpenstreetmapGps  Openstreetmap API object for gps.	 * @since  13.1	 */	protected $gps;	/**	 * @var    JOpenstreetmapInfo  Openstreetmap API object for info.	 * @since  13.1	 */	protected $info;	/**	 * @var    JOpenstreetmapUser  Openstreetmap API object for user.	 * @since  13.1	 */	protected $user;	/**	 * Constructor.	 *	 * @param   JOpenstreetmapOauth  $oauth    Openstreetmap oauth client.	 * @param   JRegistry            $options  Openstreetmap options object.	 * @param   JOpenstreetmapHttp   $client   The HTTP client object.	 *	 * @since   13.1	 */	public function __construct(JOpenstreetmapOauth $oauth = null, JRegistry $options = null, JHttp $client = null)	{		$this->oauth = $oauth;		$this->options = isset($options) ? $options : new JRegistry;		$this->client  = isset($client) ? $client : new JHttp($this->options);		// Setup the default API url if not already set.		$this->options->def('api.url', 'http://api.openstreetmap.org/api/0.6/');		// $this->options->def('api.url', 'http://api06.dev.openstreetmap.org/api/0.6/');	}	/**		 * Method to get object instances	 * 	 * @param   string  $name  Name of property to retrieve	 *	 * @return  JOpenstreetmapObject  Openstreetmap API object .	 *	 * @since   13.1	 */	public function __get($name)	{		switch ($name)		{			case 'changesets':				if ($this->changesets == null)				{					$this->changesets = new JOpenstreetmapChangesets($this->options, $this->client, $this->oauth);				}				return $this->changesets;			case 'elements':				if ($this->elements == null)				{					$this->elements = new JOpenstreetmapElements($this->options, $this->client, $this->oauth);				}				return $this->elements;			case 'gps':				if ($this->gps == null)				{					$this->gps = new JOpenstreetmapGps($this->options, $this->client, $this->oauth);				}				return $this->gps;			case 'info':				if ($this->info == null)				{					$this->info = new JOpenstreetmapInfo($this->options, $this->client, $this->oauth);				}				return $this->info;			case 'user':				if ($this->user == null)				{					$this->user = new JOpenstreetmapUser($this->options, $this->client, $this->oauth);				}				return $this->user;		}	}	/**	 * Get an option from the JOpenstreetmap instance.	 *	 * @param   string  $key  The name of the option to get.	 *	 * @return  mixed  The option value.	 *	 * @since   13.1	 */	public function getOption($key)	{		return $this->options->get($key);	}	/**	 * Set an option for the Openstreetmap instance.	 *	 * @param   string  $key    The name of the option to set.	 * @param   mixed   $value  The option value to set.	 *	 * @return  JOpenstreetmap  This object for method chaining.	 *	 * @since   13.1	 */	public function setOption($key, $value)	{		$this->options->set($key, $value);		return $this;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><fieldset class="form-vertical">	<legend><?php echo JText::_('COM_CONFIG_TEXT_FILTER_SETTINGS'); ?></legend>	<p><?php echo JText::_('COM_CONFIG_TEXT_FILTERS_DESC'); ?></p>	<?php foreach ($this->form->getFieldset('filters') as $field) : ?>		<div class="control-group">			<div class="control-label"><?php echo $field->label; ?></div>			<div class="controls"><?php echo $field->input; ?></div>		</div>	<?php endforeach; ?></fieldset>
<?php/** * @package    Joomla.Installation * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE.txt */if (version_compare(PHP_VERSION, '5.3.1', '<')){	die('Your host needs to use PHP 5.3.1 or higher to run this version of Joomla!');}/** * Constant that is checked in included files to prevent direct access. * define() is used in the installation folder rather than "const" to not error for PHP 5.2 and lower */define('_JEXEC', 1);// Bootstrap the applicationrequire_once dirname(__FILE__) . '/application/bootstrap.php';// Get the application$app = JApplicationWeb::getInstance('InstallationApplicationWeb');// Execute the application$app->execute();
<?php/** * @package     Joomla.Administrator * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the Tags component * * @package     Joomla.Administrator * @subpackage  com_tags * @since       3.1 */class TagsViewTag extends JViewLegacy{	protected $form;	protected $item;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$this->form  = $this->get('Form');		$this->item  = $this->get('Item');		$this->state = $this->get('State');		$this->canDo = TagsHelper::getActions($this->state->get('tags.component'));		$input = JFactory::getApplication()->input;		// Check for errors.		if (count($errors = $this->get('Errors'))) {			JError::raiseError(500, implode("\n", $errors));			return false;		}		$input->set('hidemainmenu', true);		$this->addToolbar();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since  3.1	 */	protected function addToolbar()	{		$input      = JFactory::getApplication()->input;		$user		= JFactory::getUser();		$userId		= $user->get('id');		$isNew		= ($this->item->id == 0);		$checkedOut	= !($this->item->checked_out == 0 || $this->item->checked_out == $userId);		// Need to load the menu language file as mod_menu hasn't been loaded yet.		$lang = JFactory::getLanguage();			$lang->load('com_tags', JPATH_BASE, null, false, false)		||	$lang->load('com_tags', JPATH_ADMINISTRATOR.'/components/com_tags', null, false, false)		||	$lang->load('com_tags', JPATH_BASE, $lang->getDefault(), false, false)		||	$lang->load('com_tags', JPATH_ADMINISTRATOR.'/components/com_tags', $lang->getDefault(), false, false);		// Load the tags helper.		require_once JPATH_COMPONENT.'/helpers/tags.php';		// Get the results for each action.		$canDo = TagsHelper::getActions('com_tags', $this->item->id);		$title = JText::_('COM_TAGS_BASE_'.($isNew?'ADD':'EDIT').'_TITLE');		// Prepare the toolbar.		JToolbarHelper::title($title, 'tag-'.($isNew?'add':'edit').($isNew?'add':'edit'));		// For new records, check the create permission.		if ($isNew)		{			JToolbarHelper::apply('tag.apply');			JToolbarHelper::save('tag.save');			JToolbarHelper::save2new('tag.save2new');		}		// If not checked out, can save the item.		elseif (!$checkedOut && ($canDo->get('core.edit') || ($canDo->get('core.edit.own') && $this->item->created_user_id == $userId))) {			JToolbarHelper::apply('tag.apply');			JToolbarHelper::save('tag.save');			if ($canDo->get('core.create')) {				JToolbarHelper::save2new('tag.save2new');			}		}		// If an existing item, can save to a copy.		if (!$isNew && $canDo->get('core.create')) {			JToolbarHelper::save2copy('tag.save2copy');		}		if (empty($this->item->id))  {			JToolbarHelper::cancel('tag.cancel');		}		else {			JToolbarHelper::cancel('tag.cancel', 'JTOOLBAR_CLOSE');		}		JToolbarHelper::help('JHELP_COMPONENTS_TAGS_MANAGER_EDIT');		JToolbarHelper::divider();	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * View class for a list of users. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersViewUsers extends JViewLegacy{	protected $items;	protected $pagination;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$this->items		= $this->get('Items');		$this->pagination	= $this->get('Pagination');		$this->state		= $this->get('State');		UsersHelper::addSubmenu('users');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		// Include the component HTML helpers.		JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');		$this->addToolbar();		$this->sidebar = JHtmlSidebar::render();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		$canDo	= UsersHelper::getActions();		// Get the toolbar object instance		$bar = JToolBar::getInstance('toolbar');		JToolbarHelper::title(JText::_('COM_USERS_VIEW_USERS_TITLE'), 'user');		if ($canDo->get('core.create'))		{			JToolbarHelper::addNew('user.add');		}		if ($canDo->get('core.edit'))		{			JToolbarHelper::editList('user.edit');		}		if ($canDo->get('core.edit.state'))		{			JToolbarHelper::divider();			JToolbarHelper::publish('users.activate', 'COM_USERS_TOOLBAR_ACTIVATE', true);			JToolbarHelper::unpublish('users.block', 'COM_USERS_TOOLBAR_BLOCK', true);			JToolbarHelper::custom('users.unblock', 'unblock.png', 'unblock_f2.png', 'COM_USERS_TOOLBAR_UNBLOCK', true);			JToolbarHelper::divider();		}		if ($canDo->get('core.delete'))		{			JToolbarHelper::deleteList('', 'users.delete');			JToolbarHelper::divider();		}		// Add a batch button		if ($canDo->get('core.edit'))		{			JHtml::_('bootstrap.modal', 'collapseModal');			$title = JText::_('JTOOLBAR_BATCH');			$dhtml = "<button data-toggle=\"modal\" data-target=\"#collapseModal\" class=\"btn btn-small\">			<i class=\"icon-checkbox-partial\" title=\"$title\"></i>			$title</button>";			$bar->appendButton('Custom', $dhtml, 'batch');		}		if ($canDo->get('core.admin'))		{			JToolbarHelper::preferences('com_users');			JToolbarHelper::divider();		}		JToolbarHelper::help('JHELP_USERS_USER_MANAGER');		JHtmlSidebar::setAction('index.php?option=com_users&view=users');		JHtmlSidebar::addFilter(			JText::_('COM_USERS_FILTER_STATE'),			'filter_state',			JHtml::_('select.options', UsersHelper::getStateOptions(), 'value', 'text', $this->state->get('filter.state'))		);		JHtmlSidebar::addFilter(			JText::_('COM_USERS_FILTER_ACTIVE'),			'filter_active',			JHtml::_('select.options', UsersHelper::getActiveOptions(), 'value', 'text', $this->state->get('filter.active'))		);		JHtmlSidebar::addFilter(			JText::_('COM_USERS_FILTER_USERGROUP'),			'filter_group_id',			JHtml::_('select.options', UsersHelper::getGroups(), 'value', 'text', $this->state->get('filter.group_id'))		);		JHtmlSidebar::addFilter(			JText::_('COM_USERS_OPTION_FILTER_DATE'),			'filter_range',			JHtml::_('select.options', Usershelper::getRangeOptions(), 'value', 'text', $this->state->get('filter.range'))		);	}}
<?php/** * @package     Joomla.Platform * @subpackage  Cache * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Joomla! Cache base object * * @package     Joomla.Platform * @subpackage  Cache * @since       11.1 */class JCache{	/**	 * @var    object  Storage handler	 * @since  11.1	 */	public static $_handler = array();	/**	 * @var    array  Options	 * @since  11.1	 */	public $_options;	/**	 * Constructor	 *	 * @param   array  $options  options	 *	 * @since   11.1	 */	public function __construct($options)	{		$conf = JFactory::getConfig();		$this->_options = array(			'cachebase' => $conf->get('cache_path', JPATH_CACHE),			'lifetime' => (int) $conf->get('cachetime'),			'language' => $conf->get('language', 'en-GB'),			'storage' => $conf->get('cache_handler', ''),			'defaultgroup' => 'default',			'locking' => true,			'locktime' => 15,			'checkTime' => true,			'caching' => ($conf->get('caching') >= 1) ? true : false);		// Overwrite default options with given options		foreach ($options as $option => $value)		{			if (isset($options[$option]) && $options[$option] !== '')			{				$this->_options[$option] = $options[$option];			}		}		if (empty($this->_options['storage']))		{			$this->_options['caching'] = false;		}	}	/**	 * Returns a reference to a cache adapter object, always creating it	 *	 * @param   string  $type     The cache object type to instantiate	 * @param   array   $options  The array of options	 *	 * @return  JCache  A JCache object	 *	 * @since   11.1	 */	public static function getInstance($type = 'output', $options = array())	{		return JCacheController::getInstance($type, $options);	}	/**	 * Get the storage handlers	 *	 * @return  array    An array of available storage handlers	 *	 * @since   11.1	 */	public static function getStores()	{		$handlers = array();		// Get an iterator and loop trough the driver classes.		$iterator = new DirectoryIterator(__DIR__ . '/storage');		foreach ($iterator as $file)		{			$fileName = $file->getFilename();			// Only load for php files.			// Note: DirectoryIterator::getExtension only available PHP >= 5.3.6			if (!$file->isFile()				|| substr($fileName, strrpos($fileName, '.') + 1) != 'php'				|| $fileName == 'helper.php')			{				continue;			}			// Derive the class name from the type.			$class = str_ireplace('.php', '', 'JCacheStorage' . ucfirst(trim($fileName)));			// If the class doesn't exist we have nothing left to do but look at the next type. We did our best.			if (!class_exists($class))			{				continue;			}			// Sweet!  Our class exists, so now we just need to know if it passes its test method.			if ($class::isSupported())			{				// Connector names should not have file extensions.				$handlers[] = str_ireplace('.php', '', $fileName);			}		}		return $handlers;	}	/**	 * Set caching enabled state	 *	 * @param   boolean  $enabled  True to enable caching	 *	 * @return  void	 *	 * @since   11.1	 */	public function setCaching($enabled)	{		$this->_options['caching'] = $enabled;	}	/**	 * Get caching state	 *	 * @return  boolean  Caching state	 *	 * @since   11.1	 */	public function getCaching()	{		return $this->_options['caching'];	}	/**	 * Set cache lifetime	 *	 * @param   integer  $lt  Cache lifetime	 *	 * @return  void	 *	 * @since   11.1	 */	public function setLifeTime($lt)	{		$this->_options['lifetime'] = $lt;	}	/**	 * Get cached data by id and group	 *	 * @param   string  $id     The cache data id	 * @param   string  $group  The cache data group	 *	 * @return  mixed  boolean  False on failure or a cached data string	 *	 * @since   11.1	 */	public function get($id, $group = null)	{		// Get the default group		$group = ($group) ? $group : $this->_options['defaultgroup'];		// Get the storage		$handler = $this->_getStorage();		if (!($handler instanceof Exception) && $this->_options['caching'])		{			return $handler->get($id, $group, $this->_options['checkTime']);		}		return false;	}	/**	 * Get a list of all cached data	 *	 * @return  mixed    Boolean false on failure or an object with a list of cache groups and data	 *	 * @since   11.1	 */	public function getAll()	{		// Get the storage		$handler = $this->_getStorage();		if (!($handler instanceof Exception) && $this->_options['caching'])		{			return $handler->getAll();		}		return false;	}	/**	 * Store the cached data by id and group	 *	 * @param   mixed   $data   The data to store	 * @param   string  $id     The cache data id	 * @param   string  $group  The cache data group	 *	 * @return  boolean  True if cache stored	 *	 * @since   11.1	 */	public function store($data, $id, $group = null)	{		// Get the default group		$group = ($group) ? $group : $this->_options['defaultgroup'];		// Get the storage and store the cached data		$handler = $this->_getStorage();		if (!($handler instanceof Exception) && $this->_options['caching'])		{			$handler->_lifetime = $this->_options['lifetime'];			return $handler->store($id, $group, $data);		}		return false;	}	/**	 * Remove a cached data entry by id and group	 *	 * @param   string  $id     The cache data id	 * @param   string  $group  The cache data group	 *	 * @return  boolean  True on success, false otherwise	 *	 * @since   11.1	 */	public function remove($id, $group = null)	{		// Get the default group		$group = ($group) ? $group : $this->_options['defaultgroup'];		// Get the storage		$handler = $this->_getStorage();		if (!($handler instanceof Exception))		{			return $handler->remove($id, $group);		}		return false;	}	/**	 * Clean cache for a group given a mode.	 *	 * group mode       : cleans all cache in the group	 * notgroup mode    : cleans all cache not in the group	 *	 * @param   string  $group  The cache data group	 * @param   string  $mode   The mode for cleaning cache [group|notgroup]	 *	 * @return  boolean  True on success, false otherwise	 *	 * @since   11.1	 */	public function clean($group = null, $mode = 'group')	{		// Get the default group		$group = ($group) ? $group : $this->_options['defaultgroup'];		// Get the storage handler		$handler = $this->_getStorage();		if (!($handler instanceof Exception))		{			return $handler->clean($group, $mode);		}		return false;	}	/**	 * Garbage collect expired cache data	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   11.1	 */	public function gc()	{		// Get the storage handler		$handler = $this->_getStorage();		if (!($handler instanceof Exception))		{			return $handler->gc();		}		return false;	}	/**	 * Set lock flag on cached item	 *	 * @param   string  $id        The cache data id	 * @param   string  $group     The cache data group	 * @param   string  $locktime  The default locktime for locking the cache.	 *	 * @return  object  Properties are lock and locklooped	 *	 * @since   11.1	 */	public function lock($id, $group = null, $locktime = null)	{		$returning = new stdClass;		$returning->locklooped = false;		// Get the default group		$group = ($group) ? $group : $this->_options['defaultgroup'];		// Get the default locktime		$locktime = ($locktime) ? $locktime : $this->_options['locktime'];		// Allow storage handlers to perform locking on their own		// NOTE drivers with lock need also unlock or unlocking will fail because of false $id		$handler = $this->_getStorage();		if (!($handler instanceof Exception) && $this->_options['locking'] == true && $this->_options['caching'] == true)		{			$locked = $handler->lock($id, $group, $locktime);			if ($locked !== false)			{				return $locked;			}		}		// Fallback		$curentlifetime = $this->_options['lifetime'];		// Set lifetime to locktime for storing in children		$this->_options['lifetime'] = $locktime;		$looptime = $locktime * 10;		$id2 = $id . '_lock';		if ($this->_options['locking'] == true && $this->_options['caching'] == true)		{			$data_lock = $this->get($id2, $group);		}		else		{			$data_lock = false;			$returning->locked = false;		}		if ($data_lock !== false)		{			$lock_counter = 0;			// Loop until you find that the lock has been released.			// That implies that data get from other thread has finished			while ($data_lock !== false)			{				if ($lock_counter > $looptime)				{					$returning->locked = false;					$returning->locklooped = true;					break;				}				usleep(100);				$data_lock = $this->get($id2, $group);				$lock_counter++;			}		}		if ($this->_options['locking'] == true && $this->_options['caching'] == true)		{			$returning->locked = $this->store(1, $id2, $group);		}		// Revert lifetime to previous one		$this->_options['lifetime'] = $curentlifetime;		return $returning;	}	/**	 * Unset lock flag on cached item	 *	 * @param   string  $id     The cache data id	 * @param   string  $group  The cache data group	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   11.1	 */	public function unlock($id, $group = null)	{		$unlock = false;		// Get the default group		$group = ($group) ? $group : $this->_options['defaultgroup'];		// Allow handlers to perform unlocking on their own		$handler = $this->_getStorage();		if (!($handler instanceof Exception) && $this->_options['caching'])		{			$unlocked = $handler->unlock($id, $group);			if ($unlocked !== false)			{				return $unlocked;			}		}		// Fallback		if ($this->_options['caching'])		{			$unlock = $this->remove($id . '_lock', $group);		}		return $unlock;	}	/**	 * Get the cache storage handler	 *	 * @return  JCacheStorage   A JCacheStorage object	 *	 * @since   11.1	 */	public function &_getStorage()	{		$hash = md5(serialize($this->_options));		if (isset(self::$_handler[$hash]))		{			return self::$_handler[$hash];		}		self::$_handler[$hash] = JCacheStorage::getInstance($this->_options['storage'], $this->_options);		return self::$_handler[$hash];	}	/**	 * Perform workarounds on retrieved cached data	 *	 * @param   string  $data     Cached data	 * @param   array   $options  Array of options	 *	 * @return  string  Body of cached data	 *	 * @since   11.1	 */	public static function getWorkarounds($data, $options = array())	{		$app = JFactory::getApplication();		$document = JFactory::getDocument();		$body = null;		// Get the document head out of the cache.		if (isset($options['mergehead']) && $options['mergehead'] == 1 && isset($data['head']) && !empty($data['head']))		{			$document->mergeHeadData($data['head']);		}		elseif (isset($data['head']) && method_exists($document, 'setHeadData'))		{			$document->setHeadData($data['head']);		}		// If the pathway buffer is set in the cache data, get it.		if (isset($data['pathway']) && is_array($data['pathway']))		{			// Push the pathway data into the pathway object.			$pathway = $app->getPathWay();			$pathway->setPathway($data['pathway']);		}		// @todo check if the following is needed, seems like it should be in page cache		// If a module buffer is set in the cache data, get it.		if (isset($data['module']) && is_array($data['module']))		{			// Iterate through the module positions and push them into the document buffer.			foreach ($data['module'] as $name => $contents)			{				$document->setBuffer($contents, 'module', $name);			}		}		if (isset($data['body']))		{			// The following code searches for a token in the cached page and replaces it with the			// proper token.			$token = JSession::getFormToken();			$search = '#<input type="hidden" name="[0-9a-f]{32}" value="1" />#';			$replacement = '<input type="hidden" name="' . $token . '" value="1" />';			$data['body'] = preg_replace($search, $replacement, $data['body']);			$body = $data['body'];		}		// Get the document body out of the cache.		return $body;	}	/**	 * Create workarounded data to be cached	 *	 * @param   string  $data     Cached data	 * @param   array   $options  Array of options	 *	 * @return  string  Data to be cached	 *	 * @since   11.1	 */	public static function setWorkarounds($data, $options = array())	{		$loptions = array();		$loptions['nopathway'] = 0;		$loptions['nohead'] = 0;		$loptions['nomodules'] = 0;		$loptions['modulemode'] = 0;		if (isset($options['nopathway']))		{			$loptions['nopathway'] = $options['nopathway'];		}		if (isset($options['nohead']))		{			$loptions['nohead'] = $options['nohead'];		}		if (isset($options['nomodules']))		{			$loptions['nomodules'] = $options['nomodules'];		}		if (isset($options['modulemode']))		{			$loptions['modulemode'] = $options['modulemode'];		}		$app = JFactory::getApplication();		$document = JFactory::getDocument();		// Get the modules buffer before component execution.		$buffer1 = $document->getBuffer();		if (!is_array($buffer1))		{			$buffer1 = array();		}		// Make sure the module buffer is an array.		if (!isset($buffer1['module']) || !is_array($buffer1['module']))		{			$buffer1['module'] = array();		}		// View body data		$cached['body'] = $data;		// Document head data		if ($loptions['nohead'] != 1 && method_exists($document, 'getHeadData'))		{			if ($loptions['modulemode'] == 1)			{				$headnow = $document->getHeadData();				$unset = array('title', 'description', 'link', 'links', 'metaTags');				foreach ($unset as $un)				{					unset($headnow[$un]);					unset($options['headerbefore'][$un]);				}				$cached['head'] = array();				// Only store what this module has added				foreach ($headnow as $now => $value)				{					if (isset($options['headerbefore'][$now]))					{						// We have to serialize the content of the arrays because the may contain other arrays which is a notice in PHP 5.4 and newer						$nowvalue = array_map('serialize', $headnow[$now]);						$beforevalue = array_map('serialize', $options['headerbefore'][$now]);						$newvalue = array_diff_assoc($nowvalue, $beforevalue);						$newvalue = array_map('unserialize', $newvalue);					}					else					{						$newvalue = $headnow[$now];					}					if (!empty($newvalue))					{						$cached['head'][$now] = $newvalue;					}				}			}			else			{				$cached['head'] = $document->getHeadData();			}		}		// Pathway data		if ($app->isSite() && $loptions['nopathway'] != 1)		{			$pathway = $app->getPathWay();			$cached['pathway'] = isset($data['pathway']) ? $data['pathway'] : $pathway->getPathway();		}		if ($loptions['nomodules'] != 1)		{			// @todo Check if the following is needed, seems like it should be in page cache			// Get the module buffer after component execution.			$buffer2 = $document->getBuffer();			if (!is_array($buffer2))			{				$buffer2 = array();			}			// Make sure the module buffer is an array.			if (!isset($buffer2['module']) || !is_array($buffer2['module']))			{				$buffer2['module'] = array();			}			// Compare the second module buffer against the first buffer.			$cached['module'] = array_diff_assoc($buffer2['module'], $buffer1['module']);		}		return $cached;	}	/**	 * Create safe id for cached data from url parameters set by plugins and framework	 *	 * @return  string   md5 encoded cacheid	 *	 * @since   11.1	 */	public static function makeId()	{		$app = JFactory::getApplication();		// Get url parameters set by plugins		if (!empty($app->registeredurlparams))		{			$registeredurlparams = $app->registeredurlparams;		}		// Platform defaults		$registeredurlparams->format = 'WORD';		$registeredurlparams->option = 'WORD';		$registeredurlparams->view = 'WORD';		$registeredurlparams->layout = 'WORD';		$registeredurlparams->tpl = 'CMD';		$registeredurlparams->id = 'INT';		$safeuriaddon = new stdClass;		foreach ($registeredurlparams as $key => $value)		{			$safeuriaddon->$key = $app->input->get($key, null, $value);		}		return md5(serialize($safeuriaddon));	}	/**	 * Add a directory where JCache should search for handlers. You may	 * either pass a string or an array of directories.	 *	 * @param   string  $path  A path to search.	 *	 * @return  array   An array with directory elements	 *	 * @since   11.1	 */	public static function addIncludePath($path = '')	{		static $paths;		if (!isset($paths))		{			$paths = array();		}		if (!empty($path) && !in_array($path, $paths))		{			jimport('joomla.filesystem.path');			array_unshift($paths, JPath::clean($path));		}		return $paths;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User notes table class * * @package     Joomla.Administrator * @subpackage  com_users * @since       2.5 */class UsersTableNote extends JTable{	/**	 * Constructor	 *	 * @param  JDatabaseDriver  &$db  Database object	 *	 * @since  2.5	 */	public function __construct(&$db)	{		parent::__construct('#__user_notes', 'id', $db);	}	/**	 * Overloaded store method for the notes table.	 *	 * @param   boolean  $updateNulls  Toggle whether null values should be updated.	 *	 * @return  boolean  True on success, false on failure.	 *	 * @since   2.5	 */	public function store($updateNulls = false)	{		$date = JFactory::getDate()->toSql();		$userId = JFactory::getUser()->get('id');		if (empty($this->id))		{			// New record.			$this->created_time = $date;			$this->created_user_id = $userId;		}		else		{			// Existing record.			$this->modified_time = $date;			$this->modified_user_id = $userId;		}		// Attempt to store the data.		return parent::store($updateNulls);	}	/**	 * Method to set the publishing state for a row or list of rows in the database	 * table.  The method respects checked out rows by other users and will attempt	 * to check-in rows that it can after adjustments are made.	 *	 * @param   mixed    $pks     An optional array of primary key values to update.  If not set the instance property value is used.	 * @param   integer  $state   The publishing state. eg. [0 = unpublished, 1 = published]	 * @param   integer  $userId  The user id of the user performing the operation.	 *	 * @return  boolean  True on success.	 *	 * @link    http://docs.joomla.org/JTable/publish	 * @since   2.5	 */	public function publish($pks = null, $state = 1, $userId = 0)	{		$k = $this->_tbl_key;		// Sanitize input.		JArrayHelper::toInteger($pks);		$userId = (int) $userId;		$state  = (int) $state;		// If there are no primary keys set check to see if the instance key is set.		if (empty($pks))		{			if ($this->$k)			{				$pks = array($this->$k);			}			// Nothing to set publishing state on, return false.			else			{				$this->setError(JText::_('JLIB_DATABASE_ERROR_NO_ROWS_SELECTED'));				return false;			}		}		$query = $this->_db->getQuery(true)			->update($this->_db->quoteName($this->_tbl))			->set($this->_db->quoteName('state') . ' = ' . (int) $state);		// Build the WHERE clause for the primary keys.		$query->where($k . '=' . implode(' OR ' . $k . '=', $pks));		// Determine if there is checkin support for the table.		if (!property_exists($this, 'checked_out') || !property_exists($this, 'checked_out_time'))		{			$checkin = false;		}		else		{			$query->where('(checked_out = 0 OR checked_out = ' . (int) $userId . ')');			$checkin = true;		}		// Update the publishing state for rows with the given primary keys.		$this->_db->setQuery($query);		try		{			$this->_db->execute();		}		catch (RuntimeException $e)		{			$this->setError($this->_db->getMessage());			return false;		}		// If checkin is supported and all rows were adjusted, check them in.		if ($checkin && (count($pks) == $this->_db->getAffectedRows()))		{			// Checkin the rows.			foreach ($pks as $pk)			{				$this->checkin($pk);			}		}		// If the JTable instance value is in the list of primary keys that were set, set the instance.		if (in_array($this->$k, $pks))		{			$this->state = $state;		}		$this->setError('');		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_checkin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Checkin Model * * @package     Joomla.Administrator * @subpackage  com_checkin * @since       1.6 */class CheckinModelCheckin extends JModelList{	protected $total;	protected $tables;	/**	 * Method to auto-populate the model state.	 *	 * @Note. Calling getState in this method will result in recursion.	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$search = $this->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $search);		// List state information.		parent::populateState('table', 'asc');	}	/**	 * Checks in requested tables	 *	 * @param   array  $ids  An array of table names. Optional.	 *	 * @return  integer   Checked in item count	 * @since   1.6	 */	public function checkin($ids = array())	{		$app = JFactory::getApplication();		$db = $this->_db;		$nullDate = $db->getNullDate();		if (!is_array($ids))		{			return;		}		// this int will hold the checked item count		$results = 0;		foreach ($ids as $tn)		{			// make sure we get the right tables based on prefix			if (stripos($tn, $app->getCfg('dbprefix')) !== 0)			{				continue;			}			$fields = $db->getTableColumns($tn);			if (!(isset($fields['checked_out']) && isset($fields['checked_out_time'])))			{				continue;			}			$query = $db->getQuery(true)				->update($db->quoteName($tn))				->set('checked_out = 0')				->set('checked_out_time = ' . $db->quote($nullDate))				->where('checked_out > 0');			if (isset($fields[$tn]['editor']))			{				$query->set('editor = NULL');			}			$db->setQuery($query);			if ($db->execute())			{				$results = $results + $db->getAffectedRows();			}		}		return $results;	}	/**	 * Get total of tables	 *	 * @return  int    Total to check-in tables	 * @since   1.6	 */	public function getTotal()	{		if (!isset($this->total))		{			$this->getItems();		}		return $this->total;	}	/**	 * Get tables	 *	 * @return  array  Checked in table names as keys and checked in item count as values	 * @since   1.6	 */	public function getItems()	{		if (!isset($this->items))		{			$app = JFactory::getApplication();			$db = $this->_db;			$tables = $db->getTableList();			// this array will hold table name as key and checked in item count as value			$results = array();			foreach ($tables as $i => $tn)			{				// make sure we get the right tables based on prefix				if (stripos($tn, $app->getCfg('dbprefix')) !== 0)				{					unset($tables[$i]);					continue;				}				if ($this->getState('filter.search') && stripos($tn, $this->getState('filter.search')) === false)				{					unset($tables[$i]);					continue;				}				$fields = $db->getTableColumns($tn);				if (!(isset($fields['checked_out']) && isset($fields['checked_out_time'])))				{					unset($tables[$i]);					continue;				}			}			foreach ($tables as $tn)			{				$query = $db->getQuery(true)					->select('COUNT(*)')					->from($db->quoteName($tn))					->where('checked_out > 0');				$db->setQuery($query);				if ($db->execute())				{					$results[$tn] = $db->loadResult();				}				else				{					continue;				}			}			$this->total = count($results);			if ($this->getState('list.ordering') == 'table')			{				if ($this->getState('list.direction') == 'asc')				{					ksort($results);				}				else				{					krsort($results);				}			}			else			{				if ($this->getState('list.direction') == 'asc')				{					asort($results);				}				else				{					arsort($results);				}			}			$results = array_slice($results, $this->getState('list.start'), $this->getState('list.limit') ? $this->getState('list.limit') : null);			$this->items = $results;		}		return $this->items;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Admin Component Help Model * * @package     Joomla.Administrator * @subpackage  com_admin * @since       1.6 */class AdminModelHelp extends JModelLegacy{	/**	 * The search string	 * @var    string	 *	 * @since  1.6	 */	protected $help_search = null;	/**	 * The page to be viewed	 * @var    string	 *	 * @since  1.6	 */	protected $page = null;	/**	 * The iso language tag	 * @var    string	 *	 * @since  1.6	 */	protected $lang_tag = null;	/**	 * Table of contents	 *	 * @var    array	 * @since  1.6	 */	protected $toc = null;	/**	 * URL for the latest version check	 *	 * @var    string	 * @since  1.6	 */	protected $latest_version_check = null;	/**	 * Method to get the help search string	 *	 * @return  string  Help search string	 *	 * @since  1.6	 */	public function &getHelpSearch()	{		if (is_null($this->help_search))		{			$this->help_search = JFactory::getApplication()->input->getString('helpsearch');		}		return $this->help_search;	}	/**	 * Method to get the page	 *	 * @return  string  The page	 *	 * @since  1.6	 */	public function &getPage()	{		if (is_null($this->page))		{			$page = JFactory::getApplication()->input->get('page', 'JHELP_START_HERE');			$this->page = JHelp::createUrl($page);		}		return $this->page;	}	/**	 * Method to get the lang tag	 *	 * @return  string  lang iso tag	 *	 * @since  1.6	 */	public function getLangTag()	{		if (is_null($this->lang_tag))		{			$lang = JFactory::getLanguage();			$this->lang_tag = $lang->getTag();			if (!is_dir(JPATH_BASE . '/help/' . $this->lang_tag))			{				// Use english as fallback				$this->lang_tag = 'en-GB';			}		}		return $this->lang_tag;	}	/**	 * Method to get the toc	 *	 * @return  array  Table of contents	 */	public function &getToc()	{		if (is_null($this->toc))		{			// Get vars			$lang_tag = $this->getLangTag();			$help_search = $this->getHelpSearch();			// Get Help files			jimport('joomla.filesystem.folder');			$files = JFolder::files(JPATH_BASE . '/help/' . $lang_tag, '\.xml$|\.html$');			$this->toc = array();			foreach ($files as $file)			{				$buffer = file_get_contents(JPATH_BASE . '/help/' . $lang_tag . '/' . $file);				if (preg_match('#<title>(.*?)</title>#', $buffer, $m))				{					$title = trim($m[1]);					if ($title)					{						// Translate the page title						$title = JText::_($title);						// strip the extension						$file = preg_replace('#\.xml$|\.html$#', '', $file);						if ($help_search)						{							if (JString::strpos(JString::strtolower(strip_tags($buffer)), JString::strtolower($help_search)) !== false)							{								// Add an item in the Table of Contents								$this->toc[$file] = $title;							}						}						else						{							// Add an item in the Table of Contents							$this->toc[$file] = $title;						}					}				}			}			// Sort the Table of Contents			asort($this->toc);		}		return $this->toc;	}	/**	 * Method to get the latest version check	 *	 * @return  string  Latest Version Check URL	 */	public function &getLatestVersionCheck()	{		if (!$this->latest_version_check)		{			$override = 'http://help.joomla.org/proxy/index.php?option=com_help&keyref=Help{major}{minor}:Joomla_Version_{major}_{minor}_{maintenance}';			$this->latest_version_check = JHelp::createUrl('JVERSION', false, $override);		}		return $this->latest_version_check;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$published = $this->state->get('filter.published');?><div class="modal hide fade" id="collapseModal">	<div class="modal-header">		<button type="button" class="close" data-dismiss="modal">x</button>		<h3><?php echo JText::_('COM_CONTACT_BATCH_OPTIONS');?></h3>	</div>	<div class="modal-body">		<p><?php echo JText::_('COM_CONTACT_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.access');?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.language'); ?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.user'); ?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.tag');?>			</div>		</div>		<?php if ($published >= 0) : ?>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.item', 'com_contact');?>			</div>		</div>		<?php endif; ?>	</div>	<div class="modal-footer">		<button class="btn" type="button" onclick="document.id('batch-category-id').value='';document.id('batch-access').value='';document.id('batch-language-id').value='';document.id('batch-user-id').value='';document.id('batch-tag-id)').value=''" data-dismiss="modal">			<?php echo JText::_('JCANCEL'); ?>		</button>		<button class="btn btn-primary" type="submit" onclick="Joomla.submitbutton('contact.batch');">			<?php echo JText::_('JGLOBAL_BATCH_PROCESS'); ?>		</button>	</div></div>
<?php/** * @package     Joomla.Libraries * @subpackage  Toolbar * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Button base class * * The JButton is the base class for all JButton types * * @package     Joomla.Libraries * @subpackage  Toolbar * @since       3.0 */abstract class JToolbarButton{	/**	 * element name	 *	 * This has to be set in the final renderer classes.	 *	 * @var    string	 */	protected $_name = null;	/**	 * reference to the object that instantiated the element	 *	 * @var    JButton	 */	protected $_parent = null;	/**	 * Constructor	 *	 * @param   object  $parent  The parent	 */	public function __construct($parent = null)	{		$this->_parent = $parent;	}	/**	 * Get the element name	 *	 * @return  string   type of the parameter	 *	 * @since   3.0	 */	public function getName()	{		return $this->_name;	}	/**	 * Get the HTML to render the button	 *	 * @param   array  &$definition  Parameters to be passed	 *	 * @return  string	 *	 * @since   3.0	 */	public function render(&$definition)	{		/*		 * Initialise some variables		 */		$html = null;		$id = call_user_func_array(array(&$this, 'fetchId'), $definition);		$action = call_user_func_array(array(&$this, 'fetchButton'), $definition);		// Build id attribute		if ($id)		{			$id = "id=\"$id\"";		}		// Build the HTML Button		$html .= "<div class=\"btn-group\" $id>\n";		$html .= $action;		$html .= "</div>\n";		return $html;	}	/**	 * Method to get the CSS class name for an icon identifier	 *	 * Can be redefined in the final class	 *	 * @param   string  $identifier  Icon identification string	 *	 * @return  string  CSS class name	 *	 * @since   3.0	 */	public function fetchIconClass($identifier)	{		return "icon-$identifier";	}	/**	 * Get the button	 *	 * Defined in the final button class	 *	 * @return  string	 *	 * @since   3.0	 */	abstract public function fetchButton();}/** * Deprecated class placeholder. You should use JToolbarButton instead. * * @package     Joomla.Legacy * @subpackage  Toolbar * @since       1.5 * @deprecated  4.0  Use JToolbarButton instead. * @codeCoverageIgnore */abstract class JButton extends JToolbarButton{	/**	 * Constructor	 *	 * @param   object  $parent  The parent	 *	 * @deprecated  4.0  Use JToolbarButton instead.	 */	public function __construct($parent = null)	{		JLog::add('JButton is deprecated. Use JToolbarButton instead.', JLog::WARNING, 'deprecated');		parent::__construct($parent);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('bootstrap.tooltip');$input     = JFactory::getApplication()->input;$function  = JFactory::getApplication()->input->getCmd('function', 'jSelectNewsfeed');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_newsfeeds&view=newsfeeds&layout=modal&tmpl=component&function='.$function);?>" method="post" name="adminForm" id="adminForm" class="form-inline">	<fieldset class="filter clearfix">		<div class="btn-toolbar">			<div class="btn-group pull-left">				<label for="filter_search">					<?php echo JText::_('JSEARCH_FILTER_LABEL'); ?>				</label>				<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" size="30" title="<?php echo JText::_('COM_NEWSFEEDS_FILTER_SEARCH_DESC'); ?>" />			</div>			<div class="btn-group pull-left">				<button type="submit" class="btn hasTooltip" data-placement="bottom" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>">					<i class="icon-search"></i></button>				<button type="button" class="btn hasTooltip" data-placement="bottom" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>" onclick="document.id('filter_search').value='';this.form.submit();">					<i class="icon-remove"></i></button>			</div>				<input onclick="if (window.parent) window.parent.<?php echo $this->escape($function);?>('0', '<?php echo $this->escape(addslashes(JText::_('COM_NEWSFEEDS_SELECT_A_FEED'))); ?>', null, null);" class="btn" type="button" value="<?php echo JText::_('COM_NEWSFEEDS_FIELD_VALUE_NONE'); ?>" />			<div class="clearfix"></div>		</div>		<hr class="hr-condensed" />		<div class="filters">			<select name="filter_access" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_ACCESS');?></option>				<?php echo JHtml::_('select.options', JHtml::_('access.assetgroups'), 'value', 'text', $this->state->get('filter.access'));?>			</select>			<select name="filter_published" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.published'), true);?>			</select>			<?php if ($this->state->get('filter.forcedLanguage')) : ?>			<select name="filter_category_id" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php echo JHtml::_('select.options', JHtml::_('category.options', 'com_newsfeeds', array('filter.language' => array('*', $this->state->get('filter.forcedLanguage')))), 'value', 'text', $this->state->get('filter.category_id'));?>			</select>			<input type="hidden" name="forcedLanguage" value="<?php echo $this->escape($this->state->get('filter.forcedLanguage')); ?>" />			<input type="hidden" name="filter_language" value="<?php echo $this->escape($this->state->get('filter.language')); ?>" />			<?php else : ?>			<select name="filter_category_id" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php echo JHtml::_('select.options', JHtml::_('category.options', 'com_newsfeeds'), 'value', 'text', $this->state->get('filter.category_id'));?>			</select>			<select name="filter_language" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_LANGUAGE');?></option>				<?php echo JHtml::_('select.options', JHtml::_('contentlanguage.existing', true, true), 'value', 'text', $this->state->get('filter.language'));?>			</select>			<?php endif; ?>		</div>	</fieldset>	<table class="table table-striped table-condensed">		<thead>			<tr>				<th class="title">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.name', $listDirn, $listOrder); ?>				</th>				<th width="15%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ACCESS', 'access_level', $listDirn, $listOrder); ?>				</th>				<th width="15%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JCATEGORY', 'a.catid', $listDirn, $listOrder); ?>				</th>				<th width="5%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_LANGUAGE', 'language', $listDirn, $listOrder); ?>				</th>				<th width="1%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tfoot>			<tr>				<td colspan="15">					<?php echo $this->pagination->getListFooter(); ?>				</td>			</tr>		</tfoot>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row<?php echo $i % 2; ?>">				<td>					<a class="pointer" onclick="if (window.parent) window.parent.<?php echo $this->escape($function);?>('<?php echo $item->id; ?>', '<?php echo $this->escape(addslashes($item->name)); ?>');">						<?php echo $this->escape($item->name); ?></a>				</td>				<td class="center">					<?php echo $this->escape($item->access_level); ?>				</td>				<td class="center">					<?php echo $this->escape($item->category_title); ?>				</td>				<td class="center">					<?php if ($item->language == '*'):?>						<?php echo JText::alt('JALL', 'language'); ?>					<?php else:?>						<?php echo $item->language_title ? $this->escape($item->language_title) : JText::_('JUNDEFINED'); ?>					<?php endif;?>				</td>				<td align="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_checkin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('bootstrap.tooltip');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_checkin');?>" method="post" name="adminForm" id="adminForm">  <?php if (!empty( $this->sidebar)) : ?>    <div id="j-sidebar-container" class="span2">      <?php echo $this->sidebar; ?>    </div>      <div id="j-main-container" class="span10">  <?php else : ?>    <div id="j-main-container">  <?php endif;?>  	<div id="filter-bar" class="btn-toolbar">  		<div class="filter-search btn-group pull-left">  			<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('JSEARCH_FILTER_LABEL'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_CHECKIN_FILTER_SEARCH_DESC'); ?>" />  		</div>  		<div class="btn-group pull-left">  			<button class="btn tip hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>  			<button class="btn tip hasTooltip" type="button" onclick="document.id('filter_search').value='';this.form.submit();" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>"><i class="icon-remove"></i></button>  		</div>  	</div>  	<div class="clearfix"> </div>  	<table id="global-checkin" class="table table-striped">  		<thead>  			<tr>  				<th width="1%">  					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />  				</th>  				<th class="left"><?php echo JHtml::_('grid.sort', 'COM_CHECKIN_DATABASE_TABLE', 'table', $listDirn, $listOrder); ?></th>  				<th><?php echo JHtml::_('grid.sort', 'COM_CHECKIN_ITEMS_TO_CHECK_IN', 'count', $listDirn, $listOrder); ?></th>  			</tr>  		</thead>  		<tbody>  		<?php foreach ($this->items as $table => $count): $i = 0;?>  			<tr class="row<?php echo $i % 2; ?>">  				<td class="center"><?php echo JHtml::_('grid.id', $i, $table); ?></td>  				<td><?php echo JText::sprintf('COM_CHECKIN_TABLE', $table); ?></td>  				<td width="200" class="center"><span class="label label-info"><?php echo $count; ?></span></td>  			</tr>  		<?php endforeach;?>  		</tbody>  		<tfoot>  			<tr>  				<td colspan="15">  					<?php echo $this->pagination->getListFooter(); ?>  				</td>  			</tr>  		</tfoot>  	</table>  	<input type="hidden" name="task" value="" />  	<input type="hidden" name="boxchecked" value="0" />  	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />  	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />  	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Document * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * DocumentError class, provides an easy interface to parse and display an error page * * @package     Joomla.Platform * @subpackage  Document * @since       11.1 */class JDocumentError extends JDocument{	/**	 * Error Object	 *	 * @var    object	 * @since  11.1	 */	protected $_error;	/**	 * Class constructor	 *	 * @param   array  $options  Associative array of attributes	 *	 * @since   11.1	 */	public function __construct($options = array())	{		parent::__construct($options);		// Set mime type		$this->_mime = 'text/html';		// Set document type		$this->_type = 'error';	}	/**	 * Set error object	 *	 * @param   object  $error  Error object to set	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	public function setError($error)	{		if ($error instanceof Exception)		{			$this->_error = & $error;			return true;		}		else		{			return false;		}	}	/**	 * Render the document	 *	 * @param   boolean  $cache   If true, cache the output	 * @param   array    $params  Associative array of attributes	 *	 * @return  string   The rendered data	 *	 * @since   11.1	 */	public function render($cache = false, $params = array())	{		// If no error object is set return null		if (!isset($this->_error))		{			return;		}		// Set the status header		JResponse::setHeader('status', $this->_error->getCode() . ' ' . str_replace("\n", ' ', $this->_error->getMessage()));		$file = 'error.php';		// Check template		$directory = isset($params['directory']) ? $params['directory'] : 'templates';		$template = isset($params['template']) ? JFilterInput::getInstance()->clean($params['template'], 'cmd') : 'system';		if (!file_exists($directory . '/' . $template . '/' . $file))		{			$template = 'system';		}		// Set variables		$this->baseurl = JURI::base(true);		$this->template = $template;		$this->debug = isset($params['debug']) ? $params['debug'] : false;		$this->error = $this->_error;		// Load		$data = $this->_loadTemplate($directory . '/' . $template, $file);		parent::render();		return $data;	}	/**	 * Load a template file	 *	 * @param   string  $directory  The name of the template	 * @param   string  $filename   The actual filename	 *	 * @return  string  The contents of the template	 *	 * @since   11.1	 */	public function _loadTemplate($directory, $filename)	{		$contents = '';		// Check to see if we have a valid template file		if (file_exists($directory . '/' . $filename))		{			// Store the file path			$this->_file = $directory . '/' . $filename;			// Get the file content			ob_start();			require_once $directory . '/' . $filename;			$contents = ob_get_contents();			ob_end_clean();		}		return $contents;	}	/**	 * Render the backtrace	 *	 * @return  string  The contents of the backtrace	 *	 * @since   11.1	 */	public function renderBacktrace()	{		$contents = null;		$backtrace = $this->_error->getTrace();		if (is_array($backtrace))		{			ob_start();			$j = 1;			echo '<table cellpadding="0" cellspacing="0" class="Table">';			echo '	<tr>';			echo '		<td colspan="3" class="TD"><strong>Call stack</strong></td>';			echo '	</tr>';			echo '	<tr>';			echo '		<td class="TD"><strong>#</strong></td>';			echo '		<td class="TD"><strong>Function</strong></td>';			echo '		<td class="TD"><strong>Location</strong></td>';			echo '	</tr>';			for ($i = count($backtrace) - 1; $i >= 0; $i--)			{				echo '	<tr>';				echo '		<td class="TD">' . $j . '</td>';				if (isset($backtrace[$i]['class']))				{					echo '	<td class="TD">' . $backtrace[$i]['class'] . $backtrace[$i]['type'] . $backtrace[$i]['function'] . '()</td>';				}				else				{					echo '	<td class="TD">' . $backtrace[$i]['function'] . '()</td>';				}				if (isset($backtrace[$i]['file']))				{					echo '		<td class="TD">' . $backtrace[$i]['file'] . ':' . $backtrace[$i]['line'] . '</td>';				}				else				{					echo '		<td class="TD">&#160;</td>';				}				echo '	</tr>';				$j++;			}			echo '</table>';			$contents = ob_get_contents();			ob_end_clean();		}		return $contents;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Database * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * PostgreSQL import driver. * * @package     Joomla.Platform * @subpackage  Database * @since       12.1 */class JDatabaseImporterPostgresql extends JDatabaseImporter{	/**	 * @var    array  An array of cached data.	 * @since  12.1	 */	protected $cache = array();	/**	 * The database connector to use for exporting structure and/or data.	 *	 * @var    JDatabaseDriverPostgresql	 * @since  12.1	 */	protected $db = null;	/**	 * The input source.	 *	 * @var    mixed	 * @since  12.1	 */	protected $from = array();	/**	 * The type of input format (XML).	 *	 * @var    string	 * @since  12.1	 */	protected $asFormat = 'xml';	/**	 * An array of options for the exporter.	 *	 * @var    object	 * @since  12.1	 */	protected $options = null;	/**	 * Constructor.	 *	 * Sets up the default options for the exporter.	 *	 * @since   12.1	 */	public function __construct()	{		$this->options = new stdClass;		$this->cache = array('columns' => array(), 'keys' => array());		// Set up the class defaults:		// Import with only structure		$this->withStructure();		// Export as XML.		$this->asXml();		// Default destination is a string using $output = (string) $exporter;	}	/**	 * Set the output option for the exporter to XML format.	 *	 * @return  JDatabaseImporterPostgresql  Method supports chaining.	 *	 * @since   12.1	 */	public function asXml()	{		$this->asFormat = 'xml';		return $this;	}	/**	 * Checks if all data and options are in order prior to exporting.	 *	 * @return  JDatabaseImporterPostgresql  Method supports chaining.	 *	 * @since   12.1	 * @throws  Exception if an error is encountered.	 */	public function check()	{		// Check if the db connector has been set.		if (!($this->db instanceof JDatabaseDriverPostgresql))		{			throw new Exception('JPLATFORM_ERROR_DATABASE_CONNECTOR_WRONG_TYPE');		}		// Check if the tables have been specified.		if (empty($this->from))		{			throw new Exception('JPLATFORM_ERROR_NO_TABLES_SPECIFIED');		}		return $this;	}	/**	 * Specifies the data source to import.	 *	 * @param   mixed  $from  The data source to import.	 *	 * @return  JDatabaseImporterPostgresql  Method supports chaining.	 *	 * @since   12.1	 */	public function from($from)	{		$this->from = $from;		return $this;	}	/**	 * Get the SQL syntax to add a column.	 *	 * @param   string            $table  The table name.	 * @param   SimpleXMLElement  $field  The XML field definition.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getAddColumnSQL($table, SimpleXMLElement $field)	{		$query = 'ALTER TABLE ' . $this->db->quoteName($table) . ' ADD COLUMN ' . $this->getColumnSQL($field);		return $query;	}	/**	 * Get the SQL syntax to add an index.	 *	 * @param   SimpleXMLElement  $field  The XML index definition.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getAddIndexSQL(SimpleXMLElement $field)	{		return (string) $field['Query'];	}	/**	 * Get alters for table if there is a difference.	 *	 * @param   SimpleXMLElement  $structure  The XML structure of the table.	 *	 * @return  array	 *	 * @since   12.1	 */	protected function getAlterTableSQL(SimpleXMLElement $structure)	{		$table = $this->getRealTableName($structure['name']);		$oldFields = $this->db->getTableColumns($table);		$oldKeys = $this->db->getTableKeys($table);		$oldSequence = $this->db->getTableSequences($table);		$alters = array();		// Get the fields and keys from the XML that we are aiming for.		$newFields = $structure->xpath('field');		$newKeys = $structure->xpath('key');		$newSequence = $structure->xpath('sequence');		/* Sequence section */		$oldSeq = $this->getSeqLookup($oldSequence);		$newSequenceLook = $this->getSeqLookup($newSequence);		foreach ($newSequenceLook as $kSeqName => $vSeq)		{			if (isset($oldSeq[$kSeqName]))			{				// The field exists, check it's the same.				$column = $oldSeq[$kSeqName][0];				/* For older database version that doesn't support these fields use default values */				if (version_compare($this->db->getVersion(), '9.1.0') < 0)				{					$column->Min_Value = '1';					$column->Max_Value = '9223372036854775807';					$column->Increment = '1';					$column->Cycle_option = 'NO';					$column->Start_Value = '1';				}				// Test whether there is a change.				$change = ((string) $vSeq[0]['Type'] != $column->Type) || ((string) $vSeq[0]['Start_Value'] != $column->Start_Value)					|| ((string) $vSeq[0]['Min_Value'] != $column->Min_Value) || ((string) $vSeq[0]['Max_Value'] != $column->Max_Value)					|| ((string) $vSeq[0]['Increment'] != $column->Increment) || ((string) $vSeq[0]['Cycle_option'] != $column->Cycle_option)					|| ((string) $vSeq[0]['Table'] != $column->Table) || ((string) $vSeq[0]['Column'] != $column->Column)					|| ((string) $vSeq[0]['Schema'] != $column->Schema) || ((string) $vSeq[0]['Name'] != $column->Name);				if ($change)				{					$alters[] = $this->getChangeSequenceSQL($kSeqName, $vSeq);				}				// Unset this field so that what we have left are fields that need to be removed.				unset($oldSeq[$kSeqName]);			}			else			{				// The sequence is new				$alters[] = $this->getAddSequenceSQL($newSequenceLook[$kSeqName][0]);			}		}		// Any sequences left are orphans		foreach ($oldSeq as $name => $column)		{			// Delete the sequence.			$alters[] = $this->getDropSequenceSQL($name);		}		/* Field section */		// Loop through each field in the new structure.		foreach ($newFields as $field)		{			$fName = (string) $field['Field'];			if (isset($oldFields[$fName]))			{				// The field exists, check it's the same.				$column = $oldFields[$fName];				// Test whether there is a change.				$change = ((string) $field['Type'] != $column->Type) || ((string) $field['Null'] != $column->Null)					|| ((string) $field['Default'] != $column->Default);				if ($change)				{					$alters[] = $this->getChangeColumnSQL($table, $field);				}				// Unset this field so that what we have left are fields that need to be removed.				unset($oldFields[$fName]);			}			else			{				// The field is new.				$alters[] = $this->getAddColumnSQL($table, $field);			}		}		// Any columns left are orphans		foreach ($oldFields as $name => $column)		{			// Delete the column.			$alters[] = $this->getDropColumnSQL($table, $name);		}		/* Index section */		// Get the lookups for the old and new keys		$oldLookup = $this->getIdxLookup($oldKeys);		$newLookup = $this->getIdxLookup($newKeys);		// Loop through each key in the new structure.		foreach ($newLookup as $name => $keys)		{			// Check if there are keys on this field in the existing table.			if (isset($oldLookup[$name]))			{				$same = true;				$newCount = count($newLookup[$name]);				$oldCount = count($oldLookup[$name]);				// There is a key on this field in the old and new tables. Are they the same?				if ($newCount == $oldCount)				{					for ($i = 0; $i < $newCount; $i++)					{						// Check only query field -> different query means different index						$same = ((string) $newLookup[$name][$i]['Query'] == $oldLookup[$name][$i]->Query);						if (!$same)						{							// Break out of the loop. No need to check further.							break;						}					}				}				else				{					// Count is different, just drop and add.					$same = false;				}				if (!$same)				{					$alters[] = $this->getDropIndexSQL($name);					$alters[]  = (string) $newLookup[$name][0]['Query'];				}				// Unset this field so that what we have left are fields that need to be removed.				unset($oldLookup[$name]);			}			else			{				// This is a new key.				$alters[] = (string) $newLookup[$name][0]['Query'];			}		}		// Any keys left are orphans.		foreach ($oldLookup as $name => $keys)		{			if ($oldLookup[$name][0]->is_primary == 'TRUE')			{				$alters[] = $this->getDropPrimaryKeySQL($table, $oldLookup[$name][0]->Index);			}			else			{				$alters[] = $this->getDropIndexSQL($name);			}		}		return $alters;	}	/**	 * Get the SQL syntax to drop a sequence.	 *	 * @param   string  $name  The name of the sequence to drop.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getDropSequenceSQL($name)	{		$query = 'DROP SEQUENCE ' . $this->db->quoteName($name);		return $query;	}	/**	 * Get the syntax to add a sequence.	 *	 * @param   SimpleXMLElement  $field  The XML definition for the sequence.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getAddSequenceSQL($field)	{		/* For older database version that doesn't support these fields use default values */		if (version_compare($this->db->getVersion(), '9.1.0') < 0)		{			$field['Min_Value'] = '1';			$field['Max_Value'] = '9223372036854775807';			$field['Increment'] = '1';			$field['Cycle_option'] = 'NO';			$field['Start_Value'] = '1';		}		$query = 'CREATE SEQUENCE ' . (string) $field['Name'] .				' INCREMENT BY ' . (string) $field['Increment'] . ' MINVALUE ' . $field['Min_Value'] .				' MAXVALUE ' . (string) $field['Max_Value'] . ' START ' . (string) $field['Start_Value'] .				(((string) $field['Cycle_option'] == 'NO' ) ? ' NO' : '' ) . ' CYCLE' .				' OWNED BY ' . $this->db->quoteName(									(string) $field['Schema'] . '.' . (string) $field['Table'] . '.' . (string) $field['Column']								);		return $query;	}	/**	 * Get the syntax to alter a sequence.	 *	 * @param   SimpleXMLElement  $field  The XML definition for the sequence.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getChangeSequenceSQL($field)	{		/* For older database version that doesn't support these fields use default values */		if (version_compare($this->db->getVersion(), '9.1.0') < 0)		{			$field['Min_Value'] = '1';			$field['Max_Value'] = '9223372036854775807';			$field['Increment'] = '1';			$field['Cycle_option'] = 'NO';			$field['Start_Value'] = '1';		}		$query = 'ALTER SEQUENCE ' . (string) $field['Name'] .				' INCREMENT BY ' . (string) $field['Increment'] . ' MINVALUE ' . (string) $field['Min_Value'] .				' MAXVALUE ' . (string) $field['Max_Value'] . ' START ' . (string) $field['Start_Value'] .				' OWNED BY ' . $this->db->quoteName(									(string) $field['Schema'] . '.' . (string) $field['Table'] . '.' . (string) $field['Column']								);		return $query;	}	/**	 * Get the syntax to alter a column.	 *	 * @param   string            $table  The name of the database table to alter.	 * @param   SimpleXMLElement  $field  The XML definition for the field.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getChangeColumnSQL($table, SimpleXMLElement $field)	{		$query = 'ALTER TABLE ' . $this->db->quoteName($table) . ' ALTER COLUMN ' . $this->db->quoteName((string) $field['Field']) . ' '			. $this->getAlterColumnSQL($table, $field);		return $query;	}	/**	 * Get the SQL syntax for a single column that would be included in a table create statement.	 *	 * @param   string            $table  The name of the database table to alter.	 * @param   SimpleXMLElement  $field  The XML field definition.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getAlterColumnSQL($table, $field)	{		// TODO Incorporate into parent class and use $this.		$blobs = array('text', 'smalltext', 'mediumtext', 'largetext');		$fName = (string) $field['Field'];		$fType = (string) $field['Type'];		$fNull = (string) $field['Null'];		$fDefault = (isset($field['Default']) && $field['Default'] != 'NULL' ) ?						preg_match('/^[0-9]$/', $field['Default']) ? $field['Default'] : $this->db->quote((string) $field['Default'])					: null;		$query = ' TYPE ' . $fType;		if ($fNull == 'NO')		{			if (in_array($fType, $blobs) || $fDefault === null)			{				$query .= ",\nALTER COLUMN " . $this->db->quoteName($fName) . ' SET NOT NULL' .						",\nALTER COLUMN " . $this->db->quoteName($fName) . ' DROP DEFAULT';			}			else			{				$query .= ",\nALTER COLUMN " . $this->db->quoteName($fName) . ' SET NOT NULL' .						",\nALTER COLUMN " . $this->db->quoteName($fName) . ' SET DEFAULT ' . $fDefault;			}		}		else		{			if ($fDefault !== null)			{				$query .= ",\nALTER COLUMN " . $this->db->quoteName($fName) . ' DROP NOT NULL' .						",\nALTER COLUMN " . $this->db->quoteName($fName) . ' SET DEFAULT ' . $fDefault;			}		}		/* sequence was created in other function, here is associated a default value but not yet owner */		if (strpos($fDefault, 'nextval') !== false)		{			$query .= ";\nALTER SEQUENCE " . $this->db->quoteName($table . '_' . $fName . '_seq') . ' OWNED BY ' . $this->db->quoteName($table . '.' . $fName);		}		return $query;	}	/**	 * Get the SQL syntax for a single column that would be included in a table create statement.	 *	 * @param   SimpleXMLElement  $field  The XML field definition.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getColumnSQL(SimpleXMLElement $field)	{		// TODO Incorporate into parent class and use $this.		$blobs = array('text', 'smalltext', 'mediumtext', 'largetext');		$fName = (string) $field['Field'];		$fType = (string) $field['Type'];		$fNull = (string) $field['Null'];		$fDefault = (isset($field['Default']) && $field['Default'] != 'NULL' ) ?						preg_match('/^[0-9]$/', $field['Default']) ? $field['Default'] : $this->db->quote((string) $field['Default'])					: null;		/* nextval() as default value means that type field is serial */		if (strpos($fDefault, 'nextval') !== false)		{			$query = $this->db->quoteName($fName) . ' SERIAL';		}		else		{			$query = $this->db->quoteName($fName) . ' ' . $fType;			if ($fNull == 'NO')			{				if (in_array($fType, $blobs) || $fDefault === null)				{					$query .= ' NOT NULL';				}				else				{					$query .= ' NOT NULL DEFAULT ' . $fDefault;				}			}			else			{				if ($fDefault !== null)				{					$query .= ' DEFAULT ' . $fDefault;				}			}		}		return $query;	}	/**	 * Get the SQL syntax to drop a column.	 *	 * @param   string  $table  The table name.	 * @param   string  $name   The name of the field to drop.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getDropColumnSQL($table, $name)	{		$query = 'ALTER TABLE ' . $this->db->quoteName($table) . ' DROP COLUMN ' . $this->db->quoteName($name);		return $query;	}	/**	 * Get the SQL syntax to drop an index.	 *	 * @param   string  $name  The name of the key to drop.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getDropIndexSQL($name)	{		$query = 'DROP INDEX ' . $this->db->quoteName($name);		return $query;	}	/**	 * Get the SQL syntax to drop a key.	 *	 * @param   string  $table  The table name.	 * @param   string  $name   The constraint name.	 *	 * @return  string	 *	 * @since   12.1	 */	protected function getDropPrimaryKeySQL($table, $name)	{		$query = 'ALTER TABLE ONLY ' . $this->db->quoteName($table) . ' DROP CONSTRAINT ' . $this->db->quoteName($name);		return $query;	}	/**	 * Get the details list of keys for a table.	 *	 * @param   array  $keys  An array of objects that comprise the keys for the table.	 *	 * @return  array  The lookup array. array({key name} => array(object, ...))	 *	 * @since   12.1	 * @throws  Exception	 */	protected function getIdxLookup($keys)	{		// First pass, create a lookup of the keys.		$lookup = array();		foreach ($keys as $key)		{			if ($key instanceof SimpleXMLElement)			{				$kName = (string) $key['Index'];			}			else			{				$kName = $key->Index;			}			if (empty($lookup[$kName]))			{				$lookup[$kName] = array();			}			$lookup[$kName][] = $key;		}		return $lookup;	}	/**	 * Get the details list of sequences for a table.	 *	 * @param   array  $sequences  An array of objects that comprise the sequences for the table.	 *	 * @return  array  The lookup array. array({key name} => array(object, ...))	 *	 * @since   12.1	 * @throws  Exception	 */	protected function getSeqLookup($sequences)	{		// First pass, create a lookup of the keys.		$lookup = array();		foreach ($sequences as $seq)		{			if ($seq instanceof SimpleXMLElement)			{				$sName = (string) $seq['Name'];			}			else			{				$sName = $seq->Name;			}			if (empty($lookup[$sName]))			{				$lookup[$sName] = array();			}			$lookup[$sName][] = $seq;		}		return $lookup;	}	/**	 * Get the real name of the table, converting the prefix wildcard string if present.	 *	 * @param   string  $table  The name of the table.	 *	 * @return  string	The real name of the table.	 *	 * @since   12.1	 */	protected function getRealTableName($table)	{		// TODO Incorporate into parent class and use $this.		$prefix = $this->db->getPrefix();		// Replace the magic prefix if found.		$table = preg_replace('|^#__|', $prefix, $table);		return $table;	}	/**	 * Merges the incoming structure definition with the existing structure.	 *	 * @return  void	 *	 * @note    Currently only supports XML format.	 * @since   12.1	 * @throws  Exception on error.	 * @todo    If it's not XML convert to XML first.	 */	protected function mergeStructure()	{		$prefix = $this->db->getPrefix();		$tables = $this->db->getTableList();		if ($this->from instanceof SimpleXMLElement)		{			$xml = $this->from;		}		else		{			$xml = new SimpleXMLElement($this->from);		}		// Get all the table definitions.		$xmlTables = $xml->xpath('database/table_structure');		foreach ($xmlTables as $table)		{			// Convert the magic prefix into the real table name.			$tableName = (string) $table['name'];			$tableName = preg_replace('|^#__|', $prefix, $tableName);			if (in_array($tableName, $tables))			{				// The table already exists. Now check if there is any difference.				if ($queries = $this->getAlterTableSQL($xml->database->table_structure))				{					// Run the queries to upgrade the data structure.					foreach ($queries as $query)					{						$this->db->setQuery($query);						try						{							$this->db->execute();						}						catch (RuntimeException $e)						{							$this->addLog('Fail: ' . $this->db->getQuery());							throw $e;						}						$this->addLog('Pass: ' . $this->db->getQuery());					}				}			}			else			{				// This is a new table.				$query = $this->xmlToCreate($table);				$this->db->setQuery($query);				try				{					$this->db->execute();				}				catch (RuntimeException $e)				{					$this->addLog('Fail: ' . $this->db->getQuery());					throw $e;				}				$this->addLog('Pass: ' . $this->db->getQuery());			}		}	}	/**	 * Sets the database connector to use for exporting structure and/or data from PostgreSQL.	 *	 * @param   JDatabaseDriverPostgresql  $db  The database connector.	 *	 * @return  JDatabaseImporterPostgresql  Method supports chaining.	 *	 * @since   12.1	 */	public function setDbo(JDatabaseDriverPostgresql $db)	{		$this->db = $db;		return $this;	}	/**	 * Sets an internal option to merge the structure based on the input data.	 *	 * @param   boolean  $setting  True to export the structure, false to not.	 *	 * @return  JDatabaseImporterPostgresql  Method supports chaining.	 *	 * @since   12.1	 */	public function withStructure($setting = true)	{		$this->options->withStructure = (boolean) $setting;		return $this;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Templates.protostar * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * This is a file to add template specific chrome to module rendering.  To use it you would * set the style attribute for the given module(s) include in your template to use the style * for each given modChrome function. * * eg.  To render a module mod_test in the submenu style, you would use the following include: * <jdoc:include type="module" name="test" style="submenu" /> * * This gives template designers ultimate control over how modules are rendered. * * NOTICE: All chrome wrapping methods should be named: modChrome_{STYLE} and take the same * two arguments. *//* * Module chrome for rendering the module in a submenu */function modChrome_no($module, &$params, &$attribs){	if ($module->content)	{		echo $module->content;	}}function modChrome_well($module, &$params, &$attribs){	if ($module->content)	{		echo "<div class=\"well " . htmlspecialchars($params->get('moduleclass_sfx')) . "\">";		if ($module->showtitle)		{			echo "<h3 class=\"page-header\">" . $module->title . "</h3>";		}		echo $module->content;		echo "</div>";	}}?>
<?php/** * @package     Joomla.Platform * @subpackage  Document * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * JDocument Module renderer * * @package     Joomla.Platform * @subpackage  Document * @since       11.1 */class JDocumentRendererModule extends JDocumentRenderer{	/**	 * Renders a module script and returns the results as a string	 *	 * @param   string  $module   The name of the module to render	 * @param   array   $attribs  Associative array of values	 * @param   string  $content  If present, module information from the buffer will be used	 *	 * @return  string  The output of the script	 *	 * @since   11.1	 */	public function render($module, $attribs = array(), $content = null)	{		if (!is_object($module))		{			$title = isset($attribs['title']) ? $attribs['title'] : null;			$module = JModuleHelper::getModule($module, $title);			if (!is_object($module))			{				if (is_null($content))				{					return '';				}				else				{					/**					 * If module isn't found in the database but data has been pushed in the buffer					 * we want to render it					 */					$tmp = $module;					$module = new stdClass;					$module->params = null;					$module->module = $tmp;					$module->id = 0;					$module->user = 0;				}			}		}		// Get the user and configuration object		// $user = JFactory::getUser();		$conf = JFactory::getConfig();		// Set the module content		if (!is_null($content))		{			$module->content = $content;		}		// Get module parameters		$params = new JRegistry;		$params->loadString($module->params);		// Use parameters from template		if (isset($attribs['params']))		{			$template_params = new JRegistry;			$template_params->loadString(html_entity_decode($attribs['params'], ENT_COMPAT, 'UTF-8'));			$params->merge($template_params);			$module = clone $module;			$module->params = (string) $params;		}		$contents = '';		// Default for compatibility purposes. Set cachemode parameter or use JModuleHelper::moduleCache from within the		// module instead		$cachemode = $params->get('cachemode', 'oldstatic');		if ($params->get('cache', 0) == 1 && $conf->get('caching') >= 1 && $cachemode != 'id' && $cachemode != 'safeuri')		{			// Default to itemid creating method and workarounds on			$cacheparams = new stdClass;			$cacheparams->cachemode = $cachemode;			$cacheparams->class = 'JModuleHelper';			$cacheparams->method = 'renderModule';			$cacheparams->methodparams = array($module, $attribs);			$contents = JModuleHelper::ModuleCache($module, $params, $cacheparams);		}		else		{			$contents = JModuleHelper::renderModule($module, $attribs);		}		return $contents;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Users component debugging helper. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersHelperDebug{	/**	 * Get a list of the components.	 *	 * @return  array	 * @since   1.6	 */	public static function getComponents()	{		// Initialise variable.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('name AS text, element AS value')			->from('#__extensions')			->where('enabled >= 1')			->where('type =' . $db->quote('component'));		$items = $db->setQuery($query)->loadObjectList();		if (count($items))		{			$lang = JFactory::getLanguage();			foreach ($items as &$item)			{				// Load language				$extension = $item->value;				$source = JPATH_ADMINISTRATOR . '/components/' . $extension;				$lang->load("$extension.sys", JPATH_ADMINISTRATOR, null, false, false)					|| $lang->load("$extension.sys", $source, null, false, false)					|| $lang->load("$extension.sys", JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)					|| $lang->load("$extension.sys", $source, $lang->getDefault(), false, false);				// Translate component name				$item->text = JText::_($item->text);			}			// Sort by component name			JArrayHelper::sortObjects($items, 'text', 1, true, $lang->getLocale());		}		return $items;	}	/**	 * Get a list of the actions for the component or code actions.	 *	 * @param   string    The name of the component.	 *	 * @return  array	 * @since   1.6	 */	public static function getDebugActions($component = null)	{		$actions = array();		// Try to get actions for the component		if (!empty($component))		{			$component_actions = JAccess::getActions($component);			if (!empty($component_actions))			{				foreach ($component_actions as &$action)				{					$actions[$action->title] = array($action->name, $action->description);				}			}		}		// Use default actions from configuration if no component selected or component doesn't have actions		if (empty($actions))		{			$filename = JPATH_ADMINISTRATOR . '/components/com_config/models/forms/application.xml';			if (is_file($filename))			{				$xml = simplexml_load_file($filename);				foreach ($xml->children()->fieldset as $fieldset)				{					if ('permissions' == (string) $fieldset['name'])					{						foreach ($fieldset->children() as $field)						{							if ('rules' == (string) $field['name'])							{								foreach ($field->children() as $action)								{									$actions[(string) $action['title']] = array(										(string) $action['name'],										(string) $action['description']									);								}								break;								break;								break;							}						}					}				}				// Load language				$lang = JFactory::getLanguage();				$extension = 'com_config';				$source = JPATH_ADMINISTRATOR . '/components/' . $extension;				$lang->load($extension, JPATH_ADMINISTRATOR, null, false, false)					|| $lang->load($extension, $source, null, false, false)					|| $lang->load($extension, JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)					|| $lang->load($extension, $source, $lang->getDefault(), false, false);			}		}		return $actions;	}	/**	 * Get a list of filter options for the levels.	 *	 * @return  array  An array of JHtmlOption elements.	 */	public static function getLevelsOptions()	{		// Build the filter options.		$options = array();		$options[] = JHtml::_('select.option', '1', JText::sprintf('COM_USERS_OPTION_LEVEL_COMPONENT', 1));		$options[] = JHtml::_('select.option', '2', JText::sprintf('COM_USERS_OPTION_LEVEL_CATEGORY', 2));		$options[] = JHtml::_('select.option', '3', JText::sprintf('COM_USERS_OPTION_LEVEL_DEEPER', 3));		$options[] = JHtml::_('select.option', '4', '4');		$options[] = JHtml::_('select.option', '5', '5');		$options[] = JHtml::_('select.option', '6', '6');		return $options;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Script file of Joomla CMS * * @package     Joomla.Administrator * @subpackage  com_admin * @since       1.6.4 */class JoomlaInstallerScript{	/**	 * Method to update Joomla!	 *	 * @param   JInstallerFile    $installer    The class calling this method	 *	 * @return void	 */	public function update($installer)	{		$this->deleteUnexistingFiles();		$this->updateManifestCaches();		$this->updateDatabase();	}	protected function updateDatabase()	{		$db = JFactory::getDbo();		if (substr($db->name, 0, 5) == 'mysql')		{			$query = 'SHOW ENGINES';			$db->setQuery($query);			$results = $db->loadObjectList();			if ($db->getErrorNum())			{				echo JText::sprintf('JLIB_DATABASE_ERROR_FUNCTION_FAILED', $db->getErrorNum(), $db->getErrorMsg()) . '<br />';				return;			}			foreach ($results as $result)			{				if ($result->Support == 'DEFAULT')				{					$query = 'ALTER TABLE #__update_sites_extensions ENGINE = ' . $result->Engine;					$db->setQuery($query);					$db->execute();					if ($db->getErrorNum())					{						echo JText::sprintf('JLIB_DATABASE_ERROR_FUNCTION_FAILED', $db->getErrorNum(), $db->getErrorMsg()) . '<br />';						return;					}					break;				}			}		}	}	protected function updateManifestCaches()	{		$extensions = array();		// Components		//`type`, `element`, `folder`, `client_id`		$extensions[] = array('component', 'com_mailto', '', 0);		$extensions[] = array('component', 'com_wrapper', '', 0);		$extensions[] = array('component', 'com_admin', '', 1);		$extensions[] = array('component', 'com_banners', '', 1);		$extensions[] = array('component', 'com_cache', '', 1);		$extensions[] = array('component', 'com_categories', '', 1);		$extensions[] = array('component', 'com_checkin', '', 1);		$extensions[] = array('component', 'com_contact', '', 1);		$extensions[] = array('component', 'com_cpanel', '', 1);		$extensions[] = array('component', 'com_installer', '', 1);		$extensions[] = array('component', 'com_languages', '', 1);		$extensions[] = array('component', 'com_login', '', 1);		$extensions[] = array('component', 'com_media', '', 1);		$extensions[] = array('component', 'com_menus', '', 1);		$extensions[] = array('component', 'com_messages', '', 1);		$extensions[] = array('component', 'com_modules', '', 1);		$extensions[] = array('component', 'com_newsfeeds', '', 1);		$extensions[] = array('component', 'com_plugins', '', 1);		$extensions[] = array('component', 'com_search', '', 1);		$extensions[] = array('component', 'com_templates', '', 1);		$extensions[] = array('component', 'com_weblinks', '', 1);		$extensions[] = array('component', 'com_content', '', 1);		$extensions[] = array('component', 'com_config', '', 1);		$extensions[] = array('component', 'com_redirect', '', 1);		$extensions[] = array('component', 'com_users', '', 1);		$extensions[] = array('component', 'com_tags', '', 1);		// Libraries		$extensions[] = array('library', 'phpmailer', '', 0);		$extensions[] = array('library', 'simplepie', '', 0);		$extensions[] = array('library', 'phputf8', '', 0);		$extensions[] = array('library', 'joomla', '', 0);		// Modules site		// Site		$extensions[] = array('module', 'mod_articles_archive', '', 0);		$extensions[] = array('module', 'mod_articles_latest', '', 0);		$extensions[] = array('module', 'mod_articles_popular', '', 0);		$extensions[] = array('module', 'mod_banners', '', 0);		$extensions[] = array('module', 'mod_breadcrumbs', '', 0);		$extensions[] = array('module', 'mod_custom', '', 0);		$extensions[] = array('module', 'mod_feed', '', 0);		$extensions[] = array('module', 'mod_footer', '', 0);		$extensions[] = array('module', 'mod_login', '', 0);		$extensions[] = array('module', 'mod_menu', '', 0);		$extensions[] = array('module', 'mod_articles_news', '', 0);		$extensions[] = array('module', 'mod_random_image', '', 0);		$extensions[] = array('module', 'mod_related_items', '', 0);		$extensions[] = array('module', 'mod_search', '', 0);		$extensions[] = array('module', 'mod_stats', '', 0);		$extensions[] = array('module', 'mod_syndicate', '', 0);		$extensions[] = array('module', 'mod_users_latest', '', 0);		$extensions[] = array('module', 'mod_weblinks', '', 0);		$extensions[] = array('module', 'mod_whosonline', '', 0);		$extensions[] = array('module', 'mod_wrapper', '', 0);		$extensions[] = array('module', 'mod_articles_category', '', 0);		$extensions[] = array('module', 'mod_articles_categories', '', 0);		$extensions[] = array('module', 'mod_languages', '', 0);		$extensions[] = array('module', 'mod_tags_popular', '', 0);		$extensions[] = array('module', 'mod_tags_similar', '', 0);		// Administrator		$extensions[] = array('module', 'mod_custom', '', 1);		$extensions[] = array('module', 'mod_feed', '', 1);		$extensions[] = array('module', 'mod_latest', '', 1);		$extensions[] = array('module', 'mod_logged', '', 1);		$extensions[] = array('module', 'mod_login', '', 1);		$extensions[] = array('module', 'mod_menu', '', 1);		$extensions[] = array('module', 'mod_popular', '', 1);		$extensions[] = array('module', 'mod_quickicon', '', 1);		$extensions[] = array('module', 'mod_stats_admin', '', 1);		$extensions[] = array('module', 'mod_status', '', 1);		$extensions[] = array('module', 'mod_submenu', '', 1);		$extensions[] = array('module', 'mod_title', '', 1);		$extensions[] = array('module', 'mod_toolbar', '', 1);		$extensions[] = array('module', 'mod_multilangstatus', '', 1);		// Plug-ins		$extensions[] = array('plugin', 'gmail', 'authentication', 0);		$extensions[] = array('plugin', 'joomla', 'authentication', 0);		$extensions[] = array('plugin', 'ldap', 'authentication', 0);		$extensions[] = array('plugin', 'emailcloak', 'content', 0);		$extensions[] = array('plugin', 'loadmodule', 'content', 0);		$extensions[] = array('plugin', 'pagebreak', 'content', 0);		$extensions[] = array('plugin', 'pagenavigation', 'content', 0);		$extensions[] = array('plugin', 'vote', 'content', 0);		$extensions[] = array('plugin', 'codemirror', 'editors', 0);		$extensions[] = array('plugin', 'none', 'editors', 0);		$extensions[] = array('plugin', 'tinymce', 'editors', 0);		$extensions[] = array('plugin', 'article', 'editors-xtd', 0);		$extensions[] = array('plugin', 'image', 'editors-xtd', 0);		$extensions[] = array('plugin', 'pagebreak', 'editors-xtd', 0);		$extensions[] = array('plugin', 'readmore', 'editors-xtd', 0);		$extensions[] = array('plugin', 'categories', 'search', 0);		$extensions[] = array('plugin', 'contacts', 'search', 0);		$extensions[] = array('plugin', 'content', 'search', 0);		$extensions[] = array('plugin', 'newsfeeds', 'search', 0);		$extensions[] = array('plugin', 'weblinks', 'search', 0);		$extensions[] = array('plugin', 'languagefilter', 'system', 0);		$extensions[] = array('plugin', 'p3p', 'system', 0);		$extensions[] = array('plugin', 'cache', 'system', 0);		$extensions[] = array('plugin', 'debug', 'system', 0);		$extensions[] = array('plugin', 'log', 'system', 0);		$extensions[] = array('plugin', 'redirect', 'system', 0);		$extensions[] = array('plugin', 'remember', 'system', 0);		$extensions[] = array('plugin', 'sef', 'system', 0);		$extensions[] = array('plugin', 'logout', 'system', 0);		$extensions[] = array('plugin', 'contactcreator', 'user', 0);		$extensions[] = array('plugin', 'joomla', 'user', 0);		$extensions[] = array('plugin', 'profile', 'user', 0);		$extensions[] = array('plugin', 'joomla', 'extension', 0);		$extensions[] = array('plugin', 'joomla', 'content', 0);		$extensions[] = array('plugin', 'languagecode', 'system', 0);		$extensions[] = array('plugin', 'joomlaupdate', 'quickicon', 0);		$extensions[] = array('plugin', 'extensionupdate', 'quickicon', 0);		$extensions[] = array('plugin', 'recaptcha', 'captcha', 0);		$extensions[] = array('plugin', 'categories', 'finder', 0);		$extensions[] = array('plugin', 'contacts', 'finder', 0);		$extensions[] = array('plugin', 'content', 'finder', 0);		$extensions[] = array('plugin', 'newsfeeds', 'finder', 0);		$extensions[] = array('plugin', 'weblinks', 'finder', 0);		$extensions[] = array('plugin', 'tags', 'finder', 0);		// Templates		$extensions[] = array('template', 'beez3', '', 0);		$extensions[] = array('template', 'hathor', '', 1);		$extensions[] = array('template', 'protostar', '', 0);		$extensions[] = array('template', 'isis', '', 1);		// Languages		$extensions[] = array('language', 'en-GB', '', 0);		$extensions[] = array('language', 'en-GB', '', 1);		// Files		$extensions[] = array('file', 'joomla', '', 0);		// Packages		// None in core at this time		// Attempt to refresh manifest caches		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('*')			->from('#__extensions');		foreach ($extensions as $extension)		{			$query->where('type=' . $db->quote($extension[0]) . ' AND element=' . $db->quote($extension[1]) . ' AND folder=' . $db->quote($extension[2]) . ' AND client_id=' . $extension[3], 'OR');		}		$db->setQuery($query);		$extensions = $db->loadObjectList();		$installer = new JInstaller;		// Check for a database error.		if ($db->getErrorNum())		{			echo JText::sprintf('JLIB_DATABASE_ERROR_FUNCTION_FAILED', $db->getErrorNum(), $db->getErrorMsg()) . '<br />';			return;		}		foreach ($extensions as $extension)		{			if (!$installer->refreshManifestCache($extension->extension_id))			{				echo JText::sprintf('FILES_JOOMLA_ERROR_MANIFEST', $extension->type, $extension->element, $extension->name, $extension->client_id) . '<br />';			}		}	}	public function deleteUnexistingFiles()	{		$files = array(			'/libraries/cms/cmsloader.php',			'/libraries/joomla/form/fields/templatestyle.php',			'/libraries/joomla/form/fields/user.php',			'/libraries/joomla/form/fields/menu.php',			'/libraries/joomla/form/fields/helpsite.php',			'/administrator/components/com_admin/sql/updates/mysql/1.7.0.sql',			'/administrator/components/com_admin/sql/updates/sqlsrv/2.5.2-2012-03-05.sql',			'/administrator/components/com_admin/sql/updates/sqlsrv/2.5.3-2012-03-13.sql',			'/administrator/components/com_admin/sql/updates/sqlsrv/index.html',			'/administrator/components/com_users/controllers/config.php',			'/administrator/language/en-GB/en-GB.plg_system_finder.ini',			'/administrator/language/en-GB/en-GB.plg_system_finder.sys.ini',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/advhr/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/advimage/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/advlink/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/advlist/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/autolink/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/autoresize/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/autosave/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/bbcode/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/contextmenu/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/directionality/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/emotions/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/fullpage/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/fullscreen/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/iespell/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/inlinepopups/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/insertdatetime/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/layer/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/lists/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/media/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/nonbreaking/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/noneditable/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/pagebreak/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/paste/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/preview/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/print/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/save/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/searchreplace/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/spellchecker/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/style/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/tabfocus/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/table/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/template/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/visualchars/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/wordcount/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/plugins/xhtmlxtras/editor_plugin_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/themes/advanced/editor_template_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/themes/simple/editor_template_src.js',			'/media/editors/tinymce/jscripts/tiny_mce/tiny_mce_src.js',			'/media/com_finder/images/calendar.png',			'/media/com_finder/images/mime/index.html',			'/media/com_finder/images/mime/pdf.png',			'/components/com_media/controller.php',			'/components/com_media/helpers/index.html',			'/components/com_media/helpers/media.php',			// Joomla 3.0			'/administrator/components/com_admin/sql/updates/mysql/1.7.0-2011-06-06-2.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.0-2011-06-06.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.0.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.1-2011-09-15-2.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.1-2011-09-15-3.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.1-2011-09-15-4.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.1-2011-09-15.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.1-2011-09-17.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.1-2011-09-20.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.3-2011-10-15.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.3-2011-10-19.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.3-2011-11-10.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.4-2011-11-19.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.4-2011-11-23.sql',			'/administrator/components/com_admin/sql/updates/mysql/1.7.4-2011-12-12.sql',			'/administrator/components/com_admin/views/sysinfo/tmpl/default_navigation.php',			'/administrator/components/com_categories/config.xml',			'/administrator/components/com_categories/helpers/categoriesadministrator.php',			'/administrator/components/com_contact/elements/contact.php',			'/administrator/components/com_contact/elements/index.html',			'/administrator/components/com_content/elements/article.php',			'/administrator/components/com_content/elements/author.php',			'/administrator/components/com_content/elements/index.html',			'/administrator/components/com_installer/models/fields/client.php',			'/administrator/components/com_installer/models/fields/group.php',			'/administrator/components/com_installer/models/fields/index.html',			'/administrator/components/com_installer/models/fields/search.php',			'/administrator/components/com_installer/models/fields/type.php',			'/administrator/components/com_installer/models/forms/index.html',			'/administrator/components/com_installer/models/forms/manage.xml',			'/administrator/components/com_installer/views/install/tmpl/default_form.php',			'/administrator/components/com_installer/views/manage/tmpl/default_filter.php',			'/administrator/components/com_languages/views/installed/tmpl/default_ftp.php',			'/administrator/components/com_languages/views/installed/tmpl/default_navigation.php',			'/administrator/components/com_modules/models/fields/index.html',			'/administrator/components/com_modules/models/fields/moduleorder.php',			'/administrator/components/com_modules/models/fields/moduleposition.php',			'/administrator/components/com_newsfeeds/elements/index.html',			'/administrator/components/com_newsfeeds/elements/newsfeed.php',			'/administrator/components/com_templates/views/prevuuw/index.html',			'/administrator/components/com_templates/views/prevuuw/tmpl/default.php',			'/administrator/components/com_templates/views/prevuuw/tmpl/index.html',			'/administrator/components/com_templates/views/prevuuw/view.html.php',			'/administrator/includes/menu.php',			'/administrator/includes/router.php',			'/administrator/manifests/packages/pkg_joomla.xml',			'/administrator/modules/mod_submenu/helper.php',			'/administrator/templates/hathor/css/ie6.css',			'/administrator/templates/hathor/html/mod_submenu/index.html',			'/administrator/templates/hathor/html/mod_submenu/default.php',			'/components/com_media/controller.php',			'/components/com_media/helpers/index.html',			'/components/com_media/helpers/media.php',			'/includes/menu.php',			'/includes/pathway.php',			'/includes/router.php',			'/language/en-GB/en-GB.pkg_joomla.sys.ini',			'/libraries/cms/controller/index.html',			'/libraries/cms/controller/legacy.php',			'/libraries/cms/model/index.html',			'/libraries/cms/model/legacy.php',			'/libraries/cms/schema/changeitemmysql.php',			'/libraries/cms/schema/changeitemsqlazure.php',			'/libraries/cms/schema/changeitemsqlsrv.php',			'/libraries/cms/view/index.html',			'/libraries/cms/view/legacy.php',			'/libraries/joomla/application/application.php',			'/libraries/joomla/application/categories.php',			'/libraries/joomla/application/cli/daemon.php',			'/libraries/joomla/application/cli/index.html',			'/libraries/joomla/application/component/controller.php',			'/libraries/joomla/application/component/controlleradmin.php',			'/libraries/joomla/application/component/controllerform.php',			'/libraries/joomla/application/component/helper.php',			'/libraries/joomla/application/component/index.html',			'/libraries/joomla/application/component/model.php',			'/libraries/joomla/application/component/modeladmin.php',			'/libraries/joomla/application/component/modelform.php',			'/libraries/joomla/application/component/modelitem.php',			'/libraries/joomla/application/component/modellist.php',			'/libraries/joomla/application/component/view.php',			'/libraries/joomla/application/helper.php',			'/libraries/joomla/application/input.php',			'/libraries/joomla/application/input/cli.php',			'/libraries/joomla/application/input/cookie.php',			'/libraries/joomla/application/input/files.php',			'/libraries/joomla/application/input/index.html',			'/libraries/joomla/application/menu.php',			'/libraries/joomla/application/module/helper.php',			'/libraries/joomla/application/module/index.html',			'/libraries/joomla/application/pathway.php',			'/libraries/joomla/application/web/webclient.php',			'/libraries/joomla/base/node.php',			'/libraries/joomla/base/object.php',			'/libraries/joomla/base/observable.php',			'/libraries/joomla/base/observer.php',			'/libraries/joomla/base/tree.php',			'/libraries/joomla/cache/storage/eaccelerator.php',			'/libraries/joomla/cache/storage/helpers/helper.php',			'/libraries/joomla/cache/storage/helpers/index.html',			'/libraries/joomla/database/database/index.html',			'/libraries/joomla/database/database/mysql.php',			'/libraries/joomla/database/database/mysqlexporter.php',			'/libraries/joomla/database/database/mysqli.php',			'/libraries/joomla/database/database/mysqliexporter.php',			'/libraries/joomla/database/database/mysqliimporter.php',			'/libraries/joomla/database/database/mysqlimporter.php',			'/libraries/joomla/database/database/mysqliquery.php',			'/libraries/joomla/database/database/mysqlquery.php',			'/libraries/joomla/database/database/sqlazure.php',			'/libraries/joomla/database/database/sqlazurequery.php',			'/libraries/joomla/database/database/sqlsrv.php',			'/libraries/joomla/database/database/sqlsrvquery.php',			'/libraries/joomla/database/exception.php',			'/libraries/joomla/database/table.php',			'/libraries/joomla/database/table/asset.php',			'/libraries/joomla/database/table/category.php',			'/libraries/joomla/database/table/content.php',			'/libraries/joomla/database/table/extension.php',			'/libraries/joomla/database/table/index.html',			'/libraries/joomla/database/table/language.php',			'/libraries/joomla/database/table/menu.php',			'/libraries/joomla/database/table/menutype.php',			'/libraries/joomla/database/table/module.php',			'/libraries/joomla/database/table/session.php',			'/libraries/joomla/database/table/update.php',			'/libraries/joomla/database/table/user.php',			'/libraries/joomla/database/table/usergroup.php',			'/libraries/joomla/database/table/viewlevel.php',			'/libraries/joomla/database/tablenested.php',			'/libraries/joomla/environment/request.php',			'/libraries/joomla/environment/uri.php',			'/libraries/joomla/error/error.php',			'/libraries/joomla/error/exception.php',			'/libraries/joomla/error/index.html',			'/libraries/joomla/error/log.php',			'/libraries/joomla/error/profiler.php',			'/libraries/joomla/filesystem/archive.php',			'/libraries/joomla/filesystem/archive/bzip2.php',			'/libraries/joomla/filesystem/archive/gzip.php',			'/libraries/joomla/filesystem/archive/index.html',			'/libraries/joomla/filesystem/archive/tar.php',			'/libraries/joomla/filesystem/archive/zip.php',			'/libraries/joomla/form/fields/category.php',			'/libraries/joomla/form/fields/componentlayout.php',			'/libraries/joomla/form/fields/contentlanguage.php',			'/libraries/joomla/form/fields/editor.php',			'/libraries/joomla/form/fields/editors.php',			'/libraries/joomla/form/fields/media.php',			'/libraries/joomla/form/fields/menuitem.php',			'/libraries/joomla/form/fields/modulelayout.php',			'/libraries/joomla/html/editor.php',			'/libraries/joomla/html/html/access.php',			'/libraries/joomla/html/html/batch.php',			'/libraries/joomla/html/html/behavior.php',			'/libraries/joomla/html/html/category.php',			'/libraries/joomla/html/html/content.php',			'/libraries/joomla/html/html/contentlanguage.php',			'/libraries/joomla/html/html/date.php',			'/libraries/joomla/html/html/email.php',			'/libraries/joomla/html/html/form.php',			'/libraries/joomla/html/html/grid.php',			'/libraries/joomla/html/html/image.php',			'/libraries/joomla/html/html/index.html',			'/libraries/joomla/html/html/jgrid.php',			'/libraries/joomla/html/html/list.php',			'/libraries/joomla/html/html/menu.php',			'/libraries/joomla/html/html/number.php',			'/libraries/joomla/html/html/rules.php',			'/libraries/joomla/html/html/select.php',			'/libraries/joomla/html/html/sliders.php',			'/libraries/joomla/html/html/string.php',			'/libraries/joomla/html/html/tabs.php',			'/libraries/joomla/html/html/tel.php',			'/libraries/joomla/html/html/user.php',			'/libraries/joomla/html/pagination.php',			'/libraries/joomla/html/pane.php',			'/libraries/joomla/html/parameter.php',			'/libraries/joomla/html/parameter/element.php',			'/libraries/joomla/html/parameter/element/calendar.php',			'/libraries/joomla/html/parameter/element/category.php',			'/libraries/joomla/html/parameter/element/componentlayouts.php',			'/libraries/joomla/html/parameter/element/contentlanguages.php',			'/libraries/joomla/html/parameter/element/editors.php',			'/libraries/joomla/html/parameter/element/filelist.php',			'/libraries/joomla/html/parameter/element/folderlist.php',			'/libraries/joomla/html/parameter/element/helpsites.php',			'/libraries/joomla/html/parameter/element/hidden.php',			'/libraries/joomla/html/parameter/element/imagelist.php',			'/libraries/joomla/html/parameter/element/index.html',			'/libraries/joomla/html/parameter/element/languages.php',			'/libraries/joomla/html/parameter/element/list.php',			'/libraries/joomla/html/parameter/element/menu.php',			'/libraries/joomla/html/parameter/element/menuitem.php',			'/libraries/joomla/html/parameter/element/modulelayouts.php',			'/libraries/joomla/html/parameter/element/password.php',			'/libraries/joomla/html/parameter/element/radio.php',			'/libraries/joomla/html/parameter/element/spacer.php',			'/libraries/joomla/html/parameter/element/sql.php',			'/libraries/joomla/html/parameter/element/templatestyle.php',			'/libraries/joomla/html/parameter/element/text.php',			'/libraries/joomla/html/parameter/element/textarea.php',			'/libraries/joomla/html/parameter/element/timezones.php',			'/libraries/joomla/html/parameter/element/usergroup.php',			'/libraries/joomla/html/parameter/index.html',			'/libraries/joomla/html/toolbar.php',			'/libraries/joomla/html/toolbar/button.php',			'/libraries/joomla/html/toolbar/button/confirm.php',			'/libraries/joomla/html/toolbar/button/custom.php',			'/libraries/joomla/html/toolbar/button/help.php',			'/libraries/joomla/html/toolbar/button/index.html',			'/libraries/joomla/html/toolbar/button/link.php',			'/libraries/joomla/html/toolbar/button/popup.php',			'/libraries/joomla/html/toolbar/button/separator.php',			'/libraries/joomla/html/toolbar/button/standard.php',			'/libraries/joomla/html/toolbar/index.html',			'/libraries/joomla/image/filters/brightness.php',			'/libraries/joomla/image/filters/contrast.php',			'/libraries/joomla/image/filters/edgedetect.php',			'/libraries/joomla/image/filters/emboss.php',			'/libraries/joomla/image/filters/grayscale.php',			'/libraries/joomla/image/filters/index.html',			'/libraries/joomla/image/filters/negate.php',			'/libraries/joomla/image/filters/sketchy.php',			'/libraries/joomla/image/filters/smooth.php',			'/libraries/joomla/language/help.php',			'/libraries/joomla/language/latin_transliterate.php',			'/libraries/joomla/log/logexception.php',			'/libraries/joomla/log/loggers/database.php',			'/libraries/joomla/log/loggers/echo.php',			'/libraries/joomla/log/loggers/formattedtext.php',			'/libraries/joomla/log/loggers/index.html',			'/libraries/joomla/log/loggers/messagequeue.php',			'/libraries/joomla/log/loggers/syslog.php',			'/libraries/joomla/log/loggers/w3c.php',			'/libraries/joomla/methods.php',			'/libraries/joomla/session/storage/eaccelerator.php',			'/libraries/joomla/string/stringnormalize.php',			'/libraries/joomla/utilities/date.php',			'/libraries/joomla/utilities/simplecrypt.php',			'/libraries/joomla/utilities/simplexml.php',			'/libraries/joomla/utilities/string.php',			'/libraries/joomla/utilities/xmlelement.php',			'/media/plg_quickicon_extensionupdate/extensionupdatecheck.js',			'/media/plg_quickicon_joomlaupdate/jupdatecheck.js',			// Joomla! 3.1			'/libraries/joomla/form/rules/boolean.php',			'/libraries/joomla/form/rules/color.php',			'/libraries/joomla/form/rules/email.php',			'/libraries/joomla/form/rules/equals.php',			'/libraries/joomla/form/rules/index.html',			'/libraries/joomla/form/rules/options.php',			'/libraries/joomla/form/rules/rules.php',			'/libraries/joomla/form/rules/tel.php',			'/libraries/joomla/form/rules/url.php',			'/libraries/joomla/form/rules/username.php',			'/libraries/joomla/installer/adapters/component.php',			'/libraries/joomla/installer/adapters/file.php',			'/libraries/joomla/installer/adapters/index.html',			'/libraries/joomla/installer/adapters/language.php',			'/libraries/joomla/installer/adapters/library.php',			'/libraries/joomla/installer/adapters/module.php',			'/libraries/joomla/installer/adapters/package.php',			'/libraries/joomla/installer/adapters/plugin.php',			'/libraries/joomla/installer/adapters/template.php',			'/libraries/joomla/installer/extension.php',			'/libraries/joomla/installer/helper.php',			'/libraries/joomla/installer/index.html',			'/libraries/joomla/installer/librarymanifest.php',			'/libraries/joomla/installer/packagemanifest.php',			'/media/system/css/mooRainbow.css',			'/media/system/js/mooRainbow-uncompressed.js',			'/media/system/js/mooRainbow.js',			'/media/system/js/swf-uncompressed.js',			'/media/system/js/swf.js',			'/media/system/js/uploader-uncompressed.js',			'/media/system/js/uploader.js',			'/media/system/swf/index.html',			'/media/system/swf/uploader.swf',		);		// TODO There is an issue while deleting folders using the ftp mode		$folders = array(			'/administrator/components/com_admin/sql/updates/sqlsrv',			'/media/com_finder/images/mime',			'/media/com_finder/images',			'/components/com_media/helpers',			// Joomla 3.0			'/administrator/components/com_contact/elements',			'/administrator/components/com_content/elements',			'/administrator/components/com_installer/models/fields',			'/administrator/components/com_installer/models/forms',			'/administrator/components/com_modules/models/fields',			'/administrator/components/com_newsfeeds/elements',			'/administrator/components/com_templates/views/prevuuw/tmpl',			'/administrator/components/com_templates/views/prevuuw',			'/libraries/cms/controller',			'/libraries/cms/model',			'/libraries/cms/view',			'/libraries/joomla/application/cli',			'/libraries/joomla/application/component',			'/libraries/joomla/application/input',			'/libraries/joomla/application/module',			'/libraries/joomla/cache/storage/helpers',			'/libraries/joomla/database/table',			'/libraries/joomla/database/database',			'/libraries/joomla/error',			'/libraries/joomla/filesystem/archive',			'/libraries/joomla/html/html',			'/libraries/joomla/html/toolbar',			'/libraries/joomla/html/toolbar/button',			'/libraries/joomla/html/parameter',			'/libraries/joomla/html/parameter/element',			'/libraries/joomla/image/filters',			'/libraries/joomla/log/loggers',			// Joomla! 3.1			'/libraries/joomla/form/rules',			'/libraries/joomla/installer/adapters',			'/libraries/joomla/installer',			'/media/system/swf/',		);		jimport('joomla.filesystem.file');		foreach ($files as $file)		{			if (JFile::exists(JPATH_ROOT . $file) && !JFile::delete(JPATH_ROOT . $file))			{				echo JText::sprintf('FILES_JOOMLA_ERROR_FILE_FOLDER', $file) . '<br />';			}		}		jimport('joomla.filesystem.folder');		foreach ($folders as $folder)		{			if (JFolder::exists(JPATH_ROOT . $folder) && !JFolder::delete(JPATH_ROOT . $folder))			{				echo JText::sprintf('FILES_JOOMLA_ERROR_FILE_FOLDER', $folder) . '<br />';			}		}	}}
<?php/** * @package     Joomla.Platform * @subpackage  Facebook * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Facebook API Album class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Facebook * * @see         http://developers.facebook.com/docs/reference/api/album/ * @since       13.1 */class JFacebookAlbum extends JFacebookObject{	/**	 * Method to get an album. Requires authentication and user_photos or friends_photos permission for private photos.	 *	 * @param   string  $album  The album id.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getAlbum($album)	{		return $this->get($album);	}	/**	 * Method to get the photos contained in this album. Requires authentication and user_photos or friends_photos permission for private photos.	 *	 * @param   string   $album   The album id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getPhotos($album, $limit = 0, $offset = 0, $until = null, $since = null)	{		return $this->getConnection($album, 'photos', '', $limit, $offset, $until, $since);	}	/**	 * Method to add photos to an album. Note: check can_upload flag first. Requires authentication and publish_stream  permission.	 *	 * @param   string  $album    The album id.	 * @param   string  $source   Path to photo.	 * @param   string  $message  Photo description.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createPhoto($album, $source, $message = null)	{		// Set POST request parameters.		$data = array();		$data[basename($source)] = '@' . realpath($source);		if ($message)		{			$data['message'] = $message;		}		return $this->createConnection($album, 'photos', $data, array('Content-Type' => 'multipart/form-data'));	}	/**	 * Method to get an album's comments. Requires authentication and user_photos or friends_photos permission for private photos.	 *	 * @param   string   $album   The album id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getComments($album, $limit = 0, $offset = 0, $until = null, $since = null)	{		return $this->getConnection($album, 'comments', '', $limit, $offset, $until, $since);	}	/**	 * Method to comment on an album. Requires authentication and publish_stream  permission.	 *	 * @param   string  $album    The album id.	 * @param   string  $message  The comment's text.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createComment($album, $message)	{		// Set POST request parameters.		$data = array();		$data['message'] = $message;		return $this->createConnection($album, 'comments', $data);	}	/**	 * Method to delete a comment. Requires authentication and publish_stream  permission.	 *	 * @param   string  $comment  The comment's id.	 *	 * @return  boolean Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteComment($comment)	{		return $this->deleteConnection($comment);	}	/**	 * Method to get album's likes. Requires authentication and user_photos or friends_photos permission for private photos.	 *	 * @param   string   $album   The album id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getLikes($album, $limit = 0, $offset = 0, $until = null, $since = null)	{		return $this->getConnection($album, 'likes', '', $limit, $offset, $until, $since);	}	/**	 * Method to like an album. Requires authentication and publish_stream  permission.	 *	 * @param   string  $album  The album id.	 *	 * @return  boolean Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function createLike($album)	{		return $this->createConnection($album, 'likes');	}	/**	 * Method to unlike an album. Requires authentication and publish_stream  permission.	 *	 * @param   string  $album  The album id.	 *	 * @return  boolean Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteLike($album)	{		return $this->deleteConnection($album, 'likes');	}	/**	 * Method to get the album's cover photo, the first picture uploaded to an album becomes the cover photo for the album.	 * Requires authentication and user_photos or friends_photos permission for private photos.	 *	 * @param   string   $album     The album id.	 * @param   boolean  $redirect  If false this will return the URL of the picture without a 302 redirect.	 *	 * @return  string  URL of the picture.	 *	 * @since   13.1	 */	public function getPicture($album, $redirect = true)	{		$extra_fields = '';		if ($redirect == false)		{			$extra_fields = '?redirect=false';		}		return $this->getConnection($album, 'picture', $extra_fields);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');$app = JFactory::getApplication();$input = $app->input;$assoc = isset($app->item_associations) ? $app->item_associations : 0;?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'contact.cancel' || document.formvalidator.isValid(document.id('contact-form')))		{			<?php echo $this->form->getField('misc')->save(); ?>			Joomla.submitform(task, document.getElementById('contact-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_contact&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="contact-form" class="form-validate">	<div class="col main-section">		<fieldset class="adminform">			<legend><?php echo empty($this->item->id) ? JText::_('COM_CONTACT_NEW_CONTACT') : JText::sprintf('COM_CONTACT_EDIT_CONTACT', $this->item->id); ?></legend>			<ul class="adminformlist">				<li><?php echo $this->form->getLabel('name'); ?>				<?php echo $this->form->getInput('name'); ?></li>				<li><?php echo $this->form->getLabel('alias'); ?>				<?php echo $this->form->getInput('alias'); ?></li>				<li><?php echo $this->form->getLabel('user_id'); ?>				<?php echo $this->form->getInput('user_id'); ?></li>				<li><?php echo $this->form->getLabel('catid'); ?>				<?php echo $this->form->getInput('catid'); ?></li>				<li><?php echo $this->form->getLabel('published'); ?>				<?php echo $this->form->getInput('published'); ?></li>				<li><?php echo $this->form->getLabel('access'); ?>				<?php echo $this->form->getInput('access'); ?></li>				<li><?php echo $this->form->getLabel('ordering'); ?>				<?php echo $this->form->getInput('ordering'); ?></li>				<li><?php echo $this->form->getLabel('featured'); ?>				<?php echo $this->form->getInput('featured'); ?></li>				<li><?php echo $this->form->getLabel('language'); ?>				<?php echo $this->form->getInput('language'); ?></li>				<!-- Tag field -->				<?php foreach ($this->get('form')->getFieldset('jmetadata') as $field) : ?>					<?php if ($field->name == 'jform[metadata][tags][]') :?>						<li>							<?php echo $field->label; ?>							<?php echo $field->input; ?>						</li>					<?php endif; ?>				<?php endforeach; ?>				<li><?php echo $this->form->getLabel('id'); ?>				<?php echo $this->form->getInput('id'); ?></li>			</ul>			<div class="clr"></div>			<?php echo $this->form->getLabel('misc'); ?>			<div class="clr"></div>			<?php echo $this->form->getInput('misc'); ?>		</fieldset>	</div>    <div class="col options-section">		<?php echo  JHtml::_('sliders.start', 'contact-slider'); ?>			<?php echo JHtml::_('sliders.panel', JText::_('JGLOBAL_FIELDSET_PUBLISHING'), 'publishing-details'); ?>			<fieldset class="panelform">			<legend class="element-invisible"><?php echo JText::_('JGLOBAL_FIELDSET_PUBLISHING'); ?></legend>				<ul class="adminformlist">					<li><?php echo $this->form->getLabel('created_by'); ?>					<?php echo $this->form->getInput('created_by'); ?></li>					<li><?php echo $this->form->getLabel('created_by_alias'); ?>					<?php echo $this->form->getInput('created_by_alias'); ?></li>					<li><?php echo $this->form->getLabel('created'); ?>					<?php echo $this->form->getInput('created'); ?></li>					<li><?php echo $this->form->getLabel('publish_up'); ?>					<?php echo $this->form->getInput('publish_up'); ?></li>					<li><?php echo $this->form->getLabel('publish_down'); ?>					<?php echo $this->form->getInput('publish_down'); ?></li>					<?php if ($this->item->modified_by) : ?>						<li><?php echo $this->form->getLabel('modified_by'); ?>						<?php echo $this->form->getInput('modified_by'); ?></li>						<li><?php echo $this->form->getLabel('modified'); ?>						<?php echo $this->form->getInput('modified'); ?></li>					<?php endif; ?>				</ul>			</fieldset>			<?php echo JHtml::_('sliders.panel', JText::_('COM_CONTACT_CONTACT_DETAILS'), 'basic-options'); ?>			<fieldset class="panelform">			<legend class="element-invisible"><?php echo JText::_('COM_CONTACT_CONTACT_DETAILS'); ?></legend>				<p><?php echo empty($this->item->id) ? JText::_('COM_CONTACT_DETAILS') : JText::sprintf('COM_CONTACT_EDIT_DETAILS', $this->item->id); ?></p>				<ul class="adminformlist">					<li><?php echo $this->form->getLabel('image'); ?>					<?php echo $this->form->getInput('image'); ?></li>					<li><?php echo $this->form->getLabel('con_position'); ?>					<?php echo $this->form->getInput('con_position'); ?></li>					<li><?php echo $this->form->getLabel('email_to'); ?>					<?php echo $this->form->getInput('email_to'); ?></li>					<li><?php echo $this->form->getLabel('address'); ?>					<?php echo $this->form->getInput('address'); ?></li>					<li><?php echo $this->form->getLabel('suburb'); ?>					<?php echo $this->form->getInput('suburb'); ?></li>					<li><?php echo $this->form->getLabel('state'); ?>					<?php echo $this->form->getInput('state'); ?></li>					<li><?php echo $this->form->getLabel('postcode'); ?>					<?php echo $this->form->getInput('postcode'); ?></li>					<li><?php echo $this->form->getLabel('country'); ?>					<?php echo $this->form->getInput('country'); ?></li>					<li><?php echo $this->form->getLabel('telephone'); ?>					<?php echo $this->form->getInput('telephone'); ?></li>					<li><?php echo $this->form->getLabel('mobile'); ?>					<?php echo $this->form->getInput('mobile'); ?></li>					<li><?php echo $this->form->getLabel('fax'); ?>					<?php echo $this->form->getInput('fax'); ?></li>					<li><?php echo $this->form->getLabel('webpage'); ?>					<?php echo $this->form->getInput('webpage'); ?></li>					<li><?php echo $this->form->getLabel('sortname1'); ?>					<?php echo $this->form->getInput('sortname1'); ?></li>					<li><?php echo $this->form->getLabel('sortname2'); ?>					<?php echo $this->form->getInput('sortname2'); ?></li>					<li><?php echo $this->form->getLabel('sortname3'); ?>					<?php echo $this->form->getInput('sortname3'); ?></li>				</ul>			</fieldset>			<?php echo $this->loadTemplate('params'); ?>			<?php echo JHtml::_('sliders.panel', JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS'), 'meta-options'); ?>			<fieldset class="panelform">			<legend class="element-invisible"><?php echo JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS'); ?></legend>				<?php echo $this->loadTemplate('metadata'); ?>			</fieldset>			<?php if ($assoc) : ?>				<?php echo $this->loadTemplate('associations'); ?>			<?php endif; ?>		<?php echo JHtml::_('sliders.end'); ?>		<input type="hidden" name="task" value="" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User notes model class. * * @package     Joomla.Administrator * @subpackage  com_users * @since       2.5 */class UsersModelNotes extends JModelList{	/**	 * Class constructor.	 *	 * @param  array  $config  An optional associative array of configuration settings.	 *	 * @since  2.5	 */	public function __construct($config = array())	{		// Set the list ordering fields.		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id',				'a.id',				'user_id',				'a.user_id',				'u.name',				'subject',				'a.subject',				'catid',				'a.catid',				'state', 'a.state',				'c.title',				'review_time',				'a.review_time',				'publish_up', 'a.publish_up',				'publish_down', 'a.publish_down',			);		}		parent::__construct($config);	}	/**	 * Build an SQL query to load the list data.	 *	 * @return  JDatabaseQuery  A JDatabaseQuery object to retrieve the data set.	 *	 * @since   2.5	 */	protected function getListQuery()	{		$db = $this->getDbo();		$query = $db->getQuery(true);		$section = $this->getState('filter.category_id');		// Select the required fields from the table.		$query->select(			$this->getState('list.select',				'a.id, a.subject, a.checked_out, a.checked_out_time,' .				'a.catid, a.created_time, a.review_time,' .				'a.state, a.publish_up, a.publish_down'			)		);		$query->from('#__user_notes AS a');		// Join over the category		$query->select('c.title AS category_title, c.params AS category_params')			->join('LEFT', '#__categories AS c ON c.id = a.catid');		// Join over the users for the note user.		$query->select('u.name AS user_name')			->join('LEFT', '#__users AS u ON u.id = a.user_id');		// Join over the users for the checked out user.		$query->select('uc.name AS editor')			->join('LEFT', '#__users AS uc ON uc.id = a.checked_out');		// Filter by search in title		$search = $this->getState('filter.search');		if (!empty($search))		{			if (stripos($search, 'id:') === 0)			{				$query->where('a.id = ' . (int) substr($search, 3));			}			elseif (stripos($search, 'uid:') === 0)			{				$query->where('a.user_id = ' . (int) substr($search, 4));			}			else			{				$search = $db->quote('%' . $db->escape($search, true) . '%');				$query->where('((a.subject LIKE ' . $search . ') OR (u.name LIKE ' . $search . ') OR (u.username LIKE ' . $search . '))');			}		}		// Filter by published state		$published = $this->getState('filter.state');		if (is_numeric($published))		{			$query->where('a.state = '.(int) $published);		} elseif ($published === '')		{			$query->where('(a.state IN (0, 1))');		}		// Filter by a single or group of categories.		$categoryId = (int) $this->getState('filter.category_id');		if ($categoryId)		{			if (is_scalar($section))			{				$query->where('a.catid = ' . $categoryId);			}		}		// Filter by a single user.		$userId = (int) $this->getState('filter.user_id');		if ($userId)		{			// Add the body and where filter.			$query->select('a.body')				->where('a.user_id = ' . $userId);		}		// Add the list ordering clause.		$orderCol = $this->state->get('list.ordering');		$orderDirn = $this->state->get('list.direction');		$query->order($db->escape($orderCol . ' ' . $orderDirn));		return $query;	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id  A prefix for the store id.	 *	 * @return  string  A store id.	 *	 * @since   2.5	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.state');		$id .= ':' . $this->getState('filter.category_id');		return parent::getStoreId($id);	}	/**	 * Gets a user object if the user filter is set.	 *	 * @return  JUser  The JUser object	 *	 * @since   2.5	 */	public function getUser()	{		$user = new JUser;		// Filter by search in title		$search = JFactory::getApplication()->input->get('u_id', 0, 'int');		if ($search != 0)		{			$user->load((int) $search);		}		return $user;	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication();		$input = $app->input;		// Adjust the context to support modal layouts.		if ($layout = $input->get('layout'))		{			$this->context .= '.' . $layout;		}		$value = $app->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $value);		$published = $this->getUserStateFromRequest($this->context.'.filter.state', 'filter_published', '', 'string');		$this->setState('filter.state', $published);		$section = $app->getUserStateFromRequest($this->context . '.filter.category_id', 'filter_category_id');		$this->setState('filter.category_id', $section);		$userId = $input->get('u_id', 0, 'int');		$this->setState('filter.user_id', $userId);		parent::populateState('a.review_time', 'DESC');	}}
<?php/** * @package     Joomla.Libraries * @subpackage  helper * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Utitlity class for associations in multilang * * @package     Joomla.Libraries * @subpackage  Language * @since       3.1 */class JLanguageAssociations{	/**	 * Get the associations.	 *	 * @param   string   $extension   The name of the component.	 * @param   string   $tablename   The name of the table.	 * @param   string   $context     The context	 * @param   integer  $id          The primary key value.	 * @param   string   $pk          The name of the primary key in the given $table.	 * @param   string   $aliasField  If the table has an alias field set it here. Null to not use it	 * @param   string   $catField    If the table has a catid field set it here. Null to not use it	 *	 * @return  array                The associated items	 *	 * @since   3.1	 */	public static function getAssociations($extension, $tablename, $context, $id, $pk = 'id', $aliasField = 'alias', $catField = 'catid')	{		$associations = array();		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select($db->quoteName('c2.language'))			->from($db->quoteName($tablename, 'c'))			->join('INNER', $db->quoteName('#__associations', 'a') . ' ON a.id = c.id AND a.context=' . $db->quote($context))			->join('INNER', $db->quoteName('#__associations', 'a2') . ' ON a.key = a2.key')			->join('INNER', $db->quoteName($tablename, 'c2') . ' ON a2.id = c2.' . $db->quoteName($pk));		// Use alias field ?		if (!empty($aliasField))		{			$query->select(				$query->concatenate(					array(						$db->quoteName('c2.' . $pk),						$db->quoteName('c2.' . $aliasField)					),					':'				) . ' AS ' . $db->quoteName($pk)			);		}		else		{			$query->select($db->quoteName('c2.' . $pk));		}		// Use catid field ?		if (!empty($catField))		{			$query->join('INNER', $db->quoteName('#__categories', 'ca') . ' ON ' . $db->quoteName('c2.' . $catField) . ' = ca.id AND ca.extension = ' . $db->quote($extension))				->select(					$query->concatenate(						array('ca.id', 'ca.alias'),						':'					) . ' AS ' . $db->quoteName($catField)				);		}		$query->where('c.id =' . (int) $id);		$db->setQuery($query);		try		{			$items = $db->loadObjectList('language');		}		catch (runtimeException $e)		{			throw new Exception($e->getMessage(), 500);			return false;		}		if ($items)		{			foreach ($items as $tag => $item)			{				$associations[$tag] = $item;			}		}		return $associations;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_media * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;jimport('joomla.filesystem.file');jimport('joomla.filesystem.folder');/** * Media File Controller * * @package     Joomla.Administrator * @subpackage  com_media * @since       1.5 */class MediaControllerFile extends JControllerLegacy{	/**	 * The folder we are uploading into	 *	 * @var   string	 */	protected $folder = '';	/**	 * Upload one or more files	 *	 * @return  boolean	 *	 * @since   1.5	 */	public function upload()	{		// Check for request forgeries		JSession::checkToken('request') or jexit(JText::_('JINVALID_TOKEN'));		$params = JComponentHelper::getParams('com_media');		// Get some data from the request		$files        = $this->input->files->get('Filedata', '', 'array');		$return       = $this->input->post->get('return-url', null, 'base64');		$this->folder = $this->input->get('folder', '', 'path');		// Set the redirect		if ($return)		{			$this->setRedirect(base64_decode($return) . '&folder=' . $this->folder);		}		// Authorize the user		if (!$this->authoriseUser('create'))		{			return false;		}		if (			$_SERVER['CONTENT_LENGTH'] > ($params->get('upload_maxsize', 0) * 1024 * 1024) ||			$_SERVER['CONTENT_LENGTH'] > (int) (ini_get('upload_max_filesize')) * 1024 * 1024 ||			$_SERVER['CONTENT_LENGTH'] > (int) (ini_get('post_max_size')) * 1024 * 1024 ||			(($_SERVER['CONTENT_LENGTH'] > (int) (ini_get('memory_limit')) * 1024 * 1024) && ((int) (ini_get('memory_limit')) != -1))		)		{			JError::raiseWarning(100, JText::_('COM_MEDIA_ERROR_WARNFILETOOLARGE'));			return false;		}		// Perform basic checks on file info before attempting anything		foreach ($files as &$file)		{			$file['name']     = JFile::makeSafe($file['name']);			$file['filepath'] = JPath::clean(implode(DIRECTORY_SEPARATOR, array(COM_MEDIA_BASE, $this->folder, $file['name'])));			if ($file['error'] == 1)			{				JError::raiseWarning(100, JText::_('COM_MEDIA_ERROR_WARNFILETOOLARGE'));				return false;			}			if ($file['size'] > ($params->get('upload_maxsize', 0) * 1024 * 1024))			{				JError::raiseNotice(100, JText::_('COM_MEDIA_ERROR_WARNFILETOOLARGE'));				return false;			}			if (JFile::exists($file['filepath']))			{				// A file with this name already exists				JError::raiseWarning(100, JText::_('COM_MEDIA_ERROR_FILE_EXISTS'));				return false;			}			if (!isset($file['name']))			{				// No filename (after the name was cleaned by JFile::makeSafe)				$this->setRedirect('index.php', JText::_('COM_MEDIA_INVALID_REQUEST'), 'error');				return false;			}		}		// Set FTP credentials, if given		JClientHelper::setCredentialsFromRequest('ftp');		JPluginHelper::importPlugin('content');		$dispatcher	= JEventDispatcher::getInstance();		foreach ($files as &$file)		{			// The request is valid			$err = null;			if (!MediaHelper::canUpload($file, $err))			{				// The file can't be upload				JError::raiseNotice(100, JText::_($err));				return false;			}			// Trigger the onContentBeforeSave event.			$object_file = new JObject($file);			$result = $dispatcher->trigger('onContentBeforeSave', array('com_media.file', &$object_file));			if (in_array(false, $result, true))			{				// There are some errors in the plugins				JError::raiseWarning(100, JText::plural('COM_MEDIA_ERROR_BEFORE_SAVE', count($errors = $object_file->getErrors()), implode('<br />', $errors)));				return false;			}			if (!JFile::upload($object_file->tmp_name, $object_file->filepath))			{				// Error in upload				JError::raiseWarning(100, JText::_('COM_MEDIA_ERROR_UNABLE_TO_UPLOAD_FILE'));				return false;			}			else			{				// Trigger the onContentAfterSave event.				$dispatcher->trigger('onContentAfterSave', array('com_media.file', &$object_file, true));				$this->setMessage(JText::sprintf('COM_MEDIA_UPLOAD_COMPLETE', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));			}		}		return true;	}	/**	 * Check that the user is authorized to perform this action	 *	 * @param   string   $action - the action to be peformed (create or delete)	 *	 * @return  boolean	 *	 * @since   1.6	 */	protected function authoriseUser($action)	{		if (!JFactory::getUser()->authorise('core.' . strtolower($action), 'com_media'))		{			// User is not authorised			JError::raiseWarning(403, JText::_('JLIB_APPLICATION_ERROR_' . strtoupper($action) . '_NOT_PERMITTED'));			return false;		}		return true;	}	/**	 * Deletes paths from the current path	 *	 * @return  boolean	 *	 * @since   1.5	 */	public function delete()	{		JSession::checkToken('request') or jexit(JText::_('JINVALID_TOKEN'));		// Get some data from the request		$tmpl	= $this->input->get('tmpl');		$paths	= $this->input->get('rm', array(), 'array');		$folder = $this->input->get('folder', '', 'path');		$redirect = 'index.php?option=com_media&folder=' . $folder;		if ($tmpl == 'component')		{			// We are inside the iframe			$redirect .= '&view=mediaList&tmpl=component';		}		$this->setRedirect($redirect);		// Nothing to delete		if (empty($paths))		{			return true;		}		// Authorize the user		if (!$this->authoriseUser('delete'))		{			return false;		}		// Set FTP credentials, if given		JClientHelper::setCredentialsFromRequest('ftp');		JPluginHelper::importPlugin('content');		$dispatcher	= JEventDispatcher::getInstance();		$ret = true;		foreach ($paths as $path)		{			if ($path !== JFile::makeSafe($path))			{				// filename is not safe				$filename = htmlspecialchars($path, ENT_COMPAT, 'UTF-8');				JError::raiseWarning(100, JText::sprintf('COM_MEDIA_ERROR_UNABLE_TO_DELETE_FILE_WARNFILENAME', substr($filename, strlen(COM_MEDIA_BASE))));				continue;			}			$fullPath = JPath::clean(implode(DIRECTORY_SEPARATOR, array(COM_MEDIA_BASE, $folder, $path)));			$object_file = new JObject(array('filepath' => $fullPath));			if (is_file($object_file->filepath))			{				// Trigger the onContentBeforeDelete event.				$result = $dispatcher->trigger('onContentBeforeDelete', array('com_media.file', &$object_file));				if (in_array(false, $result, true))				{					// There are some errors in the plugins					JError::raiseWarning(100, JText::plural('COM_MEDIA_ERROR_BEFORE_DELETE', count($errors = $object_file->getErrors()), implode('<br />', $errors)));					continue;				}				$ret &= JFile::delete($object_file->filepath);				// Trigger the onContentAfterDelete event.				$dispatcher->trigger('onContentAfterDelete', array('com_media.file', &$object_file));				$this->setMessage(JText::sprintf('COM_MEDIA_DELETE_COMPLETE', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));			}			elseif (is_dir($object_file->filepath))			{				$contents = JFolder::files($object_file->filepath, '.', true, false, array('.svn', 'CVS', '.DS_Store', '__MACOSX', 'index.html'));				if (empty($contents))				{					// Trigger the onContentBeforeDelete event.					$result = $dispatcher->trigger('onContentBeforeDelete', array('com_media.folder', &$object_file));					if (in_array(false, $result, true))					{						// There are some errors in the plugins						JError::raiseWarning(100, JText::plural('COM_MEDIA_ERROR_BEFORE_DELETE', count($errors = $object_file->getErrors()), implode('<br />', $errors)));						continue;					}					$ret &= JFolder::delete($object_file->filepath);					// Trigger the onContentAfterDelete event.					$dispatcher->trigger('onContentAfterDelete', array('com_media.folder', &$object_file));					$this->setMessage(JText::sprintf('COM_MEDIA_DELETE_COMPLETE', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));				}				else				{					// This makes no sense...					JError::raiseWarning(100, JText::sprintf('COM_MEDIA_ERROR_UNABLE_TO_DELETE_FOLDER_NOT_EMPTY', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));				}			}		}		return $ret;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Database * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * MySQL database driver * * @package     Joomla.Platform * @subpackage  Database * @see         http://dev.mysql.com/doc/ * @since       12.1 */class JDatabaseDriverMysql extends JDatabaseDriverMysqli{	/**	 * The name of the database driver.	 *	 * @var    string	 * @since  12.1	 */	public $name = 'mysql';	/**	 * Constructor.	 *	 * @param   array  $options  Array of database options with keys: host, user, password, database, select.	 *	 * @since   12.1	 */	public function __construct($options)	{		// Get some basic values from the options.		$options['host'] = (isset($options['host'])) ? $options['host'] : 'localhost';		$options['user'] = (isset($options['user'])) ? $options['user'] : 'root';		$options['password'] = (isset($options['password'])) ? $options['password'] : '';		$options['database'] = (isset($options['database'])) ? $options['database'] : '';		$options['select'] = (isset($options['select'])) ? (bool) $options['select'] : true;		// Finalize initialisation.		parent::__construct($options);	}	/**	 * Destructor.	 *	 * @since   12.1	 */	public function __destruct()	{		if (is_resource($this->connection))		{			mysql_close($this->connection);		}	}	/**	 * Connects to the database if needed.	 *	 * @return  void  Returns void if the database connected successfully.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function connect()	{		if ($this->connection)		{			return;		}		// Make sure the MySQL extension for PHP is installed and enabled.		if (!function_exists('mysql_connect'))		{			throw new RuntimeException('Could not connect to MySQL.');		}		// Attempt to connect to the server.		if (!($this->connection = @ mysql_connect($this->options['host'], $this->options['user'], $this->options['password'], true)))		{			throw new RuntimeException('Could not connect to MySQL.');		}		// Set sql_mode to non_strict mode		mysql_query("SET @@SESSION.sql_mode = '';", $this->connection);		// If auto-select is enabled select the given database.		if ($this->options['select'] && !empty($this->options['database']))		{			$this->select($this->options['database']);		}		// Set charactersets (needed for MySQL 4.1.2+).		$this->setUTF();	}	/**	 * Disconnects the database.	 *	 * @return  void	 *	 * @since   12.1	 */	public function disconnect()	{		// Close the connection.		mysql_close($this->connection);		$this->connection = null;	}	/**	 * Method to escape a string for usage in an SQL statement.	 *	 * @param   string   $text   The string to be escaped.	 * @param   boolean  $extra  Optional parameter to provide extra escaping.	 *	 * @return  string  The escaped string.	 *	 * @since   12.1	 */	public function escape($text, $extra = false)	{		$this->connect();		$result = mysql_real_escape_string($text, $this->getConnection());		if ($extra)		{			$result = addcslashes($result, '%_');		}		return $result;	}	/**	 * Test to see if the MySQL connector is available.	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   12.1	 */	public static function isSupported()	{		return (function_exists('mysql_connect'));	}	/**	 * Determines if the connection to the server is active.	 *	 * @return  boolean  True if connected to the database engine.	 *	 * @since   12.1	 */	public function connected()	{		if (is_resource($this->connection))		{			return @mysql_ping($this->connection);		}		return false;	}	/**	 * Get the number of affected rows for the previous executed SQL statement.	 *	 * @return  integer  The number of affected rows.	 *	 * @since   12.1	 */	public function getAffectedRows()	{		$this->connect();		return mysql_affected_rows($this->connection);	}	/**	 * Get the number of returned rows for the previous executed SQL statement.	 *	 * @param   resource  $cursor  An optional database cursor resource to extract the row count from.	 *	 * @return  integer   The number of returned rows.	 *	 * @since   12.1	 */	public function getNumRows($cursor = null)	{		$this->connect();		return mysql_num_rows($cursor ? $cursor : $this->cursor);	}	/**	 * Get the version of the database connector.	 *	 * @return  string  The database connector version.	 *	 * @since   12.1	 */	public function getVersion()	{		$this->connect();		return mysql_get_server_info($this->connection);	}	/**	 * Method to get the auto-incremented value from the last INSERT statement.	 *	 * @return  integer  The value of the auto-increment field from the last inserted row.	 *	 * @since   12.1	 */	public function insertid()	{		$this->connect();		return mysql_insert_id($this->connection);	}	/**	 * Execute the SQL statement.	 *	 * @return  mixed  A database cursor resource on success, boolean false on failure.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function execute()	{		$this->connect();		if (!is_resource($this->connection))		{			JLog::add(JText::sprintf('JLIB_DATABASE_QUERY_FAILED', $this->errorNum, $this->errorMsg), JLog::ERROR, 'database');			throw new RuntimeException($this->errorMsg, $this->errorNum);		}		// Take a local copy so that we don't modify the original query and cause issues later		$query = $this->replacePrefix((string) $this->sql);		if ($this->limit > 0 || $this->offset > 0)		{			$query .= ' LIMIT ' . $this->offset . ', ' . $this->limit;		}		// Increment the query counter.		$this->count++;		// If debugging is enabled then let's log the query.		if ($this->debug)		{			// Add the query to the object queue.			$this->log[] = $query;			JLog::add($query, JLog::DEBUG, 'databasequery');		}		// Reset the error values.		$this->errorNum = 0;		$this->errorMsg = '';		// Execute the query. Error suppression is used here to prevent warnings/notices that the connection has been lost.		$this->cursor = @mysql_query($query, $this->connection);		// If an error occurred handle it.		if (!$this->cursor)		{			// Check if the server was disconnected.			if (!$this->connected())			{				try				{					// Attempt to reconnect.					$this->connection = null;					$this->connect();				}				// If connect fails, ignore that exception and throw the normal exception.				catch (RuntimeException $e)				{					// Get the error number and message.					$this->errorNum = (int) mysql_errno($this->connection);					$this->errorMsg = (string) mysql_error($this->connection) . ' SQL=' . $query;					// Throw the normal query exception.					JLog::add(JText::sprintf('JLIB_DATABASE_QUERY_FAILED', $this->errorNum, $this->errorMsg), JLog::ERROR, 'databasequery');					throw new RuntimeException($this->errorMsg, $this->errorNum);				}				// Since we were able to reconnect, run the query again.				return $this->execute();			}			// The server was not disconnected.			else			{				// Get the error number and message.				$this->errorNum = (int) mysql_errno($this->connection);				$this->errorMsg = (string) mysql_error($this->connection) . ' SQL=' . $query;				// Throw the normal query exception.				JLog::add(JText::sprintf('JLIB_DATABASE_QUERY_FAILED', $this->errorNum, $this->errorMsg), JLog::ERROR, 'databasequery');				throw new RuntimeException($this->errorMsg, $this->errorNum);			}		}		return $this->cursor;	}	/**	 * Select a database for use.	 *	 * @param   string  $database  The name of the database to select for use.	 *	 * @return  boolean  True if the database was successfully selected.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function select($database)	{		$this->connect();		if (!$database)		{			return false;		}		if (!mysql_select_db($database, $this->connection))		{			throw new RuntimeException('Could not connect to database');		}		return true;	}	/**	 * Set the connection to use UTF-8 character encoding.	 *	 * @return  boolean  True on success.	 *	 * @since   12.1	 */	public function setUTF()	{		$this->connect();		return mysql_set_charset('utf8', $this->connection);	}	/**	 * Method to fetch a row from the result set cursor as an array.	 *	 * @param   mixed  $cursor  The optional result set cursor from which to fetch the row.	 *	 * @return  mixed  Either the next row from the result set or false if there are no more rows.	 *	 * @since   12.1	 */	protected function fetchArray($cursor = null)	{		return mysql_fetch_row($cursor ? $cursor : $this->cursor);	}	/**	 * Method to fetch a row from the result set cursor as an associative array.	 *	 * @param   mixed  $cursor  The optional result set cursor from which to fetch the row.	 *	 * @return  mixed  Either the next row from the result set or false if there are no more rows.	 *	 * @since   12.1	 */	protected function fetchAssoc($cursor = null)	{		return mysql_fetch_assoc($cursor ? $cursor : $this->cursor);	}	/**	 * Method to fetch a row from the result set cursor as an object.	 *	 * @param   mixed   $cursor  The optional result set cursor from which to fetch the row.	 * @param   string  $class   The class name to use for the returned row object.	 *	 * @return  mixed   Either the next row from the result set or false if there are no more rows.	 *	 * @since   12.1	 */	protected function fetchObject($cursor = null, $class = 'stdClass')	{		return mysql_fetch_object($cursor ? $cursor : $this->cursor, $class);	}	/**	 * Method to free up the memory used for the result set.	 *	 * @param   mixed  $cursor  The optional result set cursor from which to fetch the row.	 *	 * @return  void	 *	 * @since   12.1	 */	protected function freeResult($cursor = null)	{		mysql_free_result($cursor ? $cursor : $this->cursor);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Users mail model. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersModelMail extends JModelAdmin{	/**	 * Method to get the row form.	 *	 * @param   array  $data		An optional array of data for the form to interogate.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		$app = JFactory::getApplication();		// Get the form.		$form = $this->loadForm('com_users.mail', 'mail', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_users.display.mail.data', array());		$this->preprocessData('com_users.mail', $data);		return $data;	}	/**	 * Override preprocessForm to load the user plugin group instead of content.	 *	 * @param   object	A form object.	 * @param   mixed	The data expected for the form.	 * @throws	Exception if there is an error in the form event.	 * @since   1.6	 */	protected function preprocessForm(JForm $form, $data, $group = 'user')	{		parent::preprocessForm($form, $data, $group);	}	public function send()	{		$app    = JFactory::getApplication();		$data   = $app->input->post->get('jform', array(), 'array');		$user   = JFactory::getUser();		$access = new JAccess;		$db     = $this->getDbo();		$mode		= array_key_exists('mode', $data) ? (int) $data['mode'] : 0;		$subject	= array_key_exists('subject', $data) ? $data['subject'] : '';		$grp		= array_key_exists('group', $data) ? (int) $data['group'] : 0;		$recurse	= array_key_exists('recurse', $data) ? (int) $data['recurse'] : 0;		$bcc		= array_key_exists('bcc', $data) ? (int) $data['bcc'] : 0;		$disabled	= array_key_exists('disabled', $data) ? (int) $data['disabled'] : 0;		$message_body = array_key_exists('message', $data) ? $data['message'] : '';		// automatically removes html formatting		if (!$mode)		{			$message_body = JFilterInput::getInstance()->clean($message_body, 'string');		}		// Check for a message body and subject		if (!$message_body || !$subject)		{			$app->setUserState('com_users.display.mail.data', $data);			$this->setError(JText::_('COM_USERS_MAIL_PLEASE_FILL_IN_THE_FORM_CORRECTLY'));			return false;		}		// get users in the group out of the acl		$to = $access->getUsersByGroup($grp, $recurse);		// Get all users email and group except for senders		$query	= $db->getQuery(true)			->select('email')			->from('#__users')			->where('id != '.(int) $user->get('id'));		if ($grp !== 0)		{			if (empty($to))			{				$query->where('0');			} else {				$query->where('id IN (' . implode(',', $to) . ')');			}		}		if ($disabled == 0){			$query->where("block = 0");		}		$db->setQuery($query);		$rows = $db->loadColumn();		// Check to see if there are any users in this group before we continue		if (!count($rows))		{			$app->setUserState('com_users.display.mail.data', $data);			if (in_array($user->id, $to))			{				$this->setError(JText::_('COM_USERS_MAIL_ONLY_YOU_COULD_BE_FOUND_IN_THIS_GROUP'));			}			else			{				$this->setError(JText::_('COM_USERS_MAIL_NO_USERS_COULD_BE_FOUND_IN_THIS_GROUP'));			}			return false;		}		// Get the Mailer		$mailer = JFactory::getMailer();		$params = JComponentHelper::getParams('com_users');		// Build email message format.		$mailer->setSender(array($app->getCfg('mailfrom'), $app->getCfg('fromname')));		$mailer->setSubject($params->get('mailSubjectPrefix') . stripslashes($subject));		$mailer->setBody($message_body . $params->get('mailBodySuffix'));		$mailer->IsHTML($mode);		// Add recipients		if ($bcc)		{			$mailer->addBCC($rows);			$mailer->addRecipient($app->getCfg('mailfrom'));		}		else		{			$mailer->addRecipient($rows);		}		// Send the Mail		$rs	= $mailer->Send();		// Check for an error		if ($rs instanceof Exception)		{			$app->setUserState('com_users.display.mail.data', $data);			$this->setError($rs->getError());			return false;		} elseif (empty($rs))		{			$app->setUserState('com_users.display.mail.data', $data);			$this->setError(JText::_('COM_USERS_MAIL_THE_MAIL_COULD_NOT_BE_SENT'));			return false;		}		else		{			// Fill the data (specially for the 'mode', 'group' and 'bcc': they could not exist in the array			// when the box is not checked and in this case, the default value would be used instead of the '0'			// one)			$data['mode'] = $mode;			$data['subject'] = $subject;			$data['group'] = $grp;			$data['recurse'] = $recurse;			$data['bcc'] = $bcc;			$data['message'] = $message_body;			$app->setUserState('com_users.display.mail.data', array());			$app->enqueueMessage(JText::plural('COM_USERS_MAIL_EMAIL_SENT_TO_N_USERS', count($rows)), 'message');			return true;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');JHtml::_('behavior.modal');JHtml::_('formbehavior.chosen', 'select');$uri = JUri::getInstance();$return = base64_encode($uri);$user = JFactory::getUser();$userId = $user->get('id');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn = $this->escape($this->state->get('list.direction'));$modMenuId = (int) $this->get('ModMenuId');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task != 'menus.delete' || confirm('<?php echo JText::_('COM_MENUS_MENU_CONFIRM_DELETE', true);?>'))		{			Joomla.submitform(task);		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_menus&view=menus');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<label for="filter_search" class="element-invisible"><?php echo JText::_('COM_MENUS_MENU_SEARCH_FILTER');?></label>				<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_MENUS_MENU_SEARCH_FILTER'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_MENUS_ITEMS_SEARCH_FILTER'); ?>" />			</div>			<div class="btn-group pull-left hidden-phone">				<button class="btn hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button class="btn hasTooltip" type="button" onclick="document.id('filter_search').value='';this.form.submit();" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>"><i class="icon-remove"></i></button>			</div>			<div class="btn-group pull-right hidden-phone">				<label for="limit" class="element-invisible"><?php echo JText::_('JFIELD_PLG_SEARCH_SEARCHLIMIT_DESC');?></label>				<?php echo $this->pagination->getLimitBox(); ?>			</div>		</div>		<div class="clearfix"> </div>		<table class="table table-striped">			<thead>				<tr>					<th width="1%">						<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />					</th>					<th>						<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>					</th>					<th width="10%" class="nowrap center hidden-phone">						<?php echo JText::_('COM_MENUS_HEADING_PUBLISHED_ITEMS'); ?>					</th>					<th width="10%" class="nowrap center hidden-phone">						<?php echo JText::_('COM_MENUS_HEADING_UNPUBLISHED_ITEMS'); ?>					</th>					<th width="10%" class="nowrap center hidden-phone">						<?php echo JText::_('COM_MENUS_HEADING_TRASHED_ITEMS'); ?>					</th>					<th width="20%" class="nowrap hidden-phone">						<?php echo JText::_('COM_MENUS_HEADING_LINKED_MODULES'); ?>					</th>					<th width="1%" class="center nowrap">						<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>					</th>				</tr>			</thead>			<tfoot>				<tr>					<td colspan="15">						<?php echo $this->pagination->getListFooter(); ?>					</td>				</tr>			</tfoot>			<tbody>			<?php foreach ($this->items as $i => $item) :				$canCreate = $user->authorise('core.create',     'com_menus');				$canEdit   = $user->authorise('core.edit',       'com_menus');				$canChange = $user->authorise('core.edit.state', 'com_menus');			?>				<tr class="row<?php echo $i % 2; ?>">					<td class="center">						<?php echo JHtml::_('grid.id', $i, $item->id); ?>					</td>					<td>						<a href="<?php echo JRoute::_('index.php?option=com_menus&view=items&menutype='.$item->menutype) ?> ">							<?php echo $this->escape($item->title); ?></a>						<p class="small">(<span><?php echo JText::_('COM_MENUS_MENU_MENUTYPE_LABEL') ?></span>							<?php if ($canEdit) : ?>								<?php echo '<a href="'.JRoute::_('index.php?option=com_menus&task=menu.edit&id='.$item->id).' title='.$this->escape($item->description).'">'.								$this->escape($item->menutype).'</a>'; ?>)							<?php else : ?>								<?php echo $this->escape($item->menutype)?>)							<?php endif; ?>						</p>					</td>					<td class="center btns">						<a class="badge badge-success" href="<?php echo JRoute::_('index.php?option=com_menus&view=items&menutype='.$item->menutype.'&filter_published=1');?>">							<?php echo $item->count_published; ?></a>					</td>					<td class="center btns">						<a class="badge" href="<?php echo JRoute::_('index.php?option=com_menus&view=items&menutype='.$item->menutype.'&filter_published=0');?>">							<?php echo $item->count_unpublished; ?></a>					</td>					<td class="center btns">						<a class="badge badge-error" href="<?php echo JRoute::_('index.php?option=com_menus&view=items&menutype='.$item->menutype.'&filter_published=-2');?>">							<?php echo $item->count_trashed; ?></a>					</td>					<td class="left">						<?php if (isset($this->modules[$item->menutype])) : ?>							<div class="btn-group">								<a href="#" class="btn btn-small dropdown-toggle" data-toggle="dropdown">									<?php echo JText::_('COM_MENUS_MODULES') ?>									<b class="caret"></b>								</a>								<ul class="dropdown-menu">									<?php foreach ($this->modules[$item->menutype] as &$module) : ?>										<li>											<?php if ($canEdit) : ?>												<a class="small modal" href="<?php echo JRoute::_('index.php?option=com_modules&task=module.edit&id='.$module->id.'&return='.$return.'&tmpl=component&layout=modal');?>" rel="{handler: 'iframe', size: {x: 1024, y: 450}, onClose: function() {window.location.reload()}}" title="<?php echo JText::_('COM_MENUS_EDIT_MODULE_SETTINGS');?>">												<?php echo JText::sprintf('COM_MENUS_MODULE_ACCESS_POSITION', $this->escape($module->title), $this->escape($module->access_title), $this->escape($module->position)); ?></a>											<?php else :?>												<?php echo JText::sprintf('COM_MENUS_MODULE_ACCESS_POSITION', $this->escape($module->title), $this->escape($module->access_title), $this->escape($module->position)); ?>											<?php endif; ?>										</li>									<?php endforeach; ?>								</ul>							 </div>						<?php elseif ($modMenuId) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_modules&task=module.add&eid=' . $modMenuId . '&params[menutype]='.$item->menutype); ?>">							<?php echo JText::_('COM_MENUS_ADD_MENU_MODULE'); ?></a>						<?php endif; ?>					</td>					<td class="center">						<?php echo $item->id; ?>					</td>				</tr>				<?php endforeach; ?>			</tbody>		</table>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Form Field class for the Joomla Platform. * Provides a hidden field * * @package     Joomla.Platform * @subpackage  Form * @link        http://www.w3.org/TR/html-markup/input.hidden.html#input.hidden * @since       11.1 */class JFormFieldHidden extends JFormField{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	protected $type = 'Hidden';	/**	 * Method to get the field input markup.	 *	 * @return  string  The field input markup.	 *	 * @since   11.1	 */	protected function getInput()	{		// Initialize some field attributes.		$class = $this->element['class'] ? ' class="' . (string) $this->element['class'] . '"' : '';		$disabled = ((string) $this->element['disabled'] == 'true') ? ' disabled="disabled"' : '';		// Initialize JavaScript field attributes.		$onchange = $this->element['onchange'] ? ' onchange="' . (string) $this->element['onchange'] . '"' : '';		return '<input type="hidden" name="' . $this->name . '" id="' . $this->id . '" value="'			. htmlspecialchars($this->value, ENT_COMPAT, 'UTF-8') . '"' . $class . $disabled . $onchange . ' />';	}}
<?php/** * @package     Joomla.Site * @subpackage  com_banners * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JTable::addIncludePath(JPATH_COMPONENT_ADMINISTRATOR . '/tables');/** * Banner model for the Joomla Banners component. * * @package     Joomla.Site * @subpackage  com_banners * @since       1.5 */class BannersModelBanner extends JModelLegacy{	protected $_item;	/**	 * Clicks the URL, incrementing the counter	 *	 * @return  void	 *	 * @since   1.5	 */	public function click()	{		$id = $this->getState('banner.id');		// update click count		$db = $this->getDbo();		$query = $db->getQuery(true)			->update('#__banners')			->set('clicks = (clicks + 1)')			->where('id = ' . (int) $id);		$db->setQuery($query);		try		{			$db->execute();		}		catch (RuntimeException $e)		{			JError::raiseError(500, $e->getMessage());		}		// track clicks		$item = $this->getItem();		$trackClicks = $item->track_clicks;		if ($trackClicks < 0 && $item->cid)		{			$trackClicks = $item->client_track_clicks;		}		if ($trackClicks < 0)		{			$config = JComponentHelper::getParams('com_banners');			$trackClicks = $config->get('track_clicks');		}		if ($trackClicks > 0)		{			$trackDate = JFactory::getDate()->format('Y-m-d H');			$query->clear()				->select($db->quoteName('count'))				->from('#__banner_tracks')				->where('track_type=2')				->where('banner_id=' . (int) $id)				->where('track_date=' . $db->quote($trackDate));			$db->setQuery($query);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				JError::raiseError(500, $e->getMessage());			}			$count = $db->loadResult();			$query->clear();			if ($count)			{				// update count				$query->update('#__banner_tracks')					->set($db->quoteName('count') . ' = (' . $db->quote('count') . ' + 1)')					->where('track_type=2')					->where('banner_id=' . (int) $id)					->where('track_date=' . $db->quote($trackDate));			}			else			{				// insert new count				//sqlsrv change				$query->insert('#__banner_tracks')					->columns(						array(							$db->quoteName('count'), $db->quoteName('track_type'),							$db->quoteName('banner_id'), $db->quoteName('track_date')						)					)					->values('1, 2,' . (int) $id . ',' . $db->quote($trackDate));			}			$db->setQuery($query);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				JError::raiseError(500, $e->getMessage());			}		}	}	/**	 * Get the data for a banner.	 *	 * @return  object	 */	public function &getItem()	{		if (!isset($this->_item))		{			$cache = JFactory::getCache('com_banners', '');			$id = $this->getState('banner.id');			$this->_item = $cache->get($id);			if ($this->_item === false)			{				// redirect to banner url				$db = $this->getDbo();				$query = $db->getQuery(true)					->select(						'a.clickurl as clickurl,' .							'a.cid as cid,' .							'a.track_clicks as track_clicks'					)					->from('#__banners as a')					->where('a.id = ' . (int) $id)					->join('LEFT', '#__banner_clients AS cl ON cl.id = a.cid')					->select('cl.track_clicks as client_track_clicks');				$db->setQuery($query);				try				{					$db->execute();				}				catch (RuntimeException $e)				{					JError::raiseError(500, $e->getMessage());				}				$this->_item = $db->loadObject();				$cache->store($this->_item, $id);			}		}		return $this->_item;	}	/**	 * Get the URL for a banner	 *	 * @return  string	 *	 * @since   1.5	 */	public function getUrl()	{		$item = $this->getItem();		$url = $item->clickurl;		// check for links		if (!preg_match('#http[s]?://|index[2]?\.php#', $url))		{			$url = "http://$url";		}		return $url;	}}
<?php/** * @package     Joomla.Site * @subpackage  mod_tags_popular * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the syndicate functions only oncerequire_once __DIR__ . '/helper.php';$cacheparams = new stdClass;$cacheparams->cachemode = 'safeuri';$cacheparams->class = 'ModTagsPopularHelper';$cacheparams->method = 'getList';$cacheparams->methodparams = $params;$cacheparams->modeparams = array('id' => 'array', 'Itemid' => 'int');$list = JModuleHelper::moduleCache($module, $params, $cacheparams);if (!count($list)){	return;}$moduleclass_sfx = htmlspecialchars($params->get('moduleclass_sfx'));require JModuleHelper::getLayoutPath('mod_tags_popular', $params->get('layout', 'default'));
<?php/** * @package     Joomla.Administrator * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;echo JLayoutHelper::render('joomla.edit.metadata', $this);
<?php/** * @package     Joomla.Administrator * @subpackage  com_cache * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the Cache component * * @package     Joomla.Administrator * @subpackage  com_cache * @since       1.6 */class CacheViewCache extends JViewLegacy{	protected $client;	protected $data;	protected $pagination;	protected $state;	public function display($tpl = null)	{		$this->data			= $this->get('Data');		$this->client		= $this->get('Client');		$this->pagination	= $this->get('Pagination');		$this->state		= $this->get('State');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		$this->addToolbar();		$this->sidebar = JHtmlSidebar::render();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		$user = JFactory::getUser();		$condition = ($this->client->name == 'site');		JToolbarHelper::title(JText::_('COM_CACHE_CLEAR_CACHE'), 'clear.png');		JToolbarHelper::custom('delete', 'delete.png', 'delete_f2.png', 'JTOOLBAR_DELETE', true);		JToolbarHelper::divider();		if (JFactory::getUser()->authorise('core.admin', 'com_cache'))		{			JToolbarHelper::preferences('com_cache');		}		JToolbarHelper::divider();		JToolbarHelper::help('JHELP_SITE_MAINTENANCE_CLEAR_CACHE');		JHtmlSidebar::setAction('index.php?option=com_cache');		JHtmlSidebar::addFilter(			// @todo We need an actual label here			'',			'filter_client_id',			JHtml::_('select.options', CacheHelper::getClientOptions(), 'value', 'text', $this->state->get('clientId'))		);	}}
<?php/** * @package     Joomla.Site * @subpackage  Layout * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;// Note that this layout opens a div with the page class suffix. If you do not use the category children// layout you need to close this div either by overriding this file or in your main layout.$params  = $displayData->params;$extension = $displayData->get('category')->extension;$canEdit = $params->get('access-edit');$className = substr($extension, 4);// This will work for the core components but not necessarily for other components// that may have different pluralisation rules.if (substr($className, -1) == 's'){	$className = rtrim($className, 's');}$tagsData  = $displayData->get('category')->tags->itemTags;?><div>	<div class="<?php echo $className .'-category' . $displayData->pageclass_sfx;?>">		<?php if ($params->get('show_page_heading')) : ?>			<h1>				<?php echo $displayData->escape($params->get('page_heading')); ?>			</h1>		<?php endif; ?>		<?php if($params->get('show_category_title', 1)) : ?>			<h2>				<?php echo JHtml::_('content.prepare', $displayData->get('category')->title, '', $extension.'.category'); ?>			</h2>		<?php endif; ?>		<?php if ($displayData->get('show_tags', 1)) : ?>			<?php echo JLayoutHelper::render('joomla.content.tags', $tagsData); ?>		<?php endif; ?>		<?php if ($params->get('show_description', 1) || $params->def('show_description_image', 1)) : ?>			<div class="category-desc">				<?php if ($params->get('show_description_image') && $displayData->get('category')->getParams()->get('image')) : ?>					<img src="<?php echo $displayData->get('category')->getParams()->get('image'); ?>"/>				<?php endif; ?>				<?php if ($params->get('show_description') && $displayData->get('category')->description) : ?>					<?php echo JHtml::_('content.prepare', $displayData->get('category')->description, '', $extension .'.category'); ?>				<?php endif; ?>				<div class="clr"></div>			</div>		<?php endif; ?>		<?php echo $displayData->loadTemplate($displayData->subtemplatename); ?>		<?php if ($displayData->get('children') && $displayData->maxLevel != 0) : ?>			<div class="cat-children">				<h3>					<?php echo JTEXT::_('JGLOBAL_SUBCATEGORIES'); ?>				</h3>				<?php echo $displayData->loadTemplate('children'); ?>			</div>		<?php endif; ?>	</div></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * The HTML Menus Menu Item View. * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class MenusViewMenu extends JViewLegacy{	protected $form;	protected $item;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$this->form	 = $this->get('Form');		$this->item	 = $this->get('Item');		$this->state = $this->get('State');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		parent::display($tpl);		$this->addToolbar();	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		$input = JFactory::getApplication()->input;		$input->set('hidemainmenu', true);		$user  = JFactory::getUser();		$isNew = ($this->item->id == 0);		$canDo = MenusHelper::getActions($this->state->get('filter.parent_id'));		JToolbarHelper::title(JText::_($isNew ? 'COM_MENUS_VIEW_NEW_MENU_TITLE' : 'COM_MENUS_VIEW_EDIT_MENU_TITLE'), 'menu.png');		// If a new item, can save the item.  Allow users with edit permissions to apply changes to prevent returning to grid.		if ($isNew && $canDo->get('core.create'))		{			if ($canDo->get('core.edit'))			{				JToolbarHelper::apply('menu.apply');			}			JToolbarHelper::save('menu.save');		}		// If user can edit, can save the item.		if (!$isNew && $canDo->get('core.edit'))		{			JToolbarHelper::apply('menu.apply');			JToolbarHelper::save('menu.save');		}		// If the user can create new items, allow them to see Save & New		if ($canDo->get('core.create'))		{			JToolbarHelper::save2new('menu.save2new');		}		if ($isNew)		{			JToolbarHelper::cancel('menu.cancel');		}		else		{			JToolbarHelper::cancel('menu.cancel', 'JTOOLBAR_CLOSE');		}		JToolbarHelper::divider();		JToolbarHelper::help('JHELP_MENUS_MENU_MANAGER_EDIT');	}}
<?php/** * @package     Joomla.Platform * @subpackage  Log * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Joomla! MySQL Database Log class * * This class is designed to output logs to a specific MySQL database table. Fields in this * table are based on the Syslog style of log output. This is designed to allow quick and * easy searching. * * @package     Joomla.Platform * @subpackage  Log * @since       11.1 */class JLogLoggerDatabase extends JLogLogger{	/**	 * @var    string  The name of the database driver to use for connecting to the database.	 * @since  11.1	 */	protected $driver = 'mysqli';	/**	 * @var    string  The host name (or IP) of the server with which to connect for the logger.	 * @since  11.1	 */	protected $host = '127.0.0.1';	/**	 * @var    string  The database server user to connect as for the logger.	 * @since  11.1	 */	protected $user = 'root';	/**	 * @var    string  The password to use for connecting to the database server.	 * @since  11.1	 */	protected $password = '';	/**	 * @var    string  The name of the database table to use for the logger.	 * @since  11.1	 */	protected $database = 'logging';	/**	 * @var    string  The database table to use for logging entries.	 * @since  11.1	 */	protected $table = 'jos_';	/**	 * @var    JDatabaseDriver  The database driver object for the logger.	 * @since  11.1	 */	protected $db;	/**	 * Constructor.	 *	 * @param   array  &$options  Log object options.	 *	 * @since   11.1	 */	public function __construct(array &$options)	{		// Call the parent constructor.		parent::__construct($options);		// If both the database object and driver options are empty we want to use the system database connection.		if (empty($this->options['db_driver']))		{			$this->db = JFactory::getDbo();			$this->driver = null;			$this->host = null;			$this->user = null;			$this->password = null;			$this->database = null;			$this->prefix = null;		}		else		{			$this->db = null;			$this->driver = (empty($this->options['db_driver'])) ? 'mysqli' : $this->options['db_driver'];			$this->host = (empty($this->options['db_host'])) ? '127.0.0.1' : $this->options['db_host'];			$this->user = (empty($this->options['db_user'])) ? 'root' : $this->options['db_user'];			$this->password = (empty($this->options['db_pass'])) ? '' : $this->options['db_pass'];			$this->database = (empty($this->options['db_database'])) ? 'logging' : $this->options['db_database'];			$this->prefix = (empty($this->options['db_prefix'])) ? 'jos_' : $this->options['db_prefix'];		}		// The table name is independent of how we arrived at the connection object.		$this->table = (empty($this->options['db_table'])) ? '#__log_entries' : $this->options['db_table'];	}	/**	 * Method to add an entry to the log.	 *	 * @param   JLogEntry  $entry  The log entry object to add to the log.	 *	 * @return  void	 *	 * @since   11.1	 */	public function addEntry(JLogEntry $entry)	{		// Connect to the database if not connected.		if (empty($this->db))		{			$this->connect();		}		// Convert the date.		$entry->date = $entry->date->toSql(false, $this->db);		$this->db->insertObject($this->table, $entry);	}	/**	 * Method to connect to the database server based on object properties.	 *	 * @return  void	 *	 * @since   11.1	 * @throws  RuntimeException	 */	protected function connect()	{		// Build the configuration object to use for JDatabaseDriver.		$options = array(			'driver' => $this->driver,			'host' => $this->host,			'user' => $this->user,			'password' => $this->password,			'database' => $this->database,			'prefix' => $this->prefix);		$db = JDatabaseDriver::getInstance($options);		// Assign the database connector to the class.		$this->db = $db;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Linkedin * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Linkedin API object class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Linkedin * @since       13.1 */abstract class JLinkedinObject{	/**	 * @var    JRegistry  Options for the Linkedin object.	 * @since  13.1	 */	protected $options;	/**	 * @var    JHttp  The HTTP client object to use in sending HTTP requests.	 * @since  13.1	 */	protected $client;	/**	 * @var JLinkedinOAuth The OAuth client.	 * @since 13.1	 */	protected $oauth;	/**	 * Constructor.	 *	 * @param   JRegistry       $options  Linkedin options object.	 * @param   JHttp           $client   The HTTP client object.	 * @param   JLinkedinOAuth  $oauth    The OAuth client.	 *	 * @since   13.1	 */	public function __construct(JRegistry $options = null, JHttp $client = null, JLinkedinOAuth $oauth = null)	{		$this->options = isset($options) ? $options : new JRegistry;		$this->client = isset($client) ? $client : new JHttp($this->options);		$this->oauth = $oauth;	}	/**	 * Method to convert boolean to string.	 *	 * @param   boolean  $bool  The boolean value to convert.	 *	 * @return  string  String with the converted boolean.	 *	 * @since 13.1	 */	public function booleanToString($bool)	{		if ($bool)		{			return 'true';		}		else		{			return 'false';		}	}	/**	 * Get an option from the JLinkedinObject instance.	 *	 * @param   string  $key  The name of the option to get.	 *	 * @return  mixed  The option value.	 *	 * @since   13.1	 */	public function getOption($key)	{		return $this->options->get($key);	}	/**	 * Set an option for the JLinkedinObject instance.	 *	 * @param   string  $key    The name of the option to set.	 * @param   mixed   $value  The option value to set.	 *	 * @return  JLinkedinObject  This object for method chaining.	 *	 * @since   13.1	 */	public function setOption($key, $value)	{		$this->options->set($key, $value);		return $this;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_media * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$user = JFactory::getUser();$params = new JRegistry;$dispatcher	= JEventDispatcher::getInstance();$dispatcher->trigger('onContentBeforeDisplay', array('com_media.file', &$this->_tmp_doc, &$params));?>		<li class="imgOutline thumbnail height-80 width-80 center">			<?php if ($user->authorise('core.delete', 'com_media')):?>				<a class="close delete-item" target="_top" href="index.php?option=com_media&amp;task=file.delete&amp;tmpl=index&amp;<?php echo JSession::getFormToken(); ?>=1&amp;folder=<?php echo $this->state->folder; ?>&amp;rm[]=<?php echo $this->_tmp_doc->name; ?>" rel="<?php echo $this->_tmp_doc->name; ?>" title="<?php echo JText::_('JACTION_DELETE');?>">x</a>				<input class="pull-left" type="checkbox" name="rm[]" value="<?php echo $this->_tmp_doc->name; ?>" />				<div class="clearfix"></div>			<?php endif;?>			<div class="height-50">				<a style="display: block; width: 100%; height: 100%" title="<?php echo $this->_tmp_doc->name; ?>" >					<?php echo JHtml::_('image', $this->_tmp_doc->icon_32, $this->_tmp_doc->name, null, true, true) ? JHtml::_('image', $this->_tmp_doc->icon_32, $this->_tmp_doc->title, null, true) : JHtml::_('image', 'media/con_info.png', $this->_tmp_doc->name, null, true); ?></a>			</div>			<div class="small" title="<?php echo $this->_tmp_doc->name; ?>" >				<?php echo JHtml::_('string.truncate', $this->_tmp_doc->name, 10, false); ?>			</div>		</li><?php$dispatcher->trigger('onContentAfterDisplay', array('com_media.file', &$this->_tmp_doc, &$params));?>
<?php/** * @package     Joomla.Platform * @subpackage  Table * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Table class supporting modified pre-order tree traversal behavior. * * @package     Joomla.Platform * @subpackage  Table * @link        http://docs.joomla.org/JTableAsset * @since       11.1 */class JTableAsset extends JTableNested{	/**	 * The primary key of the asset.	 *	 * @var    integer	 * @since  11.1	 */	public $id = null;	/**	 * The unique name of the asset.	 *	 * @var    string	 * @since  11.1	 */	public $name = null;	/**	 * The human readable title of the asset.	 *	 * @var    string	 * @since  11.1	 */	public $title = null;	/**	 * The rules for the asset stored in a JSON string	 *	 * @var    string	 * @since  11.1	 */	public $rules = null;	/**	 * Constructor	 *	 * @param   JDatabaseDriver  $db  Database driver object.	 *	 * @since   11.1	 */	public function __construct($db)	{		parent::__construct('#__assets', 'id', $db);	}	/**	 * Method to load an asset by its name.	 *	 * @param   string  $name  The name of the asset.	 *	 * @return  integer	 *	 * @since   11.1	 */	public function loadByName($name)	{		// Get the JDatabaseQuery object		$query = $this->_db->getQuery(true);		// Get the asset id for the asset.		$query->select($this->_db->quoteName('id'))			->from($this->_db->quoteName('#__assets'))			->where($this->_db->quoteName('name') . ' = ' . $this->_db->quote($name));		$this->_db->setQuery($query);		$assetId = (int) $this->_db->loadResult();		if (empty($assetId))		{			return false;		}		return $this->load($assetId);	}	/**	 * Assert that the nested set data is valid.	 *	 * @return  boolean  True if the instance is sane and able to be stored in the database.	 *	 * @link    http://docs.joomla.org/JTable/check	 * @since   11.1	 */	public function check()	{		$this->parent_id = (int) $this->parent_id;		// JTableNested does not allow parent_id = 0, override this.		if ($this->parent_id > 0)		{			// Get the JDatabaseQuery object			$query = $this->_db->getQuery(true)				->select('COUNT(id)')				->from($this->_db->quoteName($this->_tbl))				->where($this->_db->quoteName('id') . ' = ' . $this->parent_id);			$this->_db->setQuery($query);			if ($this->_db->loadResult())			{				return true;			}			else			{				$this->setError('Invalid Parent ID');				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User note edit view * * @package     Joomla.Administrator * @subpackage  com_users * @since       2.5 */class UsersViewNote extends JViewLegacy{	/**	 * The edit form.	 *	 * @var    JForm	 * @since  2.5	 */	protected $form;	/**	 * The item data.	 *	 * @var    object	 * @since  2.5	 */	protected $item;	/**	 * The model state.	 *	 * @var    JObject	 * @since  2.5	 */	protected $state;	/**	 * Override the display method for the view.	 *	 * @param   string  $tpl  The name of the template file to parse; automatically searches through the template paths.	 *	 * @return  mixed  A string if successful, otherwise a JError object.	 *	 * @since   2.5	 */	public function display($tpl = null)	{		// Initialise view variables.		$this->state = $this->get('State');		$this->item = $this->get('Item');		$this->form = $this->get('Form');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			throw new Exception(implode("\n", $errors), 500);		}		// Get the component HTML helpers		JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');		parent::display($tpl);		$this->addToolbar();	}	/**	 * Display the toolbar.	 *	 * @return  void	 *	 * @since   2.5	 */	protected function addToolbar()	{		$input = JFactory::getApplication()->input;		$input->set('hidemainmenu', 1);		$user		= JFactory::getUser();		$isNew		= ($this->item->id == 0);		$checkedOut	= !($this->item->checked_out == 0 || $this->item->checked_out == $user->get('id'));		$canDo		= UsersHelper::getActions($this->state->get('filter.category_id'), $this->item->id);		JToolbarHelper::title(JText::_('COM_USERS_NOTES'), 'user');		// If not checked out, can save the item.		if (!$checkedOut && ($canDo->get('core.edit') || (count($user->getAuthorisedCategories('com_users', 'core.create')))))		{			JToolbarHelper::apply('note.apply');			JToolbarHelper::save('note.save');		}		if (!$checkedOut && (count($user->getAuthorisedCategories('com_users', 'core.create'))))		{			JToolbarHelper::save2new('note.save2new');		}		// If an existing item, can save to a copy.		if (!$isNew && (count($user->getAuthorisedCategories('com_users', 'core.create')) > 0))		{			JToolbarHelper::save2copy('note.save2copy');		}		if (empty($this->item->id))		{			JToolbarHelper::cancel('note.cancel');		}		else		{			JToolbarHelper::cancel('note.cancel', 'JTOOLBAR_CLOSE');		}		JToolbarHelper::divider();		JToolbarHelper::help('JHELP_USERS_USER_NOTES_EDIT');	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_messages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('behavior.keepalive');JHtml::_('behavior.modal');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'config.cancel' || document.formvalidator.isValid(document.id('config-form')))		{			Joomla.submitform(task, document.getElementById('config-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_messages'); ?>" method="post" name="adminForm" id="message-form" class="form-validate form-horizontal">	<fieldset>		<div>			<div class="modal-header">				<h3><?php echo JText::_('COM_MESSAGES_MY_SETTINGS');?></h3>			</div>			<div class="modal-body">				<button class="btn btn-primary" type="submit" onclick="Joomla.submitform('config.save', this.form);window.top.setTimeout('window.parent.SqueezeBox.close()', 700);">					<?php echo JText::_('JSAVE');?></button>				<button class="btn" type="button" onclick="window.parent.SqueezeBox.close();">					<?php echo JText::_('JCANCEL');?></button>				<hr />				<div class="control-group">					<div class="control-label">						<?php echo $this->form->getLabel('lock'); ?>					</div>					<div class="controls">						<?php echo $this->form->getInput('lock'); ?>					</div>				</div>				<div class="control-group">					<div class="control-label">						<?php echo $this->form->getLabel('mail_on_new'); ?>					</div>					<div class="controls">						<?php echo $this->form->getInput('mail_on_new'); ?>					</div>				</div>				<div class="control-group">					<div class="control-label">						<?php echo $this->form->getLabel('auto_purge'); ?>					</div>					<div class="controls">						<?php echo $this->form->getInput('auto_purge'); ?>					</div>				</div>			</div>		</div>		</fieldset>		<input type="hidden" name="task" value="" />		<?php echo JHtml::_('form.token'); ?></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Articles list controller class. * * @package     Joomla.Administrator * @subpackage  com_contact * @since       1.6 */class ContactControllerContacts extends JControllerAdmin{	/**	 * Constructor.	 *	 * @param   array  $config	An optional associative array of configuration settings.	 *	 * @return  ContactControllerContacts	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		parent::__construct($config);		$this->registerTask('unfeatured',	'featured');	}	/**	 * Method to toggle the featured setting of a list of contacts.	 *	 * @return  void	 * @since   1.6	 */	public function featured()	{		// Check for request forgeries		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$user   = JFactory::getUser();		$ids    = $this->input->get('cid', array(), 'array');		$values = array('featured' => 1, 'unfeatured' => 0);		$task   = $this->getTask();		$value  = JArrayHelper::getValue($values, $task, 0, 'int');		// Get the model.		$model  = $this->getModel();		// Access checks.		foreach ($ids as $i => $id)		{			$item = $model->getItem($id);			if (!$user->authorise('core.edit.state', 'com_contact.category.'.(int) $item->catid))			{				// Prune items that you can't change.				unset($ids[$i]);				JError::raiseNotice(403, JText::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'));			}		}		if (empty($ids))		{			JError::raiseWarning(500, JText::_('COM_CONTACT_NO_ITEM_SELECTED'));		}		else		{			// Publish the items.			if (!$model->featured($ids, $value))			{				JError::raiseWarning(500, $model->getError());			}		}		$this->setRedirect('index.php?option=com_contact&view=contacts');	}	/**	 * Proxy for getModel.	 *	 * @param   string	$name	The name of the model.	 * @param   string	$prefix	The prefix for the PHP class name.	 *	 * @return  JModel	 * @since   1.6	 */	public function getModel($name = 'Contact', $prefix = 'ContactModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}	/**	 * Method to save the submitted ordering values for records via AJAX.	 *	 * @return  void	 *	 * @since   3.0	 */	public function saveOrderAjax()	{		// Get the input		$pks   = $this->input->post->get('cid', array(), 'array');		$order = $this->input->post->get('order', array(), 'array');		// Sanitize the input		JArrayHelper::toInteger($pks);		JArrayHelper::toInteger($order);		// Get the model		$model = $this->getModel();		// Save the ordering		$return = $model->saveorder($pks, $order);		if ($return)		{			echo "1";		}		// Close the application		JFactory::getApplication()->close();	}	/**	 * Function that allows child controller access to model data	 * after the item has been deleted.	 *	 * @param   JModelLegacy  $model  The data model object.	 * @param   integer       $ids    The array of ids for items being deleted.	 *	 * @return  void	 *	 * @since   12.2	 */	protected function postDeleteHook(JModelLegacy $model, $ids = null)	{	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_banners * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$published = $this->state->get('filter.published');?><div class="modal hide fade" id="collapseModal">	<div class="modal-header">		<button type="button" class="close" data-dismiss="modal">x</button>		<h3><?php echo JText::_('COM_BANNERS_BATCH_OPTIONS');?></h3>	</div>	<div class="modal-body">		<p><?php echo JText::_('COM_BANNERS_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('banner.clients');?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.language'); ?>			</div>		</div>		<?php if ($published >= 0) : ?>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.item', 'com_banners');?>			</div>		</div>		<?php endif; ?>	</div>	<div class="modal-footer">		<button class="btn" type="button" onclick="document.id('batch-category-id').value='';document.id('batch-client-id').value='';document.id('batch-language-id').value=''" data-dismiss="modal">			<?php echo JText::_('JCANCEL'); ?>		</button>		<button class="btn btn-primary" type="submit" onclick="Joomla.submitbutton('banner.batch');">			<?php echo JText::_('JGLOBAL_BATCH_PROCESS'); ?>		</button>	</div></div>
<?php/** * @package     Joomla.Site * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Content categories view. * * @package     Joomla.Site * @subpackage  com_weblinks * @since       1.5 */class WeblinksViewCategories extends JViewLegacy{	protected $state = null;	protected $item = null;	protected $items = null;	/**	 * Display the view	 *	 * @return  mixed  False on error, null otherwise.	 */	public function display($tpl = null)	{		$state		= $this->get('State');		$items		= $this->get('Items');		$parent		= $this->get('Parent');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseWarning(500, implode("\n", $errors));			return false;		}		if ($items === false)		{			return JError::raiseError(404, JText::_('JGLOBAL_CATEGORY_NOT_FOUND'));		}		if ($parent == false)		{			return JError::raiseError(404, JText::_('JGLOBAL_CATEGORY_NOT_FOUND'));		}		$params = &$state->params;		$items = array($parent->id => $items);		//Escape strings for HTML output		$this->pageclass_sfx = htmlspecialchars($params->get('pageclass_sfx'));		$this->maxLevelcat = $params->get('maxLevelcat', -1);		$this->params = &$params;		$this->parent = &$parent;		$this->items  = &$items;		$this->_prepareDocument();		parent::display($tpl);	}	/**	 * Prepares the document	 */	protected function _prepareDocument()	{		$app	= JFactory::getApplication();		$menus	= $app->getMenu();		$title	= null;		// Because the application sets a default page title,		// we need to get it from the menu item itself		$menu = $menus->getActive();		if ($menu)		{			$this->params->def('page_heading', $this->params->get('page_title', $menu->title));		}		else		{			$this->params->def('page_heading', JText::_('COM_WEBLINKS_DEFAULT_PAGE_TITLE'));		}		$title = $this->params->get('page_title', '');		if (empty($title))		{			$title = $app->getCfg('sitename');		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		if ($this->params->get('menu-meta_description'))		{			$this->document->setDescription($this->params->get('menu-meta_description'));		}		if ($this->params->get('menu-meta_keywords'))		{			$this->document->setMetadata('keywords', $this->params->get('menu-meta_keywords'));		}		if ($this->params->get('robots'))		{			$this->document->setMetadata('robots', $this->params->get('robots'));		}	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Router * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;jimport('joomla.application.router');/** * Class to create and parse routes for the site application * * @package     Joomla.Libraries * @subpackage  Router * @since       1.5 */class JRouterSite extends JRouter{	/**	 * Function to convert a route to an internal URI	 *	 * @param   JURI  $uri  The uri.	 *	 * @return  array	 */	public function parse($uri)	{		$vars = array();		// Get the application		$app = JApplication::getInstance('site');		if ($app->getCfg('force_ssl') == 2 && strtolower($uri->getScheme()) != 'https')		{			// Forward to https			$uri->setScheme('https');			$app->redirect((string) $uri);		}		// Get the path		// Decode URL to convert punycode to unicode so that strings match when routing.		$path = urldecode($uri->getPath());		// Remove the base URI path.		$path = substr_replace($path, '', 0, strlen(JURI::base(true)));		// Check to see if a request to a specific entry point has been made.		if (preg_match("#.*?\.php#u", $path, $matches))		{			// Get the current entry point path relative to the site path.			$scriptPath = realpath($_SERVER['SCRIPT_FILENAME'] ? $_SERVER['SCRIPT_FILENAME'] : str_replace('\\\\', '\\', $_SERVER['PATH_TRANSLATED']));			$relativeScriptPath = str_replace('\\', '/', str_replace(JPATH_SITE, '', $scriptPath));			// If a php file has been found in the request path, check to see if it is a valid file.			// Also verify that it represents the same file from the server variable for entry script.			if (file_exists(JPATH_SITE . $matches[0]) && ($matches[0] == $relativeScriptPath))			{				// Remove the entry point segments from the request path for proper routing.				$path = str_replace($matches[0], '', $path);			}		}		// Identify format		if ($this->_mode == JROUTER_MODE_SEF)		{			if ($app->getCfg('sef_suffix') && !(substr($path, -9) == 'index.php' || substr($path, -1) == '/'))			{				if ($suffix = pathinfo($path, PATHINFO_EXTENSION))				{					$vars['format'] = $suffix;				}			}		}		// Set the route		$uri->setPath(trim($path, '/'));		$vars += parent::parse($uri);		return $vars;	}	/**	 * Function to convert an internal URI to a route	 *	 * @param   string  $url  The internal URL	 *	 * @return  string  The absolute search engine friendly URL	 */	public function build($url)	{		$uri = parent::build($url);		// Get the path data		$route = $uri->getPath();		// Add the suffix to the uri		if ($this->_mode == JROUTER_MODE_SEF && $route)		{			$app = JApplication::getInstance('site');			if ($app->getCfg('sef_suffix') && !(substr($route, -9) == 'index.php' || substr($route, -1) == '/'))			{				if ($format = $uri->getVar('format', 'html'))				{					$route .= '.' . $format;					$uri->delVar('format');				}			}			if ($app->getCfg('sef_rewrite'))			{				// Transform the route				if ($route == 'index.php')				{					$route = '';				}				else				{					$route = str_replace('index.php/', '', $route);				}			}		}		// Add basepath to the uri		$uri->setPath(JURI::base(true) . '/' . $route);		return $uri;	}	/**	 * Function to convert a raw route to an internal URI	 *	 * @param   JURI  $uri  The raw route	 *	 * @return  array	 */	protected function _parseRawRoute($uri)	{		$vars = array();		$app  = JApplication::getInstance('site');		$menu = $app->getMenu(true);		// Handle an empty URL (special case)		if (!$uri->getVar('Itemid') && !$uri->getVar('option'))		{			$item = $menu->getDefault(JFactory::getLanguage()->getTag());			if (!is_object($item))			{				// No default item set				return $vars;			}			// Set the information in the request			$vars = $item->query;			// Get the itemid			$vars['Itemid'] = $item->id;			// Set the active menu item			$menu->setActive($vars['Itemid']);			return $vars;		}		// Get the variables from the uri		$this->setVars($uri->getQuery(true));		// Get the itemid, if it hasn't been set force it to null		$this->setVar('Itemid', $app->input->getInt('Itemid', null));		// Only an Itemid  OR if filter language plugin set? Get the full information from the itemid		if (count($this->getVars()) == 1 || ($app->getLanguageFilter() && count($this->getVars()) == 2 ))		{			$item = $menu->getItem($this->getVar('Itemid'));			if ($item !== null && is_array($item->query))			{				$vars = $vars + $item->query;			}		}		// Set the active menu item		$menu->setActive($this->getVar('Itemid'));		return $vars;	}	/**	 * Function to convert a sef route to an internal URI	 *	 * @param   JURI  $uri  The sef URI	 *	 * @return  string  Internal URI	 */	protected function _parseSefRoute($uri)	{		$vars  = array();		$app   = JApplication::getInstance('site');		$menu  = $app->getMenu(true);		$route = $uri->getPath();		// Remove the suffix		if ($this->_mode == JROUTER_MODE_SEF)		{			if ($app->getCfg('sef_suffix'))			{				if ($suffix = pathinfo($route, PATHINFO_EXTENSION))				{					$route = str_replace('.' . $suffix, '', $route);				}			}		}		// Get the variables from the uri		$vars = $uri->getQuery(true);		// Handle an empty URL (special case)		if (empty($route))		{			// If route is empty AND option is set in the query, assume it's non-sef url, and parse apropriately			if (isset($vars['option']) || isset($vars['Itemid']))			{				return $this->_parseRawRoute($uri);			}			$item = $menu->getDefault(JFactory::getLanguage()->getTag());			// If user not allowed to see default menu item then avoid notices			if (is_object($item))			{				// Set the information in the request				$vars = $item->query;				// Get the itemid				$vars['Itemid'] = $item->id;				// Set the active menu item				$menu->setActive($vars['Itemid']);			}			return $vars;		}		/*		 * Parse the application route		 */		$segments	= explode('/', $route);		if (count($segments) > 1 && $segments[0] == 'component')		{			$vars['option'] = 'com_' . $segments[1];			$vars['Itemid'] = null;			$route = implode('/', array_slice($segments, 2));		}		else		{			// Need to reverse the array (highest sublevels first)			$items = array_reverse($menu->getMenu());			$found 				= false;			$route_lowercase 	= JString::strtolower($route);			$lang_tag 			= JFactory::getLanguage()->getTag();			foreach ($items as $item)			{				// Sqlsrv change				if (isset($item->language))				{					$item->language = trim($item->language);				}				// Get the length of the route				$length = strlen($item->route);				if ($length > 0 && JString::strpos($route_lowercase . '/', $item->route . '/') === 0					&& $item->type != 'menulink' && (!$app->getLanguageFilter() || $item->language == '*'					|| $item->language == $lang_tag))				{					// We have exact item for this language					if ($item->language == $lang_tag)					{						$found = $item;						break;					}					// Or let's remember an item for all languages					elseif (!$found)					{						$found = $item;					}				}			}			if (!$found)			{				$found = $menu->getDefault($lang_tag);			}			else			{				$route = substr($route, strlen($found->route));				if ($route)				{					$route = substr($route, 1);				}			}			$vars['Itemid'] = $found->id;			$vars['option'] = $found->component;		}		// Set the active menu item		if (isset($vars['Itemid']))		{			$menu->setActive($vars['Itemid']);		}		// Set the variables		$this->setVars($vars);		/*		 * Parse the component route		 */		if (!empty($route) && isset($this->_vars['option']))		{			$segments = explode('/', $route);			if (empty($segments[0]))			{				array_shift($segments);			}			// Handle component	route			$component = preg_replace('/[^A-Z0-9_\.-]/i', '', $this->_vars['option']);			// Use the component routing handler if it exists			$path = JPATH_SITE . '/components/' . $component . '/router.php';			if (file_exists($path) && count($segments))			{				// Cheap fix on searches				if ($component != "com_search")				{					// Decode the route segments					$segments = $this->_decodeSegments($segments);				}				else				{					// Fix up search for URL					$total = count($segments);					for ($i = 0; $i < $total; $i++)					{						// Urldecode twice because it is encoded twice						$segments[$i] = urldecode(urldecode(stripcslashes($segments[$i])));					}				}				require_once $path;				$function = substr($component, 4) . 'ParseRoute';				$function = str_replace(array("-", "."), "", $function);				$vars = $function($segments);				$this->setVars($vars);			}		}		else		{			// Set active menu item			if ($item = $menu->getActive())			{				$vars = $item->query;			}		}		return $vars;	}	/**	 * Function to build a raw route	 *	 * @param   JURI  $uri  The internal URL	 *	 * @return  string  Raw Route	 */	protected function _buildRawRoute($uri)	{	}	/**	 * Function to build a sef route	 *	 * @param   JURI  $uri  The uri	 *	 * @return  void	 */	protected function _buildSefRoute($uri)	{		// Get the route		$route = $uri->getPath();		// Get the query data		$query = $uri->getQuery(true);		if (!isset($query['option']))		{			return;		}		$app  = JApplication::getInstance('site');		$menu = $app->getMenu();		/*		 * Build the component route		 */		$component = preg_replace('/[^A-Z0-9_\.-]/i', '', $query['option']);		$tmp       = '';		$itemID    = !empty($query['Itemid']) ? $query['Itemid'] : null;		// Use the component routing handler if it exists		$path = JPATH_SITE . '/components/' . $component . '/router.php';		// Use the custom routing handler if it exists		if (file_exists($path) && !empty($query))		{			require_once $path;			$function = substr($component, 4) . 'BuildRoute';			$function = str_replace(array("-", "."), "", $function);			$parts    = $function($query);			// Encode the route segments			if ($component != 'com_search')			{				// Cheep fix on searches				$parts = $this->_encodeSegments($parts);			}			else			{				// Fix up search for URL				$total = count($parts);				for ($i = 0; $i < $total; $i++)				{					// Urlencode twice because it is decoded once after redirect					$parts[$i] = urlencode(urlencode(stripcslashes($parts[$i])));				}			}			$result = implode('/', $parts);			$tmp    = ($result != "") ? $result : '';		}		/*		 * Build the application route		 */		$built = false;		if (!empty($query['Itemid']))		{			$item = $menu->getItem($query['Itemid']);			if (is_object($item) && $query['option'] == $item->component)			{				if (!$item->home || $item->language != '*')				{					$tmp = !empty($tmp) ? $item->route . '/' . $tmp : $item->route;				}				$built = true;			}		}		if (empty($query['Itemid']) && !empty($itemID))		{			$query['Itemid'] = $itemID;		}		if (!$built)		{			$tmp = 'component/' . substr($query['option'], 4) . '/' . $tmp;		}		if ($tmp)		{			$route .= '/' . $tmp;		}		elseif ($route == 'index.php')		{			$route = '';		}		// Unset unneeded query information		if (isset($item) && $query['option'] == $item->component)		{			unset($query['Itemid']);		}		unset($query['option']);		// Set query again in the URI		$uri->setQuery($query);		$uri->setPath($route);	}	/**	 * Process the parsed router variables based on custom defined rules	 *	 * @param   JURI  $uri  The URI to parse	 *	 * @return  array  The array of processed URI variables	 */	protected function _processParseRules($uri)	{		// Process the attached parse rules		$vars = parent::_processParseRules($uri);		// Process the pagination support		if ($this->_mode == JROUTER_MODE_SEF)		{			if ($start = $uri->getVar('start'))			{				$uri->delVar('start');				$vars['limitstart'] = $start;			}		}		return $vars;	}	/**	 * Process the build uri query data based on custom defined rules	 *	 * @param   JURI  $uri  The URI	 *	 * @return  void	 */	protected function _processBuildRules($uri)	{		// Make sure any menu vars are used if no others are specified		if (($this->_mode != JROUTER_MODE_SEF) && $uri->getVar('Itemid') && count($uri->getQuery(true)) == 2)		{			$app  = JApplication::getInstance('site');			$menu = $app->getMenu();			// Get the active menu item			$itemid = $uri->getVar('Itemid');			$item = $menu->getItem($itemid);			if ($item)			{				$uri->setQuery($item->query);			}			$uri->setVar('Itemid', $itemid);		}		// Process the attached build rules		parent::_processBuildRules($uri);		// Get the path data		$route = $uri->getPath();		if ($this->_mode == JROUTER_MODE_SEF && $route)		{			$app = JApplication::getInstance('site');			if ($limitstart = $uri->getVar('limitstart'))			{				$uri->setVar('start', (int) $limitstart);				$uri->delVar('limitstart');			}		}		$uri->setPath($route);	}	/**	 * Create a uri based on a full or partial url string	 *	 * @param   string  $url  The URI	 *	 * @return  JURI	 */	protected function _createURI($url)	{		// Create the URI		$uri = parent::_createURI($url);		// Set URI defaults		$app  = JApplication::getInstance('site');		$menu = $app->getMenu();		// Get the itemid form the URI		$itemid = $uri->getVar('Itemid');		if (is_null($itemid))		{			if ($option = $uri->getVar('option'))			{				$item  = $menu->getItem($this->getVar('Itemid'));				if (isset($item) && $item->component == $option)				{					$uri->setVar('Itemid', $item->id);				}			}			else			{				if ($option = $this->getVar('option'))				{					$uri->setVar('option', $option);				}				if ($itemid = $this->getVar('Itemid'))				{					$uri->setVar('Itemid', $itemid);				}			}		}		else		{			if (!$uri->getVar('option'))			{				if ($item = $menu->getItem($itemid))				{					$uri->setVar('option', $item->component);				}			}		}		return $uri;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Updater * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.base.adapterinstance');/** * UpdateAdapter class. * * @package     Joomla.Platform * @subpackage  Updater * @since       11.1 */class JUpdateAdapter extends JAdapterInstance{	/**	 * @var    resource	 * @since  12.1	 */	protected $xmlParser;	/**	 * @var    array	 * @since  12.1	 */	protected $stack = array('base');	/**	 * ID of update site	 *	 * @var    string	 * @since  12.1	 */	protected $updateSiteId = 0;	/**	 * Columns in the extensions table to be updated	 *	 * @var    array	 * @since  12.1	 */	protected $updatecols = array('NAME', 'ELEMENT', 'TYPE', 'FOLDER', 'CLIENT', 'VERSION', 'DESCRIPTION', 'INFOURL');	/**	 * Gets the reference to the current direct parent	 *	 * @return  object	 *	 * @since   11.1	 */	protected function _getStackLocation()	{		return implode('->', $this->stack);	}	/**	 * Gets the reference to the last tag	 *	 * @return  object	 *	 * @since   11.1	 */	protected function _getLastTag()	{		return $this->stack[count($this->stack) - 1];	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_redirect * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Redirect link model. * * @package     Joomla.Administrator * @subpackage  com_redirect * @since       1.6 */class RedirectModelLink extends JModelAdmin{	/**	 * @var        string    The prefix to use with controller messages.	 * @since   1.6	 */	protected $text_prefix = 'COM_REDIRECT';	/**	 * Method to test whether a record can be deleted.	 *	 * @param   object    $record    A record object.	 *	 * @return  boolean  True if allowed to delete the record. Defaults to the permission set in the component.	 * @since   1.6	 */	protected function canDelete($record)	{		if ($record->published != -2)		{			return false;		}		$user = JFactory::getUser();		return $user->authorise('core.admin', 'com_redirect');	}	/**	 * Method to test whether a record can have its state edited.	 *	 * @param   object    $record    A record object.	 *	 * @return  boolean  True if allowed to change the state of the record. Defaults to the permission set in the component.	 * @since   1.6	 */	protected function canEditState($record)	{		$user = JFactory::getUser();		// Check the component since there are no categories or other assets.		return $user->authorise('core.admin', 'com_redirect');	}	/**	 * Returns a reference to the a Table object, always creating it.	 *	 * @param   type      The table type to instantiate	 * @param   string    A prefix for the table class name. Optional.	 * @param   array     Configuration array for model. Optional.	 * @return  JTable    A database object	 * @since   1.6	 */	public function getTable($type = 'Link', $prefix = 'RedirectTable', $config = array())	{		return JTable::getInstance($type, $prefix, $config);	}	/**	 * Method to get the record form.	 *	 * @param   array      $data        Data for the form.	 * @param   boolean    $loadData    True if the form is to load its own data (default case), false if not.	 * @return  JForm    A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_redirect.link', 'link', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		// Modify the form based on access controls.		if ($this->canEditState((object) $data) != true)		{			// Disable fields for display.			$form->setFieldAttribute('published', 'disabled', 'true');			// Disable fields while saving.			// The controller has already verified this is a record you can edit.			$form->setFieldAttribute('published', 'filter', 'unset');		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_redirect.edit.link.data', array());		if (empty($data))		{			$data = $this->getItem();		}		$this->preprocessData('com_redirect.link', $data);		return $data;	}	/**	 * Method to activate links.	 *	 * @param   array     An array of link ids.	 * @param   string    The new URL to set for the redirect.	 * @param   string    A comment for the redirect links.	 * @return  boolean  Returns true on success, false on failure.	 * @since   1.6	 */	public function activate(&$pks, $url, $comment = null)	{		$user = JFactory::getUser();		$db = $this->getDbo();		// Sanitize the ids.		$pks = (array) $pks;		JArrayHelper::toInteger($pks);		// Populate default comment if necessary.		$comment = (!empty($comment)) ? $comment : JText::sprintf('COM_REDIRECT_REDIRECTED_ON', JHtml::_('date', time()));		// Access checks.		if (!$user->authorise('core.admin', 'com_redirect'))		{			$pks = array();			$this->setError(JText::_('JLIB_APPLICATION_ERROR_EDIT_NOT_PERMITTED'));			return false;		}		if (!empty($pks))		{			// Update the link rows.			$query = $db->getQuery(true)				->update($db->quoteName('#__redirect_links'))				->set($db->quoteName('new_url') . ' = ' . $db->quote($url))				->set($db->quoteName('published') . ' = ' . $db->quote(1))				->set($db->quoteName('comment') . ' = ' . $db->quote($comment))				->where($db->quoteName('id') . ' IN (' . implode(',', $pks) . ')');			$db->setQuery($query);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				$this->setError($e->getMessage());				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Search feed view class for the Finder package. * * @package     Joomla.Site * @subpackage  com_finder * @since       2.5 */class FinderViewSearch extends JViewLegacy{	/**	 * Method to display the view.	 *	 * @param   string  $tpl  A template file to load. [optional]	 *	 * @return  mixed  JError object on failure, void on success.	 *	 * @since   2.5	 */	public function display($tpl = null)	{		// Get the application		$app = JFactory::getApplication();		// Adjust the list limit to the feed limit.		$app->input->set('limit', $app->getCfg('feed_limit'));		// Get view data.		$state = $this->get('State');		$params = $state->get('params');		$query = $this->get('Query');		$results = $this->get('Results');		// Push out the query data.		JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');		$explained = JHtml::_('query.explained', $query);		// Set the document title.		$title = $params->get('page_title', '');		if (empty($title))		{			$title = $app->getCfg('sitename');		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		// Configure the document description.		if (!empty($explained))		{			$this->document->setDescription(html_entity_decode(strip_tags($explained), ENT_QUOTES, 'UTF-8'));		}		// Set the document link.		$this->document->link = JRoute::_($query->toURI());		// If we don't have any results, we are done.		if (empty($results))		{			return;		}		// Convert the results to feed entries.		foreach ($results as $result)		{			// Convert the result to a feed entry.			$item = new JFeedItem;			$item->title = $result->title;			$item->link = JRoute::_($result->route);			$item->description = $result->description;			$item->date = (int) $result->start_date ? JHtml::date($result->start_date, 'l d F Y') : $result->indexdate;			// Get the taxonomy data.			$taxonomy = $result->getTaxonomy();			// Add the category to the feed if available.			if (isset($taxonomy['Category']))			{				$node = array_pop($taxonomy['Category']);				$item->category = $node->title;			}			// loads item info into rss array			$this->document->addItem($item);		}	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Menu * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * JMenu class * * @package     Joomla.Libraries * @subpackage  Menu * @since       1.5 */class JMenuSite extends JMenu{	/**	 * Loads the entire menu table into memory.	 *	 * @return  array	 */	public function load()	{		$db    = JFactory::getDbo();		$query = $db->getQuery(true)			->select('m.id, m.menutype, m.title, m.alias, m.note, m.path AS route, m.link, m.type, m.level, m.language')			->select($db->quoteName('m.browserNav') . ', m.access, m.params, m.home, m.img, m.template_style_id, m.component_id, m.parent_id')			->select('e.element as component')			->from('#__menu AS m')			->join('LEFT', '#__extensions AS e ON m.component_id = e.extension_id')			->where('m.published = 1')			->where('m.parent_id > 0')			->where('m.client_id = 0')			->order('m.lft');		// Set the query		$db->setQuery($query);		try		{			$this->_items = $db->loadObjectList('id');		}		catch (RuntimeException $e)		{			JError::raiseWarning(500, JText::sprintf('JERROR_LOADING_MENUS', $e->getMessage()));			return false;		}		foreach ($this->_items as &$item)		{			// Get parent information.			$parent_tree = array();			if (isset($this->_items[$item->parent_id]))			{				$parent_tree  = $this->_items[$item->parent_id]->tree;			}			// Create tree.			$parent_tree[] = $item->id;			$item->tree = $parent_tree;			// Create the query array.			$url = str_replace('index.php?', '', $item->link);			$url = str_replace('&amp;', '&', $url);			parse_str($url, $item->query);		}	}	/**	 * Gets menu items by attribute	 *	 * @param   string   $attributes  The field name	 * @param   string   $values      The value of the field	 * @param   boolean  $firstonly   If true, only returns the first item found	 *	 * @return  array	 */	public function getItems($attributes, $values, $firstonly = false)	{		$attributes = (array) $attributes;		$values 	= (array) $values;		$app		= JApplication::getInstance('site');		if ($app->isSite())		{			// Filter by language if not set			if (($key = array_search('language', $attributes)) === false)			{				if (JLanguageMultilang::isEnabled())				{					$attributes[] 	= 'language';					$values[] 		= array(JFactory::getLanguage()->getTag(), '*');				}			}			elseif ($values[$key] === null)			{				unset($attributes[$key]);				unset($values[$key]);			}			// Filter by access level if not set			if (($key = array_search('access', $attributes)) === false)			{				$attributes[] = 'access';				$values[] = JFactory::getUser()->getAuthorisedViewLevels();			}			elseif ($values[$key] === null)			{				unset($attributes[$key]);				unset($values[$key]);			}		}		// Reset arrays or we get a notice if some values were unset		$attributes = array_values($attributes);		$values = array_values($values);		return parent::getItems($attributes, $values, $firstonly);	}	/**	 * Get menu item by id	 *	 * @param   string  $language  The language code.	 *	 * @return  object  The item object	 *	 * @since   1.5	 */	public function getDefault($language = '*')	{		if (array_key_exists($language, $this->_default) && JApplication::getInstance('site')->getLanguageFilter())		{			return $this->_items[$this->_default[$language]];		}		elseif (array_key_exists('*', $this->_default))		{			return $this->_items[$this->_default['*']];		}		else		{			return 0;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$published = $this->state->get('filter.published');?><div class="modal hide fade" id="collapseModal">	<div class="modal-header">		<button type="button" class="close" data-dismiss="modal">x</button>		<h3><?php echo JText::_('COM_TAGS_BATCH_OPTIONS');?></h3>	</div>	<div class="modal-body">		<p><?php echo JText::_('COM_TAGS_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.access'); ?>			</div>		</div>	<div class="modal-body">		<p><?php echo JText::_('COM_TAGS_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.language'); ?>			</div>		</div>	</div>	<div class="modal-footer">		<button class="btn" type="button" onclick="document.id('batch-tag-id').value='';document.id('batch-client-id').value='';document.id('batch-access').value='';document.id('batch-language-id').value=''" data-dismiss="modal">			<?php echo JText::_('JCANCEL'); ?>		</button>		<button class="btn btn-primary" type="submit" onclick="Joomla.submitbutton('tag.batch');">			<?php echo JText::_('JGLOBAL_BATCH_PROCESS'); ?>		</button>		</button>	</div></div>
<?php/** * @package     Joomla.Legacy * @subpackage  Model * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Prototype form model. * * @package     Joomla.Legacy * @subpackage  Model * @see         JForm * @see         JFormField * @see         JFormRule * @since       12.2 */abstract class JModelForm extends JModelLegacy{	/**	 * Array of form objects.	 *	 * @var    array	 * @since  12.2	 */	protected $_forms = array();	/**	 * Method to checkin a row.	 *	 * @param   integer  $pk  The numeric id of the primary key.	 *	 * @return  boolean  False on failure or error, true otherwise.	 *	 * @since   12.2	 */	public function checkin($pk = null)	{		// Only attempt to check the row in if it exists.		if ($pk)		{			$user = JFactory::getUser();			// Get an instance of the row to checkin.			$table = $this->getTable();			if (!$table->load($pk))			{				$this->setError($table->getError());				return false;			}			// Check if this is the user having previously checked out the row.			if ($table->checked_out > 0 && $table->checked_out != $user->get('id') && !$user->authorise('core.admin', 'com_checkin'))			{				$this->setError(JText::_('JLIB_APPLICATION_ERROR_CHECKIN_USER_MISMATCH'));				return false;			}			// Attempt to check the row in.			if (!$table->checkin($pk))			{				$this->setError($table->getError());				return false;			}		}		return true;	}	/**	 * Method to check-out a row for editing.	 *	 * @param   integer  $pk  The numeric id of the primary key.	 *	 * @return  boolean  False on failure or error, true otherwise.	 *	 * @since   12.2	 */	public function checkout($pk = null)	{		// Only attempt to check the row in if it exists.		if ($pk)		{			$user = JFactory::getUser();			// Get an instance of the row to checkout.			$table = $this->getTable();			if (!$table->load($pk))			{				$this->setError($table->getError());				return false;			}			// Check if this is the user having previously checked out the row.			if ($table->checked_out > 0 && $table->checked_out != $user->get('id'))			{				$this->setError(JText::_('JLIB_APPLICATION_ERROR_CHECKOUT_USER_MISMATCH'));				return false;			}			// Attempt to check the row out.			if (!$table->checkout($user->get('id'), $pk))			{				$this->setError($table->getError());				return false;			}		}		return true;	}	/**	 * Abstract method for getting the form from the model.	 *	 * @param   array    $data      Data for the form.	 * @param   boolean  $loadData  True if the form is to load its own data (default case), false if not.	 *	 * @return  mixed  A JForm object on success, false on failure	 *	 * @since   12.2	 */	abstract public function getForm($data = array(), $loadData = true);	/**	 * Method to get a form object.	 *	 * @param   string   $name     The name of the form.	 * @param   string   $source   The form source. Can be XML string if file flag is set to false.	 * @param   array    $options  Optional array of options for the form creation.	 * @param   boolean  $clear    Optional argument to force load a new form.	 * @param   string   $xpath    An optional xpath to search for the fields.	 *	 * @return  mixed  JForm object on success, False on error.	 *	 * @see     JForm	 * @since   12.2	 */	protected function loadForm($name, $source = null, $options = array(), $clear = false, $xpath = false)	{		// Handle the optional arguments.		$options['control'] = JArrayHelper::getValue($options, 'control', false);		// Create a signature hash.		$hash = md5($source . serialize($options));		// Check if we can use a previously loaded form.		if (isset($this->_forms[$hash]) && !$clear)		{			return $this->_forms[$hash];		}		// Get the form.		JForm::addFormPath(JPATH_COMPONENT . '/models/forms');		JForm::addFieldPath(JPATH_COMPONENT . '/models/fields');		try		{			$form = JForm::getInstance($name, $source, $options, false, $xpath);			if (isset($options['load_data']) && $options['load_data'])			{				// Get the data for the form.				$data = $this->loadFormData();			}			else			{				$data = array();			}			// Allow for additional modification of the form, and events to be triggered.			// We pass the data because plugins may require it.			$this->preprocessForm($form, $data);			// Load the data into the form after the plugins have operated.			$form->bind($data);		}		catch (Exception $e)		{			$this->setError($e->getMessage());			return false;		}		// Store the form for later.		$this->_forms[$hash] = $form;		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  array    The default data is an empty array.	 *	 * @since   12.2	 */	protected function loadFormData()	{		return array();	}	/**	 * Method to allow derived classes to preprocess the data.	 *	 * @param   string  $context  The context identifier.	 * @param   mixed   &$data    The data to be processed. It gets altered directly.	 *	 * @return  void	 *	 * @since   3.1	 */	protected function preprocessData($context, &$data)	{		// Get the dispatcher and load the users plugins.		$dispatcher = JEventDispatcher::getInstance();		JPluginHelper::importPlugin('content');		// Trigger the data preparation event.		$results = $dispatcher->trigger('onContentPrepareData', array($context, $data));		// Check for errors encountered while preparing the data.		if (count($results) > 0 && in_array(false, $results, true))		{			$this->setError($dispatcher->getError());		}	}	/**	 * Method to allow derived classes to preprocess the form.	 *	 * @param   JForm   $form   A JForm object.	 * @param   mixed   $data   The data expected for the form.	 * @param   string  $group  The name of the plugin group to import (defaults to "content").	 *	 * @return  void	 *	 * @see     JFormField	 * @since   12.2	 * @throws  Exception if there is an error in the form event.	 */	protected function preprocessForm(JForm $form, $data, $group = 'content')	{		// Import the appropriate plugin group.		JPluginHelper::importPlugin($group);		// Get the dispatcher.		$dispatcher = JEventDispatcher::getInstance();		// Trigger the form preparation event.		$results = $dispatcher->trigger('onContentPrepareForm', array($form, $data));		// Check for errors encountered while preparing the form.		if (count($results) && in_array(false, $results, true))		{			// Get the last error.			$error = $dispatcher->getError();			if (!($error instanceof Exception))			{				throw new Exception($error);			}		}	}	/**	 * Method to validate the form data.	 *	 * @param   JForm   $form   The form to validate against.	 * @param   array   $data   The data to validate.	 * @param   string  $group  The name of the field group to validate.	 *	 * @return  mixed  Array of filtered data if valid, false otherwise.	 *	 * @see     JFormRule	 * @see     JFilterInput	 * @since   12.2	 */	public function validate($form, $data, $group = null)	{		// Filter and validate the form data.		$data = $form->filter($data);		$return = $form->validate($data, $group);		// Check for an error.		if ($return instanceof Exception)		{			$this->setError($return->getMessage());			return false;		}		// Check the validation results.		if ($return === false)		{			// Get the validation messages from the form.			foreach ($form->getErrors() as $message)			{				$this->setError($message);			}			return false;		}		return $data;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;JFormHelper::loadFieldClass('list');/** * Form Field class for the Joomla Framework. * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class JFormFieldMenuOrdering extends JFormFieldList{	/**	 * The form field type.	 *	 * @var        string	 * @since   1.7	 */	protected $type = 'MenuOrdering';	/**	 * Method to get the list of siblings in a menu.	 * The method requires that parent be set.	 *	 * @return  array  The field option objects or false if the parent field has not been set	 * @since   1.7	 */	protected function getOptions()	{		$options = array();		// Get the parent		$parent_id = $this->form->getValue('parent_id', 0);		if (empty($parent_id))		{			return false;		}		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('a.id AS value, a.title AS text')			->from('#__menu AS a')			->where('a.published >= 0')			->where('a.parent_id =' . (int) $parent_id);		if ($menuType = $this->form->getValue('menutype'))		{			$query->where('a.menutype = ' . $db->quote($menuType));		}		else		{			$query->where('a.menutype != ' . $db->quote(''));		}		$query->order('a.lft ASC');		// Get the options.		$db->setQuery($query);		try		{			$options = $db->loadObjectList();		}		catch (RuntimeException $e)		{			JError::raiseWarning(500, $e->getMessage());		}		$options = array_merge(			array(array('value' => '-1', 'text' => JText::_('COM_MENUS_ITEM_FIELD_ORDERING_VALUE_FIRST'))),			$options,			array(array('value' => '-2', 'text' => JText::_('COM_MENUS_ITEM_FIELD_ORDERING_VALUE_LAST')))		);		// Merge any additional options in the XML definition.		$options = array_merge(parent::getOptions(), $options);		return $options;	}	/**	 * Method to get the field input markup	 *	 * @return  string  The field input markup.	 * @since   1.7	 */	protected function getInput()	{		if ($this->form->getValue('id', 0) == 0)		{			return '<span class="readonly">' . JText::_('COM_MENUS_ITEM_FIELD_ORDERING_TEXT') . '</span>';		}		else		{			return parent::getInput();		}	}}
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * marker_class: Class based on the selection of text, none, or icons * jicon-text, jicon-none, jicon-icon */?><dl class="contact-address dl-horizontal">	<?php if (($this->params->get('address_check') > 0) &&		($this->contact->address || $this->contact->suburb  || $this->contact->state || $this->contact->country || $this->contact->postcode)) : ?>		<?php if ($this->params->get('address_check') > 0) : ?>			<dt>				<span class="<?php echo $this->params->get('marker_class'); ?>" >					<?php echo $this->params->get('marker_address'); ?>				</span>			</dt>		<?php endif; ?>		<?php if ($this->contact->address && $this->params->get('show_street_address')) : ?>			<dd>				<span class="contact-street">					<?php echo $this->contact->address .'<br/>'; ?>				</span>			</dd>		<?php endif; ?>		<?php if ($this->contact->suburb && $this->params->get('show_suburb')) : ?>			<dd>				<span class="contact-suburb">					<?php echo $this->contact->suburb .'<br/>'; ?>				</span>			</dd>		<?php endif; ?>		<?php if ($this->contact->state && $this->params->get('show_state')) : ?>			<dd>				<span class="contact-state">					<?php echo $this->contact->state . '<br/>'; ?>				</span>			</dd>		<?php endif; ?>		<?php if ($this->contact->postcode && $this->params->get('show_postcode')) : ?>			<dd>				<span class="contact-postcode">					<?php echo $this->contact->postcode .'<br/>'; ?>				</span>			</dd>		<?php endif; ?>		<?php if ($this->contact->country && $this->params->get('show_country')) : ?>		<dd>			<span class="contact-country">				<?php echo $this->contact->country .'<br/>'; ?>			</span>		</dd>		<?php endif; ?>	<?php endif; ?><?php if ($this->contact->email_to && $this->params->get('show_email')) : ?>	<dt>		<span class="<?php echo $this->params->get('marker_class'); ?>" >			<?php echo nl2br($this->params->get('marker_email')); ?>		</span>	</dt>	<dd>		<span class="contact-emailto">			<?php echo $this->contact->email_to; ?>		</span>	</dd><?php endif; ?><?php if ($this->contact->telephone && $this->params->get('show_telephone')) : ?>	<dt>		<span class="<?php echo $this->params->get('marker_class'); ?>" >			<?php echo $this->params->get('marker_telephone'); ?>		</span>	</dt>	<dd>		<span class="contact-telephone">			<?php echo nl2br($this->contact->telephone); ?>		</span>	</dd><?php endif; ?><?php if ($this->contact->fax && $this->params->get('show_fax')) : ?>	<dt>		<span class="<?php echo $this->params->get('marker_class'); ?>" >			<?php echo $this->params->get('marker_fax'); ?>		</span>	</dt>	<dd>		<span class="contact-fax">		<?php echo nl2br($this->contact->fax); ?>		</span>	</dd><?php endif; ?><?php if ($this->contact->mobile && $this->params->get('show_mobile')) :?>	<dt>		<span class="<?php echo $this->params->get('marker_class'); ?>" >			<?php echo $this->params->get('marker_mobile'); ?>		</span>	</dt>	<dd>		<span class="contact-mobile">			<?php echo nl2br($this->contact->mobile); ?>		</span>	</dd><?php endif; ?><?php if ($this->contact->webpage && $this->params->get('show_webpage')) : ?>	<dt>		<span class="<?php echo $this->params->get('marker_class'); ?>" >		</span>	</dt>	<dd>		<span class="contact-webpage">			<a href="<?php echo $this->contact->webpage; ?>" target="_blank">			<?php echo $this->contact->webpage; ?></a>		</span>	</dd><?php endif; ?></dl>
<?php/** * @package     Joomla.Platform * @subpackage  Facebook * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Joomla Platform class for generating Facebook API access token. * * @package     Joomla.Platform * @subpackage  Facebook * * @since       13.1 */class JFacebookOAuth extends JOAuth2Client{	/**	 * @var JRegistry Options for the JFacebookOAuth object.	 * @since 13.1	 */	protected $options;	/**	 * Constructor.	 *	 * @param   JRegistry  $options  JFacebookOauth options object.	 * @param   JHttp      $client   The HTTP client object.	 * @param   JInput     $input    The input object.	 *	 * @since   13.1	 */	public function __construct(JRegistry $options = null, JHttp $client = null, JInput $input = null)	{		$this->options = isset($options) ? $options : new JRegistry;		// Setup the authentication and token urls if not already set.		$this->options->def('authurl', 'http://www.facebook.com/dialog/oauth');		$this->options->def('tokenurl', 'https://graph.facebook.com/oauth/access_token');		// Call the JOauthOauth2client constructor to setup the object.		parent::__construct($this->options, $client, $input);	}	/**	 * Method used to set permissions.	 *	 * @param   string  $scope  Comma separated list of permissions.	 *	 * @return  JFacebookOauth  This object for method chaining	 *	 * @since   13.1	 */	public function setScope($scope)	{		$this->setOption('scope', $scope);		return $this;	}	/**	 * Method to get the current scope	 *	 * @return  string Comma separated list of permissions.	 *	 * @since   13.1	 */	public function getScope()	{		return $this->getOption('scope');	}}
<?php/** * @package     Joomla.Site * @subpackage  Layout * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Create a shortcut for params.$params = $displayData->params;$canEdit = $displayData->params->get('access-edit');JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.framework');?>	<?php if ($params->get('show_title') || $displayData->state == 0 || ($params->get('show_author') && !empty($displayData->author ))) : ?>		<div class="page-header">			<?php if ($params->get('show_title')) : ?>				<h2>					<?php if ($params->get('link_titles') && $params->get('access-view')) : ?>						<a href="<?php echo JRoute::_(ContentHelperRoute::getArticleRoute($displayData->slug, $displayData->catid)); ?>">						<?php echo $this->escape($displayData->title); ?></a>					<?php else : ?>						<?php echo $this->escape($displayData->title); ?>					<?php endif; ?>				</h2>			<?php endif; ?>			<?php if ($displayData->state == 0) : ?>				<span class="label label-warning"><?php echo JText::_('JUNPUBLISHED'); ?></span>			<?php endif; ?>		</div>	<?php endif; ?>
<?php/** * @package     Joomla.Administrator * @subpackage  mod_menu * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/* @var $menu JAdminCSSMenu */$shownew = (boolean) $params->get('shownew', 1);$showhelp = $params->get('showhelp', 1);$user = JFactory::getUser();$lang = JFactory::getLanguage();//// Site SubMenu//$menu->addChild(	new JMenuNode(JText::_('MOD_MENU_SYSTEM'), '#'), true);$menu->addChild(	new JMenuNode(JText::_('MOD_MENU_CONTROL_PANEL'), 'index.php', 'class:cpanel'));$menu->addSeparator();if ($user->authorise('core.admin')){	$menu->addChild(new JMenuNode(JText::_('MOD_MENU_CONFIGURATION'), 'index.php?option=com_config', 'class:config'));	$menu->addSeparator();}$chm = $user->authorise('core.admin', 'com_checkin');$cam = $user->authorise('core.manage', 'com_cache');if ($chm || $cam ){	// Keep this for when bootstrap supports submenus?	/* $menu->addChild(		new JMenuNode(JText::_('MOD_MENU_MAINTENANCE'), 'index.php?option=com_checkin', 'class:maintenance'), true	);*/	if ($chm)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_GLOBAL_CHECKIN'), 'index.php?option=com_checkin', 'class:checkin'));		$menu->addSeparator();	}	if ($cam)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_CLEAR_CACHE'), 'index.php?option=com_cache', 'class:clear'));		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_PURGE_EXPIRED_CACHE'), 'index.php?option=com_cache&view=purge', 'class:purge'));	}	//$menu->getParent();}$menu->addSeparator();if ($user->authorise('core.admin')){	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_SYSTEM_INFORMATION'), 'index.php?option=com_admin&view=sysinfo', 'class:info')	);}$menu->getParent();//// Users Submenu//if ($user->authorise('core.manage', 'com_users')){	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_USERS_USERS'), '#'), true	);	$createUser = $shownew && $user->authorise('core.create', 'com_users');	$createGrp = $user->authorise('core.admin', 'com_users');	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_USERS_USER_MANAGER'), 'index.php?option=com_users&view=users', 'class:user'), $createUser	);	if ($createUser)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_USERS_ADD_USER'), 'index.php?option=com_users&task=user.add', 'class:newarticle')		);		$menu->getParent();	}	if ($createGrp)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_USERS_GROUPS'), 'index.php?option=com_users&view=groups', 'class:groups'), $createUser		);		if ($createUser)		{			$menu->addChild(				new JMenuNode(JText::_('MOD_MENU_COM_USERS_ADD_GROUP'), 'index.php?option=com_users&task=group.add', 'class:newarticle')			);			$menu->getParent();		}		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_USERS_LEVELS'), 'index.php?option=com_users&view=levels', 'class:levels'), $createUser		);		if ($createUser)		{			$menu->addChild(				new JMenuNode(JText::_('MOD_MENU_COM_USERS_ADD_LEVEL'), 'index.php?option=com_users&task=level.add', 'class:newarticle')			);			$menu->getParent();		}	}	$menu->addSeparator();	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_USERS_NOTES'), 'index.php?option=com_users&view=notes', 'class:user-note'), $createUser	);	if ($createUser)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_USERS_ADD_NOTE'), 'index.php?option=com_users&task=note.add', 'class:newarticle')		);		$menu->getParent();	}	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_USERS_NOTE_CATEGORIES'), 'index.php?option=com_categories&view=categories&extension=com_users', 'class:category'), $createUser	);	if ($createUser)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_CONTENT_NEW_CATEGORY'), 'index.php?option=com_categories&task=category.add&extension=com_users.notes', 'class:newarticle')		);		$menu->getParent();	}	$menu->addSeparator();	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_MASS_MAIL_USERS'), 'index.php?option=com_users&view=mail', 'class:massmail')	);	$menu->getParent();}//// Menus Submenu//if ($user->authorise('core.manage', 'com_menus')){	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_MENUS'), '#'), true	);	$createMenu = $shownew && $user->authorise('core.create', 'com_menus');	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_MENU_MANAGER'), 'index.php?option=com_menus&view=menus', 'class:menumgr'), $createMenu	);	if ($createMenu)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_MENU_MANAGER_NEW_MENU'), 'index.php?option=com_menus&view=menu&layout=edit', 'class:newarticle')		);		$menu->getParent();	}	$menu->addSeparator();	// Menu Types	foreach (ModMenuHelper::getMenus() as $menuType)	{		$alt = '*' .$menuType->sef. '*';		if ($menuType->home == 0)		{			$titleicon = '';		}		elseif ($menuType->home == 1 && $menuType->language == '*')		{			$titleicon = ' <i class="icon-home"></i>';		}		elseif ($menuType->home > 1)		{			$titleicon = ' <span>'.JHtml::_('image', 'mod_languages/icon-16-language.png', $menuType->home, array('title' => JText::_('MOD_MENU_HOME_MULTIPLE')), true).'</span>';		}		else		{			$image = JHtml::_('image', 'mod_languages/'.$menuType->image.'.gif', null, null, true, true);			if (!$image)			{				$titleicon = ' <span>'.JHtml::_('image', 'mod_languages/icon-16-language.png', $alt, array('title' => $menuType->title_native), true).'</span>';			}			else			{				$titleicon = ' <span>' . JHtml::_('image', 'mod_languages/' . $menuType->image . '.gif', $alt, array('title' => $menuType->title_native), true) . '</span>';			}		}		$menu->addChild(			new JMenuNode($menuType->title,	'index.php?option=com_menus&view=items&menutype='.$menuType->menutype, 'class:menu', null, null, $titleicon), $createMenu		);		if ($createMenu)		{			$menu->addChild(				new JMenuNode(JText::_('MOD_MENU_MENU_MANAGER_NEW_MENU_ITEM'), 'index.php?option=com_menus&view=item&layout=edit&menutype='.$menuType->menutype, 'class:newarticle')			);			$menu->getParent();		}	}	$menu->getParent();}//// Content Submenu//if ($user->authorise('core.manage', 'com_content')){	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_CONTENT'), '#'), true	);	$createContent = $shownew && $user->authorise('core.create', 'com_content');	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_CONTENT_ARTICLE_MANAGER'), 'index.php?option=com_content', 'class:article'), $createContent	);	if ($createContent)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_CONTENT_NEW_ARTICLE'), 'index.php?option=com_content&task=article.add', 'class:newarticle')		);		$menu->getParent();	}	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_CONTENT_CATEGORY_MANAGER'), 'index.php?option=com_categories&extension=com_content', 'class:category'), $createContent	);	if ($createContent)	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_COM_CONTENT_NEW_CATEGORY'), 'index.php?option=com_categories&task=category.add&extension=com_content', 'class:newarticle')		);		$menu->getParent();	}	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_COM_CONTENT_FEATURED'), 'index.php?option=com_content&view=featured', 'class:featured')	);	$menu->addSeparator();	if ($user->authorise('core.manage', 'com_media'))	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_MEDIA_MANAGER'), 'index.php?option=com_media', 'class:media'));	}	$menu->getParent();}//// Components Submenu//// Get the authorised components and sub-menus.$components = ModMenuHelper::getComponents(true);// Check if there are any components, otherwise, don't render the menuif ($components){	$menu->addChild(new JMenuNode(JText::_('MOD_MENU_COMPONENTS'), '#'), true);	foreach ($components as &$component)	{		if (!empty($component->submenu))		{			// This component has a db driven submenu.			$menu->addChild(new JMenuNode($component->text, $component->link, $component->img), true);			foreach ($component->submenu as $sub)			{				$menu->addChild(new JMenuNode($sub->text, $sub->link, $sub->img));			}			$menu->getParent();		}		else		{			$menu->addChild(new JMenuNode($component->text, $component->link, $component->img));		}	}	$menu->getParent();}//// Extensions Submenu//$im = $user->authorise('core.manage', 'com_installer');$mm = $user->authorise('core.manage', 'com_modules');$pm = $user->authorise('core.manage', 'com_plugins');$tm = $user->authorise('core.manage', 'com_templates');$lm = $user->authorise('core.manage', 'com_languages');if ($im || $mm || $pm || $tm || $lm){	$menu->addChild(new JMenuNode(JText::_('MOD_MENU_EXTENSIONS_EXTENSIONS'), '#'), true);	if ($im)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_EXTENSIONS_EXTENSION_MANAGER'), 'index.php?option=com_installer', 'class:install'));		$menu->addSeparator();	}	if ($mm)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_EXTENSIONS_MODULE_MANAGER'), 'index.php?option=com_modules', 'class:module'));	}	if ($pm)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_EXTENSIONS_PLUGIN_MANAGER'), 'index.php?option=com_plugins', 'class:plugin'));	}	if ($tm)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_EXTENSIONS_TEMPLATE_MANAGER'), 'index.php?option=com_templates', 'class:themes'));	}	if ($lm)	{		$menu->addChild(new JMenuNode(JText::_('MOD_MENU_EXTENSIONS_LANGUAGE_MANAGER'), 'index.php?option=com_languages', 'class:language'));	}	$menu->getParent();}//// Help Submenu//if ($showhelp == 1){	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP'), '#'), true	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_JOOMLA'), 'index.php?option=com_admin&view=help', 'class:help')	);	$menu->addSeparator();	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_SUPPORT_OFFICIAL_FORUM'), 'http://forum.joomla.org', 'class:help-forum', false, '_blank')	);	if ($forum_url = $params->get('forum_url'))	{		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_HELP_SUPPORT_CUSTOM_FORUM'), $forum_url, 'class:help-forum', false, '_blank')		);	}	$debug = $lang->setDebug(false);	if ($lang->hasKey('MOD_MENU_HELP_SUPPORT_OFFICIAL_LANGUAGE_FORUM_VALUE') && JText::_('MOD_MENU_HELP_SUPPORT_OFFICIAL_LANGUAGE_FORUM_VALUE') != '')	{		$forum_url = 'http://forum.joomla.org/viewforum.php?f=' . (int) JText::_('MOD_MENU_HELP_SUPPORT_OFFICIAL_LANGUAGE_FORUM_VALUE');		$lang->setDebug($debug);		$menu->addChild(			new JMenuNode(JText::_('MOD_MENU_HELP_SUPPORT_OFFICIAL_LANGUAGE_FORUM'), $forum_url, 'class:help-forum', false, '_blank')		);	}	$lang->setDebug($debug);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_DOCUMENTATION'), 'http://docs.joomla.org', 'class:help-docs', false, '_blank')	);	$menu->addSeparator();	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_EXTENSIONS'), 'http://extensions.joomla.org', 'class:help-jed', false, '_blank')	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_TRANSLATIONS'), 'http://community.joomla.org/translations.html', 'class:help-trans', false, '_blank')	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_RESOURCES'), 'http://resources.joomla.org', 'class:help-jrd', false, '_blank')	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_COMMUNITY'), 'http://community.joomla.org', 'class:help-community', false, '_blank')	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_SECURITY'), 'http://developer.joomla.org/security.html', 'class:help-security', false, '_blank')	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_DEVELOPER'), 'http://developer.joomla.org', 'class:help-dev', false, '_blank')	);	$menu->addChild(		new JMenuNode(JText::_('MOD_MENU_HELP_SHOP'), 'http://shop.joomla.org', 'class:help-shop', false, '_blank')	);	$menu->getParent();}
<?php/** * @package     Joomla.Site * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Newsfeeds Component Newsfeed Model * * @package     Joomla.Site * @subpackage  com_newsfeeds * @since       1.5 */class NewsfeedsModelNewsfeed extends JModelItem{	/**	 * Model context string.	 *	 * @var		string	 * @since   1.6	 */	protected $_context = 'com_newsfeeds.newsfeed';	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @return  void	 * @since   1.6	 */	protected function populateState()	{		$app = JFactory::getApplication('site');		// Load state from the request.		$pk = $app->input->getInt('id');		$this->setState('newsfeed.id', $pk);		$offset = $app->input->get('limitstart', 0, 'uint');		$this->setState('list.offset', $offset);		// Load the parameters.		$params = $app->getParams();		$this->setState('params', $params);		$user = JFactory::getUser();		if ((!$user->authorise('core.edit.state', 'com_newsfeeds')) &&  (!$user->authorise('core.edit', 'com_newsfeeds'))){			$this->setState('filter.published', 1);			$this->setState('filter.archived', 2);		}	}	/**	 * Method to get newsfeed data.	 *	 * @param   integer	The id of the newsfeed.	 *	 * @return  mixed  Menu item data object on success, false on failure.	 * @since   1.6	 */	public function &getItem($pk = null)	{		$pk = (!empty($pk)) ? $pk : (int) $this->getState('newsfeed.id');		if ($this->_item === null)		{			$this->_item = array();		}		if (!isset($this->_item[$pk]))		{			try			{				$db = $this->getDbo();				$query = $db->getQuery(true)					->select($this->getState('item.select', 'a.*'))					->from('#__newsfeeds AS a');				// Join on category table.				$query->select('c.title AS category_title, c.alias AS category_alias, c.access AS category_access')					->join('LEFT', '#__categories AS c on c.id = a.catid');				// Join on user table.				$query->select('u.name AS author')					->join('LEFT', '#__users AS u on u.id = a.created_by');				// Join over the categories to get parent category titles				$query->select('parent.title as parent_title, parent.id as parent_id, parent.path as parent_route, parent.alias as parent_alias')					->join('LEFT', '#__categories as parent ON parent.id = c.parent_id')					->where('a.id = ' . (int) $pk);				// Filter by start and end dates.				$nullDate = $db->quote($db->getNullDate());				$nowDate = $db->quote(JFactory::getDate()->toSql());				// Filter by published state.				$published = $this->getState('filter.published');				$archived = $this->getState('filter.archived');				if (is_numeric($published))				{					$query->where('(a.published = ' . (int) $published . ' OR a.published =' . (int) $archived . ')')						->where('(a.publish_up = ' . $nullDate . ' OR a.publish_up <= ' . $nowDate . ')')						->where('(a.publish_down = ' . $nullDate . ' OR a.publish_down >= ' . $nowDate . ')')						->where('(c.published = ' . (int) $published . ' OR c.published =' . (int) $archived . ')');				}				$db->setQuery($query);				$data = $db->loadObject();				if (empty($data))				{					JError::raiseError(404, JText::_('COM_NEWSFEEDS_ERROR_FEED_NOT_FOUND'));				}				// Check for published state if filter set.				if (((is_numeric($published)) || (is_numeric($archived))) && (($data->published != $published) && ($data->published != $archived)))				{					JError::raiseError(404, JText::_('COM_NEWSFEEDS_ERROR_FEED_NOT_FOUND'));				}				// Convert parameter fields to objects.				$registry = new JRegistry;				$registry->loadString($data->params);				$data->params = clone $this->getState('params');				$data->params->merge($registry);				$registry = new JRegistry;				$registry->loadString($data->metadata);				$data->metadata = $registry;				// Compute access permissions.				if ($access = $this->getState('filter.access'))				{					// If the access filter has been set, we already know this user can view.					$data->params->set('access-view', true);				}				else {					// If no access filter is set, the layout takes some responsibility for display of limited information.					$user = JFactory::getUser();					$groups = $user->getAuthorisedViewLevels();					$data->params->set('access-view', in_array($data->access, $groups) && in_array($data->category_access, $groups));				}				$this->_item[$pk] = $data;			}			catch (Exception $e)			{				$this->setError($e);				$this->_item[$pk] = false;			}		}		return $this->_item[$pk];	}	/**	 * Increment the hit counter for the newsfeed.	 *	 * @param   int  $pk  Optional primary key of the item to increment.	 *	 * @return  boolean  True if successful; false otherwise and internal error set.	 *	 * @since   3.0	 */	public function hit($pk = 0)	{		$input = JFactory::getApplication()->input;		$hitcount = $input->getInt('hitcount', 1);		if ($hitcount)		{			$pk = (!empty($pk)) ? $pk : (int) $this->getState('newsfeed.id');			$db = $this->getDbo();			$db->setQuery(				'UPDATE #__newsfeeds' .				' SET hits = hits + 1' .				' WHERE id = '.(int) $pk			);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				$this->setError($e->getMessage());				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_templates * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Methods supporting a list of template extension records. * * @package     Joomla.Administrator * @subpackage  com_templates * @since       1.6 */class TemplatesModelTemplates extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id', 'a.id',				'name', 'a.name',				'folder', 'a.folder',				'element', 'a.element',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'state', 'a.state',				'enabled', 'a.enabled',				'access', 'a.access', 'access_level',				'ordering', 'a.ordering',				'client_id', 'a.client_id',			);		}		parent::__construct($config);	}	/**	 * Override parent getItems to add extra XML metadata.	 *	 * @since   1.6	 */	public function getItems()	{		$items = parent::getItems();		foreach ($items as &$item)		{			$client = JApplicationHelper::getClientInfo($item->client_id);			$item->xmldata = TemplatesHelper::parseXMLTemplateFile($client->path, $item->element);		}		return $items;	}	/**	 * Build an SQL query to load the list data.	 *	 * @return  JDatabaseQuery	 * @since   1.6	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		// Select the required fields from the table.		$query->select(			$this->getState(				'list.select',				'a.extension_id, a.name, a.element, a.client_id'			)		);		$query->from($db->quoteName('#__extensions') . ' AS a');		// Filter by extension type.		$query->where($db->quoteName('type') . ' = ' . $db->quote('template'));		// Filter by client.		$clientId = $this->getState('filter.client_id');		if (is_numeric($clientId))		{			$query->where('a.client_id = ' . (int) $clientId);		}		// Filter by search in title		$search = $this->getState('filter.search');		if (!empty($search))		{			if (stripos($search, 'id:') === 0)			{				$query->where('a.id = ' . (int) substr($search, 3));			}			else			{				$search = $db->quote('%' . $db->escape($search, true) . '%');				$query->where('a.element LIKE ' . $search . ' OR a.name LIKE ' . $search);			}		}		// Add the list ordering clause.		$query->order($db->escape($this->getState('list.ordering', 'a.folder')) . ' ' . $db->escape($this->getState('list.direction', 'ASC')));		return $query;	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id    A prefix for the store id.	 * @return  string  A store id.	 * @since   1.6	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.client_id');		return parent::getStoreId($id);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $search);		$clientId = $this->getUserStateFromRequest($this->context . '.filter.client_id', 'filter_client_id', null);		$this->setState('filter.client_id', $clientId);		// Load the parameters.		$params = JComponentHelper::getParams('com_templates');		$this->setState('params', $params);		// List state information.		parent::populateState('a.element', 'asc');	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_users&view=debuguser&user_id='.(int) $this->state->get('filter.user_id'));?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('COM_USERS_SEARCH_ASSETS'); ?></legend>		<div class="filter-search fltlft">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('COM_USERS_SEARCH_ASSETS'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_USERS_SEARCH_USERS'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_RESET'); ?></button>		</div>		<div class="filter-select fltrt">			<label class="selectlabel" for="filter_component"><?php echo JText::_('COM_USERS_OPTION_SELECT_COMPONENT'); ?></label>			<select name="filter_component" class="inputbox" id="filter_component">				<option value=""><?php echo JText::_('COM_USERS_OPTION_SELECT_COMPONENT');?></option>				<?php if (!empty($this->components))				{					echo JHtml::_('select.options', $this->components, 'value', 'text', $this->state->get('filter.component'));				}?>			</select>			<label class="selectlabel" for="filter_level_start"><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_START'); ?></label>			<select name="filter_level_start" class="inputbox" id="filter_level_start">				<option value=""><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_START');?></option>				<?php echo JHtml::_('select.options', $this->levels, 'value', 'text', $this->state->get('filter.level_start'));?>			</select>			<label class="selectlabel" for="filter_level_end"><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_END'); ?></label>			<select name="filter_level_end" class="inputbox" id="filter_level_end">				<option value=""><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_END');?></option>				<?php echo JHtml::_('select.options', $this->levels, 'value', 'text', $this->state->get('filter.level_end'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<div>		<?php echo JText::_('COM_USERS_DEBUG_LEGEND'); ?>		<span class="swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_NO_CHECK', '-');?></span>		<span class="check-0 swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_IMPLICIT_DENY', '-');?></span>		<span class="check-a swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_EXPLICIT_ALLOW', '&#10003;');?></span>		<span class="check-d swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_EXPLICIT_DENY', '&#10007;');?></span>	</div>	<table class="adminlist">		<thead>			<tr>				<th class="left">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ASSET_TITLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<th class="left">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ASSET_NAME', 'a.name', $listDirn, $listOrder); ?>				</th>				<?php foreach ($this->actions as $key => $action) : ?>				<th class="width-5">					<span class="hasTip" title="<?php echo htmlspecialchars(JText::_($key).'::'.JText::_($action[1]), ENT_COMPAT, 'UTF-8'); ?>"><?php echo JText::_($key); ?></span>				</th>				<?php endforeach; ?>				<th class="width-5 nowrap">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_LFT', 'a.lft', $listDirn, $listOrder); ?>				</th>				<th class="width-5 nowrap">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row1">				<th>					<?php echo $this->escape($item->title); ?>				</th>				<td class="nowrap">					<?php echo str_repeat('<span class="gi">|&mdash;</span>', $item->level) ?>					<?php echo $this->escape($item->name); ?>				</td>				<?php foreach ($this->actions as $action) : ?>					<?php					$name	= $action[0];					$check	= $item->checks[$name];					if ($check === true) :						$class	= 'check-a';						$text	= '&#10003;';					elseif ($check === false) :						$class	= 'check-d';						$text	= '&#10007;';					elseif ($check === null) :						$class	= 'check-0';						$text	= '-';					else :						$class	= '';						$text	= '&#160;';					endif;					?>				<td class="center <?php echo $class;?>">					<?php echo $text; ?>				</td>				<?php endforeach; ?>				<td class="center">					<?php echo (int) $item->lft; ?>					- <?php echo (int) $item->rgt; ?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></div></form>
<?php/** * Akeeba Restore * A JSON-powered JPA, JPS and ZIP archive extraction library *  * @copyright 2010-2012 Nicholas K. Dionysopoulos / AkeebaBackup.com * @license GNU GPL v2 or - at your option - any later version * @package akeebabackup * @subpackage kickstart */define('_AKEEBA_RESTORATION', 1);defined('DS') or define('DS', DIRECTORY_SEPARATOR);// Unarchiver run statesdefine('AK_STATE_NOFILE',	0); // File header not read yetdefine('AK_STATE_HEADER',	1); // File header read; ready to process datadefine('AK_STATE_DATA',		2); // Processing file datadefine('AK_STATE_DATAREAD',	3); // Finished processing file data; ready to post-processdefine('AK_STATE_POSTPROC',	4); // Post-processingdefine('AK_STATE_DONE',		5); // Done with post-processing/* Windows system detection */if(!defined('_AKEEBA_IS_WINDOWS')){	if (function_exists('php_uname'))		define('_AKEEBA_IS_WINDOWS', stristr(php_uname(), 'windows'));	else		define('_AKEEBA_IS_WINDOWS', DIRECTORY_SEPARATOR == '\\');}// Make sure the locale is correct for basename() to workif(function_exists('setlocale')){	@setlocale(LC_ALL, 'en_US.UTF8');}// fnmatch not available on non-POSIX systems// Thanks to soywiz@php.net for this usefull alternative function [http://gr2.php.net/fnmatch]if (!function_exists('fnmatch')) {	function fnmatch($pattern, $string) {		return @preg_match(			'/^' . strtr(addcslashes($pattern, '/\\.+^$(){}=!<>|'),		array('*' => '.*', '?' => '.?')) . '$/i', $string		);	}}// Unicode-safe binary data length functionif(function_exists('mb_strlen')) {	function akstringlen($string) { return mb_strlen($string,'8bit'); }} else {	function akstringlen($string) { return strlen($string); }}/** * Gets a query parameter from GET or POST data * @param $key * @param $default */function getQueryParam( $key, $default = null ){	$value = null;	if(array_key_exists($key, $_REQUEST)) {		$value = $_REQUEST[$key];	} elseif(array_key_exists($key, $_POST)) {		$value = $_POST[$key];	} elseif(array_key_exists($key, $_GET)) {		$value = $_GET[$key];	} else {		return $default;	}	if(get_magic_quotes_gpc() && !is_null($value)) $value=stripslashes($value);	return $value;}/** * Akeeba Backup's JSON compatibility layer * * On systems where json_encode and json_decode are not available, Akeeba * Backup will attempt to use PEAR's Services_JSON library to emulate them. * A copy of this library is included in this file and will be used if and * only if it isn't already loaded, e.g. due to PEAR's auto-loading, or a * 3PD extension loading it for its own purposes. *//** * Converts to and from JSON format. * * JSON (JavaScript Object Notation) is a lightweight data-interchange * format. It is easy for humans to read and write. It is easy for machines * to parse and generate. It is based on a subset of the JavaScript * Programming Language, Standard ECMA-262 3rd Edition - December 1999. * This feature can also be found in  Python. JSON is a text format that is * completely language independent but uses conventions that are familiar * to programmers of the C-family of languages, including C, C++, C#, Java, * JavaScript, Perl, TCL, and many others. These properties make JSON an * ideal data-interchange language. * * This package provides a simple encoder and decoder for JSON notation. It * is intended for use with client-side Javascript applications that make * use of HTTPRequest to perform server communication functions - data can * be encoded into JSON notation for use in a client-side javascript, or * decoded from incoming Javascript requests. JSON format is native to * Javascript, and can be directly eval()'ed with no further parsing * overhead * * All strings should be in ASCII or UTF-8 format! * * LICENSE: Redistribution and use in source and binary forms, with or * without modification, are permitted provided that the following * conditions are met: Redistributions of source code must retain the * above copyright notice, this list of conditions and the following * disclaimer. Redistributions in binary form must reproduce the above * copyright notice, this list of conditions and the following disclaimer * in the documentation and/or other materials provided with the * distribution. * * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN * NO EVENT SHALL CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE * USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH * DAMAGE. * * @category * @package     Services_JSON * @author      Michal Migurski <mike-json@teczno.com> * @author      Matt Knapp <mdknapp[at]gmail[dot]com> * @author      Brett Stimmerman <brettstimmerman[at]gmail[dot]com> * @copyright   2005 Michal Migurski * @version     CVS: $Id: restore.php 612 2011-05-19 08:26:26Z nikosdion $ * @license     http://www.opensource.org/licenses/bsd-license.php * @link        http://pear.php.net/pepr/pepr-proposal-show.php?id=198 */if(!defined('JSON_FORCE_OBJECT')){	define('JSON_FORCE_OBJECT', 1);}if(!defined('SERVICES_JSON_SLICE')){	/**	 * Marker constant for Services_JSON::decode(), used to flag stack state	 */	define('SERVICES_JSON_SLICE',   1);	/**	 * Marker constant for Services_JSON::decode(), used to flag stack state	 */	define('SERVICES_JSON_IN_STR',  2);	/**	 * Marker constant for Services_JSON::decode(), used to flag stack state	 */	define('SERVICES_JSON_IN_ARR',  3);	/**	 * Marker constant for Services_JSON::decode(), used to flag stack state	 */	define('SERVICES_JSON_IN_OBJ',  4);	/**	 * Marker constant for Services_JSON::decode(), used to flag stack state	 */	define('SERVICES_JSON_IN_CMT', 5);	/**	 * Behavior switch for Services_JSON::decode()	 */	define('SERVICES_JSON_LOOSE_TYPE', 16);	/**	 * Behavior switch for Services_JSON::decode()	 */	define('SERVICES_JSON_SUPPRESS_ERRORS', 32);}/** * Converts to and from JSON format. * * Brief example of use: * * <code> * // create a new instance of Services_JSON * $json = new Services_JSON(); * * // convert a complexe value to JSON notation, and send it to the browser * $value = array('foo', 'bar', array(1, 2, 'baz'), array(3, array(4))); * $output = $json->encode($value); * * print($output); * // prints: ["foo","bar",[1,2,"baz"],[3,[4]]] * * // accept incoming POST data, assumed to be in JSON notation * $input = file_get_contents('php://input', 1000000); * $value = $json->decode($input); * </code> */if(!class_exists('Akeeba_Services_JSON')){	class Akeeba_Services_JSON	{	   /**	    * constructs a new JSON instance	    *	    * @param    int     $use    object behavior flags; combine with boolean-OR	    *	    *                           possible values:	    *                           - SERVICES_JSON_LOOSE_TYPE:  loose typing.	    *                                   "{...}" syntax creates associative arrays	    *                                   instead of objects in decode().	    *                           - SERVICES_JSON_SUPPRESS_ERRORS:  error suppression.	    *                                   Values which can't be encoded (e.g. resources)	    *                                   appear as NULL instead of throwing errors.	    *                                   By default, a deeply-nested resource will	    *                                   bubble up with an error, so all return values	    *                                   from encode() should be checked with isError()	    */	    function Akeeba_Services_JSON($use = 0)	    {	        $this->use = $use;	    }	   /**	    * convert a string from one UTF-16 char to one UTF-8 char	    *	    * Normally should be handled by mb_convert_encoding, but	    * provides a slower PHP-only method for installations	    * that lack the multibye string extension.	    *	    * @param    string  $utf16  UTF-16 character	    * @return   string  UTF-8 character	    * @access   private	    */	    function utf162utf8($utf16)	    {	        // oh please oh please oh please oh please oh please	        if(function_exists('mb_convert_encoding')) {	            return mb_convert_encoding($utf16, 'UTF-8', 'UTF-16');	        }	        $bytes = (ord($utf16{0}) << 8) | ord($utf16{1});	        switch(true) {	            case ((0x7F & $bytes) == $bytes):	                // this case should never be reached, because we are in ASCII range	                // see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                return chr(0x7F & $bytes);	            case (0x07FF & $bytes) == $bytes:	                // return a 2-byte UTF-8 character	                // see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                return chr(0xC0 | (($bytes >> 6) & 0x1F))	                     . chr(0x80 | ($bytes & 0x3F));	            case (0xFFFF & $bytes) == $bytes:	                // return a 3-byte UTF-8 character	                // see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                return chr(0xE0 | (($bytes >> 12) & 0x0F))	                     . chr(0x80 | (($bytes >> 6) & 0x3F))	                     . chr(0x80 | ($bytes & 0x3F));	        }	        // ignoring UTF-32 for now, sorry	        return '';	    }	   /**	    * convert a string from one UTF-8 char to one UTF-16 char	    *	    * Normally should be handled by mb_convert_encoding, but	    * provides a slower PHP-only method for installations	    * that lack the multibye string extension.	    *	    * @param    string  $utf8   UTF-8 character	    * @return   string  UTF-16 character	    * @access   private	    */	    function utf82utf16($utf8)	    {	        // oh please oh please oh please oh please oh please	        if(function_exists('mb_convert_encoding')) {	            return mb_convert_encoding($utf8, 'UTF-16', 'UTF-8');	        }	        switch(strlen($utf8)) {	            case 1:	                // this case should never be reached, because we are in ASCII range	                // see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                return $utf8;	            case 2:	                // return a UTF-16 character from a 2-byte UTF-8 char	                // see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                return chr(0x07 & (ord($utf8{0}) >> 2))	                     . chr((0xC0 & (ord($utf8{0}) << 6))	                         | (0x3F & ord($utf8{1})));	            case 3:	                // return a UTF-16 character from a 3-byte UTF-8 char	                // see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                return chr((0xF0 & (ord($utf8{0}) << 4))	                         | (0x0F & (ord($utf8{1}) >> 2)))	                     . chr((0xC0 & (ord($utf8{1}) << 6))	                         | (0x7F & ord($utf8{2})));	        }	        // ignoring UTF-32 for now, sorry	        return '';	    }	   /**	    * encodes an arbitrary variable into JSON format	    *	    * @param    mixed   $var    any number, boolean, string, array, or object to be encoded.	    *                           see argument 1 to Services_JSON() above for array-parsing behavior.	    *                           if var is a strng, note that encode() always expects it	    *                           to be in ASCII or UTF-8 format!	    *	    * @return   mixed   JSON string representation of input var or an error if a problem occurs	    * @access   public	    */	    function encode($var)	    {	        switch (gettype($var)) {	            case 'boolean':	                return $var ? 'true' : 'false';	            case 'NULL':	                return 'null';	            case 'integer':	                return (int) $var;	            case 'double':	            case 'float':	                return (float) $var;	            case 'string':	                // STRINGS ARE EXPECTED TO BE IN ASCII OR UTF-8 FORMAT	                $ascii = '';	                $strlen_var = strlen($var);	               /*	                * Iterate over every character in the string,	                * escaping with a slash or encoding to UTF-8 where necessary	                */	                for ($c = 0; $c < $strlen_var; ++$c) {	                    $ord_var_c = ord($var{$c});	                    switch (true) {	                        case $ord_var_c == 0x08:	                            $ascii .= '\b';	                            break;	                        case $ord_var_c == 0x09:	                            $ascii .= '\t';	                            break;	                        case $ord_var_c == 0x0A:	                            $ascii .= '\n';	                            break;	                        case $ord_var_c == 0x0C:	                            $ascii .= '\f';	                            break;	                        case $ord_var_c == 0x0D:	                            $ascii .= '\r';	                            break;	                        case $ord_var_c == 0x22:	                        case $ord_var_c == 0x2F:	                        case $ord_var_c == 0x5C:	                            // double quote, slash, slosh	                            $ascii .= '\\'.$var{$c};	                            break;	                        case (($ord_var_c >= 0x20) && ($ord_var_c <= 0x7F)):	                            // characters U-00000000 - U-0000007F (same as ASCII)	                            $ascii .= $var{$c};	                            break;	                        case (($ord_var_c & 0xE0) == 0xC0):	                            // characters U-00000080 - U-000007FF, mask 110XXXXX	                            // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                            $char = pack('C*', $ord_var_c, ord($var{$c + 1}));	                            $c += 1;	                            $utf16 = $this->utf82utf16($char);	                            $ascii .= sprintf('\u%04s', bin2hex($utf16));	                            break;	                        case (($ord_var_c & 0xF0) == 0xE0):	                            // characters U-00000800 - U-0000FFFF, mask 1110XXXX	                            // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                            $char = pack('C*', $ord_var_c,	                                         ord($var{$c + 1}),	                                         ord($var{$c + 2}));	                            $c += 2;	                            $utf16 = $this->utf82utf16($char);	                            $ascii .= sprintf('\u%04s', bin2hex($utf16));	                            break;	                        case (($ord_var_c & 0xF8) == 0xF0):	                            // characters U-00010000 - U-001FFFFF, mask 11110XXX	                            // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                            $char = pack('C*', $ord_var_c,	                                         ord($var{$c + 1}),	                                         ord($var{$c + 2}),	                                         ord($var{$c + 3}));	                            $c += 3;	                            $utf16 = $this->utf82utf16($char);	                            $ascii .= sprintf('\u%04s', bin2hex($utf16));	                            break;	                        case (($ord_var_c & 0xFC) == 0xF8):	                            // characters U-00200000 - U-03FFFFFF, mask 111110XX	                            // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                            $char = pack('C*', $ord_var_c,	                                         ord($var{$c + 1}),	                                         ord($var{$c + 2}),	                                         ord($var{$c + 3}),	                                         ord($var{$c + 4}));	                            $c += 4;	                            $utf16 = $this->utf82utf16($char);	                            $ascii .= sprintf('\u%04s', bin2hex($utf16));	                            break;	                        case (($ord_var_c & 0xFE) == 0xFC):	                            // characters U-04000000 - U-7FFFFFFF, mask 1111110X	                            // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                            $char = pack('C*', $ord_var_c,	                                         ord($var{$c + 1}),	                                         ord($var{$c + 2}),	                                         ord($var{$c + 3}),	                                         ord($var{$c + 4}),	                                         ord($var{$c + 5}));	                            $c += 5;	                            $utf16 = $this->utf82utf16($char);	                            $ascii .= sprintf('\u%04s', bin2hex($utf16));	                            break;	                    }	                }	                return '"'.$ascii.'"';	            case 'array':	               /*	                * As per JSON spec if any array key is not an integer	                * we must treat the the whole array as an object. We	                * also try to catch a sparsely populated associative	                * array with numeric keys here because some JS engines	                * will create an array with empty indexes up to	                * max_index which can cause memory issues and because	                * the keys, which may be relevant, will be remapped	                * otherwise.	                *	                * As per the ECMA and JSON specification an object may	                * have any string as a property. Unfortunately due to	                * a hole in the ECMA specification if the key is a	                * ECMA reserved word or starts with a digit the	                * parameter is only accessible using ECMAScript's	                * bracket notation.	                */	                // treat as a JSON object	                if (is_array($var) && count($var) && (array_keys($var) !== range(0, sizeof($var) - 1))) {	                    $properties = array_map(array($this, 'name_value'),	                                            array_keys($var),	                                            array_values($var));	                    foreach($properties as $property) {	                        if(Akeeba_Services_JSON::isError($property)) {	                            return $property;	                        }	                    }	                    return '{' . join(',', $properties) . '}';	                }	                // treat it like a regular array	                $elements = array_map(array($this, 'encode'), $var);	                foreach($elements as $element) {	                    if(Akeeba_Services_JSON::isError($element)) {	                        return $element;	                    }	                }	                return '[' . join(',', $elements) . ']';	            case 'object':	                $vars = get_object_vars($var);	                $properties = array_map(array($this, 'name_value'),	                                        array_keys($vars),	                                        array_values($vars));	                foreach($properties as $property) {	                    if(Akeeba_Services_JSON::isError($property)) {	                        return $property;	                    }	                }	                return '{' . join(',', $properties) . '}';	            default:	                return ($this->use & SERVICES_JSON_SUPPRESS_ERRORS)	                    ? 'null'	                    : new Akeeba_Services_JSON_Error(gettype($var)." can not be encoded as JSON string");	        }	    }	   /**	    * array-walking function for use in generating JSON-formatted name-value pairs	    *	    * @param    string  $name   name of key to use	    * @param    mixed   $value  reference to an array element to be encoded	    *	    * @return   string  JSON-formatted name-value pair, like '"name":value'	    * @access   private	    */	    function name_value($name, $value)	    {	        $encoded_value = $this->encode($value);	        if(Akeeba_Services_JSON::isError($encoded_value)) {	            return $encoded_value;	        }	        return $this->encode(strval($name)) . ':' . $encoded_value;	    }	   /**	    * reduce a string by removing leading and trailing comments and whitespace	    *	    * @param    $str    string      string value to strip of comments and whitespace	    *	    * @return   string  string value stripped of comments and whitespace	    * @access   private	    */	    function reduce_string($str)	    {	        $str = preg_replace(array(	                // eliminate single line comments in '// ...' form	                '#^\s*//(.+)$#m',	                // eliminate multi-line comments in '/* ... */' form, at start of string	                '#^\s*/\*(.+)\*/#Us',	                // eliminate multi-line comments in '/* ... */' form, at end of string	                '#/\*(.+)\*/\s*$#Us'	            ), '', $str);	        // eliminate extraneous space	        return trim($str);	    }	   /**	    * decodes a JSON string into appropriate variable	    *	    * @param    string  $str    JSON-formatted string	    *	    * @return   mixed   number, boolean, string, array, or object	    *                   corresponding to given JSON input string.	    *                   See argument 1 to Akeeba_Services_JSON() above for object-output behavior.	    *                   Note that decode() always returns strings	    *                   in ASCII or UTF-8 format!	    * @access   public	    */	    function decode($str)	    {	        $str = $this->reduce_string($str);	        switch (strtolower($str)) {	            case 'true':	                return true;	            case 'false':	                return false;	            case 'null':	                return null;	            default:	                $m = array();	                if (is_numeric($str)) {	                    // Lookie-loo, it's a number	                    // This would work on its own, but I'm trying to be	                    // good about returning integers where appropriate:	                    // return (float)$str;	                    // Return float or int, as appropriate	                    return ((float)$str == (integer)$str)	                        ? (integer)$str	                        : (float)$str;	                } elseif (preg_match('/^("|\').*(\1)$/s', $str, $m) && $m[1] == $m[2]) {	                    // STRINGS RETURNED IN UTF-8 FORMAT	                    $delim = substr($str, 0, 1);	                    $chrs = substr($str, 1, -1);	                    $utf8 = '';	                    $strlen_chrs = strlen($chrs);	                    for ($c = 0; $c < $strlen_chrs; ++$c) {	                        $substr_chrs_c_2 = substr($chrs, $c, 2);	                        $ord_chrs_c = ord($chrs{$c});	                        switch (true) {	                            case $substr_chrs_c_2 == '\b':	                                $utf8 .= chr(0x08);	                                ++$c;	                                break;	                            case $substr_chrs_c_2 == '\t':	                                $utf8 .= chr(0x09);	                                ++$c;	                                break;	                            case $substr_chrs_c_2 == '\n':	                                $utf8 .= chr(0x0A);	                                ++$c;	                                break;	                            case $substr_chrs_c_2 == '\f':	                                $utf8 .= chr(0x0C);	                                ++$c;	                                break;	                            case $substr_chrs_c_2 == '\r':	                                $utf8 .= chr(0x0D);	                                ++$c;	                                break;	                            case $substr_chrs_c_2 == '\\"':	                            case $substr_chrs_c_2 == '\\\'':	                            case $substr_chrs_c_2 == '\\\\':	                            case $substr_chrs_c_2 == '\\/':	                                if (($delim == '"' && $substr_chrs_c_2 != '\\\'') ||	                                   ($delim == "'" && $substr_chrs_c_2 != '\\"')) {	                                    $utf8 .= $chrs{++$c};	                                }	                                break;	                            case preg_match('/\\\u[0-9A-F]{4}/i', substr($chrs, $c, 6)):	                                // single, escaped unicode character	                                $utf16 = chr(hexdec(substr($chrs, ($c + 2), 2)))	                                       . chr(hexdec(substr($chrs, ($c + 4), 2)));	                                $utf8 .= $this->utf162utf8($utf16);	                                $c += 5;	                                break;	                            case ($ord_chrs_c >= 0x20) && ($ord_chrs_c <= 0x7F):	                                $utf8 .= $chrs{$c};	                                break;	                            case ($ord_chrs_c & 0xE0) == 0xC0:	                                // characters U-00000080 - U-000007FF, mask 110XXXXX	                                //see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                                $utf8 .= substr($chrs, $c, 2);	                                ++$c;	                                break;	                            case ($ord_chrs_c & 0xF0) == 0xE0:	                                // characters U-00000800 - U-0000FFFF, mask 1110XXXX	                                // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                                $utf8 .= substr($chrs, $c, 3);	                                $c += 2;	                                break;	                            case ($ord_chrs_c & 0xF8) == 0xF0:	                                // characters U-00010000 - U-001FFFFF, mask 11110XXX	                                // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                                $utf8 .= substr($chrs, $c, 4);	                                $c += 3;	                                break;	                            case ($ord_chrs_c & 0xFC) == 0xF8:	                                // characters U-00200000 - U-03FFFFFF, mask 111110XX	                                // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                                $utf8 .= substr($chrs, $c, 5);	                                $c += 4;	                                break;	                            case ($ord_chrs_c & 0xFE) == 0xFC:	                                // characters U-04000000 - U-7FFFFFFF, mask 1111110X	                                // see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8	                                $utf8 .= substr($chrs, $c, 6);	                                $c += 5;	                                break;	                        }	                    }	                    return $utf8;	                } elseif (preg_match('/^\[.*\]$/s', $str) || preg_match('/^\{.*\}$/s', $str)) {	                    // array, or object notation	                    if ($str{0} == '[') {	                        $stk = array(SERVICES_JSON_IN_ARR);	                        $arr = array();	                    } else {	                        if ($this->use & SERVICES_JSON_LOOSE_TYPE) {	                            $stk = array(SERVICES_JSON_IN_OBJ);	                            $obj = array();	                        } else {	                            $stk = array(SERVICES_JSON_IN_OBJ);	                            $obj = new stdClass();	                        }	                    }	                    array_push($stk, array('what'  => SERVICES_JSON_SLICE,	                                           'where' => 0,	                                           'delim' => false));	                    $chrs = substr($str, 1, -1);	                    $chrs = $this->reduce_string($chrs);	                    if ($chrs == '') {	                        if (reset($stk) == SERVICES_JSON_IN_ARR) {	                            return $arr;	                        } else {	                            return $obj;	                        }	                    }	                    //print("\nparsing {$chrs}\n");	                    $strlen_chrs = strlen($chrs);	                    for ($c = 0; $c <= $strlen_chrs; ++$c) {	                        $top = end($stk);	                        $substr_chrs_c_2 = substr($chrs, $c, 2);	                        if (($c == $strlen_chrs) || (($chrs{$c} == ',') && ($top['what'] == SERVICES_JSON_SLICE))) {	                            // found a comma that is not inside a string, array, etc.,	                            // OR we've reached the end of the character list	                            $slice = substr($chrs, $top['where'], ($c - $top['where']));	                            array_push($stk, array('what' => SERVICES_JSON_SLICE, 'where' => ($c + 1), 'delim' => false));	                            //print("Found split at {$c}: ".substr($chrs, $top['where'], (1 + $c - $top['where']))."\n");	                            if (reset($stk) == SERVICES_JSON_IN_ARR) {	                                // we are in an array, so just push an element onto the stack	                                array_push($arr, $this->decode($slice));	                            } elseif (reset($stk) == SERVICES_JSON_IN_OBJ) {	                                // we are in an object, so figure	                                // out the property name and set an	                                // element in an associative array,	                                // for now	                                $parts = array();	                                if (preg_match('/^\s*(["\'].*[^\\\]["\'])\s*:\s*(\S.*),?$/Uis', $slice, $parts)) {	                                    // "name":value pair	                                    $key = $this->decode($parts[1]);	                                    $val = $this->decode($parts[2]);	                                    if ($this->use & SERVICES_JSON_LOOSE_TYPE) {	                                        $obj[$key] = $val;	                                    } else {	                                        $obj->$key = $val;	                                    }	                                } elseif (preg_match('/^\s*(\w+)\s*:\s*(\S.*),?$/Uis', $slice, $parts)) {	                                    // name:value pair, where name is unquoted	                                    $key = $parts[1];	                                    $val = $this->decode($parts[2]);	                                    if ($this->use & SERVICES_JSON_LOOSE_TYPE) {	                                        $obj[$key] = $val;	                                    } else {	                                        $obj->$key = $val;	                                    }	                                }	                            }	                        } elseif ((($chrs{$c} == '"') || ($chrs{$c} == "'")) && ($top['what'] != SERVICES_JSON_IN_STR)) {	                            // found a quote, and we are not inside a string	                            array_push($stk, array('what' => SERVICES_JSON_IN_STR, 'where' => $c, 'delim' => $chrs{$c}));	                            //print("Found start of string at {$c}\n");	                        } elseif (($chrs{$c} == $top['delim']) &&	                                 ($top['what'] == SERVICES_JSON_IN_STR) &&	                                 ((strlen(substr($chrs, 0, $c)) - strlen(rtrim(substr($chrs, 0, $c), '\\'))) % 2 != 1)) {	                            // found a quote, we're in a string, and it's not escaped	                            // we know that it's not escaped becase there is _not_ an	                            // odd number of backslashes at the end of the string so far	                            array_pop($stk);	                            //print("Found end of string at {$c}: ".substr($chrs, $top['where'], (1 + 1 + $c - $top['where']))."\n");	                        } elseif (($chrs{$c} == '[') &&	                                 in_array($top['what'], array(SERVICES_JSON_SLICE, SERVICES_JSON_IN_ARR, SERVICES_JSON_IN_OBJ))) {	                            // found a left-bracket, and we are in an array, object, or slice	                            array_push($stk, array('what' => SERVICES_JSON_IN_ARR, 'where' => $c, 'delim' => false));	                            //print("Found start of array at {$c}\n");	                        } elseif (($chrs{$c} == ']') && ($top['what'] == SERVICES_JSON_IN_ARR)) {	                            // found a right-bracket, and we're in an array	                            array_pop($stk);	                            //print("Found end of array at {$c}: ".substr($chrs, $top['where'], (1 + $c - $top['where']))."\n");	                        } elseif (($chrs{$c} == '{') &&	                                 in_array($top['what'], array(SERVICES_JSON_SLICE, SERVICES_JSON_IN_ARR, SERVICES_JSON_IN_OBJ))) {	                            // found a left-brace, and we are in an array, object, or slice	                            array_push($stk, array('what' => SERVICES_JSON_IN_OBJ, 'where' => $c, 'delim' => false));	                            //print("Found start of object at {$c}\n");	                        } elseif (($chrs{$c} == '}') && ($top['what'] == SERVICES_JSON_IN_OBJ)) {	                            // found a right-brace, and we're in an object	                            array_pop($stk);	                            //print("Found end of object at {$c}: ".substr($chrs, $top['where'], (1 + $c - $top['where']))."\n");	                        } elseif (($substr_chrs_c_2 == '/*') &&	                                 in_array($top['what'], array(SERVICES_JSON_SLICE, SERVICES_JSON_IN_ARR, SERVICES_JSON_IN_OBJ))) {	                            // found a comment start, and we are in an array, object, or slice	                            array_push($stk, array('what' => SERVICES_JSON_IN_CMT, 'where' => $c, 'delim' => false));	                            $c++;	                            //print("Found start of comment at {$c}\n");	                        } elseif (($substr_chrs_c_2 == '*/') && ($top['what'] == SERVICES_JSON_IN_CMT)) {	                            // found a comment end, and we're in one now	                            array_pop($stk);	                            $c++;	                            for ($i = $top['where']; $i <= $c; ++$i)	                                $chrs = substr_replace($chrs, ' ', $i, 1);	                            //print("Found end of comment at {$c}: ".substr($chrs, $top['where'], (1 + $c - $top['where']))."\n");	                        }	                    }	                    if (reset($stk) == SERVICES_JSON_IN_ARR) {	                        return $arr;	                    } elseif (reset($stk) == SERVICES_JSON_IN_OBJ) {	                        return $obj;	                    }	                }	        }	    }	    function isError($data, $code = null)	    {	        if (class_exists('pear')) {	            return PEAR::isError($data, $code);	        } elseif (is_object($data) && (get_class($data) == 'services_json_error' ||	                                 is_subclass_of($data, 'services_json_error'))) {	            return true;	        }	        return false;	    }	}    class Akeeba_Services_JSON_Error    {        function Akeeba_Services_JSON_Error($message = 'unknown error', $code = null,                                     $mode = null, $options = null, $userinfo = null)        {        }    }}if(!function_exists('json_encode')){	function json_encode($value, $options = 0) {		$flags = SERVICES_JSON_LOOSE_TYPE;		if( $options & JSON_FORCE_OBJECT ) $flags = 0;		$encoder = new Akeeba_Services_JSON($flags);		return $encoder->encode($value);	}}if(!function_exists('json_decode')){	function json_decode($value, $assoc = false)	{		$flags = 0;		if($assoc) $flags = SERVICES_JSON_LOOSE_TYPE;		$decoder = new Akeeba_Services_JSON($flags);		return $decoder->decode($value);	}}/** * The base class of Akeeba Engine objects. Allows for error and warnings logging * and propagation. Largely based on the Joomla! 1.5 JObject class. */abstract class AKAbstractObject{	/** @var	array	An array of errors */	private $_errors = array();	/** @var	array	The queue size of the $_errors array. Set to 0 for infinite size. */	protected $_errors_queue_size = 0;	/** @var	array	An array of warnings */	private $_warnings = array();	/** @var	array	The queue size of the $_warnings array. Set to 0 for infinite size. */	protected $_warnings_queue_size = 0;	/**	 * Public constructor, makes sure we are instanciated only by the factory class	 */	public function __construct()	{		/*		// Assisted Singleton pattern		if(function_exists('debug_backtrace'))		{			$caller=debug_backtrace();			if(				($caller[1]['class'] != 'AKFactory') &&				($caller[2]['class'] != 'AKFactory') &&				($caller[3]['class'] != 'AKFactory') &&				($caller[4]['class'] != 'AKFactory')			) {				var_dump(debug_backtrace());				trigger_error("You can't create direct descendants of ".__CLASS__, E_USER_ERROR);			}		}		*/	}	/**	 * Get the most recent error message	 * @param	integer	$i Optional error index	 * @return	string	Error message	 */	public function getError($i = null)	{		return $this->getItemFromArray($this->_errors, $i);	}	/**	 * Return all errors, if any	 * @return	array	Array of error messages	 */	public function getErrors()	{		return $this->_errors;	}	/**	 * Add an error message	 * @param	string $error Error message	 */	public function setError($error)	{		if($this->_errors_queue_size > 0)		{			if(count($this->_errors) >= $this->_errors_queue_size)			{				array_shift($this->_errors);			}		}		array_push($this->_errors, $error);	}	/**	 * Resets all error messages	 */	public function resetErrors()	{		$this->_errors = array();	}	/**	 * Get the most recent warning message	 * @param	integer	$i Optional warning index	 * @return	string	Error message	 */	public function getWarning($i = null)	{		return $this->getItemFromArray($this->_warnings, $i);	}	/**	 * Return all warnings, if any	 * @return	array	Array of error messages	 */	public function getWarnings()	{		return $this->_warnings;	}	/**	 * Add an error message	 * @param	string $error Error message	 */	public function setWarning($warning)	{		if($this->_warnings_queue_size > 0)		{			if(count($this->_warnings) >= $this->_warnings_queue_size)			{				array_shift($this->_warnings);			}		}		array_push($this->_warnings, $warning);	}	/**	 * Resets all warning messages	 */	public function resetWarnings()	{		$this->_warnings = array();	}	/**	 * Propagates errors and warnings to a foreign object. The foreign object SHOULD	 * implement the setError() and/or setWarning() methods but DOESN'T HAVE TO be of	 * AKAbstractObject type. For example, this can even be used to propagate to a	 * JObject instance in Joomla!. Propagated items will be removed from ourself.	 * @param object $object The object to propagate errors and warnings to.	 */	public function propagateToObject(&$object)	{		// Skip non-objects		if(!is_object($object)) return;		if( method_exists($object,'setError') )		{			if(!empty($this->_errors))			{				foreach($this->_errors as $error)				{					$object->setError($error);				}				$this->_errors = array();			}		}		if( method_exists($object,'setWarning') )		{			if(!empty($this->_warnings))			{				foreach($this->_warnings as $warning)				{					$object->setWarning($warning);				}				$this->_warnings = array();			}		}	}	/**	 * Propagates errors and warnings from a foreign object. Each propagated list is	 * then cleared on the foreign object, as long as it implements resetErrors() and/or	 * resetWarnings() methods.	 * @param object $object The object to propagate errors and warnings from	 */	public function propagateFromObject(&$object)	{		if( method_exists($object,'getErrors') )		{			$errors = $object->getErrors();			if(!empty($errors))			{				foreach($errors as $error)				{					$this->setError($error);				}			}			if(method_exists($object,'resetErrors'))			{				$object->resetErrors();			}		}		if( method_exists($object,'getWarnings') )		{			$warnings = $object->getWarnings();			if(!empty($warnings))			{				foreach($warnings as $warning)				{					$this->setWarning($warning);				}			}			if(method_exists($object,'resetWarnings'))			{				$object->resetWarnings();			}		}	}	/**	 * Sets the size of the error queue (acts like a LIFO buffer)	 * @param int $newSize The new queue size. Set to 0 for infinite length.	 */	protected function setErrorsQueueSize($newSize = 0)	{		$this->_errors_queue_size = (int)$newSize;	}	/**	 * Sets the size of the warnings queue (acts like a LIFO buffer)	 * @param int $newSize The new queue size. Set to 0 for infinite length.	 */	protected function setWarningsQueueSize($newSize = 0)	{		$this->_warnings_queue_size = (int)$newSize;	}	/**	 * Returns the last item of a LIFO string message queue, or a specific item	 * if so specified.	 * @param array $array An array of strings, holding messages	 * @param int $i Optional message index	 * @return mixed The message string, or false if the key doesn't exist	 */	private function getItemFromArray($array, $i = null)	{		// Find the item		if ( $i === null) {			// Default, return the last item			$item = end($array);		}		else		if ( ! array_key_exists($i, $array) ) {			// If $i has been specified but does not exist, return false			return false;		}		else		{			$item	= $array[$i];		}		return $item;	}}/** * File post processor engines base class */abstract class AKAbstractPostproc extends AKAbstractObject{	/** @var string The current (real) file path we'll have to process */	protected $filename = null;	/** @var int The requested permissions */	protected $perms = 0755;	/** @var string The temporary file path we gave to the unarchiver engine */	protected $tempFilename = null;	/** @var int The UNIX timestamp of the file's desired modification date */	public $timestamp = 0;	/**	 * Processes the current file, e.g. moves it from temp to final location by FTP	 */	abstract public function process();	/**	 * The unarchiver tells us the path to the filename it wants to extract and we give it	 * a different path instead.	 * @param string $filename The path to the real file	 * @param int $perms The permissions we need the file to have	 * @return string The path to the temporary file	 */	abstract public function processFilename($filename, $perms = 0755);	/**	 * Recursively creates a directory if it doesn't exist	 * @param string $dirName The directory to create	 * @param int $perms The permissions to give to that directory	 */	abstract public function createDirRecursive( $dirName, $perms );	abstract public function chmod( $file, $perms );	abstract public function unlink( $file );	abstract public function rmdir( $directory );	abstract public function rename( $from, $to );}/** * The base class of unarchiver classes */abstract class AKAbstractUnarchiver extends AKAbstractPart{	/** @var string Archive filename */	protected $filename = null;	/** @var array List of the names of all archive parts */	public $archiveList = array();	/** @var int The total size of all archive parts */	public $totalSize = array();	/** @var integer Current archive part number */	protected $currentPartNumber = -1;	/** @var integer The offset inside the current part */	protected $currentPartOffset = 0;	/** @var bool Should I restore permissions? */	protected $flagRestorePermissions = false;	/** @var AKAbstractPostproc Post processing class */	protected $postProcEngine = null;	/** @var string Absolute path to prepend to extracted files */	protected $addPath = '';	/** @var array Which files to rename */	public $renameFiles = array();	/** @var array Which directories to rename */	public $renameDirs = array();	/** @var array Which files to skip */	public $skipFiles = array();	/** @var integer Chunk size for processing */	protected $chunkSize = 524288;	/** @var resource File pointer to the current archive part file */	protected $fp = null;	/** @var int Run state when processing the current archive file */	protected $runState = null;	/** @var stdClass File header data, as read by the readFileHeader() method */	protected $fileHeader = null;	/** @var int How much of the uncompressed data we've read so far */	protected $dataReadLength = 0;	/**	 * Public constructor	 */	public function __construct()	{		parent::__construct();	}	/**	 * Wakeup function, called whenever the class is unserialized	 */	public function __wakeup()	{		if($this->currentPartNumber >= 0)		{			$this->fp = @fopen($this->archiveList[$this->currentPartNumber], 'rb');			if( (is_resource($this->fp)) && ($this->currentPartOffset > 0) )			{				@fseek($this->fp, $this->currentPartOffset);			}		}	}	/**	 * Sleep function, called whenever the class is serialized	 */	public function shutdown()	{		if(is_resource($this->fp))		{			$this->currentPartOffset = @ftell($this->fp);			@fclose($this->fp);		}	}	/**	 * Implements the abstract _prepare() method	 */	final protected function _prepare()	{		parent::__construct();		if( count($this->_parametersArray) > 0 )		{			foreach($this->_parametersArray as $key => $value)			{				switch($key)				{					case 'filename': // Archive's absolute filename						$this->filename = $value;						break;					case 'restore_permissions': // Should I restore permissions?						$this->flagRestorePermissions = $value;						break;					case 'post_proc': // Should I use FTP?						$this->postProcEngine = AKFactory::getpostProc($value);						break;					case 'add_path': // Path to prepend						$this->addPath = $value;						$this->addPath = str_replace('\\','/',$this->addPath);						$this->addPath = rtrim($this->addPath,'/');						if(!empty($this->addPath)) $this->addPath .= '/';						break;					case 'rename_files': // Which files to rename (hash array)						$this->renameFiles = $value;						break;										case 'rename_dirs': // Which files to rename (hash array)						$this->renameDirs = $value;						break;					case 'skip_files': // Which files to skip (indexed array)						$this->skipFiles = $value;						break;				}			}		}		$this->scanArchives();		$this->readArchiveHeader();		$errMessage = $this->getError();		if(!empty($errMessage))		{			$this->setState('error', $errMessage);		}		else		{			$this->runState = AK_STATE_NOFILE;			$this->setState('prepared');		}	}	protected function _run()	{		if($this->getState() == 'postrun') return;		$this->setState('running');		$timer = AKFactory::getTimer();		$status = true;		while( $status && ($timer->getTimeLeft() > 0) )		{			switch( $this->runState )			{				case AK_STATE_NOFILE:					$status = $this->readFileHeader();					if($status)					{						// Send start of file notification						$message = new stdClass;						$message->type = 'startfile';						$message->content = new stdClass;						if( array_key_exists('realfile', get_object_vars($this->fileHeader)) ) {							$message->content->realfile = $this->fileHeader->realFile;						} else {							$message->content->realfile = $this->fileHeader->file;						}						$message->content->file = $this->fileHeader->file;						if( array_key_exists('compressed', get_object_vars($this->fileHeader)) ) {							$message->content->compressed = $this->fileHeader->compressed;						} else {							$message->content->compressed = 0;						}						$message->content->uncompressed = $this->fileHeader->uncompressed;						$this->notify($message);					}					break;				case AK_STATE_HEADER:				case AK_STATE_DATA:					$status = $this->processFileData();					break;				case AK_STATE_DATAREAD:				case AK_STATE_POSTPROC:					$this->postProcEngine->timestamp = $this->fileHeader->timestamp;					$status = $this->postProcEngine->process();					$this->propagateFromObject( $this->postProcEngine );					$this->runState = AK_STATE_DONE;					break;				case AK_STATE_DONE:				default:					if($status)					{						// Send end of file notification						$message = new stdClass;						$message->type = 'endfile';						$message->content = new stdClass;						if( array_key_exists('realfile', get_object_vars($this->fileHeader)) ) {							$message->content->realfile = $this->fileHeader->realFile;						} else {							$message->content->realfile = $this->fileHeader->file;						}						$message->content->file = $this->fileHeader->file;						if( array_key_exists('compressed', get_object_vars($this->fileHeader)) ) {							$message->content->compressed = $this->fileHeader->compressed;						} else {							$message->content->compressed = 0;						}						$message->content->uncompressed = $this->fileHeader->uncompressed;						$this->notify($message);					}					$this->runState = AK_STATE_NOFILE;					continue;			}		}		$error = $this->getError();		if( !$status && ($this->runState == AK_STATE_NOFILE) && empty( $error ) )		{			// We just finished			$this->setState('postrun');		}		elseif( !empty($error) )		{			$this->setState( 'error', $error );		}	}	protected function _finalize()	{		// Nothing to do		$this->setState('finished');	}	/**	 * Returns the base extension of the file, e.g. '.jpa'	 * @return string	 */	private function getBaseExtension()	{		static $baseextension;		if(empty($baseextension))		{			$basename = basename($this->filename);			$lastdot = strrpos($basename,'.');			$baseextension = substr($basename, $lastdot);		}		return $baseextension;	}	/**	 * Scans for archive parts	 */	private function scanArchives()	{		$privateArchiveList = array();		// Get the components of the archive filename		$dirname = dirname($this->filename);		$base_extension = $this->getBaseExtension();		$basename = basename($this->filename, $base_extension);		$this->totalSize = 0;		// Scan for multiple parts until we don't find any more of them		$count = 0;		$found = true;		$this->archiveList = array();		while($found)		{			++$count;			$extension = substr($base_extension, 0, 2).sprintf('%02d', $count);			$filename = $dirname.DIRECTORY_SEPARATOR.$basename.$extension;			$found = file_exists($filename);			if($found)			{				// Add yet another part, with a numeric-appended filename				$this->archiveList[] = $filename;				$filesize = @filesize($filename);				$this->totalSize += $filesize;				$privateArchiveList[] = array($filename, $filesize);			}			else			{				// Add the last part, with the regular extension				$this->archiveList[] = $this->filename;				$filename = $this->filename;				$filesize = @filesize($filename);				$this->totalSize += $filesize;				$privateArchiveList[] = array($filename, $filesize);			}		}		$this->currentPartNumber = -1;		$this->currentPartOffset = 0;		$this->runState = AK_STATE_NOFILE;		// Send start of file notification		$message = new stdClass;		$message->type = 'totalsize';		$message->content = new stdClass;		$message->content->totalsize = $this->totalSize;		$message->content->filelist = $privateArchiveList;		$this->notify($message);	}	/**	 * Opens the next part file for reading	 */	protected function nextFile()	{		++$this->currentPartNumber;		if( $this->currentPartNumber > (count($this->archiveList) - 1) )		{			$this->setState('postrun');			return false;		}		else		{			if( is_resource($this->fp) ) @fclose($this->fp);			$this->fp = @fopen( $this->archiveList[$this->currentPartNumber], 'rb' );			fseek($this->fp, 0);			$this->currentPartOffset = 0;			return true;		}	}	/**	 * Returns true if we have reached the end of file	 * @param $local bool True to return EOF of the local file, false (default) to return if we have reached the end of the archive set	 * @return bool True if we have reached End Of File	 */	protected function isEOF($local = false)	{		$eof = @feof($this->fp);		if(!$eof)		{			// Border case: right at the part's end (eeeek!!!). For the life of me, I don't understand why			// feof() doesn't report true. It expects the fp to be positioned *beyond* the EOF to report			// true. Incredible! :(			$position = @ftell($this->fp);			$filesize = @filesize( $this->archiveList[$this->currentPartNumber] );			if( $position >= $filesize  ) $eof = true;		}		if($local)		{			return $eof;		}		else		{			return $eof && ($this->currentPartNumber >= (count($this->archiveList)-1) );		}	}	/**	 * Tries to make a directory user-writable so that we can write a file to it	 * @param $path string A path to a file	 */	protected function setCorrectPermissions($path)	{		static $rootDir = null;				if(is_null($rootDir)) {			$rootDir = rtrim(AKFactory::get('kickstart.setup.destdir',''),'/\\');		}				$directory = rtrim(dirname($path),'/\\');		if($directory != $rootDir) {			// Is this an unwritable directory?			if(!is_writeable($directory)) {				$this->postProcEngine->chmod( $directory, 0755 );			}		}		$this->postProcEngine->chmod( $path, 0644 );	}	/**	 * Concrete classes are supposed to use this method in order to read the archive's header and	 * prepare themselves to the point of being ready to extract the first file.	 */	protected abstract function readArchiveHeader();	/**	 * Concrete classes must use this method to read the file header	 * @return bool True if reading the file was successful, false if an error occured or we reached end of archive	 */	protected abstract function readFileHeader();	/**	 * Concrete classes must use this method to process file data. It must set $runState to AK_STATE_DATAREAD when	 * it's finished processing the file data.	 * @return bool True if processing the file data was successful, false if an error occured	 */	protected abstract function processFileData();	/**	 * Reads data from the archive and notifies the observer with the 'reading' message	 * @param $fp	 * @param $length	 */	protected function fread($fp, $length = null)	{		if(is_numeric($length))		{			if($length > 0) {				$data = fread($fp, $length);			} else {				$data = fread($fp);			}		}		else		{			$data = fread($fp);		}		if($data === false) $data = '';		// Send start of file notification		$message = new stdClass;		$message->type = 'reading';		$message->content = new stdClass;		$message->content->length = strlen($data);		$this->notify($message);		return $data;	}}/** * The superclass of all Akeeba Kickstart parts. The "parts" are intelligent stateful * classes which perform a single procedure and have preparation, running and * finalization phases. The transition between phases is handled automatically by * this superclass' tick() final public method, which should be the ONLY public API * exposed to the rest of the Akeeba Engine. */abstract class AKAbstractPart extends AKAbstractObject{	/**	 * Indicates whether this part has finished its initialisation cycle	 * @var boolean	 */	protected $isPrepared = false;	/**	 * Indicates whether this part has more work to do (it's in running state)	 * @var boolean	 */	protected $isRunning = false;	/**	 * Indicates whether this part has finished its finalization cycle	 * @var boolean	 */	protected $isFinished = false;	/**	 * Indicates whether this part has finished its run cycle	 * @var boolean	 */	protected $hasRan = false;	/**	 * The name of the engine part (a.k.a. Domain), used in return table	 * generation.	 * @var string	 */	protected $active_domain = "";	/**	 * The step this engine part is in. Used verbatim in return table and	 * should be set by the code in the _run() method.	 * @var string	 */	protected $active_step = "";	/**	 * A more detailed description of the step this engine part is in. Used	 * verbatim in return table and should be set by the code in the _run()	 * method.	 * @var string	 */	protected $active_substep = "";	/**	 * Any configuration variables, in the form of an array.	 * @var array	 */	protected $_parametersArray = array();	/** @var string The database root key */	protected $databaseRoot = array();	/** @var int Last reported warnings's position in array */	private $warnings_pointer = -1;	/** @var array An array of observers */	protected $observers = array();	/**	 * Runs the preparation for this part. Should set _isPrepared	 * to true	 */	abstract protected function _prepare();	/**	 * Runs the finalisation process for this part. Should set	 * _isFinished to true.	 */	abstract protected function _finalize();	/**	 * Runs the main functionality loop for this part. Upon calling,	 * should set the _isRunning to true. When it finished, should set	 * the _hasRan to true. If an error is encountered, setError should	 * be used.	 */	abstract protected function _run();	/**	 * Sets the BREAKFLAG, which instructs this engine part that the current step must break immediately,	 * in fear of timing out.	 */	protected function setBreakFlag()	{		AKFactory::set('volatile.breakflag', true);	}	/**	 * Sets the engine part's internal state, in an easy to use manner	 *	 * @param	string	$state			One of init, prepared, running, postrun, finished, error	 * @param	string	$errorMessage	The reported error message, should the state be set to error	 */	protected function setState($state = 'init', $errorMessage='Invalid setState argument')	{		switch($state)		{			case 'init':				$this->isPrepared = false;				$this->isRunning  = false;				$this->isFinished = false;				$this->hasRun     = false;				break;			case 'prepared':				$this->isPrepared = true;				$this->isRunning  = false;				$this->isFinished = false;				$this->hasRun     = false;				break;			case 'running':				$this->isPrepared = true;				$this->isRunning  = true;				$this->isFinished = false;				$this->hasRun     = false;				break;			case 'postrun':				$this->isPrepared = true;				$this->isRunning  = false;				$this->isFinished = false;				$this->hasRun     = true;				break;			case 'finished':				$this->isPrepared = true;				$this->isRunning  = false;				$this->isFinished = true;				$this->hasRun     = false;				break;			case 'error':			default:				$this->setError($errorMessage);				break;		}	}	/**	 * The public interface to an engine part. This method takes care for	 * calling the correct method in order to perform the initialisation -	 * run - finalisation cycle of operation and return a proper reponse array.	 * @return	array	A Reponse Array	 */	final public function tick()	{		// Call the right action method, depending on engine part state		switch( $this->getState() )		{			case "init":				$this->_prepare();				break;			case "prepared":				$this->_run();				break;			case "running":				$this->_run();				break;			case "postrun":				$this->_finalize();				break;		}		// Send a Return Table back to the caller		$out = $this->_makeReturnTable();		return $out;	}	/**	 * Returns a copy of the class's status array	 * @return array	 */	public function getStatusArray()	{		return $this->_makeReturnTable();	}	/**	 * Sends any kind of setup information to the engine part. Using this,	 * we avoid passing parameters to the constructor of the class. These	 * parameters should be passed as an indexed array and should be taken	 * into account during the preparation process only. This function will	 * set the error flag if it's called after the engine part is prepared.	 *	 * @param array $parametersArray The parameters to be passed to the	 * engine part.	 */	final public function setup( $parametersArray )	{		if( $this->isPrepared )		{			$this->setState('error', "Can't modify configuration after the preparation of " . $this->active_domain);		}		else		{			$this->_parametersArray = $parametersArray;			if(array_key_exists('root', $parametersArray))			{				$this->databaseRoot = $parametersArray['root'];			}		}	}	/**	 * Returns the state of this engine part.	 *	 * @return string The state of this engine part. It can be one of	 * error, init, prepared, running, postrun, finished.	 */	final public function getState()	{		if( $this->getError() )		{			return "error";		}		if( !($this->isPrepared) )		{			return "init";		}		if( !($this->isFinished) && !($this->isRunning) && !( $this->hasRun ) && ($this->isPrepared) )		{			return "prepared";		}		if ( !($this->isFinished) && $this->isRunning && !( $this->hasRun ) )		{			return "running";		}		if ( !($this->isFinished) && !($this->isRunning) && $this->hasRun )		{			return "postrun";		}		if ( $this->isFinished )		{			return "finished";		}	}	/**	 * Constructs a Response Array based on the engine part's state.	 * @return array The Response Array for the current state	 */	final protected function _makeReturnTable()	{		// Get a list of warnings		$warnings = $this->getWarnings();		// Report only new warnings if there is no warnings queue size		if( $this->_warnings_queue_size == 0 )		{			if( ($this->warnings_pointer > 0) && ($this->warnings_pointer < (count($warnings)) ) )			{				$warnings = array_slice($warnings, $this->warnings_pointer + 1);				$this->warnings_pointer += count($warnings);			}			else			{				$this->warnings_pointer = count($warnings);			}		}		$out =  array(			'HasRun'	=> (!($this->isFinished)),			'Domain'	=> $this->active_domain,			'Step'		=> $this->active_step,			'Substep'	=> $this->active_substep,			'Error'		=> $this->getError(),			'Warnings'	=> $warnings		);		return $out;	}	final protected function setDomain($new_domain)	{		$this->active_domain = $new_domain;	}	final public function getDomain()	{		return $this->active_domain;	}	final protected function setStep($new_step)	{		$this->active_step = $new_step;	}	final public function getStep()	{		return $this->active_step;	}	final protected function setSubstep($new_substep)	{		$this->active_substep = $new_substep;	}	final public function getSubstep()	{		return $this->active_substep;	}	/**	 * Attaches an observer object	 * @param AKAbstractPartObserver $obs	 */	function attach(AKAbstractPartObserver $obs) {        $this->observers["$obs"] = $obs;    }	/**	 * Dettaches an observer object	 * @param AKAbstractPartObserver $obs	 */    function detach(AKAbstractPartObserver $obs) {        delete($this->observers["$obs"]);    }    /**     * Notifies observers each time something interesting happened to the part     * @param mixed $message The event object     */	protected function notify($message) {        foreach ($this->observers as $obs) {            $obs->update($this, $message);        }    }}/** * Descendants of this class can be used in the unarchiver's observer methods (attach, detach and notify) * @author Nicholas * */abstract class AKAbstractPartObserver{	abstract public function update($object, $message);}/** * Direct file writer */class AKPostprocDirect extends AKAbstractPostproc{	public function process()	{		$restorePerms = AKFactory::get('kickstart.setup.restoreperms', false);		if($restorePerms)		{			@chmod($this->filename, $this->perms);		}		else		{			if(@is_file($this->filename))			{				@chmod($this->filename, 0644);			}			else			{				@chmod($this->filename, 0755);			}		}		if($this->timestamp > 0)		{			@touch($this->filename, $this->timestamp);		}		return true;	}	public function processFilename($filename, $perms = 0755)	{		$this->perms = $perms;		$this->filename = $filename;		return $filename;	}	public function createDirRecursive( $dirName, $perms )	{		if( AKFactory::get('kickstart.setup.dryrun','0') ) return true;		if (@mkdir($dirName, 0755, true)) {			@chmod($dirName, 0755);			return true;		}		$root = AKFactory::get('kickstart.setup.destdir');		$root = rtrim(str_replace('\\','/',$root),'/');		$dir = rtrim(str_replace('\\','/',$dirName),'/');		if(strpos($dir, $root) === 0) {			$dir = ltrim(substr($dir, strlen($root)), '/');			$root .= '/';		} else {			$root = '';		}				if(empty($dir)) return true;		$dirArray = explode('/', $dir);		$path = '';		foreach( $dirArray as $dir )		{			$path .= $dir . '/';			$ret = is_dir($root.$path) ? true : @mkdir($root.$path);			if( !$ret ) {				// Is this a file instead of a directory?				if(is_file($root.$path) )				{					@unlink($root.$path);					$ret = @mkdir($root.$path);				}				if( !$ret ) {					$this->setError( AKText::sprintf('COULDNT_CREATE_DIR',$path) );					return false;				}			}			// Try to set new directory permissions to 0755			@chmod($root.$path, $perms);		}		return true;	}	public function chmod( $file, $perms )	{		if( AKFactory::get('kickstart.setup.dryrun','0') ) return true;		return @chmod( $file, $perms );	}	public function unlink( $file )	{		return @unlink( $file );	}	public function rmdir( $directory )	{		return @rmdir( $directory );	}	public function rename( $from, $to )	{		return @rename($from, $to);	}}/** * FTP file writer */class AKPostprocFTP extends AKAbstractPostproc{	/** @var bool Should I use FTP over implicit SSL? */	public $useSSL = false;	/** @var bool use Passive mode? */	public $passive = true;	/** @var string FTP host name */	public $host = '';	/** @var int FTP port */	public $port = 21;	/** @var string FTP user name */	public $user = '';	/** @var string FTP password */	public $pass = '';	/** @var string FTP initial directory */	public $dir = '';	/** @var resource The FTP handle */	private $handle = null;	/** @var string The temporary directory where the data will be stored */	private $tempDir = '';	public function __construct()	{		parent::__construct();		$this->useSSL = AKFactory::get('kickstart.ftp.ssl', false);		$this->passive = AKFactory::get('kickstart.ftp.passive', true);		$this->host = AKFactory::get('kickstart.ftp.host', '');		$this->port = AKFactory::get('kickstart.ftp.port', 21);		if(trim($this->port) == '') $this->port = 21;		$this->user = AKFactory::get('kickstart.ftp.user', '');		$this->pass = AKFactory::get('kickstart.ftp.pass', '');		$this->dir = AKFactory::get('kickstart.ftp.dir', '');		$this->tempDir = AKFactory::get('kickstart.ftp.tempdir', '');		$connected = $this->connect();		if($connected)		{			if(!empty($this->tempDir))			{				$tempDir = rtrim($this->tempDir, '/\\').'/';				$writable = $this->isDirWritable($tempDir);			}			else			{				$tempDir = '';				$writable = false;			}			if(!$writable) {				// Default temporary directory is the current root				$tempDir = function_exists('getcwd') ? getcwd() : dirname(__FILE__);				if(empty($tempDir))				{					// Oh, we have no directory reported!					$tempDir = '.';				}				$absoluteDirToHere = $tempDir;				$tempDir = rtrim(str_replace('\\','/',$tempDir),'/');				if(!empty($tempDir)) $tempDir .= '/';				$this->tempDir = $tempDir;				// Is this directory writable?				$writable = $this->isDirWritable($tempDir);			}			if(!$writable)			{				// Nope. Let's try creating a temporary directory in the site's root.				$tempDir = $absoluteDirToHere.'/kicktemp';				$this->createDirRecursive($tempDir, 0777);				// Try making it writable...				$this->fixPermissions($tempDir);				$writable = $this->isDirWritable($tempDir);			}			// Was the new directory writable?			if(!$writable)			{				// Let's see if the user has specified one				$userdir = AKFactory::get('kickstart.ftp.tempdir', '');				if(!empty($userdir))				{					// Is it an absolute or a relative directory?					$absolute = false;					$absolute = $absolute || ( substr($userdir,0,1) == '/' );					$absolute = $absolute || ( substr($userdir,1,1) == ':' );					$absolute = $absolute || ( substr($userdir,2,1) == ':' );					if(!$absolute)					{						// Make absolute						$tempDir = $absoluteDirToHere.$userdir;					}					else					{						// it's already absolute						$tempDir = $userdir;					}					// Does the directory exist?					if( is_dir($tempDir) )					{						// Yeah. Is it writable?						$writable = $this->isDirWritable($tempDir);					}				}			}			$this->tempDir = $tempDir;			if(!$writable)			{				// No writable directory found!!!				$this->setError(AKText::_('FTP_TEMPDIR_NOT_WRITABLE'));			}			else			{				AKFactory::set('kickstart.ftp.tempdir', $tempDir);				$this->tempDir = $tempDir;			}		}	}	function __wakeup()	{		$this->connect();	}	public function connect()	{		// Connect to server, using SSL if so required		if($this->useSSL) {			$this->handle = @ftp_ssl_connect($this->host, $this->port);		} else {			$this->handle = @ftp_connect($this->host, $this->port);		}		if($this->handle === false)		{			$this->setError(AKText::_('WRONG_FTP_HOST'));			return false;		}		// Login		if(! @ftp_login($this->handle, $this->user, $this->pass))		{			$this->setError(AKText::_('WRONG_FTP_USER'));			@ftp_close($this->handle);			return false;		}		// Change to initial directory		if(! @ftp_chdir($this->handle, $this->dir))		{			$this->setError(AKText::_('WRONG_FTP_PATH1'));			@ftp_close($this->handle);			return false;		}		// Enable passive mode if the user requested it		if( $this->passive )		{			@ftp_pasv($this->handle, true);		}		else		{			@ftp_pasv($this->handle, false);		}		return true;	}	public function process()	{		if( is_null($this->tempFilename) )		{			// If an empty filename is passed, it means that we shouldn't do any post processing, i.e.			// the entity was a directory or symlink			return true;		}		$remotePath = dirname($this->filename);		$removePath = AKFactory::get('kickstart.setup.destdir','');		if(!empty($removePath))		{			$removePath = ltrim($removePath, "/");			$remotePath = ltrim($remotePath, "/");			$left = substr($remotePath, 0, strlen($removePath));			if($left == $removePath)			{				$remotePath = substr($remotePath, strlen($removePath));			}		}		$absoluteFSPath = dirname($this->filename);		$relativeFTPPath = trim($remotePath, '/');		$absoluteFTPPath = '/'.trim( $this->dir, '/' ).'/'.trim($remotePath, '/');		$onlyFilename = basename($this->filename);		$remoteName = $absoluteFTPPath.'/'.$onlyFilename;		$ret = @ftp_chdir($this->handle, $absoluteFTPPath);		if($ret === false)		{			$ret = $this->createDirRecursive( $absoluteFSPath, 0755);			if($ret === false) {				$this->setError(AKText::sprintf('FTP_COULDNT_UPLOAD', $this->filename));				return false;			}			$ret = @ftp_chdir($this->handle, $absoluteFTPPath);			if($ret === false) {				$this->setError(AKText::sprintf('FTP_COULDNT_UPLOAD', $this->filename));				return false;			}		}		$ret = @ftp_put($this->handle, $remoteName, $this->tempFilename, FTP_BINARY);		if($ret === false)		{			// If we couldn't create the file, attempt to fix the permissions in the PHP level and retry!			$this->fixPermissions($this->filename);			$this->unlink($this->filename);			$fp = @fopen($this->tempFilename);			if($fp !== false)			{				$ret = @ftp_fput($this->handle, $remoteName, $fp, FTP_BINARY);				@fclose($fp);			}			else			{				$ret = false;			}		}		@unlink($this->tempFilename);		if($ret === false)		{			$this->setError(AKText::sprintf('FTP_COULDNT_UPLOAD', $this->filename));			return false;		}		$restorePerms = AKFactory::get('kickstart.setup.restoreperms', false);		if($restorePerms)		{			@ftp_chmod($this->_handle, $perms, $remoteName);		}		else		{			@ftp_chmod($this->_handle, 0644, $remoteName);		}		return true;	}	public function processFilename($filename, $perms = 0755)	{		// Catch some error conditions...		if($this->getError())		{			return false;		}		// If a null filename is passed, it means that we shouldn't do any post processing, i.e.		// the entity was a directory or symlink		if(is_null($filename))		{			$this->filename = null;			$this->tempFilename = null;			return null;		}		// Strip absolute filesystem path to website's root		$removePath = AKFactory::get('kickstart.setup.destdir','');		if(!empty($removePath))		{			$left = substr($filename, 0, strlen($removePath));			if($left == $removePath)			{				$filename = substr($filename, strlen($removePath));			}		}		// Trim slash on the left		$filename = ltrim($filename, '/');		$this->filename = $filename;		$this->tempFilename = tempnam($this->tempDir, 'kickstart-');		$this->perms = $perms;		if( empty($this->tempFilename) )		{			// Oops! Let's try something different			$this->tempFilename = $this->tempDir.'/kickstart-'.time().'.dat';		}		return $this->tempFilename;	}	private function isDirWritable($dir)	{		$fp = @fopen($dir.'/kickstart.dat', 'wb');		if($fp === false)		{			return false;		}		else		{			@fclose($fp);			unlink($dir.'/kickstart.dat');			return true;		}	}	public function createDirRecursive( $dirName, $perms )	{		// Strip absolute filesystem path to website's root		$removePath = AKFactory::get('kickstart.setup.destdir','');		if(!empty($removePath))		{			// UNIXize the paths			$removePath = str_replace('\\','/',$removePath);			$dirName = str_replace('\\','/',$dirName);			// Make sure they both end in a slash			$removePath = rtrim($removePath,'/\\').'/';			$dirName = rtrim($dirName,'/\\').'/';			// Process the path removal			$left = substr($dirName, 0, strlen($removePath));			if($left == $removePath)			{				$dirName = substr($dirName, strlen($removePath));			}		}		if(empty($dirName)) $dirName = ''; // 'cause the substr() above may return FALSE.				$check = '/'.trim($this->dir,'/').'/'.trim($dirName, '/');		if($this->is_dir($check)) return true;		$alldirs = explode('/', $dirName);		$previousDir = '/'.trim($this->dir);		foreach($alldirs as $curdir)		{			$check = $previousDir.'/'.$curdir;			if(!$this->is_dir($check))			{				// Proactively try to delete a file by the same name				@ftp_delete($this->handle, $check);				if(@ftp_mkdir($this->handle, $check) === false)				{					// If we couldn't create the directory, attempt to fix the permissions in the PHP level and retry!					$this->fixPermissions($removePath.$check);					if(@ftp_mkdir($this->handle, $check) === false)					{						// Can we fall back to pure PHP mode, sire?						if(!@mkdir($check))						{							$this->setError(AKText::sprintf('FTP_CANT_CREATE_DIR',$dir));							return false;						}						else						{							// Since the directory was built by PHP, change its permissions							@chmod($check, "0777");							return true;						}					}				}				@ftp_chmod($this->handle, $perms, $check);			}			$previousDir = $check;		}		return true;	}	public function close()	{		@ftp_close($this->handle);	}	/*	 * Tries to fix directory/file permissions in the PHP level, so that	 * the FTP operation doesn't fail.	 * @param $path string The full path to a directory or file	 */	private function fixPermissions( $path )	{		// Turn off error reporting		if(!defined('KSDEBUG')) {			$oldErrorReporting = @error_reporting(E_NONE);		}		// Get UNIX style paths		$relPath = str_replace('\\','/',$path);		$basePath = rtrim(str_replace('\\','/',dirname(__FILE__)),'/');		$basePath = rtrim($basePath,'/');		if(!empty($basePath)) $basePath .= '/';		// Remove the leading relative root		if( substr($relPath,0,strlen($basePath)) == $basePath )			$relPath = substr($relPath,strlen($basePath));		$dirArray = explode('/', $relPath);		$pathBuilt = rtrim($basePath,'/');		foreach( $dirArray as $dir )		{			if(empty($dir)) continue;			$oldPath = $pathBuilt;			$pathBuilt .= '/'.$dir;			if(is_dir($oldPath.$dir))			{				@chmod($oldPath.$dir, 0777);			}			else			{				if(@chmod($oldPath.$dir, 0777) === false)				{					@unlink($oldPath.$dir);				}			}		}		// Restore error reporting		if(!defined('KSDEBUG')) {			@error_reporting($oldErrorReporting);		}	}	public function chmod( $file, $perms )	{		return @ftp_chmod($this->handle, $perms, $path);	}	private function is_dir( $dir )	{		return @ftp_chdir( $this->handle, $dir );	}	public function unlink( $file )	{		$removePath = AKFactory::get('kickstart.setup.destdir','');		if(!empty($removePath))		{			$left = substr($file, 0, strlen($removePath));			if($left == $removePath)			{				$file = substr($file, strlen($removePath));			}		}		$check = '/'.trim($this->dir,'/').'/'.trim($file, '/');		return @ftp_delete( $this->handle, $check );	}	public function rmdir( $directory )	{		$removePath = AKFactory::get('kickstart.setup.destdir','');		if(!empty($removePath))		{			$left = substr($directory, 0, strlen($removePath));			if($left == $removePath)			{				$directory = substr($directory, strlen($removePath));			}		}		$check = '/'.trim($this->dir,'/').'/'.trim($directory, '/');		return @ftp_rmdir( $this->handle, $check );	}	public function rename( $from, $to )	{		$originalFrom = $from;		$originalTo = $to;		$removePath = AKFactory::get('kickstart.setup.destdir','');		if(!empty($removePath))		{			$left = substr($from, 0, strlen($removePath));			if($left == $removePath)			{				$from = substr($from, strlen($removePath));			}		}		$from = '/'.trim($this->dir,'/').'/'.trim($from, '/');		if(!empty($removePath))		{			$left = substr($to, 0, strlen($removePath));			if($left == $removePath)			{				$to = substr($to, strlen($removePath));			}		}		$to = '/'.trim($this->dir,'/').'/'.trim($to, '/');		$result = @ftp_rename( $this->handle, $from, $to );		if($result !== true)		{			return @rename($from, $to);		}		else		{			return true;		}	}}/** * JPA archive extraction class */class AKUnarchiverJPA extends AKAbstractUnarchiver{	private $archiveHeaderData = array();	protected function readArchiveHeader()	{		// Initialize header data array		$this->archiveHeaderData = new stdClass();		// Open the first part		$this->nextFile();		// Fail for unreadable files		if( $this->fp === false ) return false;		// Read the signature		$sig = fread( $this->fp, 3 );		if ($sig != 'JPA')		{			// Not a JPA file			$this->setError( AKText::_('ERR_NOT_A_JPA_FILE') );			return false;		}		// Read and parse header length		$header_length_array = unpack( 'v', fread( $this->fp, 2 ) );		$header_length = $header_length_array[1];		// Read and parse the known portion of header data (14 bytes)		$bin_data = fread($this->fp, 14);		$header_data = unpack('Cmajor/Cminor/Vcount/Vuncsize/Vcsize', $bin_data);		// Load any remaining header data (forward compatibility)		$rest_length = $header_length - 19;		if( $rest_length > 0 )			$junk = fread($this->fp, $rest_length);		else			$junk = '';		// Temporary array with all the data we read		$temp = array(			'signature' => 			$sig,			'length' => 			$header_length,			'major' => 				$header_data['major'],			'minor' => 				$header_data['minor'],			'filecount' => 			$header_data['count'],			'uncompressedsize' => 	$header_data['uncsize'],			'compressedsize' => 	$header_data['csize'],			'unknowndata' => 		$junk		);		// Array-to-object conversion		foreach($temp as $key => $value)		{			$this->archiveHeaderData->{$key} = $value;		}		$this->currentPartOffset = @ftell($this->fp);		$this->dataReadLength = 0;		return true;	}	/**	 * Concrete classes must use this method to read the file header	 * @return bool True if reading the file was successful, false if an error occured or we reached end of archive	 */	protected function readFileHeader()	{		// If the current part is over, proceed to the next part please		if( $this->isEOF(true) ) {			$this->nextFile();		}		// Get and decode Entity Description Block		$signature = fread($this->fp, 3);		$this->fileHeader = new stdClass();		$this->fileHeader->timestamp = 0;		// Check signature		if( $signature != 'JPF' )		{			if($this->isEOF(true))			{				// This file is finished; make sure it's the last one				$this->nextFile();				if(!$this->isEOF(false))				{					$this->setError(AKText::sprintf('INVALID_FILE_HEADER', $this->currentPartNumber, $this->currentPartOffset));					return false;				}				// We're just finished				return false;			}			else			{				// This is not a file block! The archive is corrupt.				$this->setError(AKText::sprintf('INVALID_FILE_HEADER', $this->currentPartNumber, $this->currentPartOffset));				return false;			}		}		// This a JPA Entity Block. Process the header.		$isBannedFile = false;		// Read length of EDB and of the Entity Path Data		$length_array = unpack('vblocksize/vpathsize', fread($this->fp, 4));		// Read the path data		if($length_array['pathsize'] > 0) {			$file = fread( $this->fp, $length_array['pathsize'] );		} else {			$file = '';		}		// Handle file renaming		$isRenamed = false;		if(is_array($this->renameFiles) && (count($this->renameFiles) > 0) )		{			if(array_key_exists($file, $this->renameFiles))			{				$file = $this->renameFiles[$file];				$isRenamed = true;			}		}				// Handle directory renaming		$isDirRenamed = false;		if(is_array($this->renameDirs) && (count($this->renameDirs) > 0)) {			if(array_key_exists(dirname($file), $this->renameDirs)) {				$file = rtrim($this->renameDirs[dirname($file)],'/').'/'.basename($file);				$isRenamed = true;				$isDirRenamed = true;			}		}		// Read and parse the known data portion		$bin_data = fread( $this->fp, 14 );		$header_data = unpack('Ctype/Ccompression/Vcompsize/Vuncompsize/Vperms', $bin_data);		// Read any unknown data		$restBytes = $length_array['blocksize'] - (21 + $length_array['pathsize']);		if( $restBytes > 0 )		{			// Start reading the extra fields			while($restBytes >= 4)			{				$extra_header_data = fread($this->fp, 4);				$extra_header = unpack('vsignature/vlength', $extra_header_data);				$restBytes -= 4;				$extra_header['length'] -= 4;				switch($extra_header['signature'])				{					case 256:						// File modified timestamp						if($extra_header['length'] > 0)						{							$bindata = fread($this->fp, $extra_header['length']);							$restBytes -= $extra_header['length'];							$timestamps = unpack('Vmodified', substr($bindata,0,4));							$filectime = $timestamps['modified'];							$this->fileHeader->timestamp = $filectime;						}						break;					default:						// Unknown field						if($extra_header['length']>0) {							$junk = fread($this->fp, $extra_header['length']);							$restBytes -= $extra_header['length'];						}						break;				}			}			if($restBytes > 0) $junk = fread($this->fp, $restBytes);		}		$compressionType = $header_data['compression'];		// Populate the return array		$this->fileHeader->file = $file;		$this->fileHeader->compressed = $header_data['compsize'];		$this->fileHeader->uncompressed = $header_data['uncompsize'];		switch($header_data['type'])		{			case 0:				$this->fileHeader->type = 'dir';				break;			case 1:				$this->fileHeader->type = 'file';				break;			case 2:				$this->fileHeader->type = 'link';				break;		}		switch( $compressionType )		{			case 0:				$this->fileHeader->compression = 'none';				break;			case 1:				$this->fileHeader->compression = 'gzip';				break;			case 2:				$this->fileHeader->compression = 'bzip2';				break;		}		$this->fileHeader->permissions = $header_data['perms'];		// Find hard-coded banned files		if( (basename($this->fileHeader->file) == ".") || (basename($this->fileHeader->file) == "..") )		{			$isBannedFile = true;		}		// Also try to find banned files passed in class configuration		if((count($this->skipFiles) > 0) && (!$isRenamed) )		{			if(in_array($this->fileHeader->file, $this->skipFiles))			{				$isBannedFile = true;			}		}		// If we have a banned file, let's skip it		if($isBannedFile)		{			// Advance the file pointer, skipping exactly the size of the compressed data			$seekleft = $this->fileHeader->compressed;			while($seekleft > 0)			{				// Ensure that we can seek past archive part boundaries				$curSize = @filesize($this->archiveList[$this->currentPartNumber]);				$curPos = @ftell($this->fp);				$canSeek = $curSize - $curPos;				if($canSeek > $seekleft) $canSeek = $seekleft;				@fseek( $this->fp, $canSeek, SEEK_CUR );				$seekleft -= $canSeek;				if($seekleft) $this->nextFile();			}			$this->currentPartOffset = @ftell($this->fp);			$this->runState = AK_STATE_DONE;			return true;		}		// Last chance to prepend a path to the filename		if(!empty($this->addPath) && !$isDirRenamed)		{			$this->fileHeader->file = $this->addPath.$this->fileHeader->file;		}		// Get the translated path name		$restorePerms = AKFactory::get('kickstart.setup.restoreperms', false);		if($this->fileHeader->type == 'file')		{			// Regular file; ask the postproc engine to process its filename			if($restorePerms)			{				$this->fileHeader->realFile = $this->postProcEngine->processFilename( $this->fileHeader->file, $this->fileHeader->permissions );			}			else			{				$this->fileHeader->realFile = $this->postProcEngine->processFilename( $this->fileHeader->file );			}		}		elseif($this->fileHeader->type == 'dir')		{			$dir = $this->fileHeader->file;			// Directory; just create it			if($restorePerms)			{				$this->postProcEngine->createDirRecursive( $this->fileHeader->file, $this->fileHeader->permissions );			}			else			{				$this->postProcEngine->createDirRecursive( $this->fileHeader->file, 0755 );			}			$this->postProcEngine->processFilename(null);		}		else		{			// Symlink; do not post-process			$this->postProcEngine->processFilename(null);		}		$this->createDirectory();		// Header is read		$this->runState = AK_STATE_HEADER;		$this->dataReadLength = 0;		return true;	}	/**	 * Concrete classes must use this method to process file data. It must set $runState to AK_STATE_DATAREAD when	 * it's finished processing the file data.	 * @return bool True if processing the file data was successful, false if an error occured	 */	protected function processFileData()	{		switch( $this->fileHeader->type )		{			case 'dir':				return $this->processTypeDir();				break;			case 'link':				return $this->processTypeLink();				break;			case 'file':				switch($this->fileHeader->compression)				{					case 'none':						return $this->processTypeFileUncompressed();						break;					case 'gzip':					case 'bzip2':						return $this->processTypeFileCompressedSimple();						break;				}				break;		}	}	private function processTypeFileUncompressed()	{		// Uncompressed files are being processed in small chunks, to avoid timeouts		if( ($this->dataReadLength == 0) && !AKFactory::get('kickstart.setup.dryrun','0') )		{			// Before processing file data, ensure permissions are adequate			$this->setCorrectPermissions( $this->fileHeader->file );		}		// Open the output file		if( !AKFactory::get('kickstart.setup.dryrun','0') )		{			$ignore = AKFactory::get('kickstart.setup.ignoreerrors', false);			if ($this->dataReadLength == 0) {				$outfp = @fopen( $this->fileHeader->realFile, 'wb' );			} else {				$outfp = @fopen( $this->fileHeader->realFile, 'ab' );			}			// Can we write to the file?			if( ($outfp === false) && (!$ignore) ) {				// An error occured				$this->setError( AKText::sprintf('COULDNT_WRITE_FILE', $this->fileHeader->realFile) );				return false;			}		}		// Does the file have any data, at all?		if( $this->fileHeader->compressed == 0 )		{			// No file data!			if( !AKFactory::get('kickstart.setup.dryrun','0') && is_resource($outfp) ) @fclose($outfp);			$this->runState = AK_STATE_DATAREAD;			return true;		}		// Reference to the global timer		$timer = AKFactory::getTimer();		$toReadBytes = 0;		$leftBytes = $this->fileHeader->compressed - $this->dataReadLength;		// Loop while there's data to read and enough time to do it		while( ($leftBytes > 0) && ($timer->getTimeLeft() > 0) )		{			$toReadBytes = ($leftBytes > $this->chunkSize) ? $this->chunkSize : $leftBytes;			$data = $this->fread( $this->fp, $toReadBytes );			$reallyReadBytes = akstringlen($data);			$leftBytes -= $reallyReadBytes;			$this->dataReadLength += $reallyReadBytes;			if($reallyReadBytes < $toReadBytes)			{				// We read less than requested! Why? Did we hit local EOF?				if( $this->isEOF(true) && !$this->isEOF(false) )				{					// Yeap. Let's go to the next file					$this->nextFile();				}				else				{					// Nope. The archive is corrupt					$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );					return false;				}			}			if( !AKFactory::get('kickstart.setup.dryrun','0') )				if(is_resource($outfp)) @fwrite( $outfp, $data );		}		// Close the file pointer		if( !AKFactory::get('kickstart.setup.dryrun','0') )			if(is_resource($outfp)) @fclose($outfp);		// Was this a pre-timeout bail out?		if( $leftBytes > 0 )		{			$this->runState = AK_STATE_DATA;		}		else		{			// Oh! We just finished!			$this->runState = AK_STATE_DATAREAD;			$this->dataReadLength = 0;		}		return true;	}	private function processTypeFileCompressedSimple()	{		if( !AKFactory::get('kickstart.setup.dryrun','0') )		{			// Before processing file data, ensure permissions are adequate			$this->setCorrectPermissions( $this->fileHeader->file );			// Open the output file			$outfp = @fopen( $this->fileHeader->realFile, 'wb' );			// Can we write to the file?			$ignore = AKFactory::get('kickstart.setup.ignoreerrors', false);			if( ($outfp === false) && (!$ignore) ) {				// An error occured				$this->setError( AKText::sprintf('COULDNT_WRITE_FILE', $this->fileHeader->realFile) );				return false;			}		}		// Does the file have any data, at all?		if( $this->fileHeader->compressed == 0 )		{			// No file data!			if( !AKFactory::get('kickstart.setup.dryrun','0') )				if(is_resource($outfp)) @fclose($outfp);			$this->runState = AK_STATE_DATAREAD;			return true;		}		// Simple compressed files are processed as a whole; we can't do chunk processing		$zipData = $this->fread( $this->fp, $this->fileHeader->compressed );		while( akstringlen($zipData) < $this->fileHeader->compressed )		{			// End of local file before reading all data, but have more archive parts?			if($this->isEOF(true) && !$this->isEOF(false))			{				// Yeap. Read from the next file				$this->nextFile();				$bytes_left = $this->fileHeader->compressed - akstringlen($zipData);				$zipData .= $this->fread( $this->fp, $bytes_left );			}			else			{				$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );				return false;			}		}		if($this->fileHeader->compression == 'gzip')		{			$unzipData = gzinflate( $zipData );		}		elseif($this->fileHeader->compression == 'bzip2')		{			$unzipData = bzdecompress( $zipData );		}		unset($zipData);		// Write to the file.		if( !AKFactory::get('kickstart.setup.dryrun','0') && is_resource($outfp) )		{			@fwrite( $outfp, $unzipData, $this->fileHeader->uncompressed );			@fclose( $outfp );		}		unset($unzipData);		$this->runState = AK_STATE_DATAREAD;		return true;	}	/**	 * Process the file data of a link entry	 * @return bool	 */	private function processTypeLink()	{		$readBytes = 0;		$toReadBytes = 0;		$leftBytes = $this->fileHeader->compressed;		$data = '';		while( $leftBytes > 0)		{			$toReadBytes = ($leftBytes > $this->chunkSize) ? $this->chunkSize : $leftBytes;			$mydata = $this->fread( $this->fp, $toReadBytes );			$reallyReadBytes = akstringlen($mydata);			$data .= $mydata;			$leftBytes -= $reallyReadBytes;			if($reallyReadBytes < $toReadBytes)			{				// We read less than requested! Why? Did we hit local EOF?				if( $this->isEOF(true) && !$this->isEOF(false) )				{					// Yeap. Let's go to the next file					$this->nextFile();				}				else				{					// Nope. The archive is corrupt					$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );					return false;				}			}		}		// Try to remove an existing file or directory by the same name		if(file_exists($this->fileHeader->realFile)) { @unlink($this->fileHeader->realFile); @rmdir($this->fileHeader->realFile); }		// Remove any trailing slash		if(substr($this->fileHeader->realFile, -1) == '/') $this->fileHeader->realFile = substr($this->fileHeader->realFile, 0, -1);		// Create the symlink - only possible within PHP context. There's no support built in the FTP protocol, so no postproc use is possible here :(		if( !AKFactory::get('kickstart.setup.dryrun','0') )			@symlink($data, $this->fileHeader->realFile);		$this->runState = AK_STATE_DATAREAD;		return true; // No matter if the link was created!	}	/**	 * Process the file data of a directory entry	 * @return bool	 */	private function processTypeDir()	{		// Directory entries in the JPA do not have file data, therefore we're done processing the entry		$this->runState = AK_STATE_DATAREAD;		return true;	}	/**	 * Creates the directory this file points to	 */	protected function createDirectory()	{		if( AKFactory::get('kickstart.setup.dryrun','0') ) return true;		// Do we need to create a directory?		if(empty($this->fileHeader->realFile)) $this->fileHeader->realFile = $this->fileHeader->file;		$lastSlash = strrpos($this->fileHeader->realFile, '/');		$dirName = substr( $this->fileHeader->realFile, 0, $lastSlash);		$perms = $this->flagRestorePermissions ? $retArray['permissions'] : 0755;		$ignore = AKFactory::get('kickstart.setup.ignoreerrors', false);		if( ($this->postProcEngine->createDirRecursive($dirName, $perms) == false) && (!$ignore) ) {			$this->setError( AKText::sprintf('COULDNT_CREATE_DIR', $dirName) );			return false;		}		else		{			return true;		}	}}/** * ZIP archive extraction class * * Since the file data portion of ZIP and JPA are similarly structured (it's empty for dirs, * linked node name for symlinks, dumped binary data for no compressions and dumped gzipped * binary data for gzip compression) we just have to subclass AKUnarchiverJPA and change the * header reading bits. Reusable code ;) */class AKUnarchiverZIP extends AKUnarchiverJPA{	var $expectDataDescriptor = false;	protected function readArchiveHeader()	{		// Initialize header data array		$this->archiveHeaderData = new stdClass();		// Open the first part		$this->nextFile();		// Fail for unreadable files		if( $this->fp === false ) return false;		// Read a possible multipart signature		$sigBinary = fread( $this->fp, 4 );		$headerData = unpack('Vsig', $sigBinary);		// Roll back if it's not a multipart archive		if( $headerData['sig'] == 0x04034b50 ) fseek($this->fp, -4, SEEK_CUR);		$multiPartSigs = array(			0x08074b50,		// Multi-part ZIP			0x30304b50,		// Multi-part ZIP (alternate)			0x04034b50		// Single file		);		if( !in_array($headerData['sig'], $multiPartSigs) )		{			$this->setError(AKText::_('ERR_CORRUPT_ARCHIVE'));			return false;		}		$this->currentPartOffset = @ftell($this->fp);		$this->dataReadLength = 0;		return true;	}	/**	 * Concrete classes must use this method to read the file header	 * @return bool True if reading the file was successful, false if an error occured or we reached end of archive	 */	protected function readFileHeader()	{		// If the current part is over, proceed to the next part please		if( $this->isEOF(true) ) {			$this->nextFile();		}		if($this->expectDataDescriptor)		{			// The last file had bit 3 of the general purpose bit flag set. This means that we have a			// 12 byte data descriptor we need to skip. To make things worse, there might also be a 4			// byte optional data descriptor header (0x08074b50).			$junk = @fread($this->fp, 4);			$junk = unpack('Vsig', $junk);			if($junk['sig'] == 0x08074b50) {				// Yes, there was a signature				$junk = @fread($this->fp, 12);				if(defined('KSDEBUG')) {					debugMsg('Data descriptor (w/ header) skipped at '.(ftell($this->fp)-12));				}			} else {				// No, there was no signature, just read another 8 bytes				$junk = @fread($this->fp, 8);				if(defined('KSDEBUG')) {					debugMsg('Data descriptor (w/out header) skipped at '.(ftell($this->fp)-8));				}			}			// And check for EOF, too			if( $this->isEOF(true) ) {				if(defined('KSDEBUG')) {					debugMsg('EOF before reading header');				}								$this->nextFile();			}		}		// Get and decode Local File Header		$headerBinary = fread($this->fp, 30);		$headerData = unpack('Vsig/C2ver/vbitflag/vcompmethod/vlastmodtime/vlastmoddate/Vcrc/Vcompsize/Vuncomp/vfnamelen/veflen', $headerBinary);		// Check signature		if(!( $headerData['sig'] == 0x04034b50 ))		{			if(defined('KSDEBUG')) {				debugMsg('Not a file signature at '.(ftell($this->fp)-4));			}						// The signature is not the one used for files. Is this a central directory record (i.e. we're done)?			if($headerData['sig'] == 0x02014b50)			{				if(defined('KSDEBUG')) {					debugMsg('EOCD signature at '.(ftell($this->fp)-4));				}				// End of ZIP file detected. We'll just skip to the end of file...				while( $this->nextFile() ) {};				@fseek($this->fp, 0, SEEK_END); // Go to EOF				return false;			}			else			{				if(defined('KSDEBUG')) {					debugMsg( 'Invalid signature ' . dechex($headerData['sig']) . ' at '.ftell($this->fp) );				}				$this->setError(AKText::_('ERR_CORRUPT_ARCHIVE'));				return false;			}		}		// If bit 3 of the bitflag is set, expectDataDescriptor is true		$this->expectDataDescriptor = ($headerData['bitflag'] & 4) == 4;		$this->fileHeader = new stdClass();		$this->fileHeader->timestamp = 0;		// Read the last modified data and time		$lastmodtime = $headerData['lastmodtime'];		$lastmoddate = $headerData['lastmoddate'];				if($lastmoddate && $lastmodtime)		{			// ----- Extract time			$v_hour = ($lastmodtime & 0xF800) >> 11;			$v_minute = ($lastmodtime & 0x07E0) >> 5;			$v_seconde = ($lastmodtime & 0x001F)*2;						// ----- Extract date			$v_year = (($lastmoddate & 0xFE00) >> 9) + 1980;			$v_month = ($lastmoddate & 0x01E0) >> 5;			$v_day = $lastmoddate & 0x001F;						// ----- Get UNIX date format			$this->fileHeader->timestamp = @mktime($v_hour, $v_minute, $v_seconde, $v_month, $v_day, $v_year);		}				$isBannedFile = false;		$this->fileHeader->compressed	= $headerData['compsize'];		$this->fileHeader->uncompressed	= $headerData['uncomp'];		$nameFieldLength				= $headerData['fnamelen'];		$extraFieldLength				= $headerData['eflen'];		// Read filename field		$this->fileHeader->file			= fread( $this->fp, $nameFieldLength );		// Handle file renaming		$isRenamed = false;		if(is_array($this->renameFiles) && (count($this->renameFiles) > 0) )		{			if(array_key_exists($this->fileHeader->file, $this->renameFiles))			{				$this->fileHeader->file = $this->renameFiles[$this->fileHeader->file];				$isRenamed = true;			}		}				// Handle directory renaming		$isDirRenamed = false;		if(is_array($this->renameDirs) && (count($this->renameDirs) > 0)) {			if(array_key_exists(dirname($file), $this->renameDirs)) {				$file = rtrim($this->renameDirs[dirname($file)],'/').'/'.basename($file);				$isRenamed = true;				$isDirRenamed = true;			}		}		// Read extra field if present		if($extraFieldLength > 0) {			$extrafield = fread( $this->fp, $extraFieldLength );		}				if(defined('KSDEBUG')) {			debugMsg( '*'.ftell($this->fp).' IS START OF '.$this->fileHeader->file. ' ('.$this->fileHeader->compressed.' bytes)' );		}				// Decide filetype -- Check for directories		$this->fileHeader->type = 'file';		if( strrpos($this->fileHeader->file, '/') == strlen($this->fileHeader->file) - 1 ) $this->fileHeader->type = 'dir';		// Decide filetype -- Check for symbolic links		if( ($headerData['ver1'] == 10) && ($headerData['ver2'] == 3) )$this->fileHeader->type = 'link';		switch( $headerData['compmethod'] )		{			case 0:				$this->fileHeader->compression = 'none';				break;			case 8:				$this->fileHeader->compression = 'gzip';				break;		}		// Find hard-coded banned files		if( (basename($this->fileHeader->file) == ".") || (basename($this->fileHeader->file) == "..") )		{			$isBannedFile = true;		}		// Also try to find banned files passed in class configuration		if((count($this->skipFiles) > 0) && (!$isRenamed))		{			if(in_array($this->fileHeader->file, $this->skipFiles))			{				$isBannedFile = true;			}		}		// If we have a banned file, let's skip it		if($isBannedFile)		{			// Advance the file pointer, skipping exactly the size of the compressed data			$seekleft = $this->fileHeader->compressed;			while($seekleft > 0)			{				// Ensure that we can seek past archive part boundaries				$curSize = @filesize($this->archiveList[$this->currentPartNumber]);				$curPos = @ftell($this->fp);				$canSeek = $curSize - $curPos;				if($canSeek > $seekleft) $canSeek = $seekleft;				@fseek( $this->fp, $canSeek, SEEK_CUR );				$seekleft -= $canSeek;				if($seekleft) $this->nextFile();			}			$this->currentPartOffset = @ftell($this->fp);			$this->runState = AK_STATE_DONE;			return true;		}		// Last chance to prepend a path to the filename		if(!empty($this->addPath) && !$isDirRenamed)		{			$this->fileHeader->file = $this->addPath.$this->fileHeader->file;		}		// Get the translated path name		if($this->fileHeader->type == 'file')		{			$this->fileHeader->realFile = $this->postProcEngine->processFilename( $this->fileHeader->file );		}		elseif($this->fileHeader->type == 'dir')		{			$this->fileHeader->timestamp = 0;			$dir = $this->fileHeader->file;			$this->postProcEngine->createDirRecursive( $this->fileHeader->file, 0755 );			$this->postProcEngine->processFilename(null);		}		else		{			// Symlink; do not post-process			$this->fileHeader->timestamp = 0;			$this->postProcEngine->processFilename(null);		}		$this->createDirectory();		// Header is read		$this->runState = AK_STATE_HEADER;		return true;	}}/** * Timer class */class AKCoreTimer extends AKAbstractObject{	/** @var int Maximum execution time allowance per step */	private $max_exec_time = null;	/** @var int Timestamp of execution start */	private $start_time = null;	/**	 * Public constructor, creates the timer object and calculates the execution time limits	 * @return AECoreTimer	 */	public function __construct()	{		parent::__construct();		// Initialize start time		$this->start_time = $this->microtime_float();		// Get configured max time per step and bias		$config_max_exec_time	= AKFactory::get('kickstart.tuning.max_exec_time', 14);		$bias					= AKFactory::get('kickstart.tuning.run_time_bias', 75)/100;		// Get PHP's maximum execution time (our upper limit)		if(@function_exists('ini_get'))		{			$php_max_exec_time = @ini_get("maximum_execution_time");			if ( (!is_numeric($php_max_exec_time)) || ($php_max_exec_time == 0) ) {				// If we have no time limit, set a hard limit of about 10 seconds				// (safe for Apache and IIS timeouts, verbose enough for users)				$php_max_exec_time = 14;			}		}		else		{			// If ini_get is not available, use a rough default			$php_max_exec_time = 14;		}		// Apply an arbitrary correction to counter CMS load time		$php_max_exec_time--;		// Apply bias		$php_max_exec_time = $php_max_exec_time * $bias;		$config_max_exec_time = $config_max_exec_time * $bias;		// Use the most appropriate time limit value		if( $config_max_exec_time > $php_max_exec_time )		{			$this->max_exec_time = $php_max_exec_time;		}		else		{			$this->max_exec_time = $config_max_exec_time;		}	}	/**	 * Wake-up function to reset internal timer when we get unserialized	 */	public function __wakeup()	{		// Re-initialize start time on wake-up		$this->start_time = $this->microtime_float();	}	/**	 * Gets the number of seconds left, before we hit the "must break" threshold	 * @return float	 */	public function getTimeLeft()	{		return $this->max_exec_time - $this->getRunningTime();	}	/**	 * Gets the time elapsed since object creation/unserialization, effectively how	 * long Akeeba Engine has been processing data	 * @return float	 */	public function getRunningTime()	{		return $this->microtime_float() - $this->start_time;	}	/**	 * Returns the current timestampt in decimal seconds	 */	private function microtime_float()	{		list($usec, $sec) = explode(" ", microtime());		return ((float)$usec + (float)$sec);	}	/**	 * Enforce the minimum execution time	 */	public function enforce_min_exec_time()	{		// Try to get a sane value for PHP's maximum_execution_time INI parameter		if(@function_exists('ini_get'))		{			$php_max_exec = @ini_get("maximum_execution_time");		}		else		{			$php_max_exec = 10;		}		if ( ($php_max_exec == "") || ($php_max_exec == 0) ) {			$php_max_exec = 10;		}		// Decrease $php_max_exec time by 500 msec we need (approx.) to tear down		// the application, as well as another 500msec added for rounding		// error purposes. Also make sure this is never gonna be less than 0.		$php_max_exec = max($php_max_exec * 1000 - 1000, 0);		// Get the "minimum execution time per step" Akeeba Backup configuration variable		$minexectime = AKFactory::get('kickstart.tuning.min_exec_time',0);		if(!is_numeric($minexectime)) $minexectime = 0;		// Make sure we are not over PHP's time limit!		if($minexectime > $php_max_exec) $minexectime = $php_max_exec;		// Get current running time		$elapsed_time = $this->getRunningTime() * 1000;			// Only run a sleep delay if we haven't reached the minexectime execution time		if( ($minexectime > $elapsed_time) && ($elapsed_time > 0) )		{			$sleep_msec = $minexectime - $elapsed_time;			if(function_exists('usleep'))			{				usleep(1000 * $sleep_msec);			}			elseif(function_exists('time_nanosleep'))			{				$sleep_sec = floor($sleep_msec / 1000);				$sleep_nsec = 1000000 * ($sleep_msec - ($sleep_sec * 1000));				time_nanosleep($sleep_sec, $sleep_nsec);			}			elseif(function_exists('time_sleep_until'))			{				$until_timestamp = time() + $sleep_msec / 1000;				time_sleep_until($until_timestamp);			}			elseif(function_exists('sleep'))			{				$sleep_sec = ceil($sleep_msec/1000);				sleep( $sleep_sec );			}		}		elseif( $elapsed_time > 0 )		{			// No sleep required, even if user configured us to be able to do so.		}	}	/**	 * Reset the timer. It should only be used in CLI mode!	 */	public function resetTime()	{		$this->start_time = $this->microtime_float();	}}/** * JPS archive extraction class */class AKUnarchiverJPS extends AKUnarchiverJPA{	private $archiveHeaderData = array();	private $password = '';	public function __construct()	{		parent::__construct();		$this->password = AKFactory::get('kickstart.jps.password','');	}	protected function readArchiveHeader()	{		// Initialize header data array		$this->archiveHeaderData = new stdClass();		// Open the first part		$this->nextFile();		// Fail for unreadable files		if( $this->fp === false ) return false;		// Read the signature		$sig = fread( $this->fp, 3 );		if ($sig != 'JPS')		{			// Not a JPA file			$this->setError( AKText::_('ERR_NOT_A_JPS_FILE') );			return false;		}		// Read and parse the known portion of header data (5 bytes)		$bin_data = fread($this->fp, 5);		$header_data = unpack('Cmajor/Cminor/cspanned/vextra', $bin_data);		// Load any remaining header data (forward compatibility)		$rest_length = $header_data['extra'];		if( $rest_length > 0 )			$junk = fread($this->fp, $rest_length);		else			$junk = '';		// Temporary array with all the data we read		$temp = array(			'signature' => 			$sig,			'major' => 				$header_data['major'],			'minor' => 				$header_data['minor'],			'spanned' => 			$header_data['spanned']		);		// Array-to-object conversion		foreach($temp as $key => $value)		{			$this->archiveHeaderData->{$key} = $value;		}		$this->currentPartOffset = @ftell($this->fp);		$this->dataReadLength = 0;		return true;	}	/**	 * Concrete classes must use this method to read the file header	 * @return bool True if reading the file was successful, false if an error occured or we reached end of archive	 */	protected function readFileHeader()	{		// If the current part is over, proceed to the next part please		if( $this->isEOF(true) ) {			$this->nextFile();		}		// Get and decode Entity Description Block		$signature = fread($this->fp, 3);		// Check for end-of-archive siganture		if($signature == 'JPE')		{			$this->setState('postrun');			return true;		}		$this->fileHeader = new stdClass();		$this->fileHeader->timestamp = 0;		// Check signature		if( $signature != 'JPF' )		{			if($this->isEOF(true))			{				// This file is finished; make sure it's the last one				$this->nextFile();				if(!$this->isEOF(false))				{					$this->setError(AKText::sprintf('INVALID_FILE_HEADER', $this->currentPartNumber, $this->currentPartOffset));					return false;				}				// We're just finished				return false;			}			else			{				fseek($this->fp, -6, SEEK_CUR);				$signature = fread($this->fp, 3);				if($signature == 'JPE')				{					return false;				}				$this->setError(AKText::sprintf('INVALID_FILE_HEADER', $this->currentPartNumber, $this->currentPartOffset));				return false;			}		}		// This a JPA Entity Block. Process the header.		$isBannedFile = false;		// Read and decrypt the header		$edbhData = fread($this->fp, 4);		$edbh = unpack('vencsize/vdecsize', $edbhData);		$bin_data = fread($this->fp, $edbh['encsize']);		// Decrypt and truncate		$bin_data = AKEncryptionAES::AESDecryptCBC($bin_data, $this->password, 128);		$bin_data = substr($bin_data,0,$edbh['decsize']);		// Read length of EDB and of the Entity Path Data		$length_array = unpack('vpathsize', substr($bin_data,0,2) );		// Read the path data		$file = substr($bin_data,2,$length_array['pathsize']);		// Handle file renaming		$isRenamed = false;		if(is_array($this->renameFiles) && (count($this->renameFiles) > 0) )		{			if(array_key_exists($file, $this->renameFiles))			{				$file = $this->renameFiles[$file];				$isRenamed = true;			}		}				// Handle directory renaming		$isDirRenamed = false;		if(is_array($this->renameDirs) && (count($this->renameDirs) > 0)) {			if(array_key_exists(dirname($file), $this->renameDirs)) {				$file = rtrim($this->renameDirs[dirname($file)],'/').'/'.basename($file);				$isRenamed = true;				$isDirRenamed = true;			}		}		// Read and parse the known data portion		$bin_data = substr($bin_data, 2 + $length_array['pathsize']);		$header_data = unpack('Ctype/Ccompression/Vuncompsize/Vperms/Vfilectime', $bin_data);		$this->fileHeader->timestamp = $header_data['filectime'];		$compressionType = $header_data['compression'];		// Populate the return array		$this->fileHeader->file = $file;		$this->fileHeader->uncompressed = $header_data['uncompsize'];		switch($header_data['type'])		{			case 0:				$this->fileHeader->type = 'dir';				break;			case 1:				$this->fileHeader->type = 'file';				break;			case 2:				$this->fileHeader->type = 'link';				break;		}		switch( $compressionType )		{			case 0:				$this->fileHeader->compression = 'none';				break;			case 1:				$this->fileHeader->compression = 'gzip';				break;			case 2:				$this->fileHeader->compression = 'bzip2';				break;		}		$this->fileHeader->permissions = $header_data['perms'];		// Find hard-coded banned files		if( (basename($this->fileHeader->file) == ".") || (basename($this->fileHeader->file) == "..") )		{			$isBannedFile = true;		}		// Also try to find banned files passed in class configuration		if((count($this->skipFiles) > 0) && (!$isRenamed) )		{			if(in_array($this->fileHeader->file, $this->skipFiles))			{				$isBannedFile = true;			}		}		// If we have a banned file, let's skip it		if($isBannedFile)		{			$done = false;			while(!$done)			{				// Read the Data Chunk Block header				$binMiniHead = fread($this->fp, 8);				if( in_array( substr($binMiniHead,0,3), array('JPF','JPE') ) )				{					// Not a Data Chunk Block header, I am done skipping the file					@fseek($this->fp,-8,SEEK_CUR); // Roll back the file pointer					$done = true; // Mark as done					continue; // Exit loop				}				else				{					// Skip forward by the amount of compressed data					$miniHead = unpack('Vencsize/Vdecsize');					@fseek($this->fp, $miniHead['encsize'], SEEK_CUR);				}			}			$this->currentPartOffset = @ftell($this->fp);			$this->runState = AK_STATE_DONE;			return true;		}		// Last chance to prepend a path to the filename		if(!empty($this->addPath) && !$isDirRenamed)		{			$this->fileHeader->file = $this->addPath.$this->fileHeader->file;		}		// Get the translated path name		$restorePerms = AKFactory::get('kickstart.setup.restoreperms', false);		if($this->fileHeader->type == 'file')		{			// Regular file; ask the postproc engine to process its filename			if($restorePerms)			{				$this->fileHeader->realFile = $this->postProcEngine->processFilename( $this->fileHeader->file, $this->fileHeader->permissions );			}			else			{				$this->fileHeader->realFile = $this->postProcEngine->processFilename( $this->fileHeader->file );			}		}		elseif($this->fileHeader->type == 'dir')		{			$dir = $this->fileHeader->file;			$this->fileHeader->realFile = $dir;			// Directory; just create it			if($restorePerms)			{				$this->postProcEngine->createDirRecursive( $this->fileHeader->file, $this->fileHeader->permissions );			}			else			{				$this->postProcEngine->createDirRecursive( $this->fileHeader->file, 0755 );			}			$this->postProcEngine->processFilename(null);		}		else		{			// Symlink; do not post-process			$this->postProcEngine->processFilename(null);		}		$this->createDirectory();		// Header is read		$this->runState = AK_STATE_HEADER;		$this->dataReadLength = 0;		return true;	}	/**	 * Concrete classes must use this method to process file data. It must set $runState to AK_STATE_DATAREAD when	 * it's finished processing the file data.	 * @return bool True if processing the file data was successful, false if an error occured	 */	protected function processFileData()	{		switch( $this->fileHeader->type )		{			case 'dir':				return $this->processTypeDir();				break;			case 'link':				return $this->processTypeLink();				break;			case 'file':				switch($this->fileHeader->compression)				{					case 'none':						return $this->processTypeFileUncompressed();						break;					case 'gzip':					case 'bzip2':						return $this->processTypeFileCompressedSimple();						break;				}				break;		}	}	private function processTypeFileUncompressed()	{		// Uncompressed files are being processed in small chunks, to avoid timeouts		if( ($this->dataReadLength == 0) && !AKFactory::get('kickstart.setup.dryrun','0') )		{			// Before processing file data, ensure permissions are adequate			$this->setCorrectPermissions( $this->fileHeader->file );		}		// Open the output file		if( !AKFactory::get('kickstart.setup.dryrun','0') )		{			$ignore = AKFactory::get('kickstart.setup.ignoreerrors', false);			if ($this->dataReadLength == 0) {				$outfp = @fopen( $this->fileHeader->realFile, 'wb' );			} else {				$outfp = @fopen( $this->fileHeader->realFile, 'ab' );			}			// Can we write to the file?			if( ($outfp === false) && (!$ignore) ) {				// An error occured				$this->setError( AKText::sprintf('COULDNT_WRITE_FILE', $this->fileHeader->realFile) );				return false;			}		}		// Does the file have any data, at all?		if( $this->fileHeader->uncompressed == 0 )		{			// No file data!			if( !AKFactory::get('kickstart.setup.dryrun','0') && is_resource($outfp) ) @fclose($outfp);			$this->runState = AK_STATE_DATAREAD;			return true;		}		else		{			$this->setError('An uncompressed file was detected; this is not supported by this archive extraction utility');			return false;		}		return true;	}	private function processTypeFileCompressedSimple()	{		$timer = AKFactory::getTimer();		// Files are being processed in small chunks, to avoid timeouts		if( ($this->dataReadLength == 0) && !AKFactory::get('kickstart.setup.dryrun','0') )		{			// Before processing file data, ensure permissions are adequate			$this->setCorrectPermissions( $this->fileHeader->file );		}		// Open the output file		if( !AKFactory::get('kickstart.setup.dryrun','0') )		{			// Open the output file			$outfp = @fopen( $this->fileHeader->realFile, 'wb' );			// Can we write to the file?			$ignore = AKFactory::get('kickstart.setup.ignoreerrors', false);			if( ($outfp === false) && (!$ignore) ) {				// An error occured				$this->setError( AKText::sprintf('COULDNT_WRITE_FILE', $this->fileHeader->realFile) );				return false;			}		}		// Does the file have any data, at all?		if( $this->fileHeader->uncompressed == 0 )		{			// No file data!			if( !AKFactory::get('kickstart.setup.dryrun','0') )				if(is_resource($outfp)) @fclose($outfp);			$this->runState = AK_STATE_DATAREAD;			return true;		}		$leftBytes = $this->fileHeader->uncompressed - $this->dataReadLength;		// Loop while there's data to write and enough time to do it		while( ($leftBytes > 0) && ($timer->getTimeLeft() > 0) )		{			// Read the mini header			$binMiniHeader = fread($this->fp, 8);			$reallyReadBytes = akstringlen($binMiniHeader);			if($reallyReadBytes < 8)			{				// We read less than requested! Why? Did we hit local EOF?				if( $this->isEOF(true) && !$this->isEOF(false) )				{					// Yeap. Let's go to the next file					$this->nextFile();					// Retry reading the header					$binMiniHeader = fread($this->fp, 8);					$reallyReadBytes = akstringlen($binMiniHeader);					// Still not enough data? If so, the archive is corrupt or missing parts.					if($reallyReadBytes < 8) {						$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );						return false;					}				}				else				{					// Nope. The archive is corrupt					$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );					return false;				}			}			// Read the encrypted data			$miniHeader = unpack('Vencsize/Vdecsize', $binMiniHeader);			$toReadBytes = $miniHeader['encsize'];			$data = $this->fread( $this->fp, $toReadBytes );			$reallyReadBytes = akstringlen($data);			if($reallyReadBytes < $toReadBytes)			{				// We read less than requested! Why? Did we hit local EOF?				if( $this->isEOF(true) && !$this->isEOF(false) )				{					// Yeap. Let's go to the next file					$this->nextFile();					// Read the rest of the data					$toReadBytes -= $reallyReadBytes;					$restData = $this->fread( $this->fp, $toReadBytes );					$reallyReadBytes = akstringlen($restData);					if($reallyReadBytes < $toReadBytes) {						$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );						return false;					}					if(akstringlen($data) == 0) {						$data = $restData;					} else {						$data .= $restData;					}				}				else				{					// Nope. The archive is corrupt					$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );					return false;				}			}			// Decrypt the data			$data = AKEncryptionAES::AESDecryptCBC($data, $this->password, 128);			// Is the length of the decrypted data less than expected?			$data_length = akstringlen($data);			if($data_length < $miniHeader['decsize']) {				$this->setError(AKText::_('ERR_INVALID_JPS_PASSWORD'));				return false;			}			// Trim the data			$data = substr($data,0,$miniHeader['decsize']);			// Decompress			$data = gzinflate($data);			$unc_len = akstringlen($data);			// Write the decrypted data			if( !AKFactory::get('kickstart.setup.dryrun','0') )				if(is_resource($outfp)) @fwrite( $outfp, $data, akstringlen($data) );			// Update the read length			$this->dataReadLength += $unc_len;			$leftBytes = $this->fileHeader->uncompressed - $this->dataReadLength;		}		// Close the file pointer		if( !AKFactory::get('kickstart.setup.dryrun','0') )			if(is_resource($outfp)) @fclose($outfp);		// Was this a pre-timeout bail out?		if( $leftBytes > 0 )		{			$this->runState = AK_STATE_DATA;		}		else		{			// Oh! We just finished!			$this->runState = AK_STATE_DATAREAD;			$this->dataReadLength = 0;		}	}	/**	 * Process the file data of a link entry	 * @return bool	 */	private function processTypeLink()	{		// Does the file have any data, at all?		if( $this->fileHeader->uncompressed == 0 )		{			// No file data!			$this->runState = AK_STATE_DATAREAD;			return true;		}		// Read the mini header		$binMiniHeader = fread($this->fp, 8);		$reallyReadBytes = akstringlen($binMiniHeader);		if($reallyReadBytes < 8)		{			// We read less than requested! Why? Did we hit local EOF?			if( $this->isEOF(true) && !$this->isEOF(false) )			{				// Yeap. Let's go to the next file				$this->nextFile();				// Retry reading the header				$binMiniHeader = fread($this->fp, 8);				$reallyReadBytes = akstringlen($binMiniHeader);				// Still not enough data? If so, the archive is corrupt or missing parts.				if($reallyReadBytes < 8) {					$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );					return false;				}			}			else			{				// Nope. The archive is corrupt				$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );				return false;			}		}		// Read the encrypted data		$miniHeader = unpack('Vencsize/Vdecsize', $binMiniHeader);		$toReadBytes = $miniHeader['encsize'];		$data = $this->fread( $this->fp, $toReadBytes );		$reallyReadBytes = akstringlen($data);		if($reallyReadBytes < $toReadBytes)		{			// We read less than requested! Why? Did we hit local EOF?			if( $this->isEOF(true) && !$this->isEOF(false) )			{				// Yeap. Let's go to the next file				$this->nextFile();				// Read the rest of the data				$toReadBytes -= $reallyReadBytes;				$restData = $this->fread( $this->fp, $toReadBytes );				$reallyReadBytes = akstringlen($data);				if($reallyReadBytes < $toReadBytes) {					$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );					return false;				}				$data .= $restData;			}			else			{				// Nope. The archive is corrupt				$this->setError( AKText::_('ERR_CORRUPT_ARCHIVE') );				return false;			}		}		// Decrypt the data		$data = AKEncryptionAES::AESDecryptCBC($data, $this->password, 128);		// Is the length of the decrypted data less than expected?		$data_length = akstringlen($data);		if($data_length < $miniHeader['decsize']) {			$this->setError(AKText::_('ERR_INVALID_JPS_PASSWORD'));			return false;		}		// Trim the data		$data = substr($data,0,$miniHeader['decsize']);		// Try to remove an existing file or directory by the same name		if(file_exists($this->fileHeader->realFile)) { @unlink($this->fileHeader->realFile); @rmdir($this->fileHeader->realFile); }		// Remove any trailing slash		if(substr($this->fileHeader->realFile, -1) == '/') $this->fileHeader->realFile = substr($this->fileHeader->realFile, 0, -1);		// Create the symlink - only possible within PHP context. There's no support built in the FTP protocol, so no postproc use is possible here :(		if( !AKFactory::get('kickstart.setup.dryrun','0') )			@symlink($data, $this->fileHeader->realFile);		$this->runState = AK_STATE_DATAREAD;		return true; // No matter if the link was created!	}	/**	 * Process the file data of a directory entry	 * @return bool	 */	private function processTypeDir()	{		// Directory entries in the JPA do not have file data, therefore we're done processing the entry		$this->runState = AK_STATE_DATAREAD;		return true;	}	/**	 * Creates the directory this file points to	 */	protected function createDirectory()	{		if( AKFactory::get('kickstart.setup.dryrun','0') ) return true;		// Do we need to create a directory?		$lastSlash = strrpos($this->fileHeader->realFile, '/');		$dirName = substr( $this->fileHeader->realFile, 0, $lastSlash);		$perms = $this->flagRestorePermissions ? $retArray['permissions'] : 0755;		$ignore = AKFactory::get('kickstart.setup.ignoreerrors', false);		if( ($this->postProcEngine->createDirRecursive($dirName, $perms) == false) && (!$ignore) ) {			$this->setError( AKText::sprintf('COULDNT_CREATE_DIR', $dirName) );			return false;		}		else		{			return true;		}	}}/** * A filesystem scanner which uses opendir() */class AKUtilsLister extends AKAbstractObject{	public function &getFiles($folder, $pattern = '*')	{		// Initialize variables		$arr = array();		$false = false;		if(!is_dir($folder)) return $false;		$handle = @opendir($folder);		// If directory is not accessible, just return FALSE		if ($handle === FALSE) {			$this->setWarning( 'Unreadable directory '.$folder);			return $false;		}		while (($file = @readdir($handle)) !== false)		{			if( !fnmatch($pattern, $file) ) continue;			if (($file != '.') && ($file != '..'))			{				$ds = ($folder == '') || ($folder == '/') || (@substr($folder, -1) == '/') || (@substr($folder, -1) == DIRECTORY_SEPARATOR) ? '' : DIRECTORY_SEPARATOR;				$dir = $folder . $ds . $file;				$isDir = is_dir($dir);				if (!$isDir) {					$arr[] = $dir;				}			}		}		@closedir($handle);		return $arr;	}	public function &getFolders($folder, $pattern = '*')	{		// Initialize variables		$arr = array();		$false = false;		if(!is_dir($folder)) return $false;		$handle = @opendir($folder);		// If directory is not accessible, just return FALSE		if ($handle === FALSE) {			$this->setWarning( 'Unreadable directory '.$folder);			return $false;		}		while (($file = @readdir($handle)) !== false)		{			if( !fnmatch($pattern, $file) ) continue;			if (($file != '.') && ($file != '..'))			{				$ds = ($folder == '') || ($folder == '/') || (@substr($folder, -1) == '/') || (@substr($folder, -1) == DIRECTORY_SEPARATOR) ? '' : DIRECTORY_SEPARATOR;				$dir = $folder . $ds . $file;				$isDir = is_dir($dir);				if ($isDir) {					$arr[] = $dir;				}			}		}		@closedir($handle);		return $arr;	}}/** * A simple INI-based i18n engine */class AKText extends AKAbstractObject{	/**	 * The default (en_GB) translation used when no other translation is available	 * @var array	 */	private $default_translation = array(		'AUTOMODEON' => 'Auto-mode enabled',		'ERR_NOT_A_JPA_FILE' => 'The file is not a JPA archive',		'ERR_CORRUPT_ARCHIVE' => 'The archive file is corrupt, truncated or archive parts are missing',		'ERR_INVALID_LOGIN' => 'Invalid login',		'COULDNT_CREATE_DIR' => 'Could not create %s folder',		'COULDNT_WRITE_FILE' => 'Could not open %s for writing.',		'WRONG_FTP_HOST' => 'Wrong FTP host or port',		'WRONG_FTP_USER' => 'Wrong FTP username or password',		'WRONG_FTP_PATH1' => 'Wrong FTP initial directory - the directory doesn\'t exist',		'FTP_CANT_CREATE_DIR' => 'Could not create directory %s',		'FTP_TEMPDIR_NOT_WRITABLE' => 'Could not find or create a writable temporary directory',		'FTP_COULDNT_UPLOAD' => 'Could not upload %s',		'THINGS_HEADER' => 'Things you should know about Akeeba Kickstart',		'THINGS_01' => 'Kickstart is not an installer. It is an archive extraction tool. The actual installer was put inside the archive file at backup time.',		'THINGS_02' => 'Kickstart is not the only way to extract the backup archive. You can use Akeeba eXtract Wizard and upload the extracted files using FTP instead.',		'THINGS_03' => 'Kickstart is bound by your server\'s configuration. As such, it may not work at all.',		'THINGS_04' => 'You should download and upload your archive files using FTP in Binary transfer mode. Any other method could lead to a corrupt backup archive and restoration failure.',		'THINGS_05' => 'Post-restoration site load errors are usually caused by .htaccess or php.ini directives. You should understand that blank pages, 404 and 500 errors can usually be worked around by editing the aforementioned files. It is not our job to mess with your configuration files, because this could be dangerous for your site.',		'THINGS_06' => 'Kickstart overwrites files without a warning. If you are not sure that you are OK with that do not continue.',		'THINGS_07' => 'Trying to restore to the temporary URL of a cPanel host (e.g. http://1.2.3.4/~username) will lead to restoration failure and your site will appear to be not working. This is normal and it\'s just how your server and CMS software work.',		'THINGS_08' => 'You are supposed to read the documentation before using this software. Most issues can be avoided, or easily worked around, by understanding how this software works.',		'THINGS_09' => 'This text does not imply that there is a problem detected. It is standard text displayed every time you launch Kickstart.',		'CLOSE_LIGHTBOX' => 'Click here or press ESC to close this message',		'SELECT_ARCHIVE' => 'Select a backup archive',		'ARCHIVE_FILE' => 'Archive file:',		'SELECT_EXTRACTION' => 'Select an extraction method',		'WRITE_TO_FILES' => 'Write to files:',		'WRITE_DIRECTLY' => 'Directly',		'WRITE_FTP' => 'Use FTP',		'FTP_HOST' => 'FTP host name:',		'FTP_PORT' => 'FTP port:',		'FTP_FTPS' => 'Use FTP over SSL (FTPS)',		'FTP_PASSIVE' => 'Use FTP Passive Mode',		'FTP_USER' => 'FTP user name:',		'FTP_PASS' => 'FTP password:',		'FTP_DIR' => 'FTP directory:',		'FTP_TEMPDIR' => 'Temporary directory:',		'FTP_CONNECTION_OK' => 'FTP Connection Established',		'FTP_CONNECTION_FAILURE' => 'The FTP Connection Failed',		'FTP_TEMPDIR_WRITABLE' => 'The temporary directory is writable.',		'FTP_TEMPDIR_UNWRITABLE' => 'The temporary directory is not writable. Please check the permissions.',		'BTN_CHECK' => 'Check',		'BTN_RESET' => 'Reset',		'BTN_TESTFTPCON' => 'Test FTP connection',		'BTN_GOTOSTART' => 'Start over',		'FINE_TUNE' => 'Fine tune',		'MIN_EXEC_TIME' => 'Minimum execution time:',		'MAX_EXEC_TIME' => 'Maximum execution time:',		'SECONDS_PER_STEP' => 'seconds per step',		'EXTRACT_FILES' => 'Extract files',		'BTN_START' => 'Start',		'EXTRACTING' => 'Extracting',		'DO_NOT_CLOSE_EXTRACT' => 'Do not close this window while the extraction is in progress',		'RESTACLEANUP' => 'Restoration and Clean Up',		'BTN_RUNINSTALLER' => 'Run the Installer',		'BTN_CLEANUP' => 'Clean Up',		'BTN_SITEFE' => 'Visit your site\'s front-end',		'BTN_SITEBE' => 'Visit your site\'s back-end',		'WARNINGS' => 'Extraction Warnings',		'ERROR_OCCURED' => 'An error occured',		'STEALTH_MODE' => 'Stealth mode',		'STEALTH_URL' => 'HTML file to show to web visitors',		'ERR_NOT_A_JPS_FILE' => 'The file is not a JPA archive',		'ERR_INVALID_JPS_PASSWORD' => 'The password you gave is wrong or the archive is corrupt',		'JPS_PASSWORD' => 'Archive Password (for JPS files)',		'INVALID_FILE_HEADER' => 'Invalid header in archive file, part %s, offset %s',		'NEEDSOMEHELPKS' => 'Want some help to use this tool? Read this first:',		'QUICKSTART' => 'Quick Start Guide',		'CANTGETITTOWORK' => 'Can\'t get it to work? Click me!',		'NOARCHIVESCLICKHERE' => 'No archives detected. Click here for troubleshooting instructions.',		'POSTRESTORATIONTROUBLESHOOTING' => 'Something not working after the restoration? Click here for troubleshooting instructions.',		'UPDATE_HEADER' => 'An updated version of Akeeba Kickstart (<span id="update-version">unknown</span>) is available!',		'UPDATE_NOTICE' => 'You are advised to always use the latest version of Akeeba Kickstart available. Older versions may be subject to bugs and will not be supported.',		'UPDATE_DLNOW' => 'Download now',		'UPDATE_MOREINFO' => 'More information'	);	/**	 * The array holding the translation keys	 * @var array	 */	private $strings;	/**	 * The currently detected language (ISO code)	 * @var string	 */	private $language;	/*	 * Initializes the translation engine	 * @return AKText	 */	public function __construct()	{		// Start with the default translation		$this->strings = $this->default_translation;		// Try loading the translation file in English, if it exists		$this->loadTranslation('en-GB');		// Try loading the translation file in the browser's preferred language, if it exists		$this->getBrowserLanguage();		if(!is_null($this->language))		{			$this->loadTranslation();		}	}	/**	 * Singleton pattern for Language	 * @return Language The global Language instance	 */	public static function &getInstance()	{		static $instance;		if(!is_object($instance))		{			$instance = new AKText();		}		return $instance;	}	public static function _($string)	{		$text = self::getInstance();		$key = strtoupper($string);		$key = substr($key, 0, 1) == '_' ? substr($key, 1) : $key;		if (isset ($text->strings[$key]))		{			$string = $text->strings[$key];		}		else		{			if (defined($string))			{				$string = constant($string);			}		}		return $string;	}	public static function sprintf($key)	{		$text = self::getInstance();		$args = func_get_args();		if (count($args) > 0) {			$args[0] = $text->_($args[0]);			return @call_user_func_array('sprintf', $args);		}		return '';	}	public function dumpLanguage()	{		$out = '';		foreach($this->strings as $key => $value)		{			$out .= "$key=$value\n";		}		return $out;	}	public function asJavascript()	{		$out = '';		foreach($this->strings as $key => $value)		{			$key = addcslashes($key, '\\\'"');			$value = addcslashes($value, '\\\'"');			if(!empty($out)) $out .= ",\n";			$out .= "'$key':\t'$value'";		}		return $out;	}	public function resetTranslation()	{		$this->strings = $this->default_translation;	}	public function getBrowserLanguage()	{		// Detection code from Full Operating system language detection, by Harald Hope		// Retrieved from http://techpatterns.com/downloads/php_language_detection.php		$user_languages = array();		//check to see if language is set		if ( isset( $_SERVER["HTTP_ACCEPT_LANGUAGE"] ) )		{			$languages = strtolower( $_SERVER["HTTP_ACCEPT_LANGUAGE"] );			// $languages = ' fr-ch;q=0.3, da, en-us;q=0.8, en;q=0.5, fr;q=0.3';			// need to remove spaces from strings to avoid error			$languages = str_replace( ' ', '', $languages );			$languages = explode( ",", $languages );			foreach ( $languages as $language_list )			{				// pull out the language, place languages into array of full and primary				// string structure:				$temp_array = array();				// slice out the part before ; on first step, the part before - on second, place into array				$temp_array[0] = substr( $language_list, 0, strcspn( $language_list, ';' ) );//full language				$temp_array[1] = substr( $language_list, 0, 2 );// cut out primary language				if( (strlen($temp_array[0]) == 5) && ( (substr($temp_array[0],2,1) == '-') || (substr($temp_array[0],2,1) == '_') ) )				{					$langLocation = strtoupper(substr($temp_array[0],3,2));					$temp_array[0] = $temp_array[1].'-'.$langLocation;				}				//place this array into main $user_languages language array				$user_languages[] = $temp_array;			}		}		else// if no languages found		{			$user_languages[0] = array( '','' ); //return blank array.		}		$this->language = null;		$basename=basename(__FILE__, '.php') . '.ini';				// Try to match main language part of the filename, irrespective of the location, e.g. de_DE will do if de_CH doesn't exist.		$fs = new AKUtilsLister();		$iniFiles = $fs->getFiles( dirname(__FILE__), '*.'.$basename );		if(empty($iniFiles) && ($basename != 'kickstart.ini')) {			$basename = 'kickstart.ini';			$iniFiles = $fs->getFiles( dirname(__FILE__), '*.'.$basename );		}		if (is_array($iniFiles)) {			foreach($user_languages as $languageStruct)			{				if(is_null($this->language))				{					// Get files matching the main lang part					$iniFiles = $fs->getFiles( dirname(__FILE__), $languageStruct[1].'-??.'.$basename );					if (count($iniFiles) > 0) {						$filename = $iniFiles[0];						$filename = substr($filename, strlen(dirname(__FILE__))+1);						$this->language = substr($filename, 0, 5);					} else {						$this->language = null;					}				}			}		}				if(is_null($this->language)) {			// Try to find a full language match			foreach($user_languages as $languageStruct)			{				if (@file_exists($languageStruct[0].'.'.$basename) && is_null($this->language)) {					$this->language = $languageStruct[0];				} else {				}			}		} else {			// Do we have an exact match?			foreach($user_languages as $languageStruct)			{				if(substr($this->language,0,strlen($languageStruct[1])) == $languageStruct[1]) {					if(file_exists($languageStruct[0].'.'.$basename)) {						$this->language = $languageStruct[0];					}				}			}		}				// Now, scan for full language based on the partial match			}	private function loadTranslation( $lang = null )	{		$dirname = function_exists('getcwd') ? getcwd() : dirname(__FILE__);		$basename=basename(__FILE__, '.php') . '.ini';		if( empty($lang) ) $lang = $this->language;		$translationFilename = $dirname.DIRECTORY_SEPARATOR.$lang.'.'.$basename;		if(!@file_exists($translationFilename) && ($basename != 'kickstart.ini')) {			$basename = 'kickstart.ini';			$translationFilename = $dirname.DIRECTORY_SEPARATOR.$lang.'.'.$basename;		}		if(!@file_exists($translationFilename)) return;		$temp = self::parse_ini_file($translationFilename, false);		if(!is_array($this->strings)) $this->strings = array();		if(empty($temp)) {			$this->strings = array_merge($this->default_translation, $this->strings);		} else {			$this->strings = array_merge($this->strings, $temp);		}	}	/**	 * A PHP based INI file parser.	 *	 * Thanks to asohn ~at~ aircanopy ~dot~ net for posting this handy function on	 * the parse_ini_file page on http://gr.php.net/parse_ini_file	 *	 * @param string $file Filename to process	 * @param bool $process_sections True to also process INI sections	 * @return array An associative array of sections, keys and values	 * @access private	 */	public static function parse_ini_file($file, $process_sections = false, $raw_data = false)	{		$process_sections = ($process_sections !== true) ? false : true;		if(!$raw_data)		{			$ini = @file($file);		}		else		{			$ini = $file;		}		if (count($ini) == 0) {return array();}		$sections = array();		$values = array();		$result = array();		$globals = array();		$i = 0;		if(!empty($ini)) foreach ($ini as $line) {			$line = trim($line);			$line = str_replace("\t", " ", $line);			// Comments			if (!preg_match('/^[a-zA-Z0-9[]/', $line)) {continue;}			// Sections			if ($line{0} == '[') {				$tmp = explode(']', $line);				$sections[] = trim(substr($tmp[0], 1));				$i++;				continue;			}			// Key-value pair			list($key, $value) = explode('=', $line, 2);			$key = trim($key);			$value = trim($value);			if (strstr($value, ";")) {				$tmp = explode(';', $value);				if (count($tmp) == 2) {					if ((($value{0} != '"') && ($value{0} != "'")) ||					preg_match('/^".*"\s*;/', $value) || preg_match('/^".*;[^"]*$/', $value) ||					preg_match("/^'.*'\s*;/", $value) || preg_match("/^'.*;[^']*$/", $value) ){						$value = $tmp[0];					}				} else {					if ($value{0} == '"') {						$value = preg_replace('/^"(.*)".*/', '$1', $value);					} elseif ($value{0} == "'") {						$value = preg_replace("/^'(.*)'.*/", '$1', $value);					} else {						$value = $tmp[0];					}				}			}			$value = trim($value);			$value = trim($value, "'\"");			if ($i == 0) {				if (substr($line, -1, 2) == '[]') {					$globals[$key][] = $value;				} else {					$globals[$key] = $value;				}			} else {				if (substr($line, -1, 2) == '[]') {					$values[$i-1][$key][] = $value;				} else {					$values[$i-1][$key] = $value;				}			}		}		for($j = 0; $j < $i; $j++) {			if ($process_sections === true) {				$result[$sections[$j]] = $values[$j];			} else {				$result[] = $values[$j];			}		}		return $result + $globals;	}}/** * The Akeeba Kickstart Factory class * This class is reponssible for instanciating all Akeeba Kicsktart classes */class AKFactory {	/** @var array A list of instanciated objects */	private $objectlist = array();	/** @var array Simple hash data storage */	private $varlist = array();	/** Private constructor makes sure we can't directly instanciate the class */	private function __construct() {}	/**	 * Gets a single, internally used instance of the Factory	 * @param string $serialized_data [optional] Serialized data to spawn the instance from	 * @return AKFactory A reference to the unique Factory object instance	 */	protected static function &getInstance( $serialized_data = null ) {		static $myInstance;		if(!is_object($myInstance) || !is_null($serialized_data))			if(!is_null($serialized_data))			{				$myInstance = unserialize($serialized_data);			}			else			{				$myInstance = new self();			}		return $myInstance;	}	/**	 * Internal function which instanciates a class named $class_name.	 * The autoloader	 * @param object $class_name	 * @return	 */	protected static function &getClassInstance($class_name) {		$self = self::getInstance();		if(!isset($self->objectlist[$class_name]))		{			$self->objectlist[$class_name] = new $class_name;		}		return $self->objectlist[$class_name];	}	// ========================================================================	// Public factory interface	// ========================================================================	/**	 * Gets a serialized snapshot of the Factory for safekeeping (hibernate)	 * @return string The serialized snapshot of the Factory	 */	public static function serialize() {		$engine = self::getUnarchiver();		$engine->shutdown();		$serialized = serialize(self::getInstance());		if(function_exists('base64_encode') && function_exists('base64_decode'))		{			$serialized = base64_encode($serialized);		}		return $serialized;	}	/**	 * Regenerates the full Factory state from a serialized snapshot (resume)	 * @param string $serialized_data The serialized snapshot to resume from	 */	public static function unserialize($serialized_data) {		if(function_exists('base64_encode') && function_exists('base64_decode'))		{			$serialized_data = base64_decode($serialized_data);		}		self::getInstance($serialized_data);	}	/**	 * Reset the internal factory state, freeing all previously created objects	 */	public static function nuke()	{		$self = self::getInstance();		foreach($self->objectlist as $key => $object)		{			$self->objectlist[$key] = null;		}		$self->objectlist = array();	}	// ========================================================================	// Public hash data storage interface	// ========================================================================	public static function set($key, $value)	{		$self = self::getInstance();		$self->varlist[$key] = $value;	}	public static function get($key, $default = null)	{		$self = self::getInstance();		if( array_key_exists($key, $self->varlist) )		{			return $self->varlist[$key];		}		else		{			return $default;		}	}	// ========================================================================	// Akeeba Kickstart classes	// ========================================================================	/**	 * Gets the post processing engine	 * @param string $proc_engine	 */	public static function &getPostProc($proc_engine = null)	{		static $class_name;		if( empty($class_name) )		{			if(empty($proc_engine))			{				$proc_engine = self::get('kickstart.procengine','direct');			}			$class_name = 'AKPostproc'.ucfirst($proc_engine);		}		return self::getClassInstance($class_name);	}	/**	 * Gets the unarchiver engine	 */	public static function &getUnarchiver( $configOverride = null )	{		static $class_name;		if(!empty($configOverride))		{			if($configOverride['reset']) {				$class_name = null;			}		}		if( empty($class_name) )		{			$filetype = self::get('kickstart.setup.filetype', null);			if(empty($filetype))			{				$filename = self::get('kickstart.setup.sourcefile', null);				$basename = basename($filename);				$baseextension = strtoupper(substr($basename,-3));				switch($baseextension)				{					case 'JPA':						$filetype = 'JPA';						break;					case 'JPS':						$filetype = 'JPS';						break;					case 'ZIP':						$filetype = 'ZIP';						break;					default:						die('Invalid archive type or extension in file '.$filename);						break;				}			}			$class_name = 'AKUnarchiver'.ucfirst($filetype);		}		$destdir = self::get('kickstart.setup.destdir', null);		if(empty($destdir))		{			$destdir = function_exists('getcwd') ? getcwd() : dirname(__FILE__);		}		$object = self::getClassInstance($class_name);		if( $object->getState() == 'init')		{			// Initialize the object			$config = array(				'filename'				=> self::get('kickstart.setup.sourcefile', ''),				'restore_permissions'	=> self::get('kickstart.setup.restoreperms', 0),				'post_proc'				=> self::get('kickstart.procengine', 'direct'),				'add_path'				=> $destdir,				'rename_files'			=> array( '.htaccess' => 'htaccess.bak', 'php.ini' => 'php.ini.bak' ),				'skip_files'			=> array( basename(__FILE__), 'kickstart.php', 'abiautomation.ini', 'htaccess.bak', 'php.ini.bak' )			);			if(!defined('KICKSTART'))			{				// In restore.php mode we have to exclude some more files				$config['skip_files'][] = 'administrator/components/com_akeeba/restore.php';				$config['skip_files'][] = 'administrator/components/com_akeeba/restoration.php';			}			if(!empty($configOverride))			{				foreach($configOverride as $key => $value)				{					$config[$key] = $value;				}			}			$object->setup($config);		}		return $object;	}	/**	 * Get the a reference to the Akeeba Engine's timer	 * @return AKCoreTimer	 */	public static function &getTimer()	{		return self::getClassInstance('AKCoreTimer');	}}/** * AES implementation in PHP (c) Chris Veness 2005-2011 * (http://www.movable-type.co.uk/scripts/aes-php.html) * I offer these formul & scripts for free use and adaptation as my contribution to the  * open-source info-sphere from which I have received so much. You are welcome to re-use these  * scripts [under a simple attribution license or a GPL licence, without any warranty express or implied]  * provided solely that you retain my copyright notice and a link to this page. * licence. No warranty of any form is offered. * * Modified for Akeeba Backup by Nicholas K. Dionysopoulos */class AKEncryptionAES{	// Sbox is pre-computed multiplicative inverse in GF(2^8) used in SubBytes and KeyExpansion [5.1.1]	protected static $Sbox =			 array(0x63,0x7c,0x77,0x7b,0xf2,0x6b,0x6f,0xc5,0x30,0x01,0x67,0x2b,0xfe,0xd7,0xab,0x76,	               0xca,0x82,0xc9,0x7d,0xfa,0x59,0x47,0xf0,0xad,0xd4,0xa2,0xaf,0x9c,0xa4,0x72,0xc0,	               0xb7,0xfd,0x93,0x26,0x36,0x3f,0xf7,0xcc,0x34,0xa5,0xe5,0xf1,0x71,0xd8,0x31,0x15,	               0x04,0xc7,0x23,0xc3,0x18,0x96,0x05,0x9a,0x07,0x12,0x80,0xe2,0xeb,0x27,0xb2,0x75,	               0x09,0x83,0x2c,0x1a,0x1b,0x6e,0x5a,0xa0,0x52,0x3b,0xd6,0xb3,0x29,0xe3,0x2f,0x84,	               0x53,0xd1,0x00,0xed,0x20,0xfc,0xb1,0x5b,0x6a,0xcb,0xbe,0x39,0x4a,0x4c,0x58,0xcf,	               0xd0,0xef,0xaa,0xfb,0x43,0x4d,0x33,0x85,0x45,0xf9,0x02,0x7f,0x50,0x3c,0x9f,0xa8,	               0x51,0xa3,0x40,0x8f,0x92,0x9d,0x38,0xf5,0xbc,0xb6,0xda,0x21,0x10,0xff,0xf3,0xd2,	               0xcd,0x0c,0x13,0xec,0x5f,0x97,0x44,0x17,0xc4,0xa7,0x7e,0x3d,0x64,0x5d,0x19,0x73,	               0x60,0x81,0x4f,0xdc,0x22,0x2a,0x90,0x88,0x46,0xee,0xb8,0x14,0xde,0x5e,0x0b,0xdb,	               0xe0,0x32,0x3a,0x0a,0x49,0x06,0x24,0x5c,0xc2,0xd3,0xac,0x62,0x91,0x95,0xe4,0x79,	               0xe7,0xc8,0x37,0x6d,0x8d,0xd5,0x4e,0xa9,0x6c,0x56,0xf4,0xea,0x65,0x7a,0xae,0x08,	               0xba,0x78,0x25,0x2e,0x1c,0xa6,0xb4,0xc6,0xe8,0xdd,0x74,0x1f,0x4b,0xbd,0x8b,0x8a,	               0x70,0x3e,0xb5,0x66,0x48,0x03,0xf6,0x0e,0x61,0x35,0x57,0xb9,0x86,0xc1,0x1d,0x9e,	               0xe1,0xf8,0x98,0x11,0x69,0xd9,0x8e,0x94,0x9b,0x1e,0x87,0xe9,0xce,0x55,0x28,0xdf,	               0x8c,0xa1,0x89,0x0d,0xbf,0xe6,0x42,0x68,0x41,0x99,0x2d,0x0f,0xb0,0x54,0xbb,0x16);	// Rcon is Round Constant used for the Key Expansion [1st col is 2^(r-1) in GF(2^8)] [5.2]	protected static $Rcon = array(				   array(0x00, 0x00, 0x00, 0x00),	               array(0x01, 0x00, 0x00, 0x00),	               array(0x02, 0x00, 0x00, 0x00),	               array(0x04, 0x00, 0x00, 0x00),	               array(0x08, 0x00, 0x00, 0x00),	               array(0x10, 0x00, 0x00, 0x00),	               array(0x20, 0x00, 0x00, 0x00),	               array(0x40, 0x00, 0x00, 0x00),	               array(0x80, 0x00, 0x00, 0x00),	               array(0x1b, 0x00, 0x00, 0x00),	               array(0x36, 0x00, 0x00, 0x00) );	protected static $passwords = array();	/**	 * AES Cipher function: encrypt 'input' with Rijndael algorithm	 *	 * @param input message as byte-array (16 bytes)	 * @param w     key schedule as 2D byte-array (Nr+1 x Nb bytes) -	 *              generated from the cipher key by KeyExpansion()	 * @return      ciphertext as byte-array (16 bytes)	 */	protected static function Cipher($input, $w) {    // main Cipher function [5.1]	  $Nb = 4;                 // block size (in words): no of columns in state (fixed at 4 for AES)	  $Nr = count($w)/$Nb - 1; // no of rounds: 10/12/14 for 128/192/256-bit keys	  $state = array();  // initialise 4xNb byte-array 'state' with input [3.4]	  for ($i=0; $i<4*$Nb; $i++) $state[$i%4][floor($i/4)] = $input[$i];	  $state = self::AddRoundKey($state, $w, 0, $Nb);	  for ($round=1; $round<$Nr; $round++) {  // apply Nr rounds	    $state = self::SubBytes($state, $Nb);	    $state = self::ShiftRows($state, $Nb);	    $state = self::MixColumns($state, $Nb);	    $state = self::AddRoundKey($state, $w, $round, $Nb);	  }	  $state = self::SubBytes($state, $Nb);	  $state = self::ShiftRows($state, $Nb);	  $state = self::AddRoundKey($state, $w, $Nr, $Nb);	  $output = array(4*$Nb);  // convert state to 1-d array before returning [3.4]	  for ($i=0; $i<4*$Nb; $i++) $output[$i] = $state[$i%4][floor($i/4)];	  return $output;	}	protected static function AddRoundKey($state, $w, $rnd, $Nb) {  // xor Round Key into state S [5.1.4]	  for ($r=0; $r<4; $r++) {	    for ($c=0; $c<$Nb; $c++) $state[$r][$c] ^= $w[$rnd*4+$c][$r];	  }	  return $state;	}	protected static function SubBytes($s, $Nb) {    // apply SBox to state S [5.1.1]	  for ($r=0; $r<4; $r++) {	    for ($c=0; $c<$Nb; $c++) $s[$r][$c] = self::$Sbox[$s[$r][$c]];	  }	  return $s;	}	protected static function ShiftRows($s, $Nb) {    // shift row r of state S left by r bytes [5.1.2]	  $t = array(4);	  for ($r=1; $r<4; $r++) {	    for ($c=0; $c<4; $c++) $t[$c] = $s[$r][($c+$r)%$Nb];  // shift into temp copy	    for ($c=0; $c<4; $c++) $s[$r][$c] = $t[$c];         // and copy back	  }          // note that this will work for Nb=4,5,6, but not 7,8 (always 4 for AES):	  return $s;  // see fp.gladman.plus.com/cryptography_technology/rijndael/aes.spec.311.pdf	}	protected static function MixColumns($s, $Nb) {   // combine bytes of each col of state S [5.1.3]	  for ($c=0; $c<4; $c++) {	    $a = array(4);  // 'a' is a copy of the current column from 's'	    $b = array(4);  // 'b' is a{02} in GF(2^8)	    for ($i=0; $i<4; $i++) {	      $a[$i] = $s[$i][$c];	      $b[$i] = $s[$i][$c]&0x80 ? $s[$i][$c]<<1 ^ 0x011b : $s[$i][$c]<<1;	    }	    // a[n] ^ b[n] is a{03} in GF(2^8)	    $s[0][$c] = $b[0] ^ $a[1] ^ $b[1] ^ $a[2] ^ $a[3]; // 2*a0 + 3*a1 + a2 + a3	    $s[1][$c] = $a[0] ^ $b[1] ^ $a[2] ^ $b[2] ^ $a[3]; // a0 * 2*a1 + 3*a2 + a3	    $s[2][$c] = $a[0] ^ $a[1] ^ $b[2] ^ $a[3] ^ $b[3]; // a0 + a1 + 2*a2 + 3*a3	    $s[3][$c] = $a[0] ^ $b[0] ^ $a[1] ^ $a[2] ^ $b[3]; // 3*a0 + a1 + a2 + 2*a3	  }	  return $s;	}	/**	 * Key expansion for Rijndael Cipher(): performs key expansion on cipher key	 * to generate a key schedule	 *	 * @param key cipher key byte-array (16 bytes)	 * @return    key schedule as 2D byte-array (Nr+1 x Nb bytes)	 */	protected static function KeyExpansion($key) {  // generate Key Schedule from Cipher Key [5.2]	  $Nb = 4;              // block size (in words): no of columns in state (fixed at 4 for AES)	  $Nk = count($key)/4;  // key length (in words): 4/6/8 for 128/192/256-bit keys	  $Nr = $Nk + 6;        // no of rounds: 10/12/14 for 128/192/256-bit keys	  $w = array();	  $temp = array();	  for ($i=0; $i<$Nk; $i++) {	    $r = array($key[4*$i], $key[4*$i+1], $key[4*$i+2], $key[4*$i+3]);	    $w[$i] = $r;	  }	  for ($i=$Nk; $i<($Nb*($Nr+1)); $i++) {	    $w[$i] = array();	    for ($t=0; $t<4; $t++) $temp[$t] = $w[$i-1][$t];	    if ($i % $Nk == 0) {	      $temp = self::SubWord(self::RotWord($temp));	      for ($t=0; $t<4; $t++) $temp[$t] ^= self::$Rcon[$i/$Nk][$t];	    } else if ($Nk > 6 && $i%$Nk == 4) {	      $temp = self::SubWord($temp);	    }	    for ($t=0; $t<4; $t++) $w[$i][$t] = $w[$i-$Nk][$t] ^ $temp[$t];	  }	  return $w;	}	protected static function SubWord($w) {    // apply SBox to 4-byte word w	  for ($i=0; $i<4; $i++) $w[$i] = self::$Sbox[$w[$i]];	  return $w;	}	protected static function RotWord($w) {    // rotate 4-byte word w left by one byte	  $tmp = $w[0];	  for ($i=0; $i<3; $i++) $w[$i] = $w[$i+1];	  $w[3] = $tmp;	  return $w;	}	/*	 * Unsigned right shift function, since PHP has neither >>> operator nor unsigned ints	 *	 * @param a  number to be shifted (32-bit integer)	 * @param b  number of bits to shift a to the right (0..31)	 * @return   a right-shifted and zero-filled by b bits	 */	protected static function urs($a, $b) {	  $a &= 0xffffffff; $b &= 0x1f;  // (bounds check)	  if ($a&0x80000000 && $b>0) {   // if left-most bit set	    $a = ($a>>1) & 0x7fffffff;   //   right-shift one bit & clear left-most bit	    $a = $a >> ($b-1);           //   remaining right-shifts	  } else {                       // otherwise	    $a = ($a>>$b);               //   use normal right-shift	  }	  return $a;	}	/**	 * Encrypt a text using AES encryption in Counter mode of operation	 *  - see http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf	 *	 * Unicode multi-byte character safe	 *	 * @param plaintext source text to be encrypted	 * @param password  the password to use to generate a key	 * @param nBits     number of bits to be used in the key (128, 192, or 256)	 * @return          encrypted text	 */	public static function AESEncryptCtr($plaintext, $password, $nBits) {	  $blockSize = 16;  // block size fixed at 16 bytes / 128 bits (Nb=4) for AES	  if (!($nBits==128 || $nBits==192 || $nBits==256)) return '';  // standard allows 128/192/256 bit keys	  // note PHP (5) gives us plaintext and password in UTF8 encoding!	  // use AES itself to encrypt password to get cipher key (using plain password as source for	  // key expansion) - gives us well encrypted key	  $nBytes = $nBits/8;  // no bytes in key	  $pwBytes = array();	  for ($i=0; $i<$nBytes; $i++) $pwBytes[$i] = ord(substr($password,$i,1)) & 0xff;	  $key = self::Cipher($pwBytes, self::KeyExpansion($pwBytes));	  $key = array_merge($key, array_slice($key, 0, $nBytes-16));  // expand key to 16/24/32 bytes long	  // initialise counter block (NIST SP800-38A B.2): millisecond time-stamp for nonce in	  // 1st 8 bytes, block counter in 2nd 8 bytes	  $counterBlock = array();	  $nonce = floor(microtime(true)*1000);   // timestamp: milliseconds since 1-Jan-1970	  $nonceSec = floor($nonce/1000);	  $nonceMs = $nonce%1000;	  // encode nonce with seconds in 1st 4 bytes, and (repeated) ms part filling 2nd 4 bytes	  for ($i=0; $i<4; $i++) $counterBlock[$i] = self::urs($nonceSec, $i*8) & 0xff;	  for ($i=0; $i<4; $i++) $counterBlock[$i+4] = $nonceMs & 0xff;	  // and convert it to a string to go on the front of the ciphertext	  $ctrTxt = '';	  for ($i=0; $i<8; $i++) $ctrTxt .= chr($counterBlock[$i]);	  // generate key schedule - an expansion of the key into distinct Key Rounds for each round	  $keySchedule = self::KeyExpansion($key);	  $blockCount = ceil(strlen($plaintext)/$blockSize);	  $ciphertxt = array();  // ciphertext as array of strings	  for ($b=0; $b<$blockCount; $b++) {	    // set counter (block #) in last 8 bytes of counter block (leaving nonce in 1st 8 bytes)	    // done in two stages for 32-bit ops: using two words allows us to go past 2^32 blocks (68GB)	    for ($c=0; $c<4; $c++) $counterBlock[15-$c] = self::urs($b, $c*8) & 0xff;	    for ($c=0; $c<4; $c++) $counterBlock[15-$c-4] = self::urs($b/0x100000000, $c*8);	    $cipherCntr = self::Cipher($counterBlock, $keySchedule);  // -- encrypt counter block --	    // block size is reduced on final block	    $blockLength = $b<$blockCount-1 ? $blockSize : (strlen($plaintext)-1)%$blockSize+1;	    $cipherByte = array();	    for ($i=0; $i<$blockLength; $i++) {  // -- xor plaintext with ciphered counter byte-by-byte --	      $cipherByte[$i] = $cipherCntr[$i] ^ ord(substr($plaintext, $b*$blockSize+$i, 1));	      $cipherByte[$i] = chr($cipherByte[$i]);	    }	    $ciphertxt[$b] = implode('', $cipherByte);  // escape troublesome characters in ciphertext	  }	  // implode is more efficient than repeated string concatenation	  $ciphertext = $ctrTxt . implode('', $ciphertxt);	  $ciphertext = base64_encode($ciphertext);	  return $ciphertext;	}	/**	 * Decrypt a text encrypted by AES in counter mode of operation	 *	 * @param ciphertext source text to be decrypted	 * @param password   the password to use to generate a key	 * @param nBits      number of bits to be used in the key (128, 192, or 256)	 * @return           decrypted text	 */	public static function AESDecryptCtr($ciphertext, $password, $nBits) {	  $blockSize = 16;  // block size fixed at 16 bytes / 128 bits (Nb=4) for AES	  if (!($nBits==128 || $nBits==192 || $nBits==256)) return '';  // standard allows 128/192/256 bit keys	  $ciphertext = base64_decode($ciphertext);	  // use AES to encrypt password (mirroring encrypt routine)	  $nBytes = $nBits/8;  // no bytes in key	  $pwBytes = array();	  for ($i=0; $i<$nBytes; $i++) $pwBytes[$i] = ord(substr($password,$i,1)) & 0xff;	  $key = self::Cipher($pwBytes, self::KeyExpansion($pwBytes));	  $key = array_merge($key, array_slice($key, 0, $nBytes-16));  // expand key to 16/24/32 bytes long	  // recover nonce from 1st element of ciphertext	  $counterBlock = array();	  $ctrTxt = substr($ciphertext, 0, 8);	  for ($i=0; $i<8; $i++) $counterBlock[$i] = ord(substr($ctrTxt,$i,1));	  // generate key schedule	  $keySchedule = self::KeyExpansion($key);	  // separate ciphertext into blocks (skipping past initial 8 bytes)	  $nBlocks = ceil((strlen($ciphertext)-8) / $blockSize);	  $ct = array();	  for ($b=0; $b<$nBlocks; $b++) $ct[$b] = substr($ciphertext, 8+$b*$blockSize, 16);	  $ciphertext = $ct;  // ciphertext is now array of block-length strings	  // plaintext will get generated block-by-block into array of block-length strings	  $plaintxt = array();	  for ($b=0; $b<$nBlocks; $b++) {	    // set counter (block #) in last 8 bytes of counter block (leaving nonce in 1st 8 bytes)	    for ($c=0; $c<4; $c++) $counterBlock[15-$c] = self::urs($b, $c*8) & 0xff;	    for ($c=0; $c<4; $c++) $counterBlock[15-$c-4] = self::urs(($b+1)/0x100000000-1, $c*8) & 0xff;	    $cipherCntr = self::Cipher($counterBlock, $keySchedule);  // encrypt counter block	    $plaintxtByte = array();	    for ($i=0; $i<strlen($ciphertext[$b]); $i++) {	      // -- xor plaintext with ciphered counter byte-by-byte --	      $plaintxtByte[$i] = $cipherCntr[$i] ^ ord(substr($ciphertext[$b],$i,1));	      $plaintxtByte[$i] = chr($plaintxtByte[$i]);	    }	    $plaintxt[$b] = implode('', $plaintxtByte);	  }	  // join array of blocks into single plaintext string	  $plaintext = implode('',$plaintxt);	  return $plaintext;	}	/**	 * AES decryption in CBC mode. This is the standard mode (the CTR methods	 * actually use Rijndael-128 in CTR mode, which - technically - isn't AES).	 *	 * Supports AES-128, AES-192 and AES-256. It supposes that the last 4 bytes	 * contained a little-endian unsigned long integer representing the unpadded	 * data length.	 *	 * @since 3.0.1	 * @author Nicholas K. Dionysopoulos	 *	 * @param string $ciphertext The data to encrypt	 * @param string $password Encryption password	 * @param int $nBits Encryption key size. Can be 128, 192 or 256	 * @return string The plaintext	 */	public static function AESDecryptCBC($ciphertext, $password, $nBits = 128)	{		if (!($nBits==128 || $nBits==192 || $nBits==256)) return false;  // standard allows 128/192/256 bit keys		if(!function_exists('mcrypt_module_open')) return false;		// Try to fetch cached key/iv or create them if they do not exist		$lookupKey = $password.'-'.$nBits;		if(array_key_exists($lookupKey, self::$passwords))		{			$key	= self::$passwords[$lookupKey]['key'];			$iv		= self::$passwords[$lookupKey]['iv'];		}		else		{			// use AES itself to encrypt password to get cipher key (using plain password as source for			// key expansion) - gives us well encrypted key			$nBytes = $nBits/8;  // no bytes in key			$pwBytes = array();			for ($i=0; $i<$nBytes; $i++) $pwBytes[$i] = ord(substr($password,$i,1)) & 0xff;			$key = self::Cipher($pwBytes, self::KeyExpansion($pwBytes));			$key = array_merge($key, array_slice($key, 0, $nBytes-16));  // expand key to 16/24/32 bytes long			$newKey = '';			foreach($key as $int) { $newKey .= chr($int); }			$key = $newKey;			// Create an Initialization Vector (IV) based on the password, using the same technique as for the key			$nBytes = 16;  // AES uses a 128 -bit (16 byte) block size, hence the IV size is always 16 bytes			$pwBytes = array();			for ($i=0; $i<$nBytes; $i++) $pwBytes[$i] = ord(substr($password,$i,1)) & 0xff;			$iv = self::Cipher($pwBytes, self::KeyExpansion($pwBytes));			$newIV = '';			foreach($iv as $int) { $newIV .= chr($int); }			$iv = $newIV;			self::$passwords[$lookupKey]['key'] = $key;			self::$passwords[$lookupKey]['iv'] = $iv;		}		// Read the data size		$data_size = unpack('V', substr($ciphertext,-4) );		// Decrypt		$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128, '', MCRYPT_MODE_CBC, '');		mcrypt_generic_init($td, $key, $iv);		$plaintext = mdecrypt_generic($td, substr($ciphertext,0,-4));		mcrypt_generic_deinit($td);		// Trim padding, if necessary		if(strlen($plaintext) > $data_size)		{			$plaintext = substr($plaintext, 0, $data_size);		}		return $plaintext;	}}/** * The Master Setup will read the configuration parameters from restoration.php, abiautomation.ini, or * the JSON-encoded "configuration" input variable and return the status. * @return bool True if the master configuration was applied to the Factory object */function masterSetup(){	// ------------------------------------------------------------	// 1. Import basic setup parameters	// ------------------------------------------------------------	$ini_data = null;	// In restore.php mode, require restoration.php or fail	if(!defined('KICKSTART'))	{		// This is the standalone mode, used by Akeeba Backup Professional. It looks for a restoration.php		// file to perform its magic. If the file is not there, we will abort.		$setupFile = 'restoration.php';		if( !file_exists($setupFile) )		{			// Uh oh... Somebody tried to pooh on our back yard. Lock the gates! Don't let the traitor inside!			AKFactory::set('kickstart.enabled', false);			return false;		}		// Load restoration.php. It creates a global variable named $restoration_setup		require_once $setupFile;		$ini_data = $restoration_setup;		if(empty($ini_data))		{			// No parameters fetched. Darn, how am I supposed to work like that?!			AKFactory::set('kickstart.enabled', false);			return false;		}		AKFactory::set('kickstart.enabled', true);	}	else	{		// Maybe we have $restoration_setup defined in the head of kickstart.php		global $restoration_setup;		if(!empty($restoration_setup) && !is_array($restoration_setup)) {			$ini_data = AKText::parse_ini_file($restoration_setup, false, true);		} elseif(is_array($restoration_setup)) {			$ini_data = $restoration_setup;		}	}	// Import any data from $restoration_setup	if(!empty($ini_data))	{		foreach($ini_data as $key => $value)		{			AKFactory::set($key, $value);		}		AKFactory::set('kickstart.enabled', true);	}	// Reinitialize $ini_data	$ini_data = null;	// ------------------------------------------------------------	// 2. Explode JSON parameters into $_REQUEST scope	// ------------------------------------------------------------	// Detect a JSON string in the request variable and store it.	$json = getQueryParam('json', null);	// Remove everything from the request array	if(!empty($_REQUEST))	{		foreach($_REQUEST as $key => $value)		{			unset($_REQUEST[$key]);		}	}	// Decrypt a possibly encrypted JSON string	if(!empty($json))	{		$password = AKFactory::get('kickstart.security.password', null);		if(!empty($password))		{			$json = AKEncryptionAES::AESDecryptCtr($json, $password, 128);		}		// Get the raw data		$raw = json_decode( $json, true );		// Pass all JSON data to the request array		if(!empty($raw))		{			foreach($raw as $key => $value)			{				$_REQUEST[$key] = $value;			}		}	}	// ------------------------------------------------------------	// 3. Try the "factory" variable	// ------------------------------------------------------------	// A "factory" variable will override all other settings.	$serialized = getQueryParam('factory', null);	if( !is_null($serialized) )	{		// Get the serialized factory		AKFactory::unserialize($serialized);		AKFactory::set('kickstart.enabled', true);		return true;	}	// ------------------------------------------------------------	// 4. Try abiautomation.ini and the configuration variable for Kickstart	// ------------------------------------------------------------	if(defined('KICKSTART'))	{		// We are in Kickstart mode. abiautomation.ini has precedence.		$setupFile = 'abiautomation.ini';		if( file_exists($setupFile) )		{			// abiautomation.ini was found			$ini_data = AKText::parse_ini_file('restoration.ini', false);		}		else		{			// abiautomation.ini was not found. Let's try input parameters.			$configuration = getQueryParam('configuration');			if( !is_null($configuration) )			{				// Let's decode the configuration from JSON to array				$ini_data = json_decode($configuration, true);			}			else			{				// Neither exists. Enable Kickstart's interface anyway.				$ini_data = array('kickstart.enabled'=>true);			}		}		// Import any INI data we might have from other sources		if(!empty($ini_data))		{			foreach($ini_data as $key => $value)			{				AKFactory::set($key, $value);			}			AKFactory::set('kickstart.enabled', true);			return true;		}	}}// Mini-controller for restore.phpif(!defined('KICKSTART')){	// The observer class, used to report number of files and bytes processed	class RestorationObserver extends AKAbstractPartObserver	{		public $compressedTotal = 0;		public $uncompressedTotal = 0;		public $filesProcessed = 0;		public function update($object, $message)		{			if(!is_object($message)) return;			if( !array_key_exists('type', get_object_vars($message)) ) return;			if( $message->type == 'startfile' )			{				$this->filesProcessed++;				$this->compressedTotal += $message->content->compressed;				$this->uncompressedTotal += $message->content->uncompressed;			}		}		public function __toString()		{			return __CLASS__;		}	}	// Import configuration	masterSetup();	$retArray = array(		'status'	=> true,		'message'	=> null	);	$enabled = AKFactory::get('kickstart.enabled', false);	if($enabled)	{		$task = getQueryParam('task');		switch($task)		{			case 'ping':				// ping task - realy does nothing!				$timer = AKFactory::getTimer();				$timer->enforce_min_exec_time();				break;			case 'startRestore':				AKFactory::nuke(); // Reset the factory				// Let the control flow to the next step (the rest of the code is common!!)			case 'stepRestore':				$engine = AKFactory::getUnarchiver(); // Get the engine				$observer = new RestorationObserver(); // Create a new observer				$engine->attach($observer); // Attach the observer				$engine->tick();				$ret = $engine->getStatusArray();				if( $ret['Error'] != '' )				{					$retArray['status'] = false;					$retArray['done'] = true;					$retArray['message'] = $ret['Error'];				}				elseif( !$ret['HasRun'] )				{					$retArray['files'] = $observer->filesProcessed;					$retArray['bytesIn'] = $observer->compressedTotal;					$retArray['bytesOut'] = $observer->uncompressedTotal;					$retArray['status'] = true;					$retArray['done'] = true;				}				else				{					$retArray['files'] = $observer->filesProcessed;					$retArray['bytesIn'] = $observer->compressedTotal;					$retArray['bytesOut'] = $observer->uncompressedTotal;					$retArray['status'] = true;					$retArray['done'] = false;					$retArray['factory'] = AKFactory::serialize();				}				break;			case 'finalizeRestore':				$root = AKFactory::get('kickstart.setup.destdir');				// Remove the installation directory				recursive_remove_directory( $root.'/installation' );				$postproc = AKFactory::getPostProc();				// Rename htaccess.bak to .htaccess				if(file_exists($root.'/htaccess.bak'))				{					if( file_exists($root.'/.htaccess')  )					{						$postproc->unlink($root.'/.htaccess');					}					$postproc->rename( $root.'/htaccess.bak', $root.'/.htaccess' );				}				// Remove restoration.php				$basepath = dirname(__FILE__);				$basepath = rtrim( str_replace('\\','/',$basepath), '/' );				if(!empty($basepath)) $basepath .= '/';				$postproc->unlink( $basepath.'restoration.php' );				break;			default:				// Invalid task!				$enabled = false;				break;		}	}	// Maybe we weren't authorized or the task was invalid?	if(!$enabled)	{		// Maybe the user failed to enter any information		$retArray['status'] = false;		$retArray['message'] = AKText::_('ERR_INVALID_LOGIN');	}	// JSON encode the message	$json = json_encode($retArray);	// Do I have to encrypt?	$password = AKFactory::get('kickstart.security.password', null);	if(!empty($password))	{		$json = AKEncryptionAES::AESEncryptCtr($json, $password, 128);	}	// Return the message	echo "###$json###";}// ------------ lixlpixel recursive PHP functions -------------// recursive_remove_directory( directory to delete, empty )// expects path to directory and optional TRUE / FALSE to empty// of course PHP has to have the rights to delete the directory// you specify and all files and folders inside the directory// ------------------------------------------------------------function recursive_remove_directory($directory){	// if the path has a slash at the end we remove it here	if(substr($directory,-1) == '/')	{		$directory = substr($directory,0,-1);	}	// if the path is not valid or is not a directory ...	if(!file_exists($directory) || !is_dir($directory))	{		// ... we return false and exit the function		return FALSE;	// ... if the path is not readable	}elseif(!is_readable($directory))	{		// ... we return false and exit the function		return FALSE;	// ... else if the path is readable	}else{		// we open the directory		$handle = opendir($directory);		$postproc = AKFactory::getPostProc();		// and scan through the items inside		while (FALSE !== ($item = readdir($handle)))		{			// if the filepointer is not the current directory			// or the parent directory			if($item != '.' && $item != '..')			{				// we build the new path to delete				$path = $directory.'/'.$item;				// if the new path is a directory				if(is_dir($path))				{					// we call this function with the new path					recursive_remove_directory($path);				// if the new path is a file				}else{					// we remove the file					$postproc->unlink($path);				}			}		}		// close the directory		closedir($handle);		// try to delete the now empty directory		if(!$postproc->rmdir($directory))		{			// return false if not possible			return FALSE;		}		// return success		return TRUE;	}}?>
<?php/** * @package     Joomla.Administrator * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('formbehavior.chosen', 'select');$app = JFactory::getApplication();$input = $app->input;$assoc = isset($app->item_associations) ? $app->item_associations : 0;?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'contact.cancel' || document.formvalidator.isValid(document.id('contact-form')))		{			<?php echo $this->form->getField('misc')->save(); ?>			Joomla.submitform(task, document.getElementById('contact-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_contact&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="contact-form" class="form-validate form-horizontal">	<div class="row-fluid">		<!-- Begin contact -->		<div class="span10 form-horizontal">		<fieldset>			<?php echo JHtml::_('bootstrap.startTabSet', 'myTab', array('active' => 'details')); ?>				<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'details', empty($this->item->id) ? JText::_('COM_CONTACT_NEW_CONTACT', true) : JText::sprintf('COM_CONTACT_EDIT_CONTACT', $this->item->id, true)); ?>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('name'); ?></div>					<div class="controls"><?php echo $this->form->getInput('name'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('alias'); ?></div>					<div class="controls"><?php echo $this->form->getInput('alias'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('user_id'); ?></div>					<div class="controls"><?php echo $this->form->getInput('user_id'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('catid'); ?></div>					<div class="controls"><?php echo $this->form->getInput('catid'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('ordering'); ?></div>					<div class="controls"><?php echo $this->form->getInput('ordering'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('id'); ?></div>					<div class="controls"><?php echo $this->form->getInput('id'); ?></div>				</div>				<div class="control-group form-inline">					<?php echo $this->form->getLabel('misc'); ?>				</div>					<?php echo $this->form->getInput('misc'); ?>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'publishing', JText::_('JGLOBAL_FIELDSET_PUBLISHING', true)); ?>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('created_by'); ?></div>					<div class="controls"><?php echo $this->form->getInput('created_by'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('created_by_alias'); ?></div>					<div class="controls"><?php echo $this->form->getInput('created_by_alias'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('created'); ?></div>					<div class="controls"><?php echo $this->form->getInput('created'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('publish_up'); ?></div>					<div class="controls"><?php echo $this->form->getInput('publish_up'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('publish_down'); ?></div>					<div class="controls"><?php echo $this->form->getInput('publish_down'); ?></div>				</div>					<?php if ($this->item->modified_by) : ?>						<div class="control-group">							<div class="control-label"><?php echo $this->form->getLabel('modified_by'); ?></div>							<div class="controls"><?php echo $this->form->getInput('modified_by'); ?></div>						</div>						<div class="control-group">							<div class="control-label"><?php echo $this->form->getLabel('modified'); ?></div>							<div class="controls"><?php echo $this->form->getInput('modified'); ?></div>						</div>					<?php endif; ?>				<?php if ($this->item->version) : ?>					<div class="control-group">						<div class="control-label">							<?php echo $this->form->getLabel('version'); ?>						</div>						<div class="controls">							<?php echo $this->form->getInput('version'); ?>						</div>					</div>				<?php endif; ?>				<?php if ($this->item->hits) : ?>					<div class="control-group">						<div class="control-label">							<?php echo $this->form->getLabel('hits'); ?>						</div>						<div class="controls">							<?php echo $this->form->getInput('hits'); ?>						</div>					</div>				<?php endif; ?>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'basic', JText::_('COM_CONTACT_CONTACT_DETAILS', true)); ?>				<p><?php echo empty($this->item->id) ? JText::_('COM_CONTACT_DETAILS', true) : JText::sprintf('COM_CONTACT_EDIT_DETAILS', $this->item->id, true); ?></p>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('image'); ?></div>					<div class="controls"><?php echo $this->form->getInput('image'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('con_position'); ?></div>					<div class="controls"><?php echo $this->form->getInput('con_position'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('email_to'); ?></div>					<div class="controls"><?php echo $this->form->getInput('email_to'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('address'); ?></div>					<div class="controls"><?php echo $this->form->getInput('address'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('suburb'); ?></div>					<div class="controls"><?php echo $this->form->getInput('suburb'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('state'); ?></div>					<div class="controls"><?php echo $this->form->getInput('state'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('postcode'); ?></div>					<div class="controls"><?php echo $this->form->getInput('postcode'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('country'); ?></div>					<div class="controls"><?php echo $this->form->getInput('country'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('telephone'); ?></div>					<div class="controls"><?php echo $this->form->getInput('telephone'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('mobile'); ?></div>					<div class="controls"><?php echo $this->form->getInput('mobile'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('fax'); ?></div>					<div class="controls"><?php echo $this->form->getInput('fax'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('webpage'); ?></div>					<div class="controls"><?php echo $this->form->getInput('webpage'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('sortname1'); ?></div>					<div class="controls"><?php echo $this->form->getInput('sortname1'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('sortname2'); ?></div>					<div class="controls"><?php echo $this->form->getInput('sortname2'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('sortname3'); ?></div>					<div class="controls"><?php echo $this->form->getInput('sortname3'); ?></div>				</div>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php echo $this->loadTemplate('params'); ?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'metadata', JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS', true)); ?>					<?php echo $this->loadTemplate('metadata'); ?>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php if ($assoc) : ?>				<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'associations', JText::_('JGLOBAL_FIELDSET_ASSOCIATIONS', true)); ?>					<?php echo $this->loadTemplate('associations'); ?>				<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php endif; ?>			<?php echo JHtml::_('bootstrap.endTabSet'); ?>		</fieldset>		<input type="hidden" name="task" value="" />		<?php echo JHtml::_('form.token'); ?>	</div>	<!-- End content -->	<!-- Begin Sidebar -->		<?php echo JLayoutHelper::render('joomla.edit.details', $this); ?>	<!-- End Sidebar --></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Modules Component Positions Model * * @package     Joomla.Administrator * @subpackage  com_modules * @since       1.6 */class ModulesModelPositions extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'value',				'templates',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context.'.filter.search', 'filter_search');		$this->setState('filter.search', $search);		$state = $this->getUserStateFromRequest($this->context.'.filter.state', 'filter_state', '', 'string');		$this->setState('filter.state', $state);		$clientId = $app->input->getInt('client_id', 0);		$this->setState('filter.client_id', $clientId);		$template = $this->getUserStateFromRequest($this->context.'.filter.template', 'filter_template', '', 'string');		$this->setState('filter.template', $template);		$type = $this->getUserStateFromRequest($this->context.'.filter.type', 'filter_type', '', 'string');		$this->setState('filter.type', $type);		// Load the parameters.		$params = JComponentHelper::getParams('com_modules');		$this->setState('params', $params);		// List state information.		parent::populateState('value', 'asc');	}	/**	 * Method to get an array of data items.	 *	 * @return  mixed  An array of data items on success, false on failure.	 * @since   1.6	 */	public function getItems()	{		if (!isset($this->items))		{			$lang            = JFactory::getLanguage();			$search          = $this->getState('filter.search');			$state           = $this->getState('filter.state');			$clientId        = $this->getState('filter.client_id');			$filter_template = $this->getState('filter.template');			$type            = $this->getState('filter.type');			$ordering        = $this->getState('list.ordering');			$direction       = $this->getState('list.direction');			$limitstart      = $this->getState('list.start');			$limit           = $this->getState('list.limit');			$client          = JApplicationHelper::getClientInfo($clientId);			if ($type != 'template')			{				// Get the database object and a new query object.				$query	= $this->_db->getQuery(true)					->select('DISTINCT(position) as value')					->from('#__modules')					->where($this->_db->quoteName('client_id').' = '.(int) $clientId);				if ($search)				{					$query->where('position LIKE '.$this->_db->quote('%'.$this->_db->escape($search, true).'%'));				}				$this->_db->setQuery($query);				try				{					$positions = $this->_db->loadObjectList('value');				}				catch (RuntimeException $e)				{					$this->setError($e->getMessage());					return false;				}				foreach ($positions as $value => $position)				{					$positions[$value] = array();				}			}			else			{				$positions = array();			}			// Load the positions from the installed templates.			foreach (ModulesHelper::getTemplates($clientId) as $template)			{				$path = JPath::clean($client->path.'/templates/'.$template->element.'/templateDetails.xml');				if (file_exists($path))				{					$xml = simplexml_load_file($path);					if (isset($xml->positions[0]))					{						$lang->load('tpl_'.$template->element.'.sys', $client->path, null, false, false)					||	$lang->load('tpl_'.$template->element.'.sys', $client->path.'/templates/'.$template->element, null, false, false)					||	$lang->load('tpl_'.$template->element.'.sys', $client->path, $lang->getDefault(), false, false)					||	$lang->load('tpl_'.$template->element.'.sys', $client->path.'/templates/'.$template->element, $lang->getDefault(), false, false);						foreach ($xml->positions[0] as $position)						{							$value = (string) $position['value'];							$label = (string) $position;							if (!$value)							{								$value = $label;								$label = preg_replace('/[^a-zA-Z0-9_\-]/', '_', 'TPL_'.$template->element.'_POSITION_'.$value);								$altlabel = preg_replace('/[^a-zA-Z0-9_\-]/', '_', 'COM_MODULES_POSITION_'.$value);								if (!$lang->hasKey($label) && $lang->hasKey($altlabel))								{									$label = $altlabel;								}							}							if ($type == 'user' || ($state != '' && $state != $template->enabled))							{								unset($positions[$value]);							}							elseif (preg_match(chr(1) . $search . chr(1) . 'i', $value) && ($filter_template == '' || $filter_template == $template->element))							{								if (!isset($positions[$value]))								{									$positions[$value] = array();								}								$positions[$value][$template->name] = $label;							}						}					}				}			}			$this->total = count($positions);			if ($limitstart >= $this->total)			{				$limitstart = $limitstart < $limit ? 0 : $limitstart - $limit;				$this->setState('list.start', $limitstart);			}			if ($ordering == 'value')			{				if ($direction == 'asc')				{					ksort($positions);				}				else {					krsort($positions);				}			}			else {				if ($direction == 'asc')				{					asort($positions);				}				else {					arsort($positions);				}			}			$this->items = array_slice($positions, $limitstart, $limit ? $limit : null);		}		return $this->items;	}	/**	 * Method to get the total number of items.	 *	 * @return  int	The total number of items.	 * @since   1.6	 */	public function getTotal()	{		if (!isset($this->total))		{			$this->getItems();		}		return $this->total;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_banners * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JLoader::register('BannersHelper', JPATH_COMPONENT.'/helpers/banners.php');/** * View to edit a client. * * @package     Joomla.Administrator * @subpackage  com_banners * @since       1.5 */class BannersViewClient extends JViewLegacy{	protected $form;	protected $item;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$this->form	= $this->get('Form');		$this->item	= $this->get('Item');		$this->state	= $this->get('State');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		$this->addToolbar();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		JFactory::getApplication()->input->set('hidemainmenu', true);		$user		= JFactory::getUser();		$isNew		= ($this->item->id == 0);		$checkedOut	= !($this->item->checked_out == 0 || $this->item->checked_out == $user->get('id'));		$canDo		= BannersHelper::getActions();		JToolbarHelper::title($isNew ? JText::_('COM_BANNERS_MANAGER_CLIENT_NEW') : JText::_('COM_BANNERS_MANAGER_CLIENT_EDIT'), 'banners-clients.png');		// If not checked out, can save the item.		if (!$checkedOut && ($canDo->get('core.edit')||$canDo->get('core.create')))		{			JToolbarHelper::apply('client.apply');			JToolbarHelper::save('client.save');		}		if (!$checkedOut && $canDo->get('core.create')) {			JToolbarHelper::save2new('client.save2new');		}		// If an existing item, can save to a copy.		if (!$isNew && $canDo->get('core.create'))		{			JToolbarHelper::save2copy('client.save2copy');		}		if (empty($this->item->id))		{			JToolbarHelper::cancel('client.cancel');		}		else		{			JToolbarHelper::cancel('client.cancel', 'JTOOLBAR_CLOSE');		}		JToolbarHelper::divider();		JToolbarHelper::help('JHELP_COMPONENTS_BANNERS_CLIENTS_EDIT');	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.base.adapterinstance');/** * Package installer * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 */class JInstallerAdapterPackage extends JAdapterInstance{	/**	 * Method of system	 *	 * @var    string	 *	 * @since  3.1	 */	protected $route = 'install';	/**	 * Load language from a path	 *	 * @param   string  $path  The path of the language.	 *	 * @return  void	 *	 * @since   3.1	 */	public function loadLanguage($path)	{		$this->manifest = $this->parent->getManifest();		$extension = 'pkg_' . strtolower(JFilterInput::getInstance()->clean((string) $this->manifest->packagename, 'cmd'));		$lang = JFactory::getLanguage();		$source = $path;		$lang->load($extension . '.sys', $source, null, false, false)			|| $lang->load($extension . '.sys', JPATH_SITE, null, false, false)			|| $lang->load($extension . '.sys', $source, $lang->getDefault(), false, false)			|| $lang->load($extension . '.sys', JPATH_SITE, $lang->getDefault(), false, false);	}	/**	 * Custom install method	 *	 * @return  int  The extension id	 *	 * @since   3.1	 */	public function install()	{		// Get the extension manifest object		$this->manifest = $this->parent->getManifest();		/*		 * ---------------------------------------------------------------------------------------------		 * Manifest Document Setup Section		 * ---------------------------------------------------------------------------------------------		 */		// Set the extensions name		$filter = JFilterInput::getInstance();		$name = (string) $this->manifest->packagename;		$name = $filter->clean($name, 'cmd');		$this->set('name', $name);		$element = 'pkg_' . $filter->clean($this->manifest->packagename, 'cmd');		$this->set('element', $element);		// Get the component description		$description = (string) $this->manifest->description;		if ($description)		{			$this->parent->set('message', JText::_($description));		}		else		{			$this->parent->set('message', '');		}		// Set the installation path		$files = $this->manifest->files;		$group = (string) $this->manifest->packagename;		if (!empty($group))		{			$this->parent->setPath('extension_root', JPATH_MANIFESTS . '/packages/' . implode(DIRECTORY_SEPARATOR, explode('/', $group)));		}		else		{			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PACK_INSTALL_NO_PACK', JText::_('JLIB_INSTALLER_' . strtoupper($this->route))));			return false;		}		/*		 * If the package manifest already exists, then we will assume that the package is already		 * installed.		 */		if (file_exists(JPATH_MANIFESTS . '/packages/' . basename($this->parent->getPath('manifest'))))		{			// Look for an update function or update tag			$updateElement = $this->manifest->update;			// If $this->upgrade has already been set, or an update property exists in the manifest, update the extensions			if ($this->parent->isUpgrade() || $updateElement)			{				// Use the update route for all packaged extensions				$this->route = 'update';			}		}		/**		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, lets load it; we'll copy it later (don't have dest yet)		$this->scriptElement = $this->manifest->scriptfile;		$manifestScript = (string) $this->manifest->scriptfile;		if ($manifestScript)		{			$manifestScriptFile = $this->parent->getPath('source') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// Set the class name			$classname = $element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		// Run preflight if possible (since we know we're not an update)		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'preflight'))		{			if ($this->parent->manifestClass->preflight($this->route, $this) === false)			{				// Preflight failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_PACKAGE_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Create msg object; first use here		$msg = ob_get_contents();		ob_end_clean();		/*		 * ---------------------------------------------------------------------------------------------		 * Filesystem Processing Section		 * ---------------------------------------------------------------------------------------------		 */		if ($folder = $files->attributes()->folder)		{			$source = $this->parent->getPath('source') . '/' . $folder;		}		else		{			$source = $this->parent->getPath('source');		}		// Install all necessary files		if (count($this->manifest->files->children()))		{			$i = 0;			foreach ($this->manifest->files->children() as $child)			{				$file = $source . '/' . $child;				if (is_dir($file))				{					// If it's actually a directory then fill it up					$package = array();					$package['dir'] = $file;					$package['type'] = JInstallerHelper::detectType($file);				}				else				{					// If it's an archive					$package = JInstallerHelper::unpack($file);				}				$tmpInstaller = new JInstaller;				$installResult = $tmpInstaller->{$this->route}($package['dir']);				if (!$installResult)				{					$this->parent->abort(						JText::sprintf(							'JLIB_INSTALLER_ABORT_PACK_INSTALL_ERROR_EXTENSION', JText::_('JLIB_INSTALLER_' . strtoupper($this->route)),							basename($file)						)					);					return false;				}				else				{					$results[$i] = array(						'name' => $tmpInstaller->manifest->name,						'result' => $installResult					);				}				$i++;			}		}		else		{			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PACK_INSTALL_NO_FILES', JText::_('JLIB_INSTALLER_' . strtoupper($this->route))));			return false;		}		// Parse optional tags		$this->parent->parseLanguages($this->manifest->languages);		/*		 * ---------------------------------------------------------------------------------------------		 * Extension Registration		 * ---------------------------------------------------------------------------------------------		 */		$row = JTable::getInstance('extension');		$eid = $row->find(array('element' => strtolower($this->get('element')), 'type' => 'package'));		if ($eid)		{			$row->load($eid);		}		else		{			$row->name = $this->get('name');			$row->type = 'package';			$row->element = $this->get('element');			// There is no folder for modules			$row->folder = '';			$row->enabled = 1;			$row->protected = 0;			$row->access = 1;			$row->client_id = 0;			// Custom data			$row->custom_data = '';			$row->params = $this->parent->getParams();		}		// Update the manifest cache for the entry		$row->manifest_cache = $this->parent->generateManifestCache();		if (!$row->store())		{			// Install failed, roll back changes			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PACK_INSTALL_ROLLBACK', $row->getError()));			return false;		}		/*		 * ---------------------------------------------------------------------------------------------		 * Finalization and Cleanup Section		 * ---------------------------------------------------------------------------------------------		 */		// Run the custom method based on the route		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, $this->route))		{			if ($this->parent->manifestClass->{$this->route}($this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_FILE_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		// Lastly, we will copy the manifest file to its appropriate place.		$manifest = array();		$manifest['src'] = $this->parent->getPath('manifest');		$manifest['dest'] = JPATH_MANIFESTS . '/packages/' . basename($this->parent->getPath('manifest'));		if (!$this->parent->copyFiles(array($manifest), true))		{			// Install failed, rollback changes			$this->parent->abort(				JText::sprintf('JLIB_INSTALLER_ABORT_PACK_INSTALL_COPY_SETUP', JText::_('JLIB_INSTALLER_ABORT_PACK_INSTALL_NO_FILES'))			);			return false;		}		// If there is a manifest script, let's copy it.		if ($this->get('manifest_script'))		{			// First, we have to create a folder for the script if one isn't present			if (!file_exists($this->parent->getPath('extension_root')))			{				JFolder::create($this->parent->getPath('extension_root'));			}			$path['src'] = $this->parent->getPath('source') . '/' . $this->get('manifest_script');			$path['dest'] = $this->parent->getPath('extension_root') . '/' . $this->get('manifest_script');			if (!file_exists($path['dest']) || $this->parent->isOverwrite())			{				if (!$this->parent->copyFiles(array($path)))				{					// Install failed, rollback changes					$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_PACKAGE_INSTALL_MANIFEST'));					return false;				}			}		}		// And now we run the postflight		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'postflight'))		{			$this->parent->manifestClass->postflight($this->route, $this, $results);		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		return $row->extension_id;	}	/**	 * Updates a package	 *	 * The only difference between an update and a full install	 * is how we handle the database	 *	 * @return  void	 *	 * @since   3.1	 */	public function update()	{		$this->route = 'update';		$this->install();	}	/**	 * Custom uninstall method	 *	 * @param   integer  $id  The id of the package to uninstall.	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function uninstall($id)	{		$row = null;		$retval = true;		$row = JTable::getInstance('extension');		$row->load($id);		if ($row->protected)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_WARNCOREPACK'), JLog::WARNING, 'jerror');			return false;		}		$manifestFile = JPATH_MANIFESTS . '/packages/' . $row->get('element') . '.xml';		$manifest = new JInstallerManifestPackage($manifestFile);		// Set the package root path		$this->parent->setPath('extension_root', JPATH_MANIFESTS . '/packages/' . $manifest->packagename);		// Because packages may not have their own folders we cannot use the standard method of finding an installation manifest		if (!file_exists($manifestFile))		{			// TODO: Fail?			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_MISSINGMANIFEST'), JLog::WARNING, 'jerror');			return false;		}		$xml = simplexml_load_file($manifestFile);		// If we cannot load the XML file return false		if (!$xml)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_LOAD_MANIFEST'), JLog::WARNING, 'jerror');			return false;		}		// Check for a valid XML root tag.		if ($xml->getName() != 'extension')		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_INVALID_MANIFEST'), JLog::WARNING, 'jerror');			return false;		}		// If there is an manifest class file, let's load it		$this->scriptElement = $manifest->scriptfile;		$manifestScript = (string) $manifest->scriptfile;		if ($manifestScript)		{			$manifestScriptFile = $this->parent->getPath('extension_root') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// Set the class name			$classname = $row->element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		ob_start();		ob_implicit_flush(false);		// Run uninstall if possible		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'uninstall'))		{			$this->parent->manifestClass->uninstall($this);		}		$msg = ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		$error = false;		foreach ($manifest->filelist as $extension)		{			$tmpInstaller = new JInstaller;			$id = $this->_getExtensionID($extension->type, $extension->id, $extension->client, $extension->group);			$client = JApplicationHelper::getClientInfo($extension->client, true);			if ($id)			{				if (!$tmpInstaller->uninstall($extension->type, $id, $client->id))				{					$error = true;					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_NOT_PROPER', basename($extension->filename)), JLog::WARNING, 'jerror');				}			}			else			{				JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_UNKNOWN_EXTENSION'), JLog::WARNING, 'jerror');			}		}		// Remove any language files		$this->parent->removeFiles($xml->languages);		// Clean up manifest file after we're done if there were no errors		if (!$error)		{			JFile::delete($manifestFile);			$folder = $this->parent->getPath('extension_root');			if (JFolder::exists($folder))			{				JFolder::delete($folder);			}			$row->delete();		}		else		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_UNINSTALL_MANIFEST_NOT_REMOVED'), JLog::WARNING, 'jerror');		}		// Return the result up the line		return $retval;	}	/**	 * Gets the extension id.	 *	 * @param   string   $type    The extension type.	 * @param   string   $id      The name of the extension (the element field).	 * @param   integer  $client  The application id (0: Joomla CMS site; 1: Joomla CMS administrator).	 * @param   string   $group   The extension group (mainly for plugins).	 *	 * @return  integer	 *	 * @since   3.1	 */	protected function _getExtensionID($type, $id, $client, $group)	{		$db = $this->parent->getDbo();		$query = $db->getQuery(true)			->select('extension_id')			->from('#__extensions')			->where('type = ' . $db->quote($type))			->where('element = ' . $db->quote($id));		switch ($type)		{			case 'plugin':				// Plugins have a folder but not a client				$query->where('folder = ' . $db->quote($group));				break;			case 'library':			case 'package':			case 'component':				// Components, packages and libraries don't have a folder or client.				// Included for completeness.				break;			case 'language':			case 'module':			case 'template':				// Languages, modules and templates have a client but not a folder				$client = JApplicationHelper::getClientInfo($client, true);				$query->where('client_id = ' . (int) $client->id);				break;		}		$db->setQuery($query);		$result = $db->loadResult();		// Note: For templates, libraries and packages their unique name is their key.		// This means they come out the same way they came in.		return $result;	}	/**	 * Refreshes the extension table cache	 *	 * @return  boolean  Result of operation, true if updated, false on failure	 *	 * @since   3.1	 */	public function refreshManifestCache()	{		// Need to find to find where the XML file is since we don't store this normally		$manifestPath = JPATH_MANIFESTS . '/packages/' . $this->parent->extension->element . '.xml';		$this->parent->manifest = $this->parent->isManifest($manifestPath);		$this->parent->setPath('manifest', $manifestPath);		$manifest_details = JInstaller::parseXMLInstallFile($this->parent->getPath('manifest'));		$this->parent->extension->manifest_cache = json_encode($manifest_details);		$this->parent->extension->name = $manifest_details['name'];		try		{			return $this->parent->extension->store();		}		catch (RuntimeException $e)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PACK_REFRESH_MANIFEST_CACHE'), JLog::WARNING, 'jerror');			return false;		}	}}/** * Deprecated class placeholder. You should use JInstallerAdapterPackage instead. * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 * @deprecated  4.0 * @codeCoverageIgnore */class JInstallerPackage extends JInstallerAdapterPackage{}
<?php/** * @package     Joomla.Site * @subpackage  mod_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;require_once JPATH_SITE . '/components/com_weblinks/helpers/route.php';require_once JPATH_SITE . '/components/com_weblinks/helpers/category.php';JModelLegacy::addIncludePath(JPATH_SITE . '/components/com_weblinks/models', 'WeblinksModel');/** * Helper for mod_weblinks * * @package     Joomla.Site * @subpackage  mod_weblinks */class ModWeblinksHelper{	public static function getList($params)	{		// Get an instance of the generic articles model		$model = JModelLegacy::getInstance('Category', 'WeblinksModel', array('ignore_request' => true));		// Set application parameters in model		$app = JFactory::getApplication();		$appParams = $app->getParams();		$model->setState('params', $appParams);		// Set the filters based on the module params		$model->setState('list.start', 0);		$model->setState('list.limit', (int) $params->get('count', 5));		$model->setState('filter.state', 1);		$model->setState('filter.publish_date', true);		// Access filter		$access = !JComponentHelper::getParams('com_weblinks')->get('show_noauth');		$model->setState('filter.access', $access);		$ordering = $params->get('ordering', 'ordering');		$model->setState('list.ordering', $ordering == 'order' ? 'ordering' : $ordering);		$model->setState('list.direction', $params->get('direction', 'asc'));		$catid	= (int) $params->get('catid', 0);		$model->setState('category.id', $catid);		// Create query object		$db = JFactory::getDbo();		$query = $db->getQuery(true);		$case_when1 = ' CASE WHEN ';		$case_when1 .= $query->charLength('a.alias', '!=', '0');		$case_when1 .= ' THEN ';		$a_id = $query->castAsChar('a.id');		$case_when1 .= $query->concatenate(array($a_id, 'a.alias'), ':');		$case_when1 .= ' ELSE ';		$case_when1 .= $a_id.' END as slug';		$case_when2 = ' CASE WHEN ';		$case_when2 .= $query->charLength('c.alias', '!=', '0');		$case_when2 .= ' THEN ';		$c_id = $query->castAsChar('c.id');		$case_when2 .= $query->concatenate(array($c_id, 'c.alias'), ':');		$case_when2 .= ' ELSE ';		$case_when2 .= $c_id.' END as catslug';		$model->setState(			'list.select',			'a.*, c.published AS c_published,' . $case_when1 . ',' . $case_when2 . ',' . 'DATE_FORMAT(a.created, "%Y-%m-%d") AS created'		);		$model->setState('filter.c.published', 1);		// Filter by language		$model->setState('filter.language', $app->getLanguageFilter());		$items = $model->getItems();		if ($items)		{			foreach ($items as $item)			{				if ($item->params->get('count_clicks', $params->get('count_clicks')) == 1)				{					$item->link	= JRoute::_('index.php?option=com_weblinks&task=weblink.go&catid=' . $item->catslug . '&id=' . $item->slug);				}				else				{					$item->link = $item->url;				}			}			return $items;		}		else		{			return;		}	}}
<?php/** * @package     Joomla.Site * @subpackage  Layout * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// JLayout for standard handling of the details sidebar in administrator edit screens.$title = $displayData->get('form')->getValue('title');$published = $displayData->get('form')->getValue('published');?><div class="span2"><h4><?php echo JText::_('JDETAILS');?></h4>			<hr />			<fieldset class="form-vertical">				<?php if (empty($title)) : ?>					<div class="control-group">						<div class="controls">							<?php echo $displayData->get('form')->getValue('name'); ?>						</div>					</div>				<?php else : ?>				<div class="control-group">					<div class="controls">						<?php echo $displayData->get('form')->getValue('title'); ?>					</div>				</div>				<?php endif; ?>				<?php if ($published) : ?>					<div class="control-group">						<div class="control-label">							<?php echo $displayData->get('form')->getLabel('published'); ?>						</div>						<div class="controls">							<?php echo $displayData->get('form')->getInput('published'); ?>						</div>					</div>				<?php else : ?>					<div class="control-group">						<div class="control-label">							<?php echo $displayData->get('form')->getLabel('state'); ?>						</div>						<div class="controls">							<?php echo $displayData->get('form')->getInput('state'); ?>						</div>					</div>				<?php endif; ?>				<div class="control-group">					<div class="control-label">						<?php echo $displayData->get('form')->getLabel('access'); ?>					</div>					<div class="controls">						<?php echo $displayData->get('form')->getInput('access'); ?>					</div>				</div>				<div class="control-group">					<div class="control-label">						<?php echo $displayData->get('form')->getLabel('featured'); ?>					</div>					<div class="controls">						<?php echo $displayData->get('form')->getInput('featured'); ?>					</div>				</div>				<div class="control-group">					<div class="control-label">						<?php echo $displayData->get('form')->getLabel('language'); ?>					</div>					<div class="controls">						<?php echo $displayData->get('form')->getInput('language'); ?>					</div>				</div>				<div class="control-group">					<?php foreach ($displayData->get('form')->getFieldset('jmetadata') as $field) : ?>						<?php if ($field->name == 'jform[metadata][tags][]') :?>						<div class="control-group">							<div class="control-label"><?php echo $field->label; ?></div>							<div class="controls"><?php echo $field->input; ?></div>						</div>						<?php endif; ?>					<?php endforeach; ?>				</div>			</fieldset>		</div>
<?php/** * @package     Joomla.Site * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;define('FINDER_PATH_INDEXER', JPATH_ADMINISTRATOR . '/components/com_finder/helpers/indexer');JLoader::register('FinderIndexerHelper', FINDER_PATH_INDEXER . '/helper.php');/** * Suggestions model class for the Finder package. * * @package     Joomla.Site * @subpackage  com_finder * @since       2.5 */class FinderModelSuggestions extends JModelList{	/**	 * Context string for the model type.	 *	 * @var    string	 * @since  2.5	 */	protected $context = 'com_finder.suggestions';	/**	 * Method to get an array of data items.	 *	 * @return  array  An array of data items.	 *	 * @since   2.5	 */	public function getItems()	{		// Get the items.		$items = parent::getItems();		// Convert them to a simple array.		foreach ($items as $k => $v)		{			$items[$k] = $v->term;		}		return $items;	}	/**	 * Method to build a database query to load the list data.	 *	 * @return  JDatabaseQuery  A database query	 *	 * @since   2.5	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		// Select required fields		$query->select('t.term')			->from($db->quoteName('#__finder_terms') . ' AS t')			->where('t.term LIKE ' . $db->quote($db->escape($this->getState('input'), true) . '%'))			->where('t.common = 0')			->where('t.language IN (' . $db->quote($db->escape($this->getState('language'), true)) . ', ' . $db->quote('*') . ')')			->order('t.links DESC')			->order('t.weight DESC');		return $query;	}	/**	 * Method to get a store id based on model the configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id  An identifier string to generate the store id. [optional]	 *	 * @return  string  A store id.	 *	 * @since   2.5	 */	protected function getStoreId($id = '')	{		// Add the search query state.		$id .= ':' . $this->getState('input');		$id .= ':' . $this->getState('language');		// Add the list state.		$id .= ':' . $this->getState('list.start');		$id .= ':' . $this->getState('list.limit');		return parent::getStoreId($id);	}	/**	 * Method to auto-populate the model state.  Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   2.5	 */	protected function populateState($ordering = null, $direction = null)	{		// Get the configuration options.		$app = JFactory::getApplication();		$input = $app->input;		$params = JComponentHelper::getParams('com_finder');		$user = JFactory::getUser();		// Get the query input.		$this->setState('input', $input->request->get('q', '', 'string'));		// Set the query language		$lang = FinderIndexerHelper::getDefaultLanguage();		$lang = FinderIndexerHelper::getPrimaryLanguage($lang);		$this->setState('language', $lang);		// Load the list state.		$this->setState('list.start', 0);		$this->setState('list.limit', 10);		// Load the parameters.		$this->setState('params', $params);		// Load the user state.		$this->setState('user.id', (int) $user->get('id'));	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JLoader::register('ContactHelper', JPATH_ADMINISTRATOR . '/components/com_contact/helpers/contact.php');/** * Item Model for a Contact. * * @package     Joomla.Administrator * @subpackage  com_contact * @since       1.6 */class ContactModelContact extends JModelAdmin{	/**	 * Method to perform batch operations on an item or a set of items.	 *	 * @param   array  $commands  An array of commands to perform.	 * @param   array  $pks       An array of item ids.	 * @param   array  $contexts  An array of item contexts.	 *	 * @return  boolean  Returns true on success, false on failure.	 *	 * @since   2.5	 */	public function batch($commands, $pks, $contexts)	{		// Sanitize user ids.		$pks = array_unique($pks);		JArrayHelper::toInteger($pks);		// Remove any values of zero.		if (array_search(0, $pks, true))		{			unset($pks[array_search(0, $pks, true)]);		}		if (empty($pks))		{			$this->setError(JText::_('JGLOBAL_NO_ITEM_SELECTED'));			return false;		}		$done = false;		if (!empty($commands['category_id']))		{			$cmd = JArrayHelper::getValue($commands, 'move_copy', 'c');			if ($cmd == 'c')			{				$result = $this->batchCopy($commands['category_id'], $pks, $contexts);				if (is_array($result))				{					$pks = $result;				}				else				{					return false;				}			}			elseif ($cmd == 'm' && !$this->batchMove($commands['category_id'], $pks, $contexts))			{				return false;			}			$done = true;		}		if (!empty($commands['assetgroup_id']))		{			if (!$this->batchAccess($commands['assetgroup_id'], $pks, $contexts))			{				return false;			}			$done = true;		}		if (!empty($commands['language_id']))		{			if (!$this->batchLanguage($commands['language_id'], $pks, $contexts))			{				return false;			}			$done = true;		}		if (!empty($commands['tag']))		{			if (!$this->batchTag($commands['tag'], $pks, $contexts))			{				return false;			}			$done = true;		}		if (strlen($commands['user_id']) > 0)		{			if (!$this->batchUser($commands['user_id'], $pks, $contexts))			{				return false;			}			$done = true;		}		if (!$done)		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_INSUFFICIENT_BATCH_INFORMATION'));			return false;		}		// Clear the cache		$this->cleanCache();		return true;	}	/**	 * Batch copy items to a new category or current.	 *	 * @param   integer  $value     The new category.	 * @param   array    $pks       An array of row IDs.	 * @param   array    $contexts  An array of item contexts.	 *	 * @return  mixed  An array of new IDs on success, boolean false on failure.	 *	 * @since   11.1	 */	protected function batchCopy($value, $pks, $contexts)	{		$categoryId = (int) $value;		$table = $this->getTable();		$i = 0;		// Check that the category exists		if ($categoryId)		{			$categoryTable = JTable::getInstance('Category');			if (!$categoryTable->load($categoryId))			{				if ($error = $categoryTable->getError())				{					// Fatal error					$this->setError($error);					return false;				}				else				{					$this->setError(JText::_('JLIB_APPLICATION_ERROR_BATCH_MOVE_CATEGORY_NOT_FOUND'));					return false;				}			}		}		if (empty($categoryId))		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_BATCH_MOVE_CATEGORY_NOT_FOUND'));			return false;		}		// Check that the user has create permission for the component		$user = JFactory::getUser();		if (!$user->authorise('core.create', 'com_contact.category.' . $categoryId))		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_BATCH_CANNOT_CREATE'));			return false;		}		// Parent exists so we let's proceed		while (!empty($pks))		{			// Pop the first ID off the stack			$pk = array_shift($pks);			$table->reset();			// Check that the row actually exists			if (!$table->load($pk))			{				if ($error = $table->getError())				{					// Fatal error					$this->setError($error);					return false;				}				else				{					// Not fatal error					$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_BATCH_MOVE_ROW_NOT_FOUND', $pk));					continue;				}			}			// Alter the title & alias			$data = $this->generateNewTitle($categoryId, $table->alias, $table->name);			$table->name = $data['0'];			$table->alias = $data['1'];			// Reset the ID because we are making a copy			$table->id = 0;			// New category ID			$table->catid = $categoryId;			// TODO: Deal with ordering?			//$table->ordering	= 1;			// Check the row.			if (!$table->check())			{				$this->setError($table->getError());				return false;			}			// Store the row.			if (!$table->store())			{				$this->setError($table->getError());				return false;			}			// Get the new item ID			$newId = $table->get('id');			// Add the new ID to the array			$newIds[$i] = $newId;			$i++;		}		// Clean the cache		$this->cleanCache();		return $newIds;	}	/**	 * Batch change a linked user.	 *	 * @param   integer  $value     The new value matching a User ID.	 * @param   array    $pks       An array of row IDs.	 * @param   array    $contexts  An array of item contexts.	 *	 * @return  boolean  True if successful, false otherwise and internal error is set.	 *	 * @since   2.5	 */	protected function batchUser($value, $pks, $contexts)	{		// Set the variables		$user = JFactory::getUser();		$table = $this->getTable();		foreach ($pks as $pk)		{			if ($user->authorise('core.edit', $contexts[$pk]))			{				$table->reset();				$table->load($pk);				$table->user_id = (int) $value;				if (!$table->store())				{					$this->setError($table->getError());					return false;				}			}			else			{				$this->setError(JText::_('JLIB_APPLICATION_ERROR_BATCH_CANNOT_EDIT'));				return false;			}		}		// Clean the cache		$this->cleanCache();		return true;	}	/**	 * Method to test whether a record can be deleted.	 *	 * @param   object  $record  A record object.	 *	 * @return  boolean  True if allowed to delete the record. Defaults to the permission set in the component.	 * @since   1.6	 */	protected function canDelete($record)	{		if (!empty($record->id))		{			if ($record->published != -2)			{				return;			}			$user = JFactory::getUser();			return $user->authorise('core.delete', 'com_contact.category.' . (int) $record->catid);		}	}	/**	 * Method to test whether a record can have its state edited.	 *	 * @param   object    $record    A record object.	 *	 * @return  boolean  True if allowed to change the state of the record. Defaults to the permission set in the component.	 * @since   1.6	 */	protected function canEditState($record)	{		$user = JFactory::getUser();		// Check against the category.		if (!empty($record->catid))		{			return $user->authorise('core.edit.state', 'com_contact.category.' . (int) $record->catid);		}		// Default to component settings if category not known.		else		{			return parent::canEditState($record);		}	}	/**	 * Returns a Table object, always creating it	 *	 * @param   type      $type      The table type to instantiate	 * @param   string    $prefix    A prefix for the table class name. Optional.	 * @param   array     $config    Configuration array for model. Optional.	 *	 * @return  JTable    A database object	 * @since   1.6	 */	public function getTable($type = 'Contact', $prefix = 'ContactTable', $config = array())	{		return JTable::getInstance($type, $prefix, $config);	}	/**	 * Method to get the row form.	 *	 * @param   array      $data        Data for the form.	 * @param   boolean    $loadData    True if the form is to load its own data (default case), false if not.	 *	 * @return  mixed  A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		JForm::addFieldPath('JPATH_ADMINISTRATOR/components/com_users/models/fields');		// Get the form.		$form = $this->loadForm('com_contact.contact', 'contact', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		// Modify the form based on access controls.		if (!$this->canEditState((object) $data))		{			// Disable fields for display.			$form->setFieldAttribute('featured', 'disabled', 'true');			$form->setFieldAttribute('ordering', 'disabled', 'true');			$form->setFieldAttribute('published', 'disabled', 'true');			// Disable fields while saving.			// The controller has already verified this is a record you can edit.			$form->setFieldAttribute('featured', 'filter', 'unset');			$form->setFieldAttribute('ordering', 'filter', 'unset');			$form->setFieldAttribute('published', 'filter', 'unset');		}		return $form;	}	/**	 * Method to get a single record.	 *	 * @param   integer    $pk    The id of the primary key.	 *	 * @return  mixed  Object on success, false on failure.	 * @since   1.6	 */	public function getItem($pk = null)	{		if ($item = parent::getItem($pk))		{			// Convert the metadata field to an array.			$registry = new JRegistry;			$registry->loadString($item->metadata);			$item->metadata = $registry->toArray();		}		// Load associated contact items		$app = JFactory::getApplication();		$assoc = isset($app->item_associations) ? $app->item_associations : 0;		if ($assoc)		{			$item->associations = array();			if ($item->id != null)			{				$associations = JLanguageAssociations::getAssociations('com_contact', '#__contact_details', 'com_contact.item', $item->id);				foreach ($associations as $tag => $association)				{					$item->associations[$tag] = $association->id;				}			}		}		// Load item tags		if (!empty($item->id))		{			$item->tags = new JHelperTags;			$item->tags->getTagIds($item->id, 'com_contact.contact');			$item->metadata['tags'] = $item->tags;		}		return $item;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_contact.edit.contact.data', array());		if (empty($data))		{			$data = $this->getItem();			// Prime some default values.			if ($this->getState('contact.id') == 0)			{				$app = JFactory::getApplication();				$data->set('catid', $app->input->get('catid', $app->getUserState('com_contact.contacts.filter.category_id'), 'int'));			}		}		$this->preprocessData('com_contact.contact', $data);		return $data;	}	/**	 * Method to save the form data.	 *	 * @param   array  The form data.	 *	 * @return  boolean  True on success.	 * @since    3.0	 */	public function save($data)	{		$app = JFactory::getApplication();		// Alter the title for save as copy		if ($app->input->get('task') == 'save2copy')		{			list($name, $alias) = $this->generateNewTitle($data['catid'], $data['alias'], $data['name']);			$data['name'] = $name;			$data['alias'] = $alias;			$data['published'] = 0;		}		if (parent::save($data))		{			$assoc = isset($app->item_associations) ? $app->item_associations : 0;			if ($assoc)			{				$id = (int) $this->getState($this->getName() . '.id');				$item = $this->getItem($id);				// Adding self to the association				$associations = $data['associations'];				foreach ($associations as $tag => $id)				{					if (empty($id))					{						unset($associations[$tag]);					}				}				// Detecting all item menus				$all_language = $item->language == '*';				if ($all_language && !empty($associations))				{					JError::raiseNotice(403, JText::_('COM_CONTACT_ERROR_ALL_LANGUAGE_ASSOCIATED'));				}				$associations[$item->language] = $item->id;				// Deleting old association for these items				$db = JFactory::getDbo();				$query = $db->getQuery(true)					->delete('#__associations')					->where('context=' . $db->quote('com_contact.item'))					->where('id IN (' . implode(',', $associations) . ')');				$db->setQuery($query);				$db->execute();				if ($error = $db->getErrorMsg())				{					$this->setError($error);					return false;				}				if (!$all_language && count($associations))				{					// Adding new association for these items					$key = md5(json_encode($associations));					$query->clear()						->insert('#__associations');					foreach ($associations as $tag => $id)					{						$query->values($id . ',' . $db->quote('com_contact.item') . ',' . $db->quote($key));					}					$db->setQuery($query);					$db->execute();					if ($error = $db->getErrorMsg())					{						$this->setError($error);						return false;					}				}			}			return true;		}		return false;	}	/**	 * Prepare and sanitise the table prior to saving.	 *	 * @param   JTable    $table	 *	 * @return  void	 * @since   1.6	 */	protected function prepareTable($table)	{		$date = JFactory::getDate();		$user = JFactory::getUser();		$table->name = htmlspecialchars_decode($table->name, ENT_QUOTES);		$table->alias = JApplication::stringURLSafe($table->alias);		if (empty($table->alias))		{			$table->alias = JApplication::stringURLSafe($table->name);		}		if (empty($table->id))		{			// Set the values			$table->created = $date->toSql();			// Set ordering to the last item if not set			if (empty($table->ordering))			{				$db = JFactory::getDbo();				$db->setQuery('SELECT MAX(ordering) FROM #__contact_details');				$max = $db->loadResult();				$table->ordering = $max + 1;			}		}		else		{			// Set the values			$table->modified = $date->toSql();			$table->modified_by = $user->get('id');		}		// Increment the content version number.		$table->version++;	}	/**	 * A protected method to get a set of ordering conditions.	 *	 * @param   JTable    $table    A record object.	 *	 * @return  array  An array of conditions to add to add to ordering queries.	 * @since   1.6	 */	protected function getReorderConditions($table)	{		$condition = array();		$condition[] = 'catid = ' . (int) $table->catid;		return $condition;	}	protected function preprocessForm(JForm $form, $data, $group = 'content')	{		// Association content items		$app = JFactory::getApplication();		$assoc = isset($app->item_associations) ? $app->item_associations : 0;		if ($assoc)		{			$languages = JLanguageHelper::getLanguages('lang_code');			// force to array (perhaps move to $this->loadFormData())			$data = (array) $data;			$addform = new SimpleXMLElement('<form />');			$fields = $addform->addChild('fields');			$fields->addAttribute('name', 'associations');			$fieldset = $fields->addChild('fieldset');			$fieldset->addAttribute('name', 'item_associations');			$fieldset->addAttribute('description', 'COM_CONTACT_ITEM_ASSOCIATIONS_FIELDSET_DESC');			$add = false;			foreach ($languages as $tag => $language)			{				if (empty($data['language']) || $tag != $data['language'])				{					$add = true;					$field = $fieldset->addChild('field');					$field->addAttribute('name', $tag);					$field->addAttribute('type', 'modal_contacts');					$field->addAttribute('language', $tag);					$field->addAttribute('label', $language->title);					$field->addAttribute('translate_label', 'false');				}			}			if ($add)			{				$form->load($addform, false);			}		}		parent::preprocessForm($form, $data, $group);	}	/**	 * Method to toggle the featured setting of contacts.	 *	 * @param   array    $pks      The ids of the items to toggle.	 * @param   integer  $value    The value to toggle to.	 *	 * @return  boolean  True on success.	 * @since   1.6	 */	public function featured($pks, $value = 0)	{		// Sanitize the ids.		$pks = (array) $pks;		JArrayHelper::toInteger($pks);		if (empty($pks))		{			$this->setError(JText::_('COM_CONTACT_NO_ITEM_SELECTED'));			return false;		}		$table = $this->getTable();		try		{			$db = $this->getDbo();			$db->setQuery(				'UPDATE #__contact_details' .					' SET featured = ' . (int) $value .					' WHERE id IN (' . implode(',', $pks) . ')'			);			$db->execute();		}		catch (Exception $e)		{			$this->setError($e->getMessage());			return false;		}		$table->reorder();		// Clean component's cache		$this->cleanCache();		return true;	}	/**	 * Method to change the title & alias.	 *	 * @param   integer  $parent_id  The id of the parent.	 * @param   string   $alias      The alias.	 * @param   string   $title      The title.	 *	 * @return  array  Contains the modified title and alias.	 *	 * @since   3.1	 */	protected function generateNewTitle($category_id, $alias, $name)	{		// Alter the title & alias		$table = $this->getTable();		while ($table->load(array('alias' => $alias, 'catid' => $category_id)))		{			if ($name == $table->name)			{				$name = JString::increment($name);			}			$alias = JString::increment($alias, 'dash');		}		return array($name, $alias);	}}
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * @package     Joomla.Site * @subpackage  com_contact * @since       1.5 */class ContactModelContact extends JModelForm{	/**	 * @since   1.6	 */	protected $view_item = 'contact';	protected $_item = null;	/**	 * Model context string.	 *	 * @var		string	 */	protected $_context = 'com_contact.contact';	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState()	{		$app = JFactory::getApplication('site');		// Load state from the request.		$pk = $app->input->getInt('id');		$this->setState('contact.id', $pk);		// Load the parameters.		$params = $app->getParams();		$this->setState('params', $params);		$user = JFactory::getUser();		if ((!$user->authorise('core.edit.state', 'com_contact')) &&  (!$user->authorise('core.edit', 'com_contact'))){			$this->setState('filter.published', 1);			$this->setState('filter.archived', 2);		}	}	/**	 * Method to get the contact form.	 *	 * The base form is loaded from XML and then an event is fired	 *	 *	 * @param   array  $data		An optional array of data for the form to interrogate.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_contact.contact', 'contact', array('control' => 'jform', 'load_data' => true));		if (empty($form))		{			return false;		}		$id = $this->getState('contact.id');		$params = $this->getState('params');		$contact = $this->_item[$id];		$params->merge($contact->params);		if (!$params->get('show_email_copy', 0)){			$form->removeField('contact_email_copy');		}		return $form;	}	protected function loadFormData()	{		$data = (array) JFactory::getApplication()->getUserState('com_contact.contact.data', array());		$this->preprocessData('com_contact.contact', $data);		return $data;	}	/**	 * Gets a contact	 *	 * @param integer $pk  Id for the contact	 *	 * @return mixed Object or null	 */	public function &getItem($pk = null)	{		$pk = (!empty($pk)) ? $pk : (int) $this->getState('contact.id');		if ($this->_item === null)		{			$this->_item = array();		}		if (!isset($this->_item[$pk]))		{			try			{				$db = $this->getDbo();				$query = $db->getQuery(true);				//sqlsrv changes				$case_when = ' CASE WHEN ';				$case_when .= $query->charLength('a.alias', '!=', '0');				$case_when .= ' THEN ';				$a_id = $query->castAsChar('a.id');				$case_when .= $query->concatenate(array($a_id, 'a.alias'), ':');				$case_when .= ' ELSE ';				$case_when .= $a_id.' END as slug';				$case_when1 = ' CASE WHEN ';				$case_when1 .= $query->charLength('c.alias', '!=', '0');				$case_when1 .= ' THEN ';				$c_id = $query->castAsChar('c.id');				$case_when1 .= $query->concatenate(array($c_id, 'c.alias'), ':');				$case_when1 .= ' ELSE ';				$case_when1 .= $c_id.' END as catslug';				$query->select($this->getState('item.select', 'a.*') . ','.$case_when.','.$case_when1)					->from('#__contact_details AS a')				// Join on category table.					->select('c.title AS category_title, c.alias AS category_alias, c.access AS category_access')					->join('LEFT', '#__categories AS c on c.id = a.catid')				// Join over the categories to get parent category titles					->select('parent.title as parent_title, parent.id as parent_id, parent.path as parent_route, parent.alias as parent_alias')					->join('LEFT', '#__categories as parent ON parent.id = c.parent_id')					->where('a.id = ' . (int) $pk);				// Filter by start and end dates.				$nullDate = $db->quote($db->getNullDate());				$nowDate = $db->quote(JFactory::getDate()->toSql());				// Filter by published state.				$published = $this->getState('filter.published');				$archived = $this->getState('filter.archived');				if (is_numeric($published))				{					$query->where('(a.published = ' . (int) $published . ' OR a.published =' . (int) $archived . ')')						->where('(a.publish_up = ' . $nullDate . ' OR a.publish_up <= ' . $nowDate . ')')						->where('(a.publish_down = ' . $nullDate . ' OR a.publish_down >= ' . $nowDate . ')');				}				$db->setQuery($query);				$data = $db->loadObject();				if (empty($data))				{					JError::raiseError(404, JText::_('COM_CONTACT_ERROR_CONTACT_NOT_FOUND'));				}				// Check for published state if filter set.				if (((is_numeric($published)) || (is_numeric($archived))) && (($data->published != $published) && ($data->published != $archived)))				{					JError::raiseError(404, JText::_('COM_CONTACT_ERROR_CONTACT_NOT_FOUND'));				}				// Convert parameter fields to objects.				$registry = new JRegistry;				$registry->loadString($data->params);				$data->params = clone $this->getState('params');				$data->params->merge($registry);				$registry = new JRegistry;				$registry->loadString($data->metadata);				$data->metadata = $registry;				$data->tags = new JHelperTags;				$data->tags->getItemTags('com_contact.contact', $data->id);				// Compute access permissions.				if ($access = $this->getState('filter.access')) {					// If the access filter has been set, we already know this user can view.					$data->params->set('access-view', true);				}				else {					// If no access filter is set, the layout takes some responsibility for display of limited information.					$user = JFactory::getUser();					$groups = $user->getAuthorisedViewLevels();					if ($data->catid == 0 || $data->category_access === null)					{						$data->params->set('access-view', in_array($data->access, $groups));					}					else {						$data->params->set('access-view', in_array($data->access, $groups) && in_array($data->category_access, $groups));					}				}				$this->_item[$pk] = $data;			}			catch (Exception $e)			{				$this->setError($e);				$this->_item[$pk] = false;			}		}		if ($this->_item[$pk])		{			if ($extendedData = $this->getContactQuery($pk))			{				$this->_item[$pk]->articles = $extendedData->articles;				$this->_item[$pk]->profile = $extendedData->profile;			}		}		return $this->_item[$pk];	}	protected function getContactQuery($pk = null)	{		// TODO: Cache on the fingerprint of the arguments		$db		= $this->getDbo();		$user	= JFactory::getUser();		$pk = (!empty($pk)) ? $pk : (int) $this->getState('contact.id');		$query	= $db->getQuery(true);		if ($pk)		{			//sqlsrv changes			$case_when = ' CASE WHEN ';			$case_when .= $query->charLength('a.alias', '!=', '0');			$case_when .= ' THEN ';			$a_id = $query->castAsChar('a.id');			$case_when .= $query->concatenate(array($a_id, 'a.alias'), ':');			$case_when .= ' ELSE ';			$case_when .= $a_id.' END as slug';			$case_when1 = ' CASE WHEN ';			$case_when1 .= $query->charLength('cc.alias', '!=', '0');			$case_when1 .= ' THEN ';			$c_id = $query->castAsChar('cc.id');			$case_when1 .= $query->concatenate(array($c_id, 'cc.alias'), ':');			$case_when1 .= ' ELSE ';			$case_when1 .= $c_id.' END as catslug';			$query->select(				'a.*, cc.access as category_access, cc.title as category_name, '				. $case_when . ',' . $case_when1			)				->from('#__contact_details AS a')				->join('INNER', '#__categories AS cc on cc.id = a.catid')				->where('a.id = ' . (int) $pk);			$published = $this->getState('filter.published');			$archived = $this->getState('filter.archived');			if (is_numeric($published))			{				$query->where('a.published IN (1,2)')					->where('cc.published IN (1,2)');			}			$groups = implode(',', $user->getAuthorisedViewLevels());			$query->where('a.access IN ('.$groups.')');			try			{				$db->setQuery($query);				$result = $db->loadObject();				if (empty($result))				{					throw new Exception(JText::_('COM_CONTACT_ERROR_CONTACT_NOT_FOUND'), 404);				}			// If we are showing a contact list, then the contact parameters take priority			// So merge the contact parameters with the merged parameters				if ($this->getState('params')->get('show_contact_list'))				{					$registry = new JRegistry;					$registry->loadString($result->params);					$this->getState('params')->merge($registry);				}			}			catch (Exception $e)			{				$this->setError($e);				return false;			}			if ($result)			{				$user	= JFactory::getUser();				$groups	= implode(',', $user->getAuthorisedViewLevels());				//get the content by the linked user				$query	= $db->getQuery(true)					->select('a.id')					->select('a.title')					->select('a.state')					->select('a.access')					->select('a.created');				// SQL Server changes				$case_when = ' CASE WHEN ';				$case_when .= $query->charLength('a.alias', '!=', '0');				$case_when .= ' THEN ';				$a_id = $query->castAsChar('a.id');				$case_when .= $query->concatenate(array($a_id, 'a.alias'), ':');				$case_when .= ' ELSE ';				$case_when .= $a_id.' END as slug';				$case_when1 = ' CASE WHEN ';				$case_when1 .= $query->charLength('c.alias', '!=', '0');				$case_when1 .= ' THEN ';				$c_id = $query->castAsChar('c.id');				$case_when1 .= $query->concatenate(array($c_id, 'c.alias'), ':');				$case_when1 .= ' ELSE ';				$case_when1 .= $c_id.' END as catslug';				$query->select($case_when1 . ',' . $case_when)					->from('#__content as a')					->join('LEFT', '#__categories as c on a.catid=c.id')					->where('a.created_by = ' . (int) $result->user_id)					->where('a.access IN ('. $groups.')')					->order('a.state DESC, a.created DESC');				// filter per language if plugin published				if (JLanguageMultilang::isEnabled())				{					$query->where(('a.created_by = ' . (int) $result->user_id) AND ('a.language=' . $db->quote(JFactory::getLanguage()->getTag()) . ' OR a.language=' . $db->quote('*')));				}				if (is_numeric($published))				{					$query->where('a.state IN (1,2)');				}				$db->setQuery($query, 0, 10);				$articles = $db->loadObjectList();				$result->articles = $articles;				//get the profile information for the linked user				require_once JPATH_ADMINISTRATOR.'/components/com_users/models/user.php';				$userModel = JModelLegacy::getInstance('User', 'UsersModel', array('ignore_request' => true));				$data = $userModel->getItem((int) $result->user_id);				JPluginHelper::importPlugin('user');				$form = new JForm('com_users.profile');				// Get the dispatcher.				$dispatcher	= JEventDispatcher::getInstance();				// Trigger the form preparation event.				$dispatcher->trigger('onContentPrepareForm', array($form, $data));				// Trigger the data preparation event.				$dispatcher->trigger('onContentPrepareData', array('com_users.profile', $data));				// Load the data into the form after the plugins have operated.				$form->bind($data);				$result->profile = $form;				$this->contact = $result;				return $result;			}		}	}	/**	 * Increment the hit counter for the contact.	 *	 * @param   int  $pk  Optional primary key of the article to increment.	 *	 * @return  boolean  True if successful; false otherwise and internal error set.	 *	 * @since   3.0	 */	public function hit($pk = 0)	{		$input = JFactory::getApplication()->input;		$hitcount = $input->getInt('hitcount', 1);		if ($hitcount)		{			$pk = (!empty($pk)) ? $pk : (int) $this->getState('contact.id');			$db = $this->getDbo();			$db->setQuery(				'UPDATE #__contact_details' .				' SET hits = hits + 1' .				' WHERE id = '.(int) $pk			);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				$this->setError($e->getMessage());				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Extension Manager Install Model * * @package     Joomla.Administrator * @subpackage  com_installer * @since       1.5 */class InstallerModelInstall extends JModelLegacy{	/**	 * @var object JTable object	 */	protected $_table = null;	/**	 * @var object JTable object	 */	protected $_url = null;	/**	 * Model context string.	 *	 * @var		string	 */	protected $_context = 'com_installer.install';	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState()	{		$app = JFactory::getApplication('administrator');		$this->setState('message', $app->getUserState('com_installer.message'));		$this->setState('extension_message', $app->getUserState('com_installer.extension_message'));		$app->setUserState('com_installer.message', '');		$app->setUserState('com_installer.extension_message', '');		// Recall the 'Install from Directory' path.		$path = $app->getUserStateFromRequest($this->_context . '.install_directory', 'install_directory', $app->getCfg('tmp_path'));		$this->setState('install.directory', $path);		parent::populateState();	}	/**	 * Install an extension from either folder, url or upload.	 *	 * @return  boolean result of install	 *	 * @since   1.5	 */	public function install()	{		$this->setState('action', 'install');		// Set FTP credentials, if given.		JClientHelper::setCredentialsFromRequest('ftp');		$app = JFactory::getApplication();		switch ($app->input->getWord('installtype'))		{			case 'folder':				// Remember the 'Install from Directory' path.				$app->getUserStateFromRequest($this->_context . '.install_directory', 'install_directory');				$package = $this->_getPackageFromFolder();				break;			case 'upload':				$package = $this->_getPackageFromUpload();				break;			case 'url':				$package = $this->_getPackageFromUrl();				break;			default:				$app->setUserState('com_installer.message', JText::_('COM_INSTALLER_NO_INSTALL_TYPE_FOUND'));				return false;				break;		}		// Was the package unpacked?		if (!$package)		{			$app->setUserState('com_installer.message', JText::_('COM_INSTALLER_UNABLE_TO_FIND_INSTALL_PACKAGE'));			return false;		}		// Get an installer instance		$installer = JInstaller::getInstance();		// Install the package		if (!$installer->install($package['dir']))		{			// There was an error installing the package			$msg = JText::sprintf('COM_INSTALLER_INSTALL_ERROR', JText::_('COM_INSTALLER_TYPE_TYPE_' . strtoupper($package['type'])));			$result = false;		}		else		{			// Package installed sucessfully			$msg = JText::sprintf('COM_INSTALLER_INSTALL_SUCCESS', JText::_('COM_INSTALLER_TYPE_TYPE_' . strtoupper($package['type'])));			$result = true;		}		// Set some model state values		$app	= JFactory::getApplication();		$app->enqueueMessage($msg);		$this->setState('name', $installer->get('name'));		$this->setState('result', $result);		$app->setUserState('com_installer.message', $installer->message);		$app->setUserState('com_installer.extension_message', $installer->get('extension_message'));		$app->setUserState('com_installer.redirect_url', $installer->get('redirect_url'));		// Cleanup the install files		if (!is_file($package['packagefile']))		{			$config = JFactory::getConfig();			$package['packagefile'] = $config->get('tmp_path') . '/' . $package['packagefile'];		}		JInstallerHelper::cleanupInstall($package['packagefile'], $package['extractdir']);		return $result;	}	/**	 * Works out an installation package from a HTTP upload	 *	 * @return package definition or false on failure	 */	protected function _getPackageFromUpload()	{		// Get the uploaded file information		$userfile = JRequest::getVar('install_package', null, 'files', 'array');		// Make sure that file uploads are enabled in php		if (!(bool) ini_get('file_uploads'))		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_WARNINSTALLFILE'));			return false;		}		// Make sure that zlib is loaded so that the package can be unpacked		if (!extension_loaded('zlib'))		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_WARNINSTALLZLIB'));			return false;		}		// If there is no uploaded file, we have a problem...		if (!is_array($userfile))		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_NO_FILE_SELECTED'));			return false;		}		// Check if there was a problem uploading the file.		if ($userfile['error'] || $userfile['size'] < 1)		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_WARNINSTALLUPLOADERROR'));			return false;		}		// Build the appropriate paths		$config		= JFactory::getConfig();		$tmp_dest	= $config->get('tmp_path') . '/' . $userfile['name'];		$tmp_src	= $userfile['tmp_name'];		// Move uploaded file		jimport('joomla.filesystem.file');		$uploaded = JFile::upload($tmp_src, $tmp_dest);		// Unpack the downloaded package file		$package = JInstallerHelper::unpack($tmp_dest);		return $package;	}	/**	 * Install an extension from a directory	 *	 * @return  array  Package details or false on failure	 *	 * @since   1.5	 */	protected function _getPackageFromFolder()	{		$input = JFactory::getApplication()->input;		// Get the path to the package to install		$p_dir = $input->getString('install_directory');		$p_dir = JPath::clean($p_dir);		// Did you give us a valid directory?		if (!is_dir($p_dir))		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_PLEASE_ENTER_A_PACKAGE_DIRECTORY'));			return false;		}		// Detect the package type		$type = JInstallerHelper::detectType($p_dir);		// Did you give us a valid package?		if (!$type)		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_PATH_DOES_NOT_HAVE_A_VALID_PACKAGE'));			return false;		}		$package['packagefile'] = null;		$package['extractdir'] = null;		$package['dir'] = $p_dir;		$package['type'] = $type;		return $package;	}	/**	 * Install an extension from a URL	 *	 * @return  Package details or false on failure	 *	 * @since   1.5	 */	protected function _getPackageFromUrl()	{		$input = JFactory::getApplication()->input;		// Get the URL of the package to install		$url = $input->getString('install_url');		// Did you give us a URL?		if (!$url)		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_ENTER_A_URL'));			return false;		}		// Download the package at the URL given		$p_file = JInstallerHelper::downloadPackage($url);		// Was the package downloaded?		if (!$p_file)		{			JError::raiseWarning('', JText::_('COM_INSTALLER_MSG_INSTALL_INVALID_URL'));			return false;		}		$config   = JFactory::getConfig();		$tmp_dest = $config->get('tmp_path');		// Unpack the downloaded package file		$package = JInstallerHelper::unpack($tmp_dest . '/' . $p_file);		return $package;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * The Menu Item Controller * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class MenusControllerItem extends JControllerForm{	/**	 * Method to add a new menu item.	 *	 * @return  mixed  True if the record can be added, a JError object if not.	 *	 * @since   1.6	 */	public function add()	{		$app = JFactory::getApplication();		$context = 'com_menus.edit.item';		$result = parent::add();		if ($result)		{			$app->setUserState($context . '.type', null);			$app->setUserState($context . '.link', null);			$menuType = $app->getUserStateFromRequest($this->context . '.filter.menutype', 'menutype', 'mainmenu', 'cmd');			$this->setRedirect(JRoute::_('index.php?option=com_menus&view=item&menutype=' . $menuType . $this->getRedirectToItemAppend(), false));		}		return $result;	}	/**	 * Method to run batch operations.	 *	 * @param   object  $model  The model.	 *	 * @return  boolean	 True if successful, false otherwise and internal error is set.	 *	 * @since   1.6	 */	public function batch($model = null)	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$model = $this->getModel('Item', '', array());		// Preset the redirect		$this->setRedirect(JRoute::_('index.php?option=com_menus&view=items' . $this->getRedirectToListAppend(), false));		return parent::batch($model);	}	/**	 * Method to cancel an edit.	 *	 * @param   string  $key  The name of the primary key of the URL variable.	 *	 * @return  boolean  True if access level checks pass, false otherwise.	 *	 * @since   1.6	 */	public function cancel($key = null)	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$app = JFactory::getApplication();		$context = 'com_menus.edit.item';		$result = parent::cancel();		if ($result)		{			// Clear the ancillary data from the session.			$app->setUserState($context . '.type', null);			$app->setUserState($context . '.link', null);		}	}	/**	 * Method to edit an existing record.	 *	 * @param   string  $key     The name of the primary key of the URL variable.	 * @param   string  $urlVar  The name of the URL variable if different from the primary key	 * (sometimes required to avoid router collisions).	 *	 * @return  boolean  True if access level check and checkout passes, false otherwise.	 *	 * @since   1.6	 */	public function edit($key = null, $urlVar = null)	{		$app = JFactory::getApplication();		$result = parent::edit();		if ($result)		{			// Push the new ancillary data into the session.			$app->setUserState('com_menus.edit.item.type', null);			$app->setUserState('com_menus.edit.item.link', null);		}		return true;	}	/**	 * Method to save a record.	 *	 * @param   string  $key     The name of the primary key of the URL variable.	 * @param   string  $urlVar  The name of the URL variable if different from the primary key (sometimes required to avoid router collisions).	 *	 * @return  boolean  True if successful, false otherwise.	 *	 * @since   1.6	 */	public function save($key = null, $urlVar = null)	{		// Check for request forgeries.		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$app      = JFactory::getApplication();		$model    = $this->getModel('Item', '', array());		$data     = $this->input->post->get('jform', array(), 'array');		$task     = $this->getTask();		$context  = 'com_menus.edit.item';		$recordId = $this->input->getInt('id');		if (!$this->checkEditId($context, $recordId))		{			// Somehow the person just went to the form and saved it - we don't allow that.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_UNHELD_ID', $recordId));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(JRoute::_('index.php?option=com_menus&view=items' . $this->getRedirectToListAppend(), false));			return false;		}		// Populate the row id from the session.		$data['id'] = $recordId;		// The save2copy task needs to be handled slightly differently.		if ($task == 'save2copy')		{			// Check-in the original row.			if ($model->checkin($data['id']) === false)			{				// Check-in failed, go back to the item and display a notice.				$this->setMessage(JText::sprintf('JLIB_APPLICATION_ERROR_CHECKIN_FAILED', $model->getError()), 'warning');				return false;			}			// Reset the ID and then treat the request as for Apply.			$data['id'] = 0;			$data['associations'] = array();			$task = 'apply';		}		// Validate the posted data.		// This post is made up of two forms, one for the item and one for params.		$form = $model->getForm($data);		if (!$form)		{			JError::raiseError(500, $model->getError());			return false;		}		$data = $model->validate($form, $data);		// Check for the special 'request' entry.		if ($data['type'] == 'component' && isset($data['request']) && is_array($data['request']) && !empty($data['request']))		{			// Parse the submitted link arguments.			$args = array();			parse_str(parse_url($data['link'], PHP_URL_QUERY), $args);			// Merge in the user supplied request arguments.			$args = array_merge($args, $data['request']);			$data['link'] = 'index.php?' . urldecode(http_build_query($args, '', '&'));			unset($data['request']);		}		// Check for validation errors.		if ($data === false)		{			// Get the validation messages.			$errors = $model->getErrors();			// Push up to three validation messages out to the user.			for ($i = 0, $n = count($errors); $i < $n && $i < 3; $i++)			{				if ($errors[$i] instanceof Exception)				{					$app->enqueueMessage($errors[$i]->getMessage(), 'warning');				}				else				{					$app->enqueueMessage($errors[$i], 'warning');				}			}			// Save the data in the session.			$app->setUserState('com_menus.edit.item.data', $data);			// Redirect back to the edit screen.			$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_item . $this->getRedirectToItemAppend($recordId), false));			return false;		}		// Attempt to save the data.		if (!$model->save($data))		{			// Save the data in the session.			$app->setUserState('com_menus.edit.item.data', $data);			// Redirect back to the edit screen.			$this->setMessage(JText::sprintf('JLIB_APPLICATION_ERROR_SAVE_FAILED', $model->getError()), 'warning');			$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_item . $this->getRedirectToItemAppend($recordId), false));			return false;		}		// Save succeeded, check-in the row.		if ($model->checkin($data['id']) === false)		{			// Check-in failed, go back to the row and display a notice.			$this->setMessage(JText::sprintf('JLIB_APPLICATION_ERROR_CHECKIN_FAILED', $model->getError()), 'warning');			$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_item . $this->getRedirectToItemAppend($recordId), false));			return false;		}		$this->setMessage(JText::_('COM_MENUS_SAVE_SUCCESS'));		// Redirect the user and adjust session state based on the chosen task.		switch ($task)		{			case 'apply':				// Set the row data in the session.				$recordId = $model->getState($this->context . '.id');				$this->holdEditId($context, $recordId);				$app->setUserState('com_menus.edit.item.data', null);				$app->setUserState('com_menus.edit.item.type', null);				$app->setUserState('com_menus.edit.item.link', null);				// Redirect back to the edit screen.				$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_item . $this->getRedirectToItemAppend($recordId), false));				break;			case 'save2new':				// Clear the row id and data in the session.				$this->releaseEditId($context, $recordId);				$app->setUserState('com_menus.edit.item.data', null);				$app->setUserState('com_menus.edit.item.type', null);				$app->setUserState('com_menus.edit.item.link', null);				$app->setUserState('com_menus.edit.item.menutype', $model->getState('item.menutype'));				// Redirect back to the edit screen.				$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_item . $this->getRedirectToItemAppend(), false));				break;			default:				// Clear the row id and data in the session.				$this->releaseEditId($context, $recordId);				$app->setUserState('com_menus.edit.item.data', null);				$app->setUserState('com_menus.edit.item.type', null);				$app->setUserState('com_menus.edit.item.link', null);				// Redirect to the list screen.				$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_list . $this->getRedirectToListAppend(), false));				break;		}	}	/**	 * Sets the type of the menu item currently being edited.	 *	 * @return  void	 *	 * @since   1.6	 */	public function setType()	{		$app = JFactory::getApplication();		// Get the posted values from the request.		$data = $this->input->post->get('jform', array(), 'array');		$recordId = $this->input->getInt('id');		// Get the type.		$type = $data['type'];		$type = json_decode(base64_decode($type));		$title = isset($type->title) ? $type->title : null;		$recordId = isset($type->id) ? $type->id : 0;		$specialTypes = array('alias', 'separator', 'url', 'heading');		if (!in_array($title, $specialTypes))		{			$title = 'component';		}		$app->setUserState('com_menus.edit.item.type', $title);		if ($title == 'component')		{			if (isset($type->request))			{				$component = JComponentHelper::getComponent($type->request->option);				$data['component_id'] = $component->id;				$app->setUserState('com_menus.edit.item.link', 'index.php?' . JURI::buildQuery((array) $type->request));			}		}		// If the type is alias you just need the item id from the menu item referenced.		elseif ($title == 'alias')		{			$app->setUserState('com_menus.edit.item.link', 'index.php?Itemid=');		}		unset($data['request']);		$data['type'] = $title;		if ($this->input->get('fieldtype') == 'type')		{			$data['link'] = $app->getUserState('com_menus.edit.item.link');		}		//Save the data in the session.		$app->setUserState('com_menus.edit.item.data', $data);		$this->type = $type;		$this->setRedirect(JRoute::_('index.php?option=' . $this->option . '&view=' . $this->view_item . $this->getRedirectToItemAppend($recordId), false));	}}
<?php/** * @package     Joomla.Platform * @subpackage  Document * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.environment.response');/** * Document class, provides an easy interface to parse and display a document * * @package     Joomla.Platform * @subpackage  Document * @since       11.1 */class JDocument{	/**	 * Document title	 *	 * @var    string	 * @since  11.1	 */	public $title = '';	/**	 * Document description	 *	 * @var    string	 * @since  11.1	 */	public $description = '';	/**	 * Document full URL	 *	 * @var    string	 * @since  11.1	 */	public $link = '';	/**	 * Document base URL	 *	 * @var    string	 * @since  11.1	 */	public $base = '';	/**	 * Contains the document language setting	 *	 * @var    string	 * @since  11.1	 */	public $language = 'en-gb';	/**	 * Contains the document direction setting	 *	 * @var    string	 * @since  11.1	 */	public $direction = 'ltr';	/**	 * Document generator	 *	 * @var    string	 */	public $_generator = 'Joomla! - Open Source Content Management';	/**	 * Document modified date	 *	 * @var    string	 * @since  11.1	 */	public $_mdate = '';	/**	 * Tab string	 *	 * @var    string	 * @since  11.1	 */	public $_tab = "\11";	/**	 * Contains the line end string	 *	 * @var    string	 * @since  11.1	 */	public $_lineEnd = "\12";	/**	 * Contains the character encoding string	 *	 * @var    string	 * @since  11.1	 */	public $_charset = 'utf-8';	/**	 * Document mime type	 *	 * @var    string	 * @since  11.1	 */	public $_mime = '';	/**	 * Document namespace	 *	 * @var    string	 * @since  11.1	 */	public $_namespace = '';	/**	 * Document profile	 *	 * @var    string	 * @since  11.1	 */	public $_profile = '';	/**	 * Array of linked scripts	 *	 * @var    array	 * @since  11.1	 */	public $_scripts = array();	/**	 * Array of scripts placed in the header	 *	 * @var    array	 * @since  11.1	 */	public $_script = array();	/**	 * Array of linked style sheets	 *	 * @var    array	 * @since  11.1	 */	public $_styleSheets = array();	/**	 * Array of included style declarations	 *	 * @var    array	 * @since  11.1	 */	public $_style = array();	/**	 * Array of meta tags	 *	 * @var    array	 * @since  11.1	 */	public $_metaTags = array();	/**	 * The rendering engine	 *	 * @var    object	 * @since  11.1	 */	public $_engine = null;	/**	 * The document type	 *	 * @var    string	 * @since  11.1	 */	public $_type = null;	/**	 * Array of buffered output	 *	 * @var    mixed (depends on the renderer)	 * @since  11.1	 */	public static $_buffer = null;	/**	 * @var    array  JDocument instances container.	 * @since  11.3	 */	protected static $instances = array();	/**	 * Class constructor.	 *	 * @param   array  $options  Associative array of options	 *	 * @since   11.1	 */	public function __construct($options = array())	{		if (array_key_exists('lineend', $options))		{			$this->setLineEnd($options['lineend']);		}		if (array_key_exists('charset', $options))		{			$this->setCharset($options['charset']);		}		if (array_key_exists('language', $options))		{			$this->setLanguage($options['language']);		}		if (array_key_exists('direction', $options))		{			$this->setDirection($options['direction']);		}		if (array_key_exists('tab', $options))		{			$this->setTab($options['tab']);		}		if (array_key_exists('link', $options))		{			$this->setLink($options['link']);		}		if (array_key_exists('base', $options))		{			$this->setBase($options['base']);		}	}	/**	 * Returns the global JDocument object, only creating it	 * if it doesn't already exist.	 *	 * @param   string  $type        The document type to instantiate	 * @param   array   $attributes  Array of attributes	 *	 * @return  object  The document object.	 *	 * @since   11.1	 * @throws  RuntimeException	 */	public static function getInstance($type = 'html', $attributes = array())	{		$signature = serialize(array($type, $attributes));		if (empty(self::$instances[$signature]))		{			$type = preg_replace('/[^A-Z0-9_\.-]/i', '', $type);			$path = __DIR__ . '/' . $type . '/' . $type . '.php';			$ntype = null;			// Check if the document type exists			if (!file_exists($path))			{				// Default to the raw format				$ntype = $type;				$type = 'raw';			}			// Determine the path and class			$class = 'JDocument' . $type;			if (!class_exists($class))			{				$path = __DIR__ . '/' . $type . '/' . $type . '.php';				if (file_exists($path))				{					require_once $path;				}				else				{					throw new RuntimeException('Invalid JDocument Class', 500);				}			}			$instance = new $class($attributes);			self::$instances[$signature] = $instance;			if (!is_null($ntype))			{				// Set the type to the Document type originally requested				$instance->setType($ntype);			}		}		return self::$instances[$signature];	}	/**	 * Set the document type	 *	 * @param   string  $type  Type document is to set to	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setType($type)	{		$this->_type = $type;		return $this;	}	/**	 * Returns the document type	 *	 * @return  string	 *	 * @since   11.1	 */	public function getType()	{		return $this->_type;	}	/**	 * Get the contents of the document buffer	 *	 * @return  The contents of the document buffer	 *	 * @since   11.1	 */	public function getBuffer()	{		return self::$_buffer;	}	/**	 * Set the contents of the document buffer	 *	 * @param   string  $content  The content to be set in the buffer.	 * @param   array   $options  Array of optional elements.	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setBuffer($content, $options = array())	{		self::$_buffer = $content;		return $this;	}	/**	 * Gets a meta tag.	 *	 * @param   string   $name       Value of name or http-equiv tag	 * @param   boolean  $httpEquiv  META type "http-equiv" defaults to null	 *	 * @return  string	 *	 * @since   11.1	 */	public function getMetaData($name, $httpEquiv = false)	{		$result = '';		$name = strtolower($name);		if ($name == 'generator')		{			$result = $this->getGenerator();		}		elseif ($name == 'description')		{			$result = $this->getDescription();		}		else		{			if ($httpEquiv == true)			{				$result = @$this->_metaTags['http-equiv'][$name];			}			else			{				$result = @$this->_metaTags['standard'][$name];			}		}		return $result;	}	/**	 * Sets or alters a meta tag.	 *	 * @param   string   $name        Value of name or http-equiv tag	 * @param   string   $content     Value of the content tag	 * @param   boolean  $http_equiv  META type "http-equiv" defaults to null	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setMetaData($name, $content, $http_equiv = false)	{		$name = strtolower($name);		if ($name == 'generator')		{			$this->setGenerator($content);		}		elseif ($name == 'description')		{			$this->setDescription($content);		}		else		{			if ($http_equiv == true)			{				$this->_metaTags['http-equiv'][$name] = $content;			}			else			{				$this->_metaTags['standard'][$name] = $content;			}		}		return $this;	}	/**	 * Adds a linked script to the page	 *	 * @param   string   $url    URL to the linked script	 * @param   string   $type   Type of script. Defaults to 'text/javascript'	 * @param   boolean  $defer  Adds the defer attribute.	 * @param   boolean  $async  Adds the async attribute.	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function addScript($url, $type = "text/javascript", $defer = false, $async = false)	{		$this->_scripts[$url]['mime'] = $type;		$this->_scripts[$url]['defer'] = $defer;		$this->_scripts[$url]['async'] = $async;		return $this;	}	/**	 * Adds a script to the page	 *	 * @param   string  $content  Script	 * @param   string  $type     Scripting mime (defaults to 'text/javascript')	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function addScriptDeclaration($content, $type = 'text/javascript')	{		if (!isset($this->_script[strtolower($type)]))		{			$this->_script[strtolower($type)] = $content;		}		else		{			$this->_script[strtolower($type)] .= chr(13) . $content;		}		return $this;	}	/**	 * Adds a linked stylesheet to the page	 *	 * @param   string  $url      URL to the linked style sheet	 * @param   string  $type     Mime encoding type	 * @param   string  $media    Media type that this stylesheet applies to	 * @param   array   $attribs  Array of attributes	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function addStyleSheet($url, $type = 'text/css', $media = null, $attribs = array())	{		$this->_styleSheets[$url]['mime'] = $type;		$this->_styleSheets[$url]['media'] = $media;		$this->_styleSheets[$url]['attribs'] = $attribs;		return $this;	}	/**	 * Adds a stylesheet declaration to the page	 *	 * @param   string  $content  Style declarations	 * @param   string  $type     Type of stylesheet (defaults to 'text/css')	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function addStyleDeclaration($content, $type = 'text/css')	{		if (!isset($this->_style[strtolower($type)]))		{			$this->_style[strtolower($type)] = $content;		}		else		{			$this->_style[strtolower($type)] .= chr(13) . $content;		}		return $this;	}	/**	 * Sets the document charset	 *	 * @param   string  $type  Charset encoding string	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setCharset($type = 'utf-8')	{		$this->_charset = $type;		return $this;	}	/**	 * Returns the document charset encoding.	 *	 * @return  string	 *	 * @since   11.1	 */	public function getCharset()	{		return $this->_charset;	}	/**	 * Sets the global document language declaration. Default is English (en-gb).	 *	 * @param   string  $lang  The language to be set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setLanguage($lang = "en-gb")	{		$this->language = strtolower($lang);		return $this;	}	/**	 * Returns the document language.	 *	 * @return  string	 *	 * @since   11.1	 */	public function getLanguage()	{		return $this->language;	}	/**	 * Sets the global document direction declaration. Default is left-to-right (ltr).	 *	 * @param   string  $dir  The language direction to be set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setDirection($dir = "ltr")	{		$this->direction = strtolower($dir);		return $this;	}	/**	 * Returns the document direction declaration.	 *	 * @return  string	 *	 * @since   11.1	 */	public function getDirection()	{		return $this->direction;	}	/**	 * Sets the title of the document	 *	 * @param   string  $title  The title to be set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setTitle($title)	{		$this->title = $title;		return $this;	}	/**	 * Return the title of the document.	 *	 * @return  string	 *	 * @since   11.1	 */	public function getTitle()	{		return $this->title;	}	/**	 * Sets the base URI of the document	 *	 * @param   string  $base  The base URI to be set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setBase($base)	{		$this->base = $base;		return $this;	}	/**	 * Return the base URI of the document.	 *	 * @return  string	 *	 * @since   11.1	 */	public function getBase()	{		return $this->base;	}	/**	 * Sets the description of the document	 *	 * @param   string  $description  The description to set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setDescription($description)	{		$this->description = $description;		return $this;	}	/**	 * Return the title of the page.	 *	 * @return  string	 *	 * @since    11.1	 */	public function getDescription()	{		return $this->description;	}	/**	 * Sets the document link	 *	 * @param   string  $url  A url	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setLink($url)	{		$this->link = $url;		return $this;	}	/**	 * Returns the document base url	 *	 * @return string	 *	 * @since   11.1	 */	public function getLink()	{		return $this->link;	}	/**	 * Sets the document generator	 *	 * @param   string  $generator  The generator to be set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setGenerator($generator)	{		$this->_generator = $generator;		return $this;	}	/**	 * Returns the document generator	 *	 * @return  string	 *	 * @since   11.1	 */	public function getGenerator()	{		return $this->_generator;	}	/**	 * Sets the document modified date	 *	 * @param   string  $date  The date to be set	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setModifiedDate($date)	{		$this->_mdate = $date;		return $this;	}	/**	 * Returns the document modified date	 *	 * @return  string	 *	 * @since   11.1	 */	public function getModifiedDate()	{		return $this->_mdate;	}	/**	 * Sets the document MIME encoding that is sent to the browser.	 *	 * This usually will be text/html because most browsers cannot yet	 * accept the proper mime settings for XHTML: application/xhtml+xml	 * and to a lesser extent application/xml and text/xml. See the W3C note	 * ({@link http://www.w3.org/TR/xhtml-media-types/	 * http://www.w3.org/TR/xhtml-media-types/}) for more details.	 *	 * @param   string   $type  The document type to be sent	 * @param   boolean  $sync  Should the type be synced with HTML?	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 *	 * @link    http://www.w3.org/TR/xhtml-media-types	 */	public function setMimeEncoding($type = 'text/html', $sync = true)	{		$this->_mime = strtolower($type);		// Syncing with meta-data		if ($sync)		{			$this->setMetaData('content-type', $type . '; charset=' . $this->_charset, true);		}		return $this;	}	/**	 * Return the document MIME encoding that is sent to the browser.	 *	 * @return  string	 *	 * @since   11.1	 */	public function getMimeEncoding()	{		return $this->_mime;	}	/**	 * Sets the line end style to Windows, Mac, Unix or a custom string.	 *	 * @param   string  $style  "win", "mac", "unix" or custom string.	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setLineEnd($style)	{		switch ($style)		{			case 'win':				$this->_lineEnd = "\15\12";				break;			case 'unix':				$this->_lineEnd = "\12";				break;			case 'mac':				$this->_lineEnd = "\15";				break;			default:				$this->_lineEnd = $style;		}		return $this;	}	/**	 * Returns the lineEnd	 *	 * @return  string	 *	 * @since   11.1	 */	public function _getLineEnd()	{		return $this->_lineEnd;	}	/**	 * Sets the string used to indent HTML	 *	 * @param   string  $string  String used to indent ("\11", "\t", '  ', etc.).	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setTab($string)	{		$this->_tab = $string;		return $this;	}	/**	 * Returns a string containing the unit for indenting HTML	 *	 * @return  string	 *	 * @since   11.1	 */	public function _getTab()	{		return $this->_tab;	}	/**	 * Load a renderer	 *	 * @param   string  $type  The renderer type	 *	 * @return  JDocumentRenderer  Object or null if class does not exist	 *	 * @since   11.1	 * @throws  RuntimeException	 */	public function loadRenderer($type)	{		$class = 'JDocumentRenderer' . $type;		if (!class_exists($class))		{			$path = __DIR__ . '/' . $this->_type . '/renderer/' . $type . '.php';			if (file_exists($path))			{				require_once $path;			}			else			{				throw new RuntimeException('Unable to load renderer class', 500);			}		}		if (!class_exists($class))		{			return null;		}		$instance = new $class($this);		return $instance;	}	/**	 * Parses the document and prepares the buffers	 *	 * @param   array  $params  The array of parameters	 *	 * @return  JDocument instance of $this to allow chaining	 *	 * @since   11.1	 */	public function parse($params = array())	{		return $this;	}	/**	 * Outputs the document	 *	 * @param   boolean  $cache   If true, cache the output	 * @param   array    $params  Associative array of attributes	 *	 * @return  The rendered data	 *	 * @since   11.1	 */	public function render($cache = false, $params = array())	{		if ($mdate = $this->getModifiedDate())		{			JResponse::setHeader('Last-Modified', $mdate /* gmdate('D, d M Y H:i:s', time() + 900) . ' GMT' */);		}		JResponse::setHeader('Content-Type', $this->_mime . ($this->_charset ? '; charset=' . $this->_charset : ''));	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Index controller class for Finder. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderControllerIndex extends JControllerAdmin{	/**	 * Method to get a model object, loading it if required.	 *	 * @param   string  $name    The model name. Optional.	 * @param   string  $prefix  The class prefix. Optional.	 * @param   array   $config  Configuration array for model. Optional.	 *	 * @return  object  The model.	 *	 * @since   2.5	 */	public function getModel($name = 'Index', $prefix = 'FinderModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}	/**	 * Method to purge all indexed links from the database.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	public function purge()	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		// Remove the script time limit.		@set_time_limit(0);		$model = $this->getModel('Index', 'FinderModel');		// Attempt to purge the index.		$return = $model->purge();		if (!$return)		{			$message = JText::_('COM_FINDER_INDEX_PURGE_FAILED', $model->getError());			$this->setRedirect('index.php?option=com_finder&view=index', $message);			return false;		}		else		{			$message = JText::_('COM_FINDER_INDEX_PURGE_SUCCESS');			$this->setRedirect('index.php?option=com_finder&view=index', $message);			return true;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * View to edit a module. * * @package     Joomla.Administrator * @subpackage  com_modules * @since       1.6 */class ModulesViewModule extends JViewLegacy{	protected $form;	protected $item;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$this->form		= $this->get('Form');		$this->item		= $this->get('Item');		$this->state	= $this->get('State');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		$this->addToolbar();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		JFactory::getApplication()->input->set('hidemainmenu', true);		$user		= JFactory::getUser();		$isNew		= ($this->item->id == 0);		$checkedOut	= !($this->item->checked_out == 0 || $this->item->checked_out == $user->get('id'));		$canDo		= ModulesHelper::getActions($this->state->get('filter.category_id'), $this->item->id);		$item		= $this->get('Item');		JToolbarHelper::title(JText::sprintf('COM_MODULES_MANAGER_MODULE', JText::_($this->item->module)), 'module.png');		// If not checked out, can save the item.		if (!$checkedOut && ($canDo->get('core.edit') || $canDo->get('core.create') ))		{			JToolbarHelper::apply('module.apply');			JToolbarHelper::save('module.save');		}		if (!$checkedOut && $canDo->get('core.create'))		{			JToolbarHelper::save2new('module.save2new');		}			// If an existing item, can save to a copy.		if (!$isNew && $canDo->get('core.create'))		{			JToolbarHelper::save2copy('module.save2copy');		}		if (empty($this->item->id))		{			JToolbarHelper::cancel('module.cancel');		}		else		{			JToolbarHelper::cancel('module.cancel', 'JTOOLBAR_CLOSE');		}		// Get the help information for the menu item.		$lang = JFactory::getLanguage();		$help = $this->get('Help');		if ($lang->hasKey($help->url))		{			$debug = $lang->setDebug(false);			$url = JText::_($help->url);			$lang->setDebug($debug);		}		else		{			$url = null;		}		JToolbarHelper::help($help->key, false, $url);	}}
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT . '/helpers');$params = $this->params;?><div id="archive-items">	<?php foreach ($this->items as $i => $item) : ?>		<?php $info = $item->params->get('info_block_position', 0); ?>		<div class="row<?php echo $i % 2; ?>">			<div class="page-header">				<h2>					<?php if ($params->get('link_titles')) : ?>						<a href="<?php echo JRoute::_(ContentHelperRoute::getArticleRoute($item->slug, $item->catslug)); ?>"> <?php echo $this->escape($item->title); ?></a>					<?php else: ?>						<?php echo $this->escape($item->title); ?>					<?php endif; ?>				</h2>				<?php if ($params->get('show_author') && !empty($item->author )) : ?>					<small class="createdby">					<?php $author = $item->author; ?>					<?php $author = ($item->created_by_alias ? $item->created_by_alias : $author); ?>						<?php if (!empty($item->contactid ) && $params->get('link_author') == true) : ?>							<?php echo JText::sprintf(							'COM_CONTENT_WRITTEN_BY',							JHtml::_('link', JRoute::_('index.php?option=com_contact&view=contact&id='.$item->contactid), $author)							); ?>						<?php else :?>							<?php echo JText::sprintf('COM_CONTENT_WRITTEN_BY', $author); ?>						<?php endif; ?>					</small>				<?php endif; ?>			</div>		<?php $useDefList = ($params->get('show_modify_date') || $params->get('show_publish_date') || $params->get('show_create_date')			|| $params->get('show_hits') || $params->get('show_category') || $params->get('show_parent_category')); ?>		<?php if ($useDefList && ($info == 0 || $info == 2)) : ?>			<div class="article-info muted">				<dl class="article-info">				<dt class="article-info-term">					<?php echo JText::_('COM_CONTENT_ARTICLE_INFO'); ?>				</dt>				<?php if ($params->get('show_parent_category') && !empty($item->parent_slug)) : ?>					<dd>						<div class="parent-category-name">							<?php	$title = $this->escape($item->parent_title);							$url = '<a href="' . JRoute::_(ContentHelperRoute::getCategoryRoute($item->parent_slug)).'">' . $title . '</a>'; ?>							<?php if ($params->get('link_parent_category') && !empty($item->parent_slug)) : ?>								<?php echo JText::sprintf('COM_CONTENT_PARENT', $url); ?>							<?php else : ?>								<?php echo JText::sprintf('COM_CONTENT_PARENT', $title); ?>							<?php endif; ?>						</div>					</dd>				<?php endif; ?>				<?php if ($params->get('show_category')) : ?>					<dd>						<div class="category-name">							<?php $title = $this->escape($item->category_title);							$url = '<a href="' . JRoute::_(ContentHelperRoute::getCategoryRoute($item->catslug)).'">' . $title . '</a>'; ?>							<?php if ($params->get('link_category') && $item->catslug) : ?>								<?php echo JText::sprintf('COM_CONTENT_CATEGORY', $url); ?>							<?php else : ?>								<?php echo JText::sprintf('COM_CONTENT_CATEGORY', $title); ?>							<?php endif; ?>						</div>					</dd>				<?php endif; ?>				<?php if ($params->get('show_publish_date')) : ?>					<dd>						<div class="published">							<span class="icon-calendar"></span> <?php echo JText::sprintf('COM_CONTENT_PUBLISHED_DATE_ON', JHtml::_('date', $item->publish_up, JText::_('DATE_FORMAT_LC3'))); ?>						</div>					</dd>				<?php endif; ?>				<?php if ($info == 0) : ?>					<?php if ($params->get('show_modify_date')) : ?>						<dd>							<div class="modified">								<span class="icon-calendar"></span> <?php echo JText::sprintf('COM_CONTENT_LAST_UPDATED', JHtml::_('date', $item->modified, JText::_('DATE_FORMAT_LC3'))); ?>							</div>						</dd>					<?php endif; ?>					<?php if ($params->get('show_create_date')) : ?>						<dd>							<div class="create">								<span class="icon-calendar"></span> <?php echo JText::sprintf('COM_CONTENT_CREATED_DATE_ON', JHtml::_('date', $item->created, JText::_('DATE_FORMAT_LC3'))); ?>							</div>						</dd>					<?php endif; ?>					<?php if ($params->get('show_hits')) : ?>						<dd>							<div class="hits">								<span class="icon-eye-open"></span> <?php echo JText::sprintf('COM_CONTENT_ARTICLE_HITS', $item->hits); ?>							</div>						</dd>					<?php endif; ?>				<?php endif; ?>				</dl>			</div>		<?php endif; ?>		<?php if ($params->get('show_intro')) :?>			<div class="intro"> <?php echo JHtml::_('string.truncate', $item->introtext, $params->get('introtext_limit')); ?> </div>		<?php endif; ?>		<?php if ($useDefList && ($info == 1 || $info == 2)) : ?>			<div class="article-info muted">				<dl class="article-info">				<dt class="article-info-term"><?php echo JText::_('COM_CONTENT_ARTICLE_INFO'); ?></dt>				<?php if ($info == 1) : ?>					<?php if ($params->get('show_parent_category') && !empty($item->parent_slug)) : ?>						<dd>							<div class="parent-category-name">								<?php	$title = $this->escape($item->parent_title);								$url = '<a href="' . JRoute::_(ContentHelperRoute::getCategoryRoute($item->parent_slug)) . '">' . $title . '</a>';?>							<?php if ($params->get('link_parent_category') && $item->parent_slug) : ?>								<?php echo JText::sprintf('COM_CONTENT_PARENT', $url); ?>							<?php else : ?>								<?php echo JText::sprintf('COM_CONTENT_PARENT', $title); ?>							<?php endif; ?>							</div>						</dd>					<?php endif; ?>					<?php if ($params->get('show_category')) : ?>						<dd>							<div class="category-name">								<?php 	$title = $this->escape($item->category_title);								$url = '<a href="' . JRoute::_(ContentHelperRoute::getCategoryRoute($item->catslug)) . '">' . $title . '</a>'; ?>								<?php if ($params->get('link_category') && $item->catslug) : ?>									<?php echo JText::sprintf('COM_CONTENT_CATEGORY', $url); ?>								<?php else : ?>									<?php echo JText::sprintf('COM_CONTENT_CATEGORY', $title); ?>								<?php endif; ?>							</div>						</dd>					<?php endif; ?>					<?php if ($params->get('show_publish_date')) : ?>						<dd>							<div class="published">								<span class="icon-calendar"></span> <?php echo JText::sprintf('COM_CONTENT_PUBLISHED_DATE_ON', JHtml::_('date', $item->publish_up, JText::_('DATE_FORMAT_LC3'))); ?>							</div>						</dd>					<?php endif; ?>				<?php endif; ?>				<?php if ($params->get('show_create_date')) : ?>					<dd>						<div class="create"><span class="icon-calendar">							</span> <?php echo JText::sprintf('COM_CONTENT_CREATED_DATE_ON', JHtml::_('date', $item->modified, JText::_('DATE_FORMAT_LC3'))); ?>						</div>					</dd>				<?php endif; ?>				<?php if ($params->get('show_modify_date')) : ?>					<dd>						<div class="modified"><span class="icon-calendar">							</span> <?php echo JText::sprintf('COM_CONTENT_LAST_UPDATED', JHtml::_('date', $item->modified, JText::_('DATE_FORMAT_LC3'))); ?>						</div>					</dd>				<?php endif; ?>				<?php if ($params->get('show_hits')) : ?>					<dd>						<div class="hits">							<span class="icon-eye-open"></span> <?php echo JText::sprintf('COM_CONTENT_ARTICLE_HITS', $item->hits); ?>						</div>					</dd>				<?php endif; ?>			</dl>		</div>		<?php endif; ?>	</div>	<?php endforeach; ?></div><div class="pagination">	<p class="counter"> <?php echo $this->pagination->getPagesCounter(); ?> </p>	<?php echo $this->pagination->getPagesLinks(); ?></div>
<?php/** * @package     Joomla.Plugin * @subpackage  Content.pagebreak * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;jimport('joomla.utilities.utility');/** * Page break plugin * * <b>Usage:</b> * <code><hr class="system-pagebreak" /></code> * <code><hr class="system-pagebreak" title="The page title" /></code> * or * <code><hr class="system-pagebreak" alt="The first page" /></code> * or * <code><hr class="system-pagebreak" title="The page title" alt="The first page" /></code> * or * <code><hr class="system-pagebreak" alt="The first page" title="The page title" /></code> * * @package     Joomla.Plugin * @subpackage  Content.pagebreak * @since       1.6 */class PlgContentPagebreak extends JPlugin{	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * @param   string	The context of the content being passed to the plugin.	 * @param   object	The article object.  Note $article->text is also available	 * @param   object	The article params	 * @param   integer  The 'page' number	 *	 * @return  void	 * @since   1.6	 */	public function onContentPrepare($context, &$row, &$params, $page = 0)	{		$canProceed = $context == 'com_content.article';		if (!$canProceed)		{			return;		}		$style = $this->params->get('style', 'pages');		// Expression to search for.		$regex = '#<hr(.*)class="system-pagebreak"(.*)\/>#iU';		$input = JFactory::getApplication()->input;		$print = $input->getBool('print');		$showall = $input->getBool('showall');		if (!$this->params->get('enabled', 1))		{			$print = true;		}		if ($print)		{			$row->text = preg_replace($regex, '<br />', $row->text);			return true;		}		// Simple performance check to determine whether bot should process further.		if (JString::strpos($row->text, 'class="system-pagebreak') === false)		{			return true;		}		$view = $input->getString('view');		$full = $input->getBool('fullview');		if (!$page)		{			$page = 0;		}		if ($params->get('intro_only') || $params->get('popup') || $full || $view != 'article')		{			$row->text = preg_replace($regex, '', $row->text);			return;		}		// Find all instances of plugin and put in $matches.		$matches = array();		preg_match_all($regex, $row->text, $matches, PREG_SET_ORDER);		if (($showall && $this->params->get('showall', 1)))		{			$hasToc = $this->params->get('multipage_toc', 1);			if ($hasToc)			{				// Display TOC.				$page = 1;				$this->_createToc($row, $matches, $page);			}			else			{				$row->toc = '';			}			$row->text = preg_replace($regex, '<br />', $row->text);			return true;		}		// Split the text around the plugin.		$text = preg_split($regex, $row->text);		// Count the number of pages.		$n = count($text);		// We have found at least one plugin, therefore at least 2 pages.		if ($n > 1)		{			$title	= $this->params->get('title', 1);			$hasToc = $this->params->get('multipage_toc', 1);			// Adds heading or title to <site> Title.			if ($title)			{				if ($page)				{					if ($page && @$matches[$page - 1][2])					{						$attrs = JUtility::parseAttributes($matches[$page - 1][1]);						if (@$attrs['title'])						{							$row->page_title = $attrs['title'];						}					}				}			}			// Reset the text, we already hold it in the $text array.			$row->text = '';			if ($style == 'pages')			{				// Display TOC.				if ($hasToc)				{					$this->_createToc($row, $matches, $page);				}				else				{					$row->toc = '';				}				// traditional mos page navigation				$pageNav = new JPagination($n, $page, 1);				// Page counter.				$row->text .= '<div class="pagenavcounter">';				$row->text .= $pageNav->getPagesCounter();				$row->text .= '</div>';				// Page text.				$text[$page] = str_replace('<hr id="system-readmore" />', '', $text[$page]);				$row->text .= $text[$page];				// $row->text .= '<br />';				$row->text .= '<div class="pager">';				// Adds navigation between pages to bottom of text.				if ($hasToc)				{					$this->_createNavigation($row, $page, $n);				}				// Page links shown at bottom of page if TOC disabled.				if (!$hasToc)				{					$row->text .= $pageNav->getPagesLinks();				}				$row->text .= '</div>';			}			else			{				$t[] = $text[0];				$t[] = (string) JHtml::_($style.'.start', 'article'.$row->id.'-'.$style);				foreach ($text as $key => $subtext)				{					if ($key >= 1)					{						$match = $matches[$key - 1];						$match = (array) JUtility::parseAttributes($match[0]);						if (isset($match['alt']))						{							$title	= stripslashes($match['alt']);						}						elseif (isset($match['title']))						{							$title	= stripslashes($match['title']);						}						else						{							$title	= JText::sprintf('PLG_CONTENT_PAGEBREAK_PAGE_NUM', $key + 1);						}						$t[] = (string) JHtml::_($style.'.panel', $title, 'article'.$row->id.'-'.$style.$key);					}					$t[] = (string) $subtext;				}				$t[] = (string) JHtml::_($style.'.end');				$row->text = implode(' ', $t);			}		}		return true;	}	/**	 * @return  void	 * @return  1.6	 */	protected function _createTOC(&$row, &$matches, &$page)	{		$heading = isset($row->title) ? $row->title : JText::_('PLG_CONTENT_PAGEBREAK_NO_TITLE');		$input = JFactory::getApplication()->input;		$limitstart = $input->getUInt('limitstart', 0);		$showall = $input->getInt('showall', 0);		// TOC header.		$row->toc .= '<div class="pull-right article-index">';		if ($this->params->get('article_index') == 1)		{			$headingtext = JText::_('PLG_CONTENT_PAGEBREAK_ARTICLE_INDEX');			if ($this->params->get('article_index_text'))			{				htmlspecialchars($headingtext = $this->params->get('article_index_text'));			}			$row->toc .= '<h3>' . $headingtext . '</h3>';		}		// TOC first Page link.		$class = ($limitstart === 0 && $showall === 0) ? 'toclink active' : 'toclink';		$row->toc .= '<ul class="nav nav-tabs nav-stacked">		<li class="'.$class.'">			<a href="'. JRoute::_(ContentHelperRoute::getArticleRoute($row->slug, $row->catid).'&showall=&limitstart=') .'" class="'.$class.'">'			. $heading .			'</a>		</li>		';		$i = 2;		foreach ($matches as $bot)		{			$link = JRoute::_(ContentHelperRoute::getArticleRoute($row->slug, $row->catid).'&showall=&limitstart='. ($i - 1));			if (@$bot[0])			{				$attrs2 = JUtility::parseAttributes($bot[0]);				if (@$attrs2['alt'])				{					$title	= stripslashes($attrs2['alt']);				}				elseif (@$attrs2['title'])				{					$title	= stripslashes($attrs2['title']);				}				else				{					$title	= JText::sprintf('PLG_CONTENT_PAGEBREAK_PAGE_NUM', $i);				}			}			else			{				$title	= JText::sprintf('PLG_CONTENT_PAGEBREAK_PAGE_NUM', $i);			}			$class = ($limitstart == $i - 1) ? 'toclink active' : 'toclink';			$row->toc .= '				<li>					<a href="'. $link .'" class="'.$class.'">'					. $title .					'</a>				</li>				';			$i++;		}		if ($this->params->get('showall'))		{			$link = JRoute::_(ContentHelperRoute::getArticleRoute($row->slug, $row->catid).'&showall=1&limitstart=');			$class = ($showall == 1) ? 'toclink active' : 'toclink';			$row->toc .= '			<li>					<a href="'. $link .'" class="'.$class.'">'					. JText::_('PLG_CONTENT_PAGEBREAK_ALL_PAGES') .					'</a>			</li>			';		}		$row->toc .= '</ul></div>';	}	/**	 * @return  void	 * @since   1.6	 */	protected function _createNavigation(&$row, $page, $n)	{		$pnSpace = '';		if (JText::_('JGLOBAL_LT') || JText::_('JGLOBAL_LT'))		{			$pnSpace = ' ';		}		if ($page < $n - 1)		{			$page_next = $page + 1;			$link_next = JRoute::_(ContentHelperRoute::getArticleRoute($row->slug, $row->catid).'&showall=&limitstart='. ($page_next));			// Next >>			$next = '<a href="'. $link_next .'">' . JText::_('JNEXT') . $pnSpace . JText::_('JGLOBAL_GT') . JText::_('JGLOBAL_GT') .'</a>';		}		else		{			$next = JText::_('JNEXT');		}		if ($page > 0)		{			$page_prev = $page - 1 == 0 ? '' : $page - 1;			$link_prev = JRoute::_(ContentHelperRoute::getArticleRoute($row->slug, $row->catid).'&showall=&limitstart='. ($page_prev));			// << Prev			$prev = '<a href="'. $link_prev .'">'. JText::_('JGLOBAL_LT') . JText::_('JGLOBAL_LT') . $pnSpace . JText::_('JPREV') .'</a>';		}		else		{			$prev = JText::_('JPREV');		}		$row->text .= '<ul><li>' . $prev . ' </li><li>' . $next .'</li></ul>';	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JLoader::register('InstallerModel', __DIR__ . '/extension.php');JLoader::register('JoomlaInstallerScript', JPATH_ADMINISTRATOR . '/components/com_admin/script.php');/** * Installer Manage Model * * @package     Joomla.Administrator * @subpackage  com_installer * @since       1.6 */class InstallerModelDatabase extends InstallerModel{	protected $_context = 'com_installer.discover';	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication();		$this->setState('message', $app->getUserState('com_installer.message'));		$this->setState('extension_message', $app->getUserState('com_installer.extension_message'));		$app->setUserState('com_installer.message', '');		$app->setUserState('com_installer.extension_message', '');		parent::populateState('name', 'asc');	}	/**	 * Fixes database problems	 *	 * @return  void	 */	public function fix()	{		if (!$changeSet = $this->getItems())		{			return false;		}		$changeSet->fix();		$this->fixSchemaVersion($changeSet);		$this->fixUpdateVersion();		$installer = new JoomlaInstallerScript;		$installer->deleteUnexistingFiles();		$this->fixDefaultTextFilters();	}	/**	 * Gets the changeset object	 *	 * @return  JSchemaChangeset	 */	public function getItems()	{		$folder = JPATH_ADMINISTRATOR . '/components/com_admin/sql/updates/';		try		{			$changeSet = JSchemaChangeset::getInstance(JFactory::getDbo(), $folder);		}		catch (RuntimeException $e)		{			JFactory::getApplication()->enqueueMessage($e->getMessage(), 'warning');			return false;		}		return $changeSet;	}	/**	 * Method to get a JPagination object for the data set.	 *	 * @return  boolean	 *	 * @since   12.2	 */	public function getPagination()	{		return true;	}	/**	 * Get version from #__schemas table	 *	 * @return  mixed  the return value from the query, or null if the query fails	 *	 * @throws Exception	 */	public function getSchemaVersion()	{		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('version_id')			->from($db->quoteName('#__schemas'))			->where('extension_id = 700');		$db->setQuery($query);		$result = $db->loadResult();		return $result;	}	/**	 * Fix schema version if wrong	 *	 * @param   JSchemaChangeSet  $changeSet  Schema change set	 *	 * @return   mixed  string schema version if success, false if fail	 */	public function fixSchemaVersion($changeSet)	{		// Get correct schema version -- last file in array		$schema = $changeSet->getSchema();		$db = JFactory::getDbo();		$result = false;		// Check value. If ok, don't do update		$version = $this->getSchemaVersion();		if ($version == $schema)		{			$result = $version;		}		else		{			// Delete old row			$query = $db->getQuery(true)				->delete($db->quoteName('#__schemas'))				->where($db->quoteName('extension_id') . ' = 700');			$db->setQuery($query);			$db->execute();			// Add new row			$query = $db->getQuery(true)				->insert($db->quoteName('#__schemas'))				->set($db->quoteName('extension_id') . '= 700')				->set($db->quoteName('version_id') . '= ' . $db->quote($schema));			$db->setQuery($query);			if ($db->execute())			{				$result = $schema;			}		}		return $result;	}	/**	 * Get current version from #__extensions table	 *	 * @return  mixed   version if successful, false if fail	 */	public function getUpdateVersion()	{		$table = JTable::getInstance('Extension');		$table->load('700');		$cache = new JRegistry($table->manifest_cache);		return $cache->get('version');	}	/**	 * Fix Joomla version in #__extensions table if wrong (doesn't equal JVersion short version)	 *	 * @return   mixed  string update version if success, false if fail	 */	public function fixUpdateVersion()	{		$table = JTable::getInstance('Extension');		$table->load('700');		$cache = new JRegistry($table->manifest_cache);		$updateVersion = $cache->get('version');		$cmsVersion = new JVersion;		if ($updateVersion == $cmsVersion->getShortVersion())		{			return $updateVersion;		}		else		{			$cache->set('version', $cmsVersion->getShortVersion());			$table->manifest_cache = $cache->toString();			if ($table->store())			{				return $cmsVersion->getShortVersion();			}			else			{				return false;			}		}	}	/**	 * For version 2.5.x only	 * Check if com_config parameters are blank.	 *	 * @return  string  default text filters (if any)	 */	public function getDefaultTextFilters()	{		$table = JTable::getInstance('Extension');		$table->load($table->find(array('name' => 'com_config')));		return $table->params;	}	/**	 * For version 2.5.x only	 * Check if com_config parameters are blank. If so, populate with com_content text filters.	 *	 * @return  mixed  boolean true if params are updated, null otherwise	 */	public function fixDefaultTextFilters()	{		$table = JTable::getInstance('Extension');		$table->load($table->find(array('name' => 'com_config')));		// Check for empty $config and non-empty content filters		if (!$table->params)		{			// Get filters from com_content and store if you find them			$contentParams = JComponentHelper::getParams('com_content');			if ($contentParams->get('filters'))			{				$newParams = new JRegistry;				$newParams->set('filters', $contentParams->get('filters'));				$table->params = (string) $newParams;				$table->store();				return true;			}		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$script = "\t".'Joomla.submitbutton = function(pressbutton) {'."\n";$script .= "\t\t".'var form = document.adminForm;'."\n";$script .= "\t\t".'if (pressbutton == \'mail.cancel\') {'."\n";$script .= "\t\t\t".'Joomla.submitform(pressbutton);'."\n";$script .= "\t\t\t".'return;'."\n";$script .= "\t\t".'}'."\n";$script .= "\t\t".'// do field validation'."\n";$script .= "\t\t".'if (form.jform_subject.value == ""){'."\n";$script .= "\t\t\t".'alert("'.JText::_('COM_USERS_MAIL_PLEASE_FILL_IN_THE_SUBJECT', true).'");'."\n";$script .= "\t\t".'} else if (getSelectedValue(\'adminForm\',\'jform[group]\') < 0){'."\n";$script .= "\t\t\t".'alert("'.JText::_('COM_USERS_MAIL_PLEASE_SELECT_A_GROUP', true).'");'."\n";$script .= "\t\t".'} else if (form.jform_message.value == ""){'."\n";$script .= "\t\t\t".'alert("'.JText::_('COM_USERS_MAIL_PLEASE_FILL_IN_THE_MESSAGE', true).'");'."\n";$script .= "\t\t".'} else {'."\n";$script .= "\t\t\t".'Joomla.submitform(pressbutton);'."\n";$script .= "\t\t".'}'."\n";$script .= "\t\t".'}'."\n";// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('formbehavior.chosen', 'select');JFactory::getDocument()->addScriptDeclaration($script);?><form action="<?php echo JRoute::_('index.php?option=com_users&view=mail'); ?>" name="adminForm" method="post" id="adminForm">	<div class="row-fluid">		<div class="span9">			<fieldset class="adminform">				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('subject'); ?></div>					<div class="controls"><?php echo $this->form->getInput('subject'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('message'); ?></div>					<div class="controls"><?php echo $this->form->getInput('message'); ?></div>				</div>			</fieldset>			<input type="hidden" name="task" value="" />			<?php echo JHtml::_('form.token'); ?>		</div>		<div class="span3">			<fieldset class="form-inline">				<div class="control-group checkbox">					<div class="controls"><?php echo $this->form->getInput('recurse'); ?> <?php echo $this->form->getLabel('recurse'); ?></div>				</div>				<div class="control-group checkbox">					<div class="control-label"><?php echo $this->form->getInput('mode'); ?> <?php echo $this->form->getLabel('mode'); ?></div>				</div>				<div class="control-group checkbox">					<div class="control-label"><?php echo $this->form->getInput('disabled'); ?> <?php echo $this->form->getLabel('disabled'); ?></div>				</div>				<div class="control-group checkbox">					<div class="control-label"><?php echo $this->form->getInput('bcc'); ?> <?php echo $this->form->getLabel('bcc'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('group'); ?></div>					<div class="controls"><?php echo $this->form->getInput('group'); ?></div>				</div>			</fieldset>		</div>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_templates * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Templates manager master display controller. * * @package     Joomla.Administrator * @subpackage  com_templates * @since       1.6 */class TemplatesController extends JControllerLegacy{	/**	 * @var		string	The default view.	 * @since   1.6	 */	protected $default_view = 'styles';	/**	 * Method to display a view.	 *	 * @param   boolean			If true, the view output will be cached	 * @param   array  An array of safe url parameters and their variable types, for valid values see {@link JFilterInput::clean()}.	 *	 * @return  JController		This object to support chaining.	 * @since   1.5	 */	public function display($cachable = false, $urlparams = false)	{		$view   = $this->input->get('view', 'styles');		$layout = $this->input->get('layout', 'default');		$id     = $this->input->getInt('id');		// Check for edit form.		if ($view == 'style' && $layout == 'edit' && !$this->checkEditId('com_templates.edit.style', $id))		{			// Somehow the person just went to the form - we don't allow that.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_UNHELD_ID', $id));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(JRoute::_('index.php?option=com_templates&view=styles', false));			return false;		}		parent::display();	}}
<?php/** * @package     Joomla.Legacy * @subpackage  Module * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Module helper class * * @package     Joomla.Legacy * @subpackage  Module * @since       11.1 */abstract class JModuleHelper{	/**	 * Get module by name (real, eg 'Breadcrumbs' or folder, eg 'mod_breadcrumbs')	 *	 * @param   string  $name   The name of the module	 * @param   string  $title  The title of the module, optional	 *	 * @return  object  The Module object	 *	 * @since   11.1	 */	public static function &getModule($name, $title = null)	{		$result = null;		$modules =& self::_load();		$total = count($modules);		for ($i = 0; $i < $total; $i++)		{			// Match the name of the module			if ($modules[$i]->name == $name || $modules[$i]->module == $name)			{				// Match the title if we're looking for a specific instance of the module				if (!$title || $modules[$i]->title == $title)				{					// Found it					$result = &$modules[$i];					break;				}			}		}		// If we didn't find it, and the name is mod_something, create a dummy object		if (is_null($result) && substr($name, 0, 4) == 'mod_')		{			$result            = new stdClass;			$result->id        = 0;			$result->title     = '';			$result->module    = $name;			$result->position  = '';			$result->content   = '';			$result->showtitle = 0;			$result->control   = '';			$result->params    = '';		}		return $result;	}	/**	 * Get modules by position	 *	 * @param   string  $position  The position of the module	 *	 * @return  array  An array of module objects	 *	 * @since   11.1	 */	public static function &getModules($position)	{		$position = strtolower($position);		$result = array();		$input  = JFactory::getApplication()->input;		$modules =& self::_load();		$total = count($modules);		for ($i = 0; $i < $total; $i++)		{			if ($modules[$i]->position == $position)			{				$result[] = &$modules[$i];			}		}		if (count($result) == 0)		{			if ($input->getBool('tp') && JComponentHelper::getParams('com_templates')->get('template_positions_display'))			{				$result[0] = self::getModule('mod_' . $position);				$result[0]->title = $position;				$result[0]->content = $position;				$result[0]->position = $position;			}		}		return $result;	}	/**	 * Checks if a module is enabled	 *	 * @param   string  $module  The module name	 *	 * @return  boolean	 *	 * @since   11.1	 */	public static function isEnabled($module)	{		$result = self::getModule($module);		return !is_null($result);	}	/**	 * Render the module.	 *	 * @param   object  $module   A module object.	 * @param   array   $attribs  An array of attributes for the module (probably from the XML).	 *	 * @return  string  The HTML content of the module output.	 *	 * @since   11.1	 */	public static function renderModule($module, $attribs = array())	{		static $chrome;		if (defined('JDEBUG'))		{			JProfiler::getInstance('Application')->mark('beforeRenderModule ' . $module->module . ' (' . $module->title . ')');		}		$app = JFactory::getApplication();		// Record the scope.		$scope = $app->scope;		// Set scope to component name		$app->scope = $module->module;		// Get module parameters		$params = new JRegistry;		$params->loadString($module->params);		// Get the template		$template = $app->getTemplate();		// Get module path		$module->module = preg_replace('/[^A-Z0-9_\.-]/i', '', $module->module);		$path = JPATH_BASE . '/modules/' . $module->module . '/' . $module->module . '.php';		// Load the module		if (file_exists($path))		{			$lang = JFactory::getLanguage();			// 1.5 or Core then 1.6 3PD			$lang->load($module->module, JPATH_BASE, null, false, false) ||				$lang->load($module->module, dirname($path), null, false, false) ||				$lang->load($module->module, JPATH_BASE, $lang->getDefault(), false, false) ||				$lang->load($module->module, dirname($path), $lang->getDefault(), false, false);			$content = '';			ob_start();			include $path;			$module->content = ob_get_contents() . $content;			ob_end_clean();		}		// Load the module chrome functions		if (!$chrome)		{			$chrome = array();		}		include_once JPATH_THEMES . '/system/html/modules.php';		$chromePath = JPATH_THEMES . '/' . $template . '/html/modules.php';		if (!isset($chrome[$chromePath]))		{			if (file_exists($chromePath))			{				include_once $chromePath;			}			$chrome[$chromePath] = true;		}		// Check if the current module has a style param to override template module style		$paramsChromeStyle = $params->get('style');		if ($paramsChromeStyle)		{			$attribs['style'] = preg_replace('/^(system|' . $template . ')\-/i', '', $paramsChromeStyle);		}		// Make sure a style is set		if (!isset($attribs['style']))		{			$attribs['style'] = 'none';		}		// Dynamically add outline style		if ($app->input->getBool('tp') && JComponentHelper::getParams('com_templates')->get('template_positions_display'))		{			$attribs['style'] .= ' outline';		}		foreach (explode(' ', $attribs['style']) as $style)		{			$chromeMethod = 'modChrome_' . $style;			// Apply chrome and render module			if (function_exists($chromeMethod))			{				$module->style = $attribs['style'];				ob_start();				$chromeMethod($module, $params, $attribs);				$module->content = ob_get_contents();				ob_end_clean();			}		}		// Revert the scope		$app->scope = $scope;		if (defined('JDEBUG'))		{			JProfiler::getInstance('Application')->mark('afterRenderModule ' . $module->module . ' (' . $module->title . ')');		}		return $module->content;	}	/**	 * Get the path to a layout for a module	 *	 * @param   string  $module  The name of the module	 * @param   string  $layout  The name of the module layout. If alternative layout, in the form template:filename.	 *	 * @return  string  The path to the module layout	 *	 * @since   11.1	 */	public static function getLayoutPath($module, $layout = 'default')	{		$template = JFactory::getApplication()->getTemplate();		$defaultLayout = $layout;		if (strpos($layout, ':') !== false)		{			// Get the template and file name from the string			$temp = explode(':', $layout);			$template = ($temp[0] == '_') ? $template : $temp[0];			$layout = $temp[1];			$defaultLayout = ($temp[1]) ? $temp[1] : 'default';		}		// Build the template and base path for the layout		$tPath = JPATH_THEMES . '/' . $template . '/html/' . $module . '/' . $layout . '.php';		$bPath = JPATH_BASE . '/modules/' . $module . '/tmpl/' . $defaultLayout . '.php';		$dPath = JPATH_BASE . '/modules/' . $module . '/tmpl/default.php';		// If the template has a layout override use it		if (file_exists($tPath))		{			return $tPath;		}		elseif (file_exists($bPath))		{			return $bPath;		}		else		{			return $dPath;		}	}	/**	 * Load published modules.	 *	 * @return  array	 *	 * @since   11.1	 */	protected static function &_load()	{		static $clean;		if (isset($clean))		{			return $clean;		}		$app = JFactory::getApplication();		$Itemid = $app->input->getInt('Itemid');		$user = JFactory::getUser();		$groups = implode(',', $user->getAuthorisedViewLevels());		$lang = JFactory::getLanguage()->getTag();		$clientId = (int) $app->getClientId();		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('m.id, m.title, m.module, m.position, m.content, m.showtitle, m.params, mm.menuid')			->from('#__modules AS m')			->join('LEFT', '#__modules_menu AS mm ON mm.moduleid = m.id')			->where('m.published = 1')			->join('LEFT', '#__extensions AS e ON e.element = m.module AND e.client_id = m.client_id')			->where('e.enabled = 1');		$date = JFactory::getDate();		$now = $date->toSql();		$nullDate = $db->getNullDate();		$query->where('(m.publish_up = ' . $db->quote($nullDate) . ' OR m.publish_up <= ' . $db->quote($now) . ')')			->where('(m.publish_down = ' . $db->quote($nullDate) . ' OR m.publish_down >= ' . $db->quote($now) . ')')			->where('m.access IN (' . $groups . ')')			->where('m.client_id = ' . $clientId)			->where('(mm.menuid = ' . (int) $Itemid . ' OR mm.menuid <= 0)');		// Filter by language		if ($app->isSite() && $app->getLanguageFilter())		{			$query->where('m.language IN (' . $db->quote($lang) . ',' . $db->quote('*') . ')');		}		$query->order('m.position, m.ordering');		// Set the query		$db->setQuery($query);		$clean = array();		try		{			$modules = $db->loadObjectList();		}		catch (RuntimeException $e)		{			JLog::add(JText::sprintf('JLIB_APPLICATION_ERROR_MODULE_LOAD', $e->getMessage()), JLog::WARNING, 'jerror');			return $clean;		}		// Apply negative selections and eliminate duplicates		$negId = $Itemid ? -(int) $Itemid : false;		$dupes = array();		for ($i = 0, $n = count($modules); $i < $n; $i++)		{			$module = &$modules[$i];			// The module is excluded if there is an explicit prohibition			$negHit = ($negId === (int) $module->menuid);			if (isset($dupes[$module->id]))			{				// If this item has been excluded, keep the duplicate flag set,				// but remove any item from the cleaned array.				if ($negHit)				{					unset($clean[$module->id]);				}				continue;			}			$dupes[$module->id] = true;			// Only accept modules without explicit exclusions.			if (!$negHit)			{				$module->name = substr($module->module, 4);				$module->style = null;				$module->position = strtolower($module->position);				$clean[$module->id] = $module;			}		}		unset($dupes);		// Return to simple indexing that matches the query order.		$clean = array_values($clean);		return $clean;	}	/**	 * Module cache helper	 *	 * Caching modes:	 * To be set in XML:	 * 'static'      One cache file for all pages with the same module parameters	 * 'oldstatic'   1.5 definition of module caching, one cache file for all pages	 *               with the same module id and user aid,	 * 'itemid'      Changes on itemid change, to be called from inside the module:	 * 'safeuri'     Id created from $cacheparams->modeparams array,	 * 'id'          Module sets own cache id's	 *	 * @param   object  $module        Module object	 * @param   object  $moduleparams  Module parameters	 * @param   object  $cacheparams   Module cache parameters - id or url parameters, depending on the module cache mode	 *	 * @return  string	 *	 * @since   11.1	 *	 * @link JFilterInput::clean()	 */	public static function moduleCache($module, $moduleparams, $cacheparams)	{		if (!isset($cacheparams->modeparams))		{			$cacheparams->modeparams = null;		}		if (!isset($cacheparams->cachegroup))		{			$cacheparams->cachegroup = $module->module;		}		$user = JFactory::getUser();		$cache = JFactory::getCache($cacheparams->cachegroup, 'callback');		$conf = JFactory::getConfig();		// Turn cache off for internal callers if parameters are set to off and for all logged in users		if ($moduleparams->get('owncache', null) === '0' || $conf->get('caching') == 0 || $user->get('id'))		{			$cache->setCaching(false);		}		// Module cache is set in seconds, global cache in minutes, setLifeTime works in minutes		$cache->setLifeTime($moduleparams->get('cache_time', $conf->get('cachetime') * 60) / 60);		$wrkaroundoptions = array('nopathway' => 1, 'nohead' => 0, 'nomodules' => 1, 'modulemode' => 1, 'mergehead' => 1);		$wrkarounds = true;		$view_levels = md5(serialize($user->getAuthorisedViewLevels()));		switch ($cacheparams->cachemode)		{			case 'id':				$ret = $cache->get(					array($cacheparams->class, $cacheparams->method),					$cacheparams->methodparams,					$cacheparams->modeparams,					$wrkarounds,					$wrkaroundoptions				);				break;			case 'safeuri':				$secureid = null;				if (is_array($cacheparams->modeparams))				{					$uri = JRequest::get();					$safeuri = new stdClass;					foreach ($cacheparams->modeparams as $key => $value)					{						// Use int filter for id/catid to clean out spamy slugs						if (isset($uri[$key]))						{							$noHtmlFilter = JFilterInput::getInstance();							$safeuri->$key = $noHtmlFilter->clean($uri[$key], $value);						}					}				}				$secureid = md5(serialize(array($safeuri, $cacheparams->method, $moduleparams)));				$ret = $cache->get(					array($cacheparams->class, $cacheparams->method),					$cacheparams->methodparams,					$module->id . $view_levels . $secureid,					$wrkarounds,					$wrkaroundoptions				);				break;			case 'static':				$ret = $cache->get(					array($cacheparams->class,						$cacheparams->method),					$cacheparams->methodparams,					$module->module . md5(serialize($cacheparams->methodparams)),					$wrkarounds,					$wrkaroundoptions				);				break;			// Provided for backward compatibility, not really useful.			case 'oldstatic':				$ret = $cache->get(					array($cacheparams->class, $cacheparams->method),					$cacheparams->methodparams,					$module->id . $view_levels,					$wrkarounds,					$wrkaroundoptions				);				break;			case 'itemid':			default:				$ret = $cache->get(					array($cacheparams->class, $cacheparams->method),					$cacheparams->methodparams,					$module->id . $view_levels . JFactory::getApplication()->input->getInt('Itemid', null),					$wrkarounds,					$wrkaroundoptions				);				break;		}		return $ret;	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Search.newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Newsfeeds Search plugin * * @package     Joomla.Plugin * @subpackage  Search.newsfeeds * @since       1.6 */class PlgSearchNewsfeeds extends JPlugin{	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * @return array An array of search areas	 */	public function onContentSearchAreas()	{		static $areas = array(			'newsfeeds' => 'PLG_SEARCH_NEWSFEEDS_NEWSFEEDS'		);		return $areas;	}	/**	 * Newsfeeds Search method	 *	 * The sql must return the following fields that are used in a common display	 * routine: href, title, section, created, text, browsernav	 * @param string Target search string	 * @param string mathcing option, exact|any|all	 * @param string ordering option, newest|oldest|popular|alpha|category	 * @param mixed  An array if the search it to be restricted to areas, null if search all	 */	public function onContentSearch($text, $phrase = '', $ordering = '', $areas = null)	{		$db = JFactory::getDbo();		$app = JFactory::getApplication();		$user = JFactory::getUser();		$groups = implode(',', $user->getAuthorisedViewLevels());		if (is_array($areas))		{			if (!array_intersect($areas, array_keys($this->onContentSearchAreas())))			{				return array();			}		}		$sContent = $this->params->get('search_content', 1);		$sArchived = $this->params->get('search_archived', 1);		$limit = $this->params->def('search_limit', 50);		$state = array();		if ($sContent)		{			$state[] = 1;		}		if ($sArchived)		{			$state[] = 2;		}		$text = trim($text);		if ($text == '')		{			return array();		}		switch ($phrase)		{			case 'exact':				$text = $db->quote('%' . $db->escape($text, true) . '%', false);				$wheres2 = array();				$wheres2[] = 'a.name LIKE ' . $text;				$wheres2[] = 'a.link LIKE ' . $text;				$where = '(' . implode(') OR (', $wheres2) . ')';				break;			case 'all':			case 'any':			default:				$words = explode(' ', $text);				$wheres = array();				foreach ($words as $word)				{					$word = $db->quote('%' . $db->escape($word, true) . '%', false);					$wheres2 = array();					$wheres2[] = 'a.name LIKE ' . $word;					$wheres2[] = 'a.link LIKE ' . $word;					$wheres[] = implode(' OR ', $wheres2);				}				$where = '(' . implode(($phrase == 'all' ? ') AND (' : ') OR ('), $wheres) . ')';				break;		}		switch ($ordering)		{			case 'alpha':				$order = 'a.name ASC';				break;			case 'category':				$order = 'c.title ASC, a.name ASC';				break;			case 'oldest':			case 'popular':			case 'newest':			default:				$order = 'a.name ASC';		}		$searchNewsfeeds = JText::_('PLG_SEARCH_NEWSFEEDS_NEWSFEEDS');		$rows = array();		if (!empty($state))		{			$query = $db->getQuery(true);			//sqlsrv changes			$case_when = ' CASE WHEN ';			$case_when .= $query->charLength('a.alias', '!=', '0');			$case_when .= ' THEN ';			$a_id = $query->castAsChar('a.id');			$case_when .= $query->concatenate(array($a_id, 'a.alias'), ':');			$case_when .= ' ELSE ';			$case_when .= $a_id . ' END as slug';			$case_when1 = ' CASE WHEN ';			$case_when1 .= $query->charLength('c.alias', '!=', '0');			$case_when1 .= ' THEN ';			$c_id = $query->castAsChar('c.id');			$case_when1 .= $query->concatenate(array($c_id, 'c.alias'), ':');			$case_when1 .= ' ELSE ';			$case_when1 .= $c_id . ' END as catslug';			$query->select('a.name AS title, \'\' AS created, a.link AS text, ' . $case_when . "," . $case_when1)				->select($query->concatenate(array($db->quote($searchNewsfeeds), 'c.title'), " / ") . ' AS section')				->select('\'1\' AS browsernav')				->from('#__newsfeeds AS a')				->join('INNER', '#__categories as c ON c.id = a.catid')				->where('(' . $where . ')AND a.published IN (' . implode(',', $state) . ') AND c.published = 1 AND c.access IN (' . $groups . ')')				->order($order);			// Filter by language			if ($app->isSite() && JLanguageMultilang::isEnabled())			{				$tag = JFactory::getLanguage()->getTag();				$query->where('a.language in (' . $db->quote($tag) . ',' . $db->quote('*') . ')')					->where('c.language in (' . $db->quote($tag) . ',' . $db->quote('*') . ')');			}			$db->setQuery($query, 0, $limit);			$rows = $db->loadObjectList();			if ($rows)			{				foreach ($rows as $key => $row)				{					$rows[$key]->href = 'index.php?option=com_newsfeeds&view=newsfeed&catid=' . $row->catslug . '&id=' . $row->slug;				}			}		}		return $rows;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * View class for a list of articles. * * @package     Joomla.Administrator * @subpackage  com_content * @since       1.6 */class ContentViewArticles extends JViewLegacy{	protected $items;	protected $pagination;	protected $state;	/**	 * Display the view	 *	 * @return  void	 */	public function display($tpl = null)	{		if ($this->getLayout() !== 'modal')		{			ContentHelper::addSubmenu('articles');		}		$this->items		= $this->get('Items');		$this->pagination	= $this->get('Pagination');		$this->state		= $this->get('State');		$this->authors		= $this->get('Authors');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		// Levels filter.		$options	= array();		$options[]	= JHtml::_('select.option', '1', JText::_('J1'));		$options[]	= JHtml::_('select.option', '2', JText::_('J2'));		$options[]	= JHtml::_('select.option', '3', JText::_('J3'));		$options[]	= JHtml::_('select.option', '4', JText::_('J4'));		$options[]	= JHtml::_('select.option', '5', JText::_('J5'));		$options[]	= JHtml::_('select.option', '6', JText::_('J6'));		$options[]	= JHtml::_('select.option', '7', JText::_('J7'));		$options[]	= JHtml::_('select.option', '8', JText::_('J8'));		$options[]	= JHtml::_('select.option', '9', JText::_('J9'));		$options[]	= JHtml::_('select.option', '10', JText::_('J10'));		$this->f_levels = $options;		// We don't need toolbar in the modal window.		if ($this->getLayout() !== 'modal')		{			$this->addToolbar();			$this->sidebar = JHtmlSidebar::render();		}		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		$canDo = ContentHelper::getActions($this->state->get('filter.category_id'));		$user  = JFactory::getUser();		// Get the toolbar object instance		$bar = JToolBar::getInstance('toolbar');		JToolbarHelper::title(JText::_('COM_CONTENT_ARTICLES_TITLE'), 'article.png');		if ($canDo->get('core.create') || (count($user->getAuthorisedCategories('com_content', 'core.create'))) > 0 )		{			JToolbarHelper::addNew('article.add');		}		if (($canDo->get('core.edit')) || ($canDo->get('core.edit.own')))		{			JToolbarHelper::editList('article.edit');		}		if ($canDo->get('core.edit.state'))		{			JToolbarHelper::publish('articles.publish', 'JTOOLBAR_PUBLISH', true);			JToolbarHelper::unpublish('articles.unpublish', 'JTOOLBAR_UNPUBLISH', true);			JToolbarHelper::custom('articles.featured', 'featured.png', 'featured_f2.png', 'JFEATURED', true);			JToolbarHelper::archiveList('articles.archive');			JToolbarHelper::checkin('articles.checkin');		}		if ($this->state->get('filter.published') == -2 && $canDo->get('core.delete'))		{			JToolbarHelper::deleteList('', 'articles.delete', 'JTOOLBAR_EMPTY_TRASH');		}		elseif ($canDo->get('core.edit.state'))		{			JToolbarHelper::trash('articles.trash');		}		// Add a batch button		if ($user->authorise('core.edit'))		{			JHtml::_('bootstrap.modal', 'collapseModal');			$title = JText::_('JTOOLBAR_BATCH');			$dhtml = "<button data-toggle=\"modal\" data-target=\"#collapseModal\" class=\"btn btn-small\">						<i class=\"icon-checkbox-partial\" title=\"$title\"></i>						$title</button>";			$bar->appendButton('Custom', $dhtml, 'batch');		}		if ($canDo->get('core.admin'))		{			JToolbarHelper::preferences('com_content');		}		JToolbarHelper::help('JHELP_CONTENT_ARTICLE_MANAGER');		JHtmlSidebar::setAction('index.php?option=com_content&view=articles');		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_PUBLISHED'),			'filter_published',			JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.published'), true)		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_CATEGORY'),			'filter_category_id',			JHtml::_('select.options', JHtml::_('category.options', 'com_content'), 'value', 'text', $this->state->get('filter.category_id'))		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_MAX_LEVELS'),			'filter_level',			JHtml::_('select.options', $this->f_levels, 'value', 'text', $this->state->get('filter.level'))		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_ACCESS'),			'filter_access',			JHtml::_('select.options', JHtml::_('access.assetgroups'), 'value', 'text', $this->state->get('filter.access'))		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_AUTHOR'),			'filter_author_id',			JHtml::_('select.options', $this->authors, 'value', 'text', $this->state->get('filter.author_id'))		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_LANGUAGE'),			'filter_language',			JHtml::_('select.options', JHtml::_('contentlanguage.existing', true, true), 'value', 'text', $this->state->get('filter.language'))		);		JHtmlSidebar::addFilter(		'-' . JText::_('JSELECT') . ' ' . JText::_('JTAG') . '-',		'filter_tag',		JHtml::_('select.options', JHtml::_('tag.options', true, true), 'value', 'text', $this->state->get('filter.tag'))		);	}	/**	 * Returns an array of fields the table can be sorted by	 *	 * @return  array  Array containing the field name to sort by as the key and display text as value	 *	 * @since   3.0	 */	protected function getSortFields()	{		return array(			'a.ordering' => JText::_('JGRID_HEADING_ORDERING'),			'a.state' => JText::_('JSTATUS'),			'a.title' => JText::_('JGLOBAL_TITLE'),			'category_title' => JText::_('JCATEGORY'),			'access_level' => JText::_('JGRID_HEADING_ACCESS'),			'a.created_by' => JText::_('JAUTHOR'),			'language' => JText::_('JGRID_HEADING_LANGUAGE'),			'a.created' => JText::_('JDATE'),			'a.id' => JText::_('JGRID_HEADING_ID'),			'a.featured' => JText::_('JFEATURED')		);	}}
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$class = ' class="first"';if (count($this->items[$this->parent->id]) > 0 && $this->maxLevelcat != 0) :?>	<?php foreach($this->items[$this->parent->id] as $id => $item) : ?>		<?php		if ($this->params->get('show_empty_categories_cat') || $item->numitems || count($item->getChildren())) :			if (!isset($this->items[$this->parent->id][$id + 1]))			{				$class = ' class="last"';			}			?>			<div <?php echo $class; ?> >			<?php $class = ''; ?>				<h3 class="page-header item-title">					<a href="<?php echo JRoute::_(ContactHelperRoute::getCategoryRoute($item->id)); ?>">					<?php echo $this->escape($item->title); ?></a>					<?php if ($this->params->get('show_cat_num_articles_cat') == 1) :?>						<span class="badge badge-info tip hasTooltip" title="<?php echo JText::_('COM_CONTACT_NUM_ITEMS'); ?>">							<?php echo $item->numitems; ?>						</span>					<?php endif; ?>					<?php if (count($item->getChildren()) > 0) : ?>						<a href="#category-<?php echo $item->id;?>" data-toggle="collapse" data-toggle="button" class="btn btn-mini pull-right"><span class="icon-plus"></span></a>					<?php endif;?>				</h3>				<?php if ($this->params->get('show_subcat_desc_cat') == 1) :?>					<?php if ($item->description) : ?>						<div class="category-desc">							<?php echo JHtml::_('content.prepare', $item->description, '', 'com_contact.categories'); ?>						</div>					<?php endif; ?>				<?php endif; ?>				<?php if (count($item->getChildren()) > 0) :?>					<div class="collapse fade" id="category-<?php echo $item->id;?>">						<?php						$this->items[$item->id] = $item->getChildren();						$this->parent = $item;						$this->maxLevelcat--;						echo $this->loadTemplate('items');						$this->parent = $item->getParent();						$this->maxLevelcat++;						?>					</div>				<?php endif; ?>			</div>		<?php endif; ?>	<?php endforeach; ?><?php endif; ?>
<?php/** * @package     Joomla.Administrator * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;JFormHelper::loadFieldClass('list');/** * Form Field class for the Joomla Framework. * * @package     Joomla.Administrator * @subpackage  com_newsfeeds * @since       1.6 */class JFormFieldNewsfeeds extends JFormFieldList{	/**	 * The form field type.	 *	 * @var		string	 * @since   1.6	 */	protected $type = 'Newsfeeds';	/**	 * Method to get the field options.	 *	 * @return  array  The field option objects.	 * @since   1.6	 */	protected function getOptions()	{		$options = array();		$db		= JFactory::getDbo();		$query	= $db->getQuery(true)			->select('id As value, name As text')			->from('#__newsfeeds AS a')			->order('a.name');		// Get the options.		$db->setQuery($query);		try		{			$options = $db->loadObjectList();		}		catch (RuntimeException $e)		{			JError::raiseWarning(500, $db->getMessage());		}		// Merge any additional options in the XML definition.		$options = array_merge(parent::getOptions(), $options);		return $options;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.keepalive');JHtml::_('behavior.formvalidation');JHtml::_('behavior.tooltip');if (isset($this->error)) : ?>	<div class="contact-error">		<?php echo $this->error; ?>	</div><?php endif; ?><div class="contact-form">	<form id="contact-form" action="<?php echo JRoute::_('index.php'); ?>" method="post" class="form-validate form-horizontal">		<fieldset>			<legend><?php echo JText::_('COM_CONTACT_FORM_LABEL'); ?></legend>			<div class="control-group">				<div class="control-label"><?php echo $this->form->getLabel('contact_name'); ?></div>				<div class="controls"><?php echo $this->form->getInput('contact_name'); ?></div>			</div>			<div class="control-group">				<div class="control-label"><?php echo $this->form->getLabel('contact_email'); ?></div>				<div class="controls"><?php echo $this->form->getInput('contact_email'); ?></div>			</div>			<div class="control-group">				<div class="control-label"><?php echo $this->form->getLabel('contact_subject'); ?></div>				<div class="controls"><?php echo $this->form->getInput('contact_subject'); ?></div>			</div>			<div class="control-group">				<div class="control-label"><?php echo $this->form->getLabel('contact_message'); ?></div>				<div class="controls"><?php echo $this->form->getInput('contact_message'); ?></div>			</div>				<?php 	if ($this->params->get('show_email_copy')){ ?>					<div class="control-group">						<div class="control-label"><?php echo $this->form->getLabel('contact_email_copy'); ?></div>						<div class="controls"><?php echo $this->form->getInput('contact_email_copy'); ?></div>					</div>				<?php 	} ?>			<?php //Dynamically load any additional fields from plugins. ?>			     <?php foreach ($this->form->getFieldsets() as $fieldset) : ?>			          <?php if ($fieldset->name != 'contact'):?>			               <?php $fields = $this->form->getFieldset($fieldset->name);?>			               <?php foreach ($fields as $field) : ?>			               	<div class="control-group">			                    <?php if ($field->hidden) : ?>			                    	<div class="controls">			                         <?php echo $field->input;?>			                        </div>			                    <?php else:?>			                         <div class="control-label">			                            <?php echo $field->label; ?>			                            <?php if (!$field->required && $field->type != "Spacer") : ?>			                               <span class="optional"><?php echo JText::_('COM_CONTACT_OPTIONAL');?></span>			                            <?php endif; ?>			                         </div>			                         <div class="controls"><?php echo $field->input;?></div>			                    <?php endif;?>			                   </div>			               <?php endforeach;?>			          <?php endif ?>			     <?php endforeach;?>				<div class="form-actions"><button class="btn btn-primary validate" type="submit"><?php echo JText::_('COM_CONTACT_CONTACT_SEND'); ?></button>					<input type="hidden" name="option" value="com_contact" />					<input type="hidden" name="task" value="contact.submit" />					<input type="hidden" name="return" value="<?php echo $this->return_page;?>" />					<input type="hidden" name="id" value="<?php echo $this->contact->slug; ?>" />					<?php echo JHtml::_('form.token'); ?>				</div>		</fieldset>	</form></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Menu Item List Model for Menus. * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class MenusModelItems extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id', 'a.id',				'menutype', 'a.menutype',				'title', 'a.title',				'alias', 'a.alias',				'published', 'a.published',				'access', 'a.access', 'access_level',				'language', 'a.language',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'lft', 'a.lft',				'rgt', 'a.rgt',				'level', 'a.level',				'path', 'a.path',				'client_id', 'a.client_id',				'home', 'a.home',			);			$app = JFactory::getApplication();			$assoc = isset($app->item_associations) ? $app->item_associations : 0;			if ($assoc)			{				$config['filter_fields'][] = 'association';			}		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @return  void	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		$search = $this->getUserStateFromRequest($this->context . '.search', 'filter_search');		$this->setState('filter.search', $search);		$published = $this->getUserStateFromRequest($this->context . '.published', 'filter_published', '');		$this->setState('filter.published', $published);		$access = $this->getUserStateFromRequest($this->context . '.filter.access', 'filter_access', 0, 'int');		$this->setState('filter.access', $access);		$parentId = $this->getUserStateFromRequest($this->context . '.filter.parent_id', 'filter_parent_id', 0, 'int');		$this->setState('filter.parent_id', $parentId);		$level = $this->getUserStateFromRequest($this->context . '.filter.level', 'filter_level', 0, 'int');		$this->setState('filter.level', $level);		$menuType = $app->input->getString('menutype', null);		if ($menuType)		{			if ($menuType != $app->getUserState($this->context . '.filter.menutype'))			{				$app->setUserState($this->context . '.filter.menutype', $menuType);				$app->input->set('limitstart', 0);			}		}		else		{			$menuType = $app->getUserState($this->context . '.filter.menutype');			if (!$menuType)			{				$menuType = $this->getDefaultMenuType();			}		}		$this->setState('filter.menutype', $menuType);		$language = $this->getUserStateFromRequest($this->context . '.filter.language', 'filter_language', '');		$this->setState('filter.language', $language);		// Component parameters.		$params = JComponentHelper::getParams('com_menus');		$this->setState('params', $params);		// List state information.		parent::populateState('a.lft', 'asc');	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id    A prefix for the store id.	 *	 * @return  string  A store id.	 * @since   1.6	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.access');		$id .= ':' . $this->getState('filter.published');		$id .= ':' . $this->getState('filter.language');		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.parent_id');		$id .= ':' . $this->getState('filter.menutype');		return parent::getStoreId($id);	}	/**	 * Finds the default menu type.	 *	 * In the absence of better information, this is the first menu ordered by title.	 *	 * @return  string    The default menu type	 * @since   1.6	 */	protected function getDefaultMenuType()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true)			->select('menutype')			->from('#__menu_types')			->order('title');		$db->setQuery($query, 0, 1);		$menuType = $db->loadResult();		return $menuType;	}	/**	 * Builds an SQL query to load the list data.	 *	 * @return  JDatabaseQuery    A query object.	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		$user = JFactory::getUser();		$app = JFactory::getApplication();		// Select all fields from the table.		$query->select(			$this->getState(				'list.select',				$db->quoteName(					array('a.id', 'a.menutype', 'a.title', 'a.alias', 'a.note', 'a.path', 'a.link', 'a.type', 'a.parent_id', 'a.level', 'a.published', 'a.component_id', 'a.checked_out', 'a.checked_out_time', 'a.browserNav', 'a.access', 'a.img', 'a.template_style_id', 'a.params', 'a.lft', 'a.rgt', 'a.home', 'a.language', 'a.client_id'),					array(null, null, null, null, null, null, null, null, null, null, 'apublished', null, null, null, null, null, null, null, null, null, null, null, null, null)				)			)		);		$query->select(			'CASE a.type' .				' WHEN ' . $db->quote('component') . ' THEN a.published+2*(e.enabled-1) ' .				' WHEN ' . $db->quote('url') . ' THEN a.published+2 ' .				' WHEN ' . $db->quote('alias') . ' THEN a.published+4 ' .				' WHEN ' . $db->quote('separator') . ' THEN a.published+6 ' .				' WHEN ' . $db->quote('heading') . ' THEN a.published+8 ' .				' END AS published'		);		$query->from($db->quoteName('#__menu') . ' AS a');		// Join over the language		$query->select('l.title AS language_title, l.image as image')			->join('LEFT', $db->quoteName('#__languages') . ' AS l ON l.lang_code = a.language');		// Join over the users.		$query->select('u.name AS editor')			->join('LEFT', $db->quoteName('#__users') . ' AS u ON u.id = a.checked_out');		//Join over components		$query->select('c.element AS componentname')			->join('LEFT', $db->quoteName('#__extensions') . ' AS c ON c.extension_id = a.component_id');		// Join over the asset groups.		$query->select('ag.title AS access_level')			->join('LEFT', '#__viewlevels AS ag ON ag.id = a.access');		// Join over the associations.		$assoc = isset($app->item_associations) ? $app->item_associations : 0;		if ($assoc)		{			$query->select('COUNT(asso2.id)>1 as association')				->join('LEFT', '#__associations AS asso ON asso.id = a.id AND asso.context=' . $db->quote('com_menus.item'))				->join('LEFT', '#__associations AS asso2 ON asso2.key = asso.key')				->group('a.id');		}		// Join over the extensions		$query->select('e.name AS name')			->join('LEFT', '#__extensions AS e ON e.extension_id = a.component_id');		// Exclude the root category.		$query->where('a.id > 1')			->where('a.client_id = 0');		// Filter on the published state.		$published = $this->getState('filter.published');		if (is_numeric($published))		{			$query->where('a.published = ' . (int) $published);		}		elseif ($published === '')		{			$query->where('(a.published IN (0, 1))');		}		// Filter by search in title, alias or id		if ($search = trim($this->getState('filter.search')))		{			if (stripos($search, 'id:') === 0)			{				$query->where('a.id = ' . (int) substr($search, 3));			}			elseif (stripos($search, 'link:') === 0)			{				if ($search = substr($search, 5))				{					$search = $db->quote('%' . $db->escape($search, true) . '%');					$query->where('a.link LIKE ' . $search);				}			}			else			{				$search = $db->quote('%' . $db->escape($search, true) . '%');				$query->where('(' . 'a.title LIKE ' . $search . ' OR a.alias LIKE ' . $search . ' OR a.note LIKE ' . $search . ')');			}		}		// Filter the items over the parent id if set.		$parentId = $this->getState('filter.parent_id');		if (!empty($parentId))		{			$query->where('p.id = ' . (int) $parentId);		}		// Filter the items over the menu id if set.		$menuType = $this->getState('filter.menutype');		if (!empty($menuType))		{			$query->where('a.menutype = ' . $db->quote($menuType));		}		// Filter on the access level.		if ($access = $this->getState('filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		// Implement View Level Access		if (!$user->authorise('core.admin'))		{			$groups = implode(',', $user->getAuthorisedViewLevels());			$query->where('a.access IN (' . $groups . ')');		}		// Filter on the level.		if ($level = $this->getState('filter.level'))		{			$query->where('a.level <= ' . (int) $level);		}		// Filter on the language.		if ($language = $this->getState('filter.language'))		{			$query->where('a.language = ' . $db->quote($language));		}		// Add the list ordering clause.		$query->order($db->escape($this->getState('list.ordering', 'a.lft')) . ' ' . $db->escape($this->getState('list.direction', 'ASC')));		//echo nl2br(str_replace('#__','jos_',(string)$query)).'<hr/>';		return $query;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Feed * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * RSS Feed Parser class. * * @package     Joomla.Platform * @subpackage  Feed * @link        http://cyber.law.harvard.edu/rss/rss.html * @since       12.3 */class JFeedParserRss extends JFeedParser{	/**	 * @var    string  The feed element name for the entry elements.	 * @since  12.3	 */	protected $entryElementName = 'item';	/**	 * @var    string  The feed format version.	 * @since  12.3	 */	protected $version;	/**	 * Method to handle the <category> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleCategory(JFeed $feed, SimpleXMLElement $el)	{		// Get the data from the element.		$domain    = (string) $el['domain'];		$category  = (string) $el;		$feed->addCategory($category, $domain);	}	/**	 * Method to handle the <cloud> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleCloud(JFeed $feed, SimpleXMLElement $el)	{		$cloud = new stdClass;		$cloud->domain            = (string) $el['domain'];		$cloud->port              = (string) $el['port'];		$cloud->path              = (string) $el['path'];		$cloud->protocol          = (string) $el['protocol'];		$cloud->registerProcedure = (string) $el['registerProcedure'];		$feed->cloud = $cloud;	}	/**	 * Method to handle the <copyright> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleCopyright(JFeed $feed, SimpleXMLElement $el)	{		$feed->copyright = (string) $el;	}	/**	 * Method to handle the <description> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleDescription(JFeed $feed, SimpleXMLElement $el)	{		$feed->description = (string) $el;	}	/**	 * Method to handle the <generator> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleGenerator(JFeed $feed, SimpleXMLElement $el)	{		$feed->generator = (string) $el;	}	/**	 * Method to handle the <image> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleImage(JFeed $feed, SimpleXMLElement $el)	{		// Create a feed link object for the image.		$image = new JFeedLink(			(string) $el->url,			null,			'logo',			null,			(string) $el->title		);		// Populate extra fields if they exist.		$image->link         = (string) $el->link;		$image->description  = (string) $el->description;		$image->height       = (string) $el->height;		$image->width        = (string) $el->width;		$feed->image = $image;	}	/**	 * Method to handle the <language> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleLanguage(JFeed $feed, SimpleXMLElement $el)	{		$feed->language = (string) $el;	}	/**	 * Method to handle the <lastBuildDate> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleLastBuildDate(JFeed $feed, SimpleXMLElement $el)	{		$feed->updatedDate = (string) $el;	}	/**	 * Method to handle the <link> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleLink(JFeed $feed, SimpleXMLElement $el)	{		$feed->uri = (string) $el;	}	/**	 * Method to handle the <managingEditor> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleManagingEditor(JFeed $feed, SimpleXMLElement $el)	{		$feed->author = $this->processPerson((string) $el);	}	/**	 * Method to handle the <skipDays> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleSkipDays(JFeed $feed, SimpleXMLElement $el)	{		// Initialise the array.		$days = array();		// Add all of the day values from the feed to the array.		foreach ($el->day as $day)		{			$days[] = (string) $day;		}		$feed->skipDays = $days;	}	/**	 * Method to handle the <skipHours> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleSkipHours(JFeed $feed, SimpleXMLElement $el)	{		// Initialise the array.		$hours = array();		// Add all of the day values from the feed to the array.		foreach ($el->hour as $hour)		{			$hours[] = (int) $hour;		}		$feed->skipHours = $hours;	}	/**	 * Method to handle the <pubDate> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handlePubDate(JFeed $feed, SimpleXMLElement $el)	{		$feed->publishedDate = (string) $el;	}	/**	 * Method to handle the <title> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleTitle(JFeed $feed, SimpleXMLElement $el)	{		$feed->title = (string) $el;	}	/**	 * Method to handle the <ttl> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleTtl(JFeed $feed, SimpleXMLElement $el)	{		$feed->ttl = (integer) $el;	}	/**	 * Method to handle the <webmaster> element for the feed.	 *	 * @param   JFeed             $feed  The JFeed object being built from the parsed feed.	 * @param   SimpleXMLElement  $el    The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function handleWebmaster(JFeed $feed, SimpleXMLElement $el)	{		// Get the tag contents and split it over the first space.		$tmp = (string) $el;		$tmp = explode(' ', $tmp, 2);		// This is really cheap parsing.  Probably need to create a method to do this more robustly.		$name = null;		if (isset($tmp[1]))		{			$name = trim($tmp[1], ' ()');		}		$email = trim($tmp[0]);		$feed->addContributor($name, $email, null, 'webmaster');	}	/**	 * Method to initialise the feed for parsing.  Here we detect the version and advance the stream	 * reader so that it is ready to parse feed elements.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function initialise()	{		// Read the version attribute.		$this->version = $this->stream->getAttribute('version');		// We want to move forward to the first element after the <channel> element.		$this->moveToNextElement('channel');		$this->moveToNextElement();	}	/**	 * Method to handle the feed entry element for the feed: <item>.	 *	 * @param   JFeedEntry        $entry  The JFeedEntry object being built from the parsed feed entry.	 * @param   SimpleXMLElement  $el     The current XML element object to handle.	 *	 * @return  void	 *	 * @since   12.3	 */	protected function processFeedEntry(JFeedEntry $entry, SimpleXMLElement $el)	{		$entry->uri           = (string) $el->link;		$entry->title         = (string) $el->title;		$entry->publishedDate = (string) $el->pubDate;		$entry->updatedDate   = (string) $el->pubDate;		$entry->content       = (string) $el->description;		$entry->guid          = (string) $el->guid;		$entry->comments      = (string) $el->comments;		// Add the feed entry author if available.		$author = (string) $el->author;		if (!empty($author))		{			$entry->author = $this->processPerson($author);		}		// Add any categories to the entry.		foreach ($el->category as $category)		{			$entry->addCategory((string) $category, (string) $category['domain']);		}		// Add any enclosures to the entry.		foreach ($el->enclosure as $enclosure)		{			$link = new JFeedLink(				(string) $enclosure['url'],				null,				(string) $enclosure['type'],				null,				null,				(int) $enclosure['length']			);			$entry->addLink($link);		}	}	/**	 * Method to parse a string with person data and return a JFeedPerson object.	 *	 * @param   string  $data  The string to parse for a person.	 *	 * @return  JFeedPerson	 *	 * @since   12.3	 */	protected function processPerson($data)	{		// Create a new person object.		$person = new JFeedPerson;		// This is really cheap parsing, but so far good enough. :)		$data = explode(' ', $data, 2);		if (isset($data[1]))		{			$person->name = trim($data[1], ' ()');		}		// Set the email for the person.		$person->email = trim($data[0]);		return $person;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Model for the display of system information. * * @package     Joomla.Administrator * @subpackage  com_admin * @since       1.6 */class AdminModelSysInfo extends JModelLegacy{	/**	 * @var array Some PHP settings	 * @since  1.6	 */	protected $php_settings = null;	/**	 * @var array Config values	 * @since  1.6	 */	protected $config = null;	/**	 * @var array Some system values	 * @since  1.6	 */	protected $info = null;	/**	 * @var string PHP info	 * @since  1.6	 */	protected $php_info = null;	/**	 * Information about writable state of directories	 *	 * @var array	 * @since  1.6	 */	protected $directories = null;	/**	 * The current editor.	 *	 * @var string	 * @since  1.6	 */	protected $editor = null;	/**	 * Method to get the ChangeLog	 *	 * @return array some php settings	 *	 * @since  1.6	 */	public function &getPhpSettings()	{		if (is_null($this->php_settings))		{			$this->php_settings = array();			$this->php_settings['safe_mode']			= ini_get('safe_mode') == '1';			$this->php_settings['display_errors']		= ini_get('display_errors') == '1';			$this->php_settings['short_open_tag']		= ini_get('short_open_tag') == '1';			$this->php_settings['file_uploads']			= ini_get('file_uploads') == '1';			$this->php_settings['magic_quotes_gpc']		= ini_get('magic_quotes_gpc') == '1';			$this->php_settings['register_globals']		= ini_get('register_globals') == '1';			$this->php_settings['output_buffering']		= (bool) ini_get('output_buffering');			$this->php_settings['open_basedir']			= ini_get('open_basedir');			$this->php_settings['session.save_path']	= ini_get('session.save_path');			$this->php_settings['session.auto_start']	= ini_get('session.auto_start');			$this->php_settings['disable_functions']	= ini_get('disable_functions');			$this->php_settings['xml']					= extension_loaded('xml');			$this->php_settings['zlib']					= extension_loaded('zlib');			$this->php_settings['zip']					= function_exists('zip_open') && function_exists('zip_read');			$this->php_settings['mbstring']				= extension_loaded('mbstring');			$this->php_settings['iconv']				= function_exists('iconv');		}		return $this->php_settings;	}	/**	 * Method to get the config	 *	 * @return  array  config values	 *	 * @since  1.6	 */	public function &getConfig()	{		if (is_null($this->config))		{			$registry = new JRegistry(new JConfig);			$this->config = $registry->toArray();			$hidden = array('host', 'user', 'password', 'ftp_user', 'ftp_pass', 'smtpuser', 'smtppass');			foreach ($hidden as $key)			{				$this->config[$key] = 'xxxxxx';			}		}		return $this->config;	}	/**	 * Method to get the system information	 *	 * @return  array system information values	 *	 * @since   1.6	 */	public function &getInfo()	{		if (is_null($this->info))		{			$this->info = array();			$version = new JVersion;			$platform = new JPlatform;			$db = JFactory::getDbo();			if (isset($_SERVER['SERVER_SOFTWARE']))			{				$sf = $_SERVER['SERVER_SOFTWARE'];			}			else {				$sf = getenv('SERVER_SOFTWARE');			}			$this->info['php']			= php_uname();			$this->info['dbversion']	= $db->getVersion();			$this->info['dbcollation']	= $db->getCollation();			$this->info['phpversion']	= phpversion();			$this->info['server']		= $sf;			$this->info['sapi_name']	= php_sapi_name();			$this->info['version']		= $version->getLongVersion();			$this->info['platform']		= $platform->getLongVersion();			$this->info['useragent']	= $_SERVER['HTTP_USER_AGENT'];		}		return $this->info;	}	/**	 * Method to get the PHP info	 *	 * @return  string PHP info	 *	 * @since  1.6	 */	public function &getPHPInfo()	{		if (is_null($this->php_info))		{			ob_start();			date_default_timezone_set('UTC');			phpinfo(INFO_GENERAL | INFO_CONFIGURATION | INFO_MODULES);			$phpinfo = ob_get_contents();			ob_end_clean();			preg_match_all('#<body[^>]*>(.*)</body>#siU', $phpinfo, $output);			$output = preg_replace('#<table[^>]*>#', '<table class="table table-striped adminlist">', $output[1][0]);			$output = preg_replace('#(\w),(\w)#', '\1, \2', $output);			$output = preg_replace('#<hr />#', '', $output);			$output = str_replace('<div class="center">', '', $output);			$output = preg_replace('#<tr class="h">(.*)<\/tr>#', '<thead><tr class="h">$1</tr></thead><tbody>', $output);			$output = str_replace('</table>', '</tbody></table>', $output);			$output = str_replace('</div>', '', $output);			$this->php_info = $output;		}		return $this->php_info;	}	/**	 * Method to get the directory states	 *	 * @return array States of directories	 *	 * @since  1.6	 */	public function getDirectory()	{		if (is_null($this->directories))		{			$this->directories = array();			$registry = JFactory::getConfig();			$cparams = JComponentHelper::getParams('com_media');			$this->_addDirectory('administrator/components', JPATH_ADMINISTRATOR . '/components');			$this->_addDirectory('administrator/language', JPATH_ADMINISTRATOR . '/language');			// List all admin languages			$admin_langs = new DirectoryIterator(JPATH_ADMINISTRATOR . '/language');			foreach ($admin_langs as $alang)			{				if (!$alang->isDir() || $alang->isDot())				{					continue;				}				$name = $alang->getFilename();				$this->_addDirectory('administrator/language/' . $name, JPATH_ADMINISTRATOR . '/language/' . $name);			}			// List all manifests folders			$manifests = new DirectoryIterator(JPATH_ADMINISTRATOR . '/manifests');			foreach ($manifests as $manifest)			{				if (!$manifest->isDir() || $manifest->isDot())				{					continue;				}				$name = $manifest->getFilename();				$this->_addDirectory('administrator/manifests/' . $name, JPATH_ADMINISTRATOR . '/manifests/' . $name);			}			$this->_addDirectory('administrator/modules', JPATH_ADMINISTRATOR . '/modules');			$this->_addDirectory('administrator/templates', JPATH_THEMES);			$this->_addDirectory('components', JPATH_SITE . '/components');			$this->_addDirectory($cparams->get('image_path'), JPATH_SITE . '/' . $cparams->get('image_path'));			// List all images folders			$image_folders = new DirectoryIterator(JPATH_SITE . '/' . $cparams->get('image_path'));			foreach ($image_folders as $folder)			{				if (!$folder->isDir() || $folder->isDot())				{					continue;				}				$name = $manifest->getFilename();				$this->_addDirectory('images/' . $name, JPATH_SITE . '/' . $cparams->get('image_path') . '/' . $name);			}			$this->_addDirectory('language', JPATH_SITE . '/language');			// List all site languages			$site_langs = new DirectoryIterator(JPATH_SITE . '/language');			foreach ($site_langs as $alang)			{				if (!$alang->isDir() || $alang->isDot())				{					continue;				}				$name = $alang->getFilename();				$this->_addDirectory('language/' . $name, JPATH_SITE . '/language/' . $name);			}			$this->_addDirectory('libraries', JPATH_LIBRARIES);			$this->_addDirectory('media', JPATH_SITE . '/media');			$this->_addDirectory('modules', JPATH_SITE . '/modules');			$this->_addDirectory('plugins', JPATH_PLUGINS);			$plugin_groups = new DirectoryIterator(JPATH_SITE . '/language');			foreach ($plugin_groups as $folder)			{				if (!$alang->isDir() || $alang->isDot())				{					continue;				}				$name = $alang->getFilename();				$this->_addDirectory('plugins/' . $name, JPATH_PLUGINS . '/' . $name);			}			$this->_addDirectory('templates', JPATH_SITE . '/templates');			$this->_addDirectory('configuration.php', JPATH_CONFIGURATION . '/configuration.php');			$this->_addDirectory('cache', JPATH_SITE.'/cache', 'COM_ADMIN_CACHE_DIRECTORY');			$this->_addDirectory('administrator/cache', JPATH_CACHE, 'COM_ADMIN_CACHE_DIRECTORY');			$this->_addDirectory($registry->get('log_path', JPATH_ROOT . '/log'), $registry->get('log_path', JPATH_ROOT . '/log'), 'COM_ADMIN_LOG_DIRECTORY');			$this->_addDirectory($registry->get('tmp_path', JPATH_ROOT . '/tmp'), $registry->get('tmp_path', JPATH_ROOT . '/tmp'), 'COM_ADMIN_TEMP_DIRECTORY');		}		return $this->directories;	}	/**	 * Method to add a directory	 *	 * @return void	 * @since  1.6	 */	private function _addDirectory($name, $path, $message = '')	{		$this->directories[$name] = array('writable' => is_writable($path), 'message' => $message);	}	/**	 * Method to get the editor	 *	 * @return  string The default editor	 *	 * @note: has to be removed (it is present in the config...)	 *	 * @since  1.6	 */	public function &getEditor()	{		if (is_null($this->editor))		{			$config = JFactory::getConfig();			$this->editor = $config->get('editor');		}		return $this->editor;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_media * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('bootstrap.tooltip');$user = JFactory::getUser();$params = new JRegistry;$dispatcher	= JEventDispatcher::getInstance();$dispatcher->trigger('onContentBeforeDisplay', array('com_media.file', &$this->_tmp_doc, &$params));?>		<tr>			<td>				<a  title="<?php echo $this->_tmp_doc->name; ?>">					<?php  echo JHtml::_('image', $this->_tmp_doc->icon_16, $this->_tmp_doc->title, null, true, true) ? JHtml::_('image', $this->_tmp_doc->icon_16, $this->_tmp_doc->title, array('width' => 16, 'height' => 16), true) : JHtml::_('image', 'media/con_info.png', $this->_tmp_doc->title, array('width' => 16, 'height' => 16), true);?> </a>			</td>			<td class="description"  title="<?php echo $this->_tmp_doc->name; ?>">				<?php echo $this->_tmp_doc->title; ?>			</td>			<td>&#160;			</td>			<td class="filesize">				<?php echo JHtml::_('number.bytes', $this->_tmp_doc->size); ?>			</td>		<?php if ($user->authorise('core.delete', 'com_media')):?>			<td>				<a class="delete-item" target="_top" href="index.php?option=com_media&amp;task=file.delete&amp;tmpl=index&amp;<?php echo JSession::getFormToken(); ?>=1&amp;folder=<?php echo $this->state->folder; ?>&amp;rm[]=<?php echo $this->_tmp_doc->name; ?>" rel="<?php echo $this->_tmp_doc->name; ?>"><i class="icon-remove hasTooltip" title="<?php echo JText::_('JACTION_DELETE');?>"></i></a>				<input type="checkbox" name="rm[]" value="<?php echo $this->_tmp_doc->name; ?>" />			</td>		<?php endif;?>		</tr><?php$dispatcher->trigger('onContentAfterDisplay', array('com_media.file', &$this->_tmp_doc, &$params));?>
<?php/** * @package     Joomla.Platform * @subpackage  MediaWiki * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * MediaWiki API Categories class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  MediaWiki * @since       12.3 */class JMediawikiCategories extends JMediawikiObject{	/**     * Method to list all categories the page(s) belong to.     *     * @param   array    $titles        Page titles to retrieve categories.     * @param   array    $clprop        List of additional properties to get.     * @param   array    $clshow        Type of categories to show.     * @param   integer  $cllimit       Number of categories to return.     * @param   boolean  $clcontinue    Continue when more results are available.     * @param   array    $clcategories  Only list these categories.     * @param   string   $cldir         Direction of listing.     *     * @return  object     *     * @since   12.1     */	public function getCategories(array $titles, array $clprop = null, array $clshow = null, $cllimit = null, $clcontinue = false,		array $clcategories = null, $cldir = null)	{		// Build the request.		$path = '?action=query&prop=categories';		// Append titles to the request.		$path .= '&titles=' . $this->buildParameter($titles);		if (isset($clprop))		{			$path .= '&clprop=' . $this->buildParameter($clprop);		}		if (isset($clshow))		{			$path .= '&$clshow=' . $this->buildParameter($clshow);		}		if (isset($cllimit))		{			$path .= '&cllimit=' . $cllimit;		}		if ($clcontinue)		{			$path .= '&clcontinue=';		}		if (isset($clcategories))		{			$path .= '&clcategories=' . $this->buildParameter($clcategories);		}		if (isset($cldir))		{			$path .= '&cldir=' . $cldir;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get information about all categories used.     *     * @param   array  $titles  Page titles to retrieve categories.     *     * @return  object     *     * @since   12.3     */	public function getCategoriesUsed(array $titles)	{		// Build the request		$path = '?action=query&generator=categories&prop=info';		// Append titles to the request		$path .= '&titles=' . $this->buildParameter($titles);		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get information about the given categories.     *     * @param   array    $titles      Page titles to retrieve categories.     * @param   boolean  $clcontinue  Continue when more results are available.     *     * @return  object     *     * @since   12.3     */	public function getCategoriesInfo(array $titles, $clcontinue = false)	{		// Build the request.		$path = '?action=query&prop=categoryinfo';		// Append titles to the request		$path .= '&titles=' . $this->buildParameter($titles);		if ($clcontinue)		{			$path .= '&clcontinue=';		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to enumerate all categories.     *     * @param   string   $acfrom    The category to start enumerating from.     * @param   string   $acto      The category to stop enumerating at.     * @param   string   $acprefix  Search for all category titles that begin with this value.     * @param   string   $acdir     Direction to sort in.     * @param   integer  $acmin     Minimum number of category members.     * @param   integer  $acmax     Maximum number of category members.     * @param   integer  $aclimit   How many categories to return.     * @param   array    $acprop    Which properties to get.     *     * @return  object     *     * @since   12.3     */	public function enumerateCategories($acfrom = null, $acto = null, $acprefix = null, $acdir = null, $acmin = null,		$acmax = null, $aclimit = null, array $acprop = null)	{		// Build the request.		$path = '?action=query&list=allcategories';		if (isset($acfrom))		{			$path .= '&acfrom=' . $acfrom;		}		if (isset($acto))		{			$path .= '&acto=' . $acto;		}		if (isset($acprefix))		{			$path .= '&acprefix=' . $acprefix;		}		if (isset($acdir))		{			$path .= '&acdir=' . $acdir;		}		if (isset($acfrom))		{			$path .= '&acfrom=' . $acfrom;		}		if (isset($acmin))		{			$path .= '&acmin=' . $acmin;		}		if (isset($acmax))		{			$path .= '&acmax=' . $acmax;		}		if (isset($aclimit))		{			$path .= '&aclimit=' . $aclimit;		}		if (isset($acprop))		{			$path .= '&acprop=' . $this->buildParameter($acprop);		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to list change tags.     *     * @param   array   $tgprop   List of properties to get.     * @param   string  $tglimit  The maximum number of tags to limit.     *     * @return  object     *     * @since   12.3     */	public function getChangeTags(array $tgprop = null, $tglimit = null)	{		// Build the request.		$path = '?action=query&list=tags';		if (isset($tgprop))		{			$path .= '&tgprop=' . $this->buildParameter($tgprop);		}		if (isset($tglimit))		{			$path .= '&tglimit=' . $tglimit;		}		// @TODO add support for $tgcontinue		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_templates * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Template styles list controller class. * * @package     Joomla.Administrator * @subpackage  com_templates * @since       1.6 */class TemplatesControllerStyles extends JControllerAdmin{	/**	 * Method to clone and existing template style.	 */	public function duplicate()	{		// Check for request forgeries		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$pks = $this->input->post->get('cid', array(), 'array');		try		{			if (empty($pks))			{				throw new Exception(JText::_('COM_TEMPLATES_NO_TEMPLATE_SELECTED'));			}			JArrayHelper::toInteger($pks);			$model = $this->getModel();			$model->duplicate($pks);			$this->setMessage(JText::_('COM_TEMPLATES_SUCCESS_DUPLICATED'));		}		catch (Exception $e)		{			JError::raiseWarning(500, $e->getMessage());		}		$this->setRedirect('index.php?option=com_templates&view=styles');	}	/**	 * Proxy for getModel.	 *	 * @since   1.6	 */	public function getModel($name = 'Style', $prefix = 'TemplatesModel', $config = array())	{		$model = parent::getModel($name, $prefix, array('ignore_request' => true));		return $model;	}	/**	 * Method to set the home template for a client.	 *	 * @since   1.6	 */	public function setDefault()	{		// Check for request forgeries		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$pks = $this->input->post->get('cid', array(), 'array');		try		{			if (empty($pks))			{				throw new Exception(JText::_('COM_TEMPLATES_NO_TEMPLATE_SELECTED'));			}			JArrayHelper::toInteger($pks);			// Pop off the first element.			$id = array_shift($pks);			$model = $this->getModel();			$model->setHome($id);			$this->setMessage(JText::_('COM_TEMPLATES_SUCCESS_HOME_SET'));		}		catch (Exception $e)		{			JError::raiseWarning(500, $e->getMessage());		}		$this->setRedirect('index.php?option=com_templates&view=styles');	}	/**	 * Method to unset the default template for a client and for a language	 *	 * @since   1.6	 */	public function unsetDefault()	{		// Check for request forgeries		JSession::checkToken('request') or jexit(JText::_('JINVALID_TOKEN'));		$pks = $this->input->get->get('cid', array(), 'array');		JArrayHelper::toInteger($pks);		try		{			if (empty($pks))			{				throw new Exception(JText::_('COM_TEMPLATES_NO_TEMPLATE_SELECTED'));			}			// Pop off the first element.			$id = array_shift($pks);			$model = $this->getModel();			$model->unsetHome($id);			$this->setMessage(JText::_('COM_TEMPLATES_SUCCESS_HOME_UNSET'));		}		catch (Exception $e)		{			JError::raiseWarning(500, $e->getMessage());		}		$this->setRedirect('index.php?option=com_templates&view=styles');	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('formbehavior.chosen', 'select');$canDo = UsersHelper::getActions();?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'group.cancel' || document.formvalidator.isValid(document.id('group-form')))		{			Joomla.submitform(task, document.getElementById('group-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_users&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="group-form" class="form-validate form-horizontal">	<fieldset>		<legend><?php echo JText::_('COM_USERS_USERGROUP_DETAILS');?></legend>		<div class="control-group">			<div class="control-label">				<?php echo $this->form->getLabel('title'); ?>			</div>			<div class="controls">				<?php echo $this->form->getInput('title'); ?>			</div>		</div>		<div class="control-group">			<?php $parent_id = $this->form->getField('parent_id');?>			<?php if (!$parent_id->hidden) : ?>				<div class="control-label">					<?php echo $parent_id->label; ?>				</div>			<?php endif;?>			<div class="controls">				<?php echo $parent_id->input; ?>			</div>		</div>	</fieldset>	<input type="hidden" name="task" value="" />	<?php echo JHtml::_('form.token'); ?></form>
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;JFormHelper::loadFieldClass('list');/** * Form Field class for the Joomla Platform. * Provides a list of access levels. Access levels control what users in specific * groups can see. * * @package     Joomla.Platform * @subpackage  Form * @see         JAccess * @since       11.1 */class JFormFieldAccessLevel extends JFormFieldList{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	public $type = 'AccessLevel';	/**	 * Method to get the field input markup.	 *	 * @return  string   The field input markup.	 *	 * @since   11.1	 */	protected function getInput()	{		$attr = '';		// Initialize some field attributes.		$attr .= $this->element['class'] ? ' class="' . (string) $this->element['class'] . '"' : '';		$attr .= ((string) $this->element['disabled'] == 'true') ? ' disabled="disabled"' : '';		$attr .= $this->element['size'] ? ' size="' . (int) $this->element['size'] . '"' : '';		$attr .= $this->multiple ? ' multiple="multiple"' : '';		$attr .= $this->required ? ' required="required" aria-required="true"' : '';		// Initialize JavaScript field attributes.		$attr .= $this->element['onchange'] ? ' onchange="' . (string) $this->element['onchange'] . '"' : '';		// Get the field options.		$options = $this->getOptions();		return JHtml::_('access.level', $this->name, $this->value, $attr, $options, $this->id);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Modules Component Module Model * * @package     Joomla.Administrator * @subpackage  com_modules * @since       1.5 */class ModulesModelModules extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id', 'a.id',				'title', 'a.title',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'published', 'a.published',				'access', 'a.access', 'access_level',				'ordering', 'a.ordering',				'module', 'a.module',				'language', 'a.language', 'language_title',				'publish_up', 'a.publish_up',				'publish_down', 'a.publish_down',				'client_id', 'a.client_id',				'position', 'a.position',				'pages',				'name', 'e.name',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $search);		$accessId = $this->getUserStateFromRequest($this->context . '.filter.access', 'filter_access', null, 'int');		$this->setState('filter.access', $accessId);		$state = $this->getUserStateFromRequest($this->context . '.filter.state', 'filter_state', '', 'string');		$this->setState('filter.state', $state);		$position = $this->getUserStateFromRequest($this->context . '.filter.position', 'filter_position', '', 'string');		$this->setState('filter.position', $position);		$module = $this->getUserStateFromRequest($this->context . '.filter.module', 'filter_module', '', 'string');		$this->setState('filter.module', $module);		$clientId = $this->getUserStateFromRequest($this->context . '.filter.client_id', 'filter_client_id', 0, 'int', false);		$previousId = $app->getUserState($this->context . '.filter.client_id_previous', null);		if ($previousId != $clientId || $previousId === null)		{			$this->getUserStateFromRequest($this->context . '.filter.client_id_previous', 'filter_client_id_previous', 0, 'int', true);			$app->setUserState($this->context . '.filter.client_id_previous', $clientId);		}		$this->setState('filter.client_id', $clientId);		$language = $this->getUserStateFromRequest($this->context . '.filter.language', 'filter_language', '');		$this->setState('filter.language', $language);		// Load the parameters.		$params = JComponentHelper::getParams('com_modules');		$this->setState('params', $params);		// List state information.		parent::populateState('position', 'asc');	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string    A prefix for the store id.	 *	 * @return  string    A store id.	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.access');		$id .= ':' . $this->getState('filter.state');		$id .= ':' . $this->getState('filter.position');		$id .= ':' . $this->getState('filter.module');		$id .= ':' . $this->getState('filter.client_id');		$id .= ':' . $this->getState('filter.language');		return parent::getStoreId($id);	}	/**	 * Returns an object list	 *	 * @param   string The query	 * @param   int    Offset	 * @param   int    The number of records	 * @return  array	 */	protected function _getList($query, $limitstart = 0, $limit = 0)	{		$ordering = $this->getState('list.ordering', 'ordering');		if (in_array($ordering, array('pages', 'name')))		{			$this->_db->setQuery($query);			$result = $this->_db->loadObjectList();			$this->translate($result);			$lang = JFactory::getLanguage();			JArrayHelper::sortObjects($result, $ordering, $this->getState('list.direction') == 'desc' ? -1 : 1, true, $lang->getLocale());			$total = count($result);			$this->cache[$this->getStoreId('getTotal')] = $total;			if ($total < $limitstart)			{				$limitstart = 0;				$this->setState('list.start', 0);			}			return array_slice($result, $limitstart, $limit ? $limit : null);		}		else		{			if ($ordering == 'ordering')			{				$query->order('a.position ASC');				$ordering = 'a.ordering';			}			if ($ordering == 'language_title')			{				$ordering = 'l.title';			}			$query->order($this->_db->quoteName($ordering) . ' ' . $this->getState('list.direction'));			if ($ordering == 'position')			{				$query->order('a.ordering ASC');			}			$result = parent::_getList($query, $limitstart, $limit);			$this->translate($result);			return $result;		}	}	/**	 * Translate a list of objects	 *	 * @param   array The array of objects	 * @return  array The array of translated objects	 */	protected function translate(&$items)	{		$lang = JFactory::getLanguage();		$client = $this->getState('filter.client_id') ? 'administrator' : 'site';		foreach ($items as $item)		{			$extension = $item->module;			$source = constant('JPATH_' . strtoupper($client)) . "/modules/$extension";			$lang->load("$extension.sys", constant('JPATH_' . strtoupper($client)), null, false, false)				|| $lang->load("$extension.sys", $source, null, false, false)				|| $lang->load("$extension.sys", constant('JPATH_' . strtoupper($client)), $lang->getDefault(), false, false)				|| $lang->load("$extension.sys", $source, $lang->getDefault(), false, false);			$item->name = JText::_($item->name);			if (is_null($item->pages))			{				$item->pages = JText::_('JNONE');			}			elseif ($item->pages < 0)			{				$item->pages = JText::_('COM_MODULES_ASSIGNED_VARIES_EXCEPT');			}			elseif ($item->pages > 0)			{				$item->pages = JText::_('COM_MODULES_ASSIGNED_VARIES_ONLY');			}			else			{				$item->pages = JText::_('JALL');			}		}	}	/**	 * Build an SQL query to load the list data.	 *	 * @return  JDatabaseQuery	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		// Select the required fields from the table.		$query->select(			$this->getState(				'list.select',				'a.id, a.title, a.note, a.position, a.module, a.language,' .					'a.checked_out, a.checked_out_time, a.published+2*(e.enabled-1) as published, a.access, a.ordering, a.publish_up, a.publish_down'			)		);		$query->from($db->quoteName('#__modules') . ' AS a');		// Join over the language		$query->select('l.title AS language_title')			->join('LEFT', $db->quoteName('#__languages') . ' AS l ON l.lang_code = a.language');		// Join over the users for the checked out user.		$query->select('uc.name AS editor')			->join('LEFT', '#__users AS uc ON uc.id=a.checked_out');		// Join over the asset groups.		$query->select('ag.title AS access_level')			->join('LEFT', '#__viewlevels AS ag ON ag.id = a.access');		// Join over the module menus		$query->select('MIN(mm.menuid) AS pages')			->join('LEFT', '#__modules_menu AS mm ON mm.moduleid = a.id');		// Join over the extensions		$query->select('e.name AS name')			->join('LEFT', '#__extensions AS e ON e.element = a.module')			->group(				'a.id, a.title, a.note, a.position, a.module, a.language,a.checked_out,' .					'a.checked_out_time, a.published, a.access, a.ordering,l.title, uc.name, ag.title, e.name,' .					'l.lang_code, uc.id, ag.id, mm.moduleid, e.element, a.publish_up, a.publish_down,e.enabled'			);		// Filter by access level.		if ($access = $this->getState('filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		// Filter by published state		$state = $this->getState('filter.state');		if (is_numeric($state))		{			$query->where('a.published = ' . (int) $state);		}		elseif ($state === '')		{			$query->where('(a.published IN (0, 1))');		}		// Filter by position		$position = $this->getState('filter.position');		if ($position && $position != 'none')		{			$query->where('a.position = ' . $db->quote($position));		}		elseif ($position == 'none')		{			$query->where('a.position = ' . $db->quote(''));		}		// Filter by module		$module = $this->getState('filter.module');		if ($module)		{			$query->where('a.module = ' . $db->quote($module));		}		// Filter by client.		$clientId = $this->getState('filter.client_id');		if (is_numeric($clientId))		{			$query->where('a.client_id = ' . (int) $clientId . ' AND e.client_id =' . (int) $clientId);		}		// Filter by search in title		$search = $this->getState('filter.search');		if (!empty($search))		{			if (stripos($search, 'id:') === 0)			{				$query->where('a.id = ' . (int) substr($search, 3));			}			else			{				$search = $db->quote('%' . $db->escape($search, true) . '%');				$query->where('(' . 'a.title LIKE ' . $search . ' OR a.note LIKE ' . $search . ')');			}		}		// Filter on the language.		if ($language = $this->getState('filter.language'))		{			$query->where('a.language = ' . $db->quote($language));		}		//echo nl2br(str_replace('#__','jos_',$query));		return $query;	}}
<?php/** * @package     Joomla.Platform * @subpackage  MediaWiki * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * MediaWiki API Links class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  MediaWiki * @since       12.3 */class JMediawikiLinks extends JMediawikiObject{	/**     * Method to return all links from the given page(s).     *     * @param   array   $titles       Page titles to retrieve links.     * @param   array   $plnamespace  Namespaces to get links.     * @param   string  $pllimit      Number of links to return.     * @param   string  $plcontinue   Continue when more results are available.     * @param   array   $pltitles     List links to these titles.     * @param   string  $pldir        Direction of listing.     *     * @return  object     *     * @since   12.3     */	public function getLinks(array $titles, array $plnamespace = null, $pllimit = null, $plcontinue = null, array $pltitles = null, $pldir = null)	{		// Build the request.		$path = '?action=query&prop=links';		// Append titles to the request.		$path .= '&titles=' . $this->buildParameter($titles);		if (isset($plnamespace))		{			$path .= '&plnamespace=' . $this->buildParameter($plnamespace);		}		if (isset($pllimit))		{			$path .= '&pllimit=' . $pllimit;		}		if (isset($plcontinue))		{			$path .= '&plcontinue=' . $plcontinue;		}		if (isset($pltitles))		{			$path .= '&pltitles=' . $this->buildParameter($pltitles);		}		if (isset($pldir))		{			$path .= '&pldir=' . $pldir;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to return info about the link pages.     *     * @param   array  $titles  Page titles to retrieve links.     *     * @return  object     *     * @since   12.3     */	public function getLinksUsed(array $titles)	{		// Build the request.		$path = '?action=query&generator=links&prop=info';		// Append titles to the request.		$path .= '&titles=' . $this->buildParameter($titles);		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to return all interwiki links from the given page(s).     *     * @param   array    $titles      Page titles to retrieve links.     * @param   boolean  $iwurl       Whether to get the full url.     * @param   integer  $iwlimit     Number of interwiki links to return.     * @param   boolean  $iwcontinue  When more results are available, use this to continue.     * @param   string   $iwprefix    Prefix for the interwiki.     * @param   string   $iwtitle     Interwiki link to search for.     * @param   string   $iwdir       The direction in which to list.     *     * @return  object     *     * @since   12.3     */	public function getIWLinks(array $titles, $iwurl = false, $iwlimit = null, $iwcontinue = false, $iwprefix = null, $iwtitle = null, $iwdir = null)	{		// Build the request.		$path = '?action=query&prop=links';		// Append titles to the request.		$path .= '&titles=' . $this->buildParameter($titles);		if ($iwurl)		{			$path .= '&iwurl=';		}		if (isset($iwlimit))		{			$path .= '&iwlimit=' . $iwlimit;		}		if ($iwcontinue)		{			$path .= '&iwcontinue=';		}		if (isset($iwprefix))		{			$path .= '&iwprefix=' . $iwprefix;		}		if (isset($iwtitle))		{			$path .= '&iwtitle=' . $iwtitle;		}		if (isset($iwdir))		{			$path .= '&iwdir=' . $iwdir;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to return all interlanguage links from the given page(s).     *     * @param   array    $titles      Page titles to retrieve links.     * @param   integer  $lllimit     Number of langauge links to return.     * @param   boolean  $llcontinue  When more results are available, use this to continue.     * @param   string   $llurl       Whether to get the full URL.     * @param   string   $lllang      Language code.     * @param   string   $lltitle     Link to search for.     * @param   string   $lldir       The direction in which to list.     *     * @return  object     *     * @since   12.3     */	public function getLangLinks(array $titles, $lllimit = null, $llcontinue = false, $llurl = null, $lllang = null, $lltitle = null, $lldir = null)	{		// Build the request.		$path = '?action=query&prop=langlinks';		// Append titles to the request.		$path .= '&titles=' . $this->buildParameter($titles);		if (isset($lllimit))		{			$path .= '&lllimit=' . $lllimit;		}		if ($llcontinue)		{			$path .= '&llcontinue=';		}		if (isset($llurl))		{			$path .= '&llurl=' . $llurl;		}		if (isset($lllang))		{			$path .= '&lllang=' . $lllang;		}		if (isset($lltitle))		{			$path .= '&lltitle=' . $lltitle;		}		if (isset($lldir))		{			$path .= '&lldir=' . $lldir;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to return all external urls from the given page(s).     *     * @param   array    $titles      Page titles to retrieve links.     * @param   integer  $ellimit     Number of links to return.     * @param   string   $eloffset    When more results are available, use this to continue.     * @param   string   $elprotocol  Protocol of the url.     * @param   string   $elquery     Search string without protocol.     *     * @return  object     *     * @since   12.3     */	public function getExtLinks(array $titles, $ellimit = null, $eloffset = null, $elprotocol = null, $elquery = null)	{		// Build the request.		$path = '?action=query&prop=extlinks';		// Append titles to the request.		$path .= '&titles=' . $this->buildParameter($titles);		if (isset($ellimit))		{			$path .= '&ellimit=' . $ellimit;		}		if (isset($eloffset))		{			$path .= '&eloffset=' . $eloffset;		}		if (isset($elprotocol))		{			$path .= '&elprotocol=' . $elprotocol;		}		if (isset($elquery))		{			$path .= '&elquery=' . $elquery;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to enumerate all links that point to a given namespace.     *     * @param   boolean  $alcontinue   When more results are available, use this to continue.     * @param   string   $alfrom       Start listing at this title. The title need not exist.     * @param   string   $alto         The page title to stop enumerating at.     * @param   string   $alprefix     Search for all page titles that begin with this value.     * @param   string   $alunique     Only show unique links.     * @param   array    $alprop       What pieces of information to include.     * @param   string   $alnamespace  The namespace to enumerate.     * @param   integer  $allimit      Number of links to return.     *     * @return  object     *     * @since   12.3     */	public function enumerateLinks($alcontinue = false, $alfrom = null, $alto = null, $alprefix = null, $alunique = null, array $alprop = null,		$alnamespace = null, $allimit = null)	{		// Build the request.		$path = '?action=query&meta=siteinfo';		if ($alcontinue)		{			$path .= '&alcontinue=';		}		if (isset($alfrom))		{			$path .= '&alfrom=' . $alfrom;		}		if (isset($alto))		{			$path .= '&alto=' . $alto;		}		if (isset($alprefix))		{			$path .= '&alprefix=' . $alprefix;		}		if (isset($alunique))		{			$path .= '&alunique=' . $alunique;		}		if (isset($alprop))		{			$path .= '&alprop=' . $this->buildParameter($alprop);		}		if (isset($alnamespace))		{			$path .= '&alnamespace=' . $alnamespace;		}		if (isset($allimit))		{			$path .= '&allimit=' . $allimit;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}}
<?php/** * @package     Joomla.Platform * @subpackage  Database * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * MySQLi database driver * * @package     Joomla.Platform * @subpackage  Database * @see         http://php.net/manual/en/book.mysqli.php * @since       12.1 */class JDatabaseDriverMysqli extends JDatabaseDriver{	/**	 * The name of the database driver.	 *	 * @var    string	 * @since  12.1	 */	public $name = 'mysqli';	/**	 * The character(s) used to quote SQL statement names such as table names or field names,	 * etc. The child classes should define this as necessary.  If a single character string the	 * same character is used for both sides of the quoted name, else the first character will be	 * used for the opening quote and the second for the closing quote.	 *	 * @var    string	 * @since  12.2	 */	protected $nameQuote = '`';	/**	 * The null or zero representation of a timestamp for the database driver.  This should be	 * defined in child classes to hold the appropriate value for the engine.	 *	 * @var    string	 * @since  12.2	 */	protected $nullDate = '0000-00-00 00:00:00';	/**	 * @var    string  The minimum supported database version.	 * @since  12.2	 */	protected static $dbMinimum = '5.0.4';	/**	 * Constructor.	 *	 * @param   array  $options  List of options used to configure the connection	 *	 * @since   12.1	 */	public function __construct($options)	{		// Get some basic values from the options.		$options['host'] = (isset($options['host'])) ? $options['host'] : 'localhost';		$options['user'] = (isset($options['user'])) ? $options['user'] : 'root';		$options['password'] = (isset($options['password'])) ? $options['password'] : '';		$options['database'] = (isset($options['database'])) ? $options['database'] : '';		$options['select'] = (isset($options['select'])) ? (bool) $options['select'] : true;		$options['port'] = null;		$options['socket'] = null;		// Finalize initialisation.		parent::__construct($options);	}	/**	 * Destructor.	 *	 * @since   12.1	 */	public function __destruct()	{		if (is_callable(array($this->connection, 'close')))		{			mysqli_close($this->connection);		}	}	/**	 * Connects to the database if needed.	 *	 * @return  void  Returns void if the database connected successfully.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function connect()	{		if ($this->connection)		{			return;		}		/*		 * Unlike mysql_connect(), mysqli_connect() takes the port and socket as separate arguments. Therefore, we		 * have to extract them from the host string.		 */		$tmp = substr(strstr($this->options['host'], ':'), 1);		if (!empty($tmp))		{			// Get the port number or socket name			if (is_numeric($tmp))			{				$this->options['port'] = $tmp;			}			else			{				$this->options['socket'] = $tmp;			}			// Extract the host name only			$this->options['host'] = substr($this->options['host'], 0, strlen($this->options['host']) - (strlen($tmp) + 1));			// This will take care of the following notation: ":3306"			if ($this->options['host'] == '')			{				$this->options['host'] = 'localhost';			}		}		// Make sure the MySQLi extension for PHP is installed and enabled.		if (!function_exists('mysqli_connect'))		{			throw new RuntimeException('The MySQL adapter mysqli is not available');		}		$this->connection = @mysqli_connect(			$this->options['host'], $this->options['user'], $this->options['password'], null, $this->options['port'], $this->options['socket']		);		// Attempt to connect to the server.		if (!$this->connection)		{			throw new RuntimeException('Could not connect to MySQL.');		}		// Set sql_mode to non_strict mode		mysqli_query($this->connection, "SET @@SESSION.sql_mode = '';");		// If auto-select is enabled select the given database.		if ($this->options['select'] && !empty($this->options['database']))		{			$this->select($this->options['database']);		}		// Set charactersets (needed for MySQL 4.1.2+).		$this->setUTF();	}	/**	 * Disconnects the database.	 *	 * @return  void	 *	 * @since   12.1	 */	public function disconnect()	{		// Close the connection.		if (is_callable($this->connection, 'close'))		{			mysqli_close($this->connection);		}		$this->connection = null;	}	/**	 * Method to escape a string for usage in an SQL statement.	 *	 * @param   string   $text   The string to be escaped.	 * @param   boolean  $extra  Optional parameter to provide extra escaping.	 *	 * @return  string  The escaped string.	 *	 * @since   12.1	 */	public function escape($text, $extra = false)	{		$this->connect();		$result = mysqli_real_escape_string($this->getConnection(), $text);		if ($extra)		{			$result = addcslashes($result, '%_');		}		return $result;	}	/**	 * Test to see if the MySQL connector is available.	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   12.1	 */	public static function isSupported()	{		return (function_exists('mysqli_connect'));	}	/**	 * Determines if the connection to the server is active.	 *	 * @return  boolean  True if connected to the database engine.	 *	 * @since   12.1	 */	public function connected()	{		if (is_object($this->connection))		{			return mysqli_ping($this->connection);		}		return false;	}	/**	 * Drops a table from the database.	 *	 * @param   string   $tableName  The name of the database table to drop.	 * @param   boolean  $ifExists   Optionally specify that the table must exist before it is dropped.	 *	 * @return  JDatabaseDriverMysqli  Returns this object to support chaining.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function dropTable($tableName, $ifExists = true)	{		$this->connect();		$query = $this->getQuery(true);		$this->setQuery('DROP TABLE ' . ($ifExists ? 'IF EXISTS ' : '') . $query->quoteName($tableName));		$this->execute();		return $this;	}	/**	 * Get the number of affected rows for the previous executed SQL statement.	 *	 * @return  integer  The number of affected rows.	 *	 * @since   12.1	 */	public function getAffectedRows()	{		$this->connect();		return mysqli_affected_rows($this->connection);	}	/**	 * Method to get the database collation in use by sampling a text field of a table in the database.	 *	 * @return  mixed  The collation in use by the database (string) or boolean false if not supported.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function getCollation()	{		$this->connect();		$this->setQuery('SHOW FULL COLUMNS FROM #__users');		$array = $this->loadAssocList();		return $array['2']['Collation'];	}	/**	 * Get the number of returned rows for the previous executed SQL statement.	 *	 * @param   resource  $cursor  An optional database cursor resource to extract the row count from.	 *	 * @return  integer   The number of returned rows.	 *	 * @since   12.1	 */	public function getNumRows($cursor = null)	{		return mysqli_num_rows($cursor ? $cursor : $this->cursor);	}	/**	 * Shows the table CREATE statement that creates the given tables.	 *	 * @param   mixed  $tables  A table name or a list of table names.	 *	 * @return  array  A list of the create SQL for the tables.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function getTableCreate($tables)	{		$this->connect();		$result = array();		// Sanitize input to an array and iterate over the list.		settype($tables, 'array');		foreach ($tables as $table)		{			// Set the query to get the table CREATE statement.			$this->setQuery('SHOW CREATE table ' . $this->quoteName($this->escape($table)));			$row = $this->loadRow();			// Populate the result array based on the create statements.			$result[$table] = $row[1];		}		return $result;	}	/**	 * Retrieves field information about a given table.	 *	 * @param   string   $table     The name of the database table.	 * @param   boolean  $typeOnly  True to only return field types.	 *	 * @return  array  An array of fields for the database table.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function getTableColumns($table, $typeOnly = true)	{		$this->connect();		$result = array();		// Set the query to get the table fields statement.		$this->setQuery('SHOW FULL COLUMNS FROM ' . $this->quoteName($this->escape($table)));		$fields = $this->loadObjectList();		// If we only want the type as the value add just that to the list.		if ($typeOnly)		{			foreach ($fields as $field)			{				$result[$field->Field] = preg_replace("/[(0-9)]/", '', $field->Type);			}		}		// If we want the whole field data object add that to the list.		else		{			foreach ($fields as $field)			{				$result[$field->Field] = $field;			}		}		return $result;	}	/**	 * Get the details list of keys for a table.	 *	 * @param   string  $table  The name of the table.	 *	 * @return  array  An array of the column specification for the table.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function getTableKeys($table)	{		$this->connect();		// Get the details columns information.		$this->setQuery('SHOW KEYS FROM ' . $this->quoteName($table));		$keys = $this->loadObjectList();		return $keys;	}	/**	 * Method to get an array of all tables in the database.	 *	 * @return  array  An array of all the tables in the database.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function getTableList()	{		$this->connect();		// Set the query to get the tables statement.		$this->setQuery('SHOW TABLES');		$tables = $this->loadColumn();		return $tables;	}	/**	 * Get the version of the database connector.	 *	 * @return  string  The database connector version.	 *	 * @since   12.1	 */	public function getVersion()	{		$this->connect();		return mysqli_get_server_info($this->connection);	}	/**	 * Method to get the auto-incremented value from the last INSERT statement.	 *	 * @return  integer  The value of the auto-increment field from the last inserted row.	 *	 * @since   12.1	 */	public function insertid()	{		$this->connect();		return mysqli_insert_id($this->connection);	}	/**	 * Locks a table in the database.	 *	 * @param   string  $table  The name of the table to unlock.	 *	 * @return  JDatabaseDriverMysqli  Returns this object to support chaining.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function lockTable($table)	{		$this->setQuery('LOCK TABLES ' . $this->quoteName($table) . ' WRITE')->execute();		return $this;	}	/**	 * Execute the SQL statement.	 *	 * @return  mixed  A database cursor resource on success, boolean false on failure.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function execute()	{		$this->connect();		if (!is_object($this->connection))		{			JLog::add(JText::sprintf('JLIB_DATABASE_QUERY_FAILED', $this->errorNum, $this->errorMsg), JLog::ERROR, 'database');			throw new RuntimeException($this->errorMsg, $this->errorNum);		}		// Take a local copy so that we don't modify the original query and cause issues later		$query = $this->replacePrefix((string) $this->sql);		if ($this->limit > 0 || $this->offset > 0)		{			$query .= ' LIMIT ' . $this->offset . ', ' . $this->limit;		}		// Increment the query counter.		$this->count++;		// If debugging is enabled then let's log the query.		if ($this->debug)		{			// Add the query to the object queue.			$this->log[] = $query;			JLog::add($query, JLog::DEBUG, 'databasequery');		}		// Reset the error values.		$this->errorNum = 0;		$this->errorMsg = '';		// Execute the query. Error suppression is used here to prevent warnings/notices that the connection has been lost.		$this->cursor = @mysqli_query($this->connection, $query);		// If an error occurred handle it.		if (!$this->cursor)		{			$this->errorNum = (int) mysqli_errno($this->connection);			$this->errorMsg = (string) mysqli_error($this->connection) . ' SQL=' . $query;			// Check if the server was disconnected.			if (!$this->connected())			{				try				{					// Attempt to reconnect.					$this->connection = null;					$this->connect();				}				// If connect fails, ignore that exception and throw the normal exception.				catch (RuntimeException $e)				{					JLog::add(JText::sprintf('JLIB_DATABASE_QUERY_FAILED', $this->errorNum, $this->errorMsg), JLog::ERROR, 'databasequery');					throw new RuntimeException($this->errorMsg, $this->errorNum);				}				// Since we were able to reconnect, run the query again.				return $this->execute();			}			// The server was not disconnected.			else			{				JLog::add(JText::sprintf('JLIB_DATABASE_QUERY_FAILED', $this->errorNum, $this->errorMsg), JLog::ERROR, 'databasequery');				throw new RuntimeException($this->errorMsg, $this->errorNum);			}		}		return $this->cursor;	}	/**	 * Renames a table in the database.	 *	 * @param   string  $oldTable  The name of the table to be renamed	 * @param   string  $newTable  The new name for the table.	 * @param   string  $backup    Not used by MySQL.	 * @param   string  $prefix    Not used by MySQL.	 *	 * @return  JDatabaseDriverMysqli  Returns this object to support chaining.	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function renameTable($oldTable, $newTable, $backup = null, $prefix = null)	{		$this->setQuery('RENAME TABLE ' . $oldTable . ' TO ' . $newTable)->execute();		return $this;	}	/**	 * Select a database for use.	 *	 * @param   string  $database  The name of the database to select for use.	 *	 * @return  boolean  True if the database was successfully selected.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function select($database)	{		$this->connect();		if (!$database)		{			return false;		}		if (!mysqli_select_db($this->connection, $database))		{			throw new RuntimeException('Could not connect to database.');		}		return true;	}	/**	 * Set the connection to use UTF-8 character encoding.	 *	 * @return  boolean  True on success.	 *	 * @since   12.1	 */	public function setUTF()	{		$this->connect();		return $this->connection->set_charset('utf8');	}	/**	 * Method to commit a transaction.	 *	 * @return  void	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function transactionCommit()	{		$this->connect();		$this->setQuery('COMMIT');		$this->execute();	}	/**	 * Method to roll back a transaction.	 *	 * @return  void	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function transactionRollback()	{		$this->connect();		$this->setQuery('ROLLBACK');		$this->execute();	}	/**	 * Method to initialize a transaction.	 *	 * @return  void	 *	 * @since   12.2	 * @throws  RuntimeException	 */	public function transactionStart()	{		$this->connect();		$this->setQuery('START TRANSACTION');		$this->execute();	}	/**	 * Method to fetch a row from the result set cursor as an array.	 *	 * @param   mixed  $cursor  The optional result set cursor from which to fetch the row.	 *	 * @return  mixed  Either the next row from the result set or false if there are no more rows.	 *	 * @since   12.1	 */	protected function fetchArray($cursor = null)	{		return mysqli_fetch_row($cursor ? $cursor : $this->cursor);	}	/**	 * Method to fetch a row from the result set cursor as an associative array.	 *	 * @param   mixed  $cursor  The optional result set cursor from which to fetch the row.	 *	 * @return  mixed  Either the next row from the result set or false if there are no more rows.	 *	 * @since   12.1	 */	protected function fetchAssoc($cursor = null)	{		return mysqli_fetch_assoc($cursor ? $cursor : $this->cursor);	}	/**	 * Method to fetch a row from the result set cursor as an object.	 *	 * @param   mixed   $cursor  The optional result set cursor from which to fetch the row.	 * @param   string  $class   The class name to use for the returned row object.	 *	 * @return  mixed   Either the next row from the result set or false if there are no more rows.	 *	 * @since   12.1	 */	protected function fetchObject($cursor = null, $class = 'stdClass')	{		return mysqli_fetch_object($cursor ? $cursor : $this->cursor, $class);	}	/**	 * Method to free up the memory used for the result set.	 *	 * @param   mixed  $cursor  The optional result set cursor from which to fetch the row.	 *	 * @return  void	 *	 * @since   12.1	 */	protected function freeResult($cursor = null)	{		mysqli_free_result($cursor ? $cursor : $this->cursor);	}	/**	 * Unlocks tables in the database.	 *	 * @return  JDatabaseDriverMysqli  Returns this object to support chaining.	 *	 * @since   12.1	 * @throws  RuntimeException	 */	public function unlockTables()	{		$this->setQuery('UNLOCK TABLES')->execute();		return $this;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_categories * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Categories Component Categories Model * * @package     Joomla.Administrator * @subpackage  com_categories * @since       1.6 */class CategoriesModelCategories extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id', 'a.id',				'title', 'a.title',				'alias', 'a.alias',				'published', 'a.published',				'access', 'a.access', 'access_level',				'language', 'a.language',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'created_time', 'a.created_time',				'created_user_id', 'a.created_user_id',				'lft', 'a.lft',				'rgt', 'a.rgt',				'level', 'a.level',				'path', 'a.path',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @param   string    An optional ordering field.	 * @param   string    An optional direction (asc|desc).	 *	 * @return  void	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication();		$context = $this->context;		$extension = $app->getUserStateFromRequest('com_categories.categories.filter.extension', 'extension', 'com_content', 'cmd');		$this->setState('filter.extension', $extension);		$parts = explode('.', $extension);		// Extract the component name		$this->setState('filter.component', $parts[0]);		// Extract the optional section name		$this->setState('filter.section', (count($parts) > 1) ? $parts[1] : null);		$search = $this->getUserStateFromRequest($context . '.search', 'filter_search');		$this->setState('filter.search', $search);		$level = $this->getUserStateFromRequest($context . '.filter.level', 'filter_level', 0, 'int');		$this->setState('filter.level', $level);		$access = $this->getUserStateFromRequest($context . '.filter.access', 'filter_access', 0, 'int');		$this->setState('filter.access', $access);		$published = $this->getUserStateFromRequest($context . '.filter.published', 'filter_published', '');		$this->setState('filter.published', $published);		$language = $this->getUserStateFromRequest($context . '.filter.language', 'filter_language', '');		$this->setState('filter.language', $language);		$tag = $this->getUserStateFromRequest($this->context . '.filter.tag', 'filter_tag', '');		$this->setState('filter.tag', $tag);		// List state information.		parent::populateState('a.lft', 'asc');	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id    A prefix for the store id.	 *	 * @return  string  A store id.	 * @since   1.6	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.extension');		$id .= ':' . $this->getState('filter.published');		$id .= ':' . $this->getState('filter.language');		return parent::getStoreId($id);	}	/**	 * @return  string	 *	 * @since   1.6	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		$user = JFactory::getUser();		$app = JFactory::getApplication();		// Select the required fields from the table.		$query->select(			$this->getState(				'list.select',				'a.id, a.title, a.alias, a.note, a.published, a.access' .					', a.checked_out, a.checked_out_time, a.created_user_id' .					', a.path, a.parent_id, a.level, a.lft, a.rgt' .					', a.language'			)		);		$query->from('#__categories AS a');		// Join over the language		$query->select('l.title AS language_title')			->join('LEFT', $db->quoteName('#__languages') . ' AS l ON l.lang_code = a.language');		// Join over the users for the checked out user.		$query->select('uc.name AS editor')			->join('LEFT', '#__users AS uc ON uc.id=a.checked_out');		// Join over the asset groups.		$query->select('ag.title AS access_level')			->join('LEFT', '#__viewlevels AS ag ON ag.id = a.access');		// Join over the users for the author.		$query->select('ua.name AS author_name')			->join('LEFT', '#__users AS ua ON ua.id = a.created_user_id');		// Join over the associations.		$assoc = $this->getAssoc();		if ($assoc)		{			$query->select('COUNT(asso2.id)>1 as association')				->join('LEFT', '#__associations AS asso ON asso.id = a.id AND asso.context=' . $db->quote('com_categories.item'))				->join('LEFT', '#__associations AS asso2 ON asso2.key = asso.key')				->group('a.id');		}		// Filter by extension		if ($extension = $this->getState('filter.extension'))		{			$query->where('a.extension = ' . $db->quote($extension));		}		// Filter on the level.		if ($level = $this->getState('filter.level'))		{			$query->where('a.level <= ' . (int) $level);		}		// Filter by access level.		if ($access = $this->getState('filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		// Implement View Level Access		if (!$user->authorise('core.admin'))		{			$groups = implode(',', $user->getAuthorisedViewLevels());			$query->where('a.access IN (' . $groups . ')');		}		// Filter by published state		$published = $this->getState('filter.published');		if (is_numeric($published))		{			$query->where('a.published = ' . (int) $published);		}		elseif ($published === '')		{			$query->where('(a.published IN (0, 1))');		}		// Filter by search in title		$search = $this->getState('filter.search');		if (!empty($search))		{			if (stripos($search, 'id:') === 0)			{				$query->where('a.id = ' . (int) substr($search, 3));			}			elseif (stripos($search, 'author:') === 0)			{				$search = $db->quote('%' . $db->escape(substr($search, 7), true) . '%');				$query->where('(ua.name LIKE ' . $search . ' OR ua.username LIKE ' . $search . ')');			}			else			{				$search = $db->quote('%' . $db->escape($search, true) . '%');				$query->where('(a.title LIKE ' . $search . ' OR a.alias LIKE ' . $search . ' OR a.note LIKE ' . $search . ')');			}		}		// Filter on the language.		if ($language = $this->getState('filter.language'))		{			$query->where('a.language = ' . $db->quote($language));		}		// Filter by a single tag.		$tagId = $this->getState('filter.tag');		if (is_numeric($tagId))		{			$query->where($db->quoteName('tagmap.tag_id') . ' = ' . (int) $tagId)				->join(					'LEFT', $db->quoteName('#__contentitem_tag_map', 'tagmap')					. ' ON ' . $db->quoteName('tagmap.content_item_id') . ' = ' . $db->quoteName('a.id')					. ' AND ' . $db->quoteName('tagmap.type_alias') . ' = ' . $db->quote($extension . '.category')				);		}		// Add the list ordering clause		$listOrdering = $this->getState('list.ordering', 'a.lft');		$listDirn = $db->escape($this->getState('list.direction', 'ASC'));		if ($listOrdering == 'a.access')		{			$query->order('a.access ' . $listDirn . ', a.lft ' . $listDirn);		}		else		{			$query->order($db->escape($listOrdering) . ' ' . $listDirn);		}		//echo nl2br(str_replace('#__','jos_',$query));		return $query;	}	/**	 * Method to determine if an association exists	 *	 * @return  boolean  True if the association exists	 *	 * @since  3.0	 */	public function getAssoc()	{		static $assoc = null;		if (!is_null($assoc))		{			return $assoc;		}		$app = JFactory::getApplication();		$extension = $this->getState('filter.extension');		$assoc = isset($app->item_associations) ? $app->item_associations : 0;		$extension = explode('.', $extension);		$component = array_shift($extension);		$cname = str_replace('com_', '', $component);		if (!$assoc || !$component || !$cname)		{			$assoc = false;		}		else		{			$hname = $cname . 'HelperAssociation';			JLoader::register($hname, JPATH_SITE . '/components/' . $component . '/helpers/association.php');			$assoc = class_exists($hname) && !empty($hname::$category_association);		}		return $assoc;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('formbehavior.chosen', 'select');$published	= $this->state->get('filter.published');?><div class="modal hide fade" id="collapseModal">	<div class="modal-header">		<button type="button" class="close" data-dismiss="modal">x</button>		<h3><?php echo JText::_('COM_TAGS_BATCH_OPTIONS');?></h3>	</div>	<div class="modal-body">		<p><?php echo JText::_('COM_TAGS_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.access');?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.language'); ?>			</div>		</div>	<div class="modal-footer">		<button class="btn" type="button" onclick="document.id('batch-tag-id').value='';document.id('batch-access').value='';document.id('batch-language-id').value=''" data-dismiss="modal">			<?php echo JText::_('JCANCEL'); ?>		</button>		<button class="btn btn-primary" type="submit" onclick="Joomla.submitbutton('tag.batch');">			<?php echo JText::_('JGLOBAL_BATCH_PROCESS'); ?>		</button>	</div></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_templates * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><?php	echo JHtml::_('bootstrap.startAccordion', 'templatestyleOptions', array('active' => 'collapse0'));	$fieldSets = $this->form->getFieldsets('params');	$i = 0;	foreach ($fieldSets as $name => $fieldSet) :		$label = !empty($fieldSet->label) ? $fieldSet->label : 'COM_TEMPLATES_'.$name.'_FIELDSET_LABEL';		echo JHtml::_('bootstrap.addSlide', 'templatestyleOptions', JText::_($label), 'collapse' . $i++);			if (isset($fieldSet->description) && trim($fieldSet->description)) :				echo '<p class="tip">'.$this->escape(JText::_($fieldSet->description)).'</p>';			endif;			?>				<?php foreach ($this->form->getFieldset($name) as $field) : ?>					<div class="control-group">						<div class="control-label">							<?php echo $field->label; ?>						</div>						<div class="controls">							<?php echo $field->input; ?>						</div>					</div>				<?php endforeach;		echo JHtml::_('bootstrap.endSlide');	endforeach;echo JHtml::_('bootstrap.endAccordion');
<?php/** * @package     Joomla.Administrator * @subpackage  mod_menu * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Tree based class to render the admin menu * * @package     Joomla.Administrator * @subpackage  mod_menu * @since       1.5 */class JAdminCssMenu extends JObject{	/**	 * CSS string to add to document head	 * @var string	 */	protected $_css = null;	/**	 * Root node	 *	 * @var    object	 */	protected $_root = null;	/**	 * Current working node	 *	 * @var    object	 */	protected $_current = null;	/**	 * Constructor	 */	public function __construct()	{		$this->_root = new JMenuNode('ROOT');		$this->_current = & $this->_root;	}	/**	 * Method to add a child	 *	 * @param   JMenuNode  &$node       The node to process	 * @param   boolean    $setCurrent  True to set as current working node	 *	 * @return  void	 */	public function addChild(JMenuNode &$node, $setCurrent = false)	{		$this->_current->addChild($node);		if ($setCurrent)		{			$this->_current = &$node;		}	}	/**	 * Method to get the parent	 *	 * @return  void	 */	public function getParent()	{		$this->_current = &$this->_current->getParent();	}	/**	 * Method to get the parent	 *	 * @return  void	 */	public function reset()	{		$this->_current = &$this->_root;	}	public function addSeparator()	{		$this->addChild(new JMenuNode(null, null, 'separator', false));	}	public function renderMenu($id = 'menu', $class = '')	{		$depth = 1;		if (!empty($id))		{			$id = 'id="' . $id . '"';		}		if (!empty($class))		{			$class = 'class="' . $class . '"';		}		/*		 * Recurse through children if they exist		 */		while ($this->_current->hasChildren())		{			echo "<ul ".$id." ".$class.">\n";			foreach ($this->_current->getChildren() as $child)			{				$this->_current = & $child;				$this->renderLevel($depth++);			}			echo "</ul>\n";		}		if ($this->_css)		{			// Add style to document head			$doc = JFactory::getDocument();			$doc->addStyleDeclaration($this->_css);		}	}	public function renderLevel($depth)	{		/*		 * Build the CSS class suffix		 */		$class = '';		if ($this->_current->hasChildren())		{			$class = ' class="dropdown"';		}		if ($this->_current->class == 'separator')		{			$class = ' class="divider"';		}		if ($this->_current->hasChildren() && $this->_current->class)		{			$class = ' class="dropdown-submenu"';		}		if ($this->_current->class == 'disabled')		{			$class = ' class="disabled"';		}		/*		 * Print the item		 */		echo "<li".$class.">";		/*		 * Print a link if it exists		 */		$linkClass = array();		$dataToggle = '';		$dropdownCaret = '';		if ($this->_current->hasChildren())		{			$linkClass[] = 'dropdown-toggle';			$dataToggle = ' data-toggle="dropdown"';			if (!$this->_current->getParent()->hasParent())			{				$dropdownCaret = ' <span class="caret"></span>';			}		}		if ($this->_current->link != null && $this->_current->getParent()->title != 'ROOT')		{			$iconClass = $this->getIconClass($this->_current->class);			if (!empty($iconClass))			{				$linkClass[] = $iconClass;			}		}		// Implode out $linkClass for rendering		$linkClass = ' class="' . implode(' ', $linkClass) . '"';		if ($this->_current->link != null && $this->_current->target != null)		{			echo "<a" . $linkClass . " " . $dataToggle . " href=\"" . $this->_current->link . "\" target=\"" . $this->_current->target . "\" >" . $this->_current->title . $dropdownCaret . "</a>";		}		elseif ($this->_current->link != null && $this->_current->target == null)		{			echo "<a" . $linkClass . " " . $dataToggle . " href=\"" . $this->_current->link . "\">" . $this->_current->title . $dropdownCaret . "</a>";		}		elseif ($this->_current->title != null)		{			echo "<a" . $linkClass . " " . $dataToggle . ">" . $this->_current->title . $dropdownCaret . "</a>";		}		else		{			echo "<span></span>";		}		/*		 * Recurse through children if they exist		 */		while ($this->_current->hasChildren())		{			if ($this->_current->class)			{				$id = '';				if (!empty($this->_current->id))				{					$id = ' id="menu-'.strtolower($this->_current->id).'"';				}				echo '<ul'.$id.' class="dropdown-menu menu-component">'."\n";			} else {				echo '<ul class="dropdown-menu">'."\n";			}			foreach ($this->_current->getChildren() as $child)			{				$this->_current = & $child;				$this->renderLevel($depth++);			}			echo "</ul>\n";		}		echo "</li>\n";	}	/**	 * Method to get the CSS class name for an icon identifier or create one if	 * a custom image path is passed as the identifier	 *	 * @access	public	 * @param   string	$identifier	Icon identification string	 * @return  string	CSS class name	 * @since   1.5	 */	public function getIconClass($identifier)	{		static $classes;		// Initialise the known classes array if it does not exist		if (!is_array($classes))		{			$classes = array();		}		/*		 * If we don't already know about the class... build it and mark it		 * known so we don't have to build it again		 */		if (!isset($classes[$identifier]))		{			if (substr($identifier, 0, 6) == 'class:')			{				// We were passed a class name				$class = substr($identifier, 6);				$classes[$identifier] = "menu-$class";			} else {				if ($identifier == null)				{					return null;				}				// Build the CSS class for the icon				$class = preg_replace('#\.[^.]*$#', '', basename($identifier));				$class = preg_replace('#\.\.[^A-Za-z0-9\.\_\- ]#', '', $class);				$this->_css  .= "\n.menu-$class {\n" .						"\tbackground: url($identifier) no-repeat;\n" .						"}\n";				$classes[$identifier] = "menu-$class";			}		}		return $classes[$identifier];	}}/** * A Node for JAdminCssMenu * * @package     Joomla.Administrator * @subpackage  mod_menu * @since       1.5 * @see         JAdminCssMenu */class JMenuNode extends JObject{	/**	 * Node Title	 */	public $title = null;	/**	 * Node Id	 */	public $id = null;	/**	 * Node Link	 */	public $link = null;	/**	 * Link Target	 */	public $target = null;	/**	 * CSS Class for node	 */	public $class = null;	/**	 * Active Node?	 */	public $active = false;	/**	 * Parent node	 * @var    object	 */	protected $_parent = null;	/**	 * Array of Children	 *	 * @var    array	 */	protected $_children = array();	public function __construct($title, $link = null, $class = null, $active = false, $target = null, $titleicon = null)	{		$this->title	= $titleicon ? $title.$titleicon : $title;		$this->link		= JFilterOutput::ampReplace($link);		$this->class	= $class;		$this->active	= $active;		$this->id = null;		if (!empty($link) && $link !== '#')		{			$uri = new JURI($link);			$params = $uri->getQuery(true);			$parts = array();			foreach ($params as $name => $value)			{				$parts[] = str_replace(array('.', '_'), '-', $value);			}			$this->id = implode('-', $parts);		}		$this->target	= $target;	}	/**	 * Add child to this node	 *	 * If the child already has a parent, the link is unset	 *	 * @param   JMenuNode  &$child  The child to be added	 *	 * @return  void	 */	public function addChild(JMenuNode &$child)	{		$child->setParent($this);	}	/**	 * Set the parent of a this node	 *	 * If the node already has a parent, the link is unset	 *	 * @param   JMenuNode   &$parent  The JMenuNode for parent to be set or null	 *	 * @return  void	 */	public function setParent(JMenuNode &$parent = null)	{		$hash = spl_object_hash($this);		if (!is_null($this->_parent))		{			unset($this->_parent->children[$hash]);		}		if (!is_null($parent))		{			$parent->_children[$hash] = & $this;		}		$this->_parent = & $parent;	}	/**	 * Get the children of this node	 *	 * @return  array    The children	 */	public function &getChildren()	{		return $this->_children;	}	/**	 * Get the parent of this node	 *	 * @return  mixed   JMenuNode object with the parent or null for no parent	 */	public function &getParent()	{		return $this->_parent;	}	/**	 * Test if this node has children	 *	 * @return   boolean  True if there are children	 */	public function hasChildren()	{		return (bool) count($this->_children);	}	/**	 * Test if this node has a parent	 *	 * @return  boolean  True if there is a parent	 */	public function hasParent()	{		return $this->getParent() != null;	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Content.emailcloak * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Email cloack plugin class. * * @package     Joomla.Plugin * @subpackage  Content.emailcloak * @since       1.5 */class PlgContentEmailcloak extends JPlugin{	/**	 * Plugin that cloaks all emails in content from spambots via Javascript.	 *	 * @param   string   $context  The context of the content being passed to the plugin.	 * @param   mixed    &$row     An object with a "text" property or the string to be cloaked.	 * @param   array    &$params  Additional parameters. See {@see PlgContentEmailcloak()}.	 * @param   integer  $page     Optional page number. Unused. Defaults to zero.	 *	 * @return  boolean	True on success.	 */	public function onContentPrepare($context, &$row, &$params, $page = 0)	{		// Don't run this plugin when the content is being indexed		if ($context == 'com_finder.indexer')		{			return true;		}		if (is_object($row))		{			return $this->_cloak($row->text, $params);		}		return $this->_cloak($row, $params);	}	/**	 * Genarate a search pattern based on link and text.	 *	 * @param   string	The target of an email link.	 * @param   string	The text enclosed by the link.	 * @return  string	A regular expression that matches a link containing the parameters.	 */	protected function _getPattern ($link, $text)	{		$pattern = '~(?:<a ([\w "\'=\@\.\-:;]*)href\s*=\s*"mailto:'			. $link . '"([\w "\'=\@\.\-:;]*))>' . $text . '</a>~i';		return $pattern;	}	/**	 * Adds an attributes to the js cloaked email.	 *	 * @param  string Js cloaked email.	 * @param  string Attributes before email.	 * @param  string Attributes after email.	 * @return string Js cloaked email with attributes.	 */	protected function _addAttributesToEmail($jsEmail, $before, $after)	{		if ($before !== "")		{			$before = str_replace("'", "\'", $before);			$jsEmail = str_replace("document.write('<a '", "document.write('<a {$before}'", $jsEmail);		}		if ($after !== "")		{			$after = str_replace("'", "\'", $after);			$jsEmail = str_replace("'\'>');", "'\'{$after}>');", $jsEmail);		}		return $jsEmail;	}	/**	 * Cloak all emails in text from spambots via Javascript.	 *	 * @param   string  The string to be cloaked.	 * @param   array   Additional parameters. Parameter "mode" (integer, default 1)	 *                  replaces addresses with "mailto:" links if nonzero.	 * @return  boolean  True on success.	 */	protected function _cloak(&$text, &$params)	{		/*		 * Check for presence of {emailcloak=off} which is explicits disables this		 * bot for the item.		 */		if (JString::strpos($text, '{emailcloak=off}') !== false)		{			$text = JString::str_ireplace('{emailcloak=off}', '', $text);			return true;		}		// Simple performance check to determine whether bot should process further.		if (JString::strpos($text, '@') === false)		{			return true;		}		$mode = $this->params->def('mode', 1);		// any@email.address.com		$searchEmail = '([\w\.\-]+\@(?:[a-z0-9\.\-]+\.)+(?:[a-z0-9\-]{2,4}))';		// any@email.address.com?subject=anyText		$searchEmailLink = $searchEmail . '([?&][\x20-\x7f][^"<>]+)';		// anyText		$searchText = '([\x20-\x7f][^<>]+)';		//Any Image link		$searchImage	=	"(<img[^>]+>)";		/*		 * Search and fix derivatives of link code <a href="http://mce_host/ourdirectory/email@amail.com"		 * >email@email.com</a>. This happens when inserting an email in TinyMCE, cancelling its suggestion to add		 * the mailto: prefix...		 */		$pattern = $this->_getPattern($searchEmail, $searchEmail);		$pattern = str_replace('"mailto:', '"http://mce_host([\x20-\x7f][^<>]+/)', $pattern);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[3][0];			$mailText = $regs[5][0];			// Check to see if mail text is different from mail addy			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[4][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		/*		 * Search and fix derivatives of link code <a href="http://mce_host/ourdirectory/email@amail.com"		 * >anytext</a>. This happens when inserting an email in TinyMCE, cancelling its suggestion to add		 * the mailto: prefix...		 */		$pattern = $this->_getPattern($searchEmail, $searchText);		$pattern = str_replace('"mailto:', '"http://mce_host([\x20-\x7f][^<>]+/)', $pattern);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[3][0];			$mailText = $regs[5][0];			// Check to see if mail text is different from mail addy			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText, 0);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[4][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		/*		 * Search for derivatives of link code <a href="mailto:email@amail.com"		 * >email@amail.com</a>		 */		$pattern = $this->_getPattern($searchEmail, $searchEmail);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[2][0];			$mailText = $regs[4][0];			// Check to see if mail text is different from mail addy			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[3][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		/*		 * Search for derivatives of link code <a href="mailto:email@amail.com">		 * anytext</a>		 */		$pattern = $this->_getPattern($searchEmail, $searchText);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[2][0];			$mailText = $regs[4][0];			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText, 0);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[3][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		/*		 * Search for derivatives of link code <a href="mailto:email@amail.com">		 * <img anything></a>		 */		$pattern = $this->_getPattern($searchEmail, $searchImage);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[2][0];			$mailText = $regs[4][0];			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText, 0);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[3][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		/*		 * Search for derivatives of link code <a href="mailto:email@amail.com?		 * subject=Text">email@amail.com</a>		 */		$pattern = $this->_getPattern($searchEmailLink, $searchEmail);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[2][0] . $regs[3][0];			$mailText = $regs[5][0];			// Needed for handling of Body parameter			$mail = str_replace('&amp;', '&', $mail);			// Check to see if mail text is different from mail addy			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[4][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		/*		 * Search for derivatives of link code <a href="mailto:email@amail.com?		 * subject=Text">anytext</a>		 */		$pattern = $this->_getPattern($searchEmailLink, $searchText);		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[2][0] . $regs[3][0];			$mailText = $regs[5][0];			// Needed for handling of Body parameter			$mail = str_replace('&amp;', '&', $mail);			$replacement = JHtml::_('email.cloak', $mail, $mode, $mailText, 0);			// Ensure that attributes is not stripped out by email cloaking			$replacement = $this->_addAttributesToEmail($replacement, $regs[1][0], $regs[4][0]);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[0][1], strlen($regs[0][0]));		}		// Search for plain text email@amail.com		$pattern = '~' . $searchEmail . '([^a-z0-9]|$)~i';		while (preg_match($pattern, $text, $regs, PREG_OFFSET_CAPTURE))		{			$mail = $regs[1][0];			$replacement = JHtml::_('email.cloak', $mail, $mode);			// Replace the found address with the js cloaked email			$text = substr_replace($text, $replacement, $regs[1][1], strlen($mail));		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_BASE') or die;JFormHelper::loadFieldClass('list');// Load the base adapter.require_once JPATH_ADMINISTRATOR . '/components/com_finder/helpers/indexer/adapter.php';/** * Renders a list of directories. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class JFormFieldDirectories extends JFormFieldList{	/**	 * The form field type.	 *	 * @var    string	 * @since  2.5	 */	protected $type = 'Directories';	/**	 * Method to get the field options.	 *	 * @return  array  The field option objects.	 *	 * @since   2.5	 */	public function getOptions()	{		$values = array();		$options = array();		$exclude = array(			JPATH_ADMINISTRATOR,			JPATH_INSTALLATION,			JPATH_LIBRARIES,			JPATH_PLUGINS,			JPATH_SITE . '/cache',			JPATH_SITE . '/components',			JPATH_SITE . '/includes',			JPATH_SITE . '/language',			JPATH_SITE . '/modules',			JPATH_THEMES,			JFactory::getApplication()->getCfg('log_path'),			JFactory::getApplication()->getCfg('tmp_path')		);		// Get the base directories.		jimport('joomla.filesystem.folder');		$dirs = JFolder::folders(JPATH_SITE, '.', false, true);		// Iterate through the base directories and find the subdirectories.		foreach ($dirs as $dir)		{			// Check if the directory should be excluded.			if (in_array($dir, $exclude))			{				continue;			}			// Get the child directories.			$return = JFolder::folders($dir, '.', true, true);			// Merge the directories.			if (is_array($return))			{				$values[] = $dir;				$values = array_merge($values, $return);			}		}		// Convert the values to options.		for ($i = 0, $c = count($values); $i < $c; $i++)		{			$options[] = JHtml::_('select.option', str_replace(JPATH_SITE . '/', '', $values[$i]), str_replace(JPATH_SITE . '/', '', $values[$i]));		}		// Add a null option.		array_unshift($options, JHtml::_('select.option', '', '- ' . JText::_('JNONE') . ' -'));		// Handle default values of value1|value2|value3		if (is_string($value) && strpos($value, '|') && preg_match('#(?<!\\\)\|#', $value))		{			// Explode the value if it is serialized as an array of value1|value2|value3			$value = preg_split('/(?<!\\\)\|/', $value);			$value = str_replace('\|', '|', $value);			$value = str_replace('\n', "\n", $value);		}		return $options;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('formbehavior.chosen', 'select');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'weblink.cancel' || document.formvalidator.isValid(document.id('weblink-form')))		{			<?php echo $this->form->getField('description')->save(); ?>			Joomla.submitform(task, document.getElementById('weblink-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_weblinks&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="weblink-form" class="form-validate">	<div class="row-fluid">		<!-- Begin Weblinks -->		<div class="span10 form-horizontal">	<fieldset>		<?php echo JHtml::_('bootstrap.startTabSet', 'myTab', array('active' => 'details')); ?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'details', empty($this->item->id) ? JText::_('COM_WEBLINKS_NEW_WEBLINK', true) : JText::sprintf('COM_WEBLINKS_EDIT_WEBLINK', $this->item->id, true)); ?>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('title'); ?></div>					<div class="controls"><?php echo $this->form->getInput('title'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('url'); ?></div>					<div class="controls"><?php echo $this->form->getInput('url'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('catid'); ?></div>					<div class="controls"><?php echo $this->form->getInput('catid'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('ordering'); ?></div>					<div class="controls"><?php echo $this->form->getInput('ordering'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('description'); ?></div>					<div class="controls"><?php echo $this->form->getInput('description'); ?></div>				</div>				<h4><?php echo JText::_('COM_WEBLINKS_FIELDSET_IMAGES');?></h4>				<div class="control-group">					<div class="control-label">						<?php echo $this->form->getLabel('images'); ?>					</div>					<div class="controls">						<?php echo $this->form->getInput('images'); ?>					</div>				</div>				<?php foreach ($this->form->getGroup('images') as $field) : ?>					<div class="control-group">						<?php if (!$field->hidden) : ?>							<div class="control-label">								<?php echo $field->label; ?>							</div>						<?php endif; ?>						<div class="controls">							<?php echo $field->input; ?>						</div>					</div>				<?php endforeach; ?>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'publishing', JText::_('JGLOBAL_FIELDSET_PUBLISHING', true)); ?>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('alias'); ?></div>					<div class="controls"><?php echo $this->form->getInput('alias'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('id'); ?></div>					<div class="controls"><?php echo $this->form->getInput('id'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('created_by'); ?></div>					<div class="controls"><?php echo $this->form->getInput('created_by'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('created_by_alias'); ?></div>					<div class="controls"><?php echo $this->form->getInput('created_by_alias'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('created'); ?></div>					<div class="controls"><?php echo $this->form->getInput('created'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('publish_up'); ?></div>					<div class="controls"><?php echo $this->form->getInput('publish_up'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('publish_down'); ?></div>					<div class="controls"><?php echo $this->form->getInput('publish_down'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('version'); ?></div>					<div class="controls"><?php echo $this->form->getInput('version'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('modified_by'); ?></div>					<div class="controls"><?php echo $this->form->getInput('modified_by'); ?></div>				</div>				<div class="control-group">					<div class="control-label"><?php echo $this->form->getLabel('modified'); ?></div>					<div class="controls"><?php echo $this->form->getInput('modified'); ?></div>				</div>				<?php if ($this->item->hits) : ?>					<div class="control-group">						<div class="control-label"><?php echo $this->form->getLabel('hits'); ?></div>						<div class="controls"><?php echo $this->form->getInput('hits'); ?></div>					</div>				<?php endif; ?>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php $fieldSets = $this->form->getFieldsets('params'); ?>			<?php foreach ($fieldSets as $name => $fieldSet) : ?>				<?php $paramstabs = 'params-' . $name; ?>				<?php echo JHtml::_('bootstrap.addTab', 'myTab', $paramstabs, JText::_($fieldSet->label, true)); ?>					<?php echo $this->loadTemplate('params'); ?>				<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php endforeach; ?>			<?php $fieldSets = $this->form->getFieldsets('metadata'); ?>			<?php foreach ($fieldSets as $name => $fieldSet) : ?>				<?php $metadatatabs = 'metadata-' . $name; ?>				<?php echo JHtml::_('bootstrap.addTab', 'myTab', $metadatatabs, JText::_($fieldSet->label, true)); ?>					<?php echo $this->loadTemplate('metadata'); ?>				<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php endforeach; ?>			<input type="hidden" name="task" value="" />			<?php echo JHtml::_('form.token'); ?>		<?php echo JHtml::_('bootstrap.endTabSet'); ?>		</fieldset>		</div>		<!-- End Weblinks -->		<!-- Begin Sidebar -->			<?php echo JLayoutHelper::render('joomla.edit.details', $this); ?>		<!-- End Sidebar --></form>
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;JFormHelper::loadFieldClass('filelist');/** * Supports an HTML select list of image * * @package     Joomla.Platform * @subpackage  Form * @since       11.1 */class JFormFieldImageList extends JFormFieldFileList{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	public $type = 'ImageList';	/**	 * Method to get the list of images field options.	 * Use the filter attribute to specify allowable file extensions.	 *	 * @return  array  The field option objects.	 *	 * @since   11.1	 */	protected function getOptions()	{		// Define the image file type filter.		$filter = '\.png$|\.gif$|\.jpg$|\.bmp$|\.ico$|\.jpeg$|\.psd$|\.eps$';		// Set the form field element attribute for file type filter.		$this->element->addAttribute('filter', $filter);		// Get the field options.		return parent::getOptions();	}}
<?php/** * @package    Joomla.Administrator * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/* * Joomla! system checks. */@ini_set('magic_quotes_runtime', 0);/* * Installation check, and check on removal of the install directory. */if (!file_exists(JPATH_CONFIGURATION.'/configuration.php') || (filesize(JPATH_CONFIGURATION.'/configuration.php') < 10) || file_exists(JPATH_INSTALLATION.'/index.php')){	header('Location: ../installation/index.php');	exit();}//// Joomla system startup.//// System includes.require_once JPATH_LIBRARIES.'/import.legacy.php';JError::setErrorHandling(E_NOTICE, 'message');JError::setErrorHandling(E_WARNING, 'message');JError::setErrorHandling(E_ERROR, 'message', array('JError', 'customErrorPage'));// Botstrap the CMS libraries.require_once JPATH_LIBRARIES.'/cms.php';// Pre-Load configuration.ob_start();require_once JPATH_CONFIGURATION.'/configuration.php';ob_end_clean();// System configuration.$config = new JConfig;// Set the error_reportingswitch ($config->error_reporting){	case 'default':	case '-1':		break;	case 'none':	case '0':		error_reporting(0);		break;	case 'simple':		error_reporting(E_ERROR | E_WARNING | E_PARSE);		ini_set('display_errors', 1);		break;	case 'maximum':		error_reporting(E_ALL);		ini_set('display_errors', 1);		break;	case 'development':		error_reporting(-1);		ini_set('display_errors', 1);		break;	default:		error_reporting($config->error_reporting);		ini_set('display_errors', 1);		break;}define('JDEBUG', $config->debug);unset($config);/* * Joomla! framework loading. */// System profiler.if (JDEBUG){	$_PROFILER = JProfiler::getInstance('Application');}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.multiselect');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><div id="installer-update"><form action="<?php echo JRoute::_('index.php?option=com_installer&view=update');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<?php if ($this->showMessage) : ?>		<?php echo $this->loadTemplate('message'); ?>	<?php endif; ?>	<?php if ($this->ftp) : ?>		<?php echo $this->loadTemplate('ftp'); ?>	<?php endif; ?>	<?php if (count($this->items)) : ?>	<table class="adminlist" cellspacing="1">		<thead>			<tr>				<th class="checkmark-col"><input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" /></th>				<th class="nowrap"><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_NAME', 'name', $listDirn, $listOrder); ?></th>				<th class="nowrap"><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_INSTALLTYPE', 'extension_id', $listDirn, $listOrder); ?></th>				<th ><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_TYPE', 'type', $listDirn, $listOrder); ?></th>				<th class="width-10" class="center"><?php echo JText::_('JVERSION'); ?></th>				<th><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_FOLDER', 'folder', $listDirn, $listOrder); ?></th>				<th><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_CLIENT', 'client_id', $listDirn, $listOrder); ?></th>				<th class="width-25"><?php echo JText::_('COM_INSTALLER_HEADING_DETAILSURL'); ?></th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item):			$client	= $item->client_id ? JText::_('JADMINISTRATOR') : JText::_('JSITE');		?>			<tr class="row<?php echo $i % 2; ?>">				<td><?php echo JHtml::_('grid.id', $i, $item->update_id); ?></td>				<td>					<span class="editlinktip hasTip" title="<?php echo JText::_('JGLOBAL_DESCRIPTION');?>::<?php echo $item->description ? $item->description : JText::_('COM_INSTALLER_MSG_UPDATE_NODESC'); ?>">					<?php echo $item->name; ?>					</span>				</td>				<td class="center">					<?php echo $item->extension_id ? JText::_('COM_INSTALLER_MSG_UPDATE_UPDATE') : JText::_('COM_INSTALLER_NEW_INSTALL') ?>				</td>				<td><?php echo JText::_('COM_INSTALLER_TYPE_' . $item->type) ?></td>				<td class="center"><?php echo $item->version ?></td>				<td class="center"><?php echo @$item->folder != '' ? $item->folder : JText::_('COM_INSTALLER_TYPE_NONAPPLICABLE'); ?></td>				<td class="center"><?php echo $client; ?></td>				<td><?php echo $item->detailsurl ?>					<?php if (isset($item->infourl)) : ?>					<br /><a href="<?php echo $item->infourl;?>"><?php echo $item->infourl;?></a>					<?php endif; ?>				</td>			</tr>		<?php endforeach;?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<?php else : ?>		<p class="nowarning"><?php echo JText::_('COM_INSTALLER_MSG_UPDATE_NOUPDATES'); ?></p>	<?php endif; ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form></div>
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><fieldset id="filter-bar"><legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>	<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_MODULES_MODULES_FILTER_SEARCH_DESC'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>	</div>	<div class="filter-select">			<label class="selectlabel" for="filter_client_id">				<?php echo JText::_('COM_INSTALLER_VALUE_CLIENT_SELECT'); ?>			</label>			<select name="filter_client_id" class="inputbox" id="filter_client_id">				<?php echo JHtml::_('select.options', array('0' => JText::_('JSITE'), '1' => JText::_('JADMINISTRATOR')), 'value', 'text', $this->state->get('filter.client_id'), true);?>			</select>            <label class="selectlabel" for="filter_status">				<?php echo JText::_('COM_INSTALLER_VALUE_STATE_SELECT'); ?>			</label>			<select name="filter_status" class="inputbox" id="filter_status">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', InstallerHelper::getExtensionTypes(), 'value', 'text', $this->state->get('filter.status'), true);?>			</select>            <label class="selectlabel" for="filter_type">				<?php echo JText::_('COM_INSTALLER_VALUE_TYPE_SELECT'); ?>			</label>			<select name="filter_type" class="inputbox" id="filter_type">				<option value=""><?php echo JText::_('COM_INSTALLER_VALUE_TYPE_SELECT');?></option>				<?php echo JHtml::_('select.options', InstallerHelper::getExtensionTypes(), 'value', 'text', $this->state->get('filter.type'), true);?>			</select>			<label class="selectlabel" for="filter_group">				<?php echo JText::_('COM_INSTALLER_VALUE_FOLDER_SELECT'); ?>			</label>			<select name="filter_group" class="inputbox" id="filter_group">				<option value=""><?php echo JText::_('COM_INSTALLER_VALUE_FOLDER_SELECT');?></option>				<?php echo JHtml::_('select.options', array_merge(InstallerHelper::getExtensionGroupes(), array('*' => JText::_('COM_INSTALLER_VALUE_FOLDER_NONAPPLICABLE'))), 'value', 'text', $this->state->get('filter.group'), true);?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div></fieldset><div class="clr"></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * User notes list view * * @package     Joomla.Administrator * @subpackage  com_users * @since       2.5 */class UsersViewNotes extends JViewLegacy{	/**	 * A list of user note objects.	 *	 * @var    array	 * @since  2.5	 */	protected $items;	/**	 * The pagination object.	 *	 * @var    JPagination	 * @since  2.5	 */	protected $pagination;	/**	 * The model state.	 *	 * @var    JObject	 * @since  2.5	 */	protected $state;	/**	 * The model state.	 *	 * @var    JUser	 * @since  2.5	 */	protected $user;	/**	 * Override the display method for the view.	 *	 * @param   string  $tpl  The name of the template file to parse; automatically searches through the template paths.	 *	 * @return  mixed  A string if successful, otherwise a JError object.	 *	 * @since   2.5	 */	public function display($tpl = null)	{		// Initialise view variables.		$this->items      = $this->get('Items');		$this->pagination = $this->get('Pagination');		$this->state      = $this->get('State');		$this->user       = $this->get('User');		UsersHelper::addSubmenu('notes');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			throw new Exception(implode("\n", $errors), 500);		}		// Get the component HTML helpers		JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');		// turn parameters into registry objects		foreach ($this->items as $item)		{			$item->cparams = new JRegistry;			$item->cparams->loadString($item->category_params);		}		$this->addToolbar();		$this->sidebar = JHtmlSidebar::render();		parent::display($tpl);	}	/**	 * Display the toolbar.	 *	 * @return  void	 *	 * @since   2.5	 */	protected function addToolbar()	{		$canDo = UsersHelper::getActions();		JToolbarHelper::title(JText::_('COM_USERS_VIEW_NOTES_TITLE'), 'user');		if ($canDo->get('core.create'))		{			JToolbarHelper::addNew('note.add');		}		if ($canDo->get('core.edit'))		{			JToolbarHelper::editList('note.edit');		}		if ($canDo->get('core.edit.state'))		{			JToolbarHelper::divider();			JToolbarHelper::publish('notes.publish', 'JTOOLBAR_PUBLISH', true);			JToolbarHelper::unpublish('notes.unpublish', 'JTOOLBAR_UNPUBLISH', true);			JToolbarHelper::divider();			JToolbarHelper::archiveList('notes.archive');			JToolbarHelper::checkin('notes.checkin');		}		if ($this->state->get('filter.state') == -2 && $canDo->get('core.delete'))		{			JToolbarHelper::deleteList('', 'notes.delete', 'JTOOLBAR_EMPTY_TRASH');			JToolbarHelper::divider();		}		elseif ($canDo->get('core.edit.state'))		{			JToolbarHelper::trash('notes.trash');			JToolbarHelper::divider();		}		if ($canDo->get('core.admin'))		{			JToolbarHelper::preferences('com_users');			JToolbarHelper::divider();		}		JToolbarHelper::help('JHELP_USERS_USER_NOTES');		JHtmlSidebar::setAction('index.php?option=com_users&view=notes');		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_PUBLISHED'),			'filter_published',			JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.state'), true)		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_CATEGORY'),			'filter_category_id',			JHtml::_('select.options', JHtml::_('category.options', 'com_users.notes'), 'value', 'text', $this->state->get('filter.category_id'))		);	}}
<?php/** * @package     Joomla.Legacy * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.filesystem.folder');/** * Form Field to display a list of the layouts for module display from the module or template overrides. * * @package     Joomla.Legacy * @subpackage  Form * @since       11.1 */class JFormFieldModulelayout extends JFormField{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	protected $type = 'ModuleLayout';	/**	 * Method to get the field input for module layouts.	 *	 * @return  string  The field input.	 *	 * @since   11.1	 */	protected function getInput()	{		// Get the client id.		$clientId = $this->element['client_id'];		if (is_null($clientId) && $this->form instanceof JForm)		{			$clientId = $this->form->getValue('client_id');		}		$clientId = (int) $clientId;		$client = JApplicationHelper::getClientInfo($clientId);		// Get the module.		$module = (string) $this->element['module'];		if (empty($module) && ($this->form instanceof JForm))		{			$module = $this->form->getValue('module');		}		$module = preg_replace('#\W#', '', $module);		// Get the template.		$template = (string) $this->element['template'];		$template = preg_replace('#\W#', '', $template);		// Get the style.		if ($this->form instanceof JForm)		{			$template_style_id = $this->form->getValue('template_style_id');		}		$template_style_id = preg_replace('#\W#', '', $template_style_id);		// If an extension and view are present build the options.		if ($module && $client)		{			// Load language file			$lang = JFactory::getLanguage();			$lang->load($module . '.sys', $client->path, null, false, false)				|| $lang->load($module . '.sys', $client->path . '/modules/' . $module, null, false, false)				|| $lang->load($module . '.sys', $client->path, $lang->getDefault(), false, false)				|| $lang->load($module . '.sys', $client->path . '/modules/' . $module, $lang->getDefault(), false, false);			// Get the database object and a new query object.			$db = JFactory::getDbo();			$query = $db->getQuery(true);			// Build the query.			$query->select('element, name')				->from('#__extensions as e')				->where('e.client_id = ' . (int) $clientId)				->where('e.type = ' . $db->quote('template'))				->where('e.enabled = 1');			if ($template)			{				$query->where('e.element = ' . $db->quote($template));			}			if ($template_style_id)			{				$query->join('LEFT', '#__template_styles as s on s.template=e.element')					->where('s.id=' . (int) $template_style_id);			}			// Set the query and load the templates.			$db->setQuery($query);			$templates = $db->loadObjectList('element');			// Build the search paths for module layouts.			$module_path = JPath::clean($client->path . '/modules/' . $module . '/tmpl');			// Prepare array of component layouts			$module_layouts = array();			// Prepare the grouped list			$groups = array();			// Add the layout options from the module path.			if (is_dir($module_path) && ($module_layouts = JFolder::files($module_path, '^[^_]*\.php$')))			{				// Create the group for the module				$groups['_'] = array();				$groups['_']['id'] = $this->id . '__';				$groups['_']['text'] = JText::sprintf('JOPTION_FROM_MODULE');				$groups['_']['items'] = array();				foreach ($module_layouts as $file)				{					// Add an option to the module group					$value = basename($file, '.php');					$text = $lang->hasKey($key = strtoupper($module . '_LAYOUT_' . $value)) ? JText::_($key) : $value;					$groups['_']['items'][] = JHtml::_('select.option', '_:' . $value, $text);				}			}			// Loop on all templates			if ($templates)			{				foreach ($templates as $template)				{					// Load language file					$lang->load('tpl_' . $template->element . '.sys', $client->path, null, false, false)						|| $lang->load('tpl_' . $template->element . '.sys', $client->path . '/templates/' . $template->element, null, false, false)						|| $lang->load('tpl_' . $template->element . '.sys', $client->path, $lang->getDefault(), false, false)						|| $lang->load(						'tpl_' . $template->element . '.sys', $client->path . '/templates/' . $template->element, $lang->getDefault(),						false, false					);					$template_path = JPath::clean($client->path . '/templates/' . $template->element . '/html/' . $module);					// Add the layout options from the template path.					if (is_dir($template_path) && ($files = JFolder::files($template_path, '^[^_]*\.php$')))					{						foreach ($files as $i => $file)						{							// Remove layout that already exist in component ones							if (in_array($file, $module_layouts))							{								unset($files[$i]);							}						}						if (count($files))						{							// Create the group for the template							$groups[$template->element] = array();							$groups[$template->element]['id'] = $this->id . '_' . $template->element;							$groups[$template->element]['text'] = JText::sprintf('JOPTION_FROM_TEMPLATE', $template->name);							$groups[$template->element]['items'] = array();							foreach ($files as $file)							{								// Add an option to the template group								$value = basename($file, '.php');								$text = $lang->hasKey($key = strtoupper('TPL_' . $template->element . '_' . $module . '_LAYOUT_' . $value))									? JText::_($key) : $value;								$groups[$template->element]['items'][] = JHtml::_('select.option', $template->element . ':' . $value, $text);							}						}					}				}			}			// Compute attributes for the grouped list			$attr = $this->element['size'] ? ' size="' . (int) $this->element['size'] . '"' : '';			// Prepare HTML code			$html = array();			// Compute the current selected values			$selected = array($this->value);			// Add a grouped list			$html[] = JHtml::_(				'select.groupedlist', $groups, $this->name,				array('id' => $this->id, 'group.id' => 'id', 'list.attr' => $attr, 'list.select' => $selected)			);			return implode($html);		}		else		{			return '';		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// No access check.$controller	= JControllerLegacy::getInstance('Admin');$controller->execute(JFactory::getApplication()->input->get('task'));$controller->redirect();
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Form Field class for the Joomla Platform. * Displays options as a list of check boxes. * Multiselect may be forced to be true. * * @package     Joomla.Platform * @subpackage  Form * @see         JFormFieldCheckbox * @since       11.1 */class JFormFieldCheckboxes extends JFormField{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	protected $type = 'Checkboxes';	/**	 * Flag to tell the field to always be in multiple values mode.	 *	 * @var    boolean	 * @since  11.1	 */	protected $forceMultiple = true;	/**	 * Method to get the field input markup for check boxes.	 *	 * @return  string  The field input markup.	 *	 * @since   11.1	 */	protected function getInput()	{		$html = array();		// Initialize some field attributes.		$class = $this->element['class'] ? ' class="checkboxes ' . (string) $this->element['class'] . '"' : ' class="checkboxes"';		$checkedOptions = explode(',', (string) $this->element['checked']);		// Start the checkbox field output.		$html[] = '<fieldset id="' . $this->id . '"' . $class . '>';		// Get the field options.		$options = $this->getOptions();		// Build the checkbox field output.		$html[] = '<ul>';		foreach ($options as $i => $option)		{			// Initialize some option attributes.			if (!isset($this->value) || empty($this->value))			{				$checked = (in_array((string) $option->value, (array) $checkedOptions) ? ' checked="checked"' : '');			}			else			{				$value = !is_array($this->value) ? explode(',', $this->value) : $this->value;				$checked = (in_array((string) $option->value, $value) ? ' checked="checked"' : '');			}			$class = !empty($option->class) ? ' class="' . $option->class . '"' : '';			$required = !empty($option->required) ? ' required="required" aria-required="true"' : '';			$disabled = !empty($option->disable) ? ' disabled="disabled"' : '';			// Initialize some JavaScript option attributes.			$onclick = !empty($option->onclick) ? ' onclick="' . $option->onclick . '"' : '';			$html[] = '<li>';			$html[] = '<input type="checkbox" id="' . $this->id . $i . '" name="' . $this->name . '" value="'				. htmlspecialchars($option->value, ENT_COMPAT, 'UTF-8') . '"' . $checked . $class . $onclick . $disabled . $required . '/>';			$html[] = '<label for="' . $this->id . $i . '"' . $class . '>' . JText::_($option->text) . '</label>';			$html[] = '</li>';		}		$html[] = '</ul>';		// End the checkbox field output.		$html[] = '</fieldset>';		return implode($html);	}	/**	 * Method to get the field options.	 *	 * @return  array  The field option objects.	 *	 * @since   11.1	 */	protected function getOptions()	{		$options = array();		foreach ($this->element->children() as $option)		{			// Only add <option /> elements.			if ($option->getName() != 'option')			{				continue;			}			// Create a new option object based on the <option /> element.			$tmp = JHtml::_(				'select.option', (string) $option['value'], trim((string) $option), 'value', 'text',				((string) $option['disabled'] == 'true')			);			// Set some option attributes.			$tmp->class = (string) $option['class'];			// Set some JavaScript option attributes.			$tmp->onclick = (string) $option['onclick'];			// Add the option object to the result set.			$options[] = $tmp;		}		reset($options);		return $options;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;// Register dependent classes.JLoader::register('FinderIndexer', JPATH_COMPONENT_ADMINISTRATOR . '/helpers/indexer/indexer.php');/** * Indexer controller class for Finder. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderControllerIndexer extends JControllerLegacy{	/**	 * Method to start the indexer.	 *	 * @return  void	 *	 * @since   2.5	 */	public function start()	{		static $log;		$params = JComponentHelper::getParams('com_finder');		if ($params->get('enable_logging', '0'))		{			if ($log == null)			{				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';				$options['text_file'] = 'indexer.php';				$log = JLog::addLogger($options);			}		}		// Log the start		JLog::add('Starting the indexer', JLog::INFO);		// We don't want this form to be cached.		header('Pragma: no-cache');		header('Cache-Control: no-cache');		header('Expires: -1');		// Check for a valid token. If invalid, send a 403 with the error message.		JSession::checkToken('request') or $this->sendResponse(new Exception(JText::_('JINVALID_TOKEN'), 403));		// Put in a buffer to silence noise.		ob_start();		// Reset the indexer state.		FinderIndexer::resetState();		// Import the finder plugins.		JPluginHelper::importPlugin('finder');		// Add the indexer language to JS		JText::script('COM_FINDER_AN_ERROR_HAS_OCCURRED');		JText::script('COM_FINDER_NO_ERROR_RETURNED');		// Start the indexer.		try		{			// Trigger the onStartIndex event.			JEventDispatcher::getInstance()->trigger('onStartIndex');			// Get the indexer state.			$state = FinderIndexer::getState();			$state->start = 1;			// Send the response.			$this->sendResponse($state);		}		// Catch an exception and return the response.		catch (Exception $e)		{			$this->sendResponse($e);		}	}	/**	 * Method to run the next batch of content through the indexer.	 *	 * @return  void	 *	 * @since   2.5	 */	public function batch()	{		static $log;		$params = JComponentHelper::getParams('com_finder');		if ($params->get('enable_logging', '0'))		{			if ($log == null)			{				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';				$options['text_file'] = 'indexer.php';				$log = JLog::addLogger($options);			}		}		// Log the start		JLog::add('Starting the indexer batch process', JLog::INFO);		// We don't want this form to be cached.		header('Pragma: no-cache');		header('Cache-Control: no-cache');		header('Expires: -1');		// Check for a valid token. If invalid, send a 403 with the error message.		JSession::checkToken('request') or $this->sendResponse(new Exception(JText::_('JINVALID_TOKEN'), 403));		// Put in a buffer to silence noise.		ob_start();		// Remove the script time limit.		@set_time_limit(0);		// Get the indexer state.		$state = FinderIndexer::getState();		// Reset the batch offset.		$state->batchOffset = 0;		// Update the indexer state.		FinderIndexer::setState($state);		// Import the finder plugins.		JPluginHelper::importPlugin('finder');		/*		 * We are going to swap out the raw document object with an HTML document		 * in order to work around some plugins that don't do proper environment		 * checks before trying to use HTML document functions.		 */		$raw = clone(JFactory::getDocument());		$lang = JFactory::getLanguage();		// Get the document properties.		$attributes = array (			'charset'	=> 'utf-8',			'lineend'	=> 'unix',			'tab'		=> '  ',			'language'	=> $lang->getTag(),			'direction'	=> $lang->isRTL() ? 'rtl' : 'ltr'		);		// Get the HTML document.		$html = JDocument::getInstance('html', $attributes);		$doc = JFactory::getDocument();		// Swap the documents.		$doc = $html;		// Get the admin application.		$admin = clone(JFactory::getApplication());		// Get the site app.		include_once JPATH_SITE . '/includes/application.php';		$site = JApplication::getInstance('site');		// Swap the app.		$app = JFactory::getApplication();		$app = $site;		// Start the indexer.		try		{			// Trigger the onBeforeIndex event.			JEventDispatcher::getInstance()->trigger('onBeforeIndex');			// Trigger the onBuildIndex event.			JEventDispatcher::getInstance()->trigger('onBuildIndex');			// Get the indexer state.			$state = FinderIndexer::getState();			$state->start = 0;			$state->complete = 0;			// Swap the documents back.			$doc = $raw;			// Swap the applications back.			$app = $admin;			// Send the response.			$this->sendResponse($state);		}		// Catch an exception and return the response.		catch (Exception $e)		{			// Swap the documents back.			$doc = $raw;			// Send the response.			$this->sendResponse($e);		}	}	/**	 * Method to optimize the index and perform any necessary cleanup.	 *	 * @return  void	 *	 * @since   2.5	 */	public function optimize()	{		// We don't want this form to be cached.		header('Pragma: no-cache');		header('Cache-Control: no-cache');		header('Expires: -1');		// Check for a valid token. If invalid, send a 403 with the error message.		JSession::checkToken('request') or $this->sendResponse(new Exception(JText::_('JINVALID_TOKEN'), 403));		// Put in a buffer to silence noise.		ob_start();		// Import the finder plugins.		JPluginHelper::importPlugin('finder');		try		{			// Optimize the index			FinderIndexer::getInstance()->optimize();			// Get the indexer state.			$state = FinderIndexer::getState();			$state->start = 0;			$state->complete = 1;			// Send the response.			$this->sendResponse($state);		}		// Catch an exception and return the response.		catch (Exception $e)		{			$this->sendResponse($e);		}	}	/**	 * Method to handle a send a JSON response. The body parameter	 * can be a Exception object for when an error has occurred or	 * a JObject for a good response.	 *	 * @param   mixed  $data  JObject on success, Exception on error. [optional]	 *	 * @return  void	 *	 * @since   2.5	 */	public static function sendResponse($data = null)	{		static $log;		$params = JComponentHelper::getParams('com_finder');		if ($params->get('enable_logging', '0'))		{			if ($log == null)			{				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';				$options['text_file'] = 'indexer.php';				$log = JLog::addLogger($options);			}		}		// Send the assigned error code if we are catching an exception.		if ($data instanceof Exception)		{			JLog::add($data->getMessage(), JLog::ERROR);			JResponse::setHeader('status', $data->getCode());			JResponse::sendHeaders();		}		// Create the response object.		$response = new FinderIndexerResponse($data);		// Add the buffer.		$response->buffer = JDEBUG ? ob_get_contents() : ob_end_clean();		// Send the JSON response.		echo json_encode($response);		// Close the application.		JFactory::getApplication()->close();	}}/** * Finder Indexer JSON Response Class * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderIndexerResponse{	/**	 * Class Constructor	 *	 * @param   mixed  $state  The processing state for the indexer	 *	 * @since   2.5	 */	public function __construct($state)	{		static $log;		$params = JComponentHelper::getParams('com_finder');		if ($params->get('enable_logging', '0'))		{			if ($log == null)			{				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';				$options['text_file'] = 'indexer.php';				$log = JLog::addLogger($options);			}		}		// The old token is invalid so send a new one.		$this->token = JFactory::getSession()->getFormToken();		// Check if we are dealing with an error.		if ($state instanceof Exception)		{			// Log the error			JLog::add($state->getMessage(), JLog::ERROR);			// Prepare the error response.			$this->error = true;			$this->header = JText::_('COM_FINDER_INDEXER_HEADER_ERROR');			$this->message = $state->getMessage();		}		else		{			// Prepare the response data.			$this->batchSize = (int) $state->batchSize;			$this->batchOffset = (int) $state->batchOffset;			$this->totalItems = (int) $state->totalItems;			$this->startTime = $state->startTime;			$this->endTime = JFactory::getDate()->toSQL();			$this->start = !empty($state->start) ? (int) $state->start : 0;			$this->complete = !empty($state->complete) ? (int) $state->complete : 0;			// Set the appropriate messages.			if ($this->totalItems <= 0 && $this->complete)			{				$this->header = JText::_('COM_FINDER_INDEXER_HEADER_COMPLETE');				$this->message = JText::_('COM_FINDER_INDEXER_MESSAGE_COMPLETE');			}			elseif ($this->totalItems <= 0)			{				$this->header = JText::_('COM_FINDER_INDEXER_HEADER_OPTIMIZE');				$this->message = JText::_('COM_FINDER_INDEXER_MESSAGE_OPTIMIZE');			}			else			{				$this->header = JText::_('COM_FINDER_INDEXER_HEADER_RUNNING');				$this->message = JText::_('COM_FINDER_INDEXER_MESSAGE_RUNNING');			}		}	}}// Register the error handler.JError::setErrorHandling(E_ALL, 'callback', array('FinderControllerIndexer', 'sendResponse'));
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Form Rule class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Form * @since       11.1 */class JFormRuleUsername extends JFormRule{	/**	 * Method to test the username for uniqueness.	 *	 * @param   SimpleXMLElement  $element  The SimpleXMLElement object representing the <field /> tag for the form field object.	 * @param   mixed             $value    The form field value to validate.	 * @param   string            $group    The field name group control value. This acts as as an array container for the field.	 *                                      For example if the field has name="foo" and the group value is set to "bar" then the	 *                                      full field name would end up being "bar[foo]".	 * @param   JRegistry         $input    An optional JRegistry object with the entire data set to validate against the entire form.	 * @param   JForm             $form     The form object for which the field is being tested.	 *	 * @return  boolean  True if the value is valid, false otherwise.	 *	 * @since   11.1	 */	public function test(SimpleXMLElement $element, $value, $group = null, JRegistry $input = null, JForm $form = null)	{		// Get the database object and a new query object.		$db = JFactory::getDbo();		$query = $db->getQuery(true);		// Build the query.		$query->select('COUNT(*)')			->from('#__users')			->where('username = ' . $db->quote($value));		// Get the extra field check attribute.		$userId = ($form instanceof JForm) ? $form->getValue('id') : '';		$query->where($db->quoteName('id') . ' <> ' . (int) $userId);		// Set and query the database.		$db->setQuery($query);		$duplicate = (bool) $db->loadResult();		if ($duplicate)		{			return false;		}		return true;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Facebook * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Facebook API User class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Facebook * * @see         http://developers.facebook.com/docs/reference/api/event/ * @since       13.1 */class JFacebookEvent extends JFacebookObject{	/**	 * Method to get information about an event visible to the current user. Requires authentication.	 *	 * @param   string  $event  The event id.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getEvent($event)	{		return $this->get($event);	}	/**	 * Method to get the event's wall. Requires authentication.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getFeed($event, $limit = 0, $offset = 0, $until = null, $since = null)	{		return $this->getConnection($event, 'feed', '', $limit, $offset, $until, $since);	}	/**	 * Method to post a link on event's feed which the current_user is or maybe attending. Requires authentication and publish_stream permission.	 *	 * @param   string  $event    The event id.	 * @param   string  $link     Link URL.	 * @param   string  $message  Link message.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createLink($event, $link, $message = null)	{		// Set POST request parameters.		$data = array();		$data['link'] = $link;		$data['message'] = $message;		return $this->createConnection($event, 'feed', $data);	}	/**	 * Method to delete a link. Requires authentication and publish_stream permission.	 *	 * @param   mixed  $link  The Link ID.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteLink($link)	{		return $this->deleteConnection($link);	}	/**	 * Method to post on event's wall. Message or link parameter is required. Requires authentication and publish_stream permission.	 *	 * @param   string  $event        The event id.	 * @param   string  $message      Post message.	 * @param   string  $link         Post URL.	 * @param   string  $picture      Post thumbnail image (can only be used if link is specified)	 * @param   string  $name         Post name (can only be used if link is specified).	 * @param   string  $caption      Post caption (can only be used if link is specified).	 * @param   string  $description  Post description (can only be used if link is specified).	 * @param   array   $actions      Post actions array of objects containing name and link.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createPost($event, $message = null, $link = null, $picture = null, $name = null, $caption = null,		$description = null, $actions = null)	{		// Set POST request parameters.		$data = array();		$data['message'] = $message;		$data['link'] = $link;		$data['name'] = $name;		$data['caption'] = $caption;		$data['description'] = $description;		$data['actions'] = $actions;		$data['picture'] = $picture;		return $this->createConnection($event, 'feed', $data);	}	/**	 * Method to delete a post. Note: you can only delete the post if it was created by the current user.	 * Requires authentication and publish_stream permission.	 *	 * @param   string  $post  The Post ID.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deletePost($post)	{		return $this->deleteConnection($post);	}	/**	 * Method to post a status message on behalf of the user on the event's wall. Requires authentication and publish_stream permission.	 *	 * @param   string  $event    The event id.	 * @param   string  $message  Status message content.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createStatus($event, $message)	{		// Set POST request parameters.		$data = array();		$data['message'] = $message;		return $this->createConnection($event, 'feed', $data);	}	/**	 * Method to delete a status. Note: you can only delete the post if it was created by the current user.	 * Requires authentication and publish_stream permission.	 *	 * @param   string  $status  The Status ID.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteStatus($status)	{		return $this->deleteConnection($status);	}	/**	 * Method to get the list of invitees for the event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getInvited($event, $limit = 0, $offset = 0)	{		return $this->getConnection($event, 'invited', '', $limit, $offset);	}	/**	 * Method to check if a user is invited to the event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string  $event  The event id.	 * @param   mixed   $user   Either an integer containing the user ID or a string containing the username.	 *	 * @return  array   The decoded JSON response or an empty array if the user is not invited.	 *	 * @since   13.1	 */	public function isInvited($event, $user)	{		return $this->getConnection($event, 'invited/' . $user);	}	/**	 * Method to invite users to the event. Requires authentication and create_event permission.	 *	 * @param   string  $event  The event id.	 * @param   string  $users  Comma separated list of user ids.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function createInvite($event, $users)	{		// Set POST request parameters.		$data = array();		$data['users'] = $users;		return $this->createConnection($event, 'invited', $data);	}	/**	 * Method to delete a invitation. Note: you can only delete the invite if the current user is the event admin.	 * Requires authentication and rsvp_event permission.	 *	 * @param   string  $event  The event id.	 * @param   string  $user   The user id.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteInvite($event, $user)	{		return $this->deleteConnection($event, 'invited/' . $user);	}	/**	 * Method to get the list of attending users. Requires authentication and user_events or friends_events permission.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getAttending($event, $limit = 0, $offset = 0)	{		return $this->getConnection($event, 'attending', '', $limit, $offset);	}	/**	 * Method to check if a user is attending an event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string  $event  The event id.	 * @param   mixed   $user   Either an integer containing the user ID or a string containing the username.	 *	 * @return  array   The decoded JSON response or an empty array if the user is not invited.	 *	 * @since   13.1	 */	public function isAttending($event, $user)	{		return $this->getConnection($event, 'attending/' . $user);	}	/**	 * Method to set the current user as attending. Requires authentication and rsvp_event permission.	 *	 * @param   string  $event  The event id.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function createAttending($event)	{		return $this->createConnection($event, 'attending');	}	/**	 * Method to get the list of maybe attending users. Requires authentication and user_events or friends_events permission.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getMaybe($event, $limit = 0, $offset = 0)	{		return $this->getConnection($event, 'maybe', '', $limit, $offset);	}	/**	 * Method to check if a user is maybe attending an event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string  $event  The event id.	 * @param   mixed   $user   Either an integer containing the user ID or a string containing the username.	 *	 * @return  array   The decoded JSON response or an empty array if the user is not invited.	 *	 * @since   13.1	 */	public function isMaybe($event, $user)	{		return $this->getConnection($event, 'maybe/' . $user);	}	/**	 * Method to set the current user as maybe attending. Requires authentication and rscp_event permission.	 *	 * @param   string  $event  The event id.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function createMaybe($event)	{		return $this->createConnection($event, 'maybe');	}	/**	 * Method to get the list of users which declined the event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getDeclined($event, $limit = 0, $offset = 0)	{		return $this->getConnection($event, 'declined', '', $limit, $offset);	}	/**	 * Method to check if a user responded 'no' to the event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string  $event  The event id.	 * @param   mixed   $user   Either an integer containing the user ID or a string containing the username.	 *	 * @return  array   The decoded JSON response or an empty array if the user is not invited.	 *	 * @since   13.1	 */	public function isDeclined($event, $user)	{		return $this->getConnection($event, 'declined/' . $user);	}	/**	 * Method to set the current user as declined. Requires authentication and rscp_event permission.	 *	 * @param   string  $event  The event id.	 *	 * @return  boolean   Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function createDeclined($event)	{		return $this->createConnection($event, 'declined');	}	/**	 * Method to get the list of users which have not replied to the event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getNoreply($event, $limit = 0, $offset = 0)	{		return $this->getConnection($event, 'noreply', '', $limit, $offset);	}	/**	 * Method to check if a user has not replied to the event. Requires authentication and user_events or friends_events permission.	 *	 * @param   string  $event  The event id.	 * @param   mixed   $user   Either an integer containing the user ID or a string containing the username.	 *	 * @return  array   The decoded JSON response or an empty array if the user is not invited.	 *	 * @since   13.1	 */	public function isNoreply($event, $user)	{		return $this->getConnection($event, 'noreply/' . $user);	}	/**	 * Method to get the event's profile picture. Requires authentication and user_events or friends_events permission.	 *	 * @param   string   $event     The event id.	 * @param   boolean  $redirect  If false this will return the URL of the picture without a 302 redirect.	 * @param   string   $type      To request a different photo use square | small | normal | large.	 *	 * @return  string   The URL to the event's profile picture.	 *	 * @since   13.1	 */	public function getPicture($event, $redirect = true, $type = null)	{		$extra_fields = '';		if ($redirect == false)		{			$extra_fields = '?redirect=false';		}		if ($type)		{			$extra_fields .= (strpos($extra_fields, '?') === false) ? '?type=' . $type : '&type=' . $type;		}		return $this->getConnection($event, 'picture', $extra_fields);	}	/**	 * Method to get photos published on event's wall. Requires authentication.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getPhotos($event, $limit = 0, $offset = 0, $until = null, $since = null)	{		return $this->getConnection($event, 'photos', '', $limit, $offset, $until, $since);	}	/**	 * Method to post a photo on event's wall. Requires authentication and publish_stream permission.	 *	 * @param   string  $event    The event id.	 * @param   string  $source   Path to photo.	 * @param   string  $message  Photo description.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createPhoto($event, $source, $message = null)	{		// Set POST request parameters.		$data = array();		$data[basename($source)] = '@' . realpath($source);		if ($message)		{			$data['message'] = $message;		}		return $this->createConnection($event, 'photos', $data, array('Content-Type' => 'multipart/form-data'));	}	/**	 * Method to get videos published on event's wall. Requires authentication.	 *	 * @param   string   $event   The event id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getVideos($event, $limit = 0, $offset = 0, $until = null, $since = null)	{		return $this->getConnection($event, 'videos', '', $limit, $offset, $until, $since);	}	/**	 * Method to post a video on event's wall. Requires authentication and publish_stream permission.	 *	 * @param   string  $event        The event id.	 * @param   string  $source       Path to photo.	 * @param   string  $title        Video title.	 * @param   string  $description  Video description.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createVideo($event, $source, $title = null, $description = null)	{		// Set POST request parameters.		$data = array();		$data[basename($source)] = '@' . realpath($source);		if ($title)		{			$data['title'] = $title;		}		if ($description)		{			$data['description'] = $description;		}		return $this->createConnection($event, 'videos', $data, array('Content-Type' => 'multipart/form-data'));	}}
<?php/** * @package     Joomla.Platform * @subpackage  MediaWiki * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * MediaWiki API Sites class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  MediaWiki * @since       12.3 */class JMediawikiSites extends JMediawikiObject{	/**     * Method to get site information.     *     * @param   array    $siprop            The sysinfo properties to get.     * @param   string   $sifilteriw        Only local or only non local entries to return.     * @param   boolean  $sishowalldb       List all database servers.     * @param   boolean  $sinumberingroup   List the number of users in usergroups.     * @param   array    $siinlanguagecode  Language code for localized languages.     *     * @return  object     *     * @since   12.3     */	public function getSiteInfo(array $siprop = null, $sifilteriw = null, $sishowalldb = false, $sinumberingroup = false, array $siinlanguagecode = null)	{		// Build the request.		$path = '?action=query&meta=siteinfo';		if (isset($siprop))		{			$path .= '&siprop=' . $this->buildParameter($siprop);		}		if (isset($sifilteriw))		{			$path .= '&sifilteriw=' . $sifilteriw;		}		if ($sishowalldb)		{			$path .= '&sishowalldb=';		}		if ($sinumberingroup)		{			$path .= '&sinumberingroup=';		}		if (isset($siinlanguagecode))		{			$path .= '&siinlanguagecode=' . $this->buildParameter($siinlanguagecode);		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get events from logs.     *     * @param   array    $leprop    List of properties to get.     * @param   string   $letype    Filter log actions to only this type.     * @param   string   $leaction  Filter log actions to only this type.     * @param   string   $letitle   Filter entries to those related to a page.     * @param   string   $leprefix  Filter entries that start with this prefix.     * @param   string   $letag     Filter entries with tag.     * @param   string   $leuser    Filter entries made by the given user.     * @param   string   $lestart   Starting timestamp.     * @param   string   $leend     Ending timestamp.     * @param   string   $ledir     Direction of enumeration.     * @param   integer  $lelimit   Event limit to return.     *     * @return  object     *     * @since   12.3     */	public function getEvents(array $leprop = null, $letype = null, $leaction = null, $letitle = null, $leprefix = null, $letag = null,		$leuser = null, $lestart = null, $leend = null, $ledir = null, $lelimit = null)	{		// Build the request		$path = '?action=query&list=logevents';		if (isset($leprop))		{			$path .= '&leprop=' . $this->buildParameter($leprop);		}		if (isset($letype))		{			$path .= '&letype=' . $letype;		}		if (isset($leaction))		{			$path .= '&leaction=' . $leaction;		}		if (isset($letitle))		{			$path .= '&letitle=' . $letitle;		}		if (isset($leprefix))		{			$path .= '&leprefix=' . $leprefix;		}		if (isset($letag))		{			$path .= '&letag=' . $letag;		}		if (isset($leuser))		{			$path .= '&leuser=' . $leuser;		}		if (isset($lestart))		{			$path .= '&lestart=' . $lestart;		}		if (isset($leend))		{			$path .= '&leend=' . $leend;		}		if (isset($ledir))		{			$path .= '&ledir=' . $ledir;		}		if (isset($lelimit))		{			$path .= '&lelimit=' . $lelimit;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get recent changes on a site.     *     * @param   string  $rcstart        Starting timestamp.     * @param   string  $rcend          Ending timestamp.     * @param   string  $rcdir          Direction of enumeration.     * @param   array   $rcnamespace    Filter changes to only this namespace(s).     * @param   string  $rcuser         Filter changes by this user.     * @param   string  $rcexcludeuser  Filter changes to exclude changes by this user.     * @param   string  $rctag          Filter changes by this tag.     * @param   array   $rcprop         Filter log actions to only this type.     * @param   array   $rctoken        Which token to obtain for each change.     * @param   array   $rcshow         Filter changes by this criteria.     * @param   string  $rclimit        Changes limit to return.     * @param   string  $rctype         Filter event by type of changes.     * @param   string  $rctoponly      Filter changes which are latest revision.     *     * @return  object     *     * @since   12.3     */	public function getRecentChanges($rcstart = null, $rcend = null, $rcdir = null, array $rcnamespace = null, $rcuser = null, $rcexcludeuser = null,		$rctag = null, array $rcprop = null, array $rctoken = null, array $rcshow = null, $rclimit = null, $rctype = null, $rctoponly = null)	{		// Build the request.		$path = '?action=query&list=recentchanges';		if (isset($rcstart))		{			$path .= '&rcstart=' . $rcstart;		}		if (isset($rcend))		{			$path .= '&rcend=' . $rcend;		}		if (isset($rcdir))		{			$path .= '&rcdir=' . $rcdir;		}		if (isset($rcnamespace))		{			$path .= '&rcnamespaces=' . $this->buildParameter($rcnamespace);		}		if (isset($rcuser))		{			$path .= '&rcuser=' . $rcuser;		}		if (isset($rcexcludeuser))		{			$path .= '&rcexcludeuser=' . $rcexcludeuser;		}		if (isset($rctag))		{			$path .= '&rctag=' . $rctag;		}		if (isset($rcprop))		{			$path .= '&rcprop=' . $this->buildParameter($rcprop);		}		if (isset($rctoken))		{			$path .= '&rctoken=' . $this->buildParameter($rctoken);		}		if (isset($rcshow))		{			$path .= '&rcshow=' . $this->buildParameter($rcshow);		}		if (isset($rclimit))		{			$path .= '&rclimit=' . $rclimit;		}		if (isset($rctype))		{			$path .= '&rctype=' . $rctype;		}		if (isset($rctoponly))		{			$path .= '&rctoponly=' . $rctoponly;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get protected titles on a site.     *     * @param   array    $ptnamespace  Only list titles in this namespace.     * @param   array    $ptlevel      Only list titles with these protection level.     * @param   integer  $ptlimit      Limit of pages to return.     * @param   string   $ptdir        Direction of enumeration.     * @param   string   $ptstart      Starting timestamp.     * @param   string   $ptend        Ending timestamp.     * @param   array    $ptprop       List of properties to get.     *     * @return  object     *     * @since   12.3     */	public function getProtectedTitles(array $ptnamespace = null, array $ptlevel = null, $ptlimit = null, $ptdir = null, $ptstart = null,		$ptend = null, array $ptprop = null)	{		// Build the request.		$path = '?action=query&list=protectedtitles';		if (isset($ptnamespace))		{			$path .= '&ptnamespace=' . $this->buildParameter($ptnamespace);		}		if (isset($ptlevel))		{			$path .= '&ptlevel=' . $this->buildParameter($ptlevel);		}		if (isset($ptlimit))		{			$path .= '&ptlimit=' . $ptlimit;		}		if (isset($ptdir))		{			$path .= '&ptdir=' . $ptdir;		}		if (isset($ptstart))		{			$path .= '&ptstart=' . $ptstart;		}		if (isset($ptend))		{			$path .= '&ptend=' . $ptend;		}		if (isset($ptprop))		{			$path .= '&ptprop=' . $this->buildParameter($ptprop);		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_languages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * JSON Response class * * @package     Joomla.Administrator * @subpackage  com_languages * @since       2.5 */class JJsonResponse{	/**	 * Determines whether the request was successful	 *	 * @var		boolean	 * @since	2.5	 */	public $success = true;	/**	 * Determines whether the request wasn't successful.	 * This is always the negation of $this->success,	 * so you can use both flags equivalently.	 *	 * @var		boolean	 * @since	2.5	 */	public $error = false;	/**	 * The main response message	 *	 * @var		string	 * @since	2.5	 */	public $message = null;	/**	 * Array of messages gathered in the JApplication object	 *	 * @var		array	 * @since	2.5	 */	public $messages = null;	/**	 * The response data	 *	 * var		array/object	 * @since	2.5	 */	public $data = null;	/**	 * Constructor	 *	 * @param   	array/object	$response	The Response data	 * @param   	string				$message	The main response message	 * @param   	boolean				$error		True, if the success flag shall be set to false, defaults to false	 *	 * @return  void	 *	 * @since		2.5	 */	public function __construct($response = null, $message = null, $error = false)	{		$this->message = $message;		// Get the message queue		$messages = JFactory::getApplication()->getMessageQueue();		// Build the sorted messages list		if (is_array($messages) && count($messages))		{			foreach ($messages as $message)			{				if (isset($message['type']) && isset($message['message']))				{					$lists[$message['type']][] = $message['message'];				}			}		}		// If messages exist add them to the output		if (isset($lists) && is_array($lists))		{			$this->messages = $lists;		}		// Check if we are dealing with an error		if ($response instanceof Exception)		{			// Prepare the error response			$this->success = false;			$this->error = true;			$this->message	= $response->getMessage();		}		else		{			// Prepare the response data			$this->success = !$error;			$this->error = $error;			$this->data = $response;		}	}	/**	 * Magic toString method for sending the response in JSON format	 *	 * @return  string	The response in JSON format	 *	 * @since		2.5	 */	public function __toString()	{		return json_encode($this);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');$user		= JFactory::getUser();$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_redirect&view=links'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_REDIRECT_SEARCH_LINKS'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_published">				<?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?>			</label>			<select name="filter_state" class="inputbox" id="filter_published">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', RedirectHelper::publishedOptions(), 'value', 'text', $this->state->get('filter.state'), true);?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="title">					<?php echo JHtml::_('grid.sort', 'COM_REDIRECT_HEADING_OLD_URL', 'a.old_url', $listDirn, $listOrder); ?>				</th>				<th class="width-30">					<?php echo JHtml::_('grid.sort', 'COM_REDIRECT_HEADING_NEW_URL', 'a.new_url', $listDirn, $listOrder); ?>				</th>				<th class="width-30">					<?php echo JHtml::_('grid.sort', 'COM_REDIRECT_HEADING_REFERRER', 'a.referer', $listDirn, $listOrder); ?>				</th>				<th class="width-10">					<?php echo JHtml::_('grid.sort', 'COM_REDIRECT_HEADING_CREATED_DATE', 'a.created_date', $listDirn, $listOrder); ?>				</th>				<th class="nowrap state-col">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'a.published', $listDirn, $listOrder); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) :			$canCreate = $user->authorise('core.create',     'com_redirect');			$canEdit   = $user->authorise('core.edit',       'com_redirect');			$canChange = $user->authorise('core.edit.state', 'com_redirect');			?>			<tr class="row<?php echo $i % 2; ?>">				<td class="center">					<?php echo JHtml::_('grid.id', $i, $item->id); ?>				</td>				<td>					<?php if ($canEdit) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_redirect&task=link.edit&id='.$item->id);?>" title="<?php echo $this->escape($item->old_url); ?>">							<?php echo $this->escape(str_replace(JURI::root(), '', $item->old_url)); ?></a>					<?php else : ?>							<?php echo $this->escape(str_replace(JURI::root(), '', $item->old_url)); ?>					<?php endif; ?>				</td>				<td>					<?php echo $this->escape($item->new_url); ?>				</td>				<td>					<?php echo $this->escape($item->referer); ?>				</td>				<td class="center">					<?php echo JHtml::_('date', $item->created_date, JText::_('DATE_FORMAT_LC4')); ?>				</td>				<td class="center">					<?php echo JHtml::_('redirect.published', $item->published, $i); ?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<p class="footer-tip">		<?php if ($this->enabled) : ?>			<span class="enabled"><?php echo JText::_('COM_REDIRECT_PLUGIN_ENABLED'); ?></span>		<?php else : ?>			<span class="disabled"><?php echo JText::_('COM_REDIRECT_PLUGIN_DISABLED'); ?></span>		<?php endif; ?>	</p>	<div class="clr"></div>	<?php if (!empty($this->items)) : ?>		<?php echo $this->loadTemplate('addform'); ?>	<?php endif; ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?></div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Form Field class for the Joomla Platform. * Single check box field. * This is a boolean field with null for false and the specified option for true * * @package     Joomla.Platform * @subpackage  Form * @link        http://www.w3.org/TR/html-markup/input.checkbox.html#input.checkbox * @see         JFormFieldCheckboxes * @since       11.1 */class JFormFieldCheckbox extends JFormField{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	public $type = 'Checkbox';	/**	 * Method to get the field input markup.	 * The checked element sets the field to selected.	 *	 * @return  string   The field input markup.	 *	 * @since   11.1	 */	protected function getInput()	{		// Initialize some field attributes.		$class = $this->element['class'] ? ' class="' . (string) $this->element['class'] . '"' : '';		$disabled = ((string) $this->element['disabled'] == 'true') ? ' disabled="disabled"' : '';		$value = $this->element['value'] ? (string) $this->element['value'] : '1';		$required = $this->required ? ' required="required" aria-required="true"' : '';		if (empty($this->value))		{			$checked = (isset($this->element['checked'] )) ? ' checked="checked"' : '';		}		else		{			$checked = ' checked="checked"';		}		// Initialize JavaScript field attributes.		$onclick = $this->element['onclick'] ? ' onclick="' . (string) $this->element['onclick'] . '"' : '';		return '<input type="checkbox" name="' . $this->name . '" id="' . $this->id . '" value="'			. htmlspecialchars($value, ENT_COMPAT, 'UTF-8') . '"' . $class . $checked . $disabled . $onclick . $required . ' />';	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Filter table class for the Finder package. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderTableFilter extends JTable{	/**	 * Constructor	 *	 * @param   JDatabaseDriver  &$db  JDatabaseDriver connector object.	 *	 * @since   2.5	 */	public function __construct(&$db)	{		parent::__construct('#__finder_filters', 'filter_id', $db);	}	/**	 * Method to bind an associative array or object to the JTable instance.  This	 * method only binds properties that are publicly accessible and optionally	 * takes an array of properties to ignore when binding.	 *	 * @param   array  $array   Named array	 * @param   mixed  $ignore  An optional array or space separated list of properties	 *                          to ignore while binding. [optional]	 *	 * @return  mixed  Null if operation was satisfactory, otherwise returns an error string	 *	 * @since   2.5	 */	public function bind($array, $ignore = '')	{		if (isset($array['params']) && is_array($array['params']))		{			$registry = new JRegistry;			$registry->loadArray($array['params']);			$array['params'] = (string) $registry;		}		return parent::bind($array, $ignore);	}	/**	 * Method to perform sanity checks on the JTable instance properties to ensure	 * they are safe to store in the database.  Child classes should override this	 * method to make sure the data they are storing in the database is safe and	 * as expected before storage.	 *	 * @return  boolean  True if the instance is sane and able to be stored in the database.	 *	 * @since   2.5	 */	public function check()	{		if (trim($this->alias) == '')		{			$this->alias = $this->title;		}		$this->alias = JApplication::stringURLSafe($this->alias);		if (trim(str_replace('-', '', $this->alias)) == '')		{			$this->alias = JFactory::getDate()->format('Y-m-d-H-i-s');		}		// Check the end date is not earlier than start up.		if ($this->d2 > $this->_db->getNullDate() && $this->d2 < $this->d1)		{			// Swap the dates.			$temp = $this->d1;			$this->d1 = $this->d2;			$this->d2 = $temp;		}		return true;	}	/**	 * Method to set the publishing state for a row or list of rows in the database	 * table. The method respects checked out rows by other users and will attempt	 * to checkin rows that it can after adjustments are made.	 *	 * @param   mixed    $pks     An array of primary key values to update.  If not	 *                            set the instance property value is used. [optional]	 * @param   integer  $state   The publishing state. eg. [0 = unpublished, 1 = published] [optional]	 * @param   integer  $userId  The user id of the user performing the operation. [optional]	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	public function publish($pks = null, $state = 1, $userId = 0)	{		$k = $this->_tbl_key;		// Sanitize input.		JArrayHelper::toInteger($pks);		$userId = (int) $userId;		$state = (int) $state;		// If there are no primary keys set check to see if the instance key is set.		if (empty($pks))		{			if ($this->$k)			{				$pks = array($this->$k);			}			// Nothing to set publishing state on, return false.			else			{				$this->setError(JText::_('JLIB_DATABASE_ERROR_NO_ROWS_SELECTED'));				return false;			}		}		// Build the WHERE clause for the primary keys.		$where = $k . '=' . implode(' OR ' . $k . '=', $pks);		// Determine if there is checkin support for the table.		if (!property_exists($this, 'checked_out') || !property_exists($this, 'checked_out_time'))		{			$checkin = '';		}		else		{			$checkin = ' AND (checked_out = 0 OR checked_out = ' . (int) $userId . ')';		}		// Update the publishing state for rows with the given primary keys.		$query = $this->_db->getQuery(true)			->update($this->_db->quoteName($this->_tbl))			->set($this->_db->quoteName('state') . ' = ' . (int) $state)			->where($where);		$this->_db->setQuery($query . $checkin);		try		{			$this->_db->execute();		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		// If checkin is supported and all rows were adjusted, check them in.		if ($checkin && (count($pks) == $this->_db->getAffectedRows()))		{			// Checkin the rows.			foreach ($pks as $pk)			{				$this->checkin($pk);			}		}		// If the JTable instance value is in the list of primary keys that were set, set the instance.		if (in_array($this->$k, $pks))		{			$this->state = $state;		}		$this->setError('');		return true;	}	/**	 * Method to store a row in the database from the JTable instance properties.	 * If a primary key value is set the row with that primary key value will be	 * updated with the instance property values.  If no primary key value is set	 * a new row will be inserted into the database with the properties from the	 * JTable instance.	 *	 * @param   boolean  $updateNulls  True to update fields even if they are null. [optional]	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	public function store($updateNulls = false)	{		$date = JFactory::getDate();		$user = JFactory::getUser();		if ($this->filter_id)		{			// Existing item			$this->modified = $date->toSql();			$this->modified_by = $user->get('id');		}		else		{			// New item. A filter's created field can be set by the user,			// so we don't touch it if it is set.			if (!(int) $this->created)			{				$this->created = $date->toSql();			}			if (empty($this->created_by))			{				$this->created_by = $user->get('id');			}		}		if (is_array($this->data))		{			$this->map_count = count($this->data);			$this->data = implode(',', $this->data);		}		else		{			$this->map_count = 0;			$this->data = implode(',', array());		}		// Verify that the alias is unique		$table = JTable::getInstance('Filter', 'FinderTable');		if ($table->load(array('alias' => $this->alias)) && ($table->filter_id != $this->filter_id || $this->filter_id == 0))		{			$this->setError(JText::_('JLIB_DATABASE_ERROR_ARTICLE_UNIQUE_ALIAS'));			return false;		}		return parent::store($updateNulls);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Utility class working with system * * @package     Joomla.Administrator * @subpackage  com_admin * @since       1.6 */abstract class JHtmlSystem{	/**	 * Method to generate a string message for a value	 *	 * @param string $val a php ini value	 *	 * @return  string html code	 */	public static function server($val)	{		if (empty($val))		{			return JText::_('COM_ADMIN_NA');		}		else		{			return $val;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><fieldset class="form-horizontal">	<legend><?php echo JText::_('COM_CONFIG_COOKIE_SETTINGS'); ?></legend>	<?php	foreach ($this->form->getFieldset('cookie') as $field):	?>		<div class="control-group">			<div class="control-label"><?php echo $field->label; ?></div>			<div class="controls"><?php echo $field->input; ?></div>		</div>	<?php	endforeach;	?></fieldset>
<?php/** * @package     Joomla.Platform * @subpackage  Openstreetmap * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Openstreetmap API Changesets class for the Joomla Platform * * @package     Joomla.Platform * @subpackage  Openstreetmap * * @since       13.1 */class JOpenstreetmapChangesets extends JOpenstreetmapObject{	/**	 * Method to create a changeset	 * 	 * @param   array  $changesets  array which contains changeset data	 * 	 * @return  array  The xml response	 * 	 * @since   13.1	 */	public function createChangeset($changesets=array())	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key'],				'oauth_token_secret' => $token['secret']		);		// Set the API base		$base = 'changeset/create';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$xml = '<?xml version="1.0" encoding="UTF-8"?>			<osm version="0.6" generator="JOpenstreetmap">';		if (!empty($changesets))		{			// Create Changeset element for every changeset			foreach ($changesets as $tags)			{				$xml .= '<changeset>';				$tag_list = '';				if (!empty($tags))				{					// Create a list of tags for each changeset					foreach ($tags as $key => $value)					{						$xml .= '<tag k="' . $key . '" v="' . $value . '"/>';					}				}				$xml .= '</changeset>';			}		}		$xml .= '</osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		return $response->body;	}	/**	 * Method to read a changeset	 * 	 * @param   int  $id  identifier of the changeset	 * 	 * @return  array    The xml response about a changeset	 *  	 * @since   13.1	 */	public function readChangeset($id)	{		// Set the API base		$base = 'changeset/' . $id;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->changeset;	}	/**	 * Method to update a changeset	 * 	 * @param   int    $id    identifier of the changeset	 * @param   array  $tags  array of tags to update	 * 	 * @return  array    The xml response of updated changeset	 * 	 * @since   13.1 	 */	public function updateChangeset($id, $tags=array() )	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'changeset/' . $id;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Create a list of tags to update changeset		$tag_list = '';		if (!empty($tags))		{			foreach ($tags as $key => $value)			{				$tag_list .= '<tag k="' . $key . '" v="' . $value . '"/>';			}		}		$xml = '<?xml version="1.0" encoding="UTF-8"?>				<osm version="0.6" generator="JOpenstreetmap">				<changeset>'				. $tag_list .				'</changeset>  				</osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		$xml_string = simplexml_load_string($response->body);		return $xml_string->changeset;	}	/**	 * Method to close a changeset	 * 	 * @param   int  $id  identifier of the changeset	 * 	 * @return  No value returns	 * 	 * @since   13.1	 */	public function closeChangeset($id)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'changeset/' . $id . '/close';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$header['format'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $header);	}	/**	 * Method to download a changeset	 * 	 * @param   int  $id  identifier of the changeset	 * 	 * @return  array	The xml response of requested changeset	 * 	 * @since   13.1	 */	public function downloadChangeset($id)	{		// Set the API base		$base = 'changeset/' . $id . '/download';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->create;	}	/**	 * Method to expand the bounding box of a changeset	 * 	 * @param   int    $id     identifier of the changeset	 * @param   array  $nodes  list of lat lon about nodes	 * 	 * @return  array    The xml response of changed changeset	 * 	 * @since   13.1	 */	public function expandBBoxChangeset($id, $nodes)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'changeset/' . $id . '/expand_bbox';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Create a list of tags to update changeset		$node_list = '';		if (!empty($nodes))		{			foreach ($nodes as $node)			{				$node_list .= '<node lat="' . $node[0] . '" lon="' . $node[1] . '"/>';			}		}		$xml = '<?xml version="1.0" encoding="UTF-8"?>				<osm version="0.6" generator="JOpenstreetmap">				<changeset>'				. $node_list .				'</changeset>			</osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'POST', $parameters, $xml, $header);		$xml_string = simplexml_load_string($response->body);		return $xml_string->changeset;	}	/**	 * Method to Query on changesets	 *  	 * @param   string  $param  parameters for query	 * 	 * @return  array    The xml response	 * 	 * @since   13.1	 */	public function queryChangeset($param)	{		// Set the API base		$base = 'changesets/' . $param;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->osm;	}	/**	 * Method to upload a diff to a changeset	 * 	 * @param   string  $xml  diff data to upload	 * @param   int     $id   identifier of the changeset	 * 	 * @return  array    The xml response of result	 * 	 * @since   13.1	 */	public function diffUploadChangeset($xml, $id)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'changeset/' . $id . '/upload';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'POST', $parameters, $xml, $header);		$xml_string = simplexml_load_string($response->body);		return $xml_string->diffResult;	}}
<?php/** * @package    Joomla.Installation * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/* @var InstallationViewLanguagesHtml $this */// Get version of Joomla! to compare it with the version of the language package$version = new JVersion;?><script type="text/javascript">	function installLanguages()	{		document.id(install_languages_desc).hide();		document.id(wait_installing).show();		document.id(wait_installing_spinner).show();		Install.submitform();	}</script><?php echo JHtml::_('installation.stepbarlanguages'); ?><form action="index.php" method="post" id="adminForm" class="form-validate form-horizontal">	<div class="btn-toolbar">		<div class="btn-group pull-right">			<a				class="btn"				href="#"				onclick="return Install.goToPage('remove');"				rel="prev"				title="<?php echo JText::_('JPREVIOUS'); ?>">				<i class="icon-arrow-left"></i>				<?php echo JText::_('JPREVIOUS'); ?>			</a>			<a				class="btn btn-primary"				href="#"				onclick="installLanguages()"				rel="next"				title="<?php echo JText::_('JNEXT'); ?>">				<i class="icon-arrow-right icon-white"></i>				<?php echo JText::_('JNEXT'); ?>			</a>		</div>	</div>	<h3><?php echo JText::_('INSTL_LANGUAGES'); ?></h3>	<hr class="hr-condensed" />	<?php if (!$this->items) : ?>		<p><?php echo JText::_('INSTL_LANGUAGES_WARNING_NO_INTERNET') ?></p>		<p>			<a href="#"			class="btn btn-primary"			onclick="return Install.goToPage('remove');">			<i class="icon-arrow-left icon-white"></i>			<?php echo JText::_('INSTL_LANGUAGES_WARNING_BACK_BUTTON'); ?>			</a>		</p>		<p><?php echo JText::_('INSTL_LANGUAGES_WARNING_NO_INTERNET2') ?></p>	<?php else : ?>		<p id="install_languages_desc"><?php echo JText::_('INSTL_LANGUAGES_DESC'); ?></p>		<p id="wait_installing" style="display: none;">			<?php echo JText::_('INSTL_LANGUAGES_MESSAGE_PLEASE_WAIT') ?><br />			<div id="wait_installing_spinner" class="spinner spinner-img" style="display: none;"></div>		</p>	<table class="table table-striped table-condensed">			<thead>					<tr>						<th>							<?php echo JText::_('INSTL_LANGUAGES_COLUMN_HEADER_LANGUAGE'); ?>						</th>						<th>							<?php echo JText::_('INSTL_LANGUAGES_COLUMN_HEADER_VERSION'); ?>						</th>					</tr>			</thead>			<tbody>				<?php foreach ($this->items as $i => $language) : ?>					<tr>						<td>							<label class="checkbox">								<input									type="checkbox"									id="cb<?php echo $i; ?>"									name="cid[]"									value="<?php echo $language->update_id; ?>"									/> <?php echo $language->name; ?>									<?php // Display a Note if language pack version is not equal to Joomla version ?>									<?php if (substr($language->version, 0, 3) != $version->RELEASE											|| substr($language->version, 0, 5) != $version->RELEASE . "." . $version->DEV_LEVEL) : ?>										<div class="small"><?php echo JText::_('JGLOBAL_LANGUAGE_VERSION_NOT_PLATFORM'); ?></div>									<?php endif; ?>							</label>						</td>						<td>							<span class="badge"><?php echo $language->version; ?></span>						</td>					</tr>				<?php endforeach; ?>			</tbody>		</table>		<input type="hidden" name="task" value="InstallLanguages" />		<?php echo JHtml::_('form.token'); ?>	<?php endif; ?></form>
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;JFormHelper::loadFieldClass('list');/** * Supports an custom SQL select list * * @package     Joomla.Platform * @subpackage  Form * @since       11.1 */class JFormFieldSQL extends JFormFieldList{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	public $type = 'SQL';	/**	 * Method to get the custom field options.	 * Use the query attribute to supply a query to generate the list.	 *	 * @return  array  The field option objects.	 *	 * @since   11.1	 */	protected function getOptions()	{		$options = array();		// Initialize some field attributes.		$key = $this->element['key_field'] ? (string) $this->element['key_field'] : 'value';		$value = $this->element['value_field'] ? (string) $this->element['value_field'] : (string) $this->element['name'];		$translate = $this->element['translate'] ? (string) $this->element['translate'] : false;		$query = (string) $this->element['query'];		// Get the database object.		$db = JFactory::getDbo();		// Set the query and get the result list.		$db->setQuery($query);		$items = $db->loadObjectlist();		// Build the field options.		if (!empty($items))		{			foreach ($items as $item)			{				if ($translate == true)				{					$options[] = JHtml::_('select.option', $item->$key, JText::_($item->$value));				}				else				{					$options[] = JHtml::_('select.option', $item->$key, $item->$value);				}			}		}		// Merge any additional options in the XML definition.		$options = array_merge(parent::getOptions(), $options);		return $options;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User view level model. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersModelLevel extends JModelAdmin{	/**	 * @var	array	A list of the access levels in use.	 * @since   1.6	 */	protected $levelsInUse = null;	/**	 * Method to test whether a record can be deleted.	 *	 * @param   object	$record	A record object.	 *	 * @return  boolean  True if allowed to delete the record. Defaults to the permission set in the component.	 * @since   1.6	 */	protected function canDelete($record)	{		// Check if the access level is being used by any content.		if ($this->levelsInUse === null)		{			// Populate the list once.			$this->levelsInUse = array();			$db		= $this->getDbo();			$query	= $db->getQuery(true)				->select('DISTINCT access');				// from is added dynamically			// Get all the tables and the prefix			$tables = $db->getTableList();			//$fields = $db->getTableFields($tables);			$prefix = $db->getPrefix();			foreach ($tables as $table)			{				// Get all of the columns in the table				$fields = $db->getTableColumns($table);				// We are looking for the access field.  If custom tables are using something other				// than the 'access' field they are on their own unfortunately.				// Also make sure the table prefix matches the live db prefix (eg, it is not a "bak_" table)				if ((strpos($table, $prefix) === 0) && (isset($fields['access'])))				{					// Lookup the distinct values of the field.					$query->clear('from')						->from($db->quoteName($table));					$db->setQuery($query);					try					{						$values = $db->loadColumn();					}					catch (RuntimeException $e)					{						$this->setError($e->getMessage());						return false;					}					$this->levelsInUse = array_merge($this->levelsInUse, $values);					// TODO Could assemble an array of the tables used by each view level list those,					// giving the user a clue in the error where to look.				}			}			// Get uniques.			$this->levelsInUse = array_unique($this->levelsInUse);			// Ok, after all that we are ready to check the record :)		}		if (in_array($record->id, $this->levelsInUse))		{			$this->setError(JText::sprintf('COM_USERS_ERROR_VIEW_LEVEL_IN_USE', $record->id, $record->title));			return false;		}		return parent::canDelete($record);	}	/**	 * Returns a reference to the a Table object, always creating it.	 *	 * @param   type	The table type to instantiate	 * @param   string	A prefix for the table class name. Optional.	 * @param   array  Configuration array for model. Optional.	 * @return  JTable	A database object	 * @since   1.6	*/	public function getTable($type = 'Viewlevel', $prefix = 'JTable', $config = array())	{		$return = JTable::getInstance($type, $prefix, $config);		return $return;	}	/**	 * Method to get a single record.	 *	 * @param   integer	The id of the primary key.	 * @return  mixed  Object on success, false on failure.	 * @since   1.6	 */	public function getItem($pk = null)	{		$result = parent::getItem($pk);		// Convert the params field to an array.		$result->rules = json_decode($result->rules);		return $result;	}	/**	 * Method to get the record form.	 *	 * @param   array  $data		An optional array of data for the form to interogate.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		$app = JFactory::getApplication();		// Get the form.		$form = $this->loadForm('com_users.level', 'level', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_users.edit.level.data', array());		if (empty($data))		{			$data = $this->getItem();		}		$this->preprocessData('com_users.level', $data);		return $data;	}	/**	 * Override preprocessForm to load the user plugin group instead of content.	 *	 * @param   object	A form object.	 * @param   mixed	The data expected for the form.	 * @throws	Exception if there is an error in the form event.	 * @since   1.6	 */	protected function preprocessForm(JForm $form, $data, $groups = '')	{		parent::preprocessForm($form, $data, 'user');	}	/**	 * Method to save the form data.	 *	 * @param   array  The form data.	 * @return  boolean  True on success.	 * @since   1.6	 */	public function save($data)	{		if (!isset($data['rules']))		{			$data['rules'] = array();		}		return parent::save($data);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_templates * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.modal');JHtml::_('behavior.multiselect');JHtml::_('formbehavior.chosen', 'select');$user		= JFactory::getUser();$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_templates&view=templates'); ?>" method="post" name="adminForm" id="adminForm">  <?php if (!empty( $this->sidebar)) : ?>    <div id="j-sidebar-container" class="span2">      <?php echo $this->sidebar; ?>    </div>      <div id="j-main-container" class="span10">  <?php else : ?>    <div id="j-main-container">  <?php endif;?>    	<div id="filter-bar" class="btn-toolbar">  		<div class="filter-search btn-group pull-left">  			<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_TEMPLATES_TEMPLATES_FILTER_SEARCH_DESC'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_TEMPLATES_TEMPLATES_FILTER_SEARCH_DESC'); ?>" />  		</div>  		<div class="btn-group pull-left">  			<button class="btn tip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>  			<button class="btn tip" type="button" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>" onclick="document.id('filter_search').value='';this.form.submit();"><i class="icon-remove"></i></button>  		</div>  	</div>  	<div class="clearfix"> </div>  	<table class="table table-striped" id="template-mgr">  		<thead>  			<tr>  				<th class="col1template">  					&#160;  				</th>  				<th>  					<?php echo JHtml::_('grid.sort', 'COM_TEMPLATES_HEADING_TEMPLATE', 'a.element', $listDirn, $listOrder); ?>  				</th>  				<th width="10%">  					<?php echo JHtml::_('grid.sort', 'JCLIENT', 'a.client_id', $listDirn, $listOrder); ?>  				</th>  				<th width="10%">  					<?php echo JText::_('JVERSION'); ?>  				</th>  				<th width="15%">  					<?php echo JText::_('JDATE'); ?>  				</th>  				<th width="25%" >  					<?php echo JText::_('JAUTHOR'); ?>  				</th>  			</tr>  		</thead>  		<tfoot>  			<tr>  				<td colspan="8">  					<?php echo $this->pagination->getListFooter(); ?>  				</td>  			</tr>  		</tfoot>  		<tbody>  		<?php foreach ($this->items as $i => $item) : ?>  			<tr class="row<?php echo $i % 2; ?>">  				<td class="center">  					<?php echo JHtml::_('templates.thumb', $item->element, $item->client_id); ?>  				</td>  				<td class="template-name">  					<a href="<?php echo JRoute::_('index.php?option=com_templates&view=template&id='.(int) $item->extension_id); ?>">  						<?php echo JText::sprintf('COM_TEMPLATES_TEMPLATE_DETAILS', ucfirst($item->name)); ?></a>  					<p>  					<?php if ($this->preview && $item->client_id == '0') : ?>  						<a href="<?php echo JURI::root().'index.php?tp=1&template='.$item->element; ?>" target="_blank">  							<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_PREVIEW'); ?></a>  					<?php elseif ($item->client_id == '1') : ?>  						<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW_ADMIN'); ?>  					<?php else: ?>  						<span class="hasTip" title="<?php echo JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW'); ?>::<?php echo JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW_DESC'); ?>">  							<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW'); ?></span>  					<?php endif; ?>  					</p>  				</td>  				<td class="small">  					<?php echo $item->client_id == 0 ? JText::_('JSITE') : JText::_('JADMINISTRATOR'); ?>  				</td>  				<td class="small">  					<?php echo $this->escape($item->xmldata->get('version')); ?>  				</td>  				<td class="small">  					<?php echo $this->escape($item->xmldata->get('creationDate')); ?>  				</td>  				<td>  					<?php if ($author = $item->xmldata->get('author')) : ?>  						<p><?php echo $this->escape($author); ?></p>  					<?php else : ?>  						&mdash;  					<?php endif; ?>  					<?php if ($email = $item->xmldata->get('authorEmail')) : ?>  						<p><?php echo $this->escape($email); ?></p>  					<?php endif; ?>  					<?php if ($url = $item->xmldata->get('authorUrl')) : ?>  						<p><a href="<?php echo $this->escape($url); ?>">  							<?php echo $this->escape($url); ?></a></p>  					<?php endif; ?>  				</td>  			</tr>  			<?php endforeach; ?>  		</tbody>  	</table>    	<input type="hidden" name="task" value="" />  	<input type="hidden" name="boxchecked" value="0" />  	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />  	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />  	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Site * @subpackage  mod_tags_popular * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Helper for mod_tags_popular * * @package     Joomla.Site * @subpackage  mod_tags_popular * @since       3.1 */abstract class ModTagssimilarHelper{	public static function getList($params)	{		$db         = JFactory::getDbo();		$app        = JFactory::getApplication();		$user       = JFactory::getUser();		$groups     = implode(',', $user->getAuthorisedViewLevels());		$matchtype  = $params->get('matchtype', 'all');		$maximum    = $params->get('maximum', 5);		$tagsHelper = new JHelperTags;		$option     = $app->input->get('option');		$view       = $app->input->get('view');		$prefix     = $option . '.' . $view;		$id         = (array) $app->input->getObject('id');		// Strip off any slug data.		foreach ($id as $id)		{			if (substr_count($id, ':') > 0)			{				$idexplode = explode(':', $id);				$id        = $idexplode[0];			}		}		// For now assume com_tags and com_users do not have tags.		// This module does not apply to list views in general at this point.		if ($option != 'com_tags' && $view != 'category'  && $option != 'com_users')		{			$tagsToMatch = $tagsHelper->getTagIds($id, $prefix);			if (!$tagsToMatch || is_null($tagsToMatch))			{				return $results = false;			}			$tagCount = substr_count($tagsToMatch, ',') + 1;			$query = $db->getQuery(true)				->select(				array(					$db->quoteName('m.tag_id'),					$db->quoteName('m.core_content_id'),					$db->quoteName('m.content_item_id'),					$db->quoteName('m.type_alias'),						'COUNT( '  . $db->quoteName('tag_id') . ') AS ' . $db->quoteName('count'),					$db->quoteName('t.access'),					$db->quoteName('t.id'),					$db->quoteName('ct.router'),					$db->quoteName('cc.core_title'),					$db->quoteName('cc.core_alias'),					$db->quoteName('cc.core_catid'),					$db->quoteName('cc.core_language')					)			);			$query->from($db->quoteName('#__contentitem_tag_map', 'm'));			$query->join('INNER', $db->quoteName('#__tags', 't') . ' ON m.tag_id = t.id')				->join('INNER', $db->quoteName('#__ucm_content', 'cc') . ' ON m.core_content_id = cc.core_content_id')				->join('INNER', $db->quoteName('#__content_types', 'ct') . ' ON m.type_alias = ct.type_alias');			$query->where('t.access IN (' . $groups . ')');			$query->where($db->quoteName('m.tag_id') . ' IN (' . $tagsToMatch . ')');			// Don't show current item			$query->where('(' . $db->quoteName('m.content_item_id') . ' <> ' . $id . ' OR ' . $db->quoteName('m.type_alias') . ' <> ' . $db->quote($prefix) . ')');			// Only return published tags			$query->where($db->quoteName('cc.core_state') . ' = 1 ');			// Optionally filter on language			$language = JComponentHelper::getParams('com_tags')->get('tag_list_language_filter', 'all');			if ($language != 'all')			{				if ($language == 'current_language')				{					$language = JHelperContent::getCurrentLanguage();				}				$query->where($db->quoteName('cc.core_language') . ' IN (' . $db->quote($language) . ', ' . $db->quote('*') . ')');			}			$query->group($db->quoteName(array('m.core_content_id')));			if ($matchtype == 'all' && $tagCount > 0)			{				$query->having('COUNT( '  . $db->quoteName('tag_id') . ')  = ' . $tagCount);			}			elseif ($matchtype == 'half' && $tagCount > 0)			{				$tagCountHalf = ceil($tagCount / 2);				$query->having('COUNT( '  . $db->quoteName('tag_id') . ')  >= ' . $tagCountHalf);			}			$query->order($db->quoteName('count') . ' DESC');			$db->setQuery($query, 0, $maximum);			$results = $db->loadObjectList();			foreach ($results as $result)			{				$explodedAlias = explode('.', $result->type_alias);				$result->link = 'index.php?option=' . $explodedAlias[0] . '&view=' . $explodedAlias[1] . '&id=' . $result->content_item_id . '-' . $result->core_alias;			}			return $results;		}		else		{			return;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Articles list controller class. * * @package     Joomla.Administrator * @subpackage  com_content * @since       1.6 */class ContentControllerArticles extends JControllerAdmin{	/**	 * Constructor.	 *	 * @param   array  $config	An optional associative array of configuration settings.	 * @return  ContentControllerArticles	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		parent::__construct($config);		// Articles default form can come from the articles or featured view.		// Adjust the redirect view on the value of 'view' in the request.		if ($this->input->get('view') == 'featured')		{			$this->view_list = 'featured';		}		$this->registerTask('unfeatured',	'featured');	}	/**	 * Method to toggle the featured setting of a list of articles.	 *	 * @return  void	 * @since   1.6	 */	public function featured()	{		// Check for request forgeries		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$user   = JFactory::getUser();		$ids    = $this->input->get('cid', array(), 'array');		$values = array('featured' => 1, 'unfeatured' => 0);		$task   = $this->getTask();		$value  = JArrayHelper::getValue($values, $task, 0, 'int');		// Access checks.		foreach ($ids as $i => $id)		{			if (!$user->authorise('core.edit.state', 'com_content.article.'.(int) $id))			{				// Prune items that you can't change.				unset($ids[$i]);				JError::raiseNotice(403, JText::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'));			}		}		if (empty($ids))		{			JError::raiseWarning(500, JText::_('JERROR_NO_ITEMS_SELECTED'));		}		else		{			// Get the model.			$model = $this->getModel();			// Publish the items.			if (!$model->featured($ids, $value))			{				JError::raiseWarning(500, $model->getError());			}		}		$this->setRedirect('index.php?option=com_content&view=articles');	}	/**	 * Proxy for getModel.	 *	 * @param   string	$name	The name of the model.	 * @param   string	$prefix	The prefix for the PHP class name.	 *	 * @return  JModel	 * @since   1.6	 */	public function getModel($name = 'Article', $prefix = 'ContentModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}	/**	 * Method to save the submitted ordering values for records via AJAX.	 *	 * @return  void	 *	 * @since   3.0	 */	public function saveOrderAjax()	{		$pks = $this->input->post->get('cid', array(), 'array');		$order = $this->input->post->get('order', array(), 'array');		// Sanitize the input		JArrayHelper::toInteger($pks);		JArrayHelper::toInteger($order);		// Get the model		$model = $this->getModel();		// Save the ordering		$return = $model->saveorder($pks, $order);		if ($return)		{			echo "1";		}		// Close the application		JFactory::getApplication()->close();	}	/**	 * Function that allows child controller access to model data	 * after the item has been deleted.	 *	 * @param   JModelLegacy  $model  The data model object.	 * @param   integer       $ids    The array of ids for items being deleted.	 *	 * @return  void	 *	 * @since   12.2	 */	protected function postDeleteHook(JModelLegacy $model, $ids = null)	{	}}
<?php/** * @package     Joomla.Site * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;?><script type="text/javascript">	window.addEvent('domready', function() {<?php if ($this->params->get('show_advanced', 1)) : ?>		/*		 * This segment of code adds the slide effect to the advanced search box.		 */		if (document.id('advanced-search') != null)		{			var searchSlider = new Fx.Slide('advanced-search');			<?php if (!$this->params->get('expand_advanced', 0)) : ?>			searchSlider.hide();			<?php endif; ?>			document.id('advanced-search-toggle').addEvent('click', function(e)			{				e = new Event(e);				e.stop();				searchSlider.toggle();			});		}		/*		 * This segment of code disables select boxes that have no value when the		 * form is submitted so that the URL doesn't get blown up with null values.		 */		if (document.id('finder-search') != null)		{			document.id('finder-search').addEvent('submit', function(e){				e = new Event(e);				e.stop();				if (document.id('advanced-search') != null)				{					// Disable select boxes with no value selected.					document.id('advanced-search').getElements('select').each(function(s){						if (!s.getProperty('value'))						{							s.setProperty('disabled', 'disabled');						}					});				}				document.id('finder-search').submit();			});		}<?php endif; ?>		/*		 * This segment of code sets up the autocompleter.		 */<?php if ($this->params->get('show_autosuggest', 1)) : ?>	<?php JHtml::_('script', 'com_finder/autocompleter.js', false, true); ?>	var url = '<?php echo JRoute::_('index.php?option=com_finder&task=suggestions.display&format=json&tmpl=component', false); ?>';	var completer = new Autocompleter.Request.JSON(document.id('q'), url, {'postVar': 'q'});<?php endif; ?>	});</script><form id="finder-search" action="<?php echo JRoute::_($this->query->toURI()); ?>" method="get" class="form-inline">	<?php echo $this->getFields(); ?>	<?php	/*	 * DISABLED UNTIL WEIRD VALUES CAN BE TRACKED DOWN.	 */	if (false && $this->state->get('list.ordering') !== 'relevance_dsc') : ?>		<input type="hidden" name="o" value="<?php echo $this->escape($this->state->get('list.ordering')); ?>" />	<?php endif; ?>	<fieldset class="word">		<label for="q">			<?php echo JText::_('COM_FINDER_SEARCH_TERMS'); ?>		</label>		<input type="text" name="q" id="q" size="30" value="<?php echo $this->escape($this->query->input); ?>" class="inputbox" />		<?php if ($this->escape($this->query->input) != '' || $this->params->get('allow_empty_search')):?>			<button name="Search" type="submit" class="btn btn-primary"><span class="icon-search icon-white"></span> <?php echo JText::_('JSEARCH_FILTER_SUBMIT');?></button>		<?php else: ?>			<button name="Search" type="submit" class="btn btn-primary disabled"><span class="icon-search icon-white"></span> <?php echo JText::_('JSEARCH_FILTER_SUBMIT');?></button>		<?php endif; ?>		<?php if ($this->params->get('show_advanced', 1)) : ?>			<a href="#advancedSearch" data-toggle="collapse" class="btn"><span class="icon-list"></span> <?php echo JText::_('COM_FINDER_ADVANCED_SEARCH_TOGGLE'); ?></a>		<?php endif; ?></fieldset>	<?php if ($this->params->get('show_advanced', 1)) : ?>		<div id="advancedSearch" class="collapse">			<hr />			<?php if ($this->params->get('show_advanced_tips', 1)) : ?>				<div class="advanced-search-tip">					<?php echo JText::_('COM_FINDER_ADVANCED_TIPS'); ?>				</div>				<hr />			<?php endif; ?>			<div id="finder-filter-window">				<?php echo JHtml::_('filter.select', $this->query, $this->params); ?>			</div>		</div>	<?php endif; ?></form>
<?php/** * @package     Joomla.Plugin * @subpackage  Editors-xtd.article * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Editor Article buton * * @package     Joomla.Plugin * @subpackage  Editors-xtd.article * @since       1.5 */class PlgButtonArticle extends JPlugin{	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * Display the button	 *	 * @return array A four element array of (article_id, article_title, category_id, object)	 */	public function onDisplay($name)	{		/*		 * Javascript to insert the link		 * View element calls jSelectArticle when an article is clicked		 * jSelectArticle creates the link tag, sends it to the editor,		 * and closes the select frame.		 */		$js = "		function jSelectArticle(id, title, catid, object, link, lang)		{			var hreflang = '';			if (lang !== '')			{				var hreflang = ' hreflang = \"' + lang + '\"';			}			var tag = '<a' + hreflang + ' href=\"' + link + '\">' + title + '</a>';			jInsertEditorText(tag, '".$name."');			SqueezeBox.close();		}";		$doc = JFactory::getDocument();		$doc->addScriptDeclaration($js);		JHtml::_('behavior.modal');		/*		 * Use the built-in element view to select the article.		 * Currently uses blank class.		 */		$link = 'index.php?option=com_content&amp;view=articles&amp;layout=modal&amp;tmpl=component&amp;'.JSession::getFormToken().'=1';		$button = new JObject;		$button->modal = true;		$button->link = $link;		$button->text = JText::_('PLG_ARTICLE_BUTTON_ARTICLE');		$button->name = 'file-add';		$button->options = "{handler: 'iframe', size: {x: 800, y: 500}}";		return $button;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;JHtml::_('formbehavior.chosen', 'select');JHtml::_('bootstrap.tooltip');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));$lang = JFactory::getLanguage();JText::script('COM_FINDER_MAPS_CONFIRM_DELETE_PROMPT');?><script type="text/javascript">Joomla.submitbutton = function(pressbutton){	if (pressbutton == 'map.delete')	{		if (confirm(Joomla.JText._('COM_FINDER_MAPS_CONFIRM_DELETE_PROMPT')))		{			Joomla.submitform(pressbutton);		}		else		{			return false;		}	}	Joomla.submitform(pressbutton);}</script><form action="<?php echo JRoute::_('index.php?option=com_finder&view=maps');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_FINDER_FILTER_SEARCH_DESCRIPTION'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_FINDER_FILTER_SEARCH_DESCRIPTION'); ?>" />			</div>			<div class="btn-group pull-left">				<button class="btn hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button class="btn hasTooltip" type="button" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>" onclick="document.id('filter_search').value='';this.form.submit();"><i class="icon-remove"></i></button>			</div>		</div>		<div class="clearfix"> </div>		<table class="table table-striped">			<thead>				<tr>					<th width="1%">						<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />					</th>					<th class="nowrap">						<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>					</th>					<th class="nowrap" width="10%">						<?php echo JHtml::_('grid.sort', 'JSTATUS', 'a.state', $listDirn, $listOrder); ?>					</th>				</tr>			</thead>			<tbody>				<?php if (count($this->items) == 0) : ?>				<tr class="row0">					<td class="center" colspan="5">						<?php echo JText::_('COM_FINDER_MAPS_NO_CONTENT'); ?>					</td>				</tr>				<?php endif; ?>				<?php if ($this->state->get('filter.branch') != 1) : ?>				<tr class="row1">					<td colspan="5" class="center">						<a href="#" onclick="document.id('filter_branch').value='1';document.adminForm.submit();">							<?php echo JText::_('COM_FINDER_MAPS_RETURN_TO_BRANCHES'); ?></a>					</td>				</tr>				<?php endif; ?>				<?php $canChange = JFactory::getUser()->authorise('core.manage', 'com_finder'); ?>				<?php foreach ($this->items as $i => $item) : ?>				<tr class="row<?php echo $i % 2; ?>">					<td class="center">						<?php echo JHtml::_('grid.id', $i, $item->id); ?>					</td>					<td>						<?php							$key = FinderHelperLanguage::branchSingular($item->title);							$title = $lang->hasKey($key) ? JText::_($key) : $item->title;						?>						<?php if ($this->state->get('filter.branch') == 1 && $item->num_children) : ?>							<a href="#" onclick="document.id('filter_branch').value='<?php echo (int) $item->id;?>';document.adminForm.submit();" title="<?php echo JText::_('COM_FINDER_MAPS_BRANCH_LINK'); ?>">								<?php echo $this->escape($title); ?></a>						<?php else: ?>							<?php echo $this->escape(($title == '*') ? JText::_('JALL_LANGUAGE') : $title); ?>						<?php endif; ?>						<?php if ($item->num_children > 0) : ?>							<small>(<?php echo $item->num_children; ?>)</small>						<?php elseif ($item->num_nodes > 0) : ?>							<small>(<?php echo $item->num_nodes; ?>)</small>						<?php endif; ?>						<?php if ($this->escape(trim($title, '**')) == 'Language' && JLanguageMultilang::isEnabled()) : ?>							<strong><?php echo JText::_('COM_FINDER_MAPS_MULTILANG'); ?></strong>						<?php endif; ?>					</td>					<td class="center nowrap">						<?php echo JHtml::_('jgrid.published', $item->state, $i, 'maps.', $canChange, 'cb'); ?>					</td>				</tr>				<?php endforeach; ?>			</tbody>			<tfoot>				<tr>					<td colspan="9" class="nowrap">						<?php echo $this->pagination->getListFooter(); ?>					</td>				</tr>			</tfoot>		</table>		<input type="hidden" name="task" value="display" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn ?>" />	</div>	<?php echo JHtml::_('form.token'); ?></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_messages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Messages Component Messages Model * * @package     Joomla.Administrator * @subpackage  com_messages * @since       1.6 */class MessagesModelMessages extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'message_id', 'a.id',				'subject', 'a.subject',				'state', 'a.state',				'user_id_from', 'a.user_id_from',				'user_id_to', 'a.user_id_to',				'date_time', 'a.date_time',				'priority', 'a.priority',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $search);		$state = $this->getUserStateFromRequest($this->context . '.filter.state', 'filter_state', '', 'string');		$this->setState('filter.state', $state);		// List state information.		parent::populateState('a.date_time', 'desc');	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string    A prefix for the store id.	 *	 * @return  string    A store id.	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.state');		return parent::getStoreId($id);	}	/**	 * Build an SQL query to load the list data.	 *	 * @return  JDatabaseQuery	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		$user = JFactory::getUser();		// Select the required fields from the table.		$query->select(			$this->getState(				'list.select',				'a.*, ' .					'u.name AS user_from'			)		);		$query->from('#__messages AS a');		// Join over the users for message owner.		$query->join('INNER', '#__users AS u ON u.id = a.user_id_from')			->where('a.user_id_to = ' . (int) $user->get('id'));		// Filter by published state.		$state = $this->getState('filter.state');		if (is_numeric($state))		{			$query->where('a.state = ' . (int) $state);		}		elseif ($state === '')		{			$query->where('(a.state IN (0, 1))');		}		// Filter by search in subject or message.		$search = $this->getState('filter.search');		if (!empty($search))		{			$search = $db->quote('%' . $db->escape($search, true) . '%', false);			$query->where('a.subject LIKE ' . $search . ' OR a.message LIKE ' . $search);		}		// Add the list ordering clause.		$query->order($db->escape($this->getState('list.ordering', 'a.date_time')) . ' ' . $db->escape($this->getState('list.direction', 'DESC')));		//echo nl2br(str_replace('#__','jos_',$query));		return $query;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;echo JLayoutHelper::render('joomla.edit.metadata', $this);
<?php/** * @package     Joomla.Platform * @subpackage  Facebook * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Facebook API Video class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Facebook * * @see         http://developers.facebook.com/docs/reference/api/video/ * @since       13.1 */class JFacebookVideo extends JFacebookObject{	/**	 * Method to get a video. Requires authentication and user_videos or friends_videos permission for private videos.	 *	 * @param   string  $video  The video id.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getVideo($video)	{		return $this->get($video);	}	/**	 * Method to get a video's comments. Requires authentication and user_videos or friends_videos permission for private videos.	 *	 * @param   string   $video   The video id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getComments($video, $limit=0, $offset=0, $until=null, $since=null)	{		return $this->getConnection($video, 'comments', '', $limit, $offset, $until, $since);	}	/**	 * Method to comment on a video. Requires authentication and publish_stream permission, user_videos or friends_videos permission for private videos.	 *	 * @param   string  $video    The video id.	 * @param   string  $message  The comment's text.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function createComment($video, $message)	{		// Set POST request parameters.		$data = array();		$data['message'] = $message;		return $this->createConnection($video, 'comments', $data);	}	/**	 * Method to delete a comment. Requires authentication and publish_stream permission, user_videos or friends_videos permission for private videos.	 *	 * @param   string  $comment  The comment's id.	 *	 * @return  boolean Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteComment($comment)	{		return $this->deleteConnection($comment);	}	/**	 * Method to get video's likes. Requires authentication and user_videos or friends_videos permission for private videos.	 *	 * @param   string   $video   The video id.	 * @param   integer  $limit   The number of objects per page.	 * @param   integer  $offset  The object's number on the page.	 * @param   string   $until   A unix timestamp or any date accepted by strtotime.	 * @param   string   $since   A unix timestamp or any date accepted by strtotime.	 *	 * @return  mixed   The decoded JSON response or false if the client is not authenticated.	 *	 * @since   13.1	 */	public function getLikes($video, $limit=0, $offset=0, $until=null, $since=null)	{		return $this->getConnection($video, 'likes', '', $limit, $offset, $until, $since);	}	/**	 * Method to like a video. Requires authentication and publish_stream permission, user_videos or friends_videos permission for private videos.	 *	 * @param   string  $video  The video id.	 *	 * @return  boolean Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function createLike($video)	{		return $this->createConnection($video, 'likes');	}	/**	 * Method to unlike a video. Requires authentication and publish_stream permission, user_videos or friends_videos permission for private videos.	 *	 * @param   string  $video  The video id.	 *	 * @return  boolean Returns true if successful, and false otherwise.	 *	 * @since   13.1	 */	public function deleteLike($video)	{		return $this->deleteConnection($video, 'likes');	}	/**	 * Method to get the album-sized view of the video. Requires authentication and user_videos or friends_videos permission for private photos.	 *	 * @param   string  $video  The video id.	 *	 * @return  string  URL of the picture.	 *	 * @since   13.1	 */	public function getPicture($video)	{		return $this->getConnection($video, 'picture');	}}
<?php/** * @package     Joomla.Site * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the WebLinks component * * @package     Joomla.Site * @subpackage  com_weblinks * @since       1.5 */class WeblinksViewCategory extends JViewLegacy{	protected $state;	protected $items;	protected $category;	protected $children;	protected $pagination;	public function display($tpl = null)	{		$app		= JFactory::getApplication();		$params		= $app->getParams();		// Get some data from the models		$state		= $this->get('State');		$items		= $this->get('Items');		$category	= $this->get('Category');		$children	= $this->get('Children');		$parent 	= $this->get('Parent');		$pagination	= $this->get('Pagination');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		if ($category == false)		{			return JError::raiseWarning(404, JText::_('JGLOBAL_CATEGORY_NOT_FOUND'));		}		if ($parent == false)		{			return JError::raiseWarning(404, JText::_('JGLOBAL_CATEGORY_NOT_FOUND'));		}		// Check whether category access level allows access.		// TODO: SHould already be computed in $category->params->get('access-view')		$user	= JFactory::getUser();		$groups	= $user->getAuthorisedViewLevels();		if (!in_array($category->access, $groups))		{			return JError::raiseError(403, JText::_('JERROR_ALERTNOAUTHOR'));		}		// Prepare the data.		// Compute the weblink slug & link url.		for ($i = 0, $n = count($items); $i < $n; $i++)		{			$item		= &$items[$i];			$item->slug	= $item->alias ? ($item->id.':'.$item->alias) : $item->id;			if ($item->params->get('count_clicks', $params->get('count_clicks')) == 1)			{				$item->link = JRoute::_('index.php?option=com_weblinks&task=weblink.go&id='. $item->id);			}			else {				$item->link = $item->url;			}			$temp = new JRegistry;			$temp->loadString($item->params);			$item->params = clone($params);			$item->params->merge($temp);		}		// Setup the category parameters.		$cparams = $category->getParams();		$category->params = clone($params);		$category->params->merge($cparams);		$children = array($category->id => $children);		$maxLevel = $params->get('maxLevel', -1);		$this->maxLevel   = &$maxLevel;		$this->state      = &$state;		$this->items      = &$items;		$this->category   = &$category;		$this->children   = &$children;		$this->params     = &$params;		$this->parent     = &$parent;		$this->pagination = &$pagination;		$this->user       = &$user;		//Escape strings for HTML output		$this->pageclass_sfx = htmlspecialchars($params->get('pageclass_sfx'));		// Check for layout override only if this is not the active menu item		// If it is the active menu item, then the view and category id will match		$active	= $app->getMenu()->getActive();		if ((!$active) || ((strpos($active->link, 'view=category') === false) || (strpos($active->link, '&id=' . (string) $this->category->id) === false)))		{			if ($layout = $category->params->get('category_layout'))			{			$this->setLayout($layout);			}		}		elseif (isset($active->query['layout']))		{			// We need to set the layout in case this is an alternative menu item (with an alternative layout)			$this->setLayout($active->query['layout']);		}		$this->category->tags = new JHelperTags;		$this->category->tags->getItemTags('com_weblinks.category', $this->category->id);		$this->_prepareDocument();		parent::display($tpl);	}	/**	 * Prepares the document	 */	protected function _prepareDocument()	{		$app		= JFactory::getApplication();		$menus		= $app->getMenu();		$pathway	= $app->getPathway();		$title 		= null;		// Because the application sets a default page title,		// we need to get it from the menu item itself		$menu = $menus->getActive();		if ($menu)		{			$this->params->def('page_heading', $this->params->get('page_title', $menu->title));		}		else		{			$this->params->def('page_heading', JText::_('COM_WEBLINKS_DEFAULT_PAGE_TITLE'));		}		$id = (int) @$menu->query['id'];		if ($menu && ($menu->query['option'] != 'com_weblinks' || $id != $this->category->id))		{			$this->params->set('page_subheading', $this->category->title);			$path = array(array('title' => $this->category->title, 'link' => ''));			$category = $this->category->getParent();			while (($menu->query['option'] != 'com_weblinks' || $id != $category->id) && $category->id > 1)			{				$path[] = array('title' => $category->title, 'link' => WeblinksHelperRoute::getCategoryRoute($category->id));				$category = $category->getParent();			}			$path = array_reverse($path);			foreach ($path as $item)			{				$pathway->addItem($item['title'], $item['link']);			}		}		$title = $this->params->get('page_title', '');		if (empty($title))		{			$title = $app->getCfg('sitename');		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		if ($this->category->metadesc)		{			$this->document->setDescription($this->category->metadesc);		}		elseif (!$this->category->metadesc && $this->params->get('menu-meta_description'))		{			$this->document->setDescription($this->params->get('menu-meta_description'));		}		if ($this->category->metakey)		{			$this->document->setMetadata('keywords', $this->category->metakey);		}		elseif (!$this->category->metakey && $this->params->get('menu-meta_keywords'))		{			$this->document->setMetadata('keywords', $this->params->get('menu-meta_keywords'));		}		if ($this->params->get('robots'))		{			$this->document->setMetadata('robots', $this->params->get('robots'));		}		if ($app->getCfg('MetaAuthor') == '1')		{			$this->document->setMetaData('author', $this->category->getMetadata()->get('author'));		}		$mdata = $this->category->getMetadata()->toArray();		foreach ($mdata as $k => $v)		{			if ($v)			{				$this->document->setMetadata($k, $v);			}		}		// Add alternative feed link		if ($this->params->get('show_feed_link', 1) == 1)		{			$link	= '&format=feed&limitstart=';			$attribs = array('type' => 'application/rss+xml', 'title' => 'RSS 2.0');			$this->document->addHeadLink(JRoute::_($link.'&type=rss'), 'alternate', 'rel', $attribs);			$attribs = array('type' => 'application/atom+xml', 'title' => 'Atom 1.0');			$this->document->addHeadLink(JRoute::_($link.'&type=atom'), 'alternate', 'rel', $attribs);		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.modal');JHtml::_('behavior.multiselect');$user		= JFactory::getUser();$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_templates&view=templates'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('Filters'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_TEMPLATES_TEMPLATES_FILTER_SEARCH_DESC'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_client_id">				<?php echo JText::_('JGLOBAL_FILTER_CLIENT'); ?>			</label>			<select name="filter_client_id" class="inputbox" id="filter_client_id">				<option value="*"><?php echo JText::_('JGLOBAL_FILTER_CLIENT'); ?></option>				<?php echo JHtml::_('select.options', TemplatesHelper::getClientOptions(), 'value', 'text', $this->state->get('filter.client_id'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist" id="template-mgr">		<thead>			<tr>				<th class="checkmark-col">					&#160;				</th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_TEMPLATES_HEADING_TEMPLATE', 'a.element', $listDirn, $listOrder); ?>				</th>				<th class="width-10">					<?php echo JHtml::_('grid.sort', 'JCLIENT', 'a.client_id', $listDirn, $listOrder); ?>				</th>				<th class="center width-10">					<?php echo JText::_('JVERSION'); ?>				</th>				<th class="width-15">					<?php echo JText::_('JDATE'); ?>				</th>				<th class="width-25">					<?php echo JText::_('JAUTHOR'); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row<?php echo $i % 2; ?>">				<td class="center">					<?php echo JHtml::_('templates.thumb', $item->element, $item->client_id); ?>				</td>				<td class="template-name">					<a href="<?php echo JRoute::_('index.php?option=com_templates&view=template&id='.(int) $item->extension_id); ?>">						<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_DETAILS', $item->name); ?></a>					<p>					<?php if ($this->preview && $item->client_id == '0') : ?>						<a href="<?php echo JURI::root().'index.php?tp=1&template='.$item->element; ?>" target="_blank">							<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_PREVIEW'); ?></a>					<?php elseif ($item->client_id == '1') : ?>						<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW_ADMIN'); ?>					<?php else: ?>						<span class="hasTip" title="<?php echo JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW'); ?>::<?php echo JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW_DESC'); ?>">							<?php echo  JText::sprintf('COM_TEMPLATES_TEMPLATE_NO_PREVIEW'); ?></span>					<?php endif; ?>					</p>				</td>				<td class="center">					<?php echo $item->client_id == 0 ? JText::_('JSITE') : JText::_('JADMINISTRATOR'); ?>				</td>				<td class="center">					<?php echo $this->escape($item->xmldata->get('version')); ?>				</td>				<td class="center">					<?php echo $this->escape($item->xmldata->get('creationDate')); ?>				</td>				<td>					<?php if ($author = $item->xmldata->get('author')) : ?>						<p><?php echo $this->escape($author); ?></p>					<?php else : ?>						&mdash;					<?php endif; ?>					<?php if ($email = $item->xmldata->get('authorEmail')) : ?>						<p><?php echo $this->escape($email); ?></p>					<?php endif; ?>					<?php if ($url = $item->xmldata->get('authorUrl')) : ?>						<p><a href="<?php echo $this->escape($url); ?>">							<?php echo $this->escape($url); ?></a></p>					<?php endif; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'banner.cancel' || document.formvalidator.isValid(document.id('banner-form')))		{			Joomla.submitform(task, document.getElementById('banner-form'));		}	}	window.addEvent('domready', function()	{		document.id('jform_type0').addEvent('click', function(e){			document.id('image').setStyle('display', 'block');			document.id('url').setStyle('display', 'block');			document.id('custom').setStyle('display', 'none');		});		document.id('jform_type1').addEvent('click', function(e){			document.id('image').setStyle('display', 'none');			document.id('url').setStyle('display', 'none');			document.id('custom').setStyle('display', 'block');		});		if (document.id('jform_type0').checked==true)		{			document.id('jform_type0').fireEvent('click');		}		else		{			document.id('jform_type1').fireEvent('click');		}	});</script><form action="<?php echo JRoute::_('index.php?option=com_banners&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="banner-form" class="form-validate">	<div class="col main-section">		<fieldset class="adminform">			<legend><?php echo empty($this->item->id) ? JText::_('COM_BANNERS_NEW_BANNER') : JText::sprintf('COM_BANNERS_BANNER_DETAILS', $this->item->id); ?></legend>			<ul class="adminformlist">				<li><?php echo $this->form->getLabel('name'); ?>				<?php echo $this->form->getInput('name'); ?></li>				<li><?php echo $this->form->getLabel('alias'); ?>				<?php echo $this->form->getInput('alias'); ?></li>				<li><?php echo $this->form->getLabel('access'); ?>				<?php echo $this->form->getInput('access'); ?></li>				<li><?php echo $this->form->getLabel('catid'); ?>				<?php echo $this->form->getInput('catid'); ?></li>				<li><?php echo $this->form->getLabel('state'); ?>				<?php echo $this->form->getInput('state'); ?></li>				<li><?php echo $this->form->getLabel('type'); ?>				<?php echo $this->form->getInput('type'); ?></li>				<?php foreach ($this->form->getFieldset('image') as $field) : ?>					<li><?php echo $field->label; ?>						<?php echo $field->input; ?></li>				<?php endforeach; ?>				<li><div id="custom">					<?php echo $this->form->getLabel('custombannercode'); ?>					<?php echo $this->form->getInput('custombannercode'); ?>				</div>				</li>				<li><div id="url">				<?php echo $this->form->getLabel('clickurl'); ?>				<?php echo $this->form->getInput('clickurl'); ?>				</div>				</li>				<li><?php echo $this->form->getLabel('description'); ?>				<?php echo $this->form->getInput('description'); ?></li>				<li><?php echo $this->form->getLabel('language'); ?>				<?php echo $this->form->getInput('language'); ?></li>				<li><?php echo $this->form->getLabel('id'); ?>				<?php echo $this->form->getInput('id'); ?></li>			</ul>			<div class="clr"> </div>		</fieldset>	</div><div class="col options-section">	<?php echo JHtml::_('sliders.start', 'banner-sliders-' . $this->item->id, array('useCookie' => 1)); ?>	<?php echo JHtml::_('sliders.panel', JText::_('COM_BANNERS_GROUP_LABEL_PUBLISHING_DETAILS'), 'publishing-details'); ?>		<fieldset class="panelform">		<legend class="element-invisible"><?php echo JText::_('JGLOBAL_FIELDSET_PUBLISHING'); ?></legend>		<ul class="adminformlist">			<?php foreach ($this->form->getFieldset('publish') as $field) : ?>				<li><?php echo $field->label; ?>					<?php echo $field->input; ?></li>			<?php endforeach; ?>			</ul>		</fieldset>	<?php echo JHtml::_('sliders.panel', JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS'), 'metadata'); ?>		<fieldset class="panelform">		<legend class="element-invisible"><?php echo JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS'); ?></legend>			<ul class="adminformlist">				<?php foreach ($this->form->getFieldset('metadata') as $field) : ?>					<li><?php echo $field->label; ?>						<?php echo $field->input; ?></li>				<?php endforeach; ?>			</ul>		</fieldset>	<?php echo JHtml::_('sliders.end'); ?>	<input type="hidden" name="task" value="" />	<?php echo JHtml::_('form.token'); ?></div><div class="clr"></div></form>
<?php/** * @package     Joomla.Libraries * @subpackage  UCM * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;/** * UCM Class for handling content types * * @package     Joomla.Libraries * @subpackage  UCM * @since       3.1 */class JUcmType implements JUcm{	/**	 * The UCM Type	 *	 * @var    JUcmType	 * @since  3.1	 */	public $type;	/**	* The Database object	*	* @var    JDatabaseDriver	* @since  3.1	*/	protected $db;	/**	* The alias for the content type	*	* @var	  string	* @since  3.1	*/	protected $alias;	/**	 * @param  string            $alias        The alias for the item	 * @param  JDatabaseDriver   $database     The database object	 * @param  JApplicationBase  $application  The application object	 */	public function __construct($alias = null, JDatabaseDriver $database = null, JApplicationBase $application = null)	{		$this->db = $database ? $database : JFactory::getDbo();		$app      = $application ? $application : JFactory::getApplication();		// Make the best guess we can in the absence of information.		$this->alias = $alias ? $alias : $app->input->get('option') . '.' . $app->input->get('view');		$this->type  = $this->getType();	}	/**	* Get the Content Type	*	* @param   integer  $pk  The primary key of the alias type	*	* @return  object  The UCM Type data	*	* @since   3.1	*/	public function getType($pk = null)	{		if (!$pk)		{			$pk = $this->getTypeId();		}		$query	= $this->db->getQuery(true);		$query->select('ct.*');		$query->from($this->db->quoteName('#__content_types', 'ct'));		$query->where($this->db->quoteName('ct.type_id') . ' = ' . (int) $pk);		$this->db->setQuery($query);		$type = $this->db->loadObject();		return $type;	}	/**	 * Retrieves the UCM type ID	 *	 * @param   string  $alias  The string of the type alias	 *	 * @return  integer  The ID of the requested type	 *	 * @since   3.1	 */	public function getTypeId($alias = null)	{		if (!$alias)		{			$alias = $this->alias;		}		$query = $this->db->getQuery(true);		$query->select('ct.type_id');		$query->from($this->db->quoteName('#__content_types', 'ct'));		$query->where($this->db->quoteName('ct.type_alias') . ' = ' . $this->db->q($alias));		$this->db->setQuery($query);		$id = $this->db->loadResult();		return $id;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Newsfeeds component helper. * * @package     Joomla.Administrator * @subpackage  com_newsfeeds * @since       1.6 */class NewsfeedsHelper{	public static $extension = 'com_newsfeeds';	/**	 * Configure the Linkbar.	 *	 * @param   string	The name of the active view.	 */	public static function addSubmenu($vName)	{		JHtmlSidebar::addEntry(			JText::_('COM_NEWSFEEDS_SUBMENU_NEWSFEEDS'),			'index.php?option=com_newsfeeds&view=newsfeeds',			$vName == 'newsfeeds'		);		JHtmlSidebar::addEntry(			JText::_('COM_NEWSFEEDS_SUBMENU_CATEGORIES'),			'index.php?option=com_categories&extension=com_newsfeeds',			$vName == 'categories'		);		if ($vName == 'categories')		{			JToolbarHelper::title(				JText::sprintf('COM_CATEGORIES_CATEGORIES_TITLE', JText::_('com_newsfeeds')),				'newsfeeds-categories');		}	}	/**	 * Gets a list of the actions that can be performed.	 *	 * @param   integer  The category ID.	 *	 * @return  JObject	 */	public static function getActions($categoryId = 0, $newsfeedId = 0)	{		$user	= JFactory::getUser();		$result	= new JObject;		if (empty($categoryId))		{			$assetName = 'com_newsfeeds';			$level = 'component';		}		else		{			$assetName = 'com_newsfeeds.category.'.(int) $categoryId;			$level = 'category';		}		$actions = JAccess::getActions('com_newsfeeds', $level);		foreach ($actions as $action)		{			$result->set($action->name,	$user->authorise($action->name, $assetName));		}		return $result;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * This models supports retrieving a category, the articles associated with the category, * sibling, child and parent categories. * * @package     Joomla.Site * @subpackage  com_content * @since       1.5 */class ContentModelCategory extends JModelList{	/**	 * Category items data	 *	 * @var array	 */	protected $_item = null;	protected $_articles = null;	protected $_siblings = null;	protected $_children = null;	protected $_parent = null;	/**	 * Model context string.	 *	 * @var		string	 */	protected $_context = 'com_content.category';	/**	 * The category that applies.	 *	 * @access	protected	 * @var		object	 */	protected $_category = null;	/**	 * The list of other newfeed categories.	 *	 * @access	protected	 * @var		array	 */	protected $_categories = null;	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id', 'a.id',				'title', 'a.title',				'alias', 'a.alias',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'catid', 'a.catid', 'category_title',				'state', 'a.state',				'access', 'a.access', 'access_level',				'created', 'a.created',				'created_by', 'a.created_by',				'modified', 'a.modified',				'ordering', 'a.ordering',				'featured', 'a.featured',				'language', 'a.language',				'hits', 'a.hits',				'publish_up', 'a.publish_up',				'publish_down', 'a.publish_down',				'author', 'a.author'			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * return	void	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('site');		$pk  = $app->input->getInt('id');		$this->setState('category.id', $pk);		// Load the parameters. Merge Global and Menu Item params into new object		$params = $app->getParams();		$menuParams = new JRegistry;		if ($menu = $app->getMenu()->getActive())		{			$menuParams->loadString($menu->params);		}		$mergedParams = clone $menuParams;		$mergedParams->merge($params);		$this->setState('params', $mergedParams);		$user		= JFactory::getUser();				// Create a new query object.		$db		= $this->getDbo();		$query	= $db->getQuery(true);		$groups	= implode(',', $user->getAuthorisedViewLevels());		if ((!$user->authorise('core.edit.state', 'com_content')) &&  (!$user->authorise('core.edit', 'com_content'))){			// limit to published for people who can't edit or edit.state.			$this->setState('filter.published', 1);			// Filter by start and end dates.			$nullDate = $db->quote($db->getNullDate());			$nowDate = $db->quote(JFactory::getDate()->toSQL());			$query->where('(a.publish_up = ' . $nullDate . ' OR a.publish_up <= ' . $nowDate . ')')				->where('(a.publish_down = ' . $nullDate . ' OR a.publish_down >= ' . $nowDate . ')');		}		else		{			$this->setState('filter.published', array(0, 1, 2));		}		// process show_noauth parameter		if (!$params->get('show_noauth'))		{			$this->setState('filter.access', true);		}		else		{			$this->setState('filter.access', false);		}		// Optional filter text		$this->setState('list.filter', $app->input->getString('filter-search'));		// filter.order		$itemid = $app->input->get('id', 0, 'int') . ':' . $app->input->get('Itemid', 0, 'int');		$orderCol = $app->getUserStateFromRequest('com_content.category.list.' . $itemid . '.filter_order', 'filter_order', '', 'string');		if (!in_array($orderCol, $this->filter_fields))		{			$orderCol = 'a.ordering';		}		$this->setState('list.ordering', $orderCol);		$listOrder = $app->getUserStateFromRequest('com_content.category.list.' . $itemid . '.filter_order_Dir',			'filter_order_Dir', '', 'cmd');		if (!in_array(strtoupper($listOrder), array('ASC', 'DESC', '')))		{			$listOrder = 'ASC';		}		$this->setState('list.direction', $listOrder);		$this->setState('list.start', $app->input->get('limitstart', 0, 'uint'));		// set limit for query. If list, use parameter. If blog, add blog parameters for limit.		if (($app->input->get('layout') == 'blog') || $params->get('layout_type') == 'blog')		{			$limit = $params->get('num_leading_articles') + $params->get('num_intro_articles') + $params->get('num_links');			$this->setState('list.links', $params->get('num_links'));		}		else		{			$limit = $app->getUserStateFromRequest('com_content.category.list.' . $itemid . '.limit', 'limit', $params->get('display_num'), 'uint');		}		$this->setState('list.limit', $limit);		// set the depth of the category query based on parameter		$showSubcategories = $params->get('show_subcategory_content', '0');		if ($showSubcategories)		{			$this->setState('filter.max_category_levels', $params->get('show_subcategory_content', '1'));			$this->setState('filter.subcategories', true);		}		$this->setState('filter.language', JLanguageMultilang::isEnabled());		$this->setState('layout', $app->input->get('layout'));	}	/**	 * Get the articles in the category	 *	 * @return  mixed  An array of articles or false if an error occurs.	 * @since   1.5	 */	function getItems()	{		$params = $this->getState()->get('params');		$limit = $this->getState('list.limit');		if ($this->_articles === null && $category = $this->getCategory())		{			$model = JModelLegacy::getInstance('Articles', 'ContentModel', array('ignore_request' => true));			$model->setState('params', JFactory::getApplication()->getParams());			$model->setState('filter.category_id', $category->id);			$model->setState('filter.published', $this->getState('filter.published'));			$model->setState('filter.access', $this->getState('filter.access'));			$model->setState('filter.language', $this->getState('filter.language'));			$model->setState('list.ordering', $this->_buildContentOrderBy());			$model->setState('list.start', $this->getState('list.start'));			$model->setState('list.limit', $limit);			$model->setState('list.direction', $this->getState('list.direction'));			$model->setState('list.filter', $this->getState('list.filter'));			// filter.subcategories indicates whether to include articles from subcategories in the list or blog			$model->setState('filter.subcategories', $this->getState('filter.subcategories'));			$model->setState('filter.max_category_levels', $this->setState('filter.max_category_levels'));			$model->setState('list.links', $this->getState('list.links'));			if ($limit >= 0)			{				$this->_articles = $model->getItems();				if ($this->_articles === false)				{					$this->setError($model->getError());				}			}			else			{				$this->_articles = array();			}			$this->_pagination = $model->getPagination();		}		return $this->_articles;	}	/**	 * Build the orderby for the query	 *	 * @return  string	$orderby portion of query	 * @since   1.5	 */	protected function _buildContentOrderBy()	{		$app		= JFactory::getApplication('site');		$db			= $this->getDbo();		$params		= $this->state->params;		$itemid		= $app->input->get('id', 0, 'int') . ':' . $app->input->get('Itemid', 0, 'int');		$orderCol	= $app->getUserStateFromRequest('com_content.category.list.' . $itemid . '.filter_order', 'filter_order', '', 'string');		$orderDirn	= $app->getUserStateFromRequest('com_content.category.list.' . $itemid . '.filter_order_Dir', 'filter_order_Dir', '', 'cmd');		$orderby	= ' ';		if (!in_array($orderCol, $this->filter_fields))		{			$orderCol = null;		}		if (!in_array(strtoupper($orderDirn), array('ASC', 'DESC', '')))		{			$orderDirn = 'ASC';		}		if ($orderCol && $orderDirn)		{			$orderby .= $db->escape($orderCol) . ' ' . $db->escape($orderDirn) . ', ';		}		$articleOrderby		= $params->get('orderby_sec', 'rdate');		$articleOrderDate	= $params->get('order_date');		$categoryOrderby	= $params->def('orderby_pri', '');		$secondary			= ContentHelperQuery::orderbySecondary($articleOrderby, $articleOrderDate) . ', ';		$primary			= ContentHelperQuery::orderbyPrimary($categoryOrderby);		$orderby .= $primary . ' ' . $secondary . ' a.created ';		return $orderby;	}	public function getPagination()	{		if (empty($this->_pagination))		{			return null;		}		return $this->_pagination;	}	/**	 * Method to get category data for the current category	 *	 * @param   integer  An optional ID	 *	 * @return  object	 * @since   1.5	 */	public function getCategory()	{		if (!is_object($this->_item))		{			if ( isset( $this->state->params ) )			{				$params = $this->state->params;				$options = array();				$options['countItems'] = $params->get('show_cat_num_articles', 1) || !$params->get('show_empty_categories_cat', 0);			}			else {				$options['countItems'] = 0;			}			$categories = JCategories::getInstance('Content', $options);			$this->_item = $categories->get($this->getState('category.id', 'root'));			// Compute selected asset permissions.			if (is_object($this->_item))			{				$user	= JFactory::getUser();				$userId	= $user->get('id');				$asset	= 'com_content.category.'.$this->_item->id;				// Check general create permission.				if ($user->authorise('core.create', $asset))				{					$this->_item->getParams()->set('access-create', true);				}				// TODO: Why aren't we lazy loading the children and siblings?				$this->_children = $this->_item->getChildren();				$this->_parent = false;				if ($this->_item->getParent())				{					$this->_parent = $this->_item->getParent();				}				$this->_rightsibling = $this->_item->getSibling();				$this->_leftsibling = $this->_item->getSibling(false);			}			else {				$this->_children = false;				$this->_parent = false;			}		}		return $this->_item;	}	/**	 * Get the parent category.	 *	 * @param   integer  An optional category id. If not supplied, the model state 'category.id' will be used.	 *	 * @return  mixed  An array of categories or false if an error occurs.	 * @since   1.6	 */	public function getParent()	{		if (!is_object($this->_item))		{			$this->getCategory();		}		return $this->_parent;	}	/**	 * Get the left sibling (adjacent) categories.	 *	 * @return  mixed  An array of categories or false if an error occurs.	 * @since   1.6	 */	function &getLeftSibling()	{		if (!is_object($this->_item))		{			$this->getCategory();		}		return $this->_leftsibling;	}	/**	 * Get the right sibling (adjacent) categories.	 *	 * @return  mixed  An array of categories or false if an error occurs.	 * @since   1.6	 */	function &getRightSibling()	{		if (!is_object($this->_item))		{			$this->getCategory();		}		return $this->_rightsibling;	}	/**	 * Get the child categories.	 *	 * @param   integer  An optional category id. If not supplied, the model state 'category.id' will be used.	 *	 * @return  mixed  An array of categories or false if an error occurs.	 * @since   1.6	 */	function &getChildren()	{		if (!is_object($this->_item))		{			$this->getCategory();		}		// Order subcategories		if (count($this->_children))		{			$params = $this->getState()->get('params');			if ($params->get('orderby_pri') == 'alpha' || $params->get('orderby_pri') == 'ralpha')			{				jimport('joomla.utilities.arrayhelper');				JArrayHelper::sortObjects($this->_children, 'title', ($params->get('orderby_pri') == 'alpha') ? 1 : -1);			}		}		return $this->_children;	}	/**	 * Increment the hit counter for the category.	 *	 * @param   int  $pk  Optional primary key of the category to increment.	 *	 * @return  boolean True if successful; false otherwise and internal error set.	 */	public function hit($pk = 0)	{		// Initialise variables.		$pk = (!empty($pk)) ? $pk : (int) $this->getState('category.id');		$db = $this->getDbo();		$query = $db->getQuery(true)			->update('#__categories')			->set('hits = hits + 1')			->where('id = ' . (int) $pk);		$db->setQuery($query);		try		{			$db->execute();		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_languages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * @package     Joomla.Administrator * @subpackage  com_languages * @since       1.6 */class LanguagesControllerLanguages extends JControllerAdmin{	/**	 * Method to get a model object, loading it if required.	 *	 * @param   string  $name    The model name. Optional.	 * @param   string  $prefix  The class prefix. Optional.	 * @param   array   $config  Configuration array for model. Optional.	 *	 * @return  object  The model.	 *	 * @since   1.6	 */	public function getModel($name = 'Language', $prefix = 'LanguagesModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Build the route for the com_newsfeeds component * * @return  array  An array of URL arguments * * @return  array  The URL arguments to use to assemble the subsequent URL. */function NewsfeedsBuildRoute(&$query){	$segments = array();	// get a menu item based on Itemid or currently active	$app	= JFactory::getApplication();	$menu	= $app->getMenu();	$params = JComponentHelper::getParams('com_newsfeeds');	$advanced = $params->get('sef_advanced_link', 0);	if (empty($query['Itemid']))	{		$menuItem = $menu->getActive();	}	else	{		$menuItem = $menu->getItem($query['Itemid']);	}	$mView = (empty($menuItem->query['view'])) ? null : $menuItem->query['view'];	$mId   = (empty($menuItem->query['id'])) ? null : $menuItem->query['id'];	if (isset($query['view']))	{		$view = $query['view'];		if (empty($query['Itemid']) || empty($menuItem) || $menuItem->component != 'com_newsfeeds')		{			$segments[] = $query['view'];		}		unset($query['view']);	}	// are we dealing with an newsfeed that is attached to a menu item?	if (isset($query['view']) && ($mView == $query['view']) and (isset($query['id'])) and ($mId == (int) $query['id']))	{		unset($query['view']);		unset($query['catid']);		unset($query['id']);		return $segments;	}	if (isset($view) and ($view == 'category' or $view == 'newsfeed'))	{		if ($mId != (int) $query['id'] || $mView != $view)		{			if ($view == 'newsfeed' && isset($query['catid']))			{				$catid = $query['catid'];			}			elseif (isset($query['id']))			{				$catid = $query['id'];			}			$menuCatid = $mId;			$categories = JCategories::getInstance('Newsfeeds');			$category = $categories->get($catid);			if ($category)			{				$path = $category->getPath();				$path = array_reverse($path);				$array = array();				foreach ($path as $id)				{					if ((int) $id == (int) $menuCatid)					{						break;					}					if ($advanced)					{						list($tmp, $id) = explode(':', $id, 2);					}					$array[] = $id;				}				$segments = array_merge($segments, array_reverse($array));			}			if ($view == 'newsfeed')			{				if ($advanced)				{					list($tmp, $id) = explode(':', $query['id'], 2);				}				else				{					$id = $query['id'];				}				$segments[] = $id;			}		}		unset($query['id']);		unset($query['catid']);	}	if (isset($query['layout']))	{		if (!empty($query['Itemid']) && isset($menuItem->query['layout']))		{			if ($query['layout'] == $menuItem->query['layout'])			{				unset($query['layout']);			}		}		else		{			if ($query['layout'] == 'default')			{				unset($query['layout']);			}		}	}	return $segments;}/** * Parse the segments of a URL. * * @return  array  The segments of the URL to parse. * * @return  array  The URL attributes to be used by the application. */function NewsfeedsParseRoute($segments){	$vars = array();	//Get the active menu item.	$app	= JFactory::getApplication();	$menu	= $app->getMenu();	$item	= $menu->getActive();	$params = JComponentHelper::getParams('com_newsfeeds');	$advanced = $params->get('sef_advanced_link', 0);	// Count route segments	$count = count($segments);	// Standard routing for newsfeeds.	if (!isset($item))	{		$vars['view']	= $segments[0];		$vars['id']		= $segments[$count - 1];		return $vars;	}	// From the categories view, we can only jump to a category.	$id = (isset($item->query['id']) && $item->query['id'] > 1) ? $item->query['id'] : 'root';	$categories = JCategories::getInstance('Newsfeeds')->get($id)->getChildren();	$vars['catid'] = $id;	$vars['id'] = $id;	$found = 0;	foreach ($segments as $segment)	{		$segment = $advanced ? str_replace(':', '-', $segment) : $segment;		foreach ($categories as $category)		{			if ($category->slug == $segment || $category->alias == $segment)			{				$vars['id'] = $category->id;				$vars['catid'] = $category->id;				$vars['view'] = 'category';				$categories = $category->getChildren();				$found = 1;				break;			}		}		if ($found == 0)		{			if ($advanced)			{				$db = JFactory::getDbo();				$query = $db->getQuery(true)					->select($db->quoteName('id'))					->from('#__newsfeeds')					->where($db->quoteName('catid') . ' = ' . (int) $vars['catid'])					->where($db->quoteName('alias') . ' = ' . $db->quote($db->quote($segment)));				$db->setQuery($query);				$nid = $db->loadResult();			}			else			{				$nid = $segment;			}			$vars['id'] = $nid;			$vars['view'] = 'newsfeed';		}		$found = 0;	}	return $vars;}
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;jimport('joomla.updater.update');/** * Installer Update Model * * @package     Joomla.Administrator * @subpackage  com_installer * @since       1.6 */class InstallerModelUpdate extends JModelList{	/**	 * Constructor.	 *	 * @param   array  $config  An optional associative array of configuration settings.	 *	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'name',				'client_id',				'type',				'folder',				'extension_id',				'update_id',				'update_site_id',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication();		$value = $app->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $value);		$clientId = $this->getUserStateFromRequest($this->context . '.filter.client_id', 'filter_client_id', '');		$this->setState('filter.client_id', $clientId);		$categoryId = $this->getUserStateFromRequest($this->context . '.filter.type', 'filter_type', '');		$this->setState('filter.type', $categoryId);		$group = $this->getUserStateFromRequest($this->context . '.filter.group', 'filter_group', '');		$this->setState('filter.group', $group);		$this->setState('message', $app->getUserState('com_installer.message'));		$this->setState('extension_message', $app->getUserState('com_installer.extension_message'));		$app->setUserState('com_installer.message', '');		$app->setUserState('com_installer.extension_message', '');		parent::populateState('name', 'asc');	}	/**	 * Method to get the database query	 *	 * @return  JDatabaseQuery  The database query	 *	 * @since   1.6	 */	protected function getListQuery()	{		$db = $this->getDbo();		$query = $db->getQuery(true);		$type = $this->getState('filter.type');		$client = $this->getState('filter.client_id');		$group = $this->getState('filter.group');		// Grab updates ignoring new installs		$query->select('*')			->from('#__updates')			->where('extension_id != 0')			->order($this->getState('list.ordering') . ' ' . $this->getState('list.direction'));		if ($type)		{			$query->where('type=' . $db->quote($type));		}		if ($client != '')		{			$query->where('client_id = ' . intval($client));		}		if ($group != '' && in_array($type, array('plugin', 'library', '')))		{			$query->where('folder=' . $db->quote($group == '*' ? '' : $group));		}		// Filter by extension_id		if ($eid = $this->getState('filter.extension_id'))		{			$query->where($db->quoteName('extension_id') . ' = ' . $db->quote((int) $eid));		}		else		{			$query->where($db->quoteName('extension_id') . ' != ' . $db->quote(0))				->where($db->quoteName('extension_id') . ' != ' . $db->quote(700));		}		// Filter by search		$search = $this->getState('filter.search');		if (!empty($search))		{			$query->where('name LIKE ' . $db->quote('%' . $search . '%'));		}		return $query;	}	/**	 * Finds updates for an extension.	 *	 * @param   int  $eid            Extension identifier to look for	 * @param   int  $cache_timeout  Cache timout	 *	 * @return  boolean Result	 *	 * @since   1.6	 */	public function findUpdates($eid = 0, $cache_timeout = 0)	{		// Purge the updates list		$this->purge();		$updater = JUpdater::getInstance();		$results = $updater->findUpdates($eid, $cache_timeout);		return true;	}	/**	 * Removes all of the updates from the table.	 *	 * @return  boolean result of operation	 *	 * @since   1.6	 */	public function purge()	{		$db = JFactory::getDbo();		// Note: TRUNCATE is a DDL operation		// This may or may not mean depending on your database		$db->setQuery('TRUNCATE TABLE #__updates');		if ($db->execute())		{			// Reset the last update check timestamp			$query = $db->getQuery(true)				->update($db->quoteName('#__update_sites'))				->set($db->quoteName('last_check_timestamp') . ' = ' . $db->quote(0));			$db->setQuery($query);			$db->execute();			$this->_message = JText::_('COM_INSTALLER_PURGED_UPDATES');			return true;		}		else		{			$this->_message = JText::_('COM_INSTALLER_FAILED_TO_PURGE_UPDATES');			return false;		}	}	/**	 * Enables any disabled rows in #__update_sites table	 *	 * @return  boolean result of operation	 *	 * @since   1.6	 */	public function enableSites()	{		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->update('#__update_sites')			->set('enabled = 1')			->where('enabled = 0');		$db->setQuery($query);		if ($db->execute())		{			if ($rows = $db->getAffectedRows())			{				$this->_message .= JText::plural('COM_INSTALLER_ENABLED_UPDATES', $rows);			}			return true;		}		else		{			$this->_message .= JText::_('COM_INSTALLER_FAILED_TO_ENABLE_UPDATES');			return false;		}	}	/**	 * Update function.	 *	 * Sets the "result" state with the result of the operation.	 *	 * @param   array  $uids  Array[int] List of updates to apply	 *	 * @return  void	 *	 * @since   1.6	 */	public function update($uids)	{		$result = true;		foreach ($uids as $uid)		{			$update = new JUpdate;			$instance = JTable::getInstance('update');			$instance->load($uid);			$update->loadFromXML($instance->detailsurl);			// Install sets state and enqueues messages			$res = $this->install($update);			if ($res)			{				$instance->delete($uid);			}			$result = $res & $result;		}		// Set the final state		$this->setState('result', $result);	}	/**	 * Handles the actual update installation.	 *	 * @param   JUpdate  $update  An update definition	 *	 * @return  boolean   Result of install	 *	 * @since   1.6	 */	private function install($update)	{		$app = JFactory::getApplication();		if (isset($update->get('downloadurl')->_data))		{			$url = $update->downloadurl->_data;		}		else		{			JError::raiseWarning('', JText::_('COM_INSTALLER_INVALID_EXTENSION_UPDATE'));			return false;		}		$p_file = JInstallerHelper::downloadPackage($url);		// Was the package downloaded?		if (!$p_file)		{			JError::raiseWarning('', JText::sprintf('COM_INSTALLER_PACKAGE_DOWNLOAD_FAILED', $url));			return false;		}		$config		= JFactory::getConfig();		$tmp_dest	= $config->get('tmp_path');		// Unpack the downloaded package file		$package	= JInstallerHelper::unpack($tmp_dest . '/' . $p_file);		// Get an installer instance		$installer	= JInstaller::getInstance();		$update->set('type', $package['type']);		// Install the package		if (!$installer->update($package['dir']))		{			// There was an error updating the package			$msg = JText::sprintf('COM_INSTALLER_MSG_UPDATE_ERROR', JText::_('COM_INSTALLER_TYPE_TYPE_' . strtoupper($package['type'])));			$result = false;		}		else		{			// Package updated successfully			$msg = JText::sprintf('COM_INSTALLER_MSG_UPDATE_SUCCESS', JText::_('COM_INSTALLER_TYPE_TYPE_' . strtoupper($package['type'])));			$result = true;		}		// Quick change		$this->type = $package['type'];		// Set some model state values		$app->enqueueMessage($msg);		// TODO: Reconfigure this code when you have more battery life left		$this->setState('name', $installer->get('name'));		$this->setState('result', $result);		$app->setUserState('com_installer.message', $installer->message);		$app->setUserState('com_installer.extension_message', $installer->get('extension_message'));		// Cleanup the install files		if (!is_file($package['packagefile']))		{			$config = JFactory::getConfig();			$package['packagefile'] = $config->get('tmp_path') . '/' . $package['packagefile'];		}		JInstallerHelper::cleanupInstall($package['packagefile'], $package['extractdir']);		return $result;	}	/**	* Method to get the row form.	*	* @param   array    $data      Data for the form.	* @param   boolean  $loadData  True if the form is to load its own data (default case), false if not.	*	* @return  mixed  A JForm object on success, false on failure	*	* @since	2.5.2	*/	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$app = JFactory::getApplication();		JForm::addFormPath(JPATH_COMPONENT . '/models/forms');		JForm::addFieldPath(JPATH_COMPONENT . '/models/fields');		$form = JForm::getInstance('com_installer.update', 'update', array('load_data' => $loadData));		// Check for an error.		if ($form == false)		{			$this->setError($form->getMessage());			return false;		}		// Check the session for previously entered form data.		$data = $this->loadFormData();		// Bind the form data if present.		if (!empty($data))		{			$form->bind($data);		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 *	 * @since	2.5.2	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState($this->context . '.data', array());		return $data;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * JFormRule for com_contact to make sure the subject contains no banned word. * * @package     Joomla.Site * @subpackage  com_contact */class JFormRuleContactEmailSubject extends JFormRule{	/**	 * Method to test for a valid color in hexadecimal.	 *	 * @param   SimpleXMLElement  &$element  The SimpleXMLElement object representing the <field /> tag for the form field object.	 * @param   mixed             $value     The form field value to validate.	 * @param   string            $group     The field name group control value. This acts as as an array container for the field.	 *                                       For example if the field has name="foo" and the group value is set to "bar" then the	 *                                       full field name would end up being "bar[foo]".	 * @param   object            &$input    An optional JRegistry object with the entire data set to validate against the entire form.	 * @param   object            &$form     The form object for which the field is being tested.	 *	 * @return  boolean  True if the value is valid, false otherwise.	 */	public function test(&$element, $value, $group = null, &$input = null, &$form = null)	{		$params = JComponentHelper::getParams('com_contact');		$banned = $params->get('banned_subject');		foreach (explode(';', $banned) as $item) {			if (JString::stristr($item, $value) !== false)					return false;		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$published = $this->state->get('filter.state');?><div class="modal hide fade" id="collapseModal">	<div class="modal-header">		<button type="button" role="presentation" class="close" data-dismiss="modal">x</button>		<h3><?php echo JText::_('COM_WEBLINKS_BATCH_OPTIONS');?></h3>	</div>	<div class="modal-body">		<p><?php echo JText::_('COM_WEBLINKS_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.access');?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.language'); ?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.tag');?>			</div>		</div>		<?php if ($published >= 0) : ?>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.item', 'com_weblinks');?>			</div>		</div>		<?php endif; ?>	</div>	<div class="modal-footer">		<button class="btn" type="button" onclick="document.id('batch-category-id').value='';document.id('batch-access').value='';document.id('batch-language-id').value='';document.id('batch-tag-id)').value=''" data-dismiss="modal">			<?php echo JText::_('JCANCEL'); ?>		</button>		<button class="btn btn-primary" type="submit" onclick="Joomla.submitbutton('weblink.batch');">			<?php echo JText::_('JGLOBAL_BATCH_PROCESS'); ?>		</button>	</div></div>
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$class = ' class="first"';JHtml::_('bootstrap.tooltip');$lang	= JFactory::getLanguage();if (count($this->children[$this->category->id]) > 0 && $this->maxLevel != 0) : ?>	<?php foreach ($this->children[$this->category->id] as $id => $child) : ?>		<?php		if ($this->params->get('show_empty_categories') || $child->numitems || count($child->getChildren())) :			if (!isset($this->children[$this->category->id][$id + 1])) :				$class = ' class="last"';			endif;		?>		<div<?php echo $class; ?>>			<?php $class = ''; ?>			<?php if ($lang->isRTL()) : ?>			<h3 class="page-header item-title">				<?php if ( $this->params->get('show_cat_num_articles', 1)) : ?>					<span class="badge badge-info tip hasTooltip" title="<?php echo JText::_('COM_CONTENT_NUM_ITEMS'); ?>">						<?php echo $child->getNumItems(true); ?>					</span>				<?php endif; ?>				<a href="<?php echo JRoute::_(ContentHelperRoute::getCategoryRoute($child->id)); ?>">				<?php echo $this->escape($child->title); ?></a>				<?php if (count($child->getChildren()) > 0) : ?>					<a href="#category-<?php echo $child->id;?>" data-toggle="collapse" data-toggle="button" class="btn btn-mini pull-right"><span class="icon-plus"></span></a>				<?php endif;?>			<?php else : ?>			<h3 class="page-header item-title"><a href="<?php echo JRoute::_(ContentHelperRoute::getCategoryRoute($child->id));?>">				<?php echo $this->escape($child->title); ?></a>				<?php if ( $this->params->get('show_cat_num_articles', 1)) : ?>					<span class="badge badge-info tip hasTooltip" title="<?php echo JText::_('COM_CONTENT_NUM_ITEMS'); ?>">						<?php echo $child->getNumItems(true); ?>					</span>				<?php endif; ?>				<?php if (count($child->getChildren()) > 0) : ?>					<a href="#category-<?php echo $child->id;?>" data-toggle="collapse" data-toggle="button" class="btn btn-mini pull-right"><span class="icon-plus"></span></a>				<?php endif;?>			<?php endif;?>			</h3>			<?php if ($this->params->get('show_subcat_desc') == 1) : ?>			<?php if ($child->description) : ?>				<div class="category-desc">					<?php echo JHtml::_('content.prepare', $child->description, '', 'com_content.category'); ?>				</div>			<?php endif; ?>			<?php endif; ?>			<?php if (count($child->getChildren()) > 0) : ?>			<div class="collapse fade" id="category-<?php echo $child->id; ?>">				<?php				$this->children[$child->id] = $child->getChildren();				$this->category = $child;				$this->maxLevel--;				if ($this->maxLevel != 0) :					echo $this->loadTemplate('children');				endif;				$this->category = $child->getParent();				$this->maxLevel++;				?>			</div>			<?php endif; ?>		</div>		<?php endif; ?>	<?php endforeach; ?><?php endif;
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT . '/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');JHtml::_('behavior.modal', 'a.modal');$user		= JFactory::getUser();$userId		= $user->get('id');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_banners&view=tracks'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('COM_BANNERS_BEGIN_LABEL'); ?></legend>		<div class="filter-search">			<label class="filter-hide-lbl" for="filter_begin"><?php echo JText::_('COM_BANNERS_BEGIN_LABEL'); ?></label>			<?php echo JHtml::_('calendar', $this->state->get('filter.begin'), 'filter_begin', 'filter_begin', '%Y-%m-%d', array('size' => 10));?>			<label class="filter-hide-lbl" for="filter_end"><?php echo JText::_('COM_BANNERS_END_LABEL'); ?></label>			<?php echo JHtml::_('calendar', $this->state->get('filter.end'), 'filter_end', 'filter_end', '%Y-%m-%d', array('size' => 10));?>		</div>		<div class="filter-select">            <label class="selectlabel" for="filter_client_id">				<?php echo JText::_('COM_BANNERS_SELECT_CLIENT'); ?>			</label>			<select name="filter_client_id" class="inputbox" id="filter_client_id">				<option value=""><?php echo JText::_('COM_BANNERS_SELECT_CLIENT');?></option>				<?php echo JHtml::_('select.options', BannersHelper::getClientOptions(), 'value', 'text', $this->state->get('filter.client_id'));?>			</select>			<label class="selectlabel" for="filter_category_id">				<?php echo JText::_('JOPTION_SELECT_CATEGORY'); ?>			</label>			<?php $category = $this->state->get('filter.category_id');?>			<select name="filter_category_id" class="inputbox" id="filter_category_id">				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php echo JHtml::_('select.options', JHtml::_('category.options', 'com_banners'), 'value', 'text', $category);?>			</select>			<label class="selectlabel" for="filter_type">				<?php echo JText::_('BANNERS_SELECT_TYPE'); ?>			</label>			<select name="filter_type" class="inputbox" id="filter_type">				<?php echo JHtml::_('select.options', array(JHtml::_('select.option', '0', JText::_('COM_BANNERS_SELECT_TYPE')), JHtml::_('select.option', 1, JText::_('COM_BANNERS_IMPRESSION')), JHtml::_('select.option', 2, JText::_('COM_BANNERS_CLICK'))), 'value', 'text', $this->state->get('filter.type'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="title">					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_NAME', 'name', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-20">					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_CLIENT', 'client_name', $listDirn, $listOrder); ?>				</th>				<th class="width-20">					<?php echo JHtml::_('grid.sort', 'JCATEGORY', 'category_title', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-10">					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_TYPE', 'track_type', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-10">					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_COUNT', 'count', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-10">					<?php echo JHtml::_('grid.sort', 'JDATE', 'track_date', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) :?>			<tr class="row<?php echo $i % 2; ?>">				<td>					<?php echo $item->name;?>				</td>				<td>					<?php echo $item->client_name;?>				</td>				<td>					<?php echo $item->category_title;?>				</td>				<td>					<?php echo $item->track_type == 1 ? JText::_('COM_BANNERS_IMPRESSION'): JText::_('COM_BANNERS_CLICK');?>				</td>				<td>					<?php echo $item->count;?>				</td>				<td>					<?php echo JHtml::_('date', $item->track_date, JText::_('DATE_FORMAT_LC4').' H:i');?>				</td>			</tr>		<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?></div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Feed * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Class to encapsulate a feed for the Joomla Platform. * * @property  JFeedPerson  $author         Person responsible for feed content. * @property  array        $categories     Categories to which the feed belongs. * @property  array        $contributors   People who contributed to the feed content. * @property  string       $copyright      Information about rights, e.g. copyrights, held in and over the feed. * @property  string       $description    A phrase or sentence describing the feed. * @property  string       $generator      A string indicating the program used to generate the feed. * @property  string       $image          Specifies a GIF, JPEG or PNG image that should be displayed with the feed. * @property  JDate        $publishedDate  The publication date for the feed content. * @property  string       $title          A human readable title for the feed. * @property  JDate        $updatedDate    The last time the content of the feed changed. * @property  string       $uri            Universal, permanent identifier for the feed. * * @package     Joomla.Platform * @subpackage  Feed * @since       12.3 */class JFeed implements ArrayAccess{	/**	 * @var    array  The entry properties.	 * @since  12.3	 */	protected $properties = array(		'uri' => '',		'title' => '',		'updatedDate' => '',		'description' => '',		'categories' => array(),		'contributors' => array()	);	/**	 * @var    array  The list of feed entry objects.	 * @since  12.3	 */	protected $entries = array();	/**	 * Magic method to return values for feed properties.	 *	 * @param   string  $name  The name of the property.	 *	 * @return  mixed	 *	 * @since   12.3	 */	public function __get($name)	{		return isset($this->properties[$name]) ? $this->properties[$name] : null;	}	/**	 * Magic method to set values for feed properties.	 *	 * @param   string  $name   The name of the property.	 * @param   mixed   $value  The value to set for the property.	 *	 * @return  void	 *	 * @since   12.3	 */	public function __set($name, $value)	{		// Ensure that setting a date always sets a JDate instance.		if ((($name == 'updatedDate') || ($name == 'publishedDate')) && !($value instanceof JDate))		{			$value = new JDate($value);		}		// Validate that any authors that are set are instances of JFeedPerson or null.		if (($name == 'author') && (!($value instanceof JFeedPerson) || ($value === null)))		{			throw new InvalidArgumentException('JFeed "author" must be of type JFeedPerson. ' . gettype($value) . 'given.');		}		// Disallow setting categories or contributors directly.		if (($name == 'categories') || ($name == 'contributors'))		{			throw new InvalidArgumentException('Cannot directly set JFeed property "' . $name . '".');		}		$this->properties[$name] = $value;	}	/**	 * Method to add a category to the feed object.	 *	 * @param   string  $name  The name of the category to add.	 * @param   string  $uri   The optional URI for the category to add.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function addCategory($name, $uri = '')	{		$this->properties['categories'][$name] = $uri;		return $this;	}	/**	 * Method to add a contributor to the feed object.	 *	 * @param   string  $name   The full name of the person to add.	 * @param   string  $email  The email address of the person to add.	 * @param   string  $uri    The optional URI for the person to add.	 * @param   string  $type   The optional type of person to add.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function addContributor($name, $email, $uri = null, $type = null)	{		$contributor = new JFeedPerson($name, $email, $uri, $type);		// If the new contributor already exists then there is nothing to do, so just return.		foreach ($this->properties['contributors'] as $c)		{			if ($c == $contributor)			{				return $this;			}		}		// Add the new contributor.		$this->properties['contributors'][] = $contributor;		return $this;	}	/**	 * Method to add an entry to the feed object.	 *	 * @param   JFeedEntry  $entry  The entry object to add.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function addEntry(JFeedEntry $entry)	{		// If the new entry already exists then there is nothing to do, so just return.		foreach ($this->entries as $e)		{			if ($e == $entry)			{				return $this;			}		}		// Add the new entry.		$this->entries[] = $entry;		return $this;	}	/**	 * Whether or not an offset exists.  This method is executed when using isset() or empty() on	 * objects implementing ArrayAccess.	 *	 * @param   mixed  $offset  An offset to check for.	 *	 * @return  boolean	 *	 * @see     ArrayAccess::offsetExists()	 * @since   12.3	 */	public function offsetExists($offset)	{		return isset($this->entries[$offset]);	}	/**	 * Returns the value at specified offset.	 *	 * @param   mixed  $offset  The offset to retrieve.	 *	 * @return  mixed  The value at the offset.	 *	 * @see     ArrayAccess::offsetGet()	 * @since   12.3	 */	public function offsetGet($offset)	{		return $this->entries[$offset];	}	/**	 * Assigns a value to the specified offset.	 *	 * @param   mixed       $offset  The offset to assign the value to.	 * @param   JFeedEntry  $value   The JFeedEntry to set.	 *	 * @return  boolean	 *	 * @see    ArrayAccess::offsetSet()	 * @since  12.3	 */	public function offsetSet($offset, $value)	{		if (!($value instanceof JFeedEntry))		{			throw new InvalidArgumentException('Cannot set value of type "' . gettype($value) . '".');		}		$this->entries[$offset] = $value;		return true;	}	/**	 * Unsets an offset.	 *	 * @param   mixed  $offset  The offset to unset.	 *	 * @return  void	 *	 * @see     ArrayAccess::offsetUnset()	 * @since   12.3	 */	public function offsetUnset($offset)	{		unset($this->entries[$offset]);	}	/**	 * Method to remove a category from the feed object.	 *	 * @param   string  $name  The name of the category to remove.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function removeCategory($name)	{		unset($this->properties['categories'][$name]);		return $this;	}	/**	 * Method to remove a contributor from the feed object.	 *	 * @param   JFeedPerson  $contributor  The person object to remove.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function removeContributor(JFeedPerson $contributor)	{		// If the contributor exists remove it.		foreach ($this->properties['contributors'] as $k => $c)		{			if ($c == $contributor)			{				unset($this->properties['contributors'][$k]);				$this->properties['contributors'] = array_values($this->properties['contributors']);				return $this;			}		}		return $this;	}	/**	 * Method to remove an entry from the feed object.	 *	 * @param   JFeedEntry  $entry  The entry object to remove.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function removeEntry(JFeedEntry $entry)	{		// If the entry exists remove it.		foreach ($this->entries as $k => $e)		{			if ($e == $entry)			{				unset($this->entries[$k]);				$this->entries = array_values($this->entries);				return $this;			}		}		return $this;	}	/**	 * Shortcut method to set the author for the feed object.	 *	 * @param   string  $name   The full name of the person to set.	 * @param   string  $email  The email address of the person to set.	 * @param   string  $uri    The optional URI for the person to set.	 * @param   string  $type   The optional type of person to set.	 *	 * @return  JFeed	 *	 * @since   12.3	 */	public function setAuthor($name, $email, $uri = null, $type = null)	{		$author = new JFeedPerson($name, $email, $uri, $type);		$this->properties['author'] = $author;		return $this;	}}
<?php/** * @package    Joomla.Site * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Version information class for the Joomla CMS. * * @package  Joomla.Site * @since    1.0 */final class JVersion{	/** @var  string  Product name. */	public $PRODUCT = 'Joomla!';	/** @var  string  Release version. */	public $RELEASE = '3.1';	/** @var  string  Maintenance version. */	public $DEV_LEVEL = '0';	/** @var  string  Development STATUS. */	public $DEV_STATUS = 'Stable';	/** @var  string  Build number. */	public $BUILD = '';	/** @var  string  Code name. */	public $CODENAME = 'Ember';	/** @var  string  Release date. */	public $RELDATE = '24-April-2013';	/** @var  string  Release time. */	public $RELTIME = '14:00';	/** @var  string  Release timezone. */	public $RELTZ = 'GMT';	/** @var  string  Copyright Notice. */	public $COPYRIGHT = 'Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved.';	/** @var  string  Link text. */	public $URL = '<a href="http://www.joomla.org">Joomla!</a> is Free Software released under the GNU General Public License.';	/**	 * Compares two a "PHP standardized" version number against the current Joomla version.	 *	 * @param   string  $minimum  The minimum version of the Joomla which is compatible.	 *	 * @return  bool    True if the version is compatible.	 *	 * @see     http://www.php.net/version_compare	 * @since   1.0	 */	public function isCompatible($minimum)	{		return version_compare(JVERSION, $minimum, 'ge');	}	/**	 * Method to get the help file version.	 *	 * @return  string  Version suffix for help files.	 *	 * @since   1.0	 */	public function getHelpVersion()	{		return '.' . str_replace('.', '', $this->RELEASE);	}	/**	 * Gets a "PHP standardized" version string for the current Joomla.	 *	 * @return  string  Version string.	 *	 * @since   1.5	 */	public function getShortVersion()	{		return $this->RELEASE . '.' . $this->DEV_LEVEL;	}	/**	 * Gets a version string for the current Joomla with all release information.	 *	 * @return  string  Complete version string.	 *	 * @since   1.5	 */	public function getLongVersion()	{		return $this->PRODUCT . ' ' . $this->RELEASE . '.' . $this->DEV_LEVEL . ' '				. $this->DEV_STATUS . ' [ ' . $this->CODENAME . ' ] ' . $this->RELDATE . ' '				. $this->RELTIME . ' ' . $this->RELTZ;	}	/**	 * Returns the user agent.	 *	 * @param   string  $component    Name of the component.	 * @param   bool    $mask         Mask as Mozilla/5.0 or not.	 * @param   bool    $add_version  Add version afterwards to component.	 *	 * @return  string  User Agent.	 *	 * @since   1.0	 */	public function getUserAgent($component = null, $mask = false, $add_version = true)	{		if ($component === null)		{			$component = 'Framework';		}		if ($add_version)		{			$component .= '/' . $this->RELEASE;		}		// If masked pretend to look like Mozilla 5.0 but still identify ourselves.		if ($mask)		{			return 'Mozilla/5.0 ' . $this->PRODUCT . '/' . $this->RELEASE . '.' . $this->DEV_LEVEL . ($component ? ' ' . $component : '');		}		else		{			return $this->PRODUCT . '/' . $this->RELEASE . '.' . $this->DEV_LEVEL . ($component ? ' ' . $component : '');		}	}}
<?php/** * @package    Joomla.Site * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Joomla! Application define. *///Global definitions.//Joomla framework path definitions.$parts = explode(DIRECTORY_SEPARATOR, JPATH_BASE);//Defines.define('JPATH_ROOT',          implode(DIRECTORY_SEPARATOR, $parts));define('JPATH_SITE',          JPATH_ROOT);define('JPATH_CONFIGURATION', JPATH_ROOT);define('JPATH_ADMINISTRATOR', JPATH_ROOT . '/administrator');define('JPATH_LIBRARIES',     JPATH_ROOT . '/libraries');define('JPATH_PLUGINS',       JPATH_ROOT . '/plugins');define('JPATH_INSTALLATION',  JPATH_ROOT . '/installation');define('JPATH_THEMES',        JPATH_BASE . '/templates');define('JPATH_CACHE',         JPATH_BASE . '/cache');define('JPATH_MANIFESTS',     JPATH_ADMINISTRATOR . '/manifests');
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Form Field class for the Joomla Platform. * * Provides a pop up date picker linked to a button. * Optionally may be filtered to use user's or server's time zone. * * @package     Joomla.Platform * @subpackage  Form * @since       11.1 */class JFormFieldCalendar extends JFormField{	/**	 * The form field type.	 *	 * @var    string	 * @since  11.1	 */	public $type = 'Calendar';	/**	 * Method to get the field input markup.	 *	 * @return  string   The field input markup.	 *	 * @since   11.1	 */	protected function getInput()	{		// Initialize some field attributes.		$format = $this->element['format'] ? (string) $this->element['format'] : '%Y-%m-%d';		// Build the attributes array.		$attributes = array();		if ($this->element['size'])		{			$attributes['size'] = (int) $this->element['size'];		}		if ($this->element['maxlength'])		{			$attributes['maxlength'] = (int) $this->element['maxlength'];		}		if ($this->element['class'])		{			$attributes['class'] = (string) $this->element['class'];		}		if ((string) $this->element['readonly'] == 'true')		{			$attributes['readonly'] = 'readonly';		}		if ((string) $this->element['disabled'] == 'true')		{			$attributes['disabled'] = 'disabled';		}		if ($this->element['onchange'])		{			$attributes['onchange'] = (string) $this->element['onchange'];		}		if ($this->required)		{			$attributes['required'] = 'required';			$attributes['aria-required'] = 'true';		}		// Handle the special case for "now".		if (strtoupper($this->value) == 'NOW')		{			$this->value = strftime($format);		}		// Get some system objects.		$config = JFactory::getConfig();		$user = JFactory::getUser();		// If a known filter is given use it.		switch (strtoupper((string) $this->element['filter']))		{			case 'SERVER_UTC':				// Convert a date to UTC based on the server timezone.				if ((int) $this->value)				{					// Get a date object based on the correct timezone.					$date = JFactory::getDate($this->value, 'UTC');					$date->setTimezone(new DateTimeZone($config->get('offset')));					// Transform the date string.					$this->value = $date->format('Y-m-d H:i:s', true, false);				}				break;			case 'USER_UTC':				// Convert a date to UTC based on the user timezone.				if ((int) $this->value)				{					// Get a date object based on the correct timezone.					$date = JFactory::getDate($this->value, 'UTC');					$date->setTimezone(new DateTimeZone($user->getParam('timezone', $config->get('offset'))));					// Transform the date string.					$this->value = $date->format('Y-m-d H:i:s', true, false);				}				break;		}		return JHtml::_('calendar', $this->value, $this->name, $this->id, $format, $attributes);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  mod_feed * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><?phpif (is_string($feed)){	echo $feed;}else{	$lang      = JFactory::getLanguage();	$myrtl     = $params->get('rssrtl');	$direction = '';	if ($lang->isRTL() && $myrtl == 0)	{		$direction = " redirect-rtl";	}	elseif ($lang->isRTL() && $myrtl == 1)	{		$direction = " redirect-ltr";	}	elseif ($lang->isRTL() && $myrtl == 2)	{		$direction = " redirect-rtl";	}	elseif ($myrtl == 0)	{		$direction = " redirect-ltr";	}	elseif ($myrtl == 1)	{		$direction = " redirect-ltr";	}	elseif ($myrtl == 2)	{		$direction = " redirect-rtl";	}	?>	<?php if ($feed != false) : ?>	<?php	// Image handling	$iUrl   = isset($feed->image) ? $feed->image : null;	$iTitle = isset($feed->imagetitle) ? $feed->imagetitle : null;	?>	<div class="row-striped">	<div style="direction: <?php echo $rssrtl ? 'rtl' : 'ltr'; ?>; text-align: <?php echo $rssrtl ? 'right' : 'left'; ?> ! important"  class="feed<?php echo $moduleclass_sfx; ?>">	<?php if (!is_null($feed->title) && $params->get('rsstitle', 1)) : ?>		<h2 class="redirect-ltr">			<a href="<?php echo str_replace('&', '&amp', $feed->link); ?>" target="_blank">				<?php echo $feed->title; ?></a>		</h2>	<?php endif; ?>	<?php if ($params->get('rssdesc', 1)) : ?>		<?php echo $feed->description; ?>	<?php endif; ?>	<?php if ($params->get('rssimage', 1) && $iUrl) : ?>		<img src="<?php echo $iUrl; ?>" alt="<?php echo @$iTitle; ?>"/>	<?php endif; ?>	<ul class="newsfeed<?php echo $params->get('moduleclass_sfx'); ?>">	<?php if (!empty($feed)) : ?>		<?php for ($i = 0; $i < $params->get('rssitems', 5); $i++) : ?>			<?php			$uri  = (!empty($feed[$i]->guid) || !is_null($feed[$i]->guid)) ? $feed[$i]->guid : $feed[$i]->uri;			$uri  = substr($uri, 0, 4) != 'http' ? $params->get('rsslink') : $uri;			$text = !empty($feed[$i]->content) || !is_null($feed[$i]->content) ? $feed[$i]->content : $feed[$i]->description;			?>			<li>				<?php if (!empty($uri)) : ?>					<h5 class="feed-link">						<a href="<?php echo $uri; ?>" target="_blank">							<?php  echo $feed[$i]->title; ?></a></h5>				<?php else : ?>					<h5 class="feed-link"><?php  echo $feed[$i]->title; ?></h5>				<?php  endif; ?>				<?php if ($params->get('rssitemdesc') && !empty($text)) : ?>					<div class="feed-item-description">						<?php						// Strip the images.						$text = JFilterOutput::stripImages($text);						$text = JHtml::_('string.truncate', $text, $params->get('word_count'));						echo str_replace('&apos;', "'", $text);						?>					</div>				<?php endif; ?>			</li>		<?php endfor; ?>	</ul>	<?php endif; ?>	<?php endif; ?>	</div>	</div><?php}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_users&view=debuggroup&user_id='.(int) $this->state->get('filter.user_id'));?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('COM_USERS_SEARCH_ASSETS'); ?></legend>		<div class="filter-search fltlft">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('COM_USERS_SEARCH_ASSETS'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_USERS_SEARCH_USERS'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_RESET'); ?></button>		</div>		<div class="filter-select fltrt">			<label class="selectlabel" for="filter_component"><?php echo JText::_('COM_USERS_OPTION_SELECT_COMPONENT'); ?></label>			<select name="filter_component" class="inputbox" id="filter_component">				<option value=""><?php echo JText::_('COM_USERS_OPTION_SELECT_COMPONENT');?></option>				<?php if (!empty($this->components))				{					echo JHtml::_('select.options', $this->components, 'value', 'text', $this->state->get('filter.component'));				}?>			</select>			<label class="selectlabel" for="filter_level_start"><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_START'); ?></label>			<select name="filter_level_start" class="inputbox" id="filter_level_start">				<option value=""><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_START');?></option>				<?php echo JHtml::_('select.options', $this->levels, 'value', 'text', $this->state->get('filter.level_start'));?>			</select>			<label class="selectlabel" for="filter_level_end"><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_END'); ?></label>			<select name="filter_level_end" class="inputbox" id="filter_level_end">				<option value=""><?php echo JText::_('COM_USERS_OPTION_SELECT_LEVEL_END');?></option>				<?php echo JHtml::_('select.options', $this->levels, 'value', 'text', $this->state->get('filter.level_end'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<div>		<?php echo JText::_('COM_USERS_DEBUG_LEGEND'); ?>		<span class="swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_NO_CHECK', '-');?></span>		<span class="check-0 swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_IMPLICIT_DENY', '-');?></span>		<span class="check-a swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_EXPLICIT_ALLOW', '&#10003;');?></span>		<span class="check-d swatch"><?php echo JText::sprintf('COM_USERS_DEBUG_EXPLICIT_DENY', '&#10007;');?></span>	</div>	<table class="adminlist">		<thead>			<tr>				<th class="left">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ASSET_TITLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<th class="left">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ASSET_NAME', 'a.name', $listDirn, $listOrder); ?>				</th>				<?php foreach ($this->actions as $key => $action) : ?>				<th class="width-5">					<span class="hasTip" title="<?php echo htmlspecialchars(JText::_($key).'::'.JText::_($action[1]), ENT_COMPAT, 'UTF-8'); ?>"><?php echo JText::_($key); ?></span>				</th>				<?php endforeach; ?>				<th class="width-5 nowrap">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_LFT', 'a.lft', $listDirn, $listOrder); ?>				</th>				<th class="width-5 nowrap">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row1">				<td>					<?php echo $this->escape($item->title); ?>				</td>				<td class="nowrap">					<?php echo str_repeat('<span class="gi">|&mdash;</span>', $item->level) ?>					<?php echo $this->escape($item->name); ?>				</td>				<?php foreach ($this->actions as $action) : ?>					<?php					$name	= $action[0];					$check	= $item->checks[$name];					if ($check === true) :						$class	= 'check-a';						$text	= '&#10003;';					elseif ($check === false) :						$class	= 'check-d';						$text	= '&#10007;';					elseif ($check === null) :						$class	= 'check-0';						$text	= '-';					else :						$class	= '';						$text	= '&#160;';					endif;					?>				<td class="center <?php echo $class;?>">					<?php echo $text; ?>				</td>				<?php endforeach; ?>				<td class="center">					<?php echo (int) $item->lft; ?>					- <?php echo (int) $item->rgt; ?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></div></form>
<?php/** * @package     Joomla.Platform * @subpackage  User * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Authentication class, provides an interface for the Joomla authentication system * * @package     Joomla.Platform * @subpackage  User * @since       11.1 */class JAuthentication extends JObject{	// Shared success status	/**	 * This is the status code returned when the authentication is success (permit login)	 * @const  STATUS_SUCCESS successful response	 * @since  11.2	 */	const STATUS_SUCCESS = 1;	// These are for authentication purposes (username and password is valid)	/**	 * Status to indicate cancellation of authentication (unused)	 * @const  STATUS_CANCEL cancelled request (unused)	 * @since  11.2	 */	const STATUS_CANCEL = 2;	/**	 * This is the status code returned when the authentication failed (prevent login if no success)	 * @const  STATUS_FAILURE failed request	 * @since  11.2	 */	const STATUS_FAILURE = 4;	// These are for authorisation purposes (can the user login)	/**	 * This is the status code returned when the account has expired (prevent login)	 * @const  STATUS_EXPIRED an expired account (will prevent login)	 * @since  11.2	 */	const STATUS_EXPIRED = 8;	/**	 * This is the status code returned when the account has been denied (prevent login)	 * @const  STATUS_DENIED denied request (will prevent login)	 * @since  11.2	 */	const STATUS_DENIED = 16;	/**	 * This is the status code returned when the account doesn't exist (not an error)	 * @const  STATUS_UNKNOWN unknown account (won't permit or prevent login)	 * @since  11.2	 */	const STATUS_UNKNOWN = 32;	/**	 * An array of Observer objects to notify	 *	 * @var    array	 * @since  12.1	 */	protected $observers = array();	/**	 * The state of the observable object	 *	 * @var    mixed	 * @since  12.1	 */	protected $state = null;	/**	 * A multi dimensional array of [function][] = key for observers	 *	 * @var    array	 * @since  12.1	 */	protected $methods = array();	/**	 * @var    JAuthentication  JAuthentication instances container.	 * @since  11.3	 */	protected static $instance;	/**	 * Constructor	 *	 * @since   11.1	 */	public function __construct()	{		$isLoaded = JPluginHelper::importPlugin('authentication');		if (!$isLoaded)		{			JLog::add(JText::_('JLIB_USER_ERROR_AUTHENTICATION_LIBRARIES'), JLog::WARNING, 'jerror');		}	}	/**	 * Returns the global authentication object, only creating it	 * if it doesn't already exist.	 *	 * @return  JAuthentication  The global JAuthentication object	 *	 * @since   11.1	 */	public static function getInstance()	{		if (empty(self::$instance))		{			self::$instance = new JAuthentication;		}		return self::$instance;	}	/**	 * Get the state of the JAuthentication object	 *	 * @return  mixed    The state of the object.	 *	 * @since   11.1	 */	public function getState()	{		return $this->state;	}	/**	 * Attach an observer object	 *	 * @param   object  $observer  An observer object to attach	 *	 * @return  void	 *	 * @since   11.1	 */	public function attach($observer)	{		if (is_array($observer))		{			if (!isset($observer['handler']) || !isset($observer['event']) || !is_callable($observer['handler']))			{				return;			}			// Make sure we haven't already attached this array as an observer			foreach ($this->observers as $check)			{				if (is_array($check) && $check['event'] == $observer['event'] && $check['handler'] == $observer['handler'])				{					return;				}			}			$this->observers[] = $observer;			end($this->observers);			$methods = array($observer['event']);		}		else		{			if (!($observer instanceof JAuthentication))			{				return;			}			// Make sure we haven't already attached this object as an observer			$class = get_class($observer);			foreach ($this->observers as $check)			{				if ($check instanceof $class)				{					return;				}			}			$this->observers[] = $observer;			$methods = array_diff(get_class_methods($observer), get_class_methods('JPlugin'));		}		$key = key($this->observers);		foreach ($methods as $method)		{			$method = strtolower($method);			if (!isset($this->methods[$method]))			{				$this->methods[$method] = array();			}			$this->methods[$method][] = $key;		}	}	/**	 * Detach an observer object	 *	 * @param   object  $observer  An observer object to detach.	 *	 * @return  boolean  True if the observer object was detached.	 *	 * @since   11.1	 */	public function detach($observer)	{		$retval = false;		$key = array_search($observer, $this->observers);		if ($key !== false)		{			unset($this->observers[$key]);			$retval = true;			foreach ($this->methods as &$method)			{				$k = array_search($key, $method);				if ($k !== false)				{					unset($method[$k]);				}			}		}		return $retval;	}	/**	 * Finds out if a set of login credentials are valid by asking all observing	 * objects to run their respective authentication routines.	 *	 * @param   array  $credentials  Array holding the user credentials.	 * @param   array  $options      Array holding user options.	 *	 * @return  JAuthenticationResponse  Response object with status variable filled in for last plugin or first successful plugin.	 *	 * @see     JAuthenticationResponse	 * @since   11.1	 */	public function authenticate($credentials, $options = array())	{		// Get plugins		$plugins = JPluginHelper::getPlugin('authentication');		// Create authentication response		$response = new JAuthenticationResponse;		/*		 * Loop through the plugins and check of the credentials can be used to authenticate		 * the user		 *		 * Any errors raised in the plugin should be returned via the JAuthenticationResponse		 * and handled appropriately.		 */		foreach ($plugins as $plugin)		{			$className = 'plg' . $plugin->type . $plugin->name;			if (class_exists($className))			{				$plugin = new $className($this, (array) $plugin);			}			else			{				// Bail here if the plugin can't be created				JLog::add(JText::sprintf('JLIB_USER_ERROR_AUTHENTICATION_FAILED_LOAD_PLUGIN', $className), JLog::WARNING, 'jerror');				continue;			}			// Try to authenticate			$plugin->onUserAuthenticate($credentials, $options, $response);			// If authentication is successful break out of the loop			if ($response->status === self::STATUS_SUCCESS)			{				if (empty($response->type))				{					$response->type = isset($plugin->_name) ? $plugin->_name : $plugin->name;				}				break;			}		}		if (empty($response->username))		{			$response->username = $credentials['username'];		}		if (empty($response->fullname))		{			$response->fullname = $credentials['username'];		}		if (empty($response->password))		{			$response->password = $credentials['password'];		}		return $response;	}	/**	 * Authorises that a particular user should be able to login	 *	 * @param   JAuthenticationResponse  $response  response including username of the user to authorise	 * @param   array                    $options   list of options	 *	 * @return  array[JAuthenticationResponse]  results of authorisation	 *	 * @since  11.2	 */	public static function authorise($response, $options = array())	{		// Get plugins in case they haven't been imported already		JPluginHelper::importPlugin('user');		JPluginHelper::importPlugin('authentication');		$dispatcher = JEventDispatcher::getInstance();		$results = $dispatcher->trigger('onUserAuthorisation', array($response, $options));		return $results;	}}/** * Authentication response class, provides an object for storing user and error details * * @package     Joomla.Platform * @subpackage  User * @since       11.1 */class JAuthenticationResponse{	/**	 * Response status (see status codes)	 *	 * @var    string	 * @since  11.1	 */	public $status = JAuthentication::STATUS_FAILURE;	/**	 * The type of authentication that was successful	 *	 * @var    string	 * @since  11.1	 */	public $type = '';	/**	 *  The error message	 *	 * @var    string	 * @since  11.1	 */	public $error_message = '';	/**	 * Any UTF-8 string that the End User wants to use as a username.	 *	 * @var    string	 * @since  11.1	 */	public $username = '';	/**	 * Any UTF-8 string that the End User wants to use as a password.	 *	 * @var    string	 * @since  11.1	 */	public $password = '';	/**	 * The email address of the End User as specified in section 3.4.1 of [RFC2822]	 *	 * @var    string	 * @since  11.1	 */	public $email = '';	/**	 * UTF-8 string free text representation of the End User's full name.	 *	 * @var    string	 * @since  11.1	 *	 */	public $fullname = '';	/**	 * The End User's date of birth as YYYY-MM-DD. Any values whose representation uses	 * fewer than the specified number of digits should be zero-padded. The length of this	 * value MUST always be 10. If the End User user does not want to reveal any particular	 * component of this value, it MUST be set to zero.	 *	 * For instance, if a End User wants to specify that his date of birth is in 1980, but	 * not the month or day, the value returned SHALL be "1980-00-00".	 *	 * @var    string	 * @since  11.1	 */	public $birthdate = '';	/**	 * The End User's gender, "M" for male, "F" for female.	 *	 * @var    string	 * @since  11.1	 */	public $gender = '';	/**	 * UTF-8 string free text that SHOULD conform to the End User's country's postal system.	 *	 * @var    string	 * @since  11.1	 */	public $postcode = '';	/**	 * The End User's country of residence as specified by ISO3166.	 *	 * @var    string	 * @since  11.1	 */	public $country = '';	/**	 * End User's preferred language as specified by ISO639.	 *	 * @var    string	 * @since  11.1	 */	public $language = '';	/**	 * ASCII string from TimeZone database	 *	 * @var    string	 * @since  11.1	 */	public $timezone = '';}
<?php/** * @package     Joomla.Site * @subpackage  mod_feed * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Helper for mod_feed * * @package     Joomla.Site * @subpackage  mod_feed * @since       1.5 */class ModFeedHelper{	public static function getFeed($params)	{		// module params		$rssurl	= $params->get('rssurl', '');		// get RSS parsed object		$cache_time = 0;		if ($params->get('cache'))		{			$cache_time  = $params->get('cache_time', 15) * 60;		}		try		{			$feed = new JFeedFactory;			$rssDoc = $feed->getFeed($rssurl);		}		catch (InvalidArgumentException $e)		{			$msg = JText::_('MOD_NEWSFEEDS_ERRORS_FEED_NOT_RETRIEVED');		}		catch (RunTimeException $e)		{			$msg = JText::_('MOD_FEED_ERR_FEED_NOT_RETRIEVED');		}		if (empty($rssDoc))		{			$msg = JText::_('MOD_FEED_ERR_FEED_NOT_RETRIEVED');			return $msg;		}		if ($rssDoc)		{			return $rssDoc;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_messages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.modal');/** * View class for a list of messages. * * @package     Joomla.Administrator * @subpackage  com_messages * @since       1.6 */class MessagesViewMessages extends JViewLegacy{	protected $items;	protected $pagination;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$this->items		= $this->get('Items');		$this->pagination	= $this->get('Pagination');		$this->state		= $this->get('State');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		$this->addToolbar();		$this->sidebar = JHtmlSidebar::render();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		$state	= $this->get('State');		$canDo	= MessagesHelper::getActions();		JToolbarHelper::title(JText::_('COM_MESSAGES_MANAGER_MESSAGES'), 'inbox.png');		if ($canDo->get('core.create'))		{			JToolbarHelper::addNew('message.add');		}		if ($canDo->get('core.edit.state'))		{			JToolbarHelper::divider();			JToolbarHelper::publish('messages.publish', 'COM_MESSAGES_TOOLBAR_MARK_AS_READ');			JToolbarHelper::unpublish('messages.unpublish', 'COM_MESSAGES_TOOLBAR_MARK_AS_UNREAD');		}		if ($state->get('filter.state') == -2 && $canDo->get('core.delete'))		{			JToolbarHelper::divider();			JToolbarHelper::deleteList('', 'messages.delete', 'JTOOLBAR_EMPTY_TRASH');		} elseif ($canDo->get('core.edit.state'))		{			JToolbarHelper::divider();			JToolbarHelper::trash('messages.trash');		}		//JToolbarHelper::addNew('module.add');		JToolbarHelper::divider();		$bar = JToolBar::getInstance('toolbar');		JHtml::_('bootstrap.modal', 'collapseModal');		$title = JText::_('COM_MESSAGES_TOOLBAR_MY_SETTINGS');		$dhtml = "<a class=\"btn modal btn-small\" href=\"index.php?option=com_messages&amp;view=config&amp;tmpl=component\"					rel=\"{handler:'iframe', size:{x:700,y:300}}\">					<i class=\"icon-cog\" title=\"$title\"></i>$title</a>";		$bar->appendButton('Custom', $dhtml, 'config');		if ($canDo->get('core.admin'))		{			JToolbarHelper::preferences('com_messages');		}		JToolbarHelper::divider();		JToolbarHelper::help('JHELP_COMPONENTS_MESSAGING_INBOX');	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');$function  = JFactory::getApplication()->input->getCmd('function', 'jSelectPosition');$lang      = JFactory::getLanguage();$ordering  = $this->escape($this->state->get('list.ordering'));$direction = $this->escape($this->state->get('list.direction'));$clientId  = $this->state->get('filter.client_id');$state     = $this->state->get('filter.state');$template  = $this->state->get('filter.template');$type      = $this->state->get('filter.type');?><form action="<?php echo JRoute::_('index.php?option=com_modules&view=positions&layout=modal&tmpl=component&function='.$function.'&client_id=' .$clientId);?>" method="post" name="adminForm" id="adminForm">	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-search">			<label for="filter_search">				<?php echo JText::_('JSearch_Filter_Label'); ?>			</label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" size="30" title="<?php echo JText::_('COM_MODULES_FILTER_SEARCH_DESC'); ?>" />			<button type="submit">				<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();">				<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_state">				<?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?>			</label>			<select name="filter_state" class="inputbox" id="filter_state">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', JHtml::_('modules.templateStates'), 'value', 'text', $state, true);?>			</select>			<label class="selectlabel" for="filter_type">				<?php echo JText::_('COM_MODULES_OPTION_SELECT_TYPE'); ?>			</label>			<select name="filter_type" class="inputbox" id="filter_type">				<option value=""><?php echo JText::_('COM_MODULES_OPTION_SELECT_TYPE');?></option>				<?php echo JHtml::_('select.options', JHtml::_('modules.types'), 'value', 'text', $type, true);?>			</select>			<label class="selectlabel" for="filter_template">				<?php echo JText::_('JOPTION_SELECT_TEMPLATE'); ?>			</label>			<select name="filter_template" class="inputbox" id="filter_template">				<option value=""><?php echo JText::_('JOPTION_SELECT_TEMPLATE');?></option>				<?php echo JHtml::_('select.options', JHtml::_('modules.templates', $clientId), 'value', 'text', $template, true);?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<table class="adminlist">		<thead>			<tr>				<th class="title width-20">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'value', $direction, $ordering); ?>				</th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_MODULES_HEADING_TEMPLATES', 'templates', $direction, $ordering); ?>				</th>			</tr>		</thead>		<tbody>		<?php $i = 1; foreach ($this->items as $value => $templates) : ?>			<tr class="row<?php echo $i = 1 - $i;?>">				<td>					<a class="pointer" onclick="if (window.parent) window.parent.<?php echo $function;?>('<?php echo $value; ?>');"><?php echo $this->escape($value); ?></a>				</td>				<td>					<?php if (!empty($templates)):?>					<a class="pointer" onclick="if (window.parent) window.parent.<?php echo $function;?>('<?php echo $value; ?>');">						<ul>						<?php foreach ($templates as $template => $label):?>							<li><?php echo $lang->hasKey($label) ? JText::sprintf('COM_MODULES_MODULE_TEMPLATE_POSITION', JText::_($template), JText::_($label)) : JText::_($template);?></li>						<?php endforeach;?>						</ul>					</a>					<?php endif;?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $ordering; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $direction; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Content categories view. * * @package     Joomla.Site * @subpackage  com_contact * @since       1.6 */class ContactViewCategories extends JViewLegacy{	protected $state = null;	protected $item = null;	protected $items = null;	protected $pagination = null;	/**	 * Display the view	 *	 * @return  mixed  False on error, null otherwise.	 */	public function display($tpl = null)	{		$state		= $this->get('State');		$items		= $this->get('Items');		$parent		= $this->get('Parent');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseWarning(500, implode("\n", $errors));			return false;		}		if ($items === false)		{			return JError::raiseError(404, JText::_('JGLOBAL_CATEGORY_NOT_FOUND'));		}		if ($parent == false)		{			return JError::raiseError(404, JText::_('JGLOBAL_CATEGORY_NOT_FOUND'));		}		$params = &$state->params;		$items = array($parent->id => $items);		//Escape strings for HTML output		$this->pageclass_sfx = htmlspecialchars($params->get('pageclass_sfx'));		$this->maxLevelcat = $params->get('maxLevelcat', -1);		$this->params = &$params;		$this->parent = &$parent;		$this->items = &$items;		$this->_prepareDocument();		parent::display($tpl);	}	/**	 * Prepares the document	 */	protected function _prepareDocument()	{		$app	= JFactory::getApplication();		$menus	= $app->getMenu();		$title	= null;		// Because the application sets a default page title,		// we need to get it from the menu item itself		$menu = $menus->getActive();		if ($menu)		{			$this->params->def('page_heading', $this->params->def('page_title', $menu->title));		}		else		{			$this->params->def('page_heading', JText::_('COM_CONTACT_DEFAULT_PAGE_TITLE'));		}		$title = $this->params->get('page_title', '');		if (empty($title))		{			$title = $app->getCfg('sitename');		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		if ($this->params->get('menu-meta_description'))		{			$this->document->setDescription($this->params->get('menu-meta_description'));		}		if ($this->params->get('menu-meta_keywords'))		{			$this->document->setMetadata('keywords', $this->params->get('menu-meta_keywords'));		}		if ($this->params->get('robots'))		{			$this->document->setMetadata('robots', $this->params->get('robots'));		}	}}
<?php/** * @package     Joomla.Site * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Remind model class for Users. * * @package     Joomla.Site * @subpackage  com_users * @since       1.5 */class UsersModelRemind extends JModelForm{	/**	 * Method to get the username remind request form.	 *	 * @param   array      $data        An optional array of data for the form to interogate.	 * @param   boolean    $loadData    True if the form is to load its own data (default case), false if not.	 * @return  JForm    A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_users.remind', 'remind', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Override preprocessForm to load the user plugin group instead of content.	 *	 * @param   object    A form object.	 * @param   mixed     The data expected for the form.	 * @throws    Exception if there is an error in the form event.	 * @since   1.6	 */	protected function preprocessForm(JForm $form, $data, $group = 'user')	{		parent::preprocessForm($form, $data, 'user');	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState()	{		// Get the application object.		$app = JFactory::getApplication();		$params = $app->getParams('com_users');		// Load the parameters.		$this->setState('params', $params);	}	/**	 * @since   1.6	 */	public function processRemindRequest($data)	{		// Get the form.		$form = $this->getForm();		// Check for an error.		if (empty($form))		{			return false;		}		// Validate the data.		$data = $this->validate($form, $data);		// Check for an error.		if ($data instanceof Exception)		{			return $return;		}		// Check the validation results.		if ($data === false)		{			// Get the validation messages from the form.			foreach ($form->getErrors() as $formError)			{				$this->setError($formError->getMessage());			}			return false;		}		// Find the user id for the given email address.		$db = $this->getDbo();		$query = $db->getQuery(true)			->select('*')			->from($db->quoteName('#__users'))			->where($db->quoteName('email') . ' = ' . $db->quote($data['email']));		// Get the user id.		$db->setQuery($query);		try		{			$user = $db->loadObject();		}		catch (RuntimeException $e)		{			$this->setError(JText::sprintf('COM_USERS_DATABASE_ERROR', $e->getMessage()), 500);			return false;		}		// Check for a user.		if (empty($user))		{			$this->setError(JText::_('COM_USERS_USER_NOT_FOUND'));			return false;		}		// Make sure the user isn't blocked.		if ($user->block)		{			$this->setError(JText::_('COM_USERS_USER_BLOCKED'));			return false;		}		$config = JFactory::getConfig();		// Assemble the login link.		$itemid = UsersHelperRoute::getLoginRoute();		$itemid = $itemid !== null ? '&Itemid=' . $itemid : '';		$link = 'index.php?option=com_users&view=login' . $itemid;		$mode = $config->get('force_ssl', 0) == 2 ? 1 : -1;		// Put together the email template data.		$data = JArrayHelper::fromObject($user);		$data['fromname'] = $config->get('fromname');		$data['mailfrom'] = $config->get('mailfrom');		$data['sitename'] = $config->get('sitename');		$data['link_text'] = JRoute::_($link, false, $mode);		$data['link_html'] = JRoute::_($link, true, $mode);		$subject = JText::sprintf(			'COM_USERS_EMAIL_USERNAME_REMINDER_SUBJECT',			$data['sitename']		);		$body = JText::sprintf(			'COM_USERS_EMAIL_USERNAME_REMINDER_BODY',			$data['sitename'],			$data['username'],			$data['link_text']		);		// Send the password reset request email.		$return = JFactory::getMailer()->sendMail($data['mailfrom'], $data['fromname'], $user->email, $subject, $body);		// Check for an error.		if ($return !== true)		{			$this->setError(JText::_('COM_USERS_MAIL_FAILED'), 500);			return false;		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_media * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$user = JFactory::getUser();$params = new JRegistry;$dispatcher	= JEventDispatcher::getInstance();$dispatcher->trigger('onContentBeforeDisplay', array('com_media.file', &$this->_tmp_img, &$params));?>		<li class="imgOutline thumbnail height-80 width-80 center">			<?php if ($user->authorise('core.delete', 'com_media')):?>				<a class="close delete-item" target="_top" href="index.php?option=com_media&amp;task=file.delete&amp;tmpl=index&amp;<?php echo JSession::getFormToken(); ?>=1&amp;folder=<?php echo $this->state->folder; ?>&amp;rm[]=<?php echo $this->_tmp_img->name; ?>" rel="<?php echo $this->_tmp_img->name; ?>" title="<?php echo JText::_('JACTION_DELETE');?>">x</a>				<input class="pull-left" type="checkbox" name="rm[]" value="<?php echo $this->_tmp_img->name; ?>" />				<div class="clearfix"></div>			<?php endif;?>			<div class="height-50">				<a class="img-preview" href="<?php echo COM_MEDIA_BASEURL.'/'.$this->_tmp_img->path_relative; ?>" title="<?php echo $this->_tmp_img->name; ?>" >					<?php echo JHtml::_('image', COM_MEDIA_BASEURL.'/'.$this->_tmp_img->path_relative, JText::sprintf('COM_MEDIA_IMAGE_TITLE', $this->_tmp_img->title, JHtml::_('number.bytes', $this->_tmp_img->size)), array('width' => $this->_tmp_img->width_60, 'height' => $this->_tmp_img->height_60)); ?>				</a>			</div>			<div class="small">				<a href="<?php echo COM_MEDIA_BASEURL.'/'.$this->_tmp_img->path_relative; ?>" title="<?php echo $this->_tmp_img->name; ?>" class="preview"><?php echo JHtml::_('string.truncate', $this->_tmp_img->name, 10, false); ?></a>			</div>		</li><?php$dispatcher->trigger('onContentAfterDisplay', array('com_media.file', &$this->_tmp_img, &$params));?>
<?php/** * @package     Joomla.Site * @subpackage  Templates.beez3 * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$app = JFactory::getApplication();JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.framework');$n = count($this->items);$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><?php if (empty($this->items)) : ?>	<?php if ($this->params->get('show_no_articles', 1)) : ?>		<p><?php echo JText::_('COM_CONTENT_NO_ARTICLES'); ?></p>	<?php endif; ?><?php else : ?><form action="<?php echo htmlspecialchars(JUri::getInstance()->toString()); ?>" method="post" name="adminForm" id="adminForm">	<?php if ($this->params->get('filter_field') != 'hide') : ?>	<fieldset class="filters">		<legend class="hidelabeltxt">			<?php echo JText::_('JGLOBAL_FILTER_LABEL'); ?>		</legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter-search"><?php echo JText::_('COM_CONTENT_'.$this->params->get('filter_field').'_FILTER_LABEL').'&#160;'; ?></label>			<input type="text" name="filter-search" id="filter-search" value="<?php echo $this->escape($this->state->get('list.filter')); ?>" class="inputbox" onchange="document.adminForm.submit();" title="<?php echo JText::_('COM_CONTENT_FILTER_SEARCH_DESC'); ?>" />		</div>	<?php endif; ?>	<?php if ($this->params->get('show_pagination_limit')) : ?>		<div class="display-limit">			<?php echo JText::_('JGLOBAL_DISPLAY_NUM'); ?>&#160;			<?php echo $this->pagination->getLimitBox(); ?>		</div>	<?php endif; ?>	<?php if ($this->params->get('filter_field') != 'hide') :?>	</fieldset>	<?php endif; ?>	<div class="clr"></div>	<table class="category">		<?php if ($this->params->get('show_headings')) :?>		<thead>			<tr>				<th class="list-title" id="tableOrdering">					<?php echo JHtml::_('grid.sort', 'COM_CONTENT_HEADING_TITLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<?php if ($date = $this->params->get('list_show_date')) : ?>				<th class="list-date" id="tableOrdering2">					<?php if ($date == "created") : ?>						<?php echo JHtml::_('grid.sort', 'COM_CONTENT_'.$date.'_DATE', 'a.created', $listDirn, $listOrder); ?>					<?php elseif ($date == "modified") : ?>						<?php echo JHtml::_('grid.sort', 'COM_CONTENT_'.$date.'_DATE', 'a.modified', $listDirn, $listOrder); ?>					<?php elseif ($date == "published") : ?>						<?php echo JHtml::_('grid.sort', 'COM_CONTENT_'.$date.'_DATE', 'a.publish_up', $listDirn, $listOrder); ?>					<?php endif; ?>				</th>				<?php endif; ?>				<?php if ($this->params->get('list_show_author', 1)) : ?>				<th class="list-author" id="tableOrdering3">					<?php echo JHtml::_('grid.sort', 'JAUTHOR', 'author', $listDirn, $listOrder); ?>				</th>				<?php endif; ?>				<?php if ($this->params->get('list_show_hits', 1)) : ?>				<th class="list-hits" id="tableOrdering4">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_HITS', 'a.hits', $listDirn, $listOrder); ?>				</th>				<?php endif; ?>			</tr>		</thead>		<?php endif; ?>		<tbody>			<?php foreach ($this->items as $i => &$article) : ?>			<tr class="cat-list-row<?php echo $i % 2; ?>">				<?php if (in_array($article->access, $this->user->getAuthorisedViewLevels())) : ?>					<td class="list-title">						<a href="<?php echo JRoute::_(ContentHelperRoute::getArticleRoute($article->slug, $article->catid)); ?>">							<?php echo $this->escape($article->title); ?></a>					</td>					<?php if ($this->params->get('list_show_date')) : ?>					<td class="list-date">						<?php						echo JHtml::_(							'date', $article->displayDate, $this->escape(								$this->params->get('date_format', JText::_('DATE_FORMAT_LC3'))							)						); ?>					</td>					<?php endif; ?>					<?php if ($this->params->get('list_show_author', 1)) : ?>					<td class="list-author">						<?php if (!empty($article->author) || !empty($article->created_by_alias)) : ?>							<?php $author = $article->author ?>							<?php $author = ($article->created_by_alias ? $article->created_by_alias : $author);?>							<?php if (!empty($article->contactid ) &&  $this->params->get('link_author') == true):?>								<?php echo JHtml::_(										'link',										JRoute::_('index.php?option=com_contact&view=contact&id='.$article->contactid),										$author								); ?>							<?php else :?>								<?php echo JText::sprintf('COM_CONTENT_WRITTEN_BY', $author); ?>							<?php endif; ?>						<?php endif; ?>					</td>					<?php endif; ?>					<?php if ($this->params->get('list_show_hits', 1)) : ?>					<td class="list-hits">						<?php echo $article->hits; ?>					</td>					<?php endif; ?>				<?php else : ?>				<td>					<?php						echo $this->escape($article->title).' : ';						$menu		= JFactory::getApplication()->getMenu();						$active		= $menu->getActive();						$itemId		= $active->id;						$link = JRoute::_('index.php?option=com_users&view=login&Itemid='.$itemId);						$returnURL = JRoute::_(ContentHelperRoute::getArticleRoute($article->slug));						$fullURL = new JURI($link);						$fullURL->setVar('return', base64_encode($returnURL));					?>					<a href="<?php echo $fullURL; ?>" class="register">					<?php echo JText::_('COM_CONTENT_REGISTER_TO_READ_MORE'); ?></a>				</td>				<?php endif; ?>			</tr>			<?php endforeach; ?>		</tbody>	</table><?php endif; ?><?php // Code to add a link to submit an article. ?><?php if ($this->category->getParams()->get('access-create')) : ?>	<?php echo JHtml::_('icon.create', $this->category, $this->category->params, array(), true); ?><?php  endif; ?><?php // Add pagination links ?><?php if (!empty($this->items)) : ?>	<?php if (($this->params->def('show_pagination', 2) == 1  || ($this->params->get('show_pagination') == 2)) && ($this->pagination->pagesTotal > 1)) : ?>	<div class="pagination">		<?php if ($this->params->def('show_pagination_results', 1)) : ?>		 	<p class="counter">				<?php echo $this->pagination->getPagesCounter(); ?>			</p>		<?php  endif; ?>		<?php echo $this->pagination->getPagesLinks(); ?>	</div>	<?php endif; ?>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="filter_order" value="" />		<input type="hidden" name="filter_order_Dir" value="" />		<input type="hidden" name="limitstart" value="" />	</div></form><?php endif; ?>
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * The HTML Menus Menu Items View. * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class MenusViewItems extends JViewLegacy{	protected $f_levels;	protected $items;	protected $pagination;	protected $state;	/**	 * Display the view	 */	public function display($tpl = null)	{		$lang 		= JFactory::getLanguage();		$this->items		= $this->get('Items');		$this->pagination	= $this->get('Pagination');		$this->state		= $this->get('State');		MenusHelper::addSubmenu('items');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode("\n", $errors));			return false;		}		$this->ordering = array();		// Preprocess the list of items to find ordering divisions.		foreach ($this->items as $item)		{			$this->ordering[$item->parent_id][] = $item->id;			// item type text			switch ($item->type)			{				case 'url':					$value = JText::_('COM_MENUS_TYPE_EXTERNAL_URL');					break;				case 'alias':					$value = JText::_('COM_MENUS_TYPE_ALIAS');					break;				case 'separator':					$value = JText::_('COM_MENUS_TYPE_SEPARATOR');					break;				case 'heading':					$value = JText::_('COM_MENUS_TYPE_HEADING');					break;				case 'component':				default:					// load language						$lang->load($item->componentname.'.sys', JPATH_ADMINISTRATOR, null, false, false)					||	$lang->load($item->componentname.'.sys', JPATH_ADMINISTRATOR.'/components/'.$item->componentname, null, false, false)					||	$lang->load($item->componentname.'.sys', JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)					||	$lang->load($item->componentname.'.sys', JPATH_ADMINISTRATOR.'/components/'.$item->componentname, $lang->getDefault(), false, false);					if (!empty($item->componentname))					{						$value	= JText::_($item->componentname);						$vars	= null;						parse_str($item->link, $vars);						if (isset($vars['view']))						{							// Attempt to load the view xml file.							$file = JPATH_SITE.'/components/'.$item->componentname.'/views/'.$vars['view'].'/metadata.xml';							if (is_file($file) && $xml = simplexml_load_file($file))							{								// Look for the first view node off of the root node.								if ($view = $xml->xpath('view[1]'))								{									if (!empty($view[0]['title']))									{										$vars['layout'] = isset($vars['layout']) ? $vars['layout'] : 'default';										// Attempt to load the layout xml file.										// If Alternative Menu Item, get template folder for layout file										if (strpos($vars['layout'], ':') > 0)										{											// Use template folder for layout file											$temp = explode(':', $vars['layout']);											$file = JPATH_SITE.'/templates/'.$temp[0].'/html/'.$item->componentname.'/'.$vars['view'].'/'.$temp[1].'.xml';											// Load template language file											$lang->load('tpl_'.$temp[0].'.sys', JPATH_SITE, null, false, false)											||	$lang->load('tpl_'.$temp[0].'.sys', JPATH_SITE.'/templates/'.$temp[0], null, false, false)											||	$lang->load('tpl_'.$temp[0].'.sys', JPATH_SITE, $lang->getDefault(), false, false)											||	$lang->load('tpl_'.$temp[0].'.sys', JPATH_SITE.'/templates/'.$temp[0], $lang->getDefault(), false, false);										}										else										{											// Get XML file from component folder for standard layouts											$file = JPATH_SITE.'/components/'.$item->componentname.'/views/'.$vars['view'].'/tmpl/'.$vars['layout'].'.xml';										}										if (is_file($file) && $xml = simplexml_load_file($file))										{											// Look for the first view node off of the root node.											if ($layout = $xml->xpath('layout[1]'))											{												if (!empty($layout[0]['title']))												{													$value .= '  ' . JText::_(trim((string) $layout[0]['title']));												}											}											if (!empty($layout[0]->message[0]))											{												$item->item_type_desc = JText::_(trim((string) $layout[0]->message[0]));											}										}									}								}								unset($xml);							}							else							{								// Special case for absent views								$value .= '  ' . $vars['view'];							}						}					}					else					{						if (preg_match("/^index.php\?option=([a-zA-Z\-0-9_]*)/", $item->link, $result))						{							$value = JText::sprintf('COM_MENUS_TYPE_UNEXISTING', $result[1]);						}						else {							$value = JText::_('COM_MENUS_TYPE_UNKNOWN');						}					}					break;			}			$item->item_type = $value;		}		// Levels filter.		$options	= array();		$options[]	= JHtml::_('select.option', '1', JText::_('J1'));		$options[]	= JHtml::_('select.option', '2', JText::_('J2'));		$options[]	= JHtml::_('select.option', '3', JText::_('J3'));		$options[]	= JHtml::_('select.option', '4', JText::_('J4'));		$options[]	= JHtml::_('select.option', '5', JText::_('J5'));		$options[]	= JHtml::_('select.option', '6', JText::_('J6'));		$options[]	= JHtml::_('select.option', '7', JText::_('J7'));		$options[]	= JHtml::_('select.option', '8', JText::_('J8'));		$options[]	= JHtml::_('select.option', '9', JText::_('J9'));		$options[]	= JHtml::_('select.option', '10', JText::_('J10'));		$this->f_levels = $options;		$this->addToolbar();		$this->sidebar = JHtmlSidebar::render();		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @since   1.6	 */	protected function addToolbar()	{		require_once JPATH_COMPONENT.'/helpers/menus.php';		$canDo	= MenusHelper::getActions($this->state->get('filter.parent_id'));		// Get the toolbar object instance		$bar = JToolBar::getInstance('toolbar');		JToolbarHelper::title(JText::_('COM_MENUS_VIEW_ITEMS_TITLE'), 'menumgr.png');		if ($canDo->get('core.create'))		{			JToolbarHelper::addNew('item.add');		}		if ($canDo->get('core.edit'))		{			JToolbarHelper::editList('item.edit');		}		if ($canDo->get('core.edit.state'))		{			JToolbarHelper::publish('items.publish', 'JTOOLBAR_PUBLISH', true);			JToolbarHelper::unpublish('items.unpublish', 'JTOOLBAR_UNPUBLISH', true);		}		if (JFactory::getUser()->authorise('core.admin'))		{			JToolbarHelper::checkin('items.checkin', 'JTOOLBAR_CHECKIN', true);		}		if ($this->state->get('filter.published') == -2 && $canDo->get('core.delete'))		{			JToolbarHelper::deleteList('', 'items.delete', 'JTOOLBAR_EMPTY_TRASH');		}		elseif ($canDo->get('core.edit.state'))		{			JToolbarHelper::trash('items.trash');		}		if ($canDo->get('core.edit.state'))		{			JToolbarHelper::makeDefault('items.setDefault', 'COM_MENUS_TOOLBAR_SET_HOME');		}		if (JFactory::getUser()->authorise('core.admin'))		{			JToolbarHelper::custom('items.rebuild', 'refresh.png', 'refresh_f2.png', 'JToolbar_Rebuild', false);		}		// Add a batch button		if ($canDo->get('core.edit'))		{			JHtml::_('bootstrap.modal', 'collapseModal');			$title = JText::_('JTOOLBAR_BATCH');			$dhtml = "<button data-toggle=\"modal\" data-target=\"#collapseModal\" class=\"btn btn-small\">						<i class=\"icon-checkbox-partial\" title=\"$title\"></i>						$title</button>";			$bar->appendButton('Custom', $dhtml, 'batch');		}		JToolbarHelper::help('JHELP_MENUS_MENU_ITEM_MANAGER');		JHtmlSidebar::setAction('index.php?option=com_menus&view=items');		JHtmlSidebar::addFilter(			// @todo we need a label here			'',			'menutype',			JHtml::_('select.options', JHtml::_('menu.menus'), 'value', 'text', $this->state->get('filter.menutype')),			false		);		JHtmlSidebar::addFilter(			JText::_('COM_MENUS_OPTION_SELECT_LEVEL'),			'filter_level',			JHtml::_('select.options', $this->f_levels, 'value', 'text', $this->state->get('filter.level'))		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_PUBLISHED'),			'filter_published',			JHtml::_('select.options', JHtml::_('jgrid.publishedOptions', array('archived' => false)), 'value', 'text', $this->state->get('filter.published'), true)		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_ACCESS'),			'filter_access',			JHtml::_('select.options', JHtml::_('access.assetgroups'), 'value', 'text', $this->state->get('filter.access'))		);		JHtmlSidebar::addFilter(			JText::_('JOPTION_SELECT_LANGUAGE'),			'filter_language',			JHtml::_('select.options', JHtml::_('contentlanguage.existing', true, true), 'value', 'text', $this->state->get('filter.language'))		);	}	/**	 * Returns an array of fields the table can be sorted by	 *	 * @return  array  Array containing the field name to sort by as the key and display text as value	 *	 * @since   3.0	 */	protected function getSortFields()	{		return array(			'a.lft' => JText::_('JGRID_HEADING_ORDERING'),			'a.published' => JText::_('JSTATUS'),			'a.title' => JText::_('JGLOBAL_TITLE'),			'a.home' => JText::_('COM_MENUS_HEADING_HOME'),			'a.access' => JText::_('JGRID_HEADING_ACCESS'),			'association' => JText::_('COM_MENUS_HEADING_ASSOCIATION'),			'language' => JText::_('JGRID_HEADING_LANGUAGE'),			'a.id' => JText::_('JGRID_HEADING_ID')		);	}}
<?php/** * @package     Joomla.Platform * @subpackage  Table * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Usergroup table class. * * @package     Joomla.Platform * @subpackage  Table * @since       11.1 */class JTableUsergroup extends JTable{	/**	 * Constructor	 *	 * @param   JDatabaseDriver  $db  Database driver object.	 *	 * @since   11.1	 */	public function __construct($db)	{		parent::__construct('#__usergroups', 'id', $db);	}	/**	 * Method to check the current record to save	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	public function check()	{		// Validate the title.		if ((trim($this->title)) == '')		{			$this->setError(JText::_('JLIB_DATABASE_ERROR_USERGROUP_TITLE'));			return false;		}		// Check for a duplicate parent_id, title.		// There is a unique index on the (parent_id, title) field in the table.		$db = $this->_db;		$query = $db->getQuery(true)			->select('COUNT(title)')			->from($this->_tbl)			->where('title = ' . $db->quote(trim($this->title)))			->where('parent_id = ' . (int) $this->parent_id)			->where('id <> ' . (int) $this->id);		$db->setQuery($query);		if ($db->loadResult() > 0)		{			$this->setError(JText::_('JLIB_DATABASE_ERROR_USERGROUP_TITLE_EXISTS'));			return false;		}		return true;	}	/**	 * Method to recursively rebuild the nested set tree.	 *	 * @param   integer  $parent_id  The root of the tree to rebuild.	 * @param   integer  $left       The left id to start with in building the tree.	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	public function rebuild($parent_id = 0, $left = 0)	{		// Get the database object		$db = $this->_db;		// Get all children of this node		$db->setQuery('SELECT id FROM ' . $this->_tbl . ' WHERE parent_id=' . (int) $parent_id . ' ORDER BY parent_id, title');		$children = $db->loadColumn();		// The right value of this node is the left value + 1		$right = $left + 1;		// Execute this function recursively over all children		for ($i = 0, $n = count($children); $i < $n; $i++)		{			// $right is the current right value, which is incremented on recursion return			$right = $this->rebuild($children[$i], $right);			// If there is an update failure, return false to break out of the recursion			if ($right === false)			{				return false;			}		}		// We've got the left value, and now that we've processed		// the children of this node we also know the right value		$db->setQuery('UPDATE ' . $this->_tbl . ' SET lft=' . (int) $left . ', rgt=' . (int) $right . ' WHERE id=' . (int) $parent_id);		// If there is an update failure, return false to break out of the recursion		if (!$db->execute())		{			return false;		}		// Return the right value of this node + 1		return $right + 1;	}	/**	 * Inserts a new row if id is zero or updates an existing row in the database table	 *	 * @param   boolean  $updateNulls  If false, null object variables are not updated	 *	 * @return  boolean  True if successful, false otherwise and an internal error message is set	 *	 * @since   11.1	 */	public function store($updateNulls = false)	{		if ($result = parent::store($updateNulls))		{			// Rebuild the nested set tree.			$this->rebuild();		}		return $result;	}	/**	 * Delete this object and its dependencies	 *	 * @param   integer  $oid  The primary key of the user group to delete.	 *	 * @return  mixed  Boolean or Exception.	 *	 * @since   11.1	 * @throws  RuntimeException on database error.	 * @throws  UnexpectedValueException on data error.	 */	public function delete($oid = null)	{		if ($oid)		{			$this->load($oid);		}		if ($this->id == 0)		{			throw new UnexpectedValueException('Global Category not found');		}		if ($this->parent_id == 0)		{			throw new UnexpectedValueException('Root categories cannot be deleted.');		}		if ($this->lft == 0 || $this->rgt == 0)		{			throw new UnexpectedValueException('Left-Right data inconsistency. Cannot delete usergroup.');		}		$db = $this->_db;		// Select the usergroup ID and its children		$query = $db->getQuery(true)			->select($db->quoteName('c.id'))			->from($db->quoteName($this->_tbl) . 'AS c')			->where($db->quoteName('c.lft') . ' >= ' . (int) $this->lft)			->where($db->quoteName('c.rgt') . ' <= ' . (int) $this->rgt);		$db->setQuery($query);		$ids = $db->loadColumn();		if (empty($ids))		{			throw new UnexpectedValueException('Left-Right data inconsistency. Cannot delete usergroup.');		}		// Delete the category dependencies		// @todo Remove all related threads, posts and subscriptions		// Delete the usergroup and its children		$query->clear()			->delete($db->quoteName($this->_tbl))			->where($db->quoteName('id') . ' IN (' . implode(',', $ids) . ')');		$db->setQuery($query);		$db->execute();		// Delete the usergroup in view levels		$replace = array();		foreach ($ids as $id)		{			$replace[] = ',' . $db->quote("[$id,") . ',' . $db->quote("[") . ')';			$replace[] = ',' . $db->quote(",$id,") . ',' . $db->quote(",") . ')';			$replace[] = ',' . $db->quote(",$id]") . ',' . $db->quote("]") . ')';			$replace[] = ',' . $db->quote("[$id]") . ',' . $db->quote("[]") . ')';		}		// SQLSsrv change. Alternative for regexp		$query->clear()			->select('id, rules')			->from('#__viewlevels');		$db->setQuery($query);		$rules = $db->loadObjectList();		$match_ids = array();		foreach ($rules as $rule)		{			foreach ($ids as $id)			{				if (strstr($rule->rules, '[' . $id) || strstr($rule->rules, ',' . $id) || strstr($rule->rules, $id . ']'))				{					$match_ids[] = $rule->id;				}			}		}		if (!empty($match_ids))		{			$query = $db->getQuery(true)				->set('rules=' . str_repeat('replace(', 4 * count($ids)) . 'rules' . implode('', $replace))				->update('#__viewlevels')				->where('id IN (' . implode(',', $match_ids) . ')');			$db->setQuery($query);			$db->execute();		}		// Delete the user to usergroup mappings for the group(s) from the database.		$query->clear()			->delete($db->quoteName('#__user_usergroup_map'))			->where($db->quoteName('group_id') . ' IN (' . implode(',', $ids) . ')');		$db->setQuery($query);		$db->execute();		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('formbehavior.chosen', 'select');$input     = JFactory::getApplication()->input;$field     = $input->getCmd('field');$function  = 'jSelectUser_'.$field;$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_users&view=users&layout=modal&tmpl=component&groups=' . $input->get('groups', '', 'BASE64') . '&excluded=' . $input->get('excluded', '', 'BASE64'));?>" method="post" name="adminForm" id="adminForm">	<fieldset class="filter">		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<label for="filter_search" class="element-invisible"><?php echo JText::_('JSEARCH_FILTER'); ?></label>				<input type="text" name="filter_search" placeholder="<?php echo JText::_('COM_USERS_SEARCH_IN_NAME'); ?>" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_USERS_SEARCH_IN_NAME'); ?>" />			</div>			<div class="btn-group pull-left hidden-phone">				<button class="btn tip hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button class="btn tip hasTooltip" type="button" onclick="document.id('filter_search').value='';this.form.submit();" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>"><i class="icon-remove"></i></button>				<button class="btn tip hasTooltip" type="button" onclick="if (window.parent) window.parent.<?php echo $this->escape($function);?>('', '<?php echo JText::_('JLIB_FORM_SELECT_USER') ?>');"><?php echo JText::_('JOPTION_NO_USER')?></button>			</div>			<div class="btn-group pull-right hidden-phone">				<label for="filter_group_id" class="element-invisible"><?php echo JText::_('COM_USERS_FILTER_USER_GROUP'); ?></label>				<?php echo JHtml::_('access.usergroup', 'filter_group_id', $this->state->get('filter.group_id'), 'onchange="this.form.submit()"'); ?>			</div>		</div>	</fieldset>	<table class="table table-striped table-condensed">		<thead>			<tr>				<th class="left">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_NAME', 'a.name', $listDirn, $listOrder); ?>				</th>				<th class="nowrap" width="25%">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_USERNAME', 'a.username', $listDirn, $listOrder); ?>				</th>				<th class="nowrap" width="25%">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_GROUPS', 'group_names', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tfoot>			<tr>				<td colspan="15">					<?php echo $this->pagination->getListFooter(); ?>				</td>			</tr>		</tfoot>		<tbody>		<?php			$i = 0;			foreach ($this->items as $item) : ?>			<tr class="row<?php echo $i % 2; ?>">				<td>					<a class="pointer" onclick="if (window.parent) window.parent.<?php echo $this->escape($function);?>('<?php echo $item->id; ?>', '<?php echo $this->escape(addslashes($item->name)); ?>');">						<?php echo $item->name; ?></a>				</td>				<td align="center">					<?php echo $item->username; ?>				</td>				<td align="left">					<?php echo nl2br($item->group_names); ?>				</td>			</tr>		<?php endforeach; ?>		</tbody>	</table>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="field" value="<?php echo $this->escape($field); ?>" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Site * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the Tags component * * @package     Joomla.Site * @subpackage  com_tags * @since       3.1 */class TagsViewTag extends JViewLegacy{	protected $state;	protected $items;	protected $item;	protected $children;	protected $pagination;	protected $params;	public function display($tpl = null)	{		$app		= JFactory::getApplication();		$params		= $app->getParams();		// Get some data from the models		$state		= $this->get('State');		$items		= $this->get('Items');		$item		= $this->get('Item');		$children	= $this->get('Children');		$parent 	= $this->get('Parent');		$pagination	= $this->get('Pagination');		// Change to catch		/*if (count($errors = $this->get('Errors'))) {			JError::raiseError(500, implode("\n", $errors));			return false;		}*/		// Check whether access level allows access.		// TODO: SHould already be computed in $item->params->get('access-view')		$user	= JFactory::getUser();		$groups	= $user->getAuthorisedViewLevels();		foreach ($item as $itemElement)		{			if (!in_array($itemElement->access, $groups))			{				unset($itemElement);			}			// Prepare the data.			if (!empty($itemElement))			{				$temp = new JRegistry;				$temp->loadString($itemElement->params);				$itemElement->params = clone($params);				$itemElement->params->merge($temp);				$itemElement->params = (array) json_decode($itemElement->params);			}		}		$this->state      = &$state;		$this->items      = &$items;		$this->children   = &$children;		$this->parent     = &$parent;		$this->pagination = &$pagination;		$this->user       = &$user;		$this->item       = &$item;		//Escape strings for HTML output		$this->pageclass_sfx = htmlspecialchars($params->get('pageclass_sfx'));		// Merge tag params. If this is single-tag view, menu params override tag params		// Otherwise, article params override menu item params		$this->params	= $this->state->get('params');		$active	= $app->getMenu()->getActive();		$temp	= clone ($this->params);		// Check to see which parameters should take priority		if ($active)		{			$currentLink = $active->link;			// If the current view is the active item and an tag view for one tag, then the menu item params take priority			if (strpos($currentLink, 'view=tag') && (strpos($currentLink, '&id[0]='.(string) $item[0]->id)))			{				// $item->params are the article params, $temp are the menu item params				// Merge so that the menu item params take priority				$this->params->merge($temp);				// Load layout from active query (in case it is an alternative menu item)				if (isset($active->query['layout'])) {					$this->setLayout($active->query['layout']);				}			}			else			{				// Current view is not tags, so the global params take priority since tags is not an item.				// Merge the menu item params with the global params so that the article params take priority				$temp->merge($this->state->params);				$this->params = $temp;				// Check for alternative layouts (since we are not in a single-article menu item)				// Single-article menu item layout takes priority over alt layout for an article				if ($layout = $this->params->get('tags_layout'))				{					$this->setLayout($layout);				}			}		}		else		{			// Merge so that item params take priority			$temp->merge($item[0]->params);			$item[0]->params = $temp;			// Check for alternative layouts (since we are not in a single-tag menu item)			// Single-tag menu item layout takes priority over alt layout for an article			if ($layout = $item[0]->params->get('tag_layout'))			{				$this->setLayout($layout);			}		}		$this->_prepareDocument();		parent::display($tpl);	}	/**	 * Prepares the document	 */	protected function _prepareDocument()	{		$app		= JFactory::getApplication();		$menus		= $app->getMenu();		$pathway	= $app->getPathway();		$title 		= null;		// Because the application sets a default page title,		// we need to get it from the menu item itself		$menu = $menus->getActive();		if ($menu)		{			$this->params->def('page_heading', $this->params->get('page_title', $menu->title));		}		else		{			$this->params->def('page_heading', JText::_('COM_TAGS_DEFAULT_PAGE_TITLE'));		}		$id = (int) @$menu->query['id'];		if ($menu && ($menu->query['option'] != 'com_tags'))		{			$this->params->set('page_subheading', $item->title);		}		// If this is not a single tag menu item, set the page title to the menu item title		if (count($this->item) == 1)		{			$title = $this->item[0]->title;		}		else		{			$title = $this->state->params->get('page_title');		}		if (empty($title))		{			$title = $app->getCfg('sitename');		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		foreach ($this->item as $j => $itemElement)		{			if ($itemElement->metadesc)			{				$this->document->setDescription($itemElement->metadesc);			}			elseif ($itemElement->metadesc && $this->params->get('menu-meta_description'))			{				$this->document->setDescription($this->params->get('menu-meta_description'));			}			if ($itemElement->metakey)			{				$this->document->setMetadata('keywords', $itemElement->metakey);			}			elseif (!$itemElement->metakey && $this->params->get('menu-meta_keywords'))			{				$this->document->setMetadata('keywords', $this->params->get('menu-meta_keywords'));			}			if ($this->params->get('robots'))			{				$this->document->setMetadata('robots', $this->params->get('robots'));			}			if ($app->getCfg('MetaAuthor') == '1')			{				$this->document->setMetaData('author', $itemElement->created_user_id);			}		}		// TODO create tag feed document		// Add alternative feed link		if ($this->params->get('show_feed_link', 1) == 1)		{			$link	= '&format=feed&limitstart=';			$attribs = array('type' => 'application/rss+xml', 'title' => 'RSS 2.0');			$this->document->addHeadLink(JRoute::_($link.'&type=rss'), 'alternate', 'rel', $attribs);			$attribs = array('type' => 'application/atom+xml', 'title' => 'Atom 1.0');			$this->document->addHeadLink(JRoute::_($link.'&type=atom'), 'alternate', 'rel', $attribs);		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_messages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Message Table class * * @package     Joomla.Administrator * @subpackage  com_messages * @since       1.5 */class MessagesTableMessage extends JTable{	/**	 * Constructor	 *	 * @param database A database connector object	 */	public function __construct(& $db)	{		parent::__construct('#__messages', 'message_id', $db);	}	/**	 * Validation and filtering.	 *	 * @return  boolean	 */	public function check()	{		// Check the to and from users.		$user = new JUser($this->user_id_from);		if (empty($user->id))		{			$this->setError(JText::_('COM_MESSAGES_ERROR_INVALID_FROM_USER'));			return false;		}		$user = new JUser($this->user_id_to);		if (empty($user->id))		{			$this->setError(JText::_('COM_MESSAGES_ERROR_INVALID_TO_USER'));			return false;		}		if (empty($this->subject))		{			$this->setError(JText::_('COM_MESSAGES_ERROR_INVALID_SUBJECT'));			return false;		}		if (empty($this->message))		{			$this->setError(JText::_('COM_MESSAGES_ERROR_INVALID_MESSAGE'));			return false;		}		return true;	}	/**	 * Method to set the publishing state for a row or list of rows in the database	 * table.  The method respects checked out rows by other users and will attempt	 * to checkin rows that it can after adjustments are made.	 *	 * @param   mixed	An optional array of primary key values to update.  If not	 *					set the instance property value is used.	 * @param   integer The publishing state. eg. [0 = unpublished, 1 = published]	 * @param   integer The user id of the user performing the operation.	 * @return  boolean  True on success.	 * @since   1.6	 */	public function publish($pks = null, $state = 1, $userId = 0)	{		$k = $this->_tbl_key;		// Sanitize input.		JArrayHelper::toInteger($pks);		$userId = (int) $userId;		$state  = (int) $state;		// If there are no primary keys set check to see if the instance key is set.		if (empty($pks))		{			if ($this->$k)			{				$pks = array($this->$k);			}			// Nothing to set publishing state on, return false.			else {				$this->setError(JText::_('JLIB_DATABASE_ERROR_NO_ROWS_SELECTED'));				return false;			}		}		// Build the WHERE clause for the primary keys.		$where = $k.' IN ('.implode(',', $pks).')';		// Update the publishing state for rows with the given primary keys.		$this->_db->setQuery(			'UPDATE '.$this->_db->quoteName($this->_tbl).			' SET '.$this->_db->quoteName('state').' = '.(int) $state .			' WHERE ('.$where.')'		);		try		{			$this->_db->execute();		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		// If the JTable instance value is in the list of primary keys that were set, set the instance.		if (in_array($this->$k, $pks))		{			$this->state = $state;		}		$this->setError('');		return true;	}}
<?php/** * @package     Joomla.Site * @subpackage  mod_stats * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Helper for mod_stats * * @package     Joomla.Site * @subpackage  mod_stats * @since       1.5 */class ModStatsHelper{	public static function &getList(&$params)	{		$app	= JFactory::getApplication();		$db		= JFactory::getDbo();		$rows	= array();		$query	= $db->getQuery(true);		$serverinfo = $params->get('serverinfo');		$siteinfo	= $params->get('siteinfo');		$counter	= $params->get('counter');		$increase	= $params->get('increase');		$i = 0;		if ($serverinfo)		{			$rows[$i] = new stdClass;			$rows[$i]->title	= JText::_('MOD_STATS_OS');			$rows[$i]->data		= substr(php_uname(), 0, 7);			$i++;			$rows[$i] = new stdClass;			$rows[$i]->title	= JText::_('MOD_STATS_PHP');			$rows[$i]->data	= phpversion();			$i++;			$rows[$i] = new stdClass;			$rows[$i]->title	= JText::_('MOD_STATS_MYSQL');			$rows[$i]->data	= $db->getVersion();			$i++;			$rows[$i] = new stdClass;			$rows[$i]->title	= JTEXT::_('MOD_STATS_TIME');			$rows[$i]->data	= JHtml::_('date', 'now', 'H:i');			$i++;			$rows[$i] = new stdClass;			$rows[$i]->title	= JText::_('MOD_STATS_CACHING');			$rows[$i]->data	= $app->getCfg('caching') ? JText::_('JENABLED'):JText::_('JDISABLED');			$i++;			$rows[$i] = new stdClass;			$rows[$i]->title	= JText::_('MOD_STATS_GZIP');			$rows[$i]->data	= $app->getCfg('gzip') ? JText::_('JENABLED'):JText::_('JDISABLED');			$i++;		}		if ($siteinfo)		{			$query->select('COUNT(id) AS count_users')				->from('#__users');			$db->setQuery($query);			$users = $db->loadResult();			$query->clear()				->select('COUNT(id) AS count_items')				->from('#__content')				->where('state = 1');			$db->setQuery($query);			$items = $db->loadResult();			$query->clear()				->select('COUNT(id) AS count_links ')				->from('#__weblinks')				->where('state = 1');			$db->setQuery($query);			$links = $db->loadResult();			if ($users)			{				$rows[$i] = new stdClass;				$rows[$i]->title	= JText::_('MOD_STATS_USERS');				$rows[$i]->data	= $users;				$i++;			}			if ($items)			{				$rows[$i] = new stdClass;				$rows[$i]->title	= JText::_('MOD_STATS_ARTICLES');				$rows[$i]->data	= $items;				$i++;			}			if ($links)			{				$rows[$i] = new stdClass;				$rows[$i]->title	= JText::_('MOD_STATS_WEBLINKS');				$rows[$i]->data	= $links;				$i++;			}		}		if ($counter)		{			$query->clear()				->select('SUM(hits) AS count_hits')				->from('#__content')				->where('state = 1');			$db->setQuery($query);			$hits = $db->loadResult();			if ($hits)			{				$rows[$i] = new stdClass;				$rows[$i]->title	= JText::_('MOD_STATS_ARTICLES_VIEW_HITS');				$rows[$i]->data	= $hits + $increase;				$i++;			}		}		return $rows;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * The Tags List Controller * * @package     Joomla.Administrator * @subpackage  com_tags * @since       3.1 */class TagsControllerTags extends JControllerAdmin{	/**	 * Proxy for getModel	 *	 * @param   string  $name    The model name. Optional.	 * @param   string  $prefix  The class prefix. Optional.	 *	 * @return  JModelLegacy  The model.	 * @since   3.1	 */	public function getModel($name = 'Tag', $prefix = 'TagsModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}	/**	 * Rebuild the nested set tree.	 *	 * @return  boolean  False on failure or error, true on success.	 *	 * @since   3.1	 */	public function rebuild()	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$extension = $this->input->get('extension');		$this->setRedirect(JRoute::_('index.php?option=com_tags&view=tags', false));		$model = $this->getModel();		if ($model->rebuild()) {			// Rebuild succeeded.			$this->setMessage(JText::_('COM_TAGS_REBUILD_SUCCESS'));			return true;		} else {			// Rebuild failed.			$this->setMessage(JText::_('COM_TAGSS_REBUILD_FAILURE'));			return false;		}	}	/**	 * Method to save the submitted ordering values for records via AJAX.	 *	 * @return  void	 *	 * @since   3.0	 */	public function saveOrderAjax()	{		// Get the input		$input = JFactory::getApplication()->input;		$pks = $input->post->get('cid', array(), 'array');		$order = $input->post->get('order', array(), 'array');		// Sanitize the input		JArrayHelper::toInteger($pks);		JArrayHelper::toInteger($order);		// Get the model		$model = $this->getModel();		// Save the ordering		$return = $model->saveorder($pks, $order);		if ($return)		{			echo "1";		}		// Close the application		JFactory::getApplication()->close();	}}
<?php/** * @package     Joomla.Platform * @subpackage  Updater * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.updater.updateadapter');/** * Extension class for updater * * @package     Joomla.Platform * @subpackage  Updater * @since       11.1 * */class JUpdaterExtension extends JUpdateAdapter{	/**	 * Start element parser callback.	 *	 * @param   object  $parser  The parser object.	 * @param   string  $name    The name of the element.	 * @param   array   $attrs   The attributes of the element.	 *	 * @return  void	 *	 * @since   11.1	 */	protected function _startElement($parser, $name, $attrs = array())	{		array_push($this->stack, $name);		$tag = $this->_getStackLocation();		// Reset the data		if (isset($this->$tag))		{			$this->$tag->_data = "";		}		switch ($name)		{			case 'UPDATE':				$this->current_update = JTable::getInstance('update');				$this->current_update->update_site_id = $this->updateSiteId;				$this->current_update->detailsurl = $this->_url;				$this->current_update->folder = "";				$this->current_update->client_id = 1;				break;			// Don't do anything			case 'UPDATES':				break;			default:				if (in_array($name, $this->updatecols))				{					$name = strtolower($name);					$this->current_update->$name = '';				}				if ($name == 'TARGETPLATFORM')				{					$this->current_update->targetplatform = $attrs;				}				break;		}	}	/**	 * Character Parser Function	 *	 * @param   object  $parser  Parser object.	 * @param   object  $name    The name of the element.	 *	 * @return  void	 *	 * @since   11.1	 */	protected function _endElement($parser, $name)	{		array_pop($this->stack);		// @todo remove code: echo 'Closing: '. $name .'<br />';		switch ($name)		{			case 'UPDATE':				$ver = new JVersion;				// Lower case and remove the exclamation mark				$product = strtolower(JFilterInput::getInstance()->clean($ver->PRODUCT, 'cmd'));				// Check that the product matches and that the version matches (optionally a regexp)				// Check for optional min_dev_level and max_dev_level attributes to further specify targetplatform (e.g., 3.0.1)				if ($product == $this->current_update->targetplatform['NAME']					&& preg_match('/' . $this->currentUpdate->targetplatform->version . '/', $ver->RELEASE)					&& ((!isset($this->currentUpdate->targetplatform->min_dev_level)) || $ver->DEV_LEVEL >= $this->currentUpdate->targetplatform->min_dev_level)					&& ((!isset($this->currentUpdate->targetplatform->max_dev_level)) || $ver->DEV_LEVEL <= $this->currentUpdate->targetplatform->max_dev_level))				{					// Target platform isn't a valid field in the update table so unset it to prevent J! from trying to store it					unset($this->current_update->targetplatform);					if (isset($this->latest))					{						if (version_compare($this->current_update->version, $this->latest->version, '>') == 1)						{							$this->latest = $this->current_update;						}					}					else					{						$this->latest = $this->current_update;					}				}				break;			case 'UPDATES':				// :D				break;		}	}	/**	 * Character Parser Function	 *	 * @param   object  $parser  Parser object.	 * @param   object  $data    The data.	 *	 * @return  void	 *	 * @note    This is public because its called externally.	 * @since   11.1	 */	protected function _characterData($parser, $data)	{		$tag = $this->_getLastTag();		/**		 * @todo remove code		 * if(!isset($this->$tag->_data)) $this->$tag->_data = '';		 * $this->$tag->_data .= $data;		 */		if (in_array($tag, $this->updatecols))		{			$tag = strtolower($tag);			$this->current_update->$tag .= $data;		}	}	/**	 * Finds an update.	 *	 * @param   array  $options  Update options.	 *	 * @return  array  Array containing the array of update sites and array of updates	 *	 * @since   11.1	 */	public function findUpdate($options)	{		$url = $options['location'];		$this->_url = &$url;		$this->updateSiteId = $options['update_site_id'];		if (substr($url, -4) != '.xml')		{			if (substr($url, -1) != '/')			{				$url .= '/';			}			$url .= 'extension.xml';		}		$db = $this->parent->getDBO();		$http = JHttpFactory::getHttp();		$response = $http->get($url);		if (!empty($response->code) && 200 != $response->code)		{			$query = $db->getQuery(true)				->update('#__update_sites')				->set('enabled = 0')				->where('update_site_id = ' . $this->updateSiteId);			$db->setQuery($query);			$db->execute();			JLog::add("Error opening url: " . $url, JLog::WARNING, 'updater');			$app = JFactory::getApplication();			$app->enqueueMessage(JText::sprintf('JLIB_UPDATER_ERROR_EXTENSION_OPEN_URL', $url), 'warning');			return false;		}		$this->xmlParser = xml_parser_create('');		xml_set_object($this->xmlParser, $this);		xml_set_element_handler($this->xmlParser, '_startElement', '_endElement');		xml_set_character_data_handler($this->xmlParser, '_characterData');		if (!xml_parse($this->xmlParser, $response->body))		{			JLog::add("Error parsing url: " . $url, JLog::WARNING, 'updater');			$app = JFactory::getApplication();			$app->enqueueMessage(JText::sprintf('JLIB_UPDATER_ERROR_EXTENSION_PARSE_URL', $url), 'warning');			return false;		}		xml_parser_free($this->xmlParser);		if (isset($this->latest))		{			if (isset($this->latest->client) && strlen($this->latest->client))			{				if (is_numeric($this->latest->client))				{					$byName = false;					// <client> has to be 'administrator' or 'site', numeric values are depreceated. See http://docs.joomla.org/Design_of_JUpdate					JLog::add(						'Using numeric values for <client> in the updater xml is deprecated. Use \'administrator\' or \'site\' instead.',						JLog::WARNING, 'deprecated'					);				}				else				{					$byName = true;				}				$this->latest->client_id = JApplicationHelper::getClientInfo($this->latest->client, $byName)->id;				unset($this->latest->client);			}			$updates = array($this->latest);		}		else		{			$updates = array();		}		return array('update_sites' => array(), 'updates' => $updates);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_plugins * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Methods supporting a list of plugin records. * * @package     Joomla.Administrator * @subpackage  com_plugins * @since       1.6 */class PluginsModelPlugins extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'extension_id', 'a.extension_id',				'name', 'a.name',				'folder', 'a.folder',				'element', 'a.element',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'state', 'a.state',				'enabled', 'a.enabled',				'access', 'a.access', 'access_level',				'ordering', 'a.ordering',				'client_id', 'a.client_id',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $search);		$accessId = $this->getUserStateFromRequest($this->context . '.filter.access', 'filter_access', null, 'int');		$this->setState('filter.access', $accessId);		$state = $this->getUserStateFromRequest($this->context . '.filter.enabled', 'filter_enabled', '', 'string');		$this->setState('filter.enabled', $state);		$folder = $this->getUserStateFromRequest($this->context . '.filter.folder', 'filter_folder', null, 'cmd');		$this->setState('filter.folder', $folder);		$language = $this->getUserStateFromRequest($this->context . '.filter.language', 'filter_language', '');		$this->setState('filter.language', $language);		// Load the parameters.		$params = JComponentHelper::getParams('com_plugins');		$this->setState('params', $params);		// List state information.		parent::populateState('folder', 'asc');	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string    A prefix for the store id.	 *	 * @return  string    A store id.	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.access');		$id .= ':' . $this->getState('filter.state');		$id .= ':' . $this->getState('filter.folder');		$id .= ':' . $this->getState('filter.language');		return parent::getStoreId($id);	}	/**	 * Returns an object list	 *	 * @param   string The query	 * @param   int    Offset	 * @param   int    The number of records	 * @return  array	 */	protected function _getList($query, $limitstart = 0, $limit = 0)	{		$search = $this->getState('filter.search');		$ordering = $this->getState('list.ordering', 'ordering');		if ($ordering == 'name' || (!empty($search) && stripos($search, 'id:') !== 0))		{			$this->_db->setQuery($query);			$result = $this->_db->loadObjectList();			$this->translate($result);			if (!empty($search))			{				foreach ($result as $i => $item)				{					if (!preg_match("/$search/i", $item->name))					{						unset($result[$i]);					}				}			}			$lang = JFactory::getLanguage();			$direction = ($this->getState('list.direction') == 'desc') ? -1 : 1;			JArrayHelper::sortObjects($result, $ordering, $direction, true, $lang->getLocale());			$total = count($result);			$this->cache[$this->getStoreId('getTotal')] = $total;			if ($total < $limitstart)			{				$limitstart = 0;				$this->setState('list.start', 0);			}			return array_slice($result, $limitstart, $limit ? $limit : null);		}		else		{			if ($ordering == 'ordering')			{				$query->order('a.folder ASC');				$ordering = 'a.ordering';			}			$query->order($this->_db->quoteName($ordering) . ' ' . $this->getState('list.direction'));			if ($ordering == 'folder')			{				$query->order('a.ordering ASC');			}			$result = parent::_getList($query, $limitstart, $limit);			$this->translate($result);			return $result;		}	}	/**	 * Translate a list of objects	 *	 * @param   array The array of objects	 * @return  array The array of translated objects	 */	protected function translate(&$items)	{		$lang = JFactory::getLanguage();		foreach ($items as &$item)		{			$source = JPATH_PLUGINS . '/' . $item->folder . '/' . $item->element;			$extension = 'plg_' . $item->folder . '_' . $item->element;			$lang->load($extension . '.sys', JPATH_ADMINISTRATOR, null, false, false)				|| $lang->load($extension . '.sys', $source, null, false, false)				|| $lang->load($extension . '.sys', JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)				|| $lang->load($extension . '.sys', $source, $lang->getDefault(), false, false);			$item->name = JText::_($item->name);		}	}	/**	 * Build an SQL query to load the list data.	 *	 * @return  JDatabaseQuery	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		// Select the required fields from the table.		$query->select(			$this->getState(				'list.select',				'a.extension_id , a.name, a.element, a.folder, a.checked_out, a.checked_out_time,' .					' a.enabled, a.access, a.ordering'			)		)			->from($db->quoteName('#__extensions') . ' AS a')			->where($db->quoteName('type') . ' = ' . $db->quote('plugin'));		// Join over the users for the checked out user.		$query->select('uc.name AS editor')			->join('LEFT', '#__users AS uc ON uc.id=a.checked_out');		// Join over the asset groups.		$query->select('ag.title AS access_level')			->join('LEFT', '#__viewlevels AS ag ON ag.id = a.access');		// Filter by access level.		if ($access = $this->getState('filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		// Filter by published state		$published = $this->getState('filter.enabled');		if (is_numeric($published))		{			$query->where('a.enabled = ' . (int) $published);		}		elseif ($published === '')		{			$query->where('(a.enabled IN (0, 1))');		}		// Filter by state		$query->where('a.state >= 0');		// Filter by folder.		if ($folder = $this->getState('filter.folder'))		{			$query->where('a.folder = ' . $db->quote($folder));		}		// Filter by search in id		$search = $this->getState('filter.search');		if (!empty($search) && stripos($search, 'id:') === 0)		{			$query->where('a.extension_id = ' . (int) substr($search, 3));		}		return $query;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Document * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * DocumentXML class, provides an easy interface to parse and display XML output * * @package     Joomla.Platform * @subpackage  Document * @since       11.1 */class JDocumentXml extends JDocument{	/**	 * Document name	 *	 * @var    string	 * @since  12.1	 */	protected $name = 'joomla';	/**	 * Class constructor	 *	 * @param   array  $options  Associative array of options	 *	 * @since   11.1	 */	public function __construct($options = array())	{		parent::__construct($options);		// Set mime type		$this->_mime = 'application/xml';		// Set document type		$this->_type = 'xml';	}	/**	 * Render the document.	 *	 * @param   boolean  $cache   If true, cache the output	 * @param   array    $params  Associative array of attributes	 *	 * @return  The rendered data	 *	 * @since  11.1	 */	public function render($cache = false, $params = array())	{		parent::render();		JResponse::setHeader('Content-disposition', 'inline; filename="' . $this->getName() . '.xml"', true);		return $this->getBuffer();	}	/**	 * Returns the document name	 *	 * @return  string	 *	 * @since  11.1	 */	public function getName()	{		return $this->name;	}	/**	 * Sets the document name	 *	 * @param   string  $name  Document name	 *	 * @return  JDocumentXml instance of $this to allow chaining	 *	 * @since   11.1	 */	public function setName($name = 'joomla')	{		$this->name = $name;		return $this;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * The Menu Item Controller * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class MenusControllerItems extends JControllerAdmin{	public function __construct($config = array())	{		parent::__construct($config);		$this->registerTask('unsetDefault',	'setDefault');	}	/**	 * Proxy for getModel	 * @since   1.6	 */	public function getModel($name = 'Item', $prefix = 'MenusModel', $config = array())	{		return parent::getModel($name, $prefix, array('ignore_request' => true));	}	/**	 * Rebuild the nested set tree.	 *	 * @return  bool	False on failure or error, true on success.	 * @since   1.6	 */	public function rebuild()	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$this->setRedirect('index.php?option=com_menus&view=items');		$model = $this->getModel();		if ($model->rebuild())		{			// Reorder succeeded.			$this->setMessage(JText::_('COM_MENUS_ITEMS_REBUILD_SUCCESS'));			return true;		}		else		{			// Rebuild failed.			$this->setMessage(JText::sprintf('COM_MENUS_ITEMS_REBUILD_FAILED'));			return false;		}	}	public function saveorder()	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		// Get the arrays from the Request		$order = $this->input->post->get('order', null, 'array');		$originalOrder = explode(',', $this->input->getString('original_order_values'));		// Make sure something has changed		if (!($order === $originalOrder))		{			parent::saveorder();		}		else		{			// Nothing to reorder			$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_list, false));			return true;		}	}	/**	 * Method to set the home property for a list of items	 *	 * @since   1.6	 */	public function setDefault()	{		// Check for request forgeries		JSession::checkToken('request') or die(JText::_('JINVALID_TOKEN'));		// Get items to publish from the request.		$cid   = $this->input->get('cid', array(), 'array');		$data  = array('setDefault' => 1, 'unsetDefault' => 0);		$task  = $this->getTask();		$value = JArrayHelper::getValue($data, $task, 0, 'int');		if (empty($cid))		{			JError::raiseWarning(500, JText::_($this->text_prefix.'_NO_ITEM_SELECTED'));		}		else		{			// Get the model.			$model = $this->getModel();			// Make sure the item ids are integers			JArrayHelper::toInteger($cid);			// Publish the items.			if (!$model->setHome($cid, $value))			{				JError::raiseWarning(500, $model->getError());			} else {				if ($value == 1)				{					$ntext = 'COM_MENUS_ITEMS_SET_HOME';				}				else {					$ntext = 'COM_MENUS_ITEMS_UNSET_HOME';				}				$this->setMessage(JText::plural($ntext, count($cid)));			}		}		$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_list, false));	}	/**	 * Method to save the submitted ordering values for records via AJAX.	 *	 * @return  void	 *	 * @since   3.0	 */	public function saveOrderAjax()	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		// Get the arrays from the Request		$pks   = $this->input->post->get('cid', null, 'array');		$order = $this->input->post->get('order', null, 'array');		$originalOrder = explode(',', $this->input->getString('original_order_values'));		// Make sure something has changed		if (!($order === $originalOrder))		{			// Get the model			$model = $this->getModel();			// Save the ordering			$return = $model->saveorder($pks, $order);			if ($return)			{				echo "1";			}		}		// Close the application		JFactory::getApplication()->close();	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');JHtml::_('behavior.modal');JHtml::_('formbehavior.chosen', 'select');$canDo = UsersHelper::getActions();$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn = $this->escape($this->state->get('list.direction'));$loggeduser = JFactory::getUser();?><form action="<?php echo JRoute::_('index.php?option=com_users&view=users');?>" method="post" name="adminForm" id="adminForm">	<?php if (!empty( $this->sidebar)) : ?>		<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>		</div>		<div id="j-main-container" class="span10">	<?php else : ?>		<div id="j-main-container">	<?php endif;?>	<div id="filter-bar" class="btn-toolbar">		<div class="filter-search btn-group pull-left">			<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_USERS_SEARCH_USERS'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_USERS_SEARCH_USERS'); ?>" />		</div>		<div class="btn-group pull-left">			<button type="submit" class="btn tip" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>			<button type="button" class="btn tip" onclick="document.id('filter_search').value='';this.form.submit();" title="<?php echo JText::_('JSEARCH_RESET'); ?>"><i class="icon-remove"></i></button>		</div>	</div>	<div class="clearfix"> </div>	<table class="table table-striped">		<thead>			<tr>				<th width="1%" class="nowrap center">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="left">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_NAME', 'a.name', $listDirn, $listOrder); ?>				</th>				<th width="10%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_USERNAME', 'a.username', $listDirn, $listOrder); ?>				</th>				<th width="5%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ENABLED', 'a.block', $listDirn, $listOrder); ?>				</th>				<th width="5%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ACTIVATED', 'a.activation', $listDirn, $listOrder); ?>				</th>				<th width="10%" class="nowrap center">					<?php echo JText::_('COM_USERS_HEADING_GROUPS'); ?>				</th>				<th width="15%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_EMAIL', 'a.email', $listDirn, $listOrder); ?>				</th>				<th width="10%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_LAST_VISIT_DATE', 'a.lastvisitDate', $listDirn, $listOrder); ?>				</th>				<th width="10%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_REGISTRATION_DATE', 'a.registerDate', $listDirn, $listOrder); ?>				</th>				<th width="1%" class="nowrap center">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tfoot>			<tr>				<td colspan="15">					<?php echo $this->pagination->getListFooter(); ?>				</td>			</tr>		</tfoot>		<tbody>		<?php foreach ($this->items as $i => $item) :			$canEdit   = $canDo->get('core.edit');			$canChange = $loggeduser->authorise('core.edit.state',	'com_users');			// If this group is super admin and this user is not super admin, $canEdit is false			if ((!$loggeduser->authorise('core.admin')) && JAccess::check($item->id, 'core.admin'))			{				$canEdit   = false;				$canChange = false;			}		?>			<tr class="row<?php echo $i % 2; ?>">				<td class="center">					<?php if ($canEdit) : ?>						<?php echo JHtml::_('grid.id', $i, $item->id); ?>					<?php endif; ?>				</td>				<td>					<?php if ($canEdit) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_users&task=user.edit&id='.(int) $item->id); ?>" title="<?php echo JText::sprintf('COM_USERS_EDIT_USER', $this->escape($item->name)); ?>">							<?php echo $this->escape($item->name); ?></a>					<?php else : ?>						<?php echo $this->escape($item->name); ?>					<?php endif; ?>					<div>						<?php echo JHtml::_('users.filterNotes', $item->note_count, $item->id); ?>						<?php echo JHtml::_('users.notes', $item->note_count, $item->id); ?>						<?php echo JHtml::_('users.addNote', $item->id); ?>					</div>					<?php if (JDEBUG) : ?>						<div class="small"><a href="<?php echo JRoute::_('index.php?option=com_users&view=debuguser&user_id='.(int) $item->id);?>">						<?php echo JText::_('COM_USERS_DEBUG_USER');?></a></div>					<?php endif; ?>				</td>				<td class="center">					<?php echo $this->escape($item->username); ?>				</td>				<td class="center">					<?php if ($canChange) : ?>						<?php						$self = $loggeduser->id == $item->id;						echo JHtml::_('jgrid.state', JHtmlUsers::blockStates($self), $item->block, $i, 'users.', !$self);						?>					<?php else : ?>						<?php echo JText::_($item->block ? 'JNO' : 'JYES'); ?>					<?php endif; ?>				</td>				<td class="center">					<?php					$activated = empty( $item->activation) ? 0 : 1;					echo JHtml::_('jgrid.state', JHtmlUsers::activateStates(), $activated, $i, 'users.', (boolean) $activated);					?>				</td>				<td class="center">					<?php if (substr_count($item->group_names, "\n") > 1) : ?>						<span class="hasTip" title="<?php echo JText::_('COM_USERS_HEADING_GROUPS').'::'.nl2br($item->group_names); ?>"><?php echo JText::_('COM_USERS_USERS_MULTIPLE_GROUPS'); ?></span>					<?php else : ?>						<?php echo nl2br($item->group_names); ?>					<?php endif; ?>				</td>				<td class="center">					<?php echo $this->escape($item->email); ?>				</td>				<td class="center">					<?php if ($item->lastvisitDate != '0000-00-00 00:00:00'):?>						<?php echo JHtml::_('date', $item->lastvisitDate, 'Y-m-d H:i:s'); ?>					<?php else:?>						<?php echo JText::_('JNEVER'); ?>					<?php endif;?>				</td>				<td class="center">					<?php echo JHtml::_('date', $item->registerDate, 'Y-m-d H:i:s'); ?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php //Load the batch processing form. ?>	<?php echo $this->loadTemplate('batch'); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Linkedin * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Linkedin API People class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Linkedin * @since       13.1 */class JLinkedinPeople extends JLinkedinObject{	/**	 * Method to get a member's profile.	 *	 * @param   string  $id        Member id of the profile you want.	 * @param   string  $url       The public profile URL.	 * @param   string  $fields    Request fields beyond the default ones.	 * @param   string  $type      Choosing public or standard profile.	 * @param   string  $language  A comma separated list of locales ordered from highest to lowest preference.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getProfile($id = null, $url = null, $fields = null, $type = 'standard', $language = null)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/';		$data['format'] = 'json';		// Check if a member id is specified.		if ($id)		{			$base .= 'id=' . $id;		}		elseif (!$url)		{			$base .= '~';		}		// Check if profile url is specified.		if ($url)		{			$base .= 'url=' . $this->oauth->safeEncode($url);			// Choose public profile			if (!strcmp($type, 'public'))			{				$base .= ':public';			}		}		// Check if fields is specified.		if ($fields)		{			$base .= ':' . $fields;		}		// Check if language is specified.		$header = array();		if ($language)		{			$header = array('Accept-Language' => $language);		}		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data, $header);		return json_decode($response->body);	}	/**	 * Method to get a list of connections for a user who has granted access to his/her account.	 *	 * @param   string   $fields          Request fields beyond the default ones.	 * @param   integer  $start           Starting location within the result set for paginated returns.	 * @param   integer  $count           The number of results returned.	 * @param   string   $modified        Values are updated or new.	 * @param   string   $modified_since  Value as a Unix time stamp of milliseconds since epoch.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getConnections($fields = null, $start = 0, $count = 500, $modified = null, $modified_since = null)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/~/connections';		$data['format'] = 'json';		// Check if fields is specified.		if ($fields)		{			$base .= ':' . $fields;		}		// Check if start is specified.		if ($start > 0)		{			$data['start'] = $start;		}		// Check if count is specified.		if ($count != 500)		{			$data['count'] = $count;		}		// Check if modified is specified.		if ($modified)		{			$data['modified'] = $modified;		}		// Check if modified_since is specified.		if ($modified_since)		{			$data['modified-since'] = $modified_since;		}		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to get information about people.	 *	 * @param   string   $fields           Request fields beyond the default ones. provide 'api-standard-profile-request'	 * 									   field for out of network profiles.	 * @param   string   $keywords         Members who have all the keywords anywhere in their profile.	 * @param   string   $first_name       Members with a matching first name. Matches must be exact.	 * @param   string   $last_name        Members with a matching last name. Matches must be exactly.	 * @param   string   $company_name     Members who have a matching company name on their profile.	 * @param   boolean  $current_company  A value of true matches members who currently work at the company specified in the company-name	 * 									   parameter.	 * @param   string   $title            Matches members with that title on their profile.	 * @param   boolean  $current_title    A value of true matches members whose title is currently the one specified in the title-name parameter.	 * @param   string   $school_name      Members who have a matching school name on their profile.	 * @param   string   $current_school   A value of true matches members who currently attend the school specified in the school-name parameter.	 * @param   string   $country_code     Matches members with a location in a specific country. Values are defined in by ISO 3166 standard.	 * 									   Country codes must be in all lower case.	 * @param   integer  $postal_code      Matches members centered around a Postal Code. Must be combined with the country-code parameter.	 * 									   Not supported for all countries.	 * @param   integer  $distance         Matches members within a distance from a central point. This is measured in miles.	 * @param   string   $facets           Facet buckets to return, e.g. location.	 * @param   array    $facet            Array of facet values to search over. Contains values for location, industry, network, language,	 * 									   current-company, past-company and school, in exactly this order, null must be specified for an element if no value.	 * @param   integer  $start            Starting location within the result set for paginated returns.	 * @param   integer  $count            The number of results returned.	 * @param   string   $sort             Controls the search result order. There are four options: connections, recommenders,	 * 									   distance and relevance.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function search($fields = null, $keywords = null, $first_name = null, $last_name = null, $company_name = null,		$current_company = null, $title = null, $current_title = null, $school_name = null, $current_school = null, $country_code = null,		$postal_code = null, $distance = null, $facets = null, $facet = null, $start = 0, $count = 10, $sort = null)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people-search';		$data['format'] = 'json';		// Check if fields is specified.		if ($fields)		{			$base .= ':' . $fields;		}		// Check if keywords is specified.		if ($keywords)		{			$data['keywords'] = $keywords;		}		// Check if first_name is specified.		if ($first_name)		{			$data['first-name'] = $first_name;		}		// Check if last_name is specified.		if ($last_name)		{			$data['last-name'] = $last_name;		}		// Check if company-name is specified.		if ($company_name)		{			$data['company-name'] = $company_name;		}		// Check if current_company is specified.		if ($current_company)		{			$data['current-company'] = $current_company;		}		// Check if title is specified.		if ($title)		{			$data['title'] = $title;		}		// Check if current_title is specified.		if ($current_title)		{			$data['current-title'] = $current_title;		}		// Check if school_name is specified.		if ($school_name)		{			$data['school-name'] = $school_name;		}		// Check if current_school is specified.		if ($current_school)		{			$data['current-school'] = $current_school;		}		// Check if country_code is specified.		if ($country_code)		{			$data['country-code'] = $country_code;		}		// Check if postal_code is specified.		if ($postal_code)		{			$data['postal-code'] = $postal_code;		}		// Check if distance is specified.		if ($distance)		{			$data['distance'] = $distance;		}		// Check if facets is specified.		if ($facets)		{			$data['facets'] = $facets;		}		// Check if facet is specified.		if ($facet)		{			$data['facet'] = array();			for ($i = 0; $i < count($facet); $i++)			{				if ($facet[$i])				{					if ($i == 0)					{						$data['facet'][] = 'location,' . $facet[$i];					}					if ($i == 1)					{						$data['facet'][] = 'industry,' . $facet[$i];					}					if ($i == 2)					{						$data['facet'][] = 'network,' . $facet[$i];					}					if ($i == 3)					{						$data['facet'][] = 'language,' . $facet[$i];					}					if ($i == 4)					{						$data['facet'][] = 'current-company,' . $facet[$i];					}					if ($i == 5)					{						$data['facet'][] = 'past-company,' . $facet[$i];					}					if ($i == 6)					{						$data['facet'][] = 'school,' . $facet[$i];					}				}			}		}		// Check if start is specified.		if ($start > 0)		{			$data['start'] = $start;		}		// Check if count is specified.		if ($count != 10)		{			$data['count'] = $count;		}		// Check if sort is specified.		if ($sort)		{			$data['sort'] = $sort;		}		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		if (strpos($fields, 'api-standard-profile-request') === false)		{			return json_decode($response->body);		}		// Get header name.		$name = explode('"name": "', $response->body);		$name = explode('"', $name[1]);		$name = $name[0];		// Get header value.		$value = explode('"value": "', $response->body);		$value = explode('"', $value[1]);		$value = $value[0];		// Get request url.		$url = explode('"url": "', $response->body);		$url = explode('"', $url[1]);		$url = $url[0];		// Build header for out of network profile.		$header[$name] = $value;		// Send the request.		$response = $this->oauth->oauthRequest($url, 'GET', $parameters, $data, $header);		return json_decode($response->body);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><fieldset class="form-horizontal">	<legend><?php echo JText::_('COM_CONFIG_SYSTEM_SETTINGS'); ?></legend>	<?php	foreach ($this->form->getFieldset('system') as $field):	?>		<div class="control-group">			<div class="control-label"><?php echo $field->label; ?></div>			<div class="controls"><?php echo $field->input; ?></div>		</div>	<?php	endforeach;	?></fieldset>
<?php/** * @package     Joomla.Platform * @subpackage  Session * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Class for managing HTTP sessions * * Provides access to session-state values as well as session-level * settings and lifetime management methods. * Based on the standard PHP session handling mechanism it provides * more advanced features such as expire timeouts. * * @package     Joomla.Platform * @subpackage  Session * @since       11.1 */class JSession implements IteratorAggregate{	/**	 * Internal state.	 * One of 'inactive'|'active'|'expired'|'destroyed'|'error'	 *	 * @var    string	 * @see    getState()	 * @since  11.1	 */	protected $_state = 'inactive';	/**	 * Maximum age of unused session in minutes	 *	 * @var    string	 * @since  11.1	 */	protected $_expire = 15;	/**	 * The session store object.	 *	 * @var    JSessionStorage	 * @since  11.1	 */	protected $_store = null;	/**	 * Security policy.	 * List of checks that will be done.	 *	 * Default values:	 * - fix_browser	 * - fix_adress	 *	 * @var array	 * @since  11.1	 */	protected $_security = array('fix_browser');	/**	 * Force cookies to be SSL only	 * Default  false	 *	 * @var    boolean	 * @since  11.1	 */	protected $_force_ssl = false;	/**	 * @var    JSession  JSession instances container.	 * @since  11.3	 */	protected static $instance;	/**	 * @var    string	 * @since  12.2	 */	protected $storeName;	/**	 * Holds the JInput object	 *	 * @var    JInput	 * @since  12.2	 */	private $_input = null;	/**	 * Holds the event dispatcher object	 *	 * @var    JEventDispatcher	 * @since  12.2	 */	private $_dispatcher = null;	/**	 * Constructor	 *	 * @param   string  $store    The type of storage for the session.	 * @param   array   $options  Optional parameters	 *	 * @since   11.1	 */	public function __construct($store = 'none', array $options = array())	{		// Need to destroy any existing sessions started with session.auto_start		if (session_id())		{			session_unset();			session_destroy();		}		// Disable transparent sid support		ini_set('session.use_trans_sid', '0');		// Only allow the session ID to come from cookies and nothing else.		ini_set('session.use_only_cookies', '1');		// Create handler		$this->_store = JSessionStorage::getInstance($store, $options);		$this->storeName = $store;		// Set options		$this->_setOptions($options);		$this->_setCookieParams();		$this->_state = 'inactive';	}	/**	 * Magic method to get read-only access to properties.	 *	 * @param   string  $name  Name of property to retrieve	 *	 * @return  mixed   The value of the property	 *	 * @since   12.2	 */	public function __get($name)	{		if ($name === 'storeName')		{			return $this->$name;		}		if ($name === 'state' || $name === 'expire')		{			$property = '_' . $name;			return $this->$property;		}	}	/**	 * Returns the global Session object, only creating it	 * if it doesn't already exist.	 *	 * @param   string  $handler  The type of session handler.	 * @param   array   $options  An array of configuration options.	 *	 * @return  JSession  The Session object.	 *	 * @since   11.1	 */	public static function getInstance($handler, $options)	{		if (!is_object(self::$instance))		{			self::$instance = new JSession($handler, $options);		}		return self::$instance;	}	/**	 * Get current state of session	 *	 * @return  string  The session state	 *	 * @since   11.1	 */	public function getState()	{		return $this->_state;	}	/**	 * Get expiration time in minutes	 *	 * @return  integer  The session expiration time in minutes	 *	 * @since   11.1	 */	public function getExpire()	{		return $this->_expire;	}	/**	 * Get a session token, if a token isn't set yet one will be generated.	 *	 * Tokens are used to secure forms from spamming attacks. Once a token	 * has been generated the system will check the post request to see if	 * it is present, if not it will invalidate the session.	 *	 * @param   boolean  $forceNew  If true, force a new token to be created	 *	 * @return  string  The session token	 *	 * @since   11.1	 */	public function getToken($forceNew = false)	{		$token = $this->get('session.token');		// Create a token		if ($token === null || $forceNew)		{			$token = $this->_createToken(12);			$this->set('session.token', $token);		}		return $token;	}	/**	 * Method to determine if a token exists in the session. If not the	 * session will be set to expired	 *	 * @param   string   $tCheck       Hashed token to be verified	 * @param   boolean  $forceExpire  If true, expires the session	 *	 * @return  boolean	 *	 * @since   11.1	 */	public function hasToken($tCheck, $forceExpire = true)	{		// Check if a token exists in the session		$tStored = $this->get('session.token');		// Check token		if (($tStored !== $tCheck))		{			if ($forceExpire)			{				$this->_state = 'expired';			}			return false;		}		return true;	}	/**	 * Method to determine a hash for anti-spoofing variable names	 *	 * @param   boolean  $forceNew  If true, force a new token to be created	 *	 * @return  string  Hashed var name	 *	 * @since   11.1	 */	public static function getFormToken($forceNew = false)	{		$user    = JFactory::getUser();		$session = JFactory::getSession();		// TODO: Decouple from legacy JApplication class.		if (is_callable(array('JApplication', 'getHash')))		{			$hash = JApplication::getHash($user->get('id', 0) . $session->getToken($forceNew));		}		else		{			$hash = md5(JFactory::getApplication()->get('secret') . $user->get('id', 0) . $session->getToken($forceNew));		}		return $hash;	}	/**	 * Retrieve an external iterator.	 *	 * @return  ArrayIterator  Return an ArrayIterator of $_SESSION.	 *	 * @since   12.2	 */	public function getIterator()	{		return new ArrayIterator($_SESSION);	}	/**	 * Checks for a form token in the request.	 *	 * Use in conjunction with JHtml::_('form.token') or JSession::getFormToken.	 *	 * @param   string  $method  The request method in which to look for the token key.	 *	 * @return  boolean  True if found and valid, false otherwise.	 *	 * @since   12.1	 */	public static function checkToken($method = 'post')	{		$token = self::getFormToken();		$app = JFactory::getApplication();		if (!$app->input->$method->get($token, '', 'alnum'))		{			$session = JFactory::getSession();			if ($session->isNew())			{				// Redirect to login screen.				$app->redirect(JRoute::_('index.php'), JText::_('JLIB_ENVIRONMENT_SESSION_EXPIRED'));				$app->close();			}			else			{				return false;			}		}		else		{			return true;		}	}	/**	 * Get session name	 *	 * @return  string  The session name	 *	 * @since   11.1	 */	public function getName()	{		if ($this->_state === 'destroyed')		{			// @TODO : raise error			return null;		}		return session_name();	}	/**	 * Get session id	 *	 * @return  string  The session name	 *	 * @since   11.1	 */	public function getId()	{		if ($this->_state === 'destroyed')		{			// @TODO : raise error			return null;		}		return session_id();	}	/**	 * Get the session handlers	 *	 * @return  array  An array of available session handlers	 *	 * @since   11.1	 */	public static function getStores()	{		$connectors = array();		// Get an iterator and loop trough the driver classes.		$iterator = new DirectoryIterator(__DIR__ . '/storage');		foreach ($iterator as $file)		{			$fileName = $file->getFilename();			// Only load for php files.			// Note: DirectoryIterator::getExtension only available PHP >= 5.3.6			if (!$file->isFile() || substr($fileName, strrpos($fileName, '.') + 1) != 'php')			{				continue;			}			// Derive the class name from the type.			$class = str_ireplace('.php', '', 'JSessionStorage' . ucfirst(trim($fileName)));			// If the class doesn't exist we have nothing left to do but look at the next type. We did our best.			if (!class_exists($class))			{				continue;			}			// Sweet!  Our class exists, so now we just need to know if it passes its test method.			if ($class::isSupported())			{				// Connector names should not have file extensions.				$connectors[] = str_ireplace('.php', '', $fileName);			}		}		return $connectors;	}	/**	 * Shorthand to check if the session is active	 *	 * @return  boolean	 *	 * @since   12.2	 */	public function isActive()	{		return (bool) ($this->_state == 'active');	}	/**	 * Check whether this session is currently created	 *	 * @return  boolean  True on success.	 *	 * @since   11.1	 */	public function isNew()	{		$counter = $this->get('session.counter');		return (bool) ($counter === 1);	}	/**	 * Check whether this session is currently created	 *	 * @param   JInput            $input       JInput object for the session to use.	 * @param   JEventDispatcher  $dispatcher  Dispatcher object for the session to use.	 *	 * @return  void.	 *	 * @since   12.2	 */	public function initialise(JInput $input, JEventDispatcher $dispatcher = null)	{		$this->_input      = $input;		$this->_dispatcher = $dispatcher;	}	/**	 * Get data from the session store	 *	 * @param   string  $name       Name of a variable	 * @param   mixed   $default    Default value of a variable if not set	 * @param   string  $namespace  Namespace to use, default to 'default'	 *	 * @return  mixed  Value of a variable	 *	 * @since   11.1	 */	public function get($name, $default = null, $namespace = 'default')	{		// Add prefix to namespace to avoid collisions		$namespace = '__' . $namespace;		if ($this->_state !== 'active' && $this->_state !== 'expired')		{			// @TODO :: generated error here			$error = null;			return $error;		}		if (isset($_SESSION[$namespace][$name]))		{			return $_SESSION[$namespace][$name];		}		return $default;	}	/**	 * Set data into the session store.	 *	 * @param   string  $name       Name of a variable.	 * @param   mixed   $value      Value of a variable.	 * @param   string  $namespace  Namespace to use, default to 'default'.	 *	 * @return  mixed  Old value of a variable.	 *	 * @since   11.1	 */	public function set($name, $value = null, $namespace = 'default')	{		// Add prefix to namespace to avoid collisions		$namespace = '__' . $namespace;		if ($this->_state !== 'active')		{			// @TODO :: generated error here			return null;		}		$old = isset($_SESSION[$namespace][$name]) ? $_SESSION[$namespace][$name] : null;		if (null === $value)		{			unset($_SESSION[$namespace][$name]);		}		else		{			$_SESSION[$namespace][$name] = $value;		}		return $old;	}	/**	 * Check whether data exists in the session store	 *	 * @param   string  $name       Name of variable	 * @param   string  $namespace  Namespace to use, default to 'default'	 *	 * @return  boolean  True if the variable exists	 *	 * @since   11.1	 */	public function has($name, $namespace = 'default')	{		// Add prefix to namespace to avoid collisions.		$namespace = '__' . $namespace;		if ($this->_state !== 'active')		{			// @TODO :: generated error here			return null;		}		return isset($_SESSION[$namespace][$name]);	}	/**	 * Unset data from the session store	 *	 * @param   string  $name       Name of variable	 * @param   string  $namespace  Namespace to use, default to 'default'	 *	 * @return  mixed   The value from session or NULL if not set	 *	 * @since   11.1	 */	public function clear($name, $namespace = 'default')	{		// Add prefix to namespace to avoid collisions		$namespace = '__' . $namespace;		if ($this->_state !== 'active')		{			// @TODO :: generated error here			return null;		}		$value = null;		if (isset($_SESSION[$namespace][$name]))		{			$value = $_SESSION[$namespace][$name];			unset($_SESSION[$namespace][$name]);		}		return $value;	}	/**	 * Start a session.	 *	 * @return  void	 *	 * @since   12.2	 */	public function start()	{		if ($this->_state === 'active')		{			return;		}		$this->_start();		$this->_state = 'active';		// Initialise the session		$this->_setCounter();		$this->_setTimers();		// Perform security checks		$this->_validate();		if ($this->_dispatcher instanceof JEventDispatcher)		{			$this->_dispatcher->trigger('onAfterSessionStart');		}	}	/**	 * Start a session.	 *	 * Creates a session (or resumes the current one based on the state of the session)	 *	 * @return  boolean  true on success	 *	 * @since   11.1	 */	protected function _start()	{		// Start session if not started		if ($this->_state === 'restart')		{			session_regenerate_id(true);		}		else		{			$session_name = session_name();			// Get the JInputCookie object			$cookie = $this->_input->cookie;			if (is_null($cookie->get($session_name)))			{				$session_clean = $this->_input->get($session_name, false, 'string');				if ($session_clean)				{					session_id($session_clean);					$cookie->set($session_name, '', time() - 3600);				}			}		}		/**		 * Write and Close handlers are called after destructing objects since PHP 5.0.5.		 * Thus destructors can use sessions but session handler can't use objects.		 * So we are moving session closure before destructing objects.		 *		 * Replace with session_register_shutdown() when dropping compatibility with PHP 5.3		 */		register_shutdown_function('session_write_close');		session_cache_limiter('none');		session_start();		return true;	}	/**	 * Frees all session variables and destroys all data registered to a session	 *	 * This method resets the $_SESSION variable and destroys all of the data associated	 * with the current session in its storage (file or DB). It forces new session to be	 * started after this method is called. It does not unset the session cookie.	 *	 * @return  boolean  True on success	 *	 * @see     session_destroy()	 * @see     session_unset()	 * @since   11.1	 */	public function destroy()	{		// Session was already destroyed		if ($this->_state === 'destroyed')		{			return true;		}		/*		 * In order to kill the session altogether, such as to log the user out, the session id		 * must also be unset. If a cookie is used to propagate the session id (default behavior),		 * then the session cookie must be deleted.		 */		if (isset($_COOKIE[session_name()]))		{			$config = JFactory::getConfig();			$cookie_domain = $config->get('cookie_domain', '');			$cookie_path = $config->get('cookie_path', '/');			setcookie(session_name(), '', time() - 42000, $cookie_path, $cookie_domain);		}		session_unset();		session_destroy();		$this->_state = 'destroyed';		return true;	}	/**	 * Restart an expired or locked session.	 *	 * @return  boolean  True on success	 *	 * @see     destroy	 * @since   11.1	 */	public function restart()	{		$this->destroy();		if ($this->_state !== 'destroyed')		{			// @TODO :: generated error here			return false;		}		// Re-register the session handler after a session has been destroyed, to avoid PHP bug		$this->_store->register();		$this->_state = 'restart';		// Regenerate session id		session_regenerate_id(true);		$this->_start();		$this->_state = 'active';		$this->_validate();		$this->_setCounter();		return true;	}	/**	 * Create a new session and copy variables from the old one	 *	 * @return  boolean $result true on success	 *	 * @since   11.1	 */	public function fork()	{		if ($this->_state !== 'active')		{			// @TODO :: generated error here			return false;		}		// Save values		$values = $_SESSION;		// Keep session config		$cookie = session_get_cookie_params();		// Kill session		session_destroy();		// Re-register the session store after a session has been destroyed, to avoid PHP bug		$this->_store->register();		// Restore config		session_set_cookie_params($cookie['lifetime'], $cookie['path'], $cookie['domain'], $cookie['secure'], true);		// Restart session with new id		session_regenerate_id(true);		session_start();		return true;	}	/**	 * Writes session data and ends session	 *	 * Session data is usually stored after your script terminated without the need	 * to call JSession::close(), but as session data is locked to prevent concurrent	 * writes only one script may operate on a session at any time. When using	 * framesets together with sessions you will experience the frames loading one	 * by one due to this locking. You can reduce the time needed to load all the	 * frames by ending the session as soon as all changes to session variables are	 * done.	 *	 * @return  void	 *	 * @see     session_write_close()	 * @since   11.1	 */	public function close()	{		session_write_close();	}	/**	 * Set session cookie parameters	 *	 * @return  void	 *	 * @since   11.1	 */	protected function _setCookieParams()	{		$cookie = session_get_cookie_params();		if ($this->_force_ssl)		{			$cookie['secure'] = true;		}		$config = JFactory::getConfig();		if ($config->get('cookie_domain', '') != '')		{			$cookie['domain'] = $config->get('cookie_domain');		}		if ($config->get('cookie_path', '') != '')		{			$cookie['path'] = $config->get('cookie_path');		}		session_set_cookie_params($cookie['lifetime'], $cookie['path'], $cookie['domain'], $cookie['secure'], true);	}	/**	 * Create a token-string	 *	 * @param   integer  $length  Length of string	 *	 * @return  string  Generated token	 *	 * @since   11.1	 */	protected function _createToken($length = 32)	{		static $chars = '0123456789abcdef';		$max = strlen($chars) - 1;		$token = '';		$name = session_name();		for ($i = 0; $i < $length; ++$i)		{			$token .= $chars[(rand(0, $max))];		}		return md5($token . $name);	}	/**	 * Set counter of session usage	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	protected function _setCounter()	{		$counter = $this->get('session.counter', 0);		++$counter;		$this->set('session.counter', $counter);		return true;	}	/**	 * Set the session timers	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	protected function _setTimers()	{		if (!$this->has('session.timer.start'))		{			$start = time();			$this->set('session.timer.start', $start);			$this->set('session.timer.last', $start);			$this->set('session.timer.now', $start);		}		$this->set('session.timer.last', $this->get('session.timer.now'));		$this->set('session.timer.now', time());		return true;	}	/**	 * Set additional session options	 *	 * @param   array  $options  List of parameter	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	protected function _setOptions(array $options)	{		// Set name		if (isset($options['name']))		{			session_name(md5($options['name']));		}		// Set id		if (isset($options['id']))		{			session_id($options['id']);		}		// Set expire time		if (isset($options['expire']))		{			$this->_expire = $options['expire'];		}		// Get security options		if (isset($options['security']))		{			$this->_security = explode(',', $options['security']);		}		if (isset($options['force_ssl']))		{			$this->_force_ssl = (bool) $options['force_ssl'];		}		// Sync the session maxlifetime		ini_set('session.gc_maxlifetime', $this->_expire);		return true;	}	/**	 * Do some checks for security reason	 *	 * - timeout check (expire)	 * - ip-fixiation	 * - browser-fixiation	 *	 * If one check failed, session data has to be cleaned.	 *	 * @param   boolean  $restart  Reactivate session	 *	 * @return  boolean  True on success	 *	 * @see     http://shiflett.org/articles/the-truth-about-sessions	 * @since   11.1	 */	protected function _validate($restart = false)	{		// Allow to restart a session		if ($restart)		{			$this->_state = 'active';			$this->set('session.client.address', null);			$this->set('session.client.forwarded', null);			$this->set('session.client.browser', null);			$this->set('session.token', null);		}		// Check if session has expired		if ($this->_expire)		{			$curTime = $this->get('session.timer.now', 0);			$maxTime = $this->get('session.timer.last', 0) + $this->_expire;			// Empty session variables			if ($maxTime < $curTime)			{				$this->_state = 'expired';				return false;			}		}		// Record proxy forwarded for in the session in case we need it later		if (isset($_SERVER['HTTP_X_FORWARDED_FOR']))		{			$this->set('session.client.forwarded', $_SERVER['HTTP_X_FORWARDED_FOR']);		}		// Check for client address		if (in_array('fix_adress', $this->_security) && isset($_SERVER['REMOTE_ADDR']))		{			$ip = $this->get('session.client.address');			if ($ip === null)			{				$this->set('session.client.address', $_SERVER['REMOTE_ADDR']);			}			elseif ($_SERVER['REMOTE_ADDR'] !== $ip)			{				$this->_state = 'error';				return false;			}		}		// Check for clients browser		if (in_array('fix_browser', $this->_security) && isset($_SERVER['HTTP_USER_AGENT']))		{			$browser = $this->get('session.client.browser');			if ($browser === null)			{				$this->set('session.client.browser', $_SERVER['HTTP_USER_AGENT']);			}			elseif ($_SERVER['HTTP_USER_AGENT'] !== $browser)			{				// @todo remove code: 				$this->_state	=	'error';				// @todo remove code: 				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JFormHelper::loadRuleClass('email');/** * JFormRule for com_contact to make sure the E-Mail adress is not blocked. * * @package     Joomla.Site * @subpackage  com_contact */class JFormRuleContactEmail extends JFormRuleEmail{	/**	 * Method to test for a valid color in hexadecimal.	 *	 * @param   SimpleXMLElement  &$element  The SimpleXMLElement object representing the <field /> tag for the form field object.	 * @param   mixed             $value     The form field value to validate.	 * @param   string            $group     The field name group control value. This acts as as an array container for the field.	 *                                       For example if the field has name="foo" and the group value is set to "bar" then the	 *                                       full field name would end up being "bar[foo]".	 * @param   object            &$input    An optional JRegistry object with the entire data set to validate against the entire form.	 * @param   object            &$form     The form object for which the field is being tested.	 *	 * @return  boolean  True if the value is valid, false otherwise.	 */	public function test(& $element, $value, $group = null, &$input = null, &$form = null)	{		if (!parent::test($element, $value, $group, $input, $form)){			return false;		}		$params = JComponentHelper::getParams('com_contact');		$banned = $params->get('banned_email');		foreach (explode(';', $banned) as $item) {			if (JString::stristr($item, $value) !== false)					return false;		}		return true;	}}
<?php/** * @package     Joomla.Platform * @subpackage  User * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Authorisation helper class, provides static methods to perform various tasks relevant * to the Joomla user and authorisation classes * * This class has influences and some method logic from the Horde Auth package * * @package     Joomla.Platform * @subpackage  User * @since       11.1 */abstract class JUserHelper{	/**	 * Method to add a user to a group.	 *	 * @param   integer  $userId   The id of the user.	 * @param   integer  $groupId  The id of the group.	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 * @throws  RuntimeException	 */	public static function addUserToGroup($userId, $groupId)	{		// Get the user object.		$user = new JUser((int) $userId);		// Add the user to the group if necessary.		if (!in_array($groupId, $user->groups))		{			// Get the title of the group.			$db = JFactory::getDbo();			$query = $db->getQuery(true)				->select($db->quoteName('title'))				->from($db->quoteName('#__usergroups'))				->where($db->quoteName('id') . ' = ' . (int) $groupId);			$db->setQuery($query);			$title = $db->loadResult();			// If the group does not exist, return an exception.			if (!$title)			{				throw new RuntimeException('Access Usergroup Invalid');			}			// Add the group data to the user object.			$user->groups[$title] = $groupId;			// Store the user object.			$user->save();		}		if (session_id())		{			// Set the group data for any preloaded user objects.			$temp = JFactory::getUser((int) $userId);			$temp->groups = $user->groups;			// Set the group data for the user object in the session.			$temp = JFactory::getUser();			if ($temp->id == $userId)			{				$temp->groups = $user->groups;			}		}		return true;	}	/**	 * Method to get a list of groups a user is in.	 *	 * @param   integer  $userId  The id of the user.	 *	 * @return  array    List of groups	 *	 * @since   11.1	 */	public static function getUserGroups($userId)	{		// Get the user object.		$user = JUser::getInstance((int) $userId);		return isset($user->groups) ? $user->groups : array();	}	/**	 * Method to remove a user from a group.	 *	 * @param   integer  $userId   The id of the user.	 * @param   integer  $groupId  The id of the group.	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	public static function removeUserFromGroup($userId, $groupId)	{		// Get the user object.		$user = JUser::getInstance((int) $userId);		// Remove the user from the group if necessary.		$key = array_search($groupId, $user->groups);		if ($key !== false)		{			// Remove the user from the group.			unset($user->groups[$key]);			// Store the user object.			$user->save();		}		// Set the group data for any preloaded user objects.		$temp = JFactory::getUser((int) $userId);		$temp->groups = $user->groups;		// Set the group data for the user object in the session.		$temp = JFactory::getUser();		if ($temp->id == $userId)		{			$temp->groups = $user->groups;		}		return true;	}	/**	 * Method to set the groups for a user.	 *	 * @param   integer  $userId  The id of the user.	 * @param   array    $groups  An array of group ids to put the user in.	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	public static function setUserGroups($userId, $groups)	{		// Get the user object.		$user = JUser::getInstance((int) $userId);		// Set the group ids.		JArrayHelper::toInteger($groups);		$user->groups = $groups;		// Get the titles for the user groups.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select($db->quoteName('id') . ', ' . $db->quoteName('title'))			->from($db->quoteName('#__usergroups'))			->where($db->quoteName('id') . ' = ' . implode(' OR ' . $db->quoteName('id') . ' = ', $user->groups));		$db->setQuery($query);		$results = $db->loadObjectList();		// Set the titles for the user groups.		for ($i = 0, $n = count($results); $i < $n; $i++)		{			$user->groups[$results[$i]->id] = $results[$i]->id;		}		// Store the user object.		$user->save();		if ($session_id())		{			// Set the group data for any preloaded user objects.			$temp = JFactory::getUser((int) $userId);			$temp->groups = $user->groups;			// Set the group data for the user object in the session.			$temp = JFactory::getUser();			if ($temp->id == $userId)			{				$temp->groups = $user->groups;			}		}		return true;	}	/**	 * Gets the user profile information	 *	 * @param   integer  $userId  The id of the user.	 *	 * @return  object	 *	 * @since   11.1	 */	public static function getProfile($userId = 0)	{		if ($userId == 0)		{			$user	= JFactory::getUser();			$userId	= $user->id;		}		// Get the dispatcher and load the user's plugins.		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('user');		$data = new JObject;		$data->id = $userId;		// Trigger the data preparation event.		$dispatcher->trigger('onContentPrepareData', array('com_users.profile', &$data));		return $data;	}	/**	 * Method to activate a user	 *	 * @param   string  $activation  Activation string	 *	 * @return  boolean  True on success	 *	 * @since   11.1	 */	public static function activateUser($activation)	{		// Initialize some variables.		$db = JFactory::getDbo();		$query = $db->getQuery(true);		// Let's get the id of the user we want to activate		$query->select($db->quoteName('id'))			->from($db->quoteName('#__users'))			->where($db->quoteName('activation') . ' = ' . $db->quote($activation))			->where($db->quoteName('block') . ' = 1')			->where($db->quoteName('lastvisitDate') . ' = ' . $db->quote('0000-00-00 00:00:00'));		$db->setQuery($query);		$id = (int) $db->loadResult();		// Is it a valid user to activate?		if ($id)		{			$user = JUser::getInstance((int) $id);			$user->set('block', '0');			$user->set('activation', '');			// Time to take care of business.... store the user.			if (!$user->save())			{				JLog::add($user->getError(), JLog::WARNING, 'jerror');				return false;			}		}		else		{			JLog::add(JText::_('JLIB_USER_ERROR_UNABLE_TO_FIND_USER'), JLog::WARNING, 'jerror');			return false;		}		return true;	}	/**	 * Returns userid if a user exists	 *	 * @param   string  $username  The username to search on.	 *	 * @return  integer  The user id or 0 if not found.	 *	 * @since   11.1	 */	public static function getUserId($username)	{		// Initialise some variables		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select($db->quoteName('id'))			->from($db->quoteName('#__users'))			->where($db->quoteName('username') . ' = ' . $db->quote($username));		$db->setQuery($query, 0, 1);		return $db->loadResult();	}	/**	 * Formats a password using the current encryption.	 *	 * @param   string   $plaintext     The plaintext password to encrypt.	 * @param   string   $salt          The salt to use to encrypt the password. []	 *                                  If not present, a new salt will be	 *                                  generated.	 * @param   string   $encryption    The kind of password encryption to use.	 *                                  Defaults to md5-hex.	 * @param   boolean  $show_encrypt  Some password systems prepend the kind of	 *                                  encryption to the crypted password ({SHA},	 *                                  etc). Defaults to false.	 *	 * @return  string  The encrypted password.	 *	 * @since   11.1	 */	public static function getCryptedPassword($plaintext, $salt = '', $encryption = 'md5-hex', $show_encrypt = false)	{		// Get the salt to use.		$salt = self::getSalt($encryption, $salt, $plaintext);		// Encrypt the password.		switch ($encryption)		{			case 'plain':				return $plaintext;			case 'sha':				$encrypted = base64_encode(mhash(MHASH_SHA1, $plaintext));				return ($show_encrypt) ? '{SHA}' . $encrypted : $encrypted;			case 'crypt':			case 'crypt-des':			case 'crypt-md5':			case 'crypt-blowfish':				return ($show_encrypt ? '{crypt}' : '') . crypt($plaintext, $salt);			case 'md5-base64':				$encrypted = base64_encode(mhash(MHASH_MD5, $plaintext));				return ($show_encrypt) ? '{MD5}' . $encrypted : $encrypted;			case 'ssha':				$encrypted = base64_encode(mhash(MHASH_SHA1, $plaintext . $salt) . $salt);				return ($show_encrypt) ? '{SSHA}' . $encrypted : $encrypted;			case 'smd5':				$encrypted = base64_encode(mhash(MHASH_MD5, $plaintext . $salt) . $salt);				return ($show_encrypt) ? '{SMD5}' . $encrypted : $encrypted;			case 'aprmd5':				$length = strlen($plaintext);				$context = $plaintext . '$apr1$' . $salt;				$binary = self::_bin(md5($plaintext . $salt . $plaintext));				for ($i = $length; $i > 0; $i -= 16)				{					$context .= substr($binary, 0, ($i > 16 ? 16 : $i));				}				for ($i = $length; $i > 0; $i >>= 1)				{					$context .= ($i & 1) ? chr(0) : $plaintext[0];				}				$binary = self::_bin(md5($context));				for ($i = 0; $i < 1000; $i++)				{					$new = ($i & 1) ? $plaintext : substr($binary, 0, 16);					if ($i % 3)					{						$new .= $salt;					}					if ($i % 7)					{						$new .= $plaintext;					}					$new .= ($i & 1) ? substr($binary, 0, 16) : $plaintext;					$binary = self::_bin(md5($new));				}				$p = array();				for ($i = 0; $i < 5; $i++)				{					$k = $i + 6;					$j = $i + 12;					if ($j == 16)					{						$j = 5;					}					$p[] = self::_toAPRMD5((ord($binary[$i]) << 16) | (ord($binary[$k]) << 8) | (ord($binary[$j])), 5);				}				return '$apr1$' . $salt . '$' . implode('', $p) . self::_toAPRMD5(ord($binary[11]), 3);			case 'md5-hex':			default:				$encrypted = ($salt) ? md5($plaintext . $salt) : md5($plaintext);				return ($show_encrypt) ? '{MD5}' . $encrypted : $encrypted;		}	}	/**	 * Returns a salt for the appropriate kind of password encryption.	 * Optionally takes a seed and a plaintext password, to extract the seed	 * of an existing password, or for encryption types that use the plaintext	 * in the generation of the salt.	 *	 * @param   string  $encryption  The kind of password encryption to use.	 *                               Defaults to md5-hex.	 * @param   string  $seed        The seed to get the salt from (probably a	 *                               previously generated password). Defaults to	 *                               generating a new seed.	 * @param   string  $plaintext   The plaintext password that we're generating	 *                               a salt for. Defaults to none.	 *	 * @return  string  The generated or extracted salt.	 *	 * @since   11.1	 */	public static function getSalt($encryption = 'md5-hex', $seed = '', $plaintext = '')	{		// Encrypt the password.		switch ($encryption)		{			case 'crypt':			case 'crypt-des':				if ($seed)				{					return substr(preg_replace('|^{crypt}|i', '', $seed), 0, 2);				}				else				{					return substr(md5(mt_rand()), 0, 2);				}				break;			case 'crypt-md5':				if ($seed)				{					return substr(preg_replace('|^{crypt}|i', '', $seed), 0, 12);				}				else				{					return '$1$' . substr(md5(mt_rand()), 0, 8) . '$';				}				break;			case 'crypt-blowfish':				if ($seed)				{					return substr(preg_replace('|^{crypt}|i', '', $seed), 0, 16);				}				else				{					return '$2$' . substr(md5(mt_rand()), 0, 12) . '$';				}				break;			case 'ssha':				if ($seed)				{					return substr(preg_replace('|^{SSHA}|', '', $seed), -20);				}				else				{					return mhash_keygen_s2k(MHASH_SHA1, $plaintext, substr(pack('h*', md5(mt_rand())), 0, 8), 4);				}				break;			case 'smd5':				if ($seed)				{					return substr(preg_replace('|^{SMD5}|', '', $seed), -16);				}				else				{					return mhash_keygen_s2k(MHASH_MD5, $plaintext, substr(pack('h*', md5(mt_rand())), 0, 8), 4);				}				break;			case 'aprmd5': /* 64 characters that are valid for APRMD5 passwords. */				$APRMD5 = './0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';				if ($seed)				{					return substr(preg_replace('/^\$apr1\$(.{8}).*/', '\\1', $seed), 0, 8);				}				else				{					$salt = '';					for ($i = 0; $i < 8; $i++)					{						$salt .= $APRMD5{rand(0, 63)};					}					return $salt;				}				break;			default:				$salt = '';				if ($seed)				{					$salt = $seed;				}				return $salt;				break;		}	}	/**	 * Generate a random password	 *	 * @param   integer  $length  Length of the password to generate	 *	 * @return  string  Random Password	 *	 * @since   11.1	 */	public static function genRandomPassword($length = 8)	{		$salt = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";		$base = strlen($salt);		$makepass = '';		/*		 * Start with a cryptographic strength random string, then convert it to		 * a string with the numeric base of the salt.		 * Shift the base conversion on each character so the character		 * distribution is even, and randomize the start shift so it's not		 * predictable.		 */		$random = JCrypt::genRandomBytes($length + 1);		$shift = ord($random[0]);		for ($i = 1; $i <= $length; ++$i)		{			$makepass .= $salt[($shift + ord($random[$i])) % $base];			$shift += ord($random[$i]);		}		return $makepass;	}	/**	 * Converts to allowed 64 characters for APRMD5 passwords.	 *	 * @param   string   $value  The value to convert.	 * @param   integer  $count  The number of characters to convert.	 *	 * @return  string  $value converted to the 64 MD5 characters.	 *	 * @since   11.1	 */	protected static function _toAPRMD5($value, $count)	{		/* 64 characters that are valid for APRMD5 passwords. */		$APRMD5 = './0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';		$aprmd5 = '';		$count = abs($count);		while (--$count)		{			$aprmd5 .= $APRMD5[$value & 0x3f];			$value >>= 6;		}		return $aprmd5;	}	/**	 * Converts hexadecimal string to binary data.	 *	 * @param   string  $hex  Hex data.	 *	 * @return  string  Binary data.	 *	 * @since   11.1	 */	private static function _bin($hex)	{		$bin = '';		$length = strlen($hex);		for ($i = 0; $i < $length; $i += 2)		{			$tmp = sscanf(substr($hex, $i, 2), '%x');			$bin .= chr(array_shift($tmp));		}		return $bin;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_contact * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('bootstrap.tooltip');$input     = JFactory::getApplication()->input;$function  = $input->getCmd('function', 'jSelectContact');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_contact&view=contacts&layout=modal&tmpl=component&function='.$function);?>" method="post" name="adminForm" id="adminForm" class="form-inline">	<fieldset class="filter clearfix">		<div class="btn-toolbar">			<div class="btn-group pull-left">				<label for="filter_search">					<?php echo JText::_('JSEARCH_FILTER_LABEL'); ?>				</label>				<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" size="30" title="<?php echo JText::_('COM_CONTACT_FILTER_SEARCH_DESC'); ?>" />			</div>			<div class="btn-group pull-left">				<button type="submit" class="btn hasTooltip" data-placement="bottom" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>">					<i class="icon-search"></i></button>				<button type="button" class="btn hasTooltip" data-placement="bottom" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>" onclick="document.id('filter_search').value='';this.form.submit();">					<i class="icon-remove"></i></button>			</div>			<input onclick="if (window.parent) window.parent.<?php echo $this->escape($function);?>('0', '<?php echo $this->escape(addslashes(JText::_('COM_CONTACT_SELECT_A_CONTACT'))); ?>', null, null);" class="btn" type="button" value="<?php echo JText::_('COM_CONTACT_FIELD_VALUE_NONE'); ?>" />			<div class="clearfix"></div>		</div>		<hr class="hr-condensed" />		<div class="filters">			<select name="filter_access" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_ACCESS');?></option>				<?php echo JHtml::_('select.options', JHtml::_('access.assetgroups'), 'value', 'text', $this->state->get('filter.access'));?>			</select>			<select name="filter_published" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.published'), true);?>			</select>			<?php if ($this->state->get('filter.forcedLanguage')) : ?>			<select name="filter_category_id" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php echo JHtml::_('select.options', JHtml::_('category.options', 'com_contact', array('filter.language' => array('*', $this->state->get('filter.forcedLanguage')))), 'value', 'text', $this->state->get('filter.category_id'));?>			</select>			<input type="hidden" name="forcedLanguage" value="<?php echo $this->escape($this->state->get('filter.forcedLanguage')); ?>" />			<input type="hidden" name="filter_language" value="<?php echo $this->escape($this->state->get('filter.language')); ?>" />			<?php else : ?>			<select name="filter_category_id" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php echo JHtml::_('select.options', JHtml::_('category.options', 'com_contact'), 'value', 'text', $this->state->get('filter.category_id'));?>			</select>			<select name="filter_language" class="input-medium" onchange="this.form.submit()">				<option value=""><?php echo JText::_('JOPTION_SELECT_LANGUAGE');?></option>				<?php echo JHtml::_('select.options', JHtml::_('contentlanguage.existing', true, true), 'value', 'text', $this->state->get('filter.language'));?>			</select>			<?php endif; ?>		</div>	</fieldset>	<table class="table table-striped table-condensed">		<thead>			<tr>				<th class="title">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.name', $listDirn, $listOrder); ?>				</th>				<th class="center nowrap">					<?php echo JHtml::_('grid.sort', 'COM_CONTACT_FIELD_LINKED_USER_LABEL', 'ul.name', $listDirn, $listOrder); ?>				</th>				<th width="15%" class="center nowrap">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ACCESS', 'access_level', $listDirn, $listOrder); ?>				</th>				<th width="15%" class="center nowrap">					<?php echo JHtml::_('grid.sort', 'JCATEGORY', 'a.catid', $listDirn, $listOrder); ?>				</th>				<th width="5%" class="center nowrap">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_LANGUAGE', 'language', $listDirn, $listOrder); ?>				</th>				<th width="1%" class="center nowrap">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tfoot>			<tr>				<td colspan="6">					<?php echo $this->pagination->getListFooter(); ?>				</td>			</tr>		</tfoot>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row<?php echo $i % 2; ?>">				<td>					<a class="pointer" onclick="if (window.parent) window.parent.<?php echo $this->escape($function);?>('<?php echo $item->id; ?>', '<?php echo $this->escape(addslashes($item->name)); ?>');">						<?php echo $this->escape($item->name); ?></a>				</td>				<td align="center">					<?php if (!empty($item->linked_user)) : ?>						<?php echo $item->linked_user;?>					<?php endif; ?>				</td>				<td class="center">					<?php echo $this->escape($item->access_level); ?>				</td>				<td class="center">					<?php echo $this->escape($item->category_title); ?>				</td>				<td class="center">					<?php if ($item->language == '*'):?>						<?php echo JText::alt('JALL', 'language'); ?>					<?php else:?>						<?php echo $item->language_title ? $this->escape($item->language_title) : JText::_('JUNDEFINED'); ?>					<?php endif;?>				</td>				<td align="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<input type="hidden" name="task" value="" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;require_once __DIR__ . '/articles.php';/** * About Page Model * * @package     Joomla.Administrator * @subpackage  com_content */class ContentModelFeatured extends ContentModelArticles{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'id', 'a.id',				'title', 'a.title',				'alias', 'a.alias',				'checked_out', 'a.checked_out',				'checked_out_time', 'a.checked_out_time',				'catid', 'a.catid', 'category_title',				'state', 'a.state',				'access', 'a.access', 'access_level',				'created', 'a.created',				'created_by', 'a.created_by',				'created_by_alias', 'a.created_by_alias',				'ordering', 'a.ordering',				'featured', 'a.featured',				'language', 'a.language',				'hits', 'a.hits',				'publish_up', 'a.publish_up',				'publish_down', 'a.publish_down',				'fp.ordering',			);		}		parent::__construct($config);	}	/**	 * @param   boolean    True to join selected foreign information	 *	 * @return  string	 */	protected function getListQuery($resolveFKs = true)	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		// Select the required fields from the table.		$query->select(			$this->getState(				'list.select',				'a.id, a.title, a.alias, a.checked_out, a.checked_out_time, a.catid, a.state, a.access, a.created, a.hits,' .					'a.language, a.created_by_alias, a.publish_up, a.publish_down'			)		);		$query->from('#__content AS a');		// Join over the language		$query->select('l.title AS language_title')			->join('LEFT', $db->quoteName('#__languages') . ' AS l ON l.lang_code = a.language');		// Join over the content table.		$query->select('fp.ordering')			->join('INNER', '#__content_frontpage AS fp ON fp.content_id = a.id');		// Join over the users for the checked out user.		$query->select('uc.name AS editor')			->join('LEFT', '#__users AS uc ON uc.id=a.checked_out');		// Join over the asset groups.		$query->select('ag.title AS access_level')			->join('LEFT', '#__viewlevels AS ag ON ag.id = a.access');		// Join over the categories.		$query->select('c.title AS category_title')			->join('LEFT', '#__categories AS c ON c.id = a.catid');		// Join over the users for the author.		$query->select('ua.name AS author_name')			->join('LEFT', '#__users AS ua ON ua.id = a.created_by');		// Filter by access level.		if ($access = $this->getState('filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		// Filter by published state		$published = $this->getState('filter.published');		if (is_numeric($published))		{			$query->where('a.state = ' . (int) $published);		}		elseif ($published === '')		{			$query->where('(a.state = 0 OR a.state = 1)');		}		// Filter by a single or group of categories.		$baselevel = 1;		$categoryId = $this->getState('filter.category_id');		if (is_numeric($categoryId))		{			$cat_tbl = JTable::getInstance('Category', 'JTable');			$cat_tbl->load($categoryId);			$rgt = $cat_tbl->rgt;			$lft = $cat_tbl->lft;			$baselevel = (int) $cat_tbl->level;			$query->where('c.lft >= ' . (int) $lft)				->where('c.rgt <= ' . (int) $rgt);		}		elseif (is_array($categoryId))		{			JArrayHelper::toInteger($categoryId);			$categoryId = implode(',', $categoryId);			$query->where('a.catid IN (' . $categoryId . ')');		}		// Filter on the level.		if ($level = $this->getState('filter.level'))		{			$query->where('c.level <= ' . ((int) $level + (int) $baselevel - 1));		}		// Filter by search in title		$search = $this->getState('filter.search');		if (!empty($search))		{			if (stripos($search, 'id:') === 0)			{				$query->where('a.id = ' . (int) substr($search, 3));			}			else			{				$search = $db->quote('%' . $db->escape($search, true) . '%');				$query->where('a.title LIKE ' . $search . ' OR a.alias LIKE ' . $search);			}		}		// Filter on the language.		if ($language = $this->getState('filter.language'))		{			$query->where('a.language = ' . $db->quote($language));		}		// Add the list ordering clause.		$query->order($db->escape($this->getState('list.ordering', 'a.title')) . ' ' . $db->escape($this->getState('list.direction', 'ASC')));		//echo nl2br(str_replace('#__','jos_',(string)$query));		return $query;	}}
<?php/** * @package     Joomla.Legacy * @subpackage  Table * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Content table * * @package     Joomla.Legacy * @subpackage  Table * @since       11.1 */class JTableContent extends JTable{	/**	 * Helper object for storing and deleting tag information.	 *	 * @var    JHelperTags	 * @since  3.1	 */	protected $tagsHelper = null;	/**	 * Constructor	 *	 * @param   JDatabaseDriver  $db  A database connector object	 *	 * @since   11.1	 */	public function __construct($db)	{		parent::__construct('#__content', 'id', $db);		$this->tagsHelper = new JHelperTags();		$this->tagsHelper->typeAlias = 'com_content.article';	}	/**	 * Method to compute the default name of the asset.	 * The default name is in the form table_name.id	 * where id is the value of the primary key of the table.	 *	 * @return  string	 *	 * @since   11.1	 */	protected function _getAssetName()	{		$k = $this->_tbl_key;		return 'com_content.article.' . (int) $this->$k;	}	/**	 * Method to return the title to use for the asset table.	 *	 * @return  string	 *	 * @since   11.1	 */	protected function _getAssetTitle()	{		return $this->title;	}	/**	 * Method to get the parent asset id for the record	 *	 * @param   JTable   $table  A JTable object (optional) for the asset parent	 * @param   integer  $id     The id (optional) of the content.	 *	 * @return  integer	 *	 * @since   11.1	 */	protected function _getAssetParentId($table = null, $id = null)	{		$assetId = null;		// This is a article under a category.		if ($this->catid)		{			// Build the query to get the asset id for the parent category.			$query = $this->_db->getQuery(true)				->select($this->_db->quoteName('asset_id'))				->from($this->_db->quoteName('#__categories'))				->where($this->_db->quoteName('id') . ' = ' . (int) $this->catid);			// Get the asset id from the database.			$this->_db->setQuery($query);			if ($result = $this->_db->loadResult())			{				$assetId = (int) $result;			}		}		// Return the asset id.		if ($assetId)		{			return $assetId;		}		else		{			return parent::_getAssetParentId($table, $id);		}	}	/**	 * Overloaded bind function	 *	 * @param   array  $array   Named array	 * @param   mixed  $ignore  An optional array or space separated list of properties	 *                          to ignore while binding.	 *	 * @return  mixed  Null if operation was satisfactory, otherwise returns an error string	 *	 * @see     JTable::bind	 * @since   11.1	 */	public function bind($array, $ignore = '')	{		// Search for the {readmore} tag and split the text up accordingly.		if (isset($array['articletext']))		{			$pattern = '#<hr\s+id=("|\')system-readmore("|\')\s*\/*>#i';			$tagPos = preg_match($pattern, $array['articletext']);			if ($tagPos == 0)			{				$this->introtext = $array['articletext'];				$this->fulltext = '';			}			else			{				list ($this->introtext, $this->fulltext) = preg_split($pattern, $array['articletext'], 2);			}		}		if (isset($array['attribs']) && is_array($array['attribs']))		{			$registry = new JRegistry;			$registry->loadArray($array['attribs']);			$array['attribs'] = (string) $registry;		}		if (isset($array['metadata']) && is_array($array['metadata']))		{			$registry = new JRegistry;			$registry->loadArray($array['metadata']);			$array['metadata'] = (string) $registry;		}		// Bind the rules.		if (isset($array['rules']) && is_array($array['rules']))		{			$rules = new JAccessRules($array['rules']);			$this->setRules($rules);		}		return parent::bind($array, $ignore);	}	/**	 * Overloaded check function	 *	 * @return  boolean  True on success, false on failure	 *	 * @see     JTable::check	 * @since   11.1	 */	public function check()	{		if (trim($this->title) == '')		{			$this->setError(JText::_('COM_CONTENT_WARNING_PROVIDE_VALID_NAME'));			return false;		}		if (trim($this->alias) == '')		{			$this->alias = $this->title;		}		$this->alias = JApplication::stringURLSafe($this->alias);		if (trim(str_replace('-', '', $this->alias)) == '')		{			$this->alias = JFactory::getDate()->format('Y-m-d-H-i-s');		}		if (trim(str_replace('&nbsp;', '', $this->fulltext)) == '')		{			$this->fulltext = '';		}		// Check the publish down date is not earlier than publish up.		if ($this->publish_down > $this->_db->getNullDate() && $this->publish_down < $this->publish_up)		{			// Swap the dates.			$temp = $this->publish_up;			$this->publish_up = $this->publish_down;			$this->publish_down = $temp;		}		// Clean up keywords -- eliminate extra spaces between phrases		// and cr (\r) and lf (\n) characters from string		if (!empty($this->metakey))		{			// Only process if not empty			// Array of characters to remove			$bad_characters = array("\n", "\r", "\"", "<", ">");			// Remove bad characters			$after_clean = JString::str_ireplace($bad_characters, "", $this->metakey);			// Create array using commas as delimiter			$keys = explode(',', $after_clean);			$clean_keys = array();			foreach ($keys as $key)			{				if (trim($key))				{					// Ignore blank keywords					$clean_keys[] = trim($key);				}			}			// Put array back together delimited by ", "			$this->metakey = implode(", ", $clean_keys);		}		return true;	}	/**	 * Override parent delete method to delete tags information.	 *	 * @param   integer  $pk  Primary key to delete.	 *	 * @return  boolean  True on success.	 *	 * @since   3.1	 * @throws  UnexpectedValueException	 */	public function delete($pk = null)	{		$result = parent::delete($pk);		$this->tagsHelper->typeAlias = 'com_content.article';		return $result && $this->tagsHelper->deleteTagData($this, $pk);	}	/**	 * Overrides JTable::store to set modified data and user id.	 *	 * @param   boolean  $updateNulls  True to update fields even if they are null.	 *	 * @return  boolean  True on success.	 *	 * @since   11.1	 */	public function store($updateNulls = false)	{		$date = JFactory::getDate();		$user = JFactory::getUser();		if ($this->id)		{			// Existing item			$this->modified = $date->toSql();			$this->modified_by = $user->get('id');		}		else		{			// New article. An article created and created_by field can be set by the user,			// so we don't touch either of these if they are set.			if (!(int) $this->created)			{				$this->created = $date->toSql();			}			if (empty($this->created_by))			{				$this->created_by = $user->get('id');			}		}		// Verify that the alias is unique		$table = JTable::getInstance('Content', 'JTable');		if ($table->load(array('alias' => $this->alias, 'catid' => $this->catid)) && ($table->id != $this->id || $this->id == 0))		{			$this->setError(JText::_('JLIB_DATABASE_ERROR_ARTICLE_UNIQUE_ALIAS'));			return false;		}		$this->tagsHelper->typeAlias = 'com_content.article';		$this->tagsHelper->preStoreProcess($this);		$result = parent::store($updateNulls);		return $result && $this->tagsHelper->postStoreProcess($this);	}	/**	 * Method to set the publishing state for a row or list of rows in the database	 * table. The method respects checked out rows by other users and will attempt	 * to checkin rows that it can after adjustments are made.	 *	 * @param   mixed    $pks     An optional array of primary key values to update.  If not set the instance property value is used.	 * @param   integer  $state   The publishing state. eg. [0 = unpublished, 1 = published]	 * @param   integer  $userId  The user id of the user performing the operation.	 *	 * @return  boolean  True on success.	 *	 * @since   11.1	 */	public function publish($pks = null, $state = 1, $userId = 0)	{		$k = $this->_tbl_key;		// Sanitize input.		JArrayHelper::toInteger($pks);		$userId = (int) $userId;		$state = (int) $state;		// If there are no primary keys set check to see if the instance key is set.		if (empty($pks))		{			if ($this->$k)			{				$pks = array($this->$k);			}			// Nothing to set publishing state on, return false.			else			{				$this->setError(JText::_('JLIB_DATABASE_ERROR_NO_ROWS_SELECTED'));				return false;			}		}		// Build the WHERE clause for the primary keys.		$where = $k . '=' . implode(' OR ' . $k . '=', $pks);		// Determine if there is checkin support for the table.		if (!property_exists($this, 'checked_out') || !property_exists($this, 'checked_out_time'))		{			$checkin = '';		}		else		{			$checkin = ' AND (checked_out = 0 OR checked_out = ' . (int) $userId . ')';		}		// Get the JDatabaseQuery object		$query = $this->_db->getQuery(true);		// Update the publishing state for rows with the given primary keys.		$query->update($this->_db->quoteName($this->_tbl))			->set($this->_db->quoteName('state') . ' = ' . (int) $state)			->where('(' . $where . ')' . $checkin);		$this->_db->setQuery($query);		try		{			$this->_db->execute();		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		// If checkin is supported and all rows were adjusted, check them in.		if ($checkin && (count($pks) == $this->_db->getAffectedRows()))		{			// Checkin the rows.			foreach ($pks as $pk)			{				$this->checkin($pk);			}		}		// If the JTable instance value is in the list of primary keys that were set, set the instance.		if (in_array($this->$k, $pks))		{			$this->state = $state;		}		$this->setError('');		return true;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$class = ' class="first"';JHtml::_('bootstrap.tooltip');if (count($this->items[$this->parent->id]) > 0 && $this->maxLevelcat != 0) :?>	<?php foreach($this->items[$this->parent->id] as $id => $item) : ?>		<?php		if ($this->params->get('show_empty_categories_cat') || $item->numitems || count($item->getChildren())) :		if (!isset($this->items[$this->parent->id][$id + 1]))		{			$class = ' class="last"';		}		?>		<div <?php echo $class; ?> >		<?php $class = ''; ?>			<h3 class="page-header item-title">				<a href="<?php echo JRoute::_(WeblinksHelperRoute::getCategoryRoute($item->id));?>">					<?php echo $this->escape($item->title); ?></a>					<?php if ($this->params->get('show_cat_num_articles_cat') == 1) :?>						<span class="badge badge-info tip hasTooltip" title="<?php echo JText::_('COM_WEBLINKS_NUM_ITEMS'); ?>">							<?php echo $item->numitems; ?>						</span>					<?php endif; ?>					<?php if (count($item->getChildren()) > 0) : ?>						<a href="#category-<?php echo $item->id;?>" data-toggle="collapse" data-toggle="button" class="btn btn-mini pull-right"><span class="icon-plus"></span></a>					<?php endif;?>				</h3>				<?php if ($this->params->get('show_subcat_desc_cat') == 1) :?>					<?php if ($item->description) : ?>						<div class="category-desc">				<?php echo JHtml::_('content.prepare', $item->description, '', 'com_weblinks.categories'); ?>						</div>					<?php endif; ?>				<?php endif; ?>				<?php if (count($item->getChildren()) > 0) :?>					<div class="collapse fade" id="category-<?php echo $item->id;?>">						<?php						$this->items[$item->id] = $item->getChildren();						$this->parent = $item;						$this->maxLevelcat--;						echo $this->loadTemplate('items');						$this->parent = $item->getParent();						$this->maxLevelcat++;						?>					</div>				<?php endif; ?>			</div>		<?php endif; ?>	<?php endforeach; ?><?php endif; ?>
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;JHtml::_('bootstrap.tooltip');JHtml::_('formbehavior.chosen', 'select');JHtml::_('bootstrap.popover');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));$lang = JFactory::getLanguage();JText::script('COM_FINDER_INDEX_CONFIRM_PURGE_PROMPT');JText::script('COM_FINDER_INDEX_CONFIRM_DELETE_PROMPT');?><script type="text/javascript">Joomla.submitbutton = function(pressbutton){	if (pressbutton == 'index.purge')	{		if (confirm(Joomla.JText._('COM_FINDER_INDEX_CONFIRM_PURGE_PROMPT')))		{			Joomla.submitform(pressbutton);		}		else		{			return false;		}	}	if (pressbutton == 'index.delete')	{		if (confirm(Joomla.JText._('COM_FINDER_INDEX_CONFIRM_DELETE_PROMPT')))		{			Joomla.submitform(pressbutton);		}		else		{			return false;		}	}	Joomla.submitform(pressbutton);}</script><form action="<?php echo JRoute::_('index.php?option=com_finder&view=index');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_FINDER_FILTER_SEARCH_DESCRIPTION'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_FINDER_FILTER_SEARCH_DESCRIPTION'); ?>" />			</div>			<div class="btn-group pull-left">				<button class="btn hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button class="btn hasTooltip" type="button" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>" onclick="document.id('filter_search').value='';this.form.submit();"><i class="icon-remove"></i></button>			</div>		</div>		<div class="clearfix"> </div>		<?php if (!$this->pluginState['plg_content_finder']->enabled) : ?>			<div class="alert fade in">				<button class="close" data-dismiss="alert"></button>				<?php echo JText::_('COM_FINDER_INDEX_PLUGIN_CONTENT_NOT_ENABLED'); ?>			</div>		<?php endif; ?>		<table class="table table-striped">			<thead>				<tr>					<th width="1%" class="hidden-phone">						<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />					</th>					<th width="5%">						<?php echo JHtml::_('grid.sort', 'JSTATUS', 'l.published', $listDirn, $listOrder); ?>					</th>					<th>						<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'l.title', $listDirn, $listOrder); ?>					</th>					<th class="hidden-phone"></th>					<th width="5%" class="hidden-phone">						<?php echo JHtml::_('grid.sort', 'COM_FINDER_INDEX_HEADING_INDEX_TYPE', 'l.type_id', $listDirn, $listOrder); ?>					</th>					<th width="15%" class="hidden-phone">						<?php echo JHtml::_('grid.sort', 'COM_FINDER_INDEX_HEADING_INDEX_DATE', 'l.indexdate', $listDirn, $listOrder); ?>					</th>				</tr>			</thead>			<tbody>				<?php if (count($this->items) == 0) : ?>				<tr class="row0">					<td align="center" colspan="6">						<?php						if ($this->total == 0)						{							echo JText::_('COM_FINDER_INDEX_NO_DATA') . '  ' . JText::_('COM_FINDER_INDEX_TIP');						} else {							echo JText::_('COM_FINDER_INDEX_NO_CONTENT');						}						?>					</td>				</tr>				<?php endif; ?>				<?php $canChange = JFactory::getUser()->authorise('core.manage', 'com_finder'); ?>				<?php foreach ($this->items as $i => $item) : ?>				<tr class="row<?php echo $i % 2; ?>">					<td class="center hidden-phone">						<?php echo JHtml::_('grid.id', $i, $item->link_id); ?>					</td>					<td>						<?php echo JHtml::_('jgrid.published', $item->published, $i, 'index.', $canChange, 'cb'); ?>					</td>					<td>						<strong>							<?php echo $this->escape($item->title); ?>						</strong>						<small class="muted">						<?php							if (strlen($item->url) > 80)							{								echo substr($item->url, 0, 70) . '...';							} else {								echo $item->url;							}						?>						</small>					</td>					<td class="hidden-phone">						<?php if (intval($item->publish_start_date) or intval($item->publish_end_date) or intval($item->start_date) or intval($item->end_date)) : ?>							<i class="icon-calendar pull-right pop hasPopover" data-placement="left" title="<?php echo JText::_('JDETAILS');?>" data-content="<?php echo JText::sprintf('COM_FINDER_INDEX_DATE_INFO', $item->publish_start_date, $item->publish_end_date, $item->start_date, $item->end_date);?>"></i>						<?php endif; ?>					</td>					<td class="small nowrap hidden-phone">						<?php						$key = FinderHelperLanguage::branchSingular($item->t_title);						echo $lang->hasKey($key) ? JText::_($key) : $item->t_title;						?>					</td>					<td class="small nowrap hidden-phone">						<?php echo JHtml::_('date', $item->indexdate, JText::_('DATE_FORMAT_LC4')); ?>					</td>				</tr>				<?php endforeach; ?>			</tbody>			<tfoot>				<tr>					<td colspan="6" class="nowrap">						<?php echo $this->pagination->getListFooter(); ?>					</td>				</tr>			</tfoot>		</table>		<input type="hidden" name="task" value="display" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Index model class for Finder. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderModelIndex extends JModelList{	/**	 * The event to trigger after deleting the data.	 *	 * @var    string	 * @since  2.5	 */	protected $event_after_delete = 'onContentAfterDelete';	/**	 * The event to trigger before deleting the data.	 *	 * @var    string	 * @since  2.5	 */	protected $event_before_delete = 'onContentBeforeDelete';	/**	 * Constructor.	 *	 * @param   array  $config  An associative array of configuration settings. [optional]	 *	 * @since   2.5	 * @see     JController	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'published', 'l.published',				'title', 'l.title',				'type_id', 'l.type_id',				'url', 'l.url',				'indexdate', 'l.indexdate'			);		}		parent::__construct($config);	}	/**	 * Method to test whether a record can be deleted.	 *	 * @param   object  $record  A record object.	 *	 * @return  boolean  True if allowed to delete the record. Defaults to the permission for the component.	 *	 * @since   2.5	 */	protected function canDelete($record)	{		$user = JFactory::getUser();		return $user->authorise('core.delete', $this->option);	}	/**	 * Method to test whether a record can be deleted.	 *	 * @param   object  $record  A record object.	 *	 * @return  boolean  True if allowed to change the state of the record. Defaults to the permission for the component.	 *	 * @since   2.5	 */	protected function canEditState($record)	{		$user = JFactory::getUser();		return $user->authorise('core.edit.state', $this->option);	}	/**	 * Method to delete one or more records.	 *	 * @param   array  &$pks  An array of record primary keys.	 *	 * @return  boolean  True if successful, false if an error occurs.	 *	 * @since   2.5	 */	public function delete(&$pks)	{		$dispatcher = JEventDispatcher::getInstance();		$pks = (array) $pks;		$table = $this->getTable();		// Include the content plugins for the on delete events.		JPluginHelper::importPlugin('content');		// Iterate the items to delete each one.		foreach ($pks as $i => $pk)		{			if ($table->load($pk))			{				if ($this->canDelete($table))				{					$context = $this->option . '.' . $this->name;					// Trigger the onContentBeforeDelete event.					$result = $dispatcher->trigger($this->event_before_delete, array($context, $table));					if (in_array(false, $result, true))					{						$this->setError($table->getError());						return false;					}					if (!$table->delete($pk))					{						$this->setError($table->getError());						return false;					}					// Trigger the onContentAfterDelete event.					$dispatcher->trigger($this->event_after_delete, array($context, $table));				}				else				{					// Prune items that you can't change.					unset($pks[$i]);					$error = $this->getError();					if ($error)					{						$this->setError($error);					}					else					{						$this->setError(JText::_('JLIB_APPLICATION_ERROR_DELETE_NOT_PERMITTED'));					}				}			}			else			{				$this->setError($table->getError());				return false;			}		}		// Clear the component's cache		$this->cleanCache();		return true;	}	/**	 * Build an SQL query to load the list data.	 *	 * @return  JDatabaseQuery  A JDatabaseQuery object	 *	 * @since   2.5	 */	protected function getListQuery()	{		$db = $this->getDbo();		$query = $db->getQuery(true)			->select('l.*')			->select('t.title AS t_title')			->from($db->quoteName('#__finder_links') . ' AS l')			->join('INNER', $db->quoteName('#__finder_types') . ' AS t ON t.id = l.type_id');		// Check the type filter.		if ($this->getState('filter.type'))		{			$query->where('l.type_id = ' . (int) $this->getState('filter.type'));		}		// Check for state filter.		if (is_numeric($this->getState('filter.state')))		{			$query->where('l.published = ' . (int) $this->getState('filter.state'));		}		// Check the search phrase.		if ($this->getState('filter.search') != '')		{			$search = $db->escape($this->getState('filter.search'));			$query->where('l.title LIKE ' . $db->quote('%' . $db->escape($search) . '%') . ' OR l.url LIKE ' . $db->quote('%' . $db->escape($search) . '%') . ' OR l.indexdate LIKE  ' . $db->quote('%' . $db->escape($search) . '%'));		}		// Handle the list ordering.		$ordering = $this->getState('list.ordering');		$direction = $this->getState('list.direction');		if (!empty($ordering))		{			$query->order($db->escape($ordering) . ' ' . $db->escape($direction));		}		return $query;	}	/**	 * Method to get the state of the Smart Search plug-ins.	 *	 * @return  array   Array of relevant plug-ins and whether they are enabled or not.	 *	 * @since   2.5	 */	public function getPluginState()	{		$db = $this->getDbo();		$query = $db->getQuery(true)			->select('name, enabled')			->from($db->quoteName('#__extensions'))			->where($db->quoteName('type') . ' = ' .  $db->quote('plugin'))			->where($db->quoteName('folder') . ' IN(' .  $db->quote('system') . ',' . $db->quote('content') . ')')			->where($db->quoteName('element') . ' = ' .  $db->quote('finder'));		$db->setQuery($query);		$db->execute();		$plugins = $db->loadObjectList('name');		return $plugins;	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id  A prefix for the store id. [optional]	 *	 * @return  string  A store id.	 *	 * @since   2.5	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.state');		$id .= ':' . $this->getState('filter.type');		return parent::getStoreId($id);	}	/**	 * Returns a JTable object, always creating it.	 *	 * @param   string  $type    The table type to instantiate. [optional]	 * @param   string  $prefix  A prefix for the table class name. [optional]	 * @param   array   $config  Configuration array for model. [optional]	 *	 * @return  JTable  A database object	 *	 * @since   2.5	 */	public function getTable($type = 'Link', $prefix = 'FinderTable', $config = array())	{		return JTable::getInstance($type, $prefix, $config);	}	/**	 * Method to purge the index, deleting all links.	 *	 * @return  boolean  True on success, false on failure.	 *	 * @since   2.5	 * @throws  Exception on database error	 */	public function purge()	{		$db = $this->getDbo();		// Truncate the links table.		$db->truncateTable('#__finder_links');		// Truncate the links terms tables.		for ($i = 0; $i <= 15; $i++)		{			// Get the mapping table suffix.			$suffix = dechex($i);			$db->truncateTable('#__finder_links_terms' . $suffix);		}		// Truncate the terms table.		$db->truncateTable('#__finder_terms');		// Truncate the taxonomy map table.		$db->truncateTable('#__finder_taxonomy_map');		// Delete all the taxonomy nodes except the root.		$query = $db->getQuery(true)			->delete($db->quoteName('#__finder_taxonomy'))			->where($db->quoteName('id') . ' > 1');		$db->setQuery($query);		$db->execute();		// Truncate the tokens tables.		$db->truncateTable('#__finder_tokens');		// Truncate the tokens aggregate table.		$db->truncateTable('#__finder_tokens_aggregate');		return true;	}	/**	 * Method to auto-populate the model state.  Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field. [optional]	 * @param   string  $direction  An optional direction. [optional]	 *	 * @return  void	 *	 * @since   2.5	 */	protected function populateState($ordering = null, $direction = null)	{		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context . '.filter.search', 'filter_search');		$this->setState('filter.search', $search);		$state = $this->getUserStateFromRequest($this->context . '.filter.state', 'filter_state', '', 'string');		$this->setState('filter.state', $state);		$type = $this->getUserStateFromRequest($this->context . '.filter.type', 'filter_type', '', 'string');		$this->setState('filter.type', $type);		// Load the parameters.		$params = JComponentHelper::getParams('com_finder');		$this->setState('params', $params);		// List state information.		parent::populateState('l.title', 'asc');	}	/**	 * Method to change the published state of one or more records.	 *	 * @param   array    &$pks   A list of the primary keys to change.	 * @param   integer  $value  The value of the published state. [optional]	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	public function publish(&$pks, $value = 1)	{		$dispatcher = JEventDispatcher::getInstance();		$user = JFactory::getUser();		$table = $this->getTable();		$pks = (array) $pks;		// Include the content plugins for the change of state event.		JPluginHelper::importPlugin('content');		// Access checks.		foreach ($pks as $i => $pk)		{			$table->reset();			if ($table->load($pk))			{				if (!$this->canEditState($table))				{					// Prune items that you can't change.					unset($pks[$i]);					$this->setError(JText::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'));					return false;				}			}		}		// Attempt to change the state of the records.		if (!$table->publish($pks, $value, $user->get('id')))		{			$this->setError($table->getError());			return false;		}		$context = $this->option . '.' . $this->name;		// Trigger the onContentChangeState event.		$result = $dispatcher->trigger('onContentChangeState', array($context, $pks, $value));		if (in_array(false, $result, true))		{			$this->setError($table->getError());			return false;		}		// Clear the component's cache		$this->cleanCache();		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/* @var $this UsersViewNotes */JHtml::_('behavior.tooltip');$user = JFactory::getUser();$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn = $this->escape($this->state->get('list.direction'));$canEdit = $user->authorise('core.edit', 'com_users');?><form action="<?php echo JRoute::_('index.php?option=com_users&view=notes');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('COM_USERS_SEARCH_IN_NOTE_TITLE'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_USERS_SEARCH_IN_NOTE_TITLE'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<span class="faux-label")><?php echo JText::_('COM_USERS_FILTER_LABEL'); ?></span>			<label class="selectlabel" for="filter_category_id">				<?php echo JText::_('JOPTION_SELECT_CATEGORY'); ?>			</label>			<select name="filter_category_id" class="inputbox" id="filter_category_id" >				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php				echo JHtml::_(					'select.options', JHtml::_('category.options', 'com_users.notes'),					'value', 'text', $this->state->get('filter.category_id')				); ?>			</select>			<label class="selectlabel" for="filter_published">				<?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?>			</label>			<select name="filter_published" class="inputbox" id="filter_published">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php				echo JHtml::_(					'select.options', JHtml::_('jgrid.publishedOptions'),					'value', 'text', $this->state->get('filter.state'), true				); ?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="toggle" value="" class="checklist-toggle" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="width-15">					<?php echo JHtml::_('grid.sort', 'COM_USERS_USER_HEADING', 'u.name', $listDirn, $listOrder); ?>				</th>				<th  class="title">					<?php echo JHtml::_('grid.sort', 'COM_USERS_SUBJECT_HEADING', 'a.subject', $listDirn, $listOrder); ?>				</th>				<th class="width-20">					<?php echo JHtml::_('grid.sort', 'COM_USERS_CATEGORY_HEADING', 'c.title', $listDirn, $listOrder); ?>				</th>				<th class="width-5">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'a.state', $listDirn, $listOrder); ?>				</th>				<th class="width-10">					<?php echo JHtml::_('grid.sort', 'COM_USERS_REVIEW_HEADING', 'a.review_time', $listDirn, $listOrder); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<?php $canChange	= $user->authorise('core.edit.state',	'com_users'); ?>			<tr class="row<?php echo $i % 2; ?>">				<td class="center checklist">					<?php echo JHtml::_('grid.id', $i, $item->id); ?>				</td>				<td>					<?php if ($item->checked_out) : ?>						<?php echo JHtml::_('jgrid.checkedout', $i, $item->editor, $item->checked_out_time); ?>					<?php endif; ?>					<?php if ($canEdit) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_users&task=note.edit&id='.$item->id);?>">							<?php echo $this->escape($item->user_name); ?></a>					<?php else : ?>						<?php echo $this->escape($item->user_name); ?>					<?php endif; ?>				</td>				<td>					<?php if ($item->subject) : ?>						<?php echo $this->escape($item->subject); ?>					<?php else : ?>						<?php echo JText::_('COM_USERS_EMPTY_SUBJECT'); ?>					<?php endif; ?>				</td>				<td class="center">					<?php if ($item->catid && $item->cparams->get('image')) : ?>					<?php echo JHtml::_('users.image', $item->cparams->get('image')); ?>					<?php endif; ?>					<?php echo $this->escape($item->category_title); ?>				</td>				<td class="center">					<?php echo JHtml::_('jgrid.published', $item->state, $i, 'notes.', $canChange, 'cb', $item->publish_up, $item->publish_down); ?>				</td>				<td class="center">					<?php if ((int) $item->review_time) : ?>						<?php echo $this->escape($item->review_time); ?>					<?php else : ?>						<?php echo JText::_('COM_USERS_EMPTY_REVIEW'); ?>					<?php endif; ?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<div>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></div></form>
<?php/** * @package     Joomla.Libraries * @subpackage  Toolbar * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Renders a modal window button * * @package     Joomla.Libraries * @subpackage  Toolbar * @since       3.0 */class JToolbarButtonPopup extends JToolbarButton{	/**	 * Button type	 *	 * @var    string	 */	protected $_name = 'Popup';	/**	 * Fetch the HTML for the button	 *	 * @param   string   $type     Unused string, formerly button type.	 * @param   string   $name     Modal name, used to generate element ID	 * @param   string   $text     The link text	 * @param   string   $url      URL for popup	 * @param   integer  $width    Width of popup	 * @param   integer  $height   Height of popup	 * @param   integer  $top      Top attribute.  [@deprecated  Unused, will be removed in 4.0]	 * @param   integer  $left     Left attribute. [@deprecated  Unused, will be removed in 4.0]	 * @param   string   $onClose  JavaScript for the onClose event.	 * @param   string   $title    The title text	 *	 * @return  string  HTML string for the button	 *	 * @since   3.0	 */	public function fetchButton($type = 'Modal', $name = '', $text = '', $url = '', $width = 640, $height = 480, $top = 0, $left = 0,		$onClose = '', $title = '')	{		// If no $title is set, use the $text element		if (strlen($title) == 0)		{			$title = $text;		}		$text = JText::_($text);		$title = JText::_($title);		$class = 'out-2';		$doTask = $this->_getCommand($url);		$html = "<button class=\"btn btn-small modal\" data-toggle=\"modal\" data-target=\"#modal-" . $name . "\">\n";		$html .= "<i class=\"icon-" . $class . "\">\n";		$html .= "</i>\n";		$html .= "$text\n";		$html .= "</button>\n";		// Build the options array for the modal		$params = array();		$params['title']  = $title;		$params['url']    = $doTask;		$params['height'] = $height;		$params['width']  = $width;		$html .= JHtml::_('bootstrap.renderModal', 'modal-' . $name, $params);		// If an $onClose event is passed, add it to the modal JS object		if (strlen($onClose) >= 1)		{			$html .= "<script>\n";			$html .= "jQuery('#modal-" . $name . "').on('hide', function () {\n";			$html .= $onClose . ";\n";			$html .= "}";			$html .= ");";			$html .= "</script>\n";		}		return $html;	}	/**	 * Get the button id	 *	 * @param   string  $type  Button type	 * @param   string  $name  Button name	 *	 * @return  string	Button CSS Id	 *	 * @since   3.0	 */	public function fetchId($type, $name)	{		return $this->_parent->getName() . '-' . "popup-$name";	}	/**	 * Get the JavaScript command for the button	 *	 * @param   string  $url  URL for popup	 *	 * @return  string  JavaScript command string	 *	 * @since   3.0	 */	private function _getCommand($url)	{		if (substr($url, 0, 4) !== 'http')		{			$url = JURI::base() . $url;		}		return $url;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Profile model class for Users. * * @package     Joomla.Site * @subpackage  com_users * @since       1.6 */class UsersModelProfile extends JModelForm{	/**	 * @var		object	The user profile data.	 * @since   1.6	 */	protected $data;	/**	 * Method to check in a user.	 *	 * @param   integer		The id of the row to check out.	 * @return  boolean  True on success, false on failure.	 * @since   1.6	 */	public function checkin($userId = null)	{		// Get the user id.		$userId = (!empty($userId)) ? $userId : (int) $this->getState('user.id');		if ($userId)		{			// Initialise the table with JUser.			$table = JTable::getInstance('User');			// Attempt to check the row in.			if (!$table->checkin($userId))			{				$this->setError($table->getError());				return false;			}		}		return true;	}	/**	 * Method to check out a user for editing.	 *	 * @param   integer		The id of the row to check out.	 * @return  boolean  True on success, false on failure.	 * @since   1.6	 */	public function checkout($userId = null)	{		// Get the user id.		$userId = (!empty($userId)) ? $userId : (int) $this->getState('user.id');		if ($userId)		{			// Initialise the table with JUser.			$table = JTable::getInstance('User');			// Get the current user object.			$user = JFactory::getUser();			// Attempt to check the row out.			if (!$table->checkout($user->get('id'), $userId))			{				$this->setError($table->getError());				return false;			}		}		return true;	}	/**	 * Method to get the profile form data.	 *	 * The base form data is loaded and then an event is fired	 * for users plugins to extend the data.	 *	 * @return  mixed  	Data object on success, false on failure.	 * @since   1.6	 */	public function getData()	{		if ($this->data === null) {			$userId = $this->getState('user.id');			// Initialise the table with JUser.			$this->data	= new JUser($userId);			// Set the base user data.			$this->data->email1 = $this->data->get('email');			$this->data->email2 = $this->data->get('email');			// Override the base user data with any data in the session.			$temp = (array) JFactory::getApplication()->getUserState('com_users.edit.profile.data', array());			foreach ($temp as $k => $v)			{				$this->data->$k = $v;			}			// Unset the passwords.			unset($this->data->password1);			unset($this->data->password2);			$registry = new JRegistry($this->data->params);			$this->data->params = $registry->toArray();			// Get the dispatcher and load the users plugins.			$dispatcher	= JEventDispatcher::getInstance();			JPluginHelper::importPlugin('user');			// Trigger the data preparation event.			$results = $dispatcher->trigger('onContentPrepareData', array('com_users.profile', $this->data));			// Check for errors encountered while preparing the data.			if (count($results) && in_array(false, $results, true))			{				$this->setError($dispatcher->getError());				$this->data = false;			}		}		return $this->data;	}	/**	 * Method to get the profile form.	 *	 * The base form is loaded from XML and then an event is fired	 * for users plugins to extend the form with extra fields.	 *	 * @param   array  $data		An optional array of data for the form to interogate.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_users.profile', 'profile', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		if (!JComponentHelper::getParams('com_users')->get('change_login_name'))		{			$form->setFieldAttribute('username', 'class', '');			$form->setFieldAttribute('username', 'filter', '');			$form->setFieldAttribute('username', 'description', 'COM_USERS_PROFILE_NOCHANGE_USERNAME_DESC');			$form->setFieldAttribute('username', 'validate', '');			$form->setFieldAttribute('username', 'message', '');			$form->setFieldAttribute('username', 'readonly', 'true');			$form->setFieldAttribute('username', 'required', 'false');		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		$data = $this->getData();		$this->preprocessData('com_users.profile', $data);		return $data;	}	/**	 * Override preprocessForm to load the user plugin group instead of content.	 *	 * @param   object	A form object.	 * @param   mixed	The data expected for the form.	 * @throws	Exception if there is an error in the form event.	 * @since   1.6	 */	protected function preprocessForm(JForm $form, $data, $group = 'user')	{		if (JComponentHelper::getParams('com_users')->get('frontend_userparams'))		{			$form->loadFile('frontend', false);			if (JFactory::getUser()->authorise('core.login.admin'))			{				$form->loadFile('frontend_admin', false);			}		}		parent::preprocessForm($form, $data, $group);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState()	{		// Get the application object.		$params	= JFactory::getApplication()->getParams('com_users');		// Get the user id.		$userId = JFactory::getApplication()->getUserState('com_users.edit.profile.id');		$userId = !empty($userId) ? $userId : (int) JFactory::getUser()->get('id');		// Set the user id.		$this->setState('user.id', $userId);		// Load the parameters.		$this->setState('params', $params);	}	/**	 * Method to save the form data.	 *	 * @param   array  The form data.	 * @return  mixed  	The user id on success, false on failure.	 * @since   1.6	 */	public function save($data)	{		$userId = (!empty($data['id'])) ? $data['id'] : (int) $this->getState('user.id');		$user = new JUser($userId);		// Prepare the data for the user object.		$data['email']		= $data['email1'];		$data['password']	= $data['password1'];		// Unset the username if it should not be overwritten		if (!JComponentHelper::getParams('com_users')->get('change_login_name'))		{			unset($data['username']);		}		// Unset the block so it does not get overwritten		unset($data['block']);		// Unset the sendEmail so it does not get overwritten		unset($data['sendEmail']);		// Bind the data.		if (!$user->bind($data))		{			$this->setError(JText::sprintf('USERS PROFILE BIND FAILED', $user->getError()));			return false;		}		// Load the users plugin group.		JPluginHelper::importPlugin('user');		// Null the user groups so they don't get overwritten		$user->groups = null;		// Store the data.		if (!$user->save())		{			$this->setError($user->getError());			return false;		}		$user->tags = new JHelperTags;		$user->tags->getTagIds($user->id, 'com_users.user');		return $user->id;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');$app		= JFactory::getApplication();$user		= JFactory::getUser();$userId		= $user->get('id');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));$saveOrder	= $listOrder == 'a.ordering';$n			= count($this->items);?><form action="<?php echo JRoute::_('index.php?option=com_tags&view=tags');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_TAGS_FILTER_SEARCH_DESC'); ?>" />			<button type="submit" class="btn"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_published"><?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?></label>			<select name="filter_published" class="inputbox" id="filter_published">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?></option>				<?php echo JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.published'), true); ?>			</select>			<label class="selectlabel" for="filter_access"><?php echo JText::_('JOPTION_SELECT_ACCESS'); ?></label>			<select name="filter_access" class="inputbox" id="filter_access">				<option value=""><?php echo JText::_('JOPTION_SELECT_ACCESS'); ?></option>				<?php echo JHtml::_('select.options', JHtml::_('access.assetgroups'), 'value', 'text', $this->state->get('filter.access')); ?>			</select>			<label class="selectlabel" for="filter_author_id"><?php echo JText::_('JOPTION_SELECT_AUTHOR'); ?></label>			<select name="filter_author_id" class="inputbox"  id="filter_author_id">				<option value=""><?php echo JText::_('JOPTION_SELECT_AUTHOR'); ?></option>				<?php echo JHtml::_('select.options', $this->authors, 'value', 'text', $this->state->get('filter.author_id')); ?>			</select>			<label class="selectlabel" for="filter_language"><?php echo JText::_('JOPTION_SELECT_LANGUAGE'); ?></label>			<select name="filter_language" class="inputbox" id="filter_language">				<option value=""><?php echo JText::_('JOPTION_SELECT_LANGUAGE'); ?></option>				<?php echo JHtml::_('select.options', JHtml::_('contentlanguage.existing', true, true), 'value', 'text', $this->state->get('filter.language')); ?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="title">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<th class="nowrap state-col">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'a.published', $listDirn, $listOrder); ?>				</th>				<th class="title access-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ACCESS', 'access', $listDirn, $listOrder); ?>				<th class="language-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_LANGUAGE', 'language', $listDirn, $listOrder); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) :			$item->max_ordering = 0; //??			$canCreate  = $user->authorise('core.create',     'com_tags');			$canEdit    = $user->authorise('core.edit',       'com_tags.tag.' . $item->id);			$canCheckin = $user->authorise('core.manage',     'com_checkin') || $item->checked_out_user_id == $userId || $item->checked_out_user_id == 0;			$canChange  = $user->authorise('core.edit.state', 'com_tags.tag.' . $item->id) && $canCheckin;			?>			<tr class="row<?php echo $i % 2; ?>">				<th class="center">					<?php echo JHtml::_('grid.id', $i, $item->id); ?>				</th>				<td>					<?php if ($item->level > 0): ?>					<?php echo str_repeat('<span class="gi">&mdash;</span>', $item->level - 1) ?>					<?php endif; ?>					<?php if ($item->checked_out) : ?>						<?php echo JHtml::_('jgrid.checkedout', $i, $item->editor, $item->checked_out_time, 'tags.', $canCheckin); ?>					<?php endif; ?>					<?php if ($canEdit || $canEditOwn) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_tags&task=tag.edit&id='.$item->id); ?>">							<?php echo $this->escape($item->title); ?></a>					<?php else : ?>						<?php echo $this->escape($item->title); ?>					<?php endif; ?>					<p class="smallsub">						<?php echo JText::sprintf('JGLOBAL_LIST_ALIAS', $this->escape($item->alias)); ?></p>				</td>				<td class="center">					<?php echo JHtml::_('jgrid.published', $item->published, $i, 'tags.', $canChange, 'cb'); ?>				</td>				<td class="center">					<?php echo $this->escape($item->access_title); ?>				</td>				<td class="center">					<?php if ($item->language == '*'):?>						<?php echo JText::alt('JALL', 'language'); ?>					<?php else:?>						<?php echo $item->language_title ? $this->escape($item->language_title) : JText::_('JUNDEFINED'); ?>					<?php endif;?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php //Load the batch processing form. ?>	<?php echo $this->loadTemplate('batch'); ?>	<?php echo $this->pagination->getListFooter(); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Openstreetmap * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Openstreetmap API Elements class for the Joomla Platform * * @package     Joomla.Platform * @subpackage  Openstreetmap * * @since       13.1 */class JOpenstreetmapElements extends JOpenstreetmapObject{	/**	 * Method to create a node	 * 	 * @param   int    $changeset  change set id	 * @param   float  $latitude   latitude of the node	 * @param   float  $longitude  longitude of the node	 * @param   arary  $tags       array of tags for a node	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 */	public function createNode($changeset,$latitude,$longitude,$tags)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'node/create';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$tag_list = "";		// Create XML node		if (!empty($tags))		{			foreach ($tags as $key => $value)			{				$tag_list .= '<tag k="' . $key . '" v="' . $value . '"/>';			}		}		$xml = '<?xml version="1.0" encoding="UTF-8"?>				<osm version="0.6" generator="JOpenstreetmap">				<node changeset="' . $changeset . '" lat="' . $latitude . '" lon="' . $longitude . '">'				. $tag_list .				'</node>				</osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		return $response->body;	}	/**	 * Method to create a way	 * 	 * @param   int    $changeset  change set id	 * @param   array  $tags       array of tags for a way	 * @param   array  $nds        node ids to refer	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 */	public function createWay($changeset,$tags,$nds)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'way/create';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$tag_list = "";		// Create XML node		if (!empty($tags))		{			foreach ($tags as $key => $value)			{				$tag_list .= '<tag k="' . $key . '" v="' . $value . '"/>';			}		}		$nd_list = "";		if (!empty($nds))		{			foreach ($nds as $value)			{				$nd_list .= '<nd ref="' . $value . '"/>';			}		}		$xml = '<?xml version="1.0" encoding="UTF-8"?>				<osm version="0.6" generator="JOpenstreetmap">				<way changeset="' . $changeset . '">'					. $tag_list					. $nd_list .				'</way>			</osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		return $response->body;	}	/**	 * Method to create a relation	 * 	 * @param   int    $changeset  change set id	 * @param   array  $tags       array of tags for a relation	 * @param   array  $members    array of members for a relation 	 *                             eg:$members=array(array("type"=>"node","role"=>"stop","ref"=>"123"),array("type"=>"way","ref"=>"123"))	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 */	public function createRelation($changeset,$tags,$members)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = 'relation/create';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$tag_list = "";		// Create XML node		if (!empty($tags))		{			foreach ($tags as $key => $value)			{				$tag_list .= '<tag k="' . $key . '" v="' . $value . '"/>';			}		}		// Members		$member_list = "";		if (!empty($members))		{			foreach ($members as $member)			{				if ($member['type'] == "node")				{					$member_list .= '<member type="' . $member['type'] . '" role="' . $member['role'] . '" ref="' . $member['ref'] . '"/>';				}				elseif ($member['type'] == "way")				{					$member_list .= '<member type="' . $member['type'] . '" ref="' . $member['ref'] . '"/>';				}			}		}		$xml = '<?xml version="1.0" encoding="UTF-8"?>				<osm version="0.6" generator="JOpenstreetmap">				<relation relation="' . $changeset . '" >'					. $tag_list					. $member_list .				'</relation>			</osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		return $response->body;	}	/**	 * Method to read an Element [node|way|relation]	 *	 * @param   string  $element  [node|way|relation]	 * @param   int     $id       element identifier	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function readElement($element, $id)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		// Set the API base		$base = $element . '/' . $id;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->$element;	}	/**	 * Method to update an Element [node|way|relation]	 *	 * @param   string  $element  [node|way|relation]	 * @param   string  $xml      full reperentation of the element with a version number	 * @param   int     $id       element identifier	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function updateElement($element, $xml, $id)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = $element . '/' . $id;		// Build the request path.		$path = $this->getOption('api.url') . $base;		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		return $response->body;	}	/**	 * Method to delete an element [node|way|relation]	 * 	 * @param   string  $element    [node|way|relation]	 * @param   int     $id         element identifier	 * @param   int     $version    element versioln	 * @param   int     $changeset  changeset identifier	 * @param   float   $latitude   latitude of the element	 * @param   float   $longitude  longitude of the element	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function deleteElement($element, $id, $version, $changeset, $latitude=null, $longitude=null)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = $element . '/' . $id;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Create xml		$xml = '<?xml version="1.0" encoding="UTF-8"?>				<osm version="0.6" generator="JOpenstreetmap">				<' . $element . ' id="' . $id . '" version="' . $version . '" changeset="' . $changeset . '"';		if (!empty($latitude) && !empty($longitude))		{			$xml .= ' lat="' . $latitude . '" lon="' . $longitude . '"';		}		$xml .= '/></osm>';		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'DELETE', $parameters, $xml, $header);		return $response->body;	}	/**	 * Method to get history of an element [node|way|relation]	 *	 * @param   string  $element  [node|way|relation]	 * @param   int     $id       element identifier	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function historyOfElement($element, $id)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		// Set the API base		$base = $element . '/' . $id . '/history';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->$element;	}	/**	 * Method to get details about a version of an element [node|way|relation]	 *	 * @param   string  $element  [node|way|relation]	 * @param   int     $id       element identifier	 * @param   int     $version  element version	 * 	 * @return  array    The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function versionOfElement($element, $id ,$version)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		// Set the API base		$base = $element . '/' . $id . '/' . $version;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->$element;	}	/**	 * Method to get data about multiple ids of an element [node|way|relation]	 *	 * @param   string  $element  [nodes|ways|relations] - use plural word	 * @param   string  $params   Comma separated list ids belongto type $element	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function multiFetchElements($element, $params)	{		if ($element != 'nodes' && $element != 'ways' && $element != 'relations')		{			throw new DomainException("Element should be nodes, ways or relations");		}		// Get singular word		$single_element = substr($element, 0, strlen($element) - 1);		// Set the API base, $params is a string with comma seperated values		$base = $element . '?' . $element . "=" . $params;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->$single_element;	}	/**	 * Method to get relations for an Element [node|way|relation]	 *	 * @param   string  $element  [node|way|relation]	 * @param   int     $id       element identifier	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function relationsForElement($element, $id)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		// Set the API base		$base = $element . '/' . $id . '/relations';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->$element;	}	/**	 * Method to get ways for a Node element	 *	 * @param   int  $id  node identifier	 * 	 * @return  array    The xml response	 * 	 * @since   13.1	 */	public function waysForNode($id)	{		// Set the API base		$base = 'node/' . $id . '/ways';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->way;	}	/**	 * Method to get full information about an element [way|relation]	 *	 * @param   string  $element  [way|relation]	 * @param   int     $id       identifier	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function fullElement($element, $id)	{		if ($element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a way or a relation");		}		// Set the API base		$base = $element . '/' . $id . '/full';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$xml_string = $this->sendRequest($path);		return $xml_string->node;	}	/**	 * Method used by the DWG to hide old versions of elements containing data privacy or copyright infringements	 *  	 * @param   string  $element       [node|way|relation]	 * @param   int     $id            element identifier	 * @param   int     $version       element version	 * @param   int     $redaction_id  redaction id	 * 	 * @return  array   The xml response	 * 	 * @since   13.1	 * @throws  DomainException	 */	public function redaction($element, $id, $version, $redaction_id)	{		if ($element != 'node' && $element != 'way' && $element != 'relation')		{			throw new DomainException("Element should be a node, a way or a relation");		}		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(				'oauth_token' => $token['key']		);		// Set the API base		$base = $element . '/' . $id . '/' . $version . '/redact?redaction=' . $redaction_id;		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters);		$xml_string = simplexml_load_string($response->body);		return $xml_string;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_BASE') or die();JFormHelper::loadFieldClass('list');/** * Search Filter field for the Finder package. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class JFormFieldSearchFilter extends JFormFieldList{	/**	 * The form field type.	 *	 * @var    string	 * @since  2.5	 */	protected $type = 'SearchFilter';	/**	 * Method to get the field options.	 *	 * @return  array  The field option objects.	 *	 * @since   2.5	 */	public function getOptions()	{		$options = array();		// Build the query.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('f.title AS text, f.filter_id AS value')			->from($db->quoteName('#__finder_filters') . ' AS f')			->where('f.state = 1')			->order('f.title ASC');		$db->setQuery($query);		$options = $db->loadObjectList();		array_unshift($options, JHtml::_('select.option', '', JText::_('COM_FINDER_SELECT_SEARCH_FILTER'), 'value', 'text'));		return $options;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><fieldset class="form-horizontal">	<legend><?php echo JText::_('COM_CONFIG_DATABASE_SETTINGS'); ?></legend>	<?php	foreach ($this->form->getFieldset('database') as $field):	?>		<div class="control-group">			<div class="control-label"><?php echo $field->label; ?></div>			<div class="controls"><?php echo $field->input; ?></div>		</div>	<?php	endforeach;	?></fieldset>
<?php/** * @package    Joomla.Administrator * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Joomla! Application class * * Provide many supporting API functions * * @final * @package  Joomla.Administrator * @since    1.5 */class JAdministrator extends JApplication{	/**	 * Class constructor	 *	 * @param   array  An optional associative array of configuration settings.	 *                 Recognized key values include 'clientId' (this list is not meant to be comprehensive).	 *	 * @since   1.5	 */	public function __construct($config = array())	{		$config['clientId'] = 1;		parent::__construct($config);		//Set the root in the URI based on the application name		JURI::root(null, str_ireplace('/' . $this->getName(), '', JURI::base(true)));	}	/**	 * Initialise the application.	 *	 * @param   array  $options    An optional associative array of configuration settings.	 *	 * @return  void	 * @since   1.5	 */	public function initialise($options = array())	{		$config = JFactory::getConfig();		$user = JFactory::getUser();		// If the user is a guest we populate it with the guest user group.		if ($user->guest)		{			$guestUsergroup = JComponentHelper::getParams('com_users')->get('guest_usergroup', 1);			$user->groups = array($guestUsergroup);		}		// if a language was specified it has priority		// otherwise use user or default language settings		if (empty($options['language']))		{			$lang = $user->getParam('admin_language');			// Make sure that the user's language exists			if ($lang && JLanguage::exists($lang))			{				$options['language'] = $lang;			}			else			{				$params = JComponentHelper::getParams('com_languages');				$client = JApplicationHelper::getClientInfo($this->getClientId());				$options['language'] = $params->get($client->name, $config->get('language', 'en-GB'));			}		}		// One last check to make sure we have something		if (!JLanguage::exists($options['language']))		{			$lang = $config->get('language', 'en-GB');			if (JLanguage::exists($lang))			{				$options['language'] = $lang;			}			else			{				$options['language'] = 'en-GB'; // as a last ditch fail to english			}		}		// Execute the parent initialise method.		parent::initialise($options);		// Load Library language		$lang = JFactory::getLanguage();		$lang->load('lib_joomla', JPATH_ADMINISTRATOR);	}	/**	 * Route the application	 *	 * @return  void	 * @since   1.5	 */	public function route()	{		$uri = JURI::getInstance();		if ($this->getCfg('force_ssl') >= 1 && strtolower($uri->getScheme()) != 'https')		{			//forward to https			$uri->setScheme('https');			$this->redirect((string) $uri);		}		// Trigger the onAfterRoute event.		JPluginHelper::importPlugin('system');		$this->triggerEvent('onAfterRoute');	}	/**	 * Return a reference to the JRouter object.	 *	 * @return  JRouter	 * @since   1.5	 */	static public function getRouter($name = null, array $options = array())	{		$router = parent::getRouter('administrator');		return $router;	}	/**	 * Dispatch the application	 *	 * @param   string    $component    The component to dispatch.	 *	 * @return  void	 * @since   1.5	 */	public function dispatch($component = null)	{		if ($component === null)		{			$component = JAdministratorHelper::findOption();		}		$document = JFactory::getDocument();		$user = JFactory::getUser();		switch ($document->getType())		{			case 'html':				$document->setMetaData('keywords', $this->getCfg('MetaKeys'));				break;			default:				break;		}		$document->setTitle($this->getCfg('sitename') . ' - ' . JText::_('JADMINISTRATION'));		$document->setDescription($this->getCfg('MetaDesc'));		$document->setGenerator('Joomla! - Open Source Content Management');		$contents = JComponentHelper::renderComponent($component);		$document->setBuffer($contents, 'component');		// Trigger the onAfterDispatch event.		JPluginHelper::importPlugin('system');		$this->triggerEvent('onAfterDispatch');	}	/**	 * Display the application.	 *	 * @return  void	 * @since   1.5	 */	public function render()	{		$component = $this->input->get('option', 'com_login');		$template = $this->getTemplate(true);		$file = $this->input->get('tmpl', 'index');		if ($component == 'com_login')		{			$file = 'login';		}		// Safety check for when configuration.php root_user is in use.		$config = JFactory::getConfig();		$rootUser = $config->get('root_user');		if (property_exists('JConfig', 'root_user')			&& (JFactory::getUser()->get('username') == $rootUser || JFactory::getUser()->id === (string) $rootUser)		)		{			JError::raiseNotice(200, JText::sprintf('JWARNING_REMOVE_ROOT_USER', 'index.php?option=com_config&task=application.removeroot&' . JSession::getFormToken() . '=1'));		}		$params = array(			'template' => $template->template,			'file' => $file . '.php',			'directory' => JPATH_THEMES,			'params' => $template->params		);		$document = JFactory::getDocument();		$document->parse($params);		$this->triggerEvent('onBeforeRender');		$data = $document->render(false, $params);		JResponse::setBody($data);		$this->triggerEvent('onAfterRender');	}	/**	 * Login authentication function	 *	 * @param   array  Array('username' => string, 'password' => string)	 * @param   array  Array('remember' => boolean)	 *	 * @return  boolean True on success.	 * @see     JApplication::login	 * @since   1.5	 */	public function login($credentials, $options = array())	{		//The minimum group		$options['group'] = 'Public Backend';		//Make sure users are not autoregistered		$options['autoregister'] = false;		//Set the application login entry point		if (!array_key_exists('entry_url', $options))		{			$options['entry_url'] = JURI::base() . 'index.php?option=com_users&task=login';		}		// Set the access control action to check.		$options['action'] = 'core.login.admin';		$result = parent::login($credentials, $options);		if (!($result instanceof Exception))		{			$lang = $this->input->get('lang');			$lang = preg_replace('/[^A-Z-]/i', '', $lang);			$this->setUserState('application.lang', $lang);			self::purgeMessages();		}		return $result;	}	/**	 * Get the template	 *	 * @return  string    The template name	 * @since   1.0	 */	public function getTemplate($params = false)	{		static $template;		if (!isset($template))		{			$admin_style = JFactory::getUser()->getParam('admin_style');			// Load the template name from the database			$db = JFactory::getDbo();			$query = $db->getQuery(true)				->select('template, s.params')				->from('#__template_styles as s')				->join('LEFT', '#__extensions as e ON e.type=' . $db->quote('template') . ' AND e.element=s.template AND e.client_id=s.client_id');			if ($admin_style)			{				$query->where('s.client_id = 1 AND id = ' . (int) $admin_style . ' AND e.enabled = 1', 'OR');			}			$query->where('s.client_id = 1 AND home = ' . $db->quote('1'), 'OR')				->order('home');			$db->setQuery($query);			$template = $db->loadObject();			$template->template = JFilterInput::getInstance()->clean($template->template, 'cmd');			$template->params = new JRegistry($template->params);			if (!file_exists(JPATH_THEMES . '/' . $template->template . '/index.php'))			{				$this->enqueueMessage(JText::_('JERROR_ALERTNOTEMPLATE'), 'error');				$template->params = new JRegistry;				$template->template = 'isis';			}		}		if (!file_exists(JPATH_THEMES . '/' . $template->template . '/index.php'))		{			throw new InvalidArgumentException(JText::sprintf('JERROR_COULD_NOT_FIND_TEMPLATE', $template->template));		}		if ($params)		{			return $template;		}		return $template->template;	}	/**	 * Purge the jos_messages table of old messages	 *	 * @return  void	 * @since   1.5	 */	public static function purgeMessages()	{		$db = JFactory::getDbo();		$user = JFactory::getUser();		$userid = $user->get('id');		$query = 'SELECT *'			. ' FROM #__messages_cfg'			. ' WHERE user_id = ' . (int) $userid			. ' AND cfg_name = ' . $db->quote('auto_purge');		$db->setQuery($query);		$config = $db->loadObject();		// check if auto_purge value set		if (is_object($config) and $config->cfg_name == 'auto_purge')		{			$purge = $config->cfg_value;		}		else		{			// if no value set, default is 7 days			$purge = 7;		}		// calculation of past date		// if purge value is not 0, then allow purging of old messages		if ($purge > 0)		{			// purge old messages at day set in message configuration			$past = JFactory::getDate(time() - $purge * 86400);			$pastStamp = $past->toSql();			$query = 'DELETE FROM #__messages'				. ' WHERE date_time < ' . $db->quote($pastStamp)				. ' AND user_id_to = ' . (int) $userid;			$db->setQuery($query);			$db->execute();		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_categories * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;echo JLayoutHelper::render('joomla.edit.metadata', $this);?>
<?php/** * @package     Joomla.Plugin * @subpackage  User.profile * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;/** * An example custom profile plugin. * * @package     Joomla.Plugin * @subpackage  User.profile * @since       1.6 */class PlgUserProfile extends JPlugin{	/**	 * Date of birth.	 *	 * @var    string	 * @since  3.1	 */	private $_date = '';	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * Constructor	 *	 * @param   object  $subject  The object to observe	 * @param   array   $config   An array that holds the plugin configuration	 *	 * @since   1.5	 */	public function __construct(& $subject, $config)	{		parent::__construct($subject, $config);		JFormHelper::addFieldPath(__DIR__ . '/fields');	}	/**	 * @param   string     $context  The context for the data	 * @param   integer    $data     The user id	 *	 * @return  boolean	 *	 * @since   1.6	 */	public function onContentPrepareData($context, $data)	{		// Check we are manipulating a valid form.		if (!in_array($context, array('com_users.profile', 'com_users.user', 'com_users.registration', 'com_admin.profile')))		{			return true;		}		if (is_object($data))		{			$userId = isset($data->id) ? $data->id : 0;			if (!isset($data->profile) and $userId > 0)			{				// Load the profile data from the database.				$db = JFactory::getDbo();				$db->setQuery(					'SELECT profile_key, profile_value FROM #__user_profiles' .						' WHERE user_id = ' . (int) $userId . " AND profile_key LIKE 'profile.%'" .						' ORDER BY ordering'				);				try				{					$results = $db->loadRowList();				}				catch (RuntimeException $e)				{					$this->_subject->setError($e->getMessage());					return false;				}				// Merge the profile data.				$data->profile = array();				foreach ($results as $v)				{					$k = str_replace('profile.', '', $v[0]);					$data->profile[$k] = json_decode($v[1], true);					if ($data->profile[$k] === null)					{						$data->profile[$k] = $v[1];					}				}			}			if (!JHtml::isRegistered('users.url'))			{				JHtml::register('users.url', array(__CLASS__, 'url'));			}			if (!JHtml::isRegistered('users.calendar'))			{				JHtml::register('users.calendar', array(__CLASS__, 'calendar'));			}			if (!JHtml::isRegistered('users.tos'))			{				JHtml::register('users.tos', array(__CLASS__, 'tos'));			}		}		return true;	}	public static function url($value)	{		if (empty($value))		{			return JHtml::_('users.value', $value);		}		else		{			$value = htmlspecialchars($value);			if (substr($value, 0, 4) == "http")			{				return '<a href="' . $value . '">' . $value . '</a>';			}			else			{				return '<a href="http://' . $value . '">' . $value . '</a>';			}		}	}	public static function calendar($value)	{		if (empty($value))		{			return JHtml::_('users.value', $value);		}		else		{			return JHtml::_('date', $value, null, null);		}	}	public static function tos($value)	{		if ($value)		{			return JText::_('JYES');		}		else		{			return JText::_('JNO');		}	}	/**	 * @param   JForm    $form    The form to be altered.	 * @param   array    $data    The associated data for the form.	 *	 * @return  boolean	 * @since   1.6	 */	public function onContentPrepareForm($form, $data)	{		if (!($form instanceof JForm))		{			$this->_subject->setError('JERROR_NOT_A_FORM');			return false;		}		// Check we are manipulating a valid form.		$name = $form->getName();		if (!in_array($name, array('com_admin.profile', 'com_users.user', 'com_users.profile', 'com_users.registration')))		{			return true;		}		// Add the registration fields to the form.		JForm::addFormPath(__DIR__ . '/profiles');		$form->loadFile('profile', false);		$fields = array(			'address1',			'address2',			'city',			'region',			'country',			'postal_code',			'phone',			'website',			'favoritebook',			'aboutme',			'dob',			'tos',		);		//Change fields description when displayed in front-end		$app = JFactory::getApplication();		if ($app->isSite())		{			$form->setFieldAttribute('address1', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('address2', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('city', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('region', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('country', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('postal_code', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('phone', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('website', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('favoritebook', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('aboutme', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('dob', 'description', 'PLG_USER_PROFILE_FILL_FIELD_DESC_SITE', 'profile');			$form->setFieldAttribute('tos', 'description', 'PLG_USER_PROFILE_FIELD_TOS_DESC_SITE', 'profile');		}		$tosarticle = $this->params->get('register_tos_article');		$tosenabled = $this->params->get('register-require_tos', 0);		// We need to be in the registration form, field needs to be enabled and we need an article ID		if ($name != 'com_users.registration' || !$tosenabled || !$tosarticle)		{			// We only want the TOS in the registration form			$form->removeField('tos', 'profile');		}		else		{			// Push the TOS article ID into the TOS field.			$form->setFieldAttribute('tos', 'article', $tosarticle, 'profile');		}		foreach ($fields as $field)		{			// Case using the users manager in admin			if ($name == 'com_users.user')			{				// Remove the field if it is disabled in registration and profile				if ($this->params->get('register-require_' . $field, 1) == 0					&& $this->params->get('profile-require_' . $field, 1) == 0				)				{					$form->removeField($field, 'profile');				}			}			// Case registration			elseif ($name == 'com_users.registration')			{				// Toggle whether the field is required.				if ($this->params->get('register-require_' . $field, 1) > 0)				{					$form->setFieldAttribute($field, 'required', ($this->params->get('register-require_' . $field) == 2) ? 'required' : '', 'profile');				}				else				{					$form->removeField($field, 'profile');				}				if ($this->params->get('register-require_dob', 1) > 0)				{					$form->setFieldAttribute('spacer', 'type', 'spacer', 'profile');				}			}			// Case profile in site or admin			elseif ($name == 'com_users.profile' || $name == 'com_admin.profile')			{				// Toggle whether the field is required.				if ($this->params->get('profile-require_' . $field, 1) > 0)				{					$form->setFieldAttribute($field, 'required', ($this->params->get('profile-require_' . $field) == 2) ? 'required' : '', 'profile');				}				else				{					$form->removeField($field, 'profile');				}				if ($this->params->get('profile-require_dob', 1) > 0)				{					$form->setFieldAttribute('spacer', 'type', 'spacer', 'profile');				}			}		}		return true;	}	/**	 * Method is called before user data is stored in the database	 *	 * @param   array    $user   Holds the old user data.	 * @param   boolean  $isnew  True if a new user is stored.	 * @param   array    $data   Holds the new user data.	 *	 * @return    boolean	 *	 * @since   3.1	 * @throws    InvalidArgumentException on invalid date.	 */	public function onUserBeforeSave($user, $isnew, $data)	{		// Check that the date is valid.		if (!empty($data['profile']['dob']))		{			try			{				$date = new JDate($data['profile']['dob']);				$this->_date = $date->format('Y-m-d');			}			catch (Exception $e)			{				// Throw an exception if date is not valid.				throw new InvalidArgumentException(JText::_('PLG_USER_PROFILE_ERROR_INVALID_DOB'));			}		}		return true;	}	public function onUserAfterSave($data, $isNew, $result, $error)	{		$userId = JArrayHelper::getValue($data, 'id', 0, 'int');		if ($userId && $result && isset($data['profile']) && (count($data['profile'])))		{			try			{				// Sanitize the date				$data['profile']['dob'] = $this->_date;				$db = JFactory::getDbo();				$query = $db->getQuery(true)					->delete($db->quoteName('#__user_profiles'))					->where($db->quoteName('userid') . ' = ' . (int) $userId)					->where($db->quoteName('profile_key') . ' LIKE ' . $db->quote('profile.%'));				$db->setQuery($query);				$db->execute();				$tuples = array();				$order = 1;				foreach ($data['profile'] as $k => $v)				{					$tuples[] = '(' . $userId . ', ' . $db->quote('profile.' . $k) . ', ' . $db->quote(json_encode($v)) . ', ' . $order++ . ')';				}				$db->setQuery('INSERT INTO #__user_profiles VALUES ' . implode(', ', $tuples));				$db->execute();			}			catch (RuntimeException $e)			{				$this->_subject->setError($e->getMessage());				return false;			}		}		return true;	}	/**	 * Remove all user profile information for the given user ID	 *	 * Method is called after user data is deleted from the database	 *	 * @param   array    $user     Holds the user data	 * @param   boolean  $success  True if user was succesfully stored in the database	 * @param   string   $msg      Message	 *	 * @return  boolean	 */	public function onUserAfterDelete($user, $success, $msg)	{		if (!$success)		{			return false;		}		$userId = JArrayHelper::getValue($user, 'id', 0, 'int');		if ($userId)		{			try			{				$db = JFactory::getDbo();				$db->setQuery(					'DELETE FROM #__user_profiles WHERE user_id = ' . $userId .						" AND profile_key LIKE 'profile.%'"				);				$db->execute();			}			catch (Exception $e)			{				$this->_subject->setError($e->getMessage());				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_languages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Languages Model Class * * @package     Joomla.Administrator * @subpackage  com_languages * @since       1.6 */class LanguagesModelLanguages extends JModelList{	/**	 * Constructor.	 *	 * @param   array  An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		if (empty($config['filter_fields']))		{			$config['filter_fields'] = array(				'lang_id', 'a.lang_id',				'lang_code', 'a.lang_code',				'title', 'a.title',				'title_native', 'a.title_native',				'sef', 'a.sef',				'image', 'a.image',				'published', 'a.published',				'ordering', 'a.ordering',				'access', 'a.access', 'access_level',				'home', 'l.home',			);		}		parent::__construct($config);	}	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   1.6	 */	protected function populateState($ordering = null, $direction = null)	{		$app = JFactory::getApplication('administrator');		// Load the filter state.		$search = $this->getUserStateFromRequest($this->context . '.search', 'filter_search');		$this->setState('filter.search', $search);		$accessId = $this->getUserStateFromRequest($this->context . '.access', 'filter_access', null, 'int');		$this->setState('filter.access', $accessId);		$published = $this->getUserStateFromRequest($this->context . '.published', 'filter_published', '');		$this->setState('filter.published', $published);		// Load the parameters.		$params = JComponentHelper::getParams('com_languages');		$this->setState('params', $params);		// List state information.		parent::populateState('a.title', 'asc');	}	/**	 * Method to get a store id based on model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id    A prefix for the store id.	 *	 * @return  string  A store id.	 * @since   1.6	 */	protected function getStoreId($id = '')	{		// Compile the store id.		$id .= ':' . $this->getState('filter.search');		$id .= ':' . $this->getState('filter.access');		$id .= ':' . $this->getState('filter.published');		return parent::getStoreId($id);	}	/**	 * Method to build an SQL query to load the list data.	 *	 * @return  string    An SQL query	 * @since   1.6	 */	protected function getListQuery()	{		// Create a new query object.		$db = $this->getDbo();		$query = $db->getQuery(true);		// Select all fields from the languages table.		$query->select($this->getState('list.select', 'a.*', 'l.home'))			->from($db->quoteName('#__languages') . ' AS a');		// Join over the asset groups.		$query->select('ag.title AS access_level')			->join('LEFT', '#__viewlevels AS ag ON ag.id = a.access');		// Select the language home pages		$query->select('l.home AS home')			->join('LEFT', $db->quoteName('#__menu') . ' AS l  ON  l.language = a.lang_code AND l.home=1  AND l.language <> ' . $db->quote('*'));		// Filter on the published state.		$published = $this->getState('filter.published');		if (is_numeric($published))		{			$query->where('a.published = ' . (int) $published);		}		elseif ($published === '')		{			$query->where('(a.published IN (0, 1))');		}		// Filter by search in title		$search = $this->getState('filter.search');		if (!empty($search))		{			$search = $db->quote('%' . $db->escape($search, true) . '%', false);			$query->where('(a.title LIKE ' . $search . ')');		}		// Filter by access level.		if ($access = $this->getState('filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		// Add the list ordering clause.		$query->order($db->escape($this->getState('list.ordering', 'a.ordering')) . ' ' . $db->escape($this->getState('list.direction', 'ASC')));		return $query;	}	/**	 * Set the published language(s)	 *	 * @param   array    $cid      An array of language IDs.	 * @param   integer  $value    The value of the published state.	 *	 * @return  boolean  True on success, false otherwise.	 * @since   1.6	 */	public function setPublished($cid, $value = 0)	{		return JTable::getInstance('Language')->publish($cid, $value);	}	/**	 * Method to delete records.	 *	 * @param   array  An array of item primary keys.	 *	 * @return  boolean  Returns true on success, false on failure.	 * @since   1.6	 */	public function delete($pks)	{		// Sanitize the array.		$pks = (array) $pks;		// Get a row instance.		$table = JTable::getInstance('Language');		// Iterate the items to delete each one.		foreach ($pks as $itemId)		{			if (!$table->delete((int) $itemId))			{				$this->setError($table->getError());				return false;			}		}		// Clean the cache.		$this->cleanCache();		return true;	}	/**	 * Custom clean cache method, 2 places for 2 clients	 *	 * @since   1.6	 */	protected function cleanCache($group = null, $client_id = 0)	{		parent::cleanCache('_system');		parent::cleanCache('com_languages');	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><fieldset class="form-horizontal">	<legend><?php echo JText::_('COM_CONFIG_CACHE_SETTINGS'); ?></legend>			<?php			foreach ($this->form->getFieldset('cache') as $field):			?>				<div class="control-group">					<div class="control-label"><?php echo $field->label; ?></div>					<div class="controls"><?php echo $field->input; ?></div>				</div>			<?php			endforeach;			?>		<?php if (isset($this->data['cache_handler']) &&				$this->data['cache_handler'] == 'memcache' ||				$this->data['session_handler'] == 'memcache' ||				$this->data['cache_handler'] == 'memcached' ||				$this->data['session_handler'] == 'memcached'				) : ?>					<?php			foreach ($this->form->getFieldset('memcache') as $mfield):			?>				<div class="control-group">					<div class="control-label"><?php echo $mfield->label; ?></div>					<div class="controls"><?php echo $mfield->input; ?></div>				</div>			<?php			endforeach;			?>		<?php endif; ?></fieldset>
<?php/** * @package     Joomla.Administrator * @subpackage  com_plugins * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Plugins list controller class. * * @package     Joomla.Administrator * @subpackage  com_plugins * @since       1.6 */class PluginsControllerPlugins extends JControllerAdmin{	/**	 * Method to get a model object, loading it if required.	 *	 * @param   string  $name    The model name. Optional.	 * @param   string  $prefix  The class prefix. Optional.	 * @param   array   $config  Configuration array for model. Optional.	 *	 * @return  object  The model.	 *	 * @since   1.6	 */	public function getModel($name = 'Plugin', $prefix = 'PluginsModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}	/**	 * Method to save the submitted ordering values for records via AJAX.	 *	 * @return  void	 *	 * @since   3.0	 */	public function saveOrderAjax()	{		// Get the input		$input = JFactory::getApplication()->input;		$pks = $input->post->get('cid', array(), 'array');		$order = $input->post->get('order', array(), 'array');		// Sanitize the input		JArrayHelper::toInteger($pks);		JArrayHelper::toInteger($order);		// Get the model		$model = $this->getModel();		// Save the ordering		$return = $model->saveorder($pks, $order);		if ($return)		{			echo "1";		}		// Close the application		JFactory::getApplication()->close();	}}
<?php/** * @package     Joomla.Site * @subpackage  mod_articles_categories * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;require_once JPATH_SITE.'/components/com_content/helpers/route.php';/** * Helper for mod_articles_categories * * @package     Joomla.Site * @subpackage  mod_articles_categories */abstract class ModArticlesCategoriesHelper{	public static function getList(&$params)	{		$categories = JCategories::getInstance('Content');		$category = $categories->get($params->get('parent', 'root'));		if ($category != null)		{			$items = $category->getChildren();			if ($params->get('count', 0) > 0 && count($items) > $params->get('count', 0))			{				$items = array_slice($items, 0, $params->get('count', 0));			}			return $items;		}	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Pathway * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Class to manage the site application pathway. * * @package     Joomla.Libraries * @subpackage  Pathway * @since       1.5 */class JPathwaySite extends JPathway{	/**	 * Class constructor.	 *	 * @param   array  $options  The class options.	 *	 * @since   1.5	 */	public function __construct($options = array())	{		$this->_pathway = array();		$app  = JApplication::getInstance('site');		$menu = $app->getMenu();		if ($item = $menu->getActive())		{			$menus = $menu->getMenu();			$home  = $menu->getDefault();			if (is_object($home) && ($item->id != $home->id))			{				foreach ($item->tree as $menupath)				{					$url = '';					$link = $menu->getItem($menupath);					switch ($link->type)					{						case 'separator':						case 'heading':							$url = null;							break;						case 'url':							if ((strpos($link->link, 'index.php?') === 0) && (strpos($link->link, 'Itemid=') === false))							{								// If this is an internal Joomla link, ensure the Itemid is set.								$url = $link->link . '&Itemid=' . $link->id;							}							else							{								$url = $link->link;							}							break;						case 'alias':							// If this is an alias use the item id stored in the parameters to make the link.							$url = 'index.php?Itemid=' . $link->params->get('aliasoptions');							break;						default:							$router = JSite::getRouter();							if ($router->getMode() == JROUTER_MODE_SEF)							{								$url = 'index.php?Itemid=' . $link->id;							}							else							{								$url .= $link->link . '&Itemid=' . $link->id;							}							break;					}					$this->addItem($menus[$menupath]->title, $url);				}			}		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$clientId = $this->state->get('filter.client_id');$published = $this->state->get('filter.published');?><div class="modal hide fade" id="collapseModal">	<div class="modal-header">		<button type="button" class="close" data-dismiss="modal">x</button>		<h3><?php echo JText::_('COM_MODULES_BATCH_OPTIONS');?></h3>	</div>	<div class="modal-body">		<p><?php echo JText::_('COM_MODULES_BATCH_TIP'); ?></p>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.access');?>			</div>		</div>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('batch.language'); ?>			</div>		</div>		<?php if ($published >= 0) : ?>		<div class="control-group">			<div class="controls">				<?php echo JHtml::_('modules.positions', $clientId);?>			</div>		</div>		<?php endif; ?>	</div>	<div class="modal-footer">		<button class="btn" type="button" onclick="document.id('batch-position-id').value='';document.id('batch-access').value='';document.id('batch-language-id').value=''" data-dismiss="modal">			<?php echo JText::_('JCANCEL'); ?>		</button>		<button class="btn btn-primary" type="submit" onclick="Joomla.submitbutton('module.batch');">			<?php echo JText::_('JGLOBAL_BATCH_PROCESS'); ?>		</button>	</div></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Access checks are done internally because of different requirements for the two controllers.// Tell the browser not to cache this page.JResponse::setHeader('Expires', 'Mon, 26 Jul 1997 05:00:00 GMT', true);$controller = JControllerLegacy::getInstance('Config');$controller->execute(JFactory::getApplication()->input->get('task'));$controller->redirect();
<?php/** * @package     Joomla.Platform * @subpackage  Openstreetmap * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Openstreetmap API object class for the Joomla Platform * * @package     Joomla.Platform * @subpackage  Openstreetmap * * @since       13.1 */abstract class JOpenstreetmapObject{	/**	 * @var    JRegistry  Options for the Openstreetmap object.	 * @since  13.1	 */	protected $options;	/**	 * @var    JHttp  The HTTP client object to use in sending HTTP requests.	 * @since  13.1	 */	protected $client;	/**	 * @var JOpenstreetmapOauth The OAuth client.	 * @since 13.1	 */	protected $oauth;	/**	 * Constructor.	 *	 * @param   JRegistry            &$options  Openstreetmap options object.	 * @param   JHttp                $client    The HTTP client object.	 * @param   JOpenstreetmapOauth  $oauth     Openstreetmap oauth client	 *	 * @since   13.1	 */	public function __construct(JRegistry &$options = null, JHttp $client = null, JOpenstreetmapOauth $oauth = null)	{		$this->options = isset($options) ? $options : new JRegistry;		$this->client = isset($client) ? $client : new JHttp($this->options);		$this->oauth = $oauth;	}	/**	 * Get an option from the JOpenstreetmapObject instance.	 *	 * @param   string  $key  The name of the option to get.	 *	 * @return  mixed  The option value.	 *	 * @since   13.1	 */	public function getOption($key)	{		return $this->options->get($key);	}	/**	 * Set an option for the JOpenstreetmapObject instance.	 *	 * @param   string  $key    The name of the option to set.	 * @param   mixed   $value  The option value to set.	 *	 * @return  JOpenstreetmapObject  This object for method chaining.	 *	 * @since   13.1	 */	public function setOption($key, $value)	{		$this->options->set($key, $value);		return $this;	}	/**	 * Method to send the request which does not require authentication.	 *	 * @param   string  $path     The path of the request to make	 * @param   string  $method   The request method.	 * @param   array   $headers  The headers passed in the request.	 * @param   mixed   $data     Either an associative array or a string to be sent with the post request.	 *	 * @return  SimpleXMLElement  The XML response	 *	 * @since   13.1	 * @throws  DomainException	 */	public function sendRequest($path, $method='GET', $headers = array(), $data='')	{		// Send the request.		switch ($method)		{			case 'GET':				$response = $this->client->get($path, $headers);				break;			case 'POST':				$response = $this->client->post($path, $data, $headers);				break;		}		// Validate the response code.		if ($response->code != 200)		{			$error = htmlspecialchars($response->body);			throw new DomainException($error, $response->code);		}		$xml_string = simplexml_load_string($response->body);		return $xml_string;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('behavior.combobox');JHtml::_('formbehavior.chosen', 'select');$hasContent = empty($this->item->module) || $this->item->module == 'custom' || $this->item->module == 'mod_custom';// Get Params Fieldsets$this->fieldsets = $this->form->getFieldsets('params');$script = "Joomla.submitbutton = function(task)	{			if (task == 'module.cancel' || document.formvalidator.isValid(document.id('module-form'))) {";if ($hasContent){	$script .= $this->form->getField('content')->save();}$script .= "	Joomla.submitform(task, document.getElementById('module-form'));				if (self != top)				{					window.top.setTimeout('window.parent.SqueezeBox.close()', 1000);				}			}	}";JFactory::getDocument()->addScriptDeclaration($script);?><form action="<?php echo JRoute::_('index.php?option=com_modules&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="module-form" class="form-validate form-horizontal">	<fieldset>		<ul class="nav nav-tabs">			<li class="active"><a href="#details" data-toggle="tab"><?php echo JText::_('JDETAILS'); ?></a></li>			<li><a href="#options" data-toggle="tab"><?php echo JText::_('JOPTIONS'); ?></a></li>			<?php if ($hasContent) : ?>				<li><a href="#custom" data-toggle="tab"><?php echo JText::_('COM_MODULES_CUSTOM_OUTPUT'); ?></a></li>			<?php endif; ?>			<?php if ($this->item->client_id == 0) : ?>				<li><a href="#assignment" data-toggle="tab"><?php echo JText::_('COM_MODULES_MENU_ASSIGNMENT'); ?></a></li>			<?php endif; ?>		</ul>		<div class="tab-content">			<div class="tab-pane active" id="details">				<div class="row-fluid">					<div class="span6">						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('title'); ?>							</div>							<div class="controls">								<?php echo $this->form->getInput('title'); ?>							</div>						</div>						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('showtitle'); ?>							</div>							<div class="controls">								<?php echo $this->form->getInput('showtitle'); ?>							</div>						</div>						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('position'); ?>							</div>							<div class="controls">								<?php echo $this->loadTemplate('positions'); ?>							</div>						</div>						<hr />						<?php if ((string) $this->item->xml->name != 'Login Form') : ?>							<div class="control-group">								<div class="control-label">									<?php echo $this->form->getLabel('published'); ?>								</div>								<div class="controls">									<?php echo $this->form->getInput('published'); ?>								</div>							</div>						<?php endif; ?>						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('access'); ?>							</div>						<div class="controls">								<?php echo $this->form->getInput('access'); ?>							</div>						</div>						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('ordering'); ?>							</div>							<div class="controls">								<?php echo $this->form->getInput('ordering'); ?>							</div>						</div>						<?php if ((string) $this->item->xml->name != 'Login Form') : ?>							<div class="control-group">								<div class="control-label">									<?php echo $this->form->getLabel('publish_up'); ?>								</div>								<div class="controls">									<?php echo $this->form->getInput('publish_up'); ?>								</div>							</div>							<div class="control-group">								<div class="control-label">									<?php echo $this->form->getLabel('publish_down'); ?>								</div>								<div class="controls">									<?php echo $this->form->getInput('publish_down'); ?>								</div>							</div>						<?php endif; ?>						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('language'); ?>							</div>							<div class="controls">								<?php echo $this->form->getInput('language'); ?>							</div>						</div>						<div class="control-group">							<div class="control-label">								<?php echo $this->form->getLabel('note'); ?>							</div>							<div class="controls">								<?php echo $this->form->getInput('note'); ?>							</div>						</div>					</div>					<div class="span6">						<?php if ($this->item->xml) : ?>							<?php if ($text = trim($this->item->xml->description)) : ?>								<blockquote>									<h4>										<?php echo JText::_('COM_MODULES_MODULE_DESCRIPTION'); ?>										<?php if ($this->item->id) : ?>											<span class="label label-info"><?php echo JText::_('JGRID_HEADING_ID'); ?> : <?php echo $this->item->id; ?></span>										<?php endif; ?>									</h4>									<hr />									<div>										<?php echo JText::_($text); ?>									</div>									<hr />									<div>										<span class="label"><?php echo $this->item->client_id == 0 ? JText::_('JSITE') : JText::_('JADMINISTRATOR'); ?></span> / <span class="label"><?php if ($this->item->xml) echo ($text = (string) $this->item->xml->name) ? JText::_($text) : $this->item->module;else echo JText::_('COM_MODULES_ERR_XML');?></span>									</div>								</blockquote>							<?php endif; ?>						<?php else : ?>							<div class="alert alert-error"><?php echo JText::_('COM_MODULES_ERR_XML'); ?></div>						<?php endif; ?>					</div>				</div>			</div>			<div class="tab-pane" id="options">				<?php echo $this->loadTemplate('options'); ?>			</div>			<?php if ($hasContent) : ?>			<div class="tab-pane" id="custom">				<?php echo $this->form->getInput('content'); ?>			</div>			<?php endif; ?>			<?php if ($this->item->client_id == 0) : ?>				<div class="tab-pane" id="assignment">					<?php echo $this->loadTemplate('assignment'); ?>				</div>			<?php endif; ?>		</div>		<input type="hidden" name="task" value="" />		<?php echo JHtml::_('form.token'); ?>		<?php echo $this->form->getInput('module'); ?>		<?php echo $this->form->getInput('client_id'); ?>	</fieldset></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_messages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Message configuration model. * * @package     Joomla.Administrator * @subpackage  com_messages * @since       1.6 */class MessagesModelConfig extends JModelForm{	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState()	{		$app	= JFactory::getApplication('administrator');		$user	= JFactory::getUser();		$this->setState('user.id', $user->get('id'));		// Load the parameters.		$params	= JComponentHelper::getParams('com_messages');		$this->setState('params', $params);	}	/**	 * Method to get a single record.	 *	 * @param   integer	The id of the primary key.	 *	 * @return  mixed  Object on success, false on failure.	 */	public function &getItem()	{		$item = new JObject;		$db = $this->getDbo();		$query = $db->getQuery(true)			->select('cfg_name, cfg_value')			->from('#__messages_cfg')			->where('user_id = '.(int) $this->getState('user.id'));		$db->setQuery($query);		try		{			$rows = $db->loadObjectList();		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		foreach ($rows as $row)		{			$item->set($row->cfg_name, $row->cfg_value);		}		$this->preprocessData('com_messages.config', $item);		return $item;	}	/**	 * Method to get the record form.	 *	 * @param   array  $data		Data for the form.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_messages.config', 'config', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Method to save the form data.	 *	 * @param   array  The form data.	 * @return  boolean  True on success.	 */	public function save($data)	{		$db = $this->getDbo();		if ($userId = (int) $this->getState('user.id'))		{			$db->setQuery(				'DELETE FROM #__messages_cfg'.				' WHERE user_id = '. $userId			);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				$this->setError($e->getMessage());				return false;			}			$tuples = array();			foreach ($data as $k => $v)			{				$tuples[] = '(' . $userId.', ' . $db->quote($k) . ', ' . $db->quote($v) . ')';			}			if ($tuples)			{				$db->setQuery(					'INSERT INTO #__messages_cfg'.					' (user_id, cfg_name, cfg_value)'.					' VALUES '.implode(',', $tuples)				);				try				{				$db->execute();				}				catch (RuntimeException $e)				{					$this->setError($e->getMessage());					return false;				}			}			return true;		}		else		{			$this->setError('COM_MESSAGES_ERR_INVALID_USER');			return false;		}	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Helper * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Tags helper class, provides methods to perform various tasks relevant * tagging of content. * * @package     Joomla.Libraries * @subpackage  Helper * @since       3.1 */class JHelperTags{	/**	 * Helper object for storing and deleting tag information.	 *	 * @var    boolean	 * @since  3.1	 */	protected $tagsChanged = false;	/**	 * Whether up replace all tags or just add tags	 *	 * @var    boolean	 * @since  3.1	 */	protected $replaceTags = false;	/**	 * Alias for quering mapping and content type table.	 *	 * @var    string	 * @since  3.1	 */	public $typeAlias = null;	/**	 * Method to add tag rows to mapping table.	 *	 * @param   integer  $ucmId    Id of the #__ucm_content item being tagged	 * @param   JTable   $table    JTable object being tagged	 * @param   array    $tags     Array of tags to be applied.	 *	 * @return  boolean  true on success, otherwise false.	 *	 * @since   3.1	 */	public function addTagMapping($ucmId, $table, $tags = array())	{		$typeId = $this->typeAlias;		$db = $table->getDbo();		$key = $table->getKeyName();		$item = $table->$key;		$typeId = $this->getTypeId($this->typeAlias);		// Insert the new tag maps		$query = $db->getQuery(true);		$query->insert('#__contentitem_tag_map');		$query->columns(array($db->quoteName('type_alias'), $db->quoteName('core_content_id'), $db->quoteName('content_item_id'), $db->quoteName('tag_id'), $db->quoteName('tag_date'),  $db->quoteName('type_id')));		foreach ($tags as $tag)		{			$query->values($db->quote($this->typeAlias) . ', ' . (int) $ucmId . ', ' . (int) $item . ', ' . $db->quote($tag) . ', ' . $query->currentTimestamp() . ', ' . (int) $typeId);		}		$db->setQuery($query);		return (boolean) $db->execute();	}	/**	 * Function that converts tags paths into paths of names	 *	 * @param   array  $tags  Array of tags	 *	 * @return  array	 *	 * @since   3.1	 */	public static function convertPathsToNames($tags)	{		// We will replace path aliases with tag names		if ($tags)		{			// Create an array with all the aliases of the results			$aliases = array();			foreach ($tags as $tag)			{				if (!empty($tag->path))				{					if ($pathParts = explode('/', $tag->path))					{						$aliases = array_merge($aliases, $pathParts);					}				}			}			// Get the aliases titles in one single query and map the results			if ($aliases)			{				// Remove duplicates				$aliases = array_unique($aliases);				$db = JFactory::getDbo();				$query = $db->getQuery(true)					->select('alias, title')					->from('#__tags')					->where('alias IN (' . implode(',', array_map(array($db, 'quote'), $aliases)) . ')');				$db->setQuery($query);				try				{					$aliasesMapper = $db->loadAssocList('alias');				}				catch (RuntimeException $e)				{					return false;				}				// Rebuild the items path				if ($aliasesMapper)				{					foreach ($tags as $tag)					{						$namesPath = array();						if (!empty($tag->path))						{							if ($pathParts = explode('/', $tag->path))							{								foreach ($pathParts as $alias)								{									if (isset($aliasesMapper[$alias]))									{										$namesPath[] = $aliasesMapper[$alias]['title'];									}									else									{										$namesPath[] = $alias;									}								}								$tag->text = implode('/', $namesPath);							}						}					}				}			}		}		return $tags;	}	/**	 * Create any new tags by looking for #new# in the metadata	 *	 * @param   string  $metadata   Metadata JSON string	 *	 * @return  mixed   If successful, metadata with new tag titles replaced by tag ids. Otherwise false.	 *	 * @since   3.1	 */	public function createTagsFromMetadata($metadata)	{		$metaObject = json_decode($metadata);		$tags = $metaObject->tags;		if (empty($tags) || !is_array($tags))		{			$result = $metadata;		}		else		{			// We will use the tags table to store them			JTable::addIncludePath(JPATH_ADMINISTRATOR . '/components/com_tags/tables');			$tagTable = JTable::getInstance('Tag', 'TagsTable');			$newTags = array();			foreach ($tags as $key => $tag)			{				// Remove the #new# prefix that identifies new tags				$tagText = str_replace('#new#', '', $tag);				if ($tagText == $tag)				{					$newTags[] = (int) $tag;				}				else				{					// Clear old data if exist					$tagTable->reset();					// Try to load the selected tag					if ($tagTable->load(array('title' => $tagText)))					{						$newTags[] = (int) $tagTable->id;					}					else					{						// Prepare tag data						$tagTable->id = 0;						$tagTable->title = $tagText;						$tagTable->published = 1;						// $tagTable->language = property_exists ($item, 'language') ? $item->language : '*';						$tagTable->language = '*';						$tagTable->access = 1;						// Make this item a child of the root tag						$tagTable->setLocation($tagTable->getRootId(), 'last-child');						// Try to store tag						if ($tagTable->check())						{							// Assign the alias as path (autogenerated tags have always level 1)							$tagTable->path = $tagTable->alias;							if ($tagTable->store())							{								$newTags[] = (int) $tagTable->id;							}						}					}				}			}			// At this point $tags is an array of all tag ids			$metaObject->tags = $newTags;			$result = json_encode($metaObject);		}		return $result;	}	/**	 * Method to delete the tag mappings and #__ucm_content record for for an item	 *	 * @param   JTable   $table             JTable object of content table where delete occurred	 * @param   integer  $contentItemId     Id of the content item.	 *	 * @return  boolean  true on success, false on failure	 *	 * @since   3.1	 */	public function deleteTagData(JTable $table, $contentItemId)	{		$result = $this->unTagItem($contentItemId, $table);		$ucmContentTable = JTable::getInstance('Corecontent');		return $result && $ucmContentTable->deleteByContentId($contentItemId);	}	/**	 * Method to get a list of tags for an item, optionally with the tag data.	 *	 * @param   integer  $contentType  Content type alias. Dot separated.	 * @param   integer  $id           Id of the item to retrieve tags for.	 * @param   boolean  $getTagData   If true, data from the tags table will be included, defaults to true.	 *	 * @return  array    Array of of tag objects	 *	 * @since   3.1	 */	public function getItemTags($contentType, $id, $getTagData = true)	{		if (is_array($id))		{			$id = implode($id);		}		// Initialize some variables.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select($db->quoteName('m.tag_id'))			->from($db->quoteName('#__contentitem_tag_map') . ' AS m ')			->where(				array(					$db->quoteName('m.type_alias') . ' = ' . $db->quote($contentType),					$db->quoteName('m.content_item_id') . ' = ' . $id,					$db->quoteName('t.published') . ' = 1'				)			);		$user = JFactory::getUser();		$groups = implode(',', $user->getAuthorisedViewLevels());		$query->where('t.access IN (' . $groups . ')');		// Optionally filter on language		if (empty($language))		{			$language = JComponentHelper::getParams('com_tags')->get('tag_list_language_filter', 'all');		}		if ($language != 'all')		{			if ($language == 'current_language')			{				$language = JHelperContent::getCurrentLanguage();			}			$query->where($db->quoteName('language') . ' IN (' . $db->quote($language) . ', ' . $db->quote('*') . ')');		}		if ($getTagData)		{			$query->select($db->quoteName('t') . '.*');		}		$query->join('INNER', $db->quoteName('#__tags') . ' AS t ' . ' ON ' . $db->quoteName('m.tag_id') . ' = ' . $db->quoteName('t.id'));		$db->setQuery($query);		$this->itemTags = $db->loadObjectList();		return $this->itemTags;	}	/**	 * Method to get a list of tags for a given item.	 * Normally used for displaying a list of tags within a layout	 *	 * @param   integer  $id      The id (primary key) of the item to be tagged.	 * @param   string   $prefix  Dot separated string with the option and view to be used for a url.	 *	 * @return  string   Comma separated list of tag Ids.	 *	 * @since   3.1	 */	public function getTagIds($id, $prefix)	{		if (!empty($id))		{			if (is_array($id))			{				$id = implode(',', $id);			}			$db = JFactory::getDbo();			$query = $db->getQuery(true);			// Load the tags.			$query->clear()				->select($db->quoteName('t.id'))				->from($db->quoteName('#__tags') . ' AS t ')				->join(					'INNER', $db->quoteName('#__contentitem_tag_map') . ' AS m'					. ' ON ' . $db->quoteName('m.tag_id') . ' = ' . $db->quoteName('t.id')					. ' AND ' . $db->quoteName('m.type_alias') . ' = ' . $db->quote($prefix)					. ' AND ' . $db->quoteName('m.content_item_id') . ' IN ( ' . $id . ')'				);			$db->setQuery($query);			// Add the tags to the content data.			$tagsList = $db->loadColumn();			$this->tags = implode(',', $tagsList);		}		else		{			$this->tags = null;		}		return $this->tags;	}	/**	 * Method to get a query to retrieve a detailed list of items for a tag.	 *	 * @param   mixed    $tagId            Tag or array of tags to be matched	 * @param   mixed    $typesr           Null, type or array of type aliases for content types to be included in the results	 * @param   boolean  $includeChildren  True to include the results from child tags	 * @param   string   $orderByOption    Column to order the results by	 * @param   string   $orderDir         Direction to sort the results in	 * @param   boolean  $anyOrAll         True to include items matching at least one tag, false to include	 *                                     items all tags in the array.	 * @param   string   $languageFilter   Optional filter on language. Options are 'all', 'current' or any string.	 * @param   string   $stateFilter      Optional filtering on publication state, defaults to published or unpublished.	 *	 * @return  JDatabaseQuery  Query to retrieve a list of tags	 *	 * @since   3.1	 */	public function getTagItemsQuery($tagId, $typesr = null, $includeChildren = false, $orderByOption = 'c.core_title', $orderDir = 'ASC',		$anyOrAll = true, $languageFilter = 'all', $stateFilter = '0,1')	{		// Create a new query object.		$db = JFactory::getDbo();		$query = $db->getQuery(true);		$user = JFactory::getUser();		$nullDate = $db->quote($db->getNullDate());		$ntagsr = substr_count($tagId, ',') + 1;		// If we want to include children we have to adjust the list of tags.		// We do not search child tags when the match all option is selected.		if ($includeChildren)		{			if (!is_array($tagId))			{				$tagIdArray = explode(',', $tagId);			}			else			{				$tagIdArray = $tagId;			}			$tagTreeList = '';			foreach ($tagIdArray as $tag)			{				if ($this->getTagTreeArray($tag, $tagTreeArray))				{					$tagTreeList .= implode(',', $this->getTagTreeArray($tag, $tagTreeArray)) . ',';				}			}			if ($tagTreeList)			{				$tagId = trim($tagTreeList, ',');			}		}		if (is_array($tagId))		{			$tagId = implode(',', $tagId);		}		// M is the mapping table. C is the core_content table. Ct is the content_types table.		$query->select('m.type_alias, m.content_item_id, m.core_content_id, count(m.tag_id) AS match_count,  MAX(m.tag_date) as tag_date, MAX(c.core_title) AS core_title')			->select('MAX(c.core_alias) AS core_alias, MAX(c.core_body) AS core_body, MAX(c.core_state) AS core_state, MAX(c.core_access) AS core_access')			->select('MAX(c.core_metadata) AS core_metadata, MAX(c.core_created_user_id) AS core_created_user_id, MAX(c.core_created_by_alias) AS core_created_by_alias')			->select('MAX(c.core_created_time) as core_created_time, MAX(c.core_images) as core_images')			->select('CASE WHEN c.core_modified_time = ' . $nullDate . ' THEN c.core_created_time ELSE c.core_modified_time END as core_modified_time')			->select('MAX(c.core_language) AS core_language, MAX(c.core_catid) AS core_catid')			->select('MAX(c.core_publish_up) AS core_publish_up, MAX(c.core_publish_down) as core_publish_down')			->select('MAX(ct.type_title) AS content_type_title, MAX(ct.router) AS router')			->from('#__contentitem_tag_map AS m')			->join('INNER', '#__ucm_content AS c ON m.type_alias = c.core_type_alias AND m.core_content_id = c.core_content_id')			->join('INNER', '#__content_types AS ct ON ct.type_alias = m.type_alias')			// Join over the users for the author and email			->select("CASE WHEN c.core_created_by_alias > ' ' THEN c.core_created_by_alias ELSE ua.name END AS author")			->select("ua.email AS author_email")			->join('LEFT', '#__users AS ua ON ua.id = c.core_created_user_id')			->where('m.tag_id IN (' . $tagId . ')')			->where('c.core_state IN (' . $stateFilter . ')');		// Optionally filter on language		if (empty($language))		{			$language = $languageFilter;		}		if ($language != 'all')		{			if ($language == 'current_language')			{				$language = JHelperContent::getCurrentLanguage();			}			$query->where($db->quoteName('c.core_language') . ' IN (' . $db->quote($language) . ', ' . $db->quote('*') . ')');		}		// Get the type data, limited to types in the request if there are any specified.		$typesarray = self::getTypes('assocList', $typesr, false);		$typeAliases = '';		foreach ($typesarray as $type)		{			$typeAliases .= "'" . $type['type_alias'] . "'" . ',';		}		$typeAliases = rtrim($typeAliases, ',');		$query->where('m.type_alias IN (' . $typeAliases . ')');		$groups = '0,' . implode(',', array_unique($user->getAuthorisedViewLevels()));		$query->where('c.core_access IN (' . $groups . ')')			->group('m.type_alias, m.content_item_id, m.core_content_id');		// Use HAVING if matching all tags and we are matching more than one tag.		if ($ntagsr > 1 && $anyOrAll != 1 && $includeChildren != 1)		{			// The number of results should equal the number of tags requested.			$query->having("COUNT('m.tag_id') = " . $ntagsr);		}		// Set up the order by using the option chosen		if ($orderByOption == 'match_count')		{			$orderBy = 'COUNT(m.tag_id)';		}		else		{			$orderBy = 'MAX(' . $orderByOption . ')';		}		$query->order($orderBy . ' ' . $orderDir);		return $query;	}	/**	 * Function that converts tag ids to their tag names	 *	 * @param   array  $tagIds   array of integer tag ids.	 *	 * @return  array  An array of tag names.	 *	 * @since   3.1	 */	public function getTagNames($tagIds)	{		$tagNames = array();		if (is_array($tagIds) && count($tagIds) > 0)		{			JArrayHelper::toInteger($tagIds);			$tagIds = implode(',', $tagIds);			$db = JFactory::getDbo();			$query = $db->getQuery(true);			$query->select($db->quoteName('title'))				->from($db->quoteName('#__tags'))				->where($db->quoteName('id') . ' IN (' . $tagIds . ')');			$query->order($db->quoteName('title'));			$db->setQuery($query);			$tagNames = $db->loadColumn();		}		return $tagNames;	}	/**	 * Method to get an array of tag ids for the current tag and its children	 *	 * @param   integer  $id             An optional ID	 * @param   array    &$tagTreeArray  Array containing the tag tree	 *	 * @return  mixed	 *	 * @since   3.1	 */	public function getTagTreeArray($id, &$tagTreeArray = array())	{		// Get a level row instance.		$table = JTable::getInstance('Tag', 'TagsTable');		if ($table->isLeaf($id))		{			$tagTreeArray[] .= $id;			return $tagTreeArray;		}		$tagTree = $table->getTree($id);		// Attempt to load the tree		if ($tagTree)		{			foreach ($tagTree as $tag)			{				$tagTreeArray[] = $tag->id;			}			return $tagTreeArray;		}	}	/**	 * Method to get the type id for a type alias.	 *	 * @param   string  $typeAlias  A type alias.	 *	 * @return  string  Name of the table for a type	 *	 * @since   3.1	 */	public function getTypeId($typeAlias)	{		// Initialize some variables.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select($db->quoteName('type_id'))			->from($db->quoteName('#__content_types'))			->where($db->quoteName('type_alias') . ' = ' . $db->quote($typeAlias));		$db->setQuery($query);		$this->type_id = $db->loadResult();		return $this->type_id;	}	/**	 * Method to get a list of types with associated data.	 *	 * @param   string   $arrayType    Optionally specify that the returned list consist of objects, associative arrays, or arrays.	 *                                 Options are: rowList, assocList, and objectList	 * @param   array    $selectTypes  Optional array of type ids to limit the results to. Often from a request.	 * @param   boolean  $useAlias     If true, the alias is used to match, if false the type_id is used.	 *	 * @return  array   Array of of types	 *	 * @since   3.1	 */	public static function getTypes($arrayType = 'objectList', $selectTypes = null, $useAlias = true)	{		// Initialize some variables.		$db = JFactory::getDbo();		$query = $db->getQuery(true);		$query->select('*');		if (!empty($selectTypes))		{			if (is_array($selectTypes))			{				$selectTypes = implode(',', $selectTypes);			}			if ($useAlias)			{				$query->where($db->quoteName('type_alias') . ' IN (' . $db->quote($selectTypes) . ')');			}			else			{				$query->where($db->quoteName('type_id') . ' IN (' . $selectTypes . ')');			}		}		$query->from($db->quoteName('#__content_types'));		$db->setQuery($query);		switch ($arrayType)		{			case 'assocList':				$types = $db->loadAssocList();			break;			case 'rowList':				$types = $db->loadRowList();			break;			case 'objectList':			default:				$types = $db->loadObjectList();			break;		}		return $types;	}	/**	 * Function that handles saving tags used in a table class after a store()	 *	 * @param   JTable  $table      JTable being processed	 *	 * @return  null	 *	 * @since   3.1	 */	public function postStoreProcess($table)	{		$metaObject = json_decode($table->get('metadata'));		$tags = (isset($metaObject->tags)) ? $metaObject->tags : null;		$result = true;		// Process ucm_content and ucm_base if either tags have changed or we have some tags.		if ($this->tagsChanged || $tags)		{			if (!$tags)			{				// Delete all tags data				$key = $table->getKeyName();				$result = $this->deleteTagData($table, $table->$key);			}			else			{				// Process the tags				$rowdata = new JHelperContent;				$data = $rowdata->getRowData($table);				$ucmContentTable = JTable::getInstance('Corecontent');				$ucm = new JUcmContent($table, $this->typeAlias);				$ucmData = $data ? $ucm->mapData($data) : $ucm->ucmData;				$primaryId = $ucm->getPrimaryKey($ucmData['common']['core_type_id'], $ucmData['common']['core_content_item_id']);				$result = $ucmContentTable->load($primaryId);				$result = $result && $ucmContentTable->bind($ucmData['common']);				$result = $result && $ucmContentTable->check();				$result = $result && $ucmContentTable->store();				$ucmId = $ucmContentTable->core_content_id;				// Store the tag data if the article data was saved and run related methods.				$result = $result && $this->tagItem($ucmId, $table, json_decode($table->metadata)->tags, true);			}		}		return $result;	}	/**	 * Function that preProcesses data from a table prior to a store() to ensure proper tag handling	 *	 * @param   JTable  $table      JTable being processed	 *	 * @return  null	 *	 * @since   3.1	 */	public function preStoreProcess($table)	{		if ($newMetadata = $this->createTagsFromMetadata($table->metadata))		{			$table->metadata = $newMetadata;		}		// If existing row, check to see if tags have changed.		$oldTable = clone $table;		$oldTable->reset();		$key = $oldTable->getKeyName();		if ($oldTable->$key && $oldTable->load())		{			$oldMetaObject = json_decode($oldTable->get('metadata'));			$oldTags = (isset($oldMetaObject->tags)) ? $oldMetaObject->tags : null;			$newMetaObject = json_decode($table->get('metadata'));			$newTags = (isset($newMetaObject->tags)) ? $newMetaObject->tags : null;		}		// We need to process tags if the tags have changed or if we have a new row		$this->tagsChanged = ($oldTags != $newTags) || !$table->$key;	}	/**	 * Function to search tags	 *	 * @param   array  $filters  Filter to apply to the search	 *	 * @return  array	 *	 * @since   3.1	 */	public static function searchTags($filters = array())	{		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('a.id AS value')			->select('a.path AS text')			->select('a.path')			->from('#__tags AS a')			->join('LEFT', $db->quoteName('#__tags', 'b') . ' ON a.lft > b.lft AND a.rgt < b.rgt');		// Filter language		if (!empty($filters['flanguage']))		{			$query->where('a.language IN (' . $db->quote($filters['flanguage']) . ',' . $db->quote('*') . ') ');		}		// Do not return root		$query->where($db->quoteName('a.alias') . ' <> ' . $db->quote('root'));		// Search in title or path		if (!empty($filters['like']))		{			$query->where(				'(' . $db->quoteName('a.title') . ' LIKE ' . $db->quote('%' . $filters['like'] . '%')					. ' OR ' . $db->quoteName('a.path') . ' LIKE ' . $db->quote('%' . $filters['like'] . '%') . ')'			);		}		// Filter title		if (!empty($filters['title']))		{			$query->where($db->quoteName('a.title') . ' = ' . $db->quote($filters['title']));		}		// Filter on the published state		if (is_numeric($filters['published']))		{			$query->where('a.published = ' . (int) $filters['published']);		}		// Filter by parent_id		if (!empty($filters['parent_id']))		{			JTable::addIncludePath(JPATH_ADMINISTRATOR . '/components/com_tags/tables');			$tagTable = JTable::getInstance('Tag', 'TagsTable');			if ($children = $tagTable->getTree($filters['parent_id']))			{				foreach ($children as $child)				{					$childrenIds[] = $child->id;				}				$query->where('a.id IN (' . implode(',', $childrenIds) . ')');			}		}		$query->group('a.id, a.title, a.level, a.lft, a.rgt, a.parent_id, a.published, a.path')			->order('a.lft ASC');		// Get the options.		$db->setQuery($query);		try		{			$results = $db->loadObjectList();		}		catch (RuntimeException $e)		{			return false;		}		// We will replace path aliases with tag names		$results = self::convertPathsToNames($results);		return $results;	}	/**	 * Method to delete all instances of a tag from the mapping table. Generally used when a tag is deleted.	 *	 * @param   integer  $tag_id  The tag_id (primary key) for the deleted tag.	 *	 * @return  void	 *	 * @since   3.1	 */	public function tagDeleteInstances($tag_id)	{		// Delete the old tag maps.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->delete($db->quoteName('#__contentitem_tag_map'))			->where($db->quoteName('tag_id') . ' = ' . (int) $tag_id);		$db->setQuery($query);		$db->execute();	}	/**	 * Method to add or update tags associated with an item.	 *	 * @param   integer  $ucmId    Id of the #__ucm_content item being tagged	 * @param   JTable   $table    JTable object being tagged	 * @param   array    $tags     Array of tags to be applied.	 * @param   boolean  $replace  Flag indicating if all exising tags should be replaced	 *	 * @return  boolean  true on success, otherwise false.	 *	 * @since   3.1	 */	public function tagItem($ucmId, $table, $tags = array(), $replace = true)	{		$result = $this->unTagItem($ucmId, $table);		if ($replace)		{			$newTags = $tags;		}		else		{			$oldTags = json_decode($table->metadata)->tags;			$newTags = array_unique(array_merge($tags, $oldTags));		}		if (is_array($newTags) && count($newTags) > 0)		{			$result = $result && $this->addTagMapping($ucmId, $table, $newTags);		}		return $result;	}	/**	 * @param   integer  $contentId    Id of the content item being untagged	 * @param   JTable   $table        JTable object being untagged	 * @param   array    $tags         Array of tags to be untagged. Use an empty array to untag all existing tags.	 *	 * @return  boolean  true on success, otherwise false.	 *	 * @since   3.1	 */	public function unTagItem($contentId, $table, $tags = array())	{		$key = $table->getKeyName();		$id = $table->$key;		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->delete('#__contentitem_tag_map')			->where($db->quoteName('type_alias') . ' = ' . $db->quote($this->typeAlias))			->where($db->quoteName('content_item_id') . ' = ' . (int) $id);		if (is_array($tags) && count($tags) > 0)		{			$query->where($db->quoteName('tag_id') . ' IN ' . implode(',', $tags));		}		$db->setQuery($query);		return (boolean) $db->execute();	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;if (!JFactory::getUser()->authorise('core.manage', 'com_modules')){	return JError::raiseWarning(404, JText::_('JERROR_ALERTNOAUTHOR'));}$controller	= JControllerLegacy::getInstance('Modules');$controller->execute(JFactory::getApplication()->input->get('task'));$controller->redirect();
<?php/** * @package     Joomla.Administrator * @subpackage  Template.system * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php echo $this->language; ?>" lang="<?php echo $this->language; ?>" dir="<?php echo $this->direction; ?>" ><head>	<link rel="stylesheet" href="templates/system/css/error.css" type="text/css" /></head><body>	<table width="550" align="center" class="outline">	<tr>		<td align="center">			<h1>				<?php echo $this->error->getCode() ?> - <?php echo JText::_('JERROR_AN_ERROR_HAS_OCCURRED') ?>			</h1>		</td>	</tr>	<tr>		<td width="39%" align="center">			<p><?php echo $this->error->getMessage(); ?></p>			<p><a href="index.php"><?php echo JText::_('JGLOBAL_TPL_CPANEL_LINK_TEXT') ?></a></p>			<p>				<?php if ($this->debug) :					echo $this->renderBacktrace();				endif; ?>			</p>		</td>	</tr>	</table></body></html>
<?php/** * @package     Joomla.Site * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Profile view class for Users. * * @package     Joomla.Site * @subpackage  com_users * @since       1.6 */class UsersViewProfile extends JViewLegacy{	protected $data;	protected $form;	protected $params;	protected $state;	/**	 * Method to display the view.	 *	 * @param   string	$tpl	The template file to include	 * @since   1.6	 */	public function display($tpl = null)	{		// Get the view data.		$this->data		= $this->get('Data');		$this->form		= $this->get('Form');		$this->state	= $this->get('State');		$this->params	= $this->state->get('params');		// Check for errors.		if (count($errors = $this->get('Errors')))		{			JError::raiseError(500, implode('<br />', $errors));			return false;		}		// Check if a user was found.		if (!$this->data->id)		{			JError::raiseError(404, JText::_('JERROR_USERS_PROFILE_NOT_FOUND'));			return false;		}		$this->data->tags = new JHelperTags;		$this->data->tags->getItemTags('com_users.user.', $this->data->id);		// Check for layout override		$active = JFactory::getApplication()->getMenu()->getActive();		if (isset($active->query['layout']))		{			$this->setLayout($active->query['layout']);		}		//Escape strings for HTML output		$this->pageclass_sfx = htmlspecialchars($this->params->get('pageclass_sfx'));		$this->prepareDocument();		parent::display($tpl);	}	/**	 * Prepares the document	 *	 * @since   1.6	 */	protected function prepareDocument()	{		$app		= JFactory::getApplication();		$menus		= $app->getMenu();		$user		= JFactory::getUser();		$login		= $user->get('guest') ? true : false;		$title 		= null;		// Because the application sets a default page title,		// we need to get it from the menu item itself		$menu = $menus->getActive();		if ($menu)		{			$this->params->def('page_heading', $this->params->get('page_title', $user->name));		}		else		{			$this->params->def('page_heading', JText::_('COM_USERS_PROFILE'));		}		$title = $this->params->get('page_title', '');		if (empty($title))		{			$title = $app->getCfg('sitename');		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		if ($this->params->get('menu-meta_description'))		{			$this->document->setDescription($this->params->get('menu-meta_description'));		}		if ($this->params->get('menu-meta_keywords'))		{			$this->document->setMetadata('keywords', $this->params->get('menu-meta_keywords'));		}		if ($this->params->get('robots'))		{			$this->document->setMetadata('robots', $this->params->get('robots'));		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;jimport('joomla.filesystem.file');/** * Indexer class supporting PostgreSQL for the Finder indexer package. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       3.0 */class FinderIndexerDriverPostgresql extends FinderIndexer{	/**	 * Method to index a content item.	 *	 * @param   FinderIndexerResult  $item    The content item to index.	 * @param   string               $format  The format of the content. [optional]	 *	 * @return  integer  The ID of the record in the links table.	 *	 * @since   3.0	 * @throws  Exception on database error.	 */	public function index($item, $format = 'html')	{		// Mark beforeIndexing in the profiler.		static::$profiler ? static::$profiler->mark('beforeIndexing') : null;		$db = JFactory::getDbo();		$nd = $db->getNullDate();		// Check if the item is in the database.		$query = $db->getQuery(true)			->select($db->quoteName('link_id') . ', ' . $db->quoteName('md5sum'))			->from($db->quoteName('#__finder_links'))			->where($db->quoteName('url') . ' = ' . $db->quote($item->url));		// Load the item  from the database.		$db->setQuery($query);		$link = $db->loadObject();		// Get the indexer state.		$state = static::getState();		// Get the signatures of the item.		$curSig = static::getSignature($item);		$oldSig = isset($link->md5sum) ? $link->md5sum : null;		// Get the other item information.		$linkId = empty($link->link_id) ? null : $link->link_id;		$isNew = empty($link->link_id) ? true : false;		// Check the signatures. If they match, the item is up to date.		if (!$isNew && $curSig == $oldSig)		{			return $linkId;		}		/*		 * If the link already exists, flush all the term maps for the item.		 * Maps are stored in 16 tables so we need to iterate through and flush		 * each table one at a time.		 */		if (!$isNew)		{			for ($i = 0; $i <= 15; $i++)			{				// Flush the maps for the link.				$query->clear()					->delete($db->quoteName('#__finder_links_terms' . dechex($i)))					->where($db->quoteName('link_id') . ' = ' . (int) $linkId);				$db->setQuery($query);				$db->execute();			}			// Remove the taxonomy maps.			FinderIndexerTaxonomy::removeMaps($linkId);		}		// Mark afterUnmapping in the profiler.		static::$profiler ? static::$profiler->mark('afterUnmapping') : null;		// Perform cleanup on the item data.		$item->publish_start_date = (int) $item->publish_start_date != 0 ? $item->publish_start_date : $nd;		$item->publish_end_date = (int) $item->publish_end_date != 0 ? $item->publish_end_date : $nd;		$item->start_date = (int) $item->start_date != 0 ? $item->start_date : $nd;		$item->end_date = (int) $item->end_date != 0 ? $item->end_date : $nd;		// Prepare the item description.		$item->description = FinderIndexerHelper::parse($item->summary);		/*		 * Now, we need to enter the item into the links table. If the item		 * already exists in the database, we need to use an UPDATE query.		 * Otherwise, we need to use an INSERT to get the link id back.		 */		if ($isNew)		{			$columnsArray = array(				$db->quoteName('url'), $db->quoteName('route'), $db->quoteName('title'), $db->quoteName('description'),				$db->quoteName('indexdate'), $db->quoteName('published'), $db->quoteName('state'), $db->quoteName('access'),				$db->quoteName('language'), $db->quoteName('type_id'), $db->quoteName('object'), $db->quoteName('publish_start_date'),				$db->quoteName('publish_end_date'), $db->quoteName('start_date'), $db->quoteName('end_date'), $db->quoteName('list_price'),				$db->quoteName('sale_price')			);			// Insert the link.			$query->clear()				->insert($db->quoteName('#__finder_links'))				->columns($columnsArray)				->values(				$db->quote($item->url) . ', '				. $db->quote($item->route) . ', '				. $db->quote($item->title) . ', '				. $db->quote($item->description) . ', '				. $query->currentTimestamp() . ', '				. '1, '				. (int) $item->state . ', '				. (int) $item->access . ', '				. $db->quote($item->language) . ', '				. (int) $item->type_id . ', '				. $db->quote(serialize($item)) . ', '				. $db->quote($item->publish_start_date) . ', '				. $db->quote($item->publish_end_date) . ', '				. $db->quote($item->start_date) . ', '				. $db->quote($item->end_date) . ', '				. (double) ($item->list_price ? $item->list_price : 0) . ', '				. (double) ($item->sale_price ? $item->sale_price : 0)			);			$db->setQuery($query);			$db->execute();			// Get the link id.			$linkId = (int) $db->insertid();		}		else		{			// Update the link.			$query->clear()				->update($db->quoteName('#__finder_links'))				->set($db->quoteName('route') . ' = ' . $db->quote($item->route))				->set($db->quoteName('title') . ' = ' . $db->quote($item->title))				->set($db->quoteName('description') . ' = ' . $db->quote($item->description))				->set($db->quoteName('indexdate') . ' = ' . $query->currentTimestamp())				->set($db->quoteName('state') . ' = ' . (int) $item->state)				->set($db->quoteName('access') . ' = ' . (int) $item->access)				->set($db->quoteName('language') . ' = ' . $db->quote($item->language))				->set($db->quoteName('type_id') . ' = ' . (int) $item->type_id)				->set($db->quoteName('object') . ' = ' . $db->quote(serialize($item)))				->set($db->quoteName('publish_start_date') . ' = ' . $db->quote($item->publish_start_date))				->set($db->quoteName('publish_end_date') . ' = ' . $db->quote($item->publish_end_date))				->set($db->quoteName('start_date') . ' = ' . $db->quote($item->start_date))				->set($db->quoteName('end_date') . ' = ' . $db->quote($item->end_date))				->set($db->quoteName('list_price') . ' = ' . (double) ($item->list_price ? $item->list_price : 0))				->set($db->quoteName('sale_price') . ' = ' . (double) ($item->sale_price ? $item->sale_price : 0))				->where('link_id = ' . (int) $linkId);			$db->setQuery($query);			$db->execute();		}		// Set up the variables we will need during processing.		$tokens = array();		$count = 0;		// Mark afterLinking in the profiler.		static::$profiler ? static::$profiler->mark('afterLinking') : null;		// Truncate the tokens tables.		$db->truncateTable('#__finder_tokens');		// Truncate the tokens aggregate table.		$db->truncateTable('#__finder_tokens_aggregate');		/*		 * Process the item's content. The items can customize their		 * processing instructions to define extra properties to process		 * or rearrange how properties are weighted.		 */		foreach ($item->getInstructions() as $group => $properties)		{			// Iterate through the properties of the group.			foreach ($properties as $property)			{				// Check if the property exists in the item.				if (empty($item->$property))				{					continue;				}				// Tokenize the property.				if (is_array($item->$property))				{					// Tokenize an array of content and add it to the database.					foreach ($item->$property as $ip)					{						// If the group is path, we need to a few extra processing						// steps to strip the extension and convert slashes and dashes						// to spaces.						if ($group === static::PATH_CONTEXT)						{							$ip = JFile::stripExt($ip);							$ip = str_replace('/', ' ', $ip);							$ip = str_replace('-', ' ', $ip);						}						// Tokenize a string of content and add it to the database.						$count += $this->tokenizeToDB($ip, $group, $item->language, $format);						// Check if we're approaching the memory limit of the token table.						if ($count > static::$state->options->get('memory_table_limit', 30000))						{							$this->toggleTables(false);						}					}				}				else				{					// If the group is path, we need to a few extra processing					// steps to strip the extension and convert slashes and dashes					// to spaces.					if ($group === static::PATH_CONTEXT)					{						$item->$property = JFile::stripExt($item->$property);						$item->$property = str_replace('/', ' ', $item->$property);						$item->$property = str_replace('-', ' ', $item->$property);					}					// Tokenize a string of content and add it to the database.					$count += $this->tokenizeToDB($item->$property, $group, $item->language, $format);					// Check if we're approaching the memory limit of the token table.					if ($count > static::$state->options->get('memory_table_limit', 30000))					{						$this->toggleTables(false);					}				}			}		}		/*		 * Process the item's taxonomy. The items can customize their		 * taxonomy mappings to define extra properties to map.		 */		foreach ($item->getTaxonomy() as $branch => $nodes)		{			// Iterate through the nodes and map them to the branch.			foreach ($nodes as $node)			{				// Add the node to the tree.				$nodeId = FinderIndexerTaxonomy::addNode($branch, $node->title, $node->state, $node->access);				// Add the link => node map.				FinderIndexerTaxonomy::addMap($linkId, $nodeId);				// Tokenize the node title and add them to the database.				$count += $this->tokenizeToDB($node->title, static::META_CONTEXT, $item->language, $format);			}		}		// Mark afterProcessing in the profiler.		static::$profiler ? static::$profiler->mark('afterProcessing') : null;		/*		 * At this point, all of the item's content has been parsed, tokenized		 * and inserted into the #__finder_tokens table. Now, we need to		 * aggregate all the data into that table into a more usable form. The		 * aggregated data will be inserted into #__finder_tokens_aggregate		 * table.		 */		$query	= 'INSERT INTO ' . $db->quoteName('#__finder_tokens_aggregate') .				' (' . $db->quoteName('term_id') .				', ' . $db->quoteName('term') .				', ' . $db->quoteName('stem') .				', ' . $db->quoteName('common') .				', ' . $db->quoteName('phrase') .				', ' . $db->quoteName('term_weight') .				', ' . $db->quoteName('context') .				', ' . $db->quoteName('context_weight') .				', ' . $db->quoteName('language') . ')' .				' SELECT' .				' t.term_id, t1.term, t1.stem, t1.common, t1.phrase, t1.weight, t1.context,' .				' ROUND( t1.weight * COUNT( t2.term ) * %F, 8 ) AS context_weight, t1.language' .				' FROM (' .				'   SELECT DISTINCT t1.term, t1.stem, t1.common, t1.phrase, t1.weight, t1.context, t1.language' .				'   FROM ' . $db->quoteName('#__finder_tokens') . ' AS t1' .				'   WHERE t1.context = %d' .				' ) AS t1' .				' JOIN ' . $db->quoteName('#__finder_tokens') . ' AS t2 ON t2.term = t1.term' .				' LEFT JOIN ' . $db->quoteName('#__finder_terms') . ' AS t ON t.term = t1.term' .				' WHERE t2.context = %d' .				' GROUP BY t1.term, t.term_id, t1.term, t1.stem, t1.common, t1.phrase, t1.weight, t1.context, t1.language' .				' ORDER BY t1.term DESC';		// Iterate through the contexts and aggregate the tokens per context.		foreach ($state->weights as $context => $multiplier)		{			// Run the query to aggregate the tokens for this context..			$db->setQuery(sprintf($query, $multiplier, $context, $context));			$db->execute();		}		// Mark afterAggregating in the profiler.		static::$profiler ? static::$profiler->mark('afterAggregating') : null;		/*		 * When we pulled down all of the aggregate data, we did a LEFT JOIN		 * over the terms table to try to find all the term ids that		 * already exist for our tokens. If any of the rows in the aggregate		 * table have a term of 0, then no term record exists for that		 * term so we need to add it to the terms table.		 */		/* Emulation of IGNORE INTO behaviour */		$db->setQuery(			' SELECT ta.term' .			' FROM ' . $db->quoteName('#__finder_tokens_aggregate') . ' AS ta' .			' WHERE ta.term_id = 0'		);		if ($db->loadRow() == null)		{			$db->setQuery(				'INSERT INTO ' . $db->quoteName('#__finder_terms') .				' (' . $db->quoteName('term') .				', ' . $db->quoteName('stem') .				', ' . $db->quoteName('common') .				', ' . $db->quoteName('phrase') .				', ' . $db->quoteName('weight') .				', ' . $db->quoteName('soundex') .				', ' . $db->quoteName('language') . ')' .				' SELECT ta.term, ta.stem, ta.common, ta.phrase, ta.term_weight, SOUNDEX(ta.term), ta.language' .				' FROM ' . $db->quoteName('#__finder_tokens_aggregate') . ' AS ta' .				' WHERE ta.term_id = 0' .				' GROUP BY ta.term, ta.stem, ta.common, ta.phrase, ta.term_weight, SOUNDEX(ta.term), ta.language'			);			$db->execute();		}		/*		 * Now, we just inserted a bunch of new records into the terms table		 * so we need to go back and update the aggregate table with all the		 * new term ids.		 */		$query = $db->getQuery(true)			->update($db->quoteName('#__finder_tokens_aggregate') . ' AS ta')			->join('INNER', $db->quoteName('#__finder_terms') . ' AS t ON t.term = ta.term')			->set('ta.term_id = t.term_id')			->where('ta.term_id = 0');		$db->setQuery($query);		$db->execute();		// Mark afterTerms in the profiler.		static::$profiler ? static::$profiler->mark('afterTerms') : null;		/*		 * After we've made sure that all of the terms are in the terms table		 * and the aggregate table has the correct term ids, we need to update		 * the links counter for each term by one.		 */		$query->clear()			->update($db->quoteName('#__finder_terms') . ' AS t')			->join('INNER', $db->quoteName('#__finder_tokens_aggregate') . ' AS ta ON ta.term_id = t.term_id')			->set('t.' . $db->quoteName('links') . ' = t.links + 1');		$db->setQuery($query);		$db->execute();		// Mark afterTerms in the profiler.		static::$profiler ? static::$profiler->mark('afterTerms') : null;		/*		 * Before we can insert all of the mapping rows, we have to figure out		 * which mapping table the rows need to be inserted into. The mapping		 * table for each term is based on the first character of the md5 of		 * the first character of the term. In php, it would be expressed as		 * substr(md5(substr($token, 0, 1)), 0, 1)		 */		$query->clear()			->update($db->quoteName('#__finder_tokens_aggregate'))			->set($db->quoteName('map_suffix') . ' = SUBSTR(MD5(SUBSTR(' . $db->quoteName('term') . ', 1, 1)), 1, 1)');		$db->setQuery($query);		$db->execute();		/*		 * At this point, the aggregate table contains a record for each		 * term in each context. So, we're going to pull down all of that		 * data while grouping the records by term and add all of the		 * sub-totals together to arrive at the final total for each token for		 * this link. Then, we insert all of that data into the appropriate		 * mapping table.		 */		for ($i = 0; $i <= 15; $i++)		{			// Get the mapping table suffix.			$suffix = dechex($i);			/*			 * We have to run this query 16 times, one for each link => term			 * mapping table.			 */			$db->setQuery(				'INSERT INTO ' . $db->quoteName('#__finder_links_terms' . $suffix) .				' (' . $db->quoteName('link_id') .				', ' . $db->quoteName('term_id') .				', ' . $db->quoteName('weight') . ')' .				' SELECT ' . (int) $linkId . ', ' . $db->quoteName('term_id') . ',' .				' ROUND(SUM(' . $db->quoteName('context_weight') . '), 8)' .				' FROM ' . $db->quoteName('#__finder_tokens_aggregate') .				' WHERE ' . $db->quoteName('map_suffix') . ' = ' . $db->quote($suffix) .				' GROUP BY ' . $db->quoteName('term') .				' ORDER BY ' . $db->quoteName('term') . ' DESC'			);			$db->execute();		}		// Mark afterMapping in the profiler.		static::$profiler ? static::$profiler->mark('afterMapping') : null;		// Update the signature.		$query->clear()			->update($db->quoteName('#__finder_links'))			->set($db->quoteName('md5sum') . ' = ' . $db->quote($curSig))			->where($db->quoteName('link_id') . ' = ' . $db->quote($linkId));		$db->setQuery($query);		$db->execute();		// Mark afterSigning in the profiler.		static::$profiler ? static::$profiler->mark('afterSigning') : null;		// Truncate the tokens tables.		$db->truncateTable('#__finder_tokens');		// Truncate the tokens aggregate table.		$db->truncateTable('#__finder_tokens_aggregate');		// Toggle the token tables back to memory tables.		$this->toggleTables(true);		// Mark afterTruncating in the profiler.		static::$profiler ? static::$profiler->mark('afterTruncating') : null;		return $linkId;	}	/**	 * Method to remove a link from the index.	 *	 * @param   integer  $linkId  The id of the link.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function remove($linkId)	{		$db = JFactory::getDbo();		$query = $db->getQuery(true);		// Get the indexer state.		$state = static::getState();		// Update the link counts and remove the mapping records.		for ($i = 0; $i <= 15; $i++)		{			// Update the link counts for the terms.			$query->update($db->quoteName('#__finder_terms') . ' AS t')				->join('INNER', $db->quoteName('#__finder_links_terms' . dechex($i)) . ' AS m ON m.term_id = t.term_id')				->set('t.links = t.links - 1')				->where('m.link_id = ' . $db->quote((int) $linkId));			$db->setQuery($query);			$db->execute();			// Remove all records from the mapping tables.			$query->clear()				->delete($db->quoteName('#__finder_links_terms' . dechex($i)))				->where($db->quoteName('link_id') . ' = ' . (int) $linkId);			$db->setQuery($query);			$db->execute();		}		// Delete all orphaned terms.		$query->clear()			->delete($db->quoteName('#__finder_terms'))			->where($db->quoteName('links') . ' <= 0');		$db->setQuery($query);		$db->execute();		// Delete the link from the index.		$query->clear()			->delete($db->quoteName('#__finder_links'))			->where($db->quoteName('link_id') . ' = ' . $db->quote((int) $linkId));		$db->setQuery($query);		$db->execute();		// Remove the taxonomy maps.		FinderIndexerTaxonomy::removeMaps($linkId);		// Remove the orphaned taxonomy nodes.		FinderIndexerTaxonomy::removeOrphanNodes();		return true;	}	/**	 * Method to optimize the index. We use this method to remove unused terms	 * and any other optimizations that might be necessary.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function optimize()	{		// Get the database object.		$db = JFactory::getDbo();		$query = $db->getQuery(true);		// Delete all orphaned terms.		$query->delete($db->quoteName('#__finder_terms'))			->where($db->quoteName('links') . ' <= 0');		$db->setQuery($query);		$db->execute();		// Optimize the links table.		$db->setQuery('VACUUM ' . $db->quoteName('#__finder_links'));		$db->execute();		$db->setQuery('REINDEX TABLE ' . $db->quoteName('#__finder_links'));		$db->execute();		for ($i = 0; $i <= 15; $i++)		{			// Optimize the terms mapping table.			$db->setQuery('VACUUM ' . $db->quoteName('#__finder_links_terms' . dechex($i)));			$db->execute();			$db->setQuery('REINDEX TABLE ' . $db->quoteName('#__finder_links_terms' . dechex($i)));			$db->execute();		}		// Optimize the terms mapping table.		$db->setQuery('REINDEX TABLE ' . $db->quoteName('#__finder_links_terms'));		$db->execute();		// Remove the orphaned taxonomy nodes.		FinderIndexerTaxonomy::removeOrphanNodes();		// Optimize the taxonomy mapping table.		$db->setQuery('REINDEX TABLE ' . $db->quoteName('#__finder_taxonomy_map'));		$db->execute();		return true;	}	/**	 * Method to add a set of tokens to the database.	 *	 * @param   mixed  $tokens   An array or single FinderIndexerToken object.	 * @param   mixed  $context  The context of the tokens. See context constants. [optional]	 *	 * @return  integer  The number of tokens inserted into the database.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	protected function addTokensToDB($tokens, $context = '')	{		// Get the database object.		$db = JFactory::getDbo();		$query = $db->getQuery(true);		// Force tokens to an array.		$tokens = is_array($tokens) ? $tokens : array($tokens);		// Count the number of token values.		$values = 0;		// Insert the tokens into the database.		$query->insert($db->quoteName('#__finder_tokens'))			->columns(				array(					$db->quoteName('term'),					$db->quoteName('stem'),					$db->quoteName('common'),					$db->quoteName('phrase'),					$db->quoteName('weight'),					$db->quoteName('context'),					$db->quoteName('language')				)			);		// Iterate through the tokens to create SQL value sets.		foreach ($tokens as $token)		{			$query->values(				$db->quote($token->term) . ', '					. $db->quote($token->stem) . ', '					. (int) $token->common . ', '					. (int) $token->phrase . ', '					. (float) $token->weight . ', '					. (int) $context . ', '					. $db->quote($token->language)			);			$values++;		}		$db->setQuery($query);		$db->execute();		return $values;	}	/**	 * Method to switch the token tables from Memory tables to MyISAM tables	 * when they are close to running out of memory.	 *	 * @param   boolean  $memory  Flag to control how they should be toggled.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	protected function toggleTables($memory)	{		return true;	}}
<?php/** * @package     Joomla.Site * @subpackage  Layout * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><ol class="nav nav-tabs nav-stacked"><?php foreach ($displayData->get('link_items') as $item) : ?>	<li>		<a href="<?php echo JRoute::_(ContentHelperRoute::getArticleRoute($item->slug, $item->catslug)); ?>">			<?php echo $item->title; ?></a>	</li><?php endforeach; ?></ol>
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.tooltip');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));$lang = JFactory::getLanguage();JText::script('COM_FINDER_INDEX_CONFIRM_PURGE_PROMPT');JText::script('COM_FINDER_INDEX_CONFIRM_DELETE_PROMPT');?><script type="text/javascript">Joomla.submitbutton = function(pressbutton){	if (pressbutton == 'index.purge')	{		if (confirm(Joomla.JText._('COM_FINDER_INDEX_CONFIRM_PURGE_PROMPT')))		{			Joomla.submitform(pressbutton);		}		else		{			return false;		}	}	if (pressbutton == 'index.delete')	{		if (confirm(Joomla.JText._('COM_FINDER_INDEX_CONFIRM_DELETE_PROMPT')))		{			Joomla.submitform(pressbutton);		}		else		{			return false;		}	}	Joomla.submitform(pressbutton);}</script><form action="<?php echo JRoute::_('index.php?option=com_finder&view=index');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::sprintf('COM_FINDER_SEARCH_LABEL', JText::_('COM_FINDER_ITEMS')); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::sprintf('COM_FINDER_SEARCH_LABEL', JText::_('COM_FINDER_ITEMS')); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_FINDER_FILTER_SEARCH_DESCRIPTION'); ?>" />			<button type="submit" class="btn"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_type"><?php echo JText::_('COM_FINDER_INDEX_TYPE_FILTER'); ?></label>			<select name="filter_type" class="inputbox" id="filter_type">				<option value=""><?php echo JText::_('COM_FINDER_INDEX_TYPE_FILTER'); ?></option>				<?php echo JHtml::_('select.options', JHtml::_('finder.typeslist'), 'value', 'text', $this->state->get('filter.type'));?>			</select>			<label class="selectlabel" for="filter_state"><?php echo JText::_('COM_FINDER_INDEX_FILTER_BY_STATE'); ?></label>			<select name="filter_state" class="inputbox" id="filter_state">				<option value=""><?php echo JText::_('COM_FINDER_INDEX_FILTER_BY_STATE');?></option>				<?php echo JHtml::_('select.options', JHtml::_('finder.statelist'), 'value', 'text', $this->state->get('filter.state'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="title">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'l.title', $listDirn, $listOrder); ?>				</th>				<th class="nowrap state-col">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'l.published', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-5">					<?php echo JHtml::_('grid.sort', 'COM_FINDER_INDEX_HEADING_INDEX_TYPE', 'l.type_id', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-20">					<?php echo JHtml::_('grid.sort', 'COM_FINDER_INDEX_HEADING_LINK_URL', 'l.url', $listDirn, $listOrder); ?>				</th>				<th class="title date-col">					<?php echo JHtml::_('grid.sort', 'COM_FINDER_INDEX_HEADING_INDEX_DATE', 'l.indexdate', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php if (count($this->items) == 0) : ?>			<tr class="row0">				<td align="center" colspan="7">					<?php					if ($this->total == 0)					{						echo JText::_('COM_FINDER_INDEX_NO_DATA') . '  ' . JText::_('COM_FINDER_INDEX_TIP');					} else {						echo JText::_('COM_FINDER_INDEX_NO_CONTENT');					}					?>				</td>			</tr>		<?php endif; ?>		<?php $canChange	= JFactory::getUser()->authorise('core.manage',	'com_finder'); ?>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row<?php echo $i % 2; ?>">				<th class="center">					<?php echo JHtml::_('grid.id', $i, $item->link_id); ?>				</th>				<td>					<?php if ((int) $item->publish_start_date or (int) $item->publish_end_date or (int) $item->start_date or (int) $item->end_date) : ?>					<img src="<?php echo JURI::root();?>/media/system/images/calendar.png" style="border:1px;float:right" class="hasTip" title="<?php echo JText::sprintf('COM_FINDER_INDEX_DATE_INFO', $item->publish_start_date, $item->publish_end_date, $item->start_date, $item->end_date);?>" />					<?php endif; ?>					<?php echo $this->escape($item->title); ?>				</td>				<td class="center nowrap">					<?php echo JHtml::_('jgrid.published', $item->published, $i, 'index.', $canChange, 'cb'); ?>				</td>				<td class="center nowrap">					<?php					$key = FinderHelperLanguage::branchSingular($item->t_title);					echo $lang->hasKey($key) ? JText::_($key) : $item->t_title;					?>				</td>				<td class="nowrap">					<?php					if (strlen($item->url) > 80)					{						echo substr($item->url, 0, 70) . '...';					} else {						echo $item->url;					}					?>				</td>				<td class="center nowrap">					<?php echo JHtml::_('date', $item->indexdate, JText::_('DATE_FORMAT_LC4')); ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<input type="hidden" name="task" value="display" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Linkedin * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Linkedin API Social Stream class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  Linkedin * @since       13.1 */class JLinkedinStream extends JLinkedinObject{	/**	 * Method to add a new share. Note: post must contain comment and/or (title and url).	 *	 * @param   string   $visibility   One of anyone: all members or connections-only: connections only.	 * @param   string   $comment      Text of member's comment.	 * @param   string   $title        Title of shared document.	 * @param   string   $url          URL for shared content.	 * @param   string   $image        URL for image of shared content.	 * @param   string   $description  Description of shared content.	 * @param   boolean  $twitter      True to have LinkedIn pass the status message along to a member's tethered Twitter account.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 * @throws  RuntimeException	 */	public function share($visibility, $comment = null, $title = null, $url = null, $image = null, $description = null, $twitter = false)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the success response code.		$this->oauth->setOption('success_code', 201);		// Set the API base		$base = '/v1/people/~/shares';		// Check if twitter is true.		if ($twitter)		{			$base .= '?twitter-post=true';		}		// Build xml.		$xml = '<share>				  <visibility>					 <code>' . $visibility . '</code>				  </visibility>';		// Check if comment specified.		if ($comment)		{			$xml .= '<comment>' . $comment . '</comment>';		}		// Check if title and url are specified.		if ($title && $url)		{			$xml .= '<content>					   <title>' . $title . '</title>					   <submitted-url>' . $url . '</submitted-url>';			// Check if image is specified.			if ($image)			{				$xml .= '<submitted-image-url>' . $image . '</submitted-image-url>';			}			// Check if descrption id specified.			if ($description)			{				$xml .= '<description>' . $description . '</description>';			}			$xml .= '</content>';		}		elseif (!$comment)		{			throw new RuntimeException('Post must contain comment and/or (title and url).');		}		$xml .= '</share>';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'POST', $parameters, $xml, $header);		return $response;	}	/**	 * Method to reshare an existing share.	 *	 * @param   string   $visibility  One of anyone: all members or connections-only: connections only.	 * @param   string   $id          The unique identifier for a share.	 * @param   string   $comment     Text of member's comment.	 * @param   boolean  $twitter     True to have LinkedIn pass the status message along to a member's tethered Twitter account.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 * @throws  RuntimeException	 */	public function reshare($visibility, $id, $comment = null, $twitter = false)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the success response code.		$this->oauth->setOption('success_code', 201);		// Set the API base		$base = '/v1/people/~/shares';		// Check if twitter is true.		if ($twitter)		{			$base .= '?twitter-post=true';		}		// Build xml.		$xml = '<share>				  <visibility>					 <code>' . $visibility . '</code>				  </visibility>';		// Check if comment specified.		if ($comment)		{			$xml .= '<comment>' . $comment . '</comment>';		}		$xml .= '   <attribution>					   <share>					   	  <id>' . $id . '</id>					   </share>					</attribution>				 </share>';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'POST', $parameters, $xml, $header);		return $response;	}	/**	 * Method to get a particular member's current share.	 *	 * @param   string  $id   Member id of the profile you want.	 * @param   string  $url  The public profile URL.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getCurrentShare($id = null, $url = null)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/';		// Check if a member id is specified.		if ($id)		{			$base .= 'id=' . $id;		}		elseif (!$url)		{			$base .= '~';		}		// Check if profile url is specified.		if ($url)		{			$base .= 'url=' . $this->oauth->safeEncode($url);		}		$base .= ':(current-share)';		// Set request parameters.		$data['format'] = 'json';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to get a particular member's current share.	 *	 * @param   string   $id    Member id of the profile you want.	 * @param   string   $url   The public profile URL.	 * @param   boolean  $self  Used to return member's feed. Omitted to return aggregated network feed.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getShareStream($id = null, $url = null, $self = true)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/';		// Check if a member id is specified.		if ($id)		{			$base .= $id;		}		elseif (!$url)		{			$base .= '~';		}		// Check if profile url is specified.		if ($url)		{			$base .= 'url=' . $this->oauth->safeEncode($url);		}		$base .= '/network';		// Set request parameters.		$data['format'] = 'json';		$data['type'] = 'SHAR';		// Check if self is true		if ($self)		{			$data['scope'] = 'self';		}		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to get the users network updates.	 *	 * @param   string   $id      Member id.	 * @param   boolean  $self    Used to return member's feed. Omitted to return aggregated network feed.	 * @param   mixed    $type    String containing any valid Network Update Type from the table or an array of strings	 * 							  to specify more than one Network Update type.	 * @param   integer  $count   Number of updates to return, with a maximum of 250.	 * @param   integer  $start   The offset by which to start Network Update pagination.	 * @param   string   $after   Timestamp after which to retrieve updates.	 * @param   string   $before  Timestamp before which to retrieve updates.	 * @param   boolean  $hidden  Whether to display updates from people the member has chosen to "hide" from their update stream.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getNetworkUpdates($id = null, $self = true, $type = null, $count = 0, $start = 0, $after = null, $before = null,		$hidden = false)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/';		// Check if a member id is specified.		if ($id)		{			$base .= $id;		}		else		{			$base .= '~';		}		$base .= '/network/updates';		// Set request parameters.		$data['format'] = 'json';		// Check if self is true.		if ($self)		{			$data['scope'] = 'self';		}		// Check if type is specified.		if ($type)		{			$data['type'] = $type;		}		// Check if count is specified.		if ($count > 0)		{			$data['count'] = $count;		}		// Check if start is specified.		if ($start > 0)		{			$data['start'] = $start;		}		// Check if after is specified.		if ($after)		{			$data['after'] = $after;		}		// Check if before is specified.		if ($before > 0)		{			$data['before'] = $before;		}		// Check if hidden is true.		if ($hidden)		{			$data['hidden'] = $hidden;		}		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to get information about the current member's network.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getNetworkStats()	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/~/network/network-stats';		// Set request parameters.		$data['format'] = 'json';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to get the users network updates.	 *	 * @param   string  $body  The actual content of the update. You can use HTML to include links to the user name and the content the user	 *                         created. Other HTML tags are not supported. All body text should be HTML entity escaped and UTF-8 compliant.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function postNetworkUpdate($body)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the success response code.		$this->oauth->setOption('success_code', 201);		// Set the API base		$base = '/v1/people/~/person-activities';		// Build the xml.		$xml = '<activity locale="en_US">					<content-type>linkedin-html</content-type>				    <body>' . $body . '</body>				</activity>';		$header['Content-Type'] = 'text/xml';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'POST', $parameters, $xml, $header);		return $response;	}	/**	 * Method to retrieve all comments for a given network update.	 *	 * @param   string  $key  update/update-key representing an update.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getComments($key)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/~/network/updates/key=' . $key . '/update-comments';		// Set request parameters.		$data['format'] = 'json';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to post a new comment to an existing update.	 *	 * @param   string  $key      update/update-key representing an update.	 * @param   string  $comment  Maximum length of 700 characters	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function postComment($key, $comment)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the success response code.		$this->oauth->setOption('success_code', 201);		// Set the API base		$base = '/v1/people/~/network/updates/key=' . $key . '/update-comments';		// Build the xml.		$xml = '<update-comment>				  <comment>' . $comment . '</comment>				</update-comment>';		$header['Content-Type'] = 'text/xml';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'POST', $parameters, $xml, $header);		return $response;	}	/**	 * Method to retrieve the complete list of people who liked an update.	 *	 * @param   string  $key  update/update-key representing an update.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function getLikes($key)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the API base		$base = '/v1/people/~/network/updates/key=' . $key . '/likes';		// Set request parameters.		$data['format'] = 'json';		// Build the request path.		$path = $this->getOption('api.url') . $base;		// Send the request.		$response = $this->oauth->oauthRequest($path, 'GET', $parameters, $data);		return json_decode($response->body);	}	/**	 * Method to like or unlike an update.	 *	 * @param   string   $key   Update/update-key representing an update.	 * @param   boolean  $like  True to like update, false otherwise.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	private function _likeUnlike($key, $like)	{		$token = $this->oauth->getToken();		// Set parameters.		$parameters = array(			'oauth_token' => $token['key']		);		// Set the success response code.		$this->oauth->setOption('success_code', 204);		// Set the API base		$base = '/v1/people/~/network/updates/key=' . $key . '/is-liked';		// Build xml.		$xml = '<is-liked>' . $this->booleanToString($like) . '</is-liked>';		// Build the request path.		$path = $this->getOption('api.url') . $base;		$header['Content-Type'] = 'text/xml';		// Send the request.		$response = $this->oauth->oauthRequest($path, 'PUT', $parameters, $xml, $header);		return $response;	}	/**	 * Method used to like an update.	 *	 * @param   string  $key  Update/update-key representing an update.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function like($key)	{		return $this->_likeUnlike($key, true);	}	/**	 * Method used to unlike an update.	 *	 * @param   string  $key  Update/update-key representing an update.	 *	 * @return  array  The decoded JSON response	 *	 * @since   13.1	 */	public function unlike($key)	{		return $this->_likeUnlike($key, false);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * @package     Joomla.Administrator * @subpackage  com_installer * @since       2.5 */abstract class InstallerHtmlManage{	/**	 * Returns a published state on a grid	 *	 * @param   integer       $value			The state value.	 * @param   integer       $i				The row index	 * @param   boolean       $enabled			An optional setting for access control on the action.	 * @param   string        $checkbox			An optional prefix for checkboxes.	 *	 * @return  string        The Html code	 *	 * @see JHtmlJGrid::state	 *	 * @since   2.5	 */	public static function state($value, $i, $enabled = true, $checkbox = 'cb')	{		$states	= array(			2	=> array(				'',				'COM_INSTALLER_EXTENSION_PROTECTED',				'',				'COM_INSTALLER_EXTENSION_PROTECTED',				false,				'protected',				'protected'			),			1	=> array(				'unpublish',				'COM_INSTALLER_EXTENSION_ENABLED',				'COM_INSTALLER_EXTENSION_DISABLE',				'COM_INSTALLER_EXTENSION_ENABLED',				false,				'publish',				'publish'			),			0	=> array(				'publish',				'COM_INSTALLER_EXTENSION_DISABLED',				'COM_INSTALLER_EXTENSION_ENABLE',				'COM_INSTALLER_EXTENSION_DISABLED',				false,				'unpublish',				'unpublish'			),		);		return JHtml::_('jgrid.state', $states, $value, $i, 'manage.', $enabled, true, $checkbox);	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Finder.Categories * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_BASE') or die;require_once JPATH_ADMINISTRATOR . '/components/com_finder/helpers/indexer/adapter.php';/** * Finder adapter for Joomla Categories. * * @package     Joomla.Plugin * @subpackage  Finder.Categories * @since       2.5 */class PlgFinderCategories extends FinderIndexerAdapter{	/**	 * The plugin identifier.	 *	 * @var    string	 * @since  2.5	 */	protected $context = 'Categories';	/**	 * The extension name.	 *	 * @var    string	 * @since  2.5	 */	protected $extension = 'com_categories';	/**	 * The sublayout to use when rendering the results.	 *	 * @var    string	 * @since  2.5	 */	protected $layout = 'category';	/**	 * The type of content that the adapter indexes.	 *	 * @var    string	 * @since  2.5	 */	protected $type_title = 'Category';	/**	 * The table name.	 *	 * @var    string	 * @since  2.5	 */	protected $table = '#__categories';	/**	 * The field the published state is stored in.	 *	 * @var    string	 * @since  2.5	 */	protected $state_field = 'published';	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * Method to remove the link information for items that have been deleted.	 *	 * @param   string  $context  The context of the action being performed.	 * @param   JTable  $table    A JTable object containing the record to be deleted	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderDelete($context, $table)	{		if ($context == 'com_categories.category')		{			$id = $table->id;		}		elseif ($context == 'com_finder.index')		{			$id = $table->link_id;		}		else		{			return true;		}		// Remove the items.		return $this->remove($id);	}	/**	 * Method to determine if the access level of an item changed.	 *	 * @param   string   $context  The context of the content passed to the plugin.	 * @param   JTable   $row      A JTable object	 * @param   boolean  $isNew    If the content has just been created	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderAfterSave($context, $row, $isNew)	{		// We only want to handle categories here		if ($context == 'com_categories.category')		{			// Check if the access levels are different			if (!$isNew && $this->old_access != $row->access)			{				// Process the change.				$this->itemAccessChange($row);				// Reindex the item				$this->reindex($row->id);			}			// Check if the parent access level is different			if (!$isNew && $this->old_cataccess != $row->access)			{				$this->categoryAccessChange($row);			}		}		return true;	}	/**	 * Method to reindex the link information for an item that has been saved.	 * This event is fired before the data is actually saved so we are going	 * to queue the item to be indexed later.	 *	 * @param   string   $context  The context of the content passed to the plugin.	 * @param   JTable   $row     A JTable object	 * @param   boolean  $isNew    If the content is just about to be created	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderBeforeSave($context, $row, $isNew)	{		// We only want to handle categories here		if ($context == 'com_categories.category')		{			// Query the database for the old access level and the parent if the item isn't new			if (!$isNew)			{				$this->checkItemAccess($row);				$this->checkCategoryAccess($row);			}		}		return true;	}	/**	 * Method to update the link information for items that have been changed	 * from outside the edit screen. This is fired when the item is published,	 * unpublished, archived, or unarchived from the list view.	 *	 * @param   string   $context  The context for the content passed to the plugin.	 * @param   array    $pks      A list of primary key ids of the content that has changed state.	 * @param   integer  $value    The value of the state that the content has been changed to.	 *	 * @return  void	 *	 * @since   2.5	 */	public function onFinderChangeState($context, $pks, $value)	{		// We only want to handle categories here		if ($context == 'com_categories.category')		{			// The category published state is tied to the parent category			// published state so we need to look up all published states			// before we change anything.			foreach ($pks as $pk)			{				$query = clone($this->getStateQuery());				$query->where('a.id = ' . (int) $pk);				// Get the published states.				$this->db->setQuery($query);				$item = $this->db->loadObject();				// Translate the state.				$state = null;				if ($item->parent_id != 1)				{					$state = $item->cat_state;				}				$temp = $this->translateState($value, $state);				// Update the item.				$this->change($pk, 'state', $temp);				// Reindex the item				$this->reindex($pk);			}		}		// Handle when the plugin is disabled		if ($context == 'com_plugins.plugin' && $value === 0)		{			$this->pluginDisable($pks);		}	}	/**	 * Method to index an item. The item must be a FinderIndexerResult object.	 *	 * @param   FinderIndexerResult  $item    The item to index as an FinderIndexerResult object.	 * @param   string               $format  The item format	 *	 * @return  void	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	protected function index(FinderIndexerResult $item, $format = 'html')	{		// Check if the extension is enabled		if (JComponentHelper::isEnabled($this->extension) == false)		{			return;		}		$item->setLanguage();		// Need to import component route helpers dynamically, hence the reason it's handled here		$path = JPATH_SITE . '/components/' . $item->extension . '/helpers/route.php';		if (is_file($path))		{			include_once $path;		}		$extension = ucfirst(substr($item->extension, 4));		// Initialize the item parameters.		$registry = new JRegistry;		$registry->loadString($item->params);		$item->params = $registry;		$registry = new JRegistry;		$registry->loadString($item->metadata);		$item->metadata = $registry;		/* Add the meta-data processing instructions based on the categories		 * configuration parameters.		 */		// Add the meta-author.		$item->metaauthor = $item->metadata->get('author');		// Handle the link to the meta-data.		$item->addInstruction(FinderIndexer::META_CONTEXT, 'link');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metakey');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metadesc');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metaauthor');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'author');		//$item->addInstruction(FinderIndexer::META_CONTEXT, 'created_by_alias');		// Trigger the onContentPrepare event.		$item->summary = FinderIndexerHelper::prepareContent($item->summary, $item->params);		// Build the necessary route and path information.		$item->url = $this->getURL($item->id, $item->extension, $this->layout);		$class = $extension . 'HelperRoute';		if (class_exists($class) && method_exists($class, 'getCategoryRoute'))		{			$item->route = $class::getCategoryRoute($item->id);		}		else		{			$item->route = ContentHelperRoute::getCategoryRoute($item->slug, $item->catid);		}		$item->path = FinderIndexerHelper::getContentPath($item->route);		// Get the menu title if it exists.		$title = $this->getItemMenuTitle($item->url);		// Adjust the title if necessary.		if (!empty($title) && $this->params->get('use_menu_title', true))		{			$item->title = $title;		}		// Translate the state. Categories should only be published if the parent category is published.		$item->state = $this->translateState($item->state);		// Add the type taxonomy data.		$item->addTaxonomy('Type', 'Category');		// Add the language taxonomy data.		$item->addTaxonomy('Language', $item->language);		// Get content extras.		FinderIndexerHelper::getContentExtras($item);		// Index the item.		$this->indexer->index($item);	}	/**	 * Method to setup the indexer to be run.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	protected function setup()	{		// Load com_content route helper as it is the fallback for routing in the indexer in this instance.		include_once JPATH_SITE . '/components/com_content/helpers/route.php';		return true;	}	/**	 * Method to get the SQL query used to retrieve the list of content items.	 *	 * @param   mixed  $query  A JDatabaseQuery object or null.	 *	 * @return  JDatabaseQuery  A database object.	 *	 * @since   2.5	 */	protected function getListQuery($query = null)	{		$db = JFactory::getDbo();		// Check if we can use the supplied SQL query.		$query = $query instanceof JDatabaseQuery ? $query : $db->getQuery(true)			->select('a.id, a.title, a.alias, a.description AS summary, a.extension')			->select('a.created_user_id AS created_by, a.modified_time AS modified, a.modified_user_id AS modified_by')			->select('a.metakey, a.metadesc, a.metadata, a.language, a.lft, a.parent_id, a.level')			->select('a.created_time AS start_date, a.published AS state, a.access, a.params');		// Handle the alias CASE WHEN portion of the query		$case_when_item_alias = ' CASE WHEN ';		$case_when_item_alias .= $query->charLength('a.alias', '!=', '0');		$case_when_item_alias .= ' THEN ';		$a_id = $query->castAsChar('a.id');		$case_when_item_alias .= $query->concatenate(array($a_id, 'a.alias'), ':');		$case_when_item_alias .= ' ELSE ';		$case_when_item_alias .= $a_id.' END as slug';		$query->select($case_when_item_alias)			->from('#__categories AS a')			->where($db->quoteName('a.id') . ' > 1');		return $query;	}	/**	 * Method to get a SQL query to load the published and access states for	 * an article and category.	 *	 * @return  JDatabaseQuery  A database object.	 *	 * @since   2.5	 */	protected function getStateQuery()	{		$query = $this->db->getQuery(true)			->select($this->db->quoteName('a.id'))			->select('a.' . $this->state_field . ' AS state, c.published AS cat_state')			->select('a.access, c.access AS cat_access')			->from($this->db->quoteName('#__categories') . ' AS a')			->join('LEFT', '#__categories AS c ON c.id = a.parent_id');		return $query;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JLoader::register('ContentHelper', JPATH_ADMINISTRATOR . '/components/com_content/helpers/content.php');/** * @package     Joomla.Administrator * @subpackage  com_content */abstract class JHtmlContentAdministrator{	/**	 * Get the associated language flags	 *	 * @param   int  $articleid  The article item id	 *	 * @return  string  The language HTML	 */	public static function association($articleid)	{		// Defaults		$html = '';		// Get the associations		if ($associations = JLanguageAssociations::getAssociations('com_content', '#__content', 'com_content.item', $articleid))		{			foreach ($associations as $tag => $associated)			{				$associations[$tag] = (int) $associated->id;			}			// Get the associated menu items			$db = JFactory::getDbo();			$query = $db->getQuery(true)				->select('c.*')				->from('#__content as c')				->select('cat.title as category_title')				->join('LEFT', '#__categories as cat ON cat.id=c.catid')				->where('c.id IN (' . implode(',', array_values($associations)) . ')')				->join('LEFT', '#__languages as l ON c.language=l.lang_code')				->select('l.image')				->select('l.title as language_title');			$db->setQuery($query);			try			{				$items = $db->loadObjectList('id');			}			catch (runtimeException $e)			{				throw new Exception($e->getMessage(), 500);				return false;			}			$flags = array();			// Construct html			foreach ($associations as $tag => $associated)			{				if ($associated != $articleid)				{					$flags[] = JText::sprintf(						'COM_CONTENT_TIP_ASSOCIATED_LANGUAGE',						JHtml::_('image', 'mod_languages/' . $items[$associated]->image . '.gif',							$items[$associated]->language_title,							array('title' => $items[$associated]->language_title),							true						),						$items[$associated]->title, $items[$associated]->category_title					);				}			}			$html = JHtml::_('tooltip', implode('<br />', $flags), JText::_('COM_CONTENT_TIP_ASSOCIATION'), 'admin/icon-16-links.png');		}		return $html;	}	/**	 * @param   int $value	The state value	 * @param   int $i	 */	public static function featured($value = 0, $i, $canChange = true)	{		JHtml::_('bootstrap.tooltip');		// Array of image, task, title, action		$states	= array(			0	=> array('star-empty',	'articles.featured',	'COM_CONTENT_UNFEATURED',	'COM_CONTENT_TOGGLE_TO_FEATURE'),			1	=> array('star',		'articles.unfeatured',	'COM_CONTENT_FEATURED',		'COM_CONTENT_TOGGLE_TO_UNFEATURE'),		);		$state	= JArrayHelper::getValue($states, (int) $value, $states[1]);		$icon	= $state[0];		if ($canChange)		{			$html	= '<a href="#" onclick="return listItemTask(\'cb'.$i.'\',\''.$state[1].'\')" class="btn btn-micro hasTooltip' . ($value == 1 ? ' active' : '') . '" title="'.JText::_($state[3]).'"><i class="icon-'					. $icon.'"></i></a>';		}		else		{			$html	= '<a class="btn btn-micro hasTooltip disabled' . ($value == 1 ? ' active' : '') . '" title="'.JText::_($state[2]).'"><i class="icon-'					. $icon.'"></i></a>';		}		return $html;	}}
<?php/** * @package    Joomla.Platform * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE */// Set the platform root path as a constant if necessary.if (!defined('JPATH_PLATFORM')){	define('JPATH_PLATFORM', __DIR__);}// Detect the native operating system type.$os = strtoupper(substr(PHP_OS, 0, 3));if (!defined('IS_WIN')){	define('IS_WIN', ($os === 'WIN') ? true : false);}if (!defined('IS_UNIX')){	define('IS_UNIX', (($os !== 'MAC') && ($os !== 'WIN')) ? true : false);}/** * @deprecated 13.3	Use IS_UNIX instead */if (!defined('IS_MAC')){	define('IS_MAC', (IS_UNIX === true && ($os === 'DAR' || $os === 'MAC')) ? true : false);}// Import the platform version library if necessary.if (!class_exists('JPlatform')){	require_once JPATH_PLATFORM . '/platform.php';}// Import the library loader if necessary.if (!class_exists('JLoader')){	require_once JPATH_PLATFORM . '/loader.php';}class_exists('JLoader') or die;// Setup the autoloaders.JLoader::setup();// Register the legacy library base path for deprecated or legacy libraries.JLoader::registerPrefix('J', JPATH_PLATFORM . '/legacy');// Import the Joomla Factory.JLoader::import('joomla.factory');// Register classes that don't follow one file per class naming conventions.JLoader::register('JText', JPATH_PLATFORM . '/joomla/language/text.php');JLoader::register('JRoute', JPATH_PLATFORM . '/joomla/application/route.php');// Register the folder for the moved JHtml classesJHtml::addIncludePath(JPATH_PLATFORM . '/legacy/html');// Register classes for compatability with PHP 5.3if (version_compare(PHP_VERSION, '5.4.0', '<')){	JLoader::register('JsonSerializable', __DIR__ . '/compat/jsonserializable.php');}// Add deprecated constants// @deprecated 12.3define('JPATH_ISWIN', IS_WIN);define('JPATH_ISMAC', IS_MAC);// Register classes where the names have been changed to fit the autoloader rules// @deprecated  12.3JLoader::register('JSimpleCrypt', JPATH_PLATFORM . '/legacy/simplecrypt/simplecrypt.php');JLoader::register('JTree', JPATH_PLATFORM . '/legacy/base/tree.php');JLoader::register('JNode', JPATH_PLATFORM . '/legacy/base/node.php');JLoader::register('JObserver', JPATH_PLATFORM . '/legacy/base/observer.php');JLoader::register('JObservable', JPATH_PLATFORM . '/legacy/base/observable.php');JLoader::register('LogException', JPATH_PLATFORM . '/legacy/log/logexception.php');JLoader::register('JXMLElement', JPATH_PLATFORM . '/legacy/utilities/xmlelement.php');JLoader::register('JRule', JPATH_PLATFORM . '/legacy/access/rule.php');JLoader::register('JRules', JPATH_PLATFORM . '/legacy/access/rules.php');JLoader::register('JCli', JPATH_PLATFORM . '/legacy/application/cli.php');JLoader::register('JDaemon', JPATH_PLATFORM . '/legacy/application/daemon.php');JLoader::register('JApplication', JPATH_LIBRARIES . '/legacy/application/application.php');
<?php/** * @package     Joomla.Administrator * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;/** * Supports a modal newsfeeds picker. * * @package     Joomla.Administrator * @subpackage  com_newsfeeds * @since       1.6 */class JFormFieldModal_Newsfeeds extends JFormField{	/**	 * The form field type.	 *	 * @var		string	 * @since   1.6	 */	protected $type = 'Modal_Newsfeeds';	/**	 * Method to get the field input markup.	 *	 * @return  string	The field input markup.	 * @since   1.6	 */	protected function getInput()	{		// Load the javascript		JHtml::_('behavior.framework');		JHtml::_('behavior.modal', 'input.modal');		// Build the script.		$script = array();		$script[] = '	function jSelectChart_'.$this->id.'(id, name, object) {';		$script[] = '		document.id("'.$this->id.'_id").value = id;';		$script[] = '		document.id("'.$this->id.'_name").value = name;';		$script[] = '		SqueezeBox.close();';		$script[] = '	}';		// Add the script to the document head.		JFactory::getDocument()->addScriptDeclaration(implode("\n", $script));		// Build the script.		$script = array();		$script[] = '	window.addEvent("domready", function() {';		$script[] = '		var div = new Element("div").setStyle("display", "none").inject(document.id("menu-types"), "before");';		$script[] = '		document.id("menu-types").inject(div, "bottom");';		$script[] = '	});';		// Add the script to the document head.		JFactory::getDocument()->addScriptDeclaration(implode("\n", $script));		// Get the title of the linked chart		$db = JFactory::getDbo();		$db->setQuery(			'SELECT name' .			' FROM #__newsfeeds' .			' WHERE id = '.(int) $this->value		);		try		{			$title = $db->loadResult();		}		catch (RuntimeException $e)		{			JError::raiseWarning(500, $e->getMessage);		}		if (empty($title))		{			$title = JText::_('COM_NEWSFEEDS_SELECT_A_FEED');		}		$link = 'index.php?option=com_newsfeeds&amp;view=newsfeeds&amp;layout=modal&amp;tmpl=component&amp;function=jSelectChart_'.$this->id;		if (isset($this->element['language']))		{			$link .= '&amp;forcedLanguage='.$this->element['language'];		}		JHtml::_('behavior.modal', 'a.modal');		$html = "\n".'<div class="input-append"><input type="text" class="input-medium" id="'.$this->id.'_name" value="'.htmlspecialchars($title, ENT_QUOTES, 'UTF-8').'" disabled="disabled" />';		$html .= '<a class="modal btn" title="'.JText::_('COM_NEWSFEEDS_CHANGE_FEED_BUTTON').'"  href="'.$link.'" rel="{handler: \'iframe\', size: {x: 800, y: 450}}"><i class="icon-feed" title="'.JText::_('COM_NEWSFEEDS_CHANGE_FEED_BUTTON').'"></i> '.JText::_('JSELECT').'</a></div>'."\n";		// The active newsfeed id field.		if (0 == (int) $this->value)		{			$value = '';		}		else		{			$value = (int) $this->value;		}		// class='required' for client side validation		$class = '';		if ($this->required)		{			$class = ' class="required modal-value"';		}		$html .= '<input type="hidden" id="'.$this->id.'_id"'.$class.' name="'.$this->name.'" value="'.$value.'" />';		return $html;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_categories * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Categories view class for the Category package. * * @package     Joomla.Administrator * @subpackage  com_categories * @since       1.6 */class CategoriesController extends JControllerLegacy{	/**	 * @var		string	The extension for which the categories apply.	 * @since   1.6	 */	protected $extension;	/**	 * Constructor.	 *	 * @param   array An optional associative array of configuration settings.	 * @see     JController	 * @since   1.6	 */	public function __construct($config = array())	{		parent::__construct($config);		// Guess the JText message prefix. Defaults to the option.		if (empty($this->extension))		{			$this->extension = $this->input->get('extension', 'com_content');		}	}	/**	 * Method to display a view.	 *	 * @param   boolean			If true, the view output will be cached	 * @param   array  An array of safe url parameters and their variable types, for valid values see {@link JFilterInput::clean()}.	 *	 * @return  JController		This object to support chaining.	 * @since   1.5	 */	public function display($cachable = false, $urlparams = false)	{		// Get the document object.		$document = JFactory::getDocument();		// Set the default view name and format from the Request.		$vName   = $this->input->get('view', 'categories');		$vFormat = $document->getType();		$lName   = $this->input->get('layout', 'default');		$id      = $this->input->getInt('id');		// Check for edit form.		if ($vName == 'category' && $lName == 'edit' && !$this->checkEditId('com_categories.edit.category', $id))		{			// Somehow the person just went to the form - we don't allow that.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_UNHELD_ID', $id));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(JRoute::_('index.php?option=com_categories&view=categories&extension='.$this->extension, false));			return false;		}		// Get and render the view.		if ($view = $this->getView($vName, $vFormat))		{			// Get the model for the view.			$model = $this->getModel($vName, 'CategoriesModel', array('name' => $vName . '.' . substr($this->extension, 4)));			// Push the model into the view (as default).			$view->setModel($model, true);			$view->setLayout($lName);			// Push document object into the view.			$view->document = $document;			// Load the submenu.			require_once JPATH_COMPONENT.'/helpers/categories.php';			CategoriesHelper::addSubmenu($model->getState('filter.extension'));			$view->display();		}		return $this;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.multiselect');JHtml::_('bootstrap.tooltip');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><div id="installer-manage"><form action="<?php echo JRoute::_('index.php?option=com_installer&view=manage');?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<?php if ($this->showMessage) : ?>		<?php echo $this->loadTemplate('message'); ?>	<?php endif; ?>	<?php if ($this->ftp) : ?>		<?php echo $this->loadTemplate('ftp'); ?>	<?php endif; ?>	<?php echo $this->loadTemplate('filter'); ?>	<?php if (count($this->items)) : ?>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="title nowrap">					<?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_NAME', 'name', $listDirn, $listOrder); ?>				</th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_LOCATION', 'client_id', $listDirn, $listOrder); ?>				</th>				<th class="width-10 center">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'status', $listDirn, $listOrder); ?>				</th>				<th class="center">					<?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_TYPE', 'type', $listDirn, $listOrder); ?>				</th>				<th class="width-10 center">					<?php echo JText::_('JVERSION'); ?>				</th>				<th class="width-10">					<?php echo JText::_('JDATE'); ?>				</th>                <th class="width-15 center">                	<?php echo JText::_('JAUTHOR'); ?>                </th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_FOLDER', 'folder', $listDirn, $listOrder); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_ID', 'extension_id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) : ?>			<tr class="row<?php echo $i % 2; if ($item->status == 2) echo ' protected';?>">				<td>					<?php echo JHtml::_('grid.id', $i, $item->extension_id); ?>				</td>				<td>					<span class="bold hasTip" title="<?php echo htmlspecialchars($item->name.'::'.$item->description); ?>">						<?php echo $item->name; ?>					</span>				</td>				<td class="center">					<?php echo $item->client; ?>				</td>				<td class="center">					<?php if (!$item->element) : ?>					<strong>X</strong>					<?php else : ?>						<?php echo JHtml::_('InstallerHtml.Manage.state', $item->status, $i, $item->status < 2, 'cb'); ?>					<?php endif; ?>				</td>				<td class="center">					<?php echo JText::_('COM_INSTALLER_TYPE_' . $item->type); ?>				</td>				<td class="center">					<?php echo @$item->version != '' ? $item->version : '&#160;'; ?>				</td>				<td class="center">					<?php echo @$item->creationDate != '' ? $item->creationDate : '&#160;'; ?>				</td>				<td class="center">					<span class="editlinktip hasTip" title="<?php echo addslashes(htmlspecialchars(JText::_('COM_INSTALLER_AUTHOR_INFORMATION').'::'.$item->author_info)); ?>">						<?php echo @$item->author != '' ? $item->author : '&#160;'; ?>					</span>				</td>				<td class="center">					<?php echo @$item->folder != '' ? $item->folder : JText::_('COM_INSTALLER_TYPE_NONAPPLICABLE'); ?>				</td>				<td>					<?php echo $item->extension_id ?>				</td>			</tr>		<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<?php endif; ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('bootstrap.popover');$document = JFactory::getDocument();?><h2><?php echo JText::_('COM_MODULES_TYPE_CHOOSE')?></h2><ul id="new-modules-list" class="list list-striped"><?php foreach ($this->items as &$item) : ?>	<?php		// Prepare variables for the link.		$link	= 'index.php?option=com_modules&task=module.add&eid='. $item->extension_id;		$name	= $this->escape($item->name);		$desc	= JHTML::_('string.truncate', ($this->escape($item->desc)), 200);		$short_desc	= JHTML::_('string.truncate', ($this->escape($item->desc)), 90);	?>	<?php if ($document->direction != "rtl") : ?>	<li>		<a href="<?php echo JRoute::_($link);?>">			<strong><?php echo $name; ?></strong>		</a>		<small class="hasPopover" data-placement="right" title="<?php echo $name; ?>" data-content="<?php echo $desc; ?>"><?php echo $short_desc; ?></small>	</li>	<?php else : ?>	<li>		<small rel="popover" data-placement="left" title="<?php echo $name; ?>" data-content="<?php echo $desc; ?>"><?php echo $short_desc; ?></small>		<a href="<?php echo JRoute::_($link);?>">			<strong><?php echo $name; ?></strong>		</a>	</li>	<?php endif?><?php endforeach; ?></ul><div class="clr"></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Config Component Controller * * @package     Joomla.Administrator * @subpackage  com_config * @since       1.5 */class ConfigController extends JControllerLegacy{	/**	 * @var		string	The default view.	 * @since   1.6	 */	protected $default_view = 'application';	/**	 * Method to display the view.	 *	 * @param   boolean			If true, the view output will be cached	 * @param   array  An array of safe url parameters and their variable types, for valid values see {@link JFilterInput::clean()}.	 *	 * @return  JController		This object to support chaining.	 * @since   1.5	 */	public function display($cachable = false, $urlparams = false)	{		// Get the document object.		$document	= JFactory::getDocument();		// Set the default view name and format from the Request.		$vName   = $this->input->get('view', 'application');		$vFormat = $document->getType();		$lName   = $this->input->get('layout', 'default');		// Get and render the view.		if ($view = $this->getView($vName, $vFormat))		{			if ($vName != 'close')			{				// Get the model for the view.				$model = $this->getModel($vName);				// Access check.				if (!JFactory::getUser()->authorise('core.admin', $model->getState('component.option')))				{					return JError::raiseWarning(404, JText::_('JERROR_ALERTNOAUTHOR'));				}				// Push the model into the view (as default).				$view->setModel($model, true);			}			$view->setLayout($lName);			// Push document object into the view.			$view->document = $document;			$view->display();		}	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Finder.Content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_BASE') or die;require_once JPATH_ADMINISTRATOR . '/components/com_finder/helpers/indexer/adapter.php';/** * Finder adapter for com_content. * * @package     Joomla.Plugin * @subpackage  Finder.Content * @since       2.5 */class PlgFinderContent extends FinderIndexerAdapter{	/**	 * The plugin identifier.	 *	 * @var    string	 * @since  2.5	 */	protected $context = 'Content';	/**	 * The extension name.	 *	 * @var    string	 * @since  2.5	 */	protected $extension = 'com_content';	/**	 * The sublayout to use when rendering the results.	 *	 * @var    string	 * @since  2.5	 */	protected $layout = 'article';	/**	 * The type of content that the adapter indexes.	 *	 * @var    string	 * @since  2.5	 */	protected $type_title = 'Article';	/**	 * The table name.	 *	 * @var    string	 * @since  2.5	 */	protected $table = '#__content';	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * Method to update the item link information when the item category is	 * changed. This is fired when the item category is published or unpublished	 * from the list view.	 *	 * @param   string   $extension  The extension whose category has been updated.	 * @param   array    $pks        A list of primary key ids of the content that has changed state.	 * @param   integer  $value      The value of the state that the content has been changed to.	 *	 * @return  void	 *	 * @since   2.5	 */	public function onFinderCategoryChangeState($extension, $pks, $value)	{		// Make sure we're handling com_content categories		if ($extension == 'com_content')		{			$this->categoryStateChange($pks, $value);		}	}	/**	 * Method to remove the link information for items that have been deleted.	 *	 * @param   string  $context  The context of the action being performed.	 * @param   JTable  $table    A JTable object containing the record to be deleted	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderAfterDelete($context, $table)	{		if ($context == 'com_content.article')		{			$id = $table->id;		}		elseif ($context == 'com_finder.index')		{			$id = $table->link_id;		}		else		{			return true;		}		// Remove the items.		return $this->remove($id);	}	/**	 * Method to determine if the access level of an item changed.	 *	 * @param   string   $context  The context of the content passed to the plugin.	 * @param   JTable   $row      A JTable object	 * @param   boolean  $isNew    If the content has just been created	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderAfterSave($context, $row, $isNew)	{		// We only want to handle articles here		if ($context == 'com_content.article' || $context == 'com_content.form')		{			// Check if the access levels are different			if (!$isNew && $this->old_access != $row->access)			{				// Process the change.				$this->itemAccessChange($row);			}			// Reindex the item			$this->reindex($row->id);		}		// Check for access changes in the category		if ($context == 'com_categories.category')		{			// Check if the access levels are different			if (!$isNew && $this->old_cataccess != $row->access)			{				$this->categoryAccessChange($row);			}		}		return true;	}	/**	 * Method to reindex the link information for an item that has been saved.	 * This event is fired before the data is actually saved so we are going	 * to queue the item to be indexed later.	 *	 * @param   string   $context  The context of the content passed to the plugin.	 * @param   JTable   $row     A JTable object	 * @param   boolean  $isNew    If the content is just about to be created	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderBeforeSave($context, $row, $isNew)	{		// We only want to handle articles here		if ($context == 'com_content.article' || $context == 'com_content.form')		{			// Query the database for the old access level if the item isn't new			if (!$isNew)			{				$this->checkItemAccess($row);			}		}		// Check for access levels from the category		if ($context == 'com_categories.category')		{			// Query the database for the old access level if the item isn't new			if (!$isNew)			{				$this->checkCategoryAccess($row);			}		}		return true;	}	/**	 * Method to update the link information for items that have been changed	 * from outside the edit screen. This is fired when the item is published,	 * unpublished, archived, or unarchived from the list view.	 *	 * @param   string   $context  The context for the content passed to the plugin.	 * @param   array    $pks      A list of primary key ids of the content that has changed state.	 * @param   integer  $value    The value of the state that the content has been changed to.	 *	 * @return  void	 *	 * @since   2.5	 */	public function onFinderChangeState($context, $pks, $value)	{		// We only want to handle articles here		if ($context == 'com_content.article' || $context == 'com_content.form')		{			$this->itemStateChange($pks, $value);		}		// Handle when the plugin is disabled		if ($context == 'com_plugins.plugin' && $value === 0)		{			$this->pluginDisable($pks);		}	}	/**	 * Method to index an item. The item must be a FinderIndexerResult object.	 *	 * @param   FinderIndexerResult  $item    The item to index as an FinderIndexerResult object.	 * @param   string               $format  The item format	 *	 * @return  void	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	protected function index(FinderIndexerResult $item, $format = 'html')	{		$item->setLanguage();		// Check if the extension is enabled		if (JComponentHelper::isEnabled($this->extension) == false)		{			return;		}		// Initialize the item parameters.		$registry = new JRegistry;		$registry->loadString($item->params);		$item->params = JComponentHelper::getParams('com_content', true);		$item->params->merge($registry);		$registry = new JRegistry;		$registry->loadString($item->metadata);		$item->metadata = $registry;		// Trigger the onContentPrepare event.		$item->summary = FinderIndexerHelper::prepareContent($item->summary, $item->params);		$item->body = FinderIndexerHelper::prepareContent($item->body, $item->params);		// Build the necessary route and path information.		$item->url = $this->getURL($item->id, $this->extension, $this->layout);		$item->route = ContentHelperRoute::getArticleRoute($item->slug, $item->catslug);		$item->path = FinderIndexerHelper::getContentPath($item->route);		// Get the menu title if it exists.		$title = $this->getItemMenuTitle($item->url);		// Adjust the title if necessary.		if (!empty($title) && $this->params->get('use_menu_title', true))		{			$item->title = $title;		}		// Add the meta-author.		$item->metaauthor = $item->metadata->get('author');		// Add the meta-data processing instructions.		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metakey');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metadesc');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metaauthor');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'author');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'created_by_alias');		// Translate the state. Articles should only be published if the category is published.		$item->state = $this->translateState($item->state, $item->cat_state);		// Add the type taxonomy data.		$item->addTaxonomy('Type', 'Article');		// Add the author taxonomy data.		if (!empty($item->author) || !empty($item->created_by_alias))		{			$item->addTaxonomy('Author', !empty($item->created_by_alias) ? $item->created_by_alias : $item->author);		}		// Add the category taxonomy data.		$item->addTaxonomy('Category', $item->category, $item->cat_state, $item->cat_access);		// Add the language taxonomy data.		$item->addTaxonomy('Language', $item->language);		// Get content extras.		FinderIndexerHelper::getContentExtras($item);		// Index the item.		$this->indexer->index($item);	}	/**	 * Method to setup the indexer to be run.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	protected function setup()	{		// Load dependent classes.		include_once JPATH_SITE . '/components/com_content/helpers/route.php';		return true;	}	/**	 * Method to get the SQL query used to retrieve the list of content items.	 *	 * @param   mixed  $query  A JDatabaseQuery object or null.	 *	 * @return  JDatabaseQuery  A database object.	 *	 * @since   2.5	 */	protected function getListQuery($query = null)	{		$db = JFactory::getDbo();		// Check if we can use the supplied SQL query.		$query = $query instanceof JDatabaseQuery ? $query : $db->getQuery(true)			->select('a.id, a.title, a.alias, a.introtext AS summary, a.fulltext AS body')			->select('a.state, a.catid, a.created AS start_date, a.created_by')			->select('a.created_by_alias, a.modified, a.modified_by, a.attribs AS params')			->select('a.metakey, a.metadesc, a.metadata, a.language, a.access, a.version, a.ordering')			->select('a.publish_up AS publish_start_date, a.publish_down AS publish_end_date')			->select('c.title AS category, c.published AS cat_state, c.access AS cat_access');		// Handle the alias CASE WHEN portion of the query		$case_when_item_alias = ' CASE WHEN ';		$case_when_item_alias .= $query->charLength('a.alias', '!=', '0');		$case_when_item_alias .= ' THEN ';		$a_id = $query->castAsChar('a.id');		$case_when_item_alias .= $query->concatenate(array($a_id, 'a.alias'), ':');		$case_when_item_alias .= ' ELSE ';		$case_when_item_alias .= $a_id.' END as slug';		$query->select($case_when_item_alias);		$case_when_category_alias = ' CASE WHEN ';		$case_when_category_alias .= $query->charLength('c.alias', '!=', '0');		$case_when_category_alias .= ' THEN ';		$c_id = $query->castAsChar('c.id');		$case_when_category_alias .= $query->concatenate(array($c_id, 'c.alias'), ':');		$case_when_category_alias .= ' ELSE ';		$case_when_category_alias .= $c_id.' END as catslug';		$query->select($case_when_category_alias)			->select('u.name AS author')			->from('#__content AS a')			->join('LEFT', '#__categories AS c ON c.id = a.catid')			->join('LEFT', '#__users AS u ON u.id = a.created_by');		return $query;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Base this model on the backend version.require_once JPATH_ADMINISTRATOR.'/components/com_content/models/article.php';/** * Content Component Article Model * * @package     Joomla.Site * @subpackage  com_content * @since       1.5 */class ContentModelForm extends ContentModelArticle{	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState()	{		$app = JFactory::getApplication();		// Load state from the request.		$pk = $app->input->getInt('a_id');		$this->setState('article.id', $pk);		$this->setState('article.catid', $app->input->getInt('catid'));		$return = $app->input->get('return', null, 'base64');		$this->setState('return_page', base64_decode($return));		// Load the parameters.		$params	= $app->getParams();		$this->setState('params', $params);		$this->setState('layout', $app->input->get('layout'));	}	/**	 * Method to get article data.	 *	 * @param   integer	The id of the article.	 *	 * @return  mixed  Content item data object on success, false on failure.	 */	public function getItem($itemId = null)	{		$itemId = (int) (!empty($itemId)) ? $itemId : $this->getState('article.id');		// Get a row instance.		$table = $this->getTable();		// Attempt to load the row.		$return = $table->load($itemId);		// Check for a table object error.		if ($return === false && $table->getError())		{			$this->setError($table->getError());			return false;		}		$properties = $table->getProperties(1);		$value = JArrayHelper::toObject($properties, 'JObject');		// Convert attrib field to Registry.		$value->params = new JRegistry;		$value->params->loadString($value->attribs);		// Compute selected asset permissions.		$user	= JFactory::getUser();		$userId	= $user->get('id');		$asset	= 'com_content.article.'. $value->id;		// Check general edit permission first.		if ($user->authorise('core.edit', $asset))		{			$value->params->set('access-edit', true);		}		// Now check if edit.own is available.		elseif (!empty($userId) && $user->authorise('core.edit.own', $asset))		{			// Check for a valid user and that they are the owner.			if ($userId == $value->created_by)			{				$value->params->set('access-edit', true);			}		}		// Check edit state permission.		if ($itemId)		{			// Existing item			$value->params->set('access-change', $user->authorise('core.edit.state', $asset));		}		else		{			// New item.			$catId = (int) $this->getState('article.catid');			if ($catId)			{				$value->params->set('access-change', $user->authorise('core.edit.state', 'com_content.category.'.$catId));				$value->catid = $catId;			}			else			{				$value->params->set('access-change', $user->authorise('core.edit.state', 'com_content'));			}		}		$value->articletext = $value->introtext;		if (!empty($value->fulltext))		{			$value->articletext .= '<hr id="system-readmore" />'.$value->fulltext;		}		// Convert the metadata field to an array.		$registry = new JRegistry;		$registry->loadString($value->metadata);		$value->metadata = $registry->toArray();		if ($itemId)		{			$value->tags = new JHelperTags;			$value->tags->getTagIds($value->id, 'com_content.article');			$value->metadata['tags'] = $value->tags;		}		return $value;	}	/**	 * Get the return URL.	 *	 * @return  string	The return URL.	 * @since   1.6	 */	public function getReturnPage()	{		return base64_encode($this->getState('return_page'));	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Utility class working with phpsetting * * @package     Joomla.Administrator * @subpackage  com_admin * @since       1.6 */abstract class JHtmlPhpSetting{	/**	 * Method to generate a boolean message for a value	 *	 * @param boolean $val is the value set?	 *	 * @return  string html code	 */	public static function boolean($val)	{		if ($val)		{			return JText::_('JON');		}		else		{			return JText::_('JOFF');		}	}	/**	 * Method to generate a boolean message for a value	 *	 * @param boolean $val is the value set?	 *	 * @return  string html code	 */	public static function set($val)	{		if ($val)		{			return JText::_('JYES');		}		else		{			return JText::_('JNO');		}	}	/**	 * Method to generate a string message for a value	 *	 * @param string $val a php ini value	 *	 * @return  string html code	 */	public static function string($val)	{		if (empty($val))		{			return JText::_('JNONE');		}		else		{			return $val;		}	}	/**	 * Method to generate an integer from a value	 *	 * @param string $val a php ini value	 *	 * @return  string html code	 *	 * @deprecated  4.0  Use intval() or casting instead.	 */	public static function integer($val)	{		JLog::add('JHtmlPhpSetting::integer() is deprecated. Use intval() or casting instead.', JLog::WARNING, 'deprecated');		return (int) $val;	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Content.pagenavigation * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Pagenavigation plugin class. * * @package     Joomla.Plugin * @subpackage  Content.pagenavigation * @since       1.5 */class PlgContentPagenavigation extends JPlugin{	/**	 * @since   1.6	 */	public function onContentBeforeDisplay($context, &$row, &$params, $page = 0)	{		$app = JFactory::getApplication();		$view = $app->input->get('view');		$print = $app->input->getBool('print');		if ($print)		{			return false;		}		if ($params->get('show_item_navigation') && ($context == 'com_content.article') && ($view == 'article'))		{			$db = JFactory::getDbo();			$user = JFactory::getUser();			$lang = JFactory::getLanguage();			$nullDate = $db->getNullDate();			$date = JFactory::getDate();			$now = $date->toSql();			$uid = $row->id;			$option = 'com_content';			$canPublish = $user->authorise('core.edit.state', $option . '.article.' . $row->id);			// The following is needed as different menu items types utilise a different param to control ordering.			// For Blogs the `orderby_sec` param is the order controlling param.			// For Table and List views it is the `orderby` param.			$params_list = $params->toArray();			if (array_key_exists('orderby_sec', $params_list))			{				$order_method = $params->get('orderby_sec', '');			}			else			{				$order_method = $params->get('orderby', '');			}			// Additional check for invalid sort ordering.			if ($order_method == 'front')			{				$order_method = '';			}			// Determine sort order.			switch ($order_method)			{				case 'date' :					$orderby = 'a.created';					break;				case 'rdate' :					$orderby = 'a.created DESC';					break;				case 'alpha' :					$orderby = 'a.title';					break;				case 'ralpha' :					$orderby = 'a.title DESC';					break;				case 'hits' :					$orderby = 'a.hits';					break;				case 'rhits' :					$orderby = 'a.hits DESC';					break;				case 'order' :					$orderby = 'a.ordering';					break;				case 'author' :					$orderby = 'a.created_by_alias, u.name';					break;				case 'rauthor' :					$orderby = 'a.created_by_alias DESC, u.name DESC';					break;				case 'front' :					$orderby = 'f.ordering';					break;				default :					$orderby = 'a.ordering';					break;			}			$xwhere = ' AND (a.state = 1 OR a.state = -1)' .				' AND (publish_up = ' . $db->quote($nullDate) . ' OR publish_up <= ' . $db->quote($now) . ')' .				' AND (publish_down = ' . $db->quote($nullDate) . ' OR publish_down >= ' . $db->quote($now) . ')';			// Array of articles in same category correctly ordered.			$query = $db->getQuery(true);			// Sqlsrv changes			$case_when = ' CASE WHEN ';			$case_when .= $query->charLength('a.alias', '!=', '0');			$case_when .= ' THEN ';			$a_id = $query->castAsChar('a.id');			$case_when .= $query->concatenate(array($a_id, 'a.alias'), ':');			$case_when .= ' ELSE ';			$case_when .= $a_id . ' END as slug';			$case_when1 = ' CASE WHEN ';			$case_when1 .= $query->charLength('cc.alias', '!=', '0');			$case_when1 .= ' THEN ';			$c_id = $query->castAsChar('cc.id');			$case_when1 .= $query->concatenate(array($c_id, 'cc.alias'), ':');			$case_when1 .= ' ELSE ';			$case_when1 .= $c_id . ' END as catslug';			$query->select('a.id,' . $case_when . ',' . $case_when1)				->from('#__content AS a')				->join('LEFT', '#__categories AS cc ON cc.id = a.catid')				->where(					'a.catid = ' . (int) $row->catid . ' AND a.state = ' . (int) $row->state						. ($canPublish ? '' : ' AND a.access = ' . (int) $row->access) . $xwhere				);			$query->order($orderby);			if ($app->isSite() && $app->getLanguageFilter())			{				$query->where('a.language in (' . $db->quote($lang->getTag()) . ',' . $db->quote('*') . ')');			}			$db->setQuery($query);			$list = $db->loadObjectList('id');			// This check needed if incorrect Itemid is given resulting in an incorrect result.			if (!is_array($list))			{				$list = array();			}			reset($list);			// Location of current content item in array list.			$location = array_search($uid, array_keys($list));			$rows = array_values($list);			$row->prev = null;			$row->next = null;			if ($location - 1 >= 0)			{				// The previous content item cannot be in the array position -1.				$row->prev = $rows[$location - 1];			}			if (($location + 1) < count($rows))			{				// The next content item cannot be in an array position greater than the number of array postions.				$row->next = $rows[$location + 1];			}			$pnSpace = "";			if (JText::_('JGLOBAL_LT') || JText::_('JGLOBAL_GT'))			{				$pnSpace = " ";			}			if ($row->prev)			{				$row->prev = JRoute::_(ContentHelperRoute::getArticleRoute($row->prev->slug, $row->prev->catslug));			}			else			{				$row->prev = '';			}			if ($row->next)			{				$row->next = JRoute::_(ContentHelperRoute::getArticleRoute($row->next->slug, $row->next->catslug));			}			else			{				$row->next = '';			}			// Output.			if ($row->prev || $row->next)			{				// Get the path for the layout file				$path = JPluginHelper::getLayoutPath('content', 'pagenavigation');				// Render the pagenav				ob_start();				include $path;				$row->pagination = ob_get_clean();				$row->paginationposition = $this->params->get('position', 1);				// This will default to the 1.5 and 1.6-1.7 behavior.				$row->paginationrelative = $this->params->get('relative', 0);			}		}		return;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('formbehavior.chosen', 'select');$canDo = UsersHelper::getActions();// Get the form fieldsets.$fieldsets = $this->form->getFieldsets();?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'user.cancel' || document.formvalidator.isValid(document.id('user-form')))		{			Joomla.submitform(task, document.getElementById('user-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_users&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="user-form" class="form-validate form-horizontal" enctype="multipart/form-data">	<fieldset>		<?php echo JHtml::_('bootstrap.startTabSet', 'myTab', array('active' => 'details')); ?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'details', JText::_('COM_USERS_USER_ACCOUNT_DETAILS', true)); ?>				<?php foreach ($this->form->getFieldset('user_details') as $field) : ?>					<div class="control-group">						<div class="control-label">							<?php echo $field->label; ?>						</div>						<div class="controls">							<?php echo $field->input; ?>						</div>					</div>				<?php endforeach; ?>			<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php if ($this->grouplist) : ?>				<?php echo JHtml::_('bootstrap.addTab', 'myTab', 'groups', JText::_('COM_USERS_ASSIGNED_GROUPS', true)); ?>					<?php echo $this->loadTemplate('groups'); ?>				<?php echo JHtml::_('bootstrap.endTab'); ?>			<?php endif; ?>			<?php			foreach ($fieldsets as $fieldset) :				if ($fieldset->name == 'user_details') :					continue;				endif;			?>			<?php echo JHtml::_('bootstrap.addTab', 'myTab', $fieldset->name, JText::_($fieldset->label, true)); ?>				<?php foreach ($this->form->getFieldset($fieldset->name) as $field) : ?>					<?php if ($field->hidden) : ?>						<div class="control-group">							<div class="controls">								<?php echo $field->input; ?>							</div>						</div>					<?php else: ?>						<div class="control-group">							<div class="control-label">								<?php echo $field->label; ?>							</div>							<div class="controls">								<?php echo $field->input; ?>							</div>						</div>					<?php endif; ?>				<?php endforeach; ?>		<?php echo JHtml::_('bootstrap.endTab'); ?>		<?php endforeach; ?>		<?php echo JHtml::_('bootstrap.endTabSet'); ?>	</fieldset>	<input type="hidden" name="task" value="" />	<?php echo JHtml::_('form.token'); ?></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Weblink Table class * * @package     Joomla.Administrator * @subpackage  com_weblinks * @since       1.5 */class WeblinksTableWeblink extends JTable{	/**	 * Helper object for storing and deleting tag information.	 *	 * @var    JHelperTags	 * @since  3.1	 */	protected $tagsHelper = null;	/**	 * Constructor	 *	 * @param JDatabaseDriver A database connector object	 */	public function __construct(&$db)	{		parent::__construct('#__weblinks', 'id', $db);		$this->tagsHelper = new JHelperTags();		$this->tagsHelper->typeAlias = 'com_weblinks.weblink';	}	/**	 * Overloaded bind function to pre-process the params.	 *	 * @param   array  Named array	 * @return  null|string	null is operation was satisfactory, otherwise returns an error	 * @see     JTable:bind	 * @since   1.5	 */	public function bind($array, $ignore = '')	{		if (isset($array['params']) && is_array($array['params']))		{			$registry = new JRegistry;			$registry->loadArray($array['params']);			$array['params'] = (string) $registry;		}		if (isset($array['metadata']) && is_array($array['metadata']))		{			$registry = new JRegistry;			$registry->loadArray($array['metadata']);			$array['metadata'] = (string) $registry;		}		if (isset($array['images']) && is_array($array['images']))		{			$registry = new JRegistry;			$registry->loadArray($array['images']);			$array['images'] = (string) $registry;		}		return parent::bind($array, $ignore);	}	/**	 * Overload the store method for the Weblinks table.	 *	 * @param   boolean	Toggle whether null values should be updated.	 * @return  boolean  True on success, false on failure.	 * @since   1.6	 */	public function store($updateNulls = false)	{		$date	= JFactory::getDate();		$user	= JFactory::getUser();		if ($this->id)		{			// Existing item			$this->modified		= $date->toSql();			$this->modified_by	= $user->get('id');		}		else		{			// New weblink. A weblink created and created_by field can be set by the user,			// so we don't touch either of these if they are set.			if (!(int) $this->created)			{				$this->created = $date->toSql();			}			if (empty($this->created_by))			{				$this->created_by = $user->get('id');			}		}		// Set publish_up to null date if not set		if (!$this->publish_up)		{			$this->publish_up = $this->_db->getNullDate();		}		// Set publish_down to null date if not set		if (!$this->publish_down)		{			$this->publish_down = $this->_db->getNullDate();		}		// Verify that the alias is unique		$table = JTable::getInstance('Weblink', 'WeblinksTable');		if ($table->load(array('alias' => $this->alias, 'catid' => $this->catid)) && ($table->id != $this->id || $this->id == 0))		{			$this->setError(JText::_('COM_WEBLINKS_ERROR_UNIQUE_ALIAS'));			return false;		}		$this->tagsHelper->preStoreProcess($this);		$result = parent::store($updateNulls);		return $result && $this->tagsHelper->postStoreProcess($this);	}	/**	 * Overloaded check method to ensure data integrity.	 *	 * @return  boolean  True on success.	 */	public function check()	{		if (JFilterInput::checkAttribute(array ('href', $this->url)))		{			$this->setError(JText::_('COM_WEBLINKS_ERR_TABLES_PROVIDE_URL'));			return false;		}		// check for valid name		if (trim($this->title) == '')		{			$this->setError(JText::_('COM_WEBLINKS_ERR_TABLES_TITLE'));			return false;		}		// check for existing name		$query = 'SELECT id FROM #__weblinks WHERE title = '.$this->_db->quote($this->title).' AND catid = '.(int) $this->catid;		$this->_db->setQuery($query);		$xid = (int) $this->_db->loadResult();		if ($xid && $xid != (int) $this->id)		{			$this->setError(JText::_('COM_WEBLINKS_ERR_TABLES_NAME'));			return false;		}		if (empty($this->alias))		{			$this->alias = $this->title;		}		$this->alias = JApplication::stringURLSafe($this->alias);		if (trim(str_replace('-', '', $this->alias)) == '')		{			$this->alias = JFactory::getDate()->format("Y-m-d-H-i-s");		}		// Check the publish down date is not earlier than publish up.		if ($this->publish_down > $this->_db->getNullDate() && $this->publish_down < $this->publish_up)		{			$this->setError(JText::_('JGLOBAL_START_PUBLISH_AFTER_FINISH'));			return false;		}		// clean up keywords -- eliminate extra spaces between phrases		// and cr (\r) and lf (\n) characters from string		if (!empty($this->metakey))		{			// only process if not empty			$bad_characters = array("\n", "\r", "\"", "<", ">"); // array of characters to remove			$after_clean = JString::str_ireplace($bad_characters, "", $this->metakey); // remove bad characters			$keys = explode(',', $after_clean); // create array using commas as delimiter			$clean_keys = array();			foreach ($keys as $key)			{				if (trim($key)) {  // ignore blank keywords					$clean_keys[] = trim($key);				}			}			$this->metakey = implode(", ", $clean_keys); // put array back together delimited by ", "		}		return true;	}	/**	 * Override parent delete method to delete tags information.	 *	 * @param   integer  $pk  Primary key to delete.	 *	 * @return  boolean  True on success.	 *	 * @since   3.1	 * @throws  UnexpectedValueException	 */	public function delete($pk = null)	{		$result = parent::delete($pk);		return $result && $this->tagsHelper->deleteTagData($this, $pk);	}	/**	 * Method to set the publishing state for a row or list of rows in the database	 * table.  The method respects checked out rows by other users and will attempt	 * to checkin rows that it can after adjustments are made.	 *	 * @param   mixed	An optional array of primary key values to update.  If not	 *					set the instance property value is used.	 * @param   integer The publishing state. eg. [0 = unpublished, 1 = published]	 * @param   integer The user id of the user performing the operation.	 * @return  boolean  True on success.	 * @since   1.0.4	 */	public function publish($pks = null, $state = 1, $userId = 0)	{		$k = $this->_tbl_key;		// Sanitize input.		JArrayHelper::toInteger($pks);		$userId = (int) $userId;		$state  = (int) $state;		// If there are no primary keys set check to see if the instance key is set.		if (empty($pks))		{			if ($this->$k)			{				$pks = array($this->$k);			}			// Nothing to set publishing state on, return false.			else {				$this->setError(JText::_('JLIB_DATABASE_ERROR_NO_ROWS_SELECTED'));				return false;			}		}		// Build the WHERE clause for the primary keys.		$where = $k.'='.implode(' OR '.$k.'=', $pks);		// Determine if there is checkin support for the table.		if (!property_exists($this, 'checked_out') || !property_exists($this, 'checked_out_time'))		{			$checkin = '';		}		else		{			$checkin = ' AND (checked_out = 0 OR checked_out = '.(int) $userId.')';		}		// Update the publishing state for rows with the given primary keys.		$this->_db->setQuery(			'UPDATE '.$this->_db->quoteName($this->_tbl) .			' SET '.$this->_db->quoteName('state').' = '.(int) $state .			' WHERE ('.$where.')' .			$checkin		);		try		{			$this->_db->execute();		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		// If checkin is supported and all rows were adjusted, check them in.		if ($checkin && (count($pks) == $this->_db->getAffectedRows()))		{			// Checkin the rows.			foreach ($pks as $pk)			{				$this->checkin($pk);			}		}		// If the JTable instance value is in the list of primary keys that were set, set the instance.		if (in_array($this->$k, $pks))		{			$this->state = $state;		}		$this->setError('');		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_templates * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Template style controller class. * * @package     Joomla.Administrator * @subpackage  com_templates * @since       1.6 */class TemplatesControllerStyle extends JControllerForm{	/**	 * @var		string	The prefix to use with controller messages.	 * @since   1.6	 */	protected $text_prefix = 'COM_TEMPLATES_STYLE';}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'weblink.cancel' || document.formvalidator.isValid(document.id('weblink-form')))		{			<?php echo $this->form->getField('description')->save(); ?>			Joomla.submitform(task, document.getElementById('weblink-form'));		}	}</script><div class="weblink-edit"><form action="<?php echo JRoute::_('index.php?option=com_weblinks&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="weblink-form" class="form-validate">	<div class="col main-section">		<fieldset class="adminform">			<legend><?php echo empty($this->item->id) ? JText::_('COM_WEBLINKS_NEW_WEBLINK') : JText::sprintf('COM_WEBLINKS_EDIT_WEBLINK', $this->item->id); ?></legend>			<ul class="adminformlist">				<li><?php echo $this->form->getLabel('title'); ?>				<?php echo $this->form->getInput('title'); ?></li>				<li><?php echo $this->form->getLabel('alias'); ?>				<?php echo $this->form->getInput('alias'); ?></li>				<li><?php echo $this->form->getLabel('url'); ?>				<?php echo $this->form->getInput('url'); ?></li>				<li><?php echo $this->form->getLabel('catid'); ?>				<?php echo $this->form->getInput('catid'); ?></li>				<li><?php echo $this->form->getLabel('state'); ?>				<?php echo $this->form->getInput('state'); ?></li>				<li><?php echo $this->form->getLabel('access'); ?>				<?php echo $this->form->getInput('access'); ?></li>				<li><?php echo $this->form->getLabel('ordering'); ?>				<?php echo $this->form->getInput('ordering'); ?></li>				<li><?php echo $this->form->getLabel('language'); ?>				<?php echo $this->form->getInput('language'); ?></li>				<!-- Tag field -->				<?php foreach ($this->get('form')->getFieldset('jmetadata') as $field) : ?>					<?php if ($field->name == 'jform[metadata][tags][]') :?>						<li>							<?php echo $field->label; ?>							<?php echo $field->input; ?>						</li>					<?php endif; ?>				<?php endforeach; ?>				<li><?php echo $this->form->getLabel('id'); ?>				<?php echo $this->form->getInput('id'); ?></li>			</ul>			<div>				<?php echo $this->form->getLabel('description'); ?>				<div class="clr"></div>				<?php echo $this->form->getInput('description'); ?>			</div>		</fieldset>	</div>	<div class="col options-section">		<?php echo JHtml::_('sliders.start', 'weblink-sliders-'.$this->item->id, array('useCookie' => 1)); ?>		<?php echo JHtml::_('sliders.panel', JText::_('JGLOBAL_FIELDSET_PUBLISHING'), 'publishing-details'); ?>		<fieldset class="panelform">			<legend class="element-invisible"><?php echo JText::_('JGLOBAL_FIELDSET_PUBLISHING'); ?></legend>			<ul class="adminformlist">				<li><?php echo $this->form->getLabel('created_by'); ?>				<?php echo $this->form->getInput('created_by'); ?></li>				<li><?php echo $this->form->getLabel('created_by_alias'); ?>				<?php echo $this->form->getInput('created_by_alias'); ?></li>				<li><?php echo $this->form->getLabel('created'); ?>				<?php echo $this->form->getInput('created'); ?></li>				<li><?php echo $this->form->getLabel('publish_up'); ?>				<?php echo $this->form->getInput('publish_up'); ?></li>				<li><?php echo $this->form->getLabel('publish_down'); ?>				<?php echo $this->form->getInput('publish_down'); ?></li>				<?php if ($this->item->modified_by) : ?>					<li><?php echo $this->form->getLabel('modified_by'); ?>					<?php echo $this->form->getInput('modified_by'); ?></li>					<li><?php echo $this->form->getLabel('modified'); ?>					<?php echo $this->form->getInput('modified'); ?></li>				<?php endif; ?>				<?php if ($this->item->hits) : ?>					<li><?php echo $this->form->getLabel('hits'); ?>					<?php echo $this->form->getInput('hits'); ?></li>				<?php endif; ?>			</ul>		</fieldset>		<?php echo $this->loadTemplate('params'); ?>		<?php echo JHtml::_('sliders.panel', JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS'), 'meta-options'); ?>		<fieldset class="panelform">		<legend class="element-invisible"><?php echo JText::_('JGLOBAL_FIELDSET_METADATA_OPTIONS'); ?></legend>			<?php echo $this->loadTemplate('metadata'); ?>		</fieldset>		<?php echo JHtml::_('sliders.end'); ?>		<input type="hidden" name="task" value="" />		<?php echo JHtml::_('form.token'); ?>	</div>	<div class="clr"></div></form></div>
<?php/** * @package     Joomla.Site * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.framework');$n			= count($this->items);$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><?php if (empty($this->items)) : ?>	<p> <?php echo JText::_('COM_NEWSFEEDS_NO_ARTICLES'); ?></p><?php else : ?><form action="<?php echo htmlspecialchars(JUri::getInstance()->toString()); ?>" method="post" name="adminForm" id="adminForm">	<?php if ($this->params->get('filter_field') != 'hide' || $this->params->get('show_pagination_limit')) :?>	<fieldset class="filters btn-toolbar">		<?php if ($this->params->get('filter_field') != 'hide') :?>			<div class="btn-group">				<label class="filter-search-lbl element-invisible" for="filter-search"><span class="label label-warning"><?php echo JText::_('JUNPUBLISHED'); ?></span><?php echo JText::_('COM_NEWSFEEDS_FILTER_LABEL').'&#160;'; ?></label>				<input type="text" name="filter-search" id="filter-search" value="<?php echo $this->escape($this->state->get('list.filter')); ?>" class="inputbox" onchange="document.adminForm.submit();" title="<?php echo JText::_('COM_NEWSFEEDS_FILTER_SEARCH_DESC'); ?>" placeholder="<?php echo JText::_('COM_NEWSFEEDS_FILTER_SEARCH_DESC'); ?>" />			</div>		<?php endif; ?>		<?php if ($this->params->get('show_pagination_limit')) : ?>			<div class="btn-group pull-right">				<label for="limit" class="element-invisible">					<?php echo JText::_('JGLOBAL_DISPLAY_NUM'); ?>				</label>				<?php echo $this->pagination->getLimitBox(); ?>			</div>		<?php endif; ?>	</fieldset>	<?php endif; ?>		<ul class="category list-striped list-condensed">			<?php foreach ($this->items as $i => $item) : ?>				<?php if ($this->items[$i]->published == 0) : ?>					<li class="system-unpublished cat-list-row<?php echo $i % 2; ?>">				<?php else: ?>					<li class="cat-list-row<?php echo $i % 2; ?>" >				<?php endif; ?>				<?php  if ($this->params->get('show_articles')) : ?>					<span class="list-hits badge badge-info pull-right">						<?php echo  JText::sprintf('COM_NEWSFEEDS_NUM_ARTICLES_COUNT', $item->numarticles); ?>					</span>				<?php  endif; ?>				<span class="list pull-left">					<strong class="list-title">						<a href="<?php echo JRoute::_(NewsFeedsHelperRoute::getNewsfeedRoute($item->slug, $item->catid)); ?>">							<?php echo $item->name; ?></a>					</strong>				</span>				<?php if ($this->items[$i]->published == 0) : ?>					<span class="label label-warning"><?php echo JText::_('JUNPUBLISHED'); ?></span>				<?php endif; ?>				<br />				<?php  if ($this->params->get('show_link')) : ?>					<span class="list pull-left">							<a href="<?php echo $item->link; ?>"><?php echo $item->link; ?></a>					</span>					<br/>				<?php  endif; ?>				</li>			<?php endforeach; ?>		</ul>		<?php // Add pagination links ?>		<?php if (!empty($this->items)) : ?>			<?php if (($this->params->def('show_pagination', 2) == 1  || ($this->params->get('show_pagination') == 2)) && ($this->pagination->pagesTotal > 1)) : ?>				<div class="pagination">					<?php if ($this->params->def('show_pagination_results', 1)) : ?>						<p class="counter pull-right">							<?php echo $this->pagination->getPagesCounter(); ?>						</p>					<?php endif; ?>					<?php echo $this->pagination->getPagesLinks(); ?>				</div>			<?php endif; ?>		<?php  endif; ?>	</form><?php endif; ?>
<?php/** * @package     Joomla.Site * @subpackage  com_search * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the search component * * @package     Joomla.Site * @subpackage  com_search * @since       1.0 */class SearchViewSearch extends JViewLegacy{	public function display($tpl = null)	{		require_once JPATH_COMPONENT_ADMINISTRATOR.'/helpers/search.php';		$app     = JFactory::getApplication();		$pathway = $app->getPathway();		$uri     = JURI::getInstance();		$error   = null;		$rows    = null;		$results = null;		$total   = 0;		// Get some data from the model		$areas      = $this->get('areas');		$state      = $this->get('state');		$searchword = $state->get('keyword');		$params     = $app->getParams();		$menus = $app->getMenu();		$menu  = $menus->getActive();		// because the application sets a default page title, we need to get it		// right from the menu item itself		if (is_object($menu))		{			$menu_params = new JRegistry;			$menu_params->loadString($menu->params);			if (!$menu_params->get('page_title'))			{				$params->set('page_title',	JText::_('COM_SEARCH_SEARCH'));			}		}		else		{			$params->set('page_title',	JText::_('COM_SEARCH_SEARCH'));		}		$title = $params->get('page_title');		if ($app->getCfg('sitename_pagetitles', 0) == 1)		{			$title = JText::sprintf('JPAGETITLE', $app->getCfg('sitename'), $title);		}		elseif ($app->getCfg('sitename_pagetitles', 0) == 2)		{			$title = JText::sprintf('JPAGETITLE', $title, $app->getCfg('sitename'));		}		$this->document->setTitle($title);		if ($params->get('menu-meta_description'))		{			$this->document->setDescription($params->get('menu-meta_description'));		}		if ($params->get('menu-meta_keywords'))		{			$this->document->setMetadata('keywords', $params->get('menu-meta_keywords'));		}		if ($params->get('robots'))		{			$this->document->setMetadata('robots', $params->get('robots'));		}		// built select lists		$orders = array();		$orders[] = JHtml::_('select.option', 'newest', JText::_('COM_SEARCH_NEWEST_FIRST'));		$orders[] = JHtml::_('select.option', 'oldest', JText::_('COM_SEARCH_OLDEST_FIRST'));		$orders[] = JHtml::_('select.option', 'popular', JText::_('COM_SEARCH_MOST_POPULAR'));		$orders[] = JHtml::_('select.option', 'alpha', JText::_('COM_SEARCH_ALPHABETICAL'));		$orders[] = JHtml::_('select.option', 'category', JText::_('JCATEGORY'));		$lists = array();		$lists['ordering'] = JHtml::_('select.genericlist', $orders, 'ordering', 'class="inputbox"', 'value', 'text', $state->get('ordering'));		$searchphrases         = array();		$searchphrases[]       = JHtml::_('select.option',  'all', JText::_('COM_SEARCH_ALL_WORDS'));		$searchphrases[]       = JHtml::_('select.option',  'any', JText::_('COM_SEARCH_ANY_WORDS'));		$searchphrases[]       = JHtml::_('select.option',  'exact', JText::_('COM_SEARCH_EXACT_PHRASE'));		$lists['searchphrase'] = JHtml::_('select.radiolist',  $searchphrases, 'searchphrase', '', 'value', 'text', $state->get('match'));		// log the search		JSearchHelper::logSearch($searchword, 'com_search');		//limit searchword		$lang = JFactory::getLanguage();		$upper_limit = $lang->getUpperLimitSearchWord();		$lower_limit = $lang->getLowerLimitSearchWord();		if (SearchHelper::limitSearchWord($searchword))		{			$error = JText::sprintf('COM_SEARCH_ERROR_SEARCH_MESSAGE', $lower_limit, $upper_limit);		}		// Sanitise searchword		if (SearchHelper::santiseSearchWord($searchword, $state->get('match')))		{			$error = JText::_('COM_SEARCH_ERROR_IGNOREKEYWORD');		}		if (!$searchword && !empty($this->input) && count($this->input->post))		{			// $error = JText::_('COM_SEARCH_ERROR_ENTERKEYWORD');		}		// Put the filtered results back into the model		// for next release, the checks should be done in the model perhaps...		$state->set('keyword', $searchword);		if ($error == null)		{			$results	= $this->get('data');			$total		= $this->get('total');			$pagination	= $this->get('pagination');			require_once JPATH_SITE . '/components/com_content/helpers/route.php';			for ($i = 0, $count = count($results); $i < $count; $i++)			{				$row = &$results[$i]->text;				if ($state->get('match') == 'exact')				{					$searchwords = array($searchword);					$needle = $searchword;				}				else {					$searchworda = preg_replace('#\xE3\x80\x80#s', ' ', $searchword);					$searchwords = preg_split("/\s+/u", $searchworda);					$needle = $searchwords[0];				}				$row = SearchHelper::prepareSearchContent($row, $needle);				$searchwords = array_unique($searchwords);				$searchRegex = '#(';				$x = 0;				foreach ($searchwords as $k => $hlword)				{					$searchRegex .= ($x == 0 ? '' : '|');					$searchRegex .= preg_quote($hlword, '#');					$x++;				}				$searchRegex .= ')#iu';				$row = preg_replace($searchRegex, '<span class="highlight">\0</span>', $row);				$result = &$results[$i];				if ($result->created)				{					$created = JHtml::_('date', $result->created, JText::_('DATE_FORMAT_LC3'));				}				else {					$created = '';				}				$result->text		= JHtml::_('content.prepare', $result->text, '', 'com_search.search');				$result->created	= $created;				$result->count		= $i + 1;			}		}		// Check for layout override		$active = JFactory::getApplication()->getMenu()->getActive();		if (isset($active->query['layout']))		{			$this->setLayout($active->query['layout']);		}		//Escape strings for HTML output		$this->pageclass_sfx = htmlspecialchars($params->get('pageclass_sfx'));		$this->pagination = &$pagination;		$this->results = &$results;		$this->lists = &$lists;		$this->params = &$params;		$this->ordering = $state->get('ordering');		$this->searchword = $searchword;		$this->origkeyword = $state->get('origkeyword');		$this->searchphrase = $state->get('match');		$this->searchareas = $areas;		$this->total = $total;		$this->error = $error;		$this->action = $uri;		parent::display($tpl);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  mod_status * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$hideLinks = $input->getBool('hidemainmenu');$task      = $input->getCmd('task');$output    = array();// Print the Preview link to Main site.if ($params->get('show_viewsite', 1)) :	$output[] = '<div class="btn-group viewsite"><a href="'.JURI::root().'" target="_blank"><i class="icon-share-alt"></i> '.JText::_('JGLOBAL_VIEW_SITE').'</a></div><div class="btn-group divider">	</div>';endif;// Print the logged in users.if ($params->get('show_loggedin_users', 1)) :	$output[] = '<div class="btn-group loggedin-users">'.JText::plural('MOD_STATUS_USERS', $online_num).'</div><div class="btn-group divider">	</div>';endif;// Print the back-end logged in users.if ($params->get('show_loggedin_users_admin', 1)) :	$output[] = '<div class="btn-group backloggedin-users">'.JText::plural('MOD_STATUS_BACKEND_USERS', $count).'</div><div class="btn-group divider">	</div>';endif;//  Print the inbox message.if ($params->get('show_messages', 1)) :	$output[] = '<div class="btn-group '.$inboxClass.'">'.			($hideLinks ? '' : '<a href="'.$inboxLink.'">').			'<i class="icon-envelope"></i> '.			JText::plural('MOD_STATUS_MESSAGES', $unread).			($hideLinks ? '' : '</a>').			'<div class="btn-group divider"></div>'.			'</div>';endif;// Print the logout link.if ($task == 'edit' || $task == 'editA' || $input->getInt('hidemainmenu')){	$logoutLink = '';} else {	$logoutLink = JRoute::_('index.php?option=com_login&task=logout&'. JSession::getFormToken() .'=1');}if ($params->get('show_logout', 1)) :	$output[] = '<div class="btn-group logout">' .($hideLinks ? '' : '<a href="'.$logoutLink.'"><i class="icon-minus-sign"></i> ').JText::_('JLOGOUT').($hideLinks ? '' : '</a>').'</div>';endif;// Output the items.foreach ($output as $item) :	echo $item;endforeach;
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Model for the global configuration * * @package     Joomla.Administrator * @subpackage  com_config */class ConfigModelApplication extends JModelForm{	/**	 * Method to get a form object.	 *	 * @param   array  $data		Data for the form.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 *	 * @return  mixed  A JForm object on success, false on failure	 *	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_config.application', 'application', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Method to get the configuration data.	 *	 * This method will load the global configuration data straight from	 * JConfig. If configuration data has been saved in the session, that	 * data will be merged into the original data, overwriting it.	 *	 * @return  array  	An array containg all global config data.	 *	 * @since   1.6	 */	public function getData()	{		// Get the config data.		$config	= new JConfig;		$data	= JArrayHelper::fromObject($config);		// Prime the asset_id for the rules.		$data['asset_id'] = 1;		// Get the text filter data		$params = JComponentHelper::getParams('com_config');		$data['filters'] = JArrayHelper::fromObject($params->get('filters'));		// If no filter data found, get from com_content (update of 1.6/1.7 site)		if (empty($data['filters']))		{			$contentParams = JComponentHelper::getParams('com_content');			$data['filters'] = JArrayHelper::fromObject($contentParams->get('filters'));		}		// Check for data in the session.		$temp = JFactory::getApplication()->getUserState('com_config.config.global.data');		// Merge in the session data.		if (!empty($temp))		{			$data = array_merge($data, $temp);		}		$this->preprocessData('com_config.application', $data);		return $data;	}	/**	 * Method to save the configuration data.	 *	 * @param   array  An array containing all global config data.	 *	 * @return  bool	True on success, false on failure.	 *	 * @since   1.6	 */	public function save($data)	{		// Save the rules		if (isset($data['rules']))		{			$rules	= new JAccessRules($data['rules']);			// Check that we aren't removing our Super User permission			// Need to get groups from database, since they might have changed			$myGroups = JAccess::getGroupsByUser(JFactory::getUser()->get('id'));			$myRules = $rules->getData();			$hasSuperAdmin = $myRules['core.admin']->allow($myGroups);			if (!$hasSuperAdmin)			{				$this->setError(JText::_('COM_CONFIG_ERROR_REMOVING_SUPER_ADMIN'));				return false;			}			$asset = JTable::getInstance('asset');			if ($asset->loadByName('root.1'))			{				$asset->rules = (string) $rules;				if (!$asset->check() || !$asset->store())				{					JError::raiseNotice('SOME_ERROR_CODE', $asset->getError());				}			}			else			{				$this->setError(JText::_('COM_CONFIG_ERROR_ROOT_ASSET_NOT_FOUND'));				return false;			}			unset($data['rules']);		}		// Save the text filters		if (isset($data['filters']))		{			$registry = new JRegistry;			$registry->loadArray(array('filters' => $data['filters']));			$extension = JTable::getInstance('extension');			// Get extension_id			$extension_id = $extension->find(array('name' => 'com_config'));			if ($extension->load((int) $extension_id))			{				$extension->params = (string) $registry;				if (!$extension->check() || !$extension->store())				{					JError::raiseNotice('SOME_ERROR_CODE', $extension->getError());				}			}			else			{				$this->setError(JText::_('COM_CONFIG_ERROR_CONFIG_EXTENSION_NOT_FOUND'));				return false;			}			unset($data['filters']);		}		// Get the previous configuration.		$prev = new JConfig;		$prev = JArrayHelper::fromObject($prev);		// Merge the new data in. We do this to preserve values that were not in the form.		$data = array_merge($prev, $data);		/*		 * Perform miscellaneous options based on configuration settings/changes.		 */		// Escape the offline message if present.		if (isset($data['offline_message']))		{			$data['offline_message'] = JFilterOutput::ampReplace($data['offline_message']);		}		// Purge the database session table if we are changing to the database handler.		if ($prev['session_handler'] != 'database' && $data['session_handler'] == 'database')		{			$table = JTable::getInstance('session');			$table->purge(-1);		}		if (empty($data['cache_handler']))		{			$data['caching'] = 0;		}		// Clean the cache if disabled but previously enabled.		if (!$data['caching'] && $prev['caching'])		{			$cache = JFactory::getCache();			$cache->clean();		}		// Create the new configuration object.		$config = new JRegistry('config');		$config->loadArray($data);		// Overwrite the old FTP credentials with the new ones.		$temp = JFactory::getConfig();		$temp->set('ftp_enable', $data['ftp_enable']);		$temp->set('ftp_host', $data['ftp_host']);		$temp->set('ftp_port', $data['ftp_port']);		$temp->set('ftp_user', $data['ftp_user']);		$temp->set('ftp_pass', $data['ftp_pass']);		$temp->set('ftp_root', $data['ftp_root']);		// Clear cache of com_config component.		$this->cleanCache('_system');		// Write the configuration file.		return $this->writeConfigFile($config);	}	/**	 * Method to unset the root_user value from configuration data.	 *	 * This method will load the global configuration data straight from	 * JConfig and remove the root_user value for security, then save the configuration.	 *	 * @since   1.6	 */	public function removeroot()	{		// Get the previous configuration.		$prev = new JConfig;		$prev = JArrayHelper::fromObject($prev);		// Create the new configuration object, and unset the root_user property		$config = new JRegistry('config');		unset($prev['root_user']);		$config->loadArray($prev);		// Write the configuration file.		return $this->writeConfigFile($config);	}	/**	 * Method to write the configuration to a file.	 *	 * @param   JRegistry  $config	A JRegistry object containing all global config data.	 *	 * @return  bool	   True on success, false on failure.	 *	 * @since	2.5.4	 */	private function writeConfigFile(JRegistry $config)	{		jimport('joomla.filesystem.path');		jimport('joomla.filesystem.file');		// Set the configuration file path.		$file = JPATH_CONFIGURATION . '/configuration.php';		// Get the new FTP credentials.		$ftp = JClientHelper::getCredentials('ftp', true);		// Attempt to make the file writeable if using FTP.		if (!$ftp['enabled'] && JPath::isOwner($file) && !JPath::setPermissions($file, '0644'))		{			JError::raiseNotice('SOME_ERROR_CODE', JText::_('COM_CONFIG_ERROR_CONFIGURATION_PHP_NOTWRITABLE'));		}		// Attempt to write the configuration file as a PHP class named JConfig.		$configuration = $config->toString('PHP', array('class' => 'JConfig', 'closingtag' => false));		if (!JFile::write($file, $configuration))		{			$this->setError(JText::_('COM_CONFIG_ERROR_WRITE_FAILED'));			return false;		}		// Attempt to make the file unwriteable if using FTP.		if (!$ftp['enabled'] && JPath::isOwner($file) && !JPath::setPermissions($file, '0444'))		{			JError::raiseNotice('SOME_ERROR_CODE', JText::_('COM_CONFIG_ERROR_CONFIGURATION_PHP_NOTUNWRITABLE'));		}		return true;	}}
<?php/** * @package     Joomla.Legacy * @subpackage  Model * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Model class for handling lists of items. * * @package     Joomla.Legacy * @subpackage  Model * @since       12.2 */class JModelList extends JModelLegacy{	/**	 * Internal memory based cache array of data.	 *	 * @var    array	 * @since  12.2	 */	protected $cache = array();	/**	 * Context string for the model type.  This is used to handle uniqueness	 * when dealing with the getStoreId() method and caching data structures.	 *	 * @var    string	 * @since  12.2	 */	protected $context = null;	/**	 * Valid filter fields or ordering.	 *	 * @var    array	 * @since  12.2	 */	protected $filter_fields = array();	/**	 * An internal cache for the last query used.	 *	 * @var    JDatabaseQuery	 * @since  12.2	 */	protected $query = array();	/**	 * Constructor.	 *	 * @param   array  $config  An optional associative array of configuration settings.	 *	 * @see     JModelLegacy	 * @since   12.2	 */	public function __construct($config = array())	{		parent::__construct($config);		// Add the ordering filtering fields white list.		if (isset($config['filter_fields']))		{			$this->filter_fields = $config['filter_fields'];		}		// Guess the context as Option.ModelName.		if (empty($this->context))		{			$this->context = strtolower($this->option . '.' . $this->getName());		}	}	/**	 * Method to cache the last query constructed.	 *	 * This method ensures that the query is constructed only once for a given state of the model.	 *	 * @return  JDatabaseQuery  A JDatabaseQuery object	 *	 * @since   12.2	 */	protected function _getListQuery()	{		// Capture the last store id used.		static $lastStoreId;		// Compute the current store id.		$currentStoreId = $this->getStoreId();		// If the last store id is different from the current, refresh the query.		if ($lastStoreId != $currentStoreId || empty($this->query))		{			$lastStoreId = $currentStoreId;			$this->query = $this->getListQuery();		}		return $this->query;	}	/**	 * Method to get an array of data items.	 *	 * @return  mixed  An array of data items on success, false on failure.	 *	 * @since   12.2	 */	public function getItems()	{		// Get a storage key.		$store = $this->getStoreId();		// Try to load the data from internal storage.		if (isset($this->cache[$store]))		{			return $this->cache[$store];		}		// Load the list items.		$query = $this->_getListQuery();		try		{			$items = $this->_getList($query, $this->getStart(), $this->getState('list.limit'));		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		// Add the items to the internal cache.		$this->cache[$store] = $items;		return $this->cache[$store];	}	/**	 * Method to get a JDatabaseQuery object for retrieving the data set from a database.	 *	 * @return  JDatabaseQuery   A JDatabaseQuery object to retrieve the data set.	 *	 * @since   12.2	 */	protected function getListQuery()	{		$db = $this->getDbo();		$query = $db->getQuery(true);		return $query;	}	/**	 * Method to get a JPagination object for the data set.	 *	 * @return  JPagination  A JPagination object for the data set.	 *	 * @since   12.2	 */	public function getPagination()	{		// Get a storage key.		$store = $this->getStoreId('getPagination');		// Try to load the data from internal storage.		if (isset($this->cache[$store]))		{			return $this->cache[$store];		}		// Create the pagination object.		$limit = (int) $this->getState('list.limit') - (int) $this->getState('list.links');		$page = new JPagination($this->getTotal(), $this->getStart(), $limit);		// Add the object to the internal cache.		$this->cache[$store] = $page;		return $this->cache[$store];	}	/**	 * Method to get a store id based on the model configuration state.	 *	 * This is necessary because the model is used by the component and	 * different modules that might need different sets of data or different	 * ordering requirements.	 *	 * @param   string  $id  An identifier string to generate the store id.	 *	 * @return  string  A store id.	 *	 * @since   12.2	 */	protected function getStoreId($id = '')	{		// Add the list state to the store id.		$id .= ':' . $this->getState('list.start');		$id .= ':' . $this->getState('list.limit');		$id .= ':' . $this->getState('list.ordering');		$id .= ':' . $this->getState('list.direction');		return md5($this->context . ':' . $id);	}	/**	 * Method to get the total number of items for the data set.	 *	 * @return  integer  The total number of items available in the data set.	 *	 * @since   12.2	 */	public function getTotal()	{		// Get a storage key.		$store = $this->getStoreId('getTotal');		// Try to load the data from internal storage.		if (isset($this->cache[$store]))		{			return $this->cache[$store];		}		// Load the total.		$query = $this->_getListQuery();		try		{			$total = (int) $this->_getListCount($query);		}		catch (RuntimeException $e)		{			$this->setError($e->getMessage());			return false;		}		// Add the total to the internal cache.		$this->cache[$store] = $total;		return $this->cache[$store];	}	/**	 * Method to get the starting number of items for the data set.	 *	 * @return  integer  The starting number of items available in the data set.	 *	 * @since   12.2	 */	public function getStart()	{		$store = $this->getStoreId('getstart');		// Try to load the data from internal storage.		if (isset($this->cache[$store]))		{			return $this->cache[$store];		}		$start = $this->getState('list.start');		$limit = $this->getState('list.limit');		$total = $this->getTotal();		if ($start > $total - $limit)		{			$start = max(0, (int) (ceil($total / $limit) - 1) * $limit);		}		// Add the total to the internal cache.		$this->cache[$store] = $start;		return $this->cache[$store];	}	/**	 * Method to auto-populate the model state.	 *	 * This method should only be called once per instantiation and is designed	 * to be called on the first call to the getState() method unless the model	 * configuration flag to ignore the request is set.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @param   string  $ordering   An optional ordering field.	 * @param   string  $direction  An optional direction (asc|desc).	 *	 * @return  void	 *	 * @since   12.2	 */	protected function populateState($ordering = null, $direction = null)	{		// If the context is set, assume that stateful lists are used.		if ($this->context)		{			$app = JFactory::getApplication();			$value = $app->getUserStateFromRequest('global.list.limit', 'limit', $app->getCfg('list_limit'), 'uint');			$limit = $value;			$this->setState('list.limit', $limit);			$value = $app->getUserStateFromRequest($this->context . '.limitstart', 'limitstart', 0);			$limitstart = ($limit != 0 ? (floor($value / $limit) * $limit) : 0);			$this->setState('list.start', $limitstart);			// Check if the ordering field is in the white list, otherwise use the incoming value.			$value = $app->getUserStateFromRequest($this->context . '.ordercol', 'filter_order', $ordering);			if (!in_array($value, $this->filter_fields))			{				$value = $ordering;				$app->setUserState($this->context . '.ordercol', $value);			}			$this->setState('list.ordering', $value);			// Check if the ordering direction is valid, otherwise use the incoming value.			$value = $app->getUserStateFromRequest($this->context . '.orderdirn', 'filter_order_Dir', $direction);			if (!in_array(strtoupper($value), array('ASC', 'DESC', '')))			{				$value = $direction;				$app->setUserState($this->context . '.orderdirn', $value);			}			$this->setState('list.direction', $value);		}		else		{			$this->setState('list.start', 0);			$this->state->set('list.limit', 0);		}	}	/**	 * Gets the value of a user state variable and sets it in the session	 *	 * This is the same as the method in JApplication except that this also can optionally	 * force you back to the first page when a filter has changed	 *	 * @param   string   $key        The key of the user state variable.	 * @param   string   $request    The name of the variable passed in a request.	 * @param   string   $default    The default value for the variable if not found. Optional.	 * @param   string   $type       Filter for the variable, for valid values see {@link JFilterInput::clean()}. Optional.	 * @param   boolean  $resetPage  If true, the limitstart in request is set to zero	 *	 * @return  The request user state.	 *	 * @since   12.2	 */	public function getUserStateFromRequest($key, $request, $default = null, $type = 'none', $resetPage = true)	{		$app = JFactory::getApplication();		$input     = $app->input;		$old_state = $app->getUserState($key);		$cur_state = (!is_null($old_state)) ? $old_state : $default;		$new_state = $input->get($request, null, $type);		if (($cur_state != $new_state) && ($resetPage))		{			$input->set('limitstart', 0);		}		// Save the new value only if it is set in this request.		if ($new_state !== null)		{			$app->setUserState($key, $new_state);		}		else		{			$new_state = $cur_state;		}		return $new_state;	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.filesystem.file');jimport('joomla.filesystem.folder');jimport('joomla.filesystem.path');jimport('joomla.base.adapter');/** * Joomla base installer class * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 */class JInstaller extends JAdapter{	/**	 * Array of paths needed by the installer	 *	 * @var    array	 * @since  12.1	 */	protected $paths = array();	/**	 * True if package is an upgrade	 *	 * @var    boolean	 * @since  12.1	 */	protected $upgrade = null;	/**	 * The manifest trigger class	 *	 * @var    object	 * @since  3.1	 */	public $manifestClass = null;	/**	 * True if existing files can be overwritten	 * @var    boolean	 * @since  12.1	 */	protected $overwrite = false;	/**	 * Stack of installation steps	 * - Used for installation rollback	 *	 * @var    array	 * @since  12.1	 */	protected $stepStack = array();	/**	 * Extension Table Entry	 *	 * @var    JTableExtension	 * @since  3.1	 */	public $extension = null;	/**	 * The output from the install/uninstall scripts	 *	 * @var    string	 * @since  3.1	 * */	public $message = null;	/**	 * The installation manifest XML object	 *	 * @var    object	 * @since  3.1	 */	public $manifest = null;	/**	 * The extension message that appears	 *	 * @var    string	 * @since  3.1	 */	protected $extension_message = null;	/**	 * The redirect URL if this extension (can be null if no redirect)	 *	 * @var    string	 * @since  3.1	 */	protected $redirect_url = null;	/**	 * @var    JInstaller  JInstaller instance container.	 * @since  3.1	 */	protected static $instance;	/**	 * Constructor	 *	 * @since   3.1	 */	public function __construct()	{		parent::__construct(__DIR__, 'JInstallerAdapter', __DIR__ . '/adapter');		// Override the default adapter folder		$this->_adapterfolder = 'adapter';	}	/**	 * Returns the global Installer object, only creating it	 * if it doesn't already exist.	 *	 * @return  JInstaller  An installer object	 *	 * @since   3.1	 */	public static function getInstance()	{		if (!isset(self::$instance))		{			self::$instance = new JInstaller;		}		return self::$instance;	}	/**	 * Get the allow overwrite switch	 *	 * @return  boolean  Allow overwrite switch	 *	 * @since   3.1	 */	public function isOverwrite()	{		return $this->overwrite;	}	/**	 * Set the allow overwrite switch	 *	 * @param   boolean  $state  Overwrite switch state	 *	 * @return  boolean  True it state is set, false if it is not	 *	 * @since   3.1	 */	public function setOverwrite($state = false)	{		$tmp = $this->overwrite;		if ($state)		{			$this->overwrite = true;		}		else		{			$this->overwrite = false;		}		return $tmp;	}	/**	 * Get the redirect location	 *	 * @return  string  Redirect location (or null)	 *	 * @since   3.1	 */	public function getRedirectURL()	{		return $this->redirect_url;	}	/**	 * Set the redirect location	 *	 * @param   string  $newurl  New redirect location	 *	 * @return  void	 *	 * @since   3.1	 */	public function setRedirectURL($newurl)	{		$this->redirect_url = $newurl;	}	/**	 * Get the upgrade switch	 *	 * @return  boolean	 *	 * @since   3.1	 */	public function isUpgrade()	{		return $this->upgrade;	}	/**	 * Set the upgrade switch	 *	 * @param   boolean  $state  Upgrade switch state	 *	 * @return  boolean  True if upgrade, false otherwise	 *	 * @since   3.1	 */	public function setUpgrade($state = false)	{		$tmp = $this->upgrade;		if ($state)		{			$this->upgrade = true;		}		else		{			$this->upgrade = false;		}		return $tmp;	}	/**	 * Get the installation manifest object	 *	 * @return  object  Manifest object	 *	 * @since   3.1	 */	public function getManifest()	{		if (!is_object($this->manifest))		{			$this->findManifest();		}		return $this->manifest;	}	/**	 * Get an installer path by name	 *	 * @param   string  $name     Path name	 * @param   string  $default  Default value	 *	 * @return  string  Path	 *	 * @since   3.1	 */	public function getPath($name, $default = null)	{		return (!empty($this->paths[$name])) ? $this->paths[$name] : $default;	}	/**	 * Sets an installer path by name	 *	 * @param   string  $name   Path name	 * @param   string  $value  Path	 *	 * @return  void	 *	 * @since   3.1	 */	public function setPath($name, $value)	{		$this->paths[$name] = $value;	}	/**	 * Pushes a step onto the installer stack for rolling back steps	 *	 * @param   array  $step  Installer step	 *	 * @return  void	 *	 * @since   3.1	 */	public function pushStep($step)	{		$this->stepStack[] = $step;	}	/**	 * Installation abort method	 *	 * @param   string  $msg   Abort message from the installer	 * @param   string  $type  Package type if defined	 *	 * @return  boolean  True if successful	 *	 * @since   3.1	 * @throws  RuntimeException	 */	public function abort($msg = null, $type = null)	{		$retval = true;		$step = array_pop($this->stepStack);		// Raise abort warning		if ($msg)		{			JLog::add($msg, JLog::WARNING, 'jerror');		}		while ($step != null)		{			switch ($step['type'])			{				case 'file':					// Remove the file					$stepval = JFile::delete($step['path']);					break;				case 'folder':					// Remove the folder					$stepval = JFolder::delete($step['path']);					break;				case 'query':					// Placeholder in case this is necessary in the future					// $stepval is always false because if this step was called it invariably failed					$stepval = false;					break;				case 'extension':					// Get database connector object					$db = $this->getDBO();					$query = $db->getQuery(true);					// Remove the entry from the #__extensions table					$query->delete($db->quoteName('#__extensions'))						->where($db->quoteName('extension_id') . ' = ' . (int) $step['id']);					$db->setQuery($query);					$stepval = $db->execute();					break;				default:					if ($type && is_object($this->_adapters[$type]))					{						// Build the name of the custom rollback method for the type						$method = '_rollback_' . $step['type'];						// Custom rollback method handler						if (method_exists($this->_adapters[$type], $method))						{							$stepval = $this->_adapters[$type]->$method($step);						}					}					else					{						// Set it to false						$stepval = false;					}					break;			}			// Only set the return value if it is false			if ($stepval === false)			{				$retval = false;			}			// Get the next step and continue			$step = array_pop($this->stepStack);		}		$conf = JFactory::getConfig();		$debug = $conf->get('debug');		if ($debug)		{			throw new RuntimeException('Installation unexpectedly terminated: ' . $msg, 500);		}		return $retval;	}	// Adapter functions	/**	 * Package installation method	 *	 * @param   string  $path  Path to package source folder	 *	 * @return  boolean  True if successful	 *	 * @since   3.1	 */	public function install($path = null)	{		if ($path && JFolder::exists($path))		{			$this->setPath('source', $path);		}		else		{			$this->abort(JText::_('JLIB_INSTALLER_ABORT_NOINSTALLPATH'));			return false;		}		if (!$this->setupInstall())		{			$this->abort(JText::_('JLIB_INSTALLER_ABORT_DETECTMANIFEST'));			return false;		}		$type = (string) $this->manifest->attributes()->type;		if (is_object($this->_adapters[$type]))		{			// Add the languages from the package itself			if (method_exists($this->_adapters[$type], 'loadLanguage'))			{				$this->_adapters[$type]->loadLanguage($path);			}			// Fire the onExtensionBeforeInstall event.			JPluginHelper::importPlugin('extension');			$dispatcher = JEventDispatcher::getInstance();			$dispatcher->trigger(				'onExtensionBeforeInstall',				array('method' => 'install', 'type' => $type, 'manifest' => $this->manifest, 'extension' => 0)			);			// Run the install			$result = $this->_adapters[$type]->install();			// Fire the onExtensionAfterInstall			$dispatcher->trigger(				'onExtensionAfterInstall',				array('installer' => clone $this, 'eid' => $result)			);			if ($result !== false)			{				return true;			}			else			{				return false;			}		}		return false;	}	/**	 * Discovered package installation method	 *	 * @param   integer  $eid  Extension ID	 *	 * @return  boolean  True if successful	 *	 * @since   3.1	 */	public function discover_install($eid = null)	{		if ($eid)		{			$this->extension = JTable::getInstance('extension');			if (!$this->extension->load($eid))			{				$this->abort(JText::_('JLIB_INSTALLER_ABORT_LOAD_DETAILS'));				return false;			}			if ($this->extension->state != -1)			{				$this->abort(JText::_('JLIB_INSTALLER_ABORT_ALREADYINSTALLED'));				return false;			}			// Lazy load the adapter			if (!isset($this->_adapters[$this->extension->type]) || !is_object($this->_adapters[$this->extension->type]))			{				if (!$this->setAdapter($this->extension->type))				{					return false;				}			}			if (is_object($this->_adapters[$this->extension->type]))			{				if (method_exists($this->_adapters[$this->extension->type], 'discover_install'))				{					// Add the languages from the package itself					if (method_exists($this->_adapters[$this->extension->type], 'loadLanguage'))					{						$this->_adapters[$this->extension->type]->loadLanguage();					}					// Fire the onExtensionBeforeInstall event.					JPluginHelper::importPlugin('extension');					$dispatcher = JEventDispatcher::getInstance();					$dispatcher->trigger(						'onExtensionBeforeInstall',						array(							'method' => 'discover_install',							'type' => $this->extension->get('type'),							'manifest' => null,							'extension' => $this->extension->get('extension_id')						)					);					// Run the install					$result = $this->_adapters[$this->extension->type]->discover_install();					// Fire the onExtensionAfterInstall					$dispatcher->trigger(						'onExtensionAfterInstall',						array('installer' => clone $this, 'eid' => $result)					);					if ($result !== false)					{						return true;					}					else					{						return false;					}				}				else				{					$this->abort(JText::_('JLIB_INSTALLER_ABORT_METHODNOTSUPPORTED'));					return false;				}			}			return false;		}		else		{			$this->abort(JText::_('JLIB_INSTALLER_ABORT_EXTENSIONNOTVALID'));			return false;		}	}	/**	 * Extension discover method	 * Asks each adapter to find extensions	 *	 * @return  array  JExtension	 *	 * @since   3.1	 */	public function discover()	{		$this->loadAllAdapters();		$results = array();		foreach ($this->_adapters as $adapter)		{			// Joomla! 1.5 installation adapter legacy support			if (method_exists($adapter, 'discover'))			{				$tmp = $adapter->discover();				// If its an array and has entries				if (is_array($tmp) && count($tmp))				{					// Merge it into the system					$results = array_merge($results, $tmp);				}			}		}		return $results;	}	/**	 * Package update method	 *	 * @param   string  $path  Path to package source folder	 *	 * @return  boolean  True if successful	 *	 * @since   3.1	 */	public function update($path = null)	{		if ($path && JFolder::exists($path))		{			$this->setPath('source', $path);		}		else		{			$this->abort(JText::_('JLIB_INSTALLER_ABORT_NOUPDATEPATH'));			return false;		}		if (!$this->setupInstall())		{			$this->abort(JText::_('JLIB_INSTALLER_ABORT_DETECTMANIFEST'));			return false;		}		$type = (string) $this->manifest->attributes()->type;		if (is_object($this->_adapters[$type]))		{			// Add the languages from the package itself			if (method_exists($this->_adapters[$type], 'loadLanguage'))			{				$this->_adapters[$type]->loadLanguage($path);			}			// Fire the onExtensionBeforeUpdate event.			JPluginHelper::importPlugin('extension');			$dispatcher = JEventDispatcher::getInstance();			$dispatcher->trigger('onExtensionBeforeUpdate', array('type' => $type, 'manifest' => $this->manifest));			// Run the update			$result = $this->_adapters[$type]->update();			// Fire the onExtensionAfterUpdate			$dispatcher->trigger(				'onExtensionAfterUpdate',				array('installer' => clone $this, 'eid' => $result)			);			if ($result !== false)			{				return true;			}			else			{				return false;			}		}		return false;	}	/**	 * Package uninstallation method	 *	 * @param   string   $type        Package type	 * @param   mixed    $identifier  Package identifier for adapter	 * @param   integer  $cid         Application ID; deprecated in 1.6	 *	 * @return  boolean  True if successful	 *	 * @since   3.1	 */	public function uninstall($type, $identifier, $cid = 0)	{		if (!isset($this->_adapters[$type]) || !is_object($this->_adapters[$type]))		{			if (!$this->setAdapter($type))			{				// We failed to get the right adapter				return false;			}		}		if (is_object($this->_adapters[$type]))		{			// We don't load languages here, we get the extension adapter to work it out			// Fire the onExtensionBeforeUninstall event.			JPluginHelper::importPlugin('extension');			$dispatcher = JEventDispatcher::getInstance();			$dispatcher->trigger('onExtensionBeforeUninstall', array('eid' => $identifier));			// Run the uninstall			$result = $this->_adapters[$type]->uninstall($identifier);			// Fire the onExtensionAfterInstall			$dispatcher->trigger(				'onExtensionAfterUninstall',				array('installer' => clone $this, 'eid' => $identifier, 'result' => $result)			);			return $result;		}		return false;	}	/**	 * Refreshes the manifest cache stored in #__extensions	 *	 * @param   integer  $eid  Extension ID	 *	 * @return  mixed  void on success, false on error @todo missing return value ?	 *	 * @since   3.1	 */	public function refreshManifestCache($eid)	{		if ($eid)		{			$this->extension = JTable::getInstance('extension');			if (!$this->extension->load($eid))			{				$this->abort(JText::_('JLIB_INSTALLER_ABORT_LOAD_DETAILS'));				return false;			}			if ($this->extension->state == -1)			{				$this->abort(JText::_('JLIB_INSTALLER_ABORT_REFRESH_MANIFEST_CACHE'));				return false;			}			// Lazy load the adapter			if (!isset($this->_adapters[$this->extension->type]) || !is_object($this->_adapters[$this->extension->type]))			{				if (!$this->setAdapter($this->extension->type))				{					return false;				}			}			if (is_object($this->_adapters[$this->extension->type]))			{				if (method_exists($this->_adapters[$this->extension->type], 'refreshManifestCache'))				{					$result = $this->_adapters[$this->extension->type]->refreshManifestCache();					if ($result !== false)					{						return true;					}					else					{						return false;					}				}				else				{					$this->abort(JText::sprintf('JLIB_INSTALLER_ABORT_METHODNOTSUPPORTED_TYPE', $this->extension->type));					return false;				}			}			return false;		}		else		{			$this->abort(JText::_('JLIB_INSTALLER_ABORT_REFRESH_MANIFEST_CACHE_VALID'));			return false;		}	}	// Utility functions	/**	 * Prepare for installation: this method sets the installation directory, finds	 * and checks the installation file and verifies the installation type.	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function setupInstall()	{		// We need to find the installation manifest file		if (!$this->findManifest())		{			return false;		}		// Load the adapter(s) for the install manifest		$type = (string) $this->manifest->attributes()->type;		// Lazy load the adapter		if (!isset($this->_adapters[$type]) || !is_object($this->_adapters[$type]))		{			if (!$this->setAdapter($type))			{				return false;			}		}		return true;	}	/**	 * Backward compatible method to parse through a queries element of the	 * installation manifest file and take appropriate action.	 *	 * @param   SimpleXMLElement  $element  The XML node to process	 *	 * @return  mixed  Number of queries processed or False on error	 *	 * @since   3.1	 */	public function parseQueries(SimpleXMLElement $element)	{		// Get the database connector object		$db = & $this->_db;		if (!$element || !count($element->children()))		{			// Either the tag does not exist or has no children therefore we return zero files processed.			return 0;		}		// Get the array of query nodes to process		$queries = $element->children();		if (count($queries) == 0)		{			// No queries to process			return 0;		}		// Process each query in the $queries array (children of $tagName).		foreach ($queries as $query)		{			$db->setQuery($query->data());			if (!$db->execute())			{				JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_SQL_ERROR', $db->stderr(true)), JLog::WARNING, 'jerror');				return false;			}		}		return (int) count($queries);	}	/**	 * Method to extract the name of a discreet installation sql file from the installation manifest file.	 *	 * @param   object  $element  The XML node to process	 *	 * @return  mixed  Number of queries processed or False on error	 *	 * @since   3.1	 */	public function parseSQLFiles($element)	{		if (!$element || !count($element->children()))		{			// The tag does not exist.			return 0;		}		$queries = array();		$db = & $this->_db;		$dbDriver = strtolower($db->name);		if ($dbDriver == 'mysqli')		{			$dbDriver = 'mysql';		}		// Get the name of the sql file to process		foreach ($element->children() as $file)		{			$fCharset = (strtolower($file->attributes()->charset) == 'utf8') ? 'utf8' : '';			$fDriver = strtolower($file->attributes()->driver);			if ($fDriver == 'mysqli')			{				$fDriver = 'mysql';			}			if ($fCharset == 'utf8' && $fDriver == $dbDriver)			{				$sqlfile = $this->getPath('extension_root') . '/' . $file;				// Check that sql files exists before reading. Otherwise raise error for rollback				if (!file_exists($sqlfile))				{					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_SQL_ERROR', $db->stderr(true)), JLog::WARNING, 'jerror');					return false;				}				$buffer = file_get_contents($sqlfile);				// Graceful exit and rollback if read not successful				if ($buffer === false)				{					JLog::add(JText::_('JLIB_INSTALLER_ERROR_SQL_READBUFFER'), JLog::WARNING, 'jerror');					return false;				}				// Create an array of queries from the sql file				$queries = JDatabaseDriver::splitSql($buffer);				if (count($queries) == 0)				{					// No queries to process					return 0;				}				// Process each query in the $queries array (split out of sql file).				foreach ($queries as $query)				{					$query = trim($query);					if ($query != '' && $query{0} != '#')					{						$db->setQuery($query);						if (!$db->execute())						{							JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_SQL_ERROR', $db->stderr(true)), JLog::WARNING, 'jerror');							return false;						}					}				}			}		}		return (int) count($queries);	}	/**	 * Set the schema version for an extension by looking at its latest update	 *	 * @param   SimpleXMLElement  $schema  Schema Tag	 * @param   integer           $eid     Extension ID	 *	 * @return  void	 *	 * @since   3.1	 */	public function setSchemaVersion(SimpleXMLElement $schema, $eid)	{		if ($eid && $schema)		{			$db = JFactory::getDbo();			$schemapaths = $schema->children();			if (!$schemapaths)			{				return;			}			if (count($schemapaths))			{				$dbDriver = strtolower($db->name);				if ($dbDriver == 'mysqli')				{					$dbDriver = 'mysql';				}				$schemapath = '';				foreach ($schemapaths as $entry)				{					$attrs = $entry->attributes();					if ($attrs['type'] == $dbDriver)					{						$schemapath = $entry;						break;					}				}				if (strlen($schemapath))				{					$files = str_replace('.sql', '', JFolder::files($this->getPath('extension_root') . '/' . $schemapath, '\.sql$'));					usort($files, 'version_compare');					// Update the database					$query = $db->getQuery(true)						->delete('#__schemas')						->where('extension_id = ' . $eid);					$db->setQuery($query);					if ($db->execute())					{						$query->clear()							->insert($db->quoteName('#__schemas'))							->columns(array($db->quoteName('extension_id'), $db->quoteName('version_id')))							->values($eid . ', ' . $db->quote(end($files)));						$db->setQuery($query);						$db->execute();					}				}			}		}	}	/**	 * Method to process the updates for an item	 *	 * @param   SimpleXMLElement  $schema  The XML node to process	 * @param   integer           $eid     Extension Identifier	 *	 * @return  boolean           Result of the operations	 *	 * @since   3.1	 */	public function parseSchemaUpdates(SimpleXMLElement $schema, $eid)	{		$files = array();		$update_count = 0;		// Ensure we have an XML element and a valid extension id		if ($eid && $schema)		{			$db = JFactory::getDbo();			$schemapaths = $schema->children();			if (count($schemapaths))			{				$dbDriver = strtolower($db->name);				if ($dbDriver == 'mysqli')				{					$dbDriver = 'mysql';				}				$schemapath = '';				foreach ($schemapaths as $entry)				{					$attrs = $entry->attributes();					if ($attrs['type'] == $dbDriver)					{						$schemapath = $entry;						break;					}				}				if (strlen($schemapath))				{					$files = str_replace('.sql', '', JFolder::files($this->getPath('extension_root') . '/' . $schemapath, '\.sql$'));					usort($files, 'version_compare');					if (!count($files))					{						return false;					}					$query = $db->getQuery(true)						->select('version_id')						->from('#__schemas')						->where('extension_id = ' . $eid);					$db->setQuery($query);					$version = $db->loadResult();					if ($version)					{						// We have a version!						foreach ($files as $file)						{							if (version_compare($file, $version) > 0)							{								$buffer = file_get_contents($this->getPath('extension_root') . '/' . $schemapath . '/' . $file . '.sql');								// Graceful exit and rollback if read not successful								if ($buffer === false)								{									JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_SQL_READBUFFER'), JLog::WARNING, 'jerror');									return false;								}								// Create an array of queries from the sql file								$queries = JDatabaseDriver::splitSql($buffer);								if (count($queries) == 0)								{									// No queries to process									continue;								}								// Process each query in the $queries array (split out of sql file).								foreach ($queries as $query)								{									$query = trim($query);									if ($query != '' && $query{0} != '#')									{										$db->setQuery($query);										if (!$db->execute())										{											JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_SQL_ERROR', $db->stderr(true)), JLog::WARNING, 'jerror');											return false;										}										$update_count++;									}								}							}						}					}					// Update the database					$query = $db->getQuery(true)						->delete('#__schemas')						->where('extension_id = ' . $eid);					$db->setQuery($query);					if ($db->execute())					{						$query->clear()							->insert($db->quoteName('#__schemas'))							->columns(array($db->quoteName('extension_id'), $db->quoteName('version_id')))							->values($eid . ', ' . $db->quote(end($files)));						$db->setQuery($query);						$db->execute();					}				}			}		}		return $update_count;	}	/**	 * Method to parse through a files element of the installation manifest and take appropriate	 * action.	 *	 * @param   SimpleXMLElement  $element   The XML node to process	 * @param   integer           $cid       Application ID of application to install to	 * @param   array             $oldFiles  List of old files (SimpleXMLElement's)	 * @param   array             $oldMD5    List of old MD5 sums (indexed by filename with value as MD5)	 *	 * @return  boolean      True on success	 *	 * @since   3.1	 */	public function parseFiles(SimpleXMLElement $element, $cid = 0, $oldFiles = null, $oldMD5 = null)	{		// Get the array of file nodes to process; we checked whether this had children above.		if (!$element || !count($element->children()))		{			// Either the tag does not exist or has no children (hence no files to process) therefore we return zero files processed.			return 0;		}		$copyfiles = array();		// Get the client info		$client = JApplicationHelper::getClientInfo($cid);		/*		 * Here we set the folder we are going to remove the files from.		 */		if ($client)		{			$pathname = 'extension_' . $client->name;			$destination = $this->getPath($pathname);		}		else		{			$pathname = 'extension_root';			$destination = $this->getPath($pathname);		}		/*		 * Here we set the folder we are going to copy the files from.		 *		 * Does the element have a folder attribute?		 *		 * If so this indicates that the files are in a subdirectory of the source		 * folder and we should append the folder attribute to the source path when		 * copying files.		 */		$folder = (string) $element->attributes()->folder;		if ($folder && file_exists($this->getPath('source') . '/' . $folder))		{			$source = $this->getPath('source') . '/' . $folder;		}		else		{			$source = $this->getPath('source');		}		// Work out what files have been deleted		if ($oldFiles && ($oldFiles instanceof SimpleXMLElement))		{			$oldEntries = $oldFiles->children();			if (count($oldEntries))			{				$deletions = $this->findDeletedFiles($oldEntries, $element->children());				foreach ($deletions['folders'] as $deleted_folder)				{					JFolder::delete($destination . '/' . $deleted_folder);				}				foreach ($deletions['files'] as $deleted_file)				{					JFile::delete($destination . '/' . $deleted_file);				}			}		}		$path = array();		// Copy the MD5SUMS file if it exists		if (file_exists($source . '/MD5SUMS'))		{			$path['src'] = $source . '/MD5SUMS';			$path['dest'] = $destination . '/MD5SUMS';			$path['type'] = 'file';			$copyfiles[] = $path;		}		// Process each file in the $files array (children of $tagName).		foreach ($element->children() as $file)		{			$path['src'] = $source . '/' . $file;			$path['dest'] = $destination . '/' . $file;			// Is this path a file or folder?			$path['type'] = ($file->getName() == 'folder') ? 'folder' : 'file';			/*			 * Before we can add a file to the copyfiles array we need to ensure			 * that the folder we are copying our file to exits and if it doesn't,			 * we need to create it.			 */			if (basename($path['dest']) != $path['dest'])			{				$newdir = dirname($path['dest']);				if (!JFolder::create($newdir))				{					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_CREATE_DIRECTORY', $newdir), JLog::WARNING, 'jerror');					return false;				}			}			// Add the file to the copyfiles array			$copyfiles[] = $path;		}		return $this->copyFiles($copyfiles);	}	/**	 * Method to parse through a languages element of the installation manifest and take appropriate	 * action.	 *	 * @param   SimpleXMLElement  $element  The XML node to process	 * @param   integer           $cid      Application ID of application to install to	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function parseLanguages(SimpleXMLElement $element, $cid = 0)	{		// TODO: work out why the below line triggers 'node no longer exists' errors with files		if (!$element || !count($element->children()))		{			// Either the tag does not exist or has no children therefore we return zero files processed.			return 0;		}		$copyfiles = array();		// Get the client info		$client = JApplicationHelper::getClientInfo($cid);		// Here we set the folder we are going to copy the files to.		// 'languages' Files are copied to JPATH_BASE/language/ folder		$destination = $client->path . '/language';		/*		 * Here we set the folder we are going to copy the files from.		 *		 * Does the element have a folder attribute?		 *		 * If so this indicates that the files are in a subdirectory of the source		 * folder and we should append the folder attribute to the source path when		 * copying files.		 */		$folder = (string) $element->attributes()->folder;		if ($folder && file_exists($this->getPath('source') . '/' . $folder))		{			$source = $this->getPath('source') . '/' . $folder;		}		else		{			$source = $this->getPath('source');		}		// Process each file in the $files array (children of $tagName).		foreach ($element->children() as $file)		{			/*			 * Language files go in a subfolder based on the language code, ie.			 * <language tag="en-US">en-US.mycomponent.ini</language>			 * would go in the en-US subdirectory of the language folder.			 */			// We will only install language files where a core language pack			// already exists.			if ((string) $file->attributes()->tag != '')			{				$path['src'] = $source . '/' . $file;				if ((string) $file->attributes()->client != '')				{					// Override the client					$langclient = JApplicationHelper::getClientInfo((string) $file->attributes()->client, true);					$path['dest'] = $langclient->path . '/language/' . $file->attributes()->tag . '/' . basename((string) $file);				}				else				{					// Use the default client					$path['dest'] = $destination . '/' . $file->attributes()->tag . '/' . basename((string) $file);				}				// If the language folder is not present, then the core pack hasn't been installed... ignore				if (!JFolder::exists(dirname($path['dest'])))				{					continue;				}			}			else			{				$path['src'] = $source . '/' . $file;				$path['dest'] = $destination . '/' . $file;			}			/*			 * Before we can add a file to the copyfiles array we need to ensure			 * that the folder we are copying our file to exits and if it doesn't,			 * we need to create it.			 */			if (basename($path['dest']) != $path['dest'])			{				$newdir = dirname($path['dest']);				if (!JFolder::create($newdir))				{					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_CREATE_DIRECTORY', $newdir), JLog::WARNING, 'jerror');					return false;				}			}			// Add the file to the copyfiles array			$copyfiles[] = $path;		}		return $this->copyFiles($copyfiles);	}	/**	 * Method to parse through a media element of the installation manifest and take appropriate	 * action.	 *	 * @param   SimpleXMLElement  $element  The XML node to process	 * @param   integer           $cid      Application ID of application to install to	 *	 * @return  boolean     True on success	 *	 * @since   3.1	 */	public function parseMedia(SimpleXMLElement $element, $cid = 0)	{		if (!$element || !count($element->children()))		{			// Either the tag does not exist or has no children therefore we return zero files processed.			return 0;		}		$copyfiles = array();		// Here we set the folder we are going to copy the files to.		// Default 'media' Files are copied to the JPATH_BASE/media folder		$folder = ((string) $element->attributes()->destination) ? '/' . $element->attributes()->destination : null;		$destination = JPath::clean(JPATH_ROOT . '/media' . $folder);		// Here we set the folder we are going to copy the files from.		/*		 * Does the element have a folder attribute?		 * If so this indicates that the files are in a subdirectory of the source		 * folder and we should append the folder attribute to the source path when		 * copying files.		 */		$folder = (string) $element->attributes()->folder;		if ($folder && file_exists($this->getPath('source') . '/' . $folder))		{			$source = $this->getPath('source') . '/' . $folder;		}		else		{			$source = $this->getPath('source');		}		// Process each file in the $files array (children of $tagName).		foreach ($element->children() as $file)		{			$path['src'] = $source . '/' . $file;			$path['dest'] = $destination . '/' . $file;			// Is this path a file or folder?			$path['type'] = ($file->getName() == 'folder') ? 'folder' : 'file';			/*			 * Before we can add a file to the copyfiles array we need to ensure			 * that the folder we are copying our file to exits and if it doesn't,			 * we need to create it.			 */			if (basename($path['dest']) != $path['dest'])			{				$newdir = dirname($path['dest']);				if (!JFolder::create($newdir))				{					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_CREATE_DIRECTORY', $newdir), JLog::WARNING, 'jerror');					return false;				}			}			// Add the file to the copyfiles array			$copyfiles[] = $path;		}		return $this->copyFiles($copyfiles);	}	/**	 * Method to parse the parameters of an extension, build the INI	 * string for its default parameters, and return the INI string.	 *	 * @return  string   INI string of parameter values	 *	 * @since   3.1	 */	public function getParams()	{		// Validate that we have a fieldset to use		if (!isset($this->manifest->config->fields->fieldset))		{			return '{}';		}		// Getting the fieldset tags		$fieldsets = $this->manifest->config->fields->fieldset;		// Creating the data collection variable:		$ini = array();		// Iterating through the fieldsets:		foreach ($fieldsets as $fieldset)		{			if (!count($fieldset->children()))			{				// Either the tag does not exist or has no children therefore we return zero files processed.				return null;			}			// Iterating through the fields and collecting the name/default values:			foreach ($fieldset as $field)			{				// Check against the null value since otherwise default values like "0"				// cause entire parameters to be skipped.				if (($name = $field->attributes()->name) === null)				{					continue;				}				if (($value = $field->attributes()->default) === null)				{					continue;				}				$ini[(string) $name] = (string) $value;			}		}		return json_encode($ini);	}	/**	 * Copyfiles	 *	 * Copy files from source directory to the target directory	 *	 * @param   array    $files      Array with filenames	 * @param   boolean  $overwrite  True if existing files can be replaced	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function copyFiles($files, $overwrite = null)	{		/*		 * To allow for manual override on the overwriting flag, we check to see if		 * the $overwrite flag was set and is a boolean value.  If not, use the object		 * allowOverwrite flag.		 */		if (is_null($overwrite) || !is_bool($overwrite))		{			$overwrite = $this->overwrite;		}		/*		 * $files must be an array of filenames.  Verify that it is an array with		 * at least one file to copy.		 */		if (is_array($files) && count($files) > 0)		{			foreach ($files as $file)			{				// Get the source and destination paths				$filesource = JPath::clean($file['src']);				$filedest = JPath::clean($file['dest']);				$filetype = array_key_exists('type', $file) ? $file['type'] : 'file';				if (!file_exists($filesource))				{					/*					 * The source file does not exist.  Nothing to copy so set an error					 * and return false.					 */					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_NO_FILE', $filesource), JLog::WARNING, 'jerror');					return false;				}				elseif (($exists = file_exists($filedest)) && !$overwrite)				{					// It's okay if the manifest already exists					if ($this->getPath('manifest') == $filesource)					{						continue;					}					// The destination file already exists and the overwrite flag is false.					// Set an error and return false.					JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_FILE_EXISTS', $filedest), JLog::WARNING, 'jerror');					return false;				}				else				{					// Copy the folder or file to the new location.					if ($filetype == 'folder')					{						if (!(JFolder::copy($filesource, $filedest, null, $overwrite)))						{							JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_FAIL_COPY_FOLDER', $filesource, $filedest), JLog::WARNING, 'jerror');							return false;						}						$step = array('type' => 'folder', 'path' => $filedest);					}					else					{						if (!(JFile::copy($filesource, $filedest, null)))						{							JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_FAIL_COPY_FILE', $filesource, $filedest), JLog::WARNING, 'jerror');							return false;						}						$step = array('type' => 'file', 'path' => $filedest);					}					/*					 * Since we copied a file/folder, we want to add it to the installation step stack so that					 * in case we have to roll back the installation we can remove the files copied.					 */					if (!$exists)					{						$this->stepStack[] = $step;					}				}			}		}		else		{			// The $files variable was either not an array or an empty array			return false;		}		return count($files);	}	/**	 * Method to parse through a files element of the installation manifest and remove	 * the files that were installed	 *	 * @param   object   $element  The XML node to process	 * @param   integer  $cid      Application ID of application to remove from	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function removeFiles($element, $cid = 0)	{		if (!$element || !count($element->children()))		{			// Either the tag does not exist or has no children therefore we return zero files processed.			return true;		}		$retval = true;		$debug = false;		if (isset($GLOBALS['installerdebug']) && $GLOBALS['installerdebug'])		{			$debug = true;		}		// Get the client info if we're using a specific client		if ($cid > -1)		{			$client = JApplicationHelper::getClientInfo($cid);		}		else		{			$client = null;		}		// Get the array of file nodes to process		$files = $element->children();		if (count($files) == 0)		{			// No files to process			return true;		}		$folder = '';		/*		 * Here we set the folder we are going to remove the files from.  There are a few		 * special cases that need to be considered for certain reserved tags.		 */		switch ($element->getName())		{			case 'media':				if ((string) $element->attributes()->destination)				{					$folder = (string) $element->attributes()->destination;				}				else				{					$folder = '';				}				$source = $client->path . '/media/' . $folder;				break;			case 'languages':				$lang_client = (string) $element->attributes()->client;				if ($lang_client)				{					$client = JApplicationHelper::getClientInfo($lang_client, true);					$source = $client->path . '/language';				}				else				{					if ($client)					{						$source = $client->path . '/language';					}					else					{						$source = '';					}				}				break;			default:				if ($client)				{					$pathname = 'extension_' . $client->name;					$source = $this->getPath($pathname);				}				else				{					$pathname = 'extension_root';					$source = $this->getPath($pathname);				}				break;		}		// Process each file in the $files array (children of $tagName).		foreach ($files as $file)		{			/*			 * If the file is a language, we must handle it differently.  Language files			 * go in a subdirectory based on the language code, ie.			 * <language tag="en_US">en_US.mycomponent.ini</language>			 * would go in the en_US subdirectory of the languages directory.			 */			if ($file->getName() == 'language' && (string) $file->attributes()->tag != '')			{				if ($source)				{					$path = $source . '/' . $file->attributes()->tag . '/' . basename((string) $file);				}				else				{					$target_client = JApplicationHelper::getClientInfo((string) $file->attributes()->client, true);					$path = $target_client->path . '/language/' . $file->attributes()->tag . '/' . basename((string) $file);				}				// If the language folder is not present, then the core pack hasn't been installed... ignore				if (!JFolder::exists(dirname($path)))				{					continue;				}			}			else			{				$path = $source . '/' . $file;			}			// Actually delete the files/folders			if (is_dir($path))			{				$val = JFolder::delete($path);			}			else			{				$val = JFile::delete($path);			}			if ($val === false)			{				JLog::add('Failed to delete ' . $path, JLog::WARNING, 'jerror');				$retval = false;			}		}		if (!empty($folder))		{			$val = JFolder::delete($source);		}		return $retval;	}	/**	 * Copies the installation manifest file to the extension folder in the given client	 *	 * @param   integer  $cid  Where to copy the installfile [optional: defaults to 1 (admin)]	 *	 * @return  boolean  True on success, False on error	 *	 * @since   3.1	 */	public function copyManifest($cid = 1)	{		// Get the client info		$client = JApplicationHelper::getClientInfo($cid);		$path['src'] = $this->getPath('manifest');		if ($client)		{			$pathname = 'extension_' . $client->name;			$path['dest'] = $this->getPath($pathname) . '/' . basename($this->getPath('manifest'));		}		else		{			$pathname = 'extension_root';			$path['dest'] = $this->getPath($pathname) . '/' . basename($this->getPath('manifest'));		}		return $this->copyFiles(array($path), true);	}	/**	 * Tries to find the package manifest file	 *	 * @return  boolean  True on success, False on error	 *	 * @since 3.1	 */	public function findManifest()	{		// Main folder manifests (higher priority)		$parentXmlfiles = JFolder::files($this->getPath('source'), '.xml$', false, true);		// Search for children manifests (lower priority)		$allXmlFiles    = JFolder::files($this->getPath('source'), '.xml$', 1, true);		// Create an unique array of files ordered by priority		$xmlfiles = array_unique(array_merge($parentXmlfiles, $allXmlFiles));		// If at least one XML file exists		if (!empty($xmlfiles))		{			foreach ($xmlfiles as $file)			{				// Is it a valid Joomla installation manifest file?				$manifest = $this->isManifest($file);				if (!is_null($manifest))				{					// If the root method attribute is set to upgrade, allow file overwrite					if ((string) $manifest->attributes()->method == 'upgrade')					{						$this->upgrade = true;						$this->overwrite = true;					}					// If the overwrite option is set, allow file overwriting					if ((string) $manifest->attributes()->overwrite == 'true')					{						$this->overwrite = true;					}					// Set the manifest object and path					$this->manifest = $manifest;					$this->setPath('manifest', $file);					// Set the installation source path to that of the manifest file					$this->setPath('source', dirname($file));					return true;				}			}			// None of the XML files found were valid install files			JLog::add(JText::_('JLIB_INSTALLER_ERROR_NOTFINDJOOMLAXMLSETUPFILE'), JLog::WARNING, 'jerror');			return false;		}		else		{			// No XML files were found in the install folder			JLog::add(JText::_('JLIB_INSTALLER_ERROR_NOTFINDXMLSETUPFILE'), JLog::WARNING, 'jerror');			return false;		}	}	/**	 * Is the XML file a valid Joomla installation manifest file.	 *	 * @param   string  $file  An xmlfile path to check	 *	 * @return  mixed  A SimpleXMLElement, or null if the file failed to parse	 *	 * @since   3.1	 */	public function isManifest($file)	{		$xml = simplexml_load_file($file);		// If we cannot load the XML file return null		if (!$xml)		{			return null;		}		// Check for a valid XML root tag.		if ($xml->getName() != 'extension')		{			return null;		}		// Valid manifest file return the object		return $xml;	}	/**	 * Generates a manifest cache	 *	 * @return string serialised manifest data	 *	 * @since   3.1	 */	public function generateManifestCache()	{		return json_encode(self::parseXMLInstallFile($this->getPath('manifest')));	}	/**	 * Cleans up discovered extensions if they're being installed some other way	 *	 * @param   string   $type     The type of extension (component, etc)	 * @param   string   $element  Unique element identifier (e.g. com_content)	 * @param   string   $folder   The folder of the extension (plugins; e.g. system)	 * @param   integer  $client   The client application (administrator or site)	 *	 * @return  object    Result of query	 *	 * @since   3.1	 */	public function cleanDiscoveredExtension($type, $element, $folder = '', $client = 0)	{		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->delete($db->quoteName('#__extensions'))			->where('type = ' . $db->quote($type))			->where('element = ' . $db->quote($element))			->where('folder = ' . $db->quote($folder))			->where('client_id = ' . (int) $client)			->where('state = -1');		$db->setQuery($query);		return $db->execute();	}	/**	 * Compares two "files" entries to find deleted files/folders	 *	 * @param   array  $old_files  An array of SimpleXMLElement objects that are the old files	 * @param   array  $new_files  An array of SimpleXMLElement objects that are the new files	 *	 * @return  array  An array with the delete files and folders in findDeletedFiles[files] and findDeletedFiles[folders] respectively	 *	 * @since   3.1	 */	public function findDeletedFiles($old_files, $new_files)	{		// The magic find deleted files function!		// The files that are new		$files = array();		// The folders that are new		$folders = array();		// The folders of the files that are new		$containers = array();		// A list of files to delete		$files_deleted = array();		// A list of folders to delete		$folders_deleted = array();		foreach ($new_files as $file)		{			switch ($file->getName())			{				case 'folder':					// Add any folders to the list					$folders[] = (string) $file; // add any folders to the list					break;				case 'file':				default:					// Add any files to the list					$files[] = (string) $file;					// Now handle the folder part of the file to ensure we get any containers					// Break up the parts of the directory					$container_parts = explode('/', dirname((string) $file));					// Make sure this is clean and empty					$container = '';					foreach ($container_parts as $part)					{						// Iterate through each part						// Add a slash if its not empty						if (!empty($container))						{							$container .= '/';						}						// Aappend the folder part						$container .= $part;						if (!in_array($container, $containers))						{							// Add the container if it doesn't already exist							$containers[] = $container;						}					}					break;			}		}		foreach ($old_files as $file)		{			switch ($file->getName())			{				case 'folder':					if (!in_array((string) $file, $folders))					{						// See whether the folder exists in the new list						if (!in_array((string) $file, $containers))						{							// Check if the folder exists as a container in the new list							// If it's not in the new list or a container then delete it							$folders_deleted[] = (string) $file;						}					}					break;				case 'file':				default:					if (!in_array((string) $file, $files))					{						// Look if the file exists in the new list						if (!in_array(dirname((string) $file), $folders))						{							// Look if the file is now potentially in a folder							$files_deleted[] = (string) $file; // not in a folder, doesn't exist, wipe it out!						}					}					break;			}		}		return array('files' => $files_deleted, 'folders' => $folders_deleted);	}	/**	 * Loads an MD5SUMS file into an associative array	 *	 * @param   string  $filename  Filename to load	 *	 * @return  array  Associative array with filenames as the index and the MD5 as the value	 *	 * @since   3.1	 */	public function loadMD5Sum($filename)	{		if (!file_exists($filename))		{			// Bail if the file doesn't exist			return false;		}		$data = file($filename, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);		$retval = array();		foreach ($data as $row)		{			// Split up the data			$results = explode('  ', $row);			// Cull any potential prefix			$results[1] = str_replace('./', '', $results[1]);			// Throw into the array			$retval[$results[1]] = $results[0];		}		return $retval;	}	/**	 * Parse a XML install manifest file.	 *	 * XML Root tag should be 'install' except for languages which use meta file.	 *	 * @param   string  $path  Full path to XML file.	 *	 * @return  array  XML metadata.	 *	 * @since   12.1	 */	public static function parseXMLInstallFile($path)	{		// Read the file to see if it's a valid component XML file		$xml = simplexml_load_file($path);		if (!$xml)		{			return false;		}		// Check for a valid XML root tag.		// Extensions use 'extension' as the root tag.  Languages use 'metafile' instead		if ($xml->getName() != 'extension' && $xml->getName() != 'metafile')		{			unset($xml);			return false;		}		$data = array();		$data['name'] = (string) $xml->name;		// Check if we're a language. If so use metafile.		$data['type'] = $xml->getName() == 'metafile' ? 'language' : (string) $xml->attributes()->type;		$data['creationDate'] = ((string) $xml->creationDate) ? (string) $xml->creationDate : JText::_('Unknown');		$data['author'] = ((string) $xml->author) ? (string) $xml->author : JText::_('Unknown');		$data['copyright'] = (string) $xml->copyright;		$data['authorEmail'] = (string) $xml->authorEmail;		$data['authorUrl'] = (string) $xml->authorUrl;		$data['version'] = (string) $xml->version;		$data['description'] = (string) $xml->description;		$data['group'] = (string) $xml->group;		return $data;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Stemmer base class for the Finder indexer package. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderIndexerTaxonomy{	/**	 * An internal cache of taxonomy branch data.	 *	 * @var    array	 * @since  2.5	 */	public static $branches = array();	/**	 * An internal cache of taxonomy node data.	 *	 * @var    array	 * @since  2.5	 */	public static $nodes = array();	/**	 * Method to add a branch to the taxonomy tree.	 *	 * @param   string   $title   The title of the branch.	 * @param   integer  $state   The published state of the branch. [optional]	 * @param   integer  $access  The access state of the branch. [optional]	 *	 * @return  integer  The id of the branch.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function addBranch($title, $state = 1, $access = 1)	{		// Check to see if the branch is in the cache.		if (isset(self::$branches[$title]))		{			return self::$branches[$title]->id;		}		// Check to see if the branch is in the table.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('*')			->from($db->quoteName('#__finder_taxonomy'))			->where($db->quoteName('parent_id') . ' = 1')			->where($db->quoteName('title') . ' = ' . $db->quote($title));		$db->setQuery($query);		// Get the result.		$result = $db->loadObject();		// Check if the database matches the input data.		if (!empty($result) && $result->state == $state && $result->access == $access)		{			// The data matches, add the item to the cache.			self::$branches[$title] = $result;			return self::$branches[$title]->id;		}		// The database did not match the input. This could be because the		// state has changed or because the branch does not exist. Let's figure		// out which case is true and deal with it.		$branch = new JObject;		if (empty($result))		{			// Prepare the branch object.			$branch->parent_id = 1;			$branch->title = $title;			$branch->state = (int) $state;			$branch->access = (int) $access;		}		else		{			// Prepare the branch object.			$branch->id = (int) $result->id;			$branch->parent_id = (int) $result->parent_id;			$branch->title = $result->title;			$branch->state = (int) $result->title;			$branch->access = (int) $result->access;			$branch->ordering = (int) $result->ordering;		}		// Store the branch.		self::storeNode($branch);		// Add the branch to the cache.		self::$branches[$title] = $branch;		return self::$branches[$title]->id;	}	/**	 * Method to add a node to the taxonomy tree.	 *	 * @param   string   $branch  The title of the branch to store the node in.	 * @param   string   $title   The title of the node.	 * @param   integer  $state   The published state of the node. [optional]	 * @param   integer  $access  The access state of the node. [optional]	 *	 * @return  integer  The id of the node.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function addNode($branch, $title, $state = 1, $access = 1)	{		// Check to see if the node is in the cache.		if (isset(self::$nodes[$branch][$title]))		{			return self::$nodes[$branch][$title]->id;		}		// Get the branch id, insert it if it does not exist.		$branchId = self::addBranch($branch);		// Check to see if the node is in the table.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('*')			->from($db->quoteName('#__finder_taxonomy'))			->where($db->quoteName('parent_id') . ' = ' . $db->quote($branchId))			->where($db->quoteName('title') . ' = ' . $db->quote($title));		$db->setQuery($query);		// Get the result.		$result = $db->loadObject();		// Check if the database matches the input data.		if (!empty($result) && $result->state == $state && $result->access == $access)		{			// The data matches, add the item to the cache.			self::$nodes[$branch][$title] = $result;			return self::$nodes[$branch][$title]->id;		}		// The database did not match the input. This could be because the		// state has changed or because the node does not exist. Let's figure		// out which case is true and deal with it.		$node = new JObject;		if (empty($result))		{			// Prepare the node object.			$node->parent_id = (int) $branchId;			$node->title = $title;			$node->state = (int) $state;			$node->access = (int) $access;		}		else		{			// Prepare the node object.			$node->id = (int) $result->id;			$node->parent_id = (int) $result->parent_id;			$node->title = $result->title;			$node->state = (int) $result->title;			$node->access = (int) $result->access;			$node->ordering = (int) $result->ordering;		}		// Store the node.		self::storeNode($node);		// Add the node to the cache.		self::$nodes[$branch][$title] = $node;		return self::$nodes[$branch][$title]->id;	}	/**	 * Method to add a map entry between a link and a taxonomy node.	 *	 * @param   integer  $linkId  The link to map to.	 * @param   integer  $nodeId  The node to map to.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function addMap($linkId, $nodeId)	{		// Insert the map.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select($db->quoteName('link_id'))			->from($db->quoteName('#__finder_taxonomy_map'))			->where($db->quoteName('link_id') . ' = ' . (int) $linkId)			->where($db->quoteName('node_id') . ' = ' . (int) $nodeId);		$db->setQuery($query);		$db->execute();		$id = (int) $db->loadResult();		$map = new JObject;		$map->link_id = (int) $linkId;		$map->node_id = (int) $nodeId;		if ($id)		{			$db->updateObject('#__finder_taxonomy_map', $map);		}		else		{			$db->insertObject('#__finder_taxonomy_map', $map);		}		return true;	}	/**	 * Method to get the title of all taxonomy branches.	 *	 * @return  array  An array of branch titles.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function getBranchTitles()	{		$db = JFactory::getDbo();		// Set user variables		$user = JFactory::getUser();		$groups = implode(',', $user->getAuthorisedViewLevels());		// Create a query to get the taxonomy branch titles.		$query = $db->getQuery(true)			->select($db->quoteName('title'))			->from($db->quoteName('#__finder_taxonomy'))			->where($db->quoteName('parent_id') . ' = 1')			->where($db->quoteName('state') . ' = 1')			->where($db->quoteName('access') . ' IN (' . $groups . ')');		// Get the branch titles.		$db->setQuery($query);		$results = $db->loadColumn();		return $results;	}	/**	 * Method to find a taxonomy node in a branch.	 *	 * @param   string  $branch  The branch to search.	 * @param   string  $title   The title of the node.	 *	 * @return  mixed  Integer id on success, null on no match.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function getNodeByTitle($branch, $title)	{		$db = JFactory::getDbo();		// Set user variables		$user = JFactory::getUser();		$groups = implode(',', $user->getAuthorisedViewLevels());		// Create a query to get the node.		$query = $db->getQuery(true)			->select('t1.*')			->from($db->quoteName('#__finder_taxonomy') . ' AS t1')			->join('INNER', $db->quoteName('#__finder_taxonomy') . ' AS t2 ON t2.id = t1.parent_id')			->where('t1.access IN (' . $groups . ')')			->where('t1.state = 1')			->where('t1.title LIKE ' . $db->quote($db->escape($title) . '%'))			->where('t2.access IN (' . $groups . ')')			->where('t2.state = 1')			->where('t2.title = ' . $db->quote($branch));		// Get the node.		$db->setQuery($query, 0, 1);		$result = $db->loadObject();		return $result;	}	/**	 * Method to remove map entries for a link.	 *	 * @param   integer  $linkId  The link to remove.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function removeMaps($linkId)	{		// Delete the maps.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->delete($db->quoteName('#__finder_taxonomy_map'))			->where($db->quoteName('link_id') . ' = ' . (int) $linkId);		$db->setQuery($query);		$db->execute();		return true;	}	/**	 * Method to remove orphaned taxonomy nodes and branches.	 *	 * @return  integer  The number of deleted rows.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public static function removeOrphanNodes()	{		// Delete all orphaned nodes.		$db = JFactory::getDbo();		$query = 'DELETE t' .			' FROM ' . $db->quoteName('#__finder_taxonomy') . ' AS t' .			' LEFT JOIN ' . $db->quoteName('#__finder_taxonomy_map') . ' AS m ON m.node_id = t.id' .			' WHERE t.parent_id > 1' .			' AND m.link_id IS NULL';		$db->setQuery($query);		$db->execute();		return $db->getAffectedRows();	}	/**	 * Method to store a node to the database.  This method will accept either a branch or a node.	 *	 * @param   object  $item  The item to store.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	protected static function storeNode($item)	{		$db = JFactory::getDbo();		// Check if we are updating or inserting the item.		if (empty($item->id))		{			// Insert the item.			$db->insertObject('#__finder_taxonomy', $item, 'id');		}		else		{			// Update the item.			$db->updateObject('#__finder_taxonomy', $item, 'id');		}		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_plugins * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Plugin model. * * @package     Joomla.Administrator * @subpackage  com_plugins * @since       1.6 */class PluginsModelPlugin extends JModelAdmin{	/**	 * @var		string	The help screen key for the module.	 * @since   1.6	 */	protected $helpKey = 'JHELP_EXTENSIONS_PLUGIN_MANAGER_EDIT';	/**	 * @var		string	The help screen base URL for the module.	 * @since   1.6	 */	protected $helpURL;	protected $_cache;	/**	 * @var		string	The event to trigger after saving the data.	 * @since   1.6	 */	protected $event_after_save = 'onExtensionAfterSave';	/**	 * @var		string	The event to trigger after before the data.	 * @since   1.6	 */	protected $event_before_save = 'onExtensionBeforeSave';	/**	 * Method to get the record form.	 *	 * @param   array  $data		Data for the form.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// The folder and element vars are passed when saving the form.		if (empty($data))		{			$item		= $this->getItem();			$folder		= $item->folder;			$element	= $item->element;		}		else		{			$folder		= JArrayHelper::getValue($data, 'folder', '', 'cmd');			$element	= JArrayHelper::getValue($data, 'element', '', 'cmd');		}		// These variables are used to add data from the plugin XML files.		$this->setState('item.folder',	$folder);		$this->setState('item.element',	$element);		// Get the form.		$form = $this->loadForm('com_plugins.plugin', 'plugin', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		// Modify the form based on access controls.		if (!$this->canEditState((object) $data))		{			// Disable fields for display.			$form->setFieldAttribute('ordering', 'disabled', 'true');			$form->setFieldAttribute('enabled', 'disabled', 'true');			// Disable fields while saving.			// The controller has already verified this is a record you can edit.			$form->setFieldAttribute('ordering', 'filter', 'unset');			$form->setFieldAttribute('enabled', 'filter', 'unset');		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_plugins.edit.plugin.data', array());		if (empty($data))		{			$data = $this->getItem();		}		$this->preprocessData('com_plugins.plugin', $data);		return $data;	}	/**	 * Method to get a single record.	 *	 * @param   integer	The id of the primary key.	 *	 * @return  mixed  Object on success, false on failure.	 */	public function getItem($pk = null)	{		$pk = (!empty($pk)) ? $pk : (int) $this->getState('plugin.id');		if (!isset($this->_cache[$pk]))		{			$false	= false;			// Get a row instance.			$table = $this->getTable();			// Attempt to load the row.			$return = $table->load($pk);			// Check for a table object error.			if ($return === false && $table->getError())			{				$this->setError($table->getError());				return $false;			}			// Convert to the JObject before adding other data.			$properties = $table->getProperties(1);			$this->_cache[$pk] = JArrayHelper::toObject($properties, 'JObject');			// Convert the params field to an array.			$registry = new JRegistry;			$registry->loadString($table->params);			$this->_cache[$pk]->params = $registry->toArray();			// Get the plugin XML.			$path = JPath::clean(JPATH_PLUGINS.'/'.$table->folder.'/'.$table->element.'/'.$table->element.'.xml');			if (file_exists($path))			{				$this->_cache[$pk]->xml = simplexml_load_file($path);			} else {				$this->_cache[$pk]->xml = null;			}		}		return $this->_cache[$pk];	}	/**	 * Returns a reference to the a Table object, always creating it.	 *	 * @param   type	The table type to instantiate	 * @param   string	A prefix for the table class name. Optional.	 * @param   array  Configuration array for model. Optional.	 * @return  JTable	A database object	*/	public function getTable($type = 'Extension', $prefix = 'JTable', $config = array())	{		return JTable::getInstance($type, $prefix, $config);	}	/**	 * Auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @return  void	 * @since   1.6	 */	protected function populateState()	{		// Execute the parent method.		parent::populateState();		$app = JFactory::getApplication('administrator');		// Load the User state.		$pk = $app->input->getInt('extension_id');		$this->setState('plugin.id', $pk);	}	/**	 * @param   object	A form object.	 * @param   mixed	The data expected for the form.	 * @return  mixed  True if successful.	 * @throws	Exception if there is an error in the form event.	 * @since   1.6	 */	protected function preprocessForm(JForm $form, $data, $group = 'content')	{		jimport('joomla.filesystem.path');		$folder		= $this->getState('item.folder');		$element	= $this->getState('item.element');		$lang		= JFactory::getLanguage();		$client		= JApplicationHelper::getClientInfo(0);		// Load the core and/or local language sys file(s) for the ordering field.		$db = JFactory::getDbo();		$query = 'SELECT element' .				' FROM #__extensions' .				' WHERE (type =' .$db->quote('plugin'). 'AND folder='. $db->quote($folder) . ')';		$db->setQuery($query);		$elements = $db->loadColumn();		foreach ($elements as $elementa)		{				$lang->load('plg_'.$folder.'_'.$elementa.'.sys', JPATH_ADMINISTRATOR, null, false, false)			||	$lang->load('plg_'.$folder.'_'.$elementa.'.sys', JPATH_PLUGINS.'/'.$folder.'/'.$elementa, null, false, false)			||	$lang->load('plg_'.$folder.'_'.$elementa.'.sys', JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)			||	$lang->load('plg_'.$folder.'_'.$elementa.'.sys', JPATH_PLUGINS.'/'.$folder.'/'.$elementa, $lang->getDefault(), false, false);		}		if (empty($folder) || empty($element))		{			$app = JFactory::getApplication();			$app->redirect(JRoute::_('index.php?option=com_plugins&view=plugins', false));		}		$formFile = JPath::clean(JPATH_PLUGINS . '/' . $folder . '/' . $element . '/' . $element . '.xml');		if (!file_exists($formFile))		{			throw new Exception(JText::sprintf('COM_PLUGINS_ERROR_FILE_NOT_FOUND', $element . '.xml'));		}		// Load the core and/or local language file(s).			$lang->load('plg_'.$folder.'_'.$element, JPATH_ADMINISTRATOR, null, false, false)		||	$lang->load('plg_'.$folder.'_'.$element, JPATH_PLUGINS.'/'.$folder.'/'.$element, null, false, false)		||	$lang->load('plg_'.$folder.'_'.$element, JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)		||	$lang->load('plg_'.$folder.'_'.$element, JPATH_PLUGINS.'/'.$folder.'/'.$element, $lang->getDefault(), false, false);		if (file_exists($formFile))		{			// Get the plugin form.			if (!$form->loadFile($formFile, false, '//config'))			{				throw new Exception(JText::_('JERROR_LOADFILE_FAILED'));			}		}		// Attempt to load the xml file.		if (!$xml = simplexml_load_file($formFile))		{			throw new Exception(JText::_('JERROR_LOADFILE_FAILED'));		}		// Get the help data from the XML file if present.		$help = $xml->xpath('/extension/help');		if (!empty($help))		{			$helpKey = trim((string) $help[0]['key']);			$helpURL = trim((string) $help[0]['url']);			$this->helpKey = $helpKey ? $helpKey : $this->helpKey;			$this->helpURL = $helpURL ? $helpURL : $this->helpURL;		}		// Trigger the default form events.		parent::preprocessForm($form, $data, $group);	}	/**	 * A protected method to get a set of ordering conditions.	 *	 * @param   object	A record object.	 * @return  array  An array of conditions to add to add to ordering queries.	 * @since   1.6	 */	protected function getReorderConditions($table)	{		$condition = array();		$condition[] = 'type = '. $this->_db->quote($table->type);		$condition[] = 'folder = '. $this->_db->quote($table->folder);		return $condition;	}	/**	 * Override method to save the form data.	 *	 * @param   array  The form data.	 * @return  boolean  True on success.	 * @since   1.6	 */	public function save($data)	{		// Load the extension plugin group.		JPluginHelper::importPlugin('extension');		// Setup type		$data['type'] = 'plugin';		return parent::save($data);	}	/**	 * Get the necessary data to load an item help screen.	 *	 * @return  object  An object with key, url, and local properties for loading the item help screen.	 * @since   1.6	 */	public function getHelp()	{		return (object) array('key' => $this->helpKey, 'url' => $this->helpURL);	}	/**	 * Custom clean cache method, plugins are cached in 2 places for different clients	 *	 * @since   1.6	 */	protected function cleanCache($group = null, $client_id = 0)	{		parent::cleanCache('com_plugins');	}}
<?php/** * @package     Joomla.Administrator * @subpackage  mod_popular * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JModelLegacy::addIncludePath(JPATH_ADMINISTRATOR.'/components/com_content/models', 'ContentModel');/** * Helper for mod_popular * * @package     Joomla.Administrator * @subpackage  mod_popular * @since       1.6 */abstract class ModPopularHelper{	/**	 * Get a list of the most popular articles	 *	 * @param   JObject		The module parameters.	 *	 * @return  array	 */	public static function getList($params)	{		$user = JFactory::getuser();		// Get an instance of the generic articles model		$model = JModelLegacy::getInstance('Articles', 'ContentModel', array('ignore_request' => true));		// Set List SELECT		$model->setState('list.select', 'a.id, a.title, a.checked_out, a.checked_out_time, ' .				' a.created, a.hits');		// Set Ordering filter		$model->setState('list.ordering', 'a.hits');		$model->setState('list.direction', 'DESC');		// Set Category Filter		$categoryId = $params->get('catid');		if (is_numeric($categoryId)){			$model->setState('filter.category_id', $categoryId);		}		// Set User Filter.		$userId = $user->get('id');		switch ($params->get('user_id'))		{			case 'by_me':				$model->setState('filter.author_id', $userId);				break;			case 'not_me':				$model->setState('filter.author_id', $userId);				$model->setState('filter.author_id.include', false);				break;		}		// Set the Start and Limit		$model->setState('list.start', 0);		$model->setState('list.limit', $params->get('count', 5));		$items = $model->getItems();		if ($error = $model->getError())		{			JError::raiseError(500, $error);			return false;		}		// Set the links		foreach ($items as &$item)		{			if ($user->authorise('core.edit', 'com_content.article.'.$item->id)){				$item->link = JRoute::_('index.php?option=com_content&task=article.edit&id='.$item->id);			} else {				$item->link = '';			}		}		return $items;	}	/**	 * Get the alternate title for the module	 *	 * @param   JObject	The module parameters.	 * @return  string	The alternate title for the module.	 */	public static function getTitle($params)	{		$who = $params->get('user_id');		$catid = (int) $params->get('catid');		if ($catid)		{			$category = JCategories::getInstance('Content')->get($catid);			if ($category)			{				$title = $category->title;			}			else {				$title = JText::_('MOD_POPULAR_UNEXISTING');			}		}		else		{			$title = '';		}		return JText::plural('MOD_POPULAR_TITLE' . ($catid ? "_CATEGORY" : '') . ($who != '0' ? "_$who" : ''), (int) $params->get('count'), $title);	}}
<?php/** * @package     Joomla.Platform * @subpackage  Language * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Allows for quoting in language .ini files. */define('_QQ_', '"');/** * Languages/translation handler class * * @package     Joomla.Platform * @subpackage  Language * @since       11.1 */class JLanguage{	protected static $languages = array();	/**	 * Debug language, If true, highlights if string isn't found.	 * @var    boolean	 * @since  11.1	 */	protected $debug = false;	/**	 * The default language, used when a language file in the requested language does not exist.	 * @var    string	 * @since  11.1	 */	protected $default = 'en-GB';	/**	 * An array of orphaned text.	 * @var    array	 * @since  11.1	 */	protected $orphans = array();	/**	 * Array holding the language metadata.	 * @var    array	 * @since  11.1	 */	protected $metadata = null;	/**	 * Array holding the language locale or boolean null if none.	 * @var    array|boolean	 * @since  11.1	 */	protected $locale = null;	/**	 * The language to load.	 * @var    string	 * @since  11.1	 */	protected $lang = null;	/**	 * A nested array of language files that have been loaded	 * @var    array	 * @since  11.1	 */	protected $paths = array();	/**	 * List of language files that are in error state	 * @var    array	 * @since  11.1	 */	protected $errorfiles = array();	/**	 * Translations	 * @var    array	 * @since  11.1	 */	protected $strings = null;	/**	 * An array of used text, used during debugging.	 * @var    array	 * @since  11.1	 */	protected $used = array();	/**	 * Counter for number of loads.	 * @var    integer	 * @since  11.1	 */	protected $counter = 0;	/**	 * An array used to store overrides.	 * @var    array	 * @since  11.1	 */	protected $override = array();	/**	 * Name of the transliterator function for this language.	 * @var    string	 * @since  11.1	 */	protected $transliterator = null;	/**	 * Name of the pluralSuffixesCallback function for this language.	 * @var    string	 * @since  11.1	 */	protected $pluralSuffixesCallback = null;	/**	 * Name of the ignoredSearchWordsCallback function for this language.	 * @var    string	 * @since  11.1	 */	protected $ignoredSearchWordsCallback = null;	/**	 * Name of the lowerLimitSearchWordCallback function for this language.	 * @var    string	 * @since  11.1	 */	protected $lowerLimitSearchWordCallback = null;	/**	 * Name of the uppperLimitSearchWordCallback function for this language	 * @var    string	 * @since  11.1	 */	protected $upperLimitSearchWordCallback = null;	/**	 * Name of the searchDisplayedCharactersNumberCallback function for this language.	 * @var    string	 * @since  11.1	 */	protected $searchDisplayedCharactersNumberCallback = null;	/**	 * Constructor activating the default information of the language.	 *	 * @param   string   $lang   The language	 * @param   boolean  $debug  Indicates if language debugging is enabled.	 *	 * @since   11.1	 */	public function __construct($lang = null, $debug = false)	{		$this->strings = array();		if ($lang == null)		{			$lang = $this->default;		}		$this->setLanguage($lang);		$this->setDebug($debug);		$filename = JPATH_BASE . "/language/overrides/$lang.override.ini";		if (file_exists($filename) && $contents = $this->parse($filename))		{			if (is_array($contents))			{				// Sort the underlying heap by key values to optimize merging				ksort($contents, SORT_STRING);				$this->override = $contents;			}			unset($contents);		}		// Look for a language specific localise class		$class = str_replace('-', '_', $lang . 'Localise');		$paths = array();		if (defined('JPATH_SITE'))		{			// Note: Manual indexing to enforce load order.			$paths[0] = JPATH_SITE . "/language/overrides/$lang.localise.php";			$paths[2] = JPATH_SITE . "/language/$lang/$lang.localise.php";		}		if (defined('JPATH_ADMINISTRATOR'))		{			// Note: Manual indexing to enforce load order.			$paths[1] = JPATH_ADMINISTRATOR . "/language/overrides/$lang.localise.php";			$paths[3] = JPATH_ADMINISTRATOR . "/language/$lang/$lang.localise.php";		}		ksort($paths);		$path = reset($paths);		while (!class_exists($class) && $path)		{			if (file_exists($path))			{				require_once $path;			}			$path = next($paths);		}		if (class_exists($class))		{			/* Class exists. Try to find			 * -a transliterate method,			 * -a getPluralSuffixes method,			 * -a getIgnoredSearchWords method			 * -a getLowerLimitSearchWord method			 * -a getUpperLimitSearchWord method			 * -a getSearchDisplayCharactersNumber method			 */			if (method_exists($class, 'transliterate'))			{				$this->transliterator = array($class, 'transliterate');			}			if (method_exists($class, 'getPluralSuffixes'))			{				$this->pluralSuffixesCallback = array($class, 'getPluralSuffixes');			}			if (method_exists($class, 'getIgnoredSearchWords'))			{				$this->ignoredSearchWordsCallback = array($class, 'getIgnoredSearchWords');			}			if (method_exists($class, 'getLowerLimitSearchWord'))			{				$this->lowerLimitSearchWordCallback = array($class, 'getLowerLimitSearchWord');			}			if (method_exists($class, 'getUpperLimitSearchWord'))			{				$this->upperLimitSearchWordCallback = array($class, 'getUpperLimitSearchWord');			}			if (method_exists($class, 'getSearchDisplayedCharactersNumber'))			{				$this->searchDisplayedCharactersNumberCallback = array($class, 'getSearchDisplayedCharactersNumber');			}		}		$this->load();	}	/**	 * Returns a language object.	 *	 * @param   string   $lang   The language to use.	 * @param   boolean  $debug  The debug mode.	 *	 * @return  JLanguage  The Language object.	 *	 * @since   11.1	 */	public static function getInstance($lang, $debug = false)	{		if (!isset(self::$languages[$lang . $debug]))		{			self::$languages[$lang . $debug] = new JLanguage($lang, $debug);		}		return self::$languages[$lang . $debug];	}	/**	 * Translate function, mimics the php gettext (alias _) function.	 *	 * The function checks if $jsSafe is true, then if $interpretBackslashes is true.	 *	 * @param   string   $string                The string to translate	 * @param   boolean  $jsSafe                Make the result javascript safe	 * @param   boolean  $interpretBackSlashes  Interpret \t and \n	 *	 * @return  string  The translation of the string	 *	 * @since   11.1	 */	public function _($string, $jsSafe = false, $interpretBackSlashes = true)	{		// Detect empty string		if ($string == '')		{			return '';		}		$key = strtoupper($string);		if (isset($this->strings[$key]))		{			$string = $this->debug ? '**' . $this->strings[$key] . '**' : $this->strings[$key];			// Store debug information			if ($this->debug)			{				$caller = $this->getCallerInfo();				if (!array_key_exists($key, $this->used))				{					$this->used[$key] = array();				}				$this->used[$key][] = $caller;			}		}		else		{			if ($this->debug)			{				$caller = $this->getCallerInfo();				$caller['string'] = $string;				if (!array_key_exists($key, $this->orphans))				{					$this->orphans[$key] = array();				}				$this->orphans[$key][] = $caller;				$string = '??' . $string . '??';			}		}		if ($jsSafe)		{			// Javascript filter			$string = addslashes($string);		}		elseif ($interpretBackSlashes)		{			// Interpret \n and \t characters			$string = str_replace(array('\\\\', '\t', '\n'), array("\\", "\t", "\n"), $string);		}		return $string;	}	/**	 * Transliterate function	 *	 * This method processes a string and replaces all accented UTF-8 characters by unaccented	 * ASCII-7 "equivalents".	 *	 * @param   string  $string  The string to transliterate.	 *	 * @return  string  The transliteration of the string.	 *	 * @since   11.1	 */	public function transliterate($string)	{		if ($this->transliterator !== null)		{			return call_user_func($this->transliterator, $string);		}		$string = JLanguageTransliterate::utf8_latin_to_ascii($string);		$string = JString::strtolower($string);		return $string;	}	/**	 * Getter for transliteration function	 *	 * @return  callable  The transliterator function	 *	 * @since   11.1	 */	public function getTransliterator()	{		return $this->transliterator;	}	/**	 * Set the transliteration function.	 *	 * @param   callable  $function  Function name or the actual function.	 *	 * @return  callable  The previous function.	 *	 * @since   11.1	 */	public function setTransliterator($function)	{		$previous = $this->transliterator;		$this->transliterator = $function;		return $previous;	}	/**	 * Returns an array of suffixes for plural rules.	 *	 * @param   integer  $count  The count number the rule is for.	 *	 * @return  array    The array of suffixes.	 *	 * @since   11.1	 */	public function getPluralSuffixes($count)	{		if ($this->pluralSuffixesCallback !== null)		{			return call_user_func($this->pluralSuffixesCallback, $count);		}		else		{			return array((string) $count);		}	}	/**	 * Getter for pluralSuffixesCallback function.	 *	 * @return  callable  Function name or the actual function.	 *	 * @since   11.1	 */	public function getPluralSuffixesCallback()	{		return $this->pluralSuffixesCallback;	}	/**	 * Set the pluralSuffixes function.	 *	 * @param   callable  $function  Function name or actual function.	 *	 * @return  callable  The previous function.	 *	 * @since   11.1	 */	public function setPluralSuffixesCallback($function)	{		$previous = $this->pluralSuffixesCallback;		$this->pluralSuffixesCallback = $function;		return $previous;	}	/**	 * Returns an array of ignored search words	 *	 * @return  array  The array of ignored search words.	 *	 * @since   11.1	 */	public function getIgnoredSearchWords()	{		if ($this->ignoredSearchWordsCallback !== null)		{			return call_user_func($this->ignoredSearchWordsCallback);		}		else		{			return array();		}	}	/**	 * Getter for ignoredSearchWordsCallback function.	 *	 * @return  callable  Function name or the actual function.	 *	 * @since   11.1	 */	public function getIgnoredSearchWordsCallback()	{		return $this->ignoredSearchWordsCallback;	}	/**	 * Setter for the ignoredSearchWordsCallback function	 *	 * @param   callable  $function  Function name or actual function.	 *	 * @return  callable  The previous function.	 *	 * @since   11.1	 */	public function setIgnoredSearchWordsCallback($function)	{		$previous = $this->ignoredSearchWordsCallback;		$this->ignoredSearchWordsCallback = $function;		return $previous;	}	/**	 * Returns a lower limit integer for length of search words	 *	 * @return  integer  The lower limit integer for length of search words (3 if no value was set for a specific language).	 *	 * @since   11.1	 */	public function getLowerLimitSearchWord()	{		if ($this->lowerLimitSearchWordCallback !== null)		{			return call_user_func($this->lowerLimitSearchWordCallback);		}		else		{			return 3;		}	}	/**	 * Getter for lowerLimitSearchWordCallback function	 *	 * @return  callable  Function name or the actual function.	 *	 * @since   11.1	 */	public function getLowerLimitSearchWordCallback()	{		return $this->lowerLimitSearchWordCallback;	}	/**	 * Setter for the lowerLimitSearchWordCallback function.	 *	 * @param   callable  $function  Function name or actual function.	 *	 * @return  callable  The previous function.	 *	 * @since   11.1	 */	public function setLowerLimitSearchWordCallback($function)	{		$previous = $this->lowerLimitSearchWordCallback;		$this->lowerLimitSearchWordCallback = $function;		return $previous;	}	/**	 * Returns an upper limit integer for length of search words	 *	 * @return  integer  The upper limit integer for length of search words (20 if no value was set for a specific language).	 *	 * @since   11.1	 */	public function getUpperLimitSearchWord()	{		if ($this->upperLimitSearchWordCallback !== null)		{			return call_user_func($this->upperLimitSearchWordCallback);		}		else		{			return 20;		}	}	/**	 * Getter for upperLimitSearchWordCallback function	 *	 * @return  callable  Function name or the actual function.	 *	 * @since   11.1	 */	public function getUpperLimitSearchWordCallback()	{		return $this->upperLimitSearchWordCallback;	}	/**	 * Setter for the upperLimitSearchWordCallback function	 *	 * @param   callable  $function  Function name or the actual function.	 *	 * @return  callable  The previous function.	 *	 * @since   11.1	 */	public function setUpperLimitSearchWordCallback($function)	{		$previous = $this->upperLimitSearchWordCallback;		$this->upperLimitSearchWordCallback = $function;		return $previous;	}	/**	 * Returns the number of characters displayed in search results.	 *	 * @return  integer  The number of characters displayed (200 if no value was set for a specific language).	 *	 * @since   11.1	 */	public function getSearchDisplayedCharactersNumber()	{		if ($this->searchDisplayedCharactersNumberCallback !== null)		{			return call_user_func($this->searchDisplayedCharactersNumberCallback);		}		else		{			return 200;		}	}	/**	 * Getter for searchDisplayedCharactersNumberCallback function	 *	 * @return  callable  Function name or the actual function.	 *	 * @since   11.1	 */	public function getSearchDisplayedCharactersNumberCallback()	{		return $this->searchDisplayedCharactersNumberCallback;	}	/**	 * Setter for the searchDisplayedCharactersNumberCallback function.	 *	 * @param   callable  $function  Function name or the actual function.	 *	 * @return  callable  The previous function.	 *	 * @since   11.1	 */	public function setSearchDisplayedCharactersNumberCallback($function)	{		$previous = $this->searchDisplayedCharactersNumberCallback;		$this->searchDisplayedCharactersNumberCallback = $function;		return $previous;	}	/**	 * Checks if a language exists.	 *	 * This is a simple, quick check for the directory that should contain language files for the given user.	 *	 * @param   string  $lang      Language to check.	 * @param   string  $basePath  Optional path to check.	 *	 * @return  boolean  True if the language exists.	 *	 * @since   11.1	 */	public static function exists($lang, $basePath = JPATH_BASE)	{		static $paths = array();		// Return false if no language was specified		if (!$lang)		{			return false;		}		$path = $basePath . '/language/' . $lang;		// Return previous check results if it exists		if (isset($paths[$path]))		{			return $paths[$path];		}		// Check if the language exists		$paths[$path] = is_dir($path);		return $paths[$path];	}	/**	 * Loads a single language file and appends the results to the existing strings	 *	 * @param   string   $extension  The extension for which a language file should be loaded.	 * @param   string   $basePath   The basepath to use.	 * @param   string   $lang       The language to load, default null for the current language.	 * @param   boolean  $reload     Flag that will force a language to be reloaded if set to true.	 * @param   boolean  $default    Flag that force the default language to be loaded if the current does not exist.	 *	 * @return  boolean  True if the file has successfully loaded.	 *	 * @since   11.1	 */	public function load($extension = 'joomla', $basePath = JPATH_BASE, $lang = null, $reload = false, $default = true)	{		if (!$lang)		{			$lang = $this->lang;		}		$path = self::getLanguagePath($basePath, $lang);		$internal = $extension == 'joomla' || $extension == '';		$filename = $internal ? $lang : $lang . '.' . $extension;		$filename = "$path/$filename.ini";		$result = false;		if (isset($this->paths[$extension][$filename]) && !$reload)		{			// This file has already been tested for loading.			$result = $this->paths[$extension][$filename];		}		else		{			// Load the language file			$result = $this->loadLanguage($filename, $extension);			// Check whether there was a problem with loading the file			if ($result === false && $default)			{				// No strings, so either file doesn't exist or the file is invalid				$oldFilename = $filename;				// Check the standard file name				$path = self::getLanguagePath($basePath, $this->default);				$filename = $internal ? $this->default : $this->default . '.' . $extension;				$filename = "$path/$filename.ini";				// If the one we tried is different than the new name, try again				if ($oldFilename != $filename)				{					$result = $this->loadLanguage($filename, $extension, false);				}			}		}		return $result;	}	/**	 * Loads a language file.	 *	 * This method will not note the successful loading of a file - use load() instead.	 *	 * @param   string  $filename   The name of the file.	 * @param   string  $extension  The name of the extension.	 *	 * @return  boolean  True if new strings have been added to the language	 *	 * @see     JLanguage::load()	 * @since   11.1	 */	protected function loadLanguage($filename, $extension = 'unknown')	{		$this->counter++;		$result = false;		$strings = false;		if (file_exists($filename))		{			$strings = $this->parse($filename);		}		if ($strings)		{			if (is_array($strings))			{				// Sort the underlying heap by key values to optimize merging				ksort($strings, SORT_STRING);				$this->strings = array_merge($this->strings, $strings);			}			if (is_array($strings) && count($strings))			{				// Do not bother with ksort here.  Since the originals were sorted, PHP will already have chosen the best heap.				$this->strings = array_merge($this->strings, $this->override);				$result = true;			}		}		// Record the result of loading the extension's file.		if (!isset($this->paths[$extension]))		{			$this->paths[$extension] = array();		}		$this->paths[$extension][$filename] = $result;		return $result;	}	/**	 * Parses a language file.	 *	 * @param   string  $filename  The name of the file.	 *	 * @return  array  The array of parsed strings.	 *	 * @since   11.1	 */	protected function parse($filename)	{		if ($this->debug)		{			// Capture hidden PHP errors from the parsing.			$php_errormsg = null;			$track_errors = ini_get('track_errors');			ini_set('track_errors', true);		}		$contents = file_get_contents($filename);		$contents = str_replace('_QQ_', '"\""', $contents);		$strings = @parse_ini_string($contents);		if (!is_array($strings))		{			$strings = array();		}		if ($this->debug)		{			// Restore error tracking to what it was before.			ini_set('track_errors', $track_errors);			// Initialise variables for manually parsing the file for common errors.			$blacklist = array('YES', 'NO', 'NULL', 'FALSE', 'ON', 'OFF', 'NONE', 'TRUE');			$regex = '/^(|(\[[^\]]*\])|([A-Z][A-Z0-9_\-\.]*\s*=(\s*(("[^"]*")|(_QQ_)))+))\s*(;.*)?$/';			$this->debug = false;			$errors = array();			// Open the file as a stream.			$file = new SplFileObject($filename);			foreach ($file as $lineNumber => $line)			{				// Avoid BOM error as BOM is OK when using parse_ini				if ($lineNumber == 0)				{					$line = str_replace("\xEF\xBB\xBF", '', $line);				}				// Check that the key is not in the blacklist and that the line format passes the regex.				$key = strtoupper(trim(substr($line, 0, strpos($line, '='))));				// Workaround to reduce regex complexity when matching escaped quotes				$line = str_replace('\"', '_QQ_', $line);				if (!preg_match($regex, $line) || in_array($key, $blacklist))				{					$errors[] = $lineNumber;				}			}			// Check if we encountered any errors.			if (count($errors))			{				if (basename($filename) != $this->lang . '.ini')				{					$this->errorfiles[$filename] = $filename . JText::sprintf('JERROR_PARSING_LANGUAGE_FILE', implode(', ', $errors));				}				else				{					$this->errorfiles[$filename] = $filename . '&#160;: error(s) in line(s) ' . implode(', ', $errors);				}			}			elseif ($php_errormsg)			{				// We didn't find any errors but there's probably a parse notice.				$this->errorfiles['PHP' . $filename] = 'PHP parser errors :' . $php_errormsg;			}			$this->debug = true;		}		return $strings;	}	/**	 * Get a metadata language property.	 *	 * @param   string  $property  The name of the property.	 * @param   mixed   $default   The default value.	 *	 * @return  mixed  The value of the property.	 *	 * @since   11.1	 */	public function get($property, $default = null)	{		if (isset($this->metadata[$property]))		{			return $this->metadata[$property];		}		return $default;	}	/**	 * Determine who called JLanguage or JText.	 *	 * @return  array  Caller information.	 *	 * @since   11.1	 */	protected function getCallerInfo()	{		// Try to determine the source if none was provided		if (!function_exists('debug_backtrace'))		{			return null;		}		$backtrace = debug_backtrace();		$info = array();		// Search through the backtrace to our caller		$continue = true;		while ($continue && next($backtrace))		{			$step = current($backtrace);			$class = @ $step['class'];			// We're looking for something outside of language.php			if ($class != 'JLanguage' && $class != 'JText')			{				$info['function'] = @ $step['function'];				$info['class'] = $class;				$info['step'] = prev($backtrace);				// Determine the file and name of the file				$info['file'] = @ $step['file'];				$info['line'] = @ $step['line'];				$continue = false;			}		}		return $info;	}	/**	 * Getter for Name.	 *	 * @return  string  Official name element of the language.	 *	 * @since   11.1	 */	public function getName()	{		return $this->metadata['name'];	}	/**	 * Get a list of language files that have been loaded.	 *	 * @param   string  $extension  An optional extension name.	 *	 * @return  array	 *	 * @since   11.1	 */	public function getPaths($extension = null)	{		if (isset($extension))		{			if (isset($this->paths[$extension]))			{				return $this->paths[$extension];			}			return null;		}		else		{			return $this->paths;		}	}	/**	 * Get a list of language files that are in error state.	 *	 * @return  array	 *	 * @since   11.1	 */	public function getErrorFiles()	{		return $this->errorfiles;	}	/**	 * Getter for the language tag (as defined in RFC 3066)	 *	 * @return  string  The language tag.	 *	 * @since   11.1	 */	public function getTag()	{		return $this->metadata['tag'];	}	/**	 * Get the RTL property.	 *	 * @return  boolean  True is it an RTL language.	 *	 * @since   11.1	 */	public function isRTL()	{		return (bool) $this->metadata['rtl'];	}	/**	 * Set the Debug property.	 *	 * @param   boolean  $debug  The debug setting.	 *	 * @return  boolean  Previous value.	 *	 * @since   11.1	 */	public function setDebug($debug)	{		$previous = $this->debug;		$this->debug = (boolean) $debug;		return $previous;	}	/**	 * Get the Debug property.	 *	 * @return  boolean  True is in debug mode.	 *	 * @since   11.1	 */	public function getDebug()	{		return $this->debug;	}	/**	 * Get the default language code.	 *	 * @return  string  Language code.	 *	 * @since   11.1	 */	public function getDefault()	{		return $this->default;	}	/**	 * Set the default language code.	 *	 * @param   string  $lang  The language code.	 *	 * @return  string  Previous value.	 *	 * @since   11.1	 */	public function setDefault($lang)	{		$previous = $this->default;		$this->default = $lang;		return $previous;	}	/**	 * Get the list of orphaned strings if being tracked.	 *	 * @return  array  Orphaned text.	 *	 * @since   11.1	 */	public function getOrphans()	{		return $this->orphans;	}	/**	 * Get the list of used strings.	 *	 * Used strings are those strings requested and found either as a string or a constant.	 *	 * @return  array  Used strings.	 *	 * @since   11.1	 */	public function getUsed()	{		return $this->used;	}	/**	 * Determines is a key exists.	 *	 * @param   string  $string  The key to check.	 *	 * @return  boolean  True, if the key exists.	 *	 * @since   11.1	 */	public function hasKey($string)	{		$key = strtoupper($string);		return isset($this->strings[$key]);	}	/**	 * Returns a associative array holding the metadata.	 *	 * @param   string  $lang  The name of the language.	 *	 * @return  mixed  If $lang exists return key/value pair with the language metadata, otherwise return NULL.	 *	 * @since   11.1	 */	public static function getMetadata($lang)	{		$path = self::getLanguagePath(JPATH_BASE, $lang);		$file = $lang . '.xml';		$result = null;		if (is_file("$path/$file"))		{			$result = self::parseXMLLanguageFile("$path/$file");		}		if (empty($result))		{			return null;		}		return $result;	}	/**	 * Returns a list of known languages for an area	 *	 * @param   string  $basePath  The basepath to use	 *	 * @return  array  key/value pair with the language file and real name.	 *	 * @since   11.1	 */	public static function getKnownLanguages($basePath = JPATH_BASE)	{		$dir = self::getLanguagePath($basePath);		$knownLanguages = self::parseLanguageFiles($dir);		return $knownLanguages;	}	/**	 * Get the path to a language	 *	 * @param   string  $basePath  The basepath to use.	 * @param   string  $language  The language tag.	 *	 * @return  string  language related path or null.	 *	 * @since   11.1	 */	public static function getLanguagePath($basePath = JPATH_BASE, $language = null)	{		$dir = $basePath . '/language';		if (!empty($language))		{			$dir .= '/' . $language;		}		return $dir;	}	/**	 * Set the language attributes to the given language.	 *	 * Once called, the language still needs to be loaded using JLanguage::load().	 *	 * @param   string  $lang  Language code.	 *	 * @return  string  Previous value.	 *	 * @since   11.1	 */	public function setLanguage($lang)	{		$previous = $this->lang;		$this->lang = $lang;		$this->metadata = $this->getMetadata($this->lang);		return $previous;	}	/**	 * Get the language locale based on current language.	 *	 * @return  array  The locale according to the language.	 *	 * @since   11.1	 */	public function getLocale()	{		if (!isset($this->locale))		{			$locale = str_replace(' ', '', isset($this->metadata['locale']) ? $this->metadata['locale'] : '');			if ($locale)			{				$this->locale = explode(',', $locale);			}			else			{				$this->locale = false;			}		}		return $this->locale;	}	/**	 * Get the first day of the week for this language.	 *	 * @return  integer  The first day of the week according to the language	 *	 * @since   11.1	 */	public function getFirstDay()	{		return (int) (isset($this->metadata['firstDay']) ? $this->metadata['firstDay'] : 0);	}	/**	 * Searches for language directories within a certain base dir.	 *	 * @param   string  $dir  directory of files.	 *	 * @return  array  Array holding the found languages as filename => real name pairs.	 *	 * @since   11.1	 */	public static function parseLanguageFiles($dir = null)	{		$languages = array();		$iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir));		foreach ($iterator as $file)		{			$langs    = array();			$fileName = $file->getFilename();			if (!$file->isFile() || !preg_match("/^([-_A-Za-z]*)\.xml$/", $fileName))			{				continue;			}			try			{				$metadata = self::parseXMLLanguageFile($file->getRealPath());				if ($metadata)				{					$lang = str_replace('.xml', '', $fileName);					$langs[$lang] = $metadata;				}				$languages = array_merge($languages, $langs);			}			catch (RuntimeException $e)			{			}		}		return $languages;	}	/**	 * Parse XML file for language information.	 *	 * @param   string  $path  Path to the XML files.	 *	 * @return  array  Array holding the found metadata as a key => value pair.	 *	 * @since   11.1	 * @throws  RuntimeException	 */	public static function parseXMLLanguageFile($path)	{		if (!is_readable($path))		{			throw new RuntimeException('File not found or not readable');		}		// Try to load the file		$xml = simplexml_load_file($path);		if (!$xml)		{			return null;		}		// Check that it's a metadata file		if ((string) $xml->getName() != 'metafile')		{			return null;		}		$metadata = array();		foreach ($xml->metadata->children() as $child)		{			$metadata[$child->getName()] = (string) $child;		}		return $metadata;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Session * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Database session storage handler for PHP * * @package     Joomla.Platform * @subpackage  Session * @see         http://www.php.net/manual/en/function.session-set-save-handler.php * @since       11.1 */class JSessionStorageDatabase extends JSessionStorage{	/**	 * Read the data for a particular session identifier from the SessionHandler backend.	 *	 * @param   string  $id  The session identifier.	 *	 * @return  string  The session data.	 *	 * @since   11.1	 */	public function read($id)	{		// Get the database connection object and verify its connected.		$db = JFactory::getDbo();		try		{			// Get the session data from the database table.			$query = $db->getQuery(true)				->select($db->quoteName('data'))			->from($db->quoteName('#__session'))			->where($db->quoteName('session_id') . ' = ' . $db->quote($id));			$db->setQuery($query);			$result = (string) $db->loadResult();			$result = str_replace('\0\0\0', chr(0) . '*' . chr(0), $result);			return $result;		}		catch (Exception $e)		{			return false;		}	}	/**	 * Write session data to the SessionHandler backend.	 *	 * @param   string  $id    The session identifier.	 * @param   string  $data  The session data.	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   11.1	 */	public function write($id, $data)	{		// Get the database connection object and verify its connected.		$db = JFactory::getDbo();		$data = str_replace(chr(0) . '*' . chr(0), '\0\0\0', $data);		try		{			$query = $db->getQuery(true)				->update($db->quoteName('#__session'))			->set($db->quoteName('data') . ' = ' . $db->quote($data))			->set($db->quoteName('time') . ' = ' . $db->quote((int) time()))			->where($db->quoteName('session_id') . ' = ' . $db->quote($id));			// Try to update the session data in the database table.			$db->setQuery($query);			if (!$db->execute())			{				return false;			}			/* Since $db->execute did not throw an exception, so the query was successful.			Either the data changed, or the data was identical.			In either case we are done.			*/			return true;		}		catch (Exception $e)		{			return false;		}	}	/**	 * Destroy the data for a particular session identifier in the SessionHandler backend.	 *	 * @param   string  $id  The session identifier.	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   11.1	 */	public function destroy($id)	{		// Get the database connection object and verify its connected.		$db = JFactory::getDbo();		try		{			$query = $db->getQuery(true)				->delete($db->quoteName('#__session'))			->where($db->quoteName('session_id') . ' = ' . $db->quote($id));			// Remove a session from the database.			$db->setQuery($query);			return (boolean) $db->execute();		}		catch (Exception $e)		{			return false;		}	}	/**	 * Garbage collect stale sessions from the SessionHandler backend.	 *	 * @param   integer  $lifetime  The maximum age of a session.	 *	 * @return  boolean  True on success, false otherwise.	 *	 * @since   11.1	 */	public function gc($lifetime = 1440)	{		// Get the database connection object and verify its connected.		$db = JFactory::getDbo();		// Determine the timestamp threshold with which to purge old sessions.		$past = time() - $lifetime;		try		{			$query = $db->getQuery(true)				->delete($db->quoteName('#__session'))			->where($db->quoteName('time') . ' < ' . $db->quote((int) $past));			// Remove expired sessions from the database.			$db->setQuery($query);			return (boolean) $db->execute();		}		catch (Exception $e)		{			return false;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_cpanel * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$user = JFactory::getUser();?><div class="row-fluid">	<div class="span2">		<div class="sidebar-nav">			<ul class="nav nav-list">				<li class="nav-header"><?php echo JText::_('COM_CPANEL_HEADER_SUBMENU'); ?></li>				<li class="active"><a href="<?php echo $this->baseurl; ?>"><?php echo JText::_('COM_CPANEL_LINK_DASHBOARD'); ?></a></li>				<li class="nav-header"><?php echo JText::_('COM_CPANEL_HEADER_SYSTEM'); ?></li>			<?php if ($user->authorise('core.admin')):?>				<li><a href="<?php echo $this->baseurl; ?>/index.php?option=com_config"><?php echo JText::_('COM_CPANEL_LINK_GLOBAL_CONFIG'); ?></a></li>				<li><a href="<?php echo $this->baseurl; ?>/index.php?option=com_admin&view=sysinfo"><?php echo JText::_('COM_CPANEL_LINK_SYSINFO'); ?></a></li>			<?php endif;?>			<?php if ($user->authorise('core.manage', 'com_cache')):?>				<li><a href="<?php echo $this->baseurl; ?>/index.php?option=com_cache"><?php echo JText::_('COM_CPANEL_LINK_CLEAR_CACHE'); ?></a></li>			<?php endif;?>			<?php if ($user->authorise('core.admin', 'com_checkin')):?>				<li><a href="<?php echo $this->baseurl; ?>/index.php?option=com_checkin"><?php echo JText::_('COM_CPANEL_LINK_CHECKIN'); ?></a></li>			<?php endif;?>			<?php if ($user->authorise('core.manage', 'com_installer')):?>				<li><a href="<?php echo $this->baseurl; ?>/index.php?option=com_installer"><?php echo JText::_('COM_CPANEL_LINK_EXTENSIONS'); ?></a></li>			<?php endif;?>			</ul>		</div>	</div>	<div class="span6">		<?php		foreach ($this->modules as $module)		{			$output = JModuleHelper::renderModule($module, array('style' => 'well'));			$params = new JRegistry;			$params->loadString($module->params);			echo $output;		}		?>	</div>	<div class="span4">		<?php		// Display the submenu position modules		$this->iconmodules = JModuleHelper::getModules('icon');		foreach ($this->iconmodules as $iconmodule)		{			$output = JModuleHelper::renderModule($iconmodule, array('style' => 'well'));			$params = new JRegistry;			$params->loadString($iconmodule->params);			echo $output;		}		?>	</div></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_modules * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * @package     Joomla.Administrator * @subpackage  com_modules * @since       1.6 */abstract class JHtmlModules{	/**	 * Builds an array of template options	 *	 * @param   integer  $clientId  The client id	 * @param   string   $state     The state of the template	 *	 * @return  array	 */	public static function templates($clientId = 0, $state = '')	{		$options   = array();		$templates = ModulesHelper::getTemplates($clientId, $state);		foreach ($templates as $template)		{			$options[]	= JHtml::_('select.option', $template->element, $template->name);		}		return $options;	}	/**	 * Builds an array of template type options	 *	 * @return  array	 */	public static function types()	{		$options = array();		$options[] = JHtml::_('select.option', 'user', 'COM_MODULES_OPTION_POSITION_USER_DEFINED');		$options[] = JHtml::_('select.option', 'template', 'COM_MODULES_OPTION_POSITION_TEMPLATE_DEFINED');		return $options;	}	/**	 * Builds an array of template state options	 *	 * @return  array	 */	public static function templateStates()	{		$options = array();		$options[] = JHtml::_('select.option', '1', 'JENABLED');		$options[] = JHtml::_('select.option', '0', 'JDISABLED');		return $options;	}	/**	 * Returns a published state on a grid	 *	 * @param   integer  $value     The state value.	 * @param   integer  $i         The row index	 * @param   boolean  $enabled   An optional setting for access control on the action.	 * @param   string   $checkbox  An optional prefix for checkboxes.	 *	 * @return  string        The Html code	 *	 * @see     JHtmlJGrid::state	 * @since   1.7.1	 */	public static function state($value, $i, $enabled = true, $checkbox = 'cb')	{		$states	= array(			1 => array(				'unpublish',				'COM_MODULES_EXTENSION_PUBLISHED_ENABLED',				'COM_MODULES_HTML_UNPUBLISH_ENABLED',				'COM_MODULES_EXTENSION_PUBLISHED_ENABLED',				true,				'publish',				'publish'			),			0 => array(				'publish',				'COM_MODULES_EXTENSION_UNPUBLISHED_ENABLED',				'COM_MODULES_HTML_PUBLISH_ENABLED',				'COM_MODULES_EXTENSION_UNPUBLISHED_ENABLED',				true,				'unpublish',				'unpublish'			),			-1 => array(				'unpublish',				'COM_MODULES_EXTENSION_PUBLISHED_DISABLED',				'COM_MODULES_HTML_UNPUBLISH_DISABLED',				'COM_MODULES_EXTENSION_PUBLISHED_DISABLED',				true,				'warning',				'warning'			),			-2 => array(				'publish',				'COM_MODULES_EXTENSION_UNPUBLISHED_DISABLED',				'COM_MODULES_HTML_PUBLISH_DISABLED',				'COM_MODULES_EXTENSION_UNPUBLISHED_DISABLED',				true,				'unpublish',				'unpublish'			),		);		return JHtml::_('jgrid.state', $states, $value, $i, 'modules.', $enabled, true, $checkbox);	}	/**	 * Display a batch widget for the module position selector.	 *	 * @param   integer  $clientId  The client ID	 *	 * @return  string  The necessary HTML for the widget.	 *	 * @since   2.5	 */	public static function positions($clientId)	{		// Create the copy/move options.		$options = array(			JHtml::_('select.option', 'c', JText::_('JLIB_HTML_BATCH_COPY')),			JHtml::_('select.option', 'm', JText::_('JLIB_HTML_BATCH_MOVE'))		);		// Create the batch selector to change select the category by which to move or copy.		$lines = array(			'<label id="batch-choose-action-lbl" for="batch-choose-action">',			JText::_('COM_MODULES_BATCH_POSITION_LABEL'),			'</label>',			'<div id="batch-choose-action" class="control-group">',			'<select name="batch[position_id]" class="inputbox" id="batch-position-id">',			'<option value="">' . JText::_('JSELECT') . '</option>',			'<option value="nochange">' . JText::_('COM_MODULES_BATCH_POSITION_NOCHANGE') . '</option>',			'<option value="noposition">' . JText::_('COM_MODULES_BATCH_POSITION_NOPOSITION') . '</option>',			JHtml::_('select.options',	self::positionList($clientId)),			'</select>',			'</div>', '<div id="batch-move-copy" class="control-group radio">',			JHtml::_('select.radiolist', $options, 'batch[move_copy]', '', 'value', 'text', 'm'),			'</div>'		);		return implode("\n", $lines);	}	/**	 * Method to get the field options.	 *	 * @param   integer  $clientId  The client ID	 *	 * @return  array  The field option objects.	 *	 * @since   2.5	 */	public static function positionList($clientId = 0)	{		$db		= JFactory::getDbo();		$query	= $db->getQuery(true)			->select('DISTINCT(position) as value')			->select('position as text')			->from($db->quoteName('#__modules'))			->where($db->quoteName('client_id') . ' = ' . (int) $clientId)			->order('position');		// Get the options.		$db->setQuery($query);		try		{			$options = $db->loadObjectList();		}		catch (RuntimeException $e)		{			JError::raiseWarning(500, $e->getMessage());		}		// Pop the first item off the array if it's blank		if (count($options))		{			if (strlen($options[0]->text) < 1)			{				array_shift($options);			}		}		return $options;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');$user		= JFactory::getUser();$userId		= $user->get('id');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_banners&view=clients'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_BANNERS_SEARCH_IN_TITLE'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_state">				<?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?>			</label>			<select name="filter_state" class="inputbox" id="filter_state">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.state'), true);?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_CLIENT', 'name', $listDirn, $listOrder); ?>				</th>				<th class="width-30">					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_CONTACT', 'contact', $listDirn, $listOrder); ?>				</th>				<th class="nowrap state-col">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'state', $listDirn, $listOrder); ?>				</th>				<th class="width-5">					<?php echo JHtml::_('grid.sort', 'COM_BANNERS_HEADING_ACTIVE', 'nbanners', $listDirn, $listOrder); ?>				</th>				<th class="nowrap width-5">					<?php echo JText::_('COM_BANNERS_HEADING_METAKEYWORDS'); ?>				</th>				<th class="width-10">					<?php echo JText::_('COM_BANNERS_HEADING_PURCHASETYPE'); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) :			$ordering   = ($listOrder == 'ordering');			$canCreate  = $user->authorise('core.create',     'com_banners');			$canEdit    = $user->authorise('core.edit',       'com_banners');			$canCheckin = $user->authorise('core.manage',     'com_checkin') || $item->checked_out == $user->get('id') || $item->checked_out == 0;			$canChange  = $user->authorise('core.edit.state', 'com_banners') && $canCheckin;			?>			<tr class="row<?php echo $i % 2; ?>">				<td class="center">					<?php echo JHtml::_('grid.id', $i, $item->id); ?>				</td>				<td>					<?php if ($item->checked_out) : ?>						<?php echo JHtml::_('jgrid.checkedout', $i, $item->editor, $item->checked_out_time, 'clients.', $canCheckin); ?>					<?php endif; ?>					<?php if ($canEdit) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_banners&task=client.edit&id='.(int) $item->id); ?>">							<?php echo $this->escape($item->name); ?></a>					<?php else : ?>							<?php echo $this->escape($item->name); ?>					<?php endif; ?>				</td>				<td class="center">					<?php echo $item->contact;?>				</td>				<td class="center">					<?php echo JHtml::_('jgrid.published', $item->state, $i, 'clients.', $canChange);?>				</td>				<td class="center">					<?php echo $item->nbanners; ?>				</td>				<td>					<?php echo $item->metakey; ?>				</td>				<td class="center">					<?php if ($item->purchase_type < 0):?>						<?php echo JText::sprintf('COM_BANNERS_DEFAULT', JText::_('COM_BANNERS_FIELD_VALUE_'.$this->state->params->get('purchase_type')));?>					<?php else:?>						<?php echo JText::_('COM_BANNERS_FIELD_VALUE_'.$item->purchase_type);?>					<?php endif;?>				</td>				<td class="center">					<?php echo $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Installer Database Controller * * @package     Joomla.Administrator * @subpackage  com_installer * @since       2.5 */class InstallerControllerDatabase extends JControllerLegacy{	/**	 * Tries to fix missing database updates	 *	 * @return  void	 *	 * @since   2.5	 */	public function fix()	{		$model = $this->getModel('database');		$model->fix();		$this->setRedirect(JRoute::_('index.php?option=com_installer&view=database', false));	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_media * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the Media component * * @package     Joomla.Administrator * @subpackage  com_media * @since       1.0 */class MediaViewMediaList extends JViewLegacy{	public function display($tpl = null)	{		// Do not allow cache		JResponse::allowCache(false);		$app	= JFactory::getApplication();		$style = $app->getUserStateFromRequest('media.list.layout', 'layout', 'thumbs', 'word');		$lang	= JFactory::getLanguage();		JHtml::_('behavior.framework', true);		$document = JFactory::getDocument();		/*		$document->addStyleSheet('../media/media/css/medialist-'.$style.'.css');		if ($lang->isRTL()) :			$document->addStyleSheet('../media/media/css/medialist-'.$style.'_rtl.css');		endif;		*/		$document->addScriptDeclaration("		window.addEvent('domready', function()		{			window.parent.document.updateUploader();			$$('a.img-preview').each(function(el)			{				el.addEvent('click', function(e)				{					new Event(e).stop();					window.top.document.preview.fromElement(el);				});			});		});");		$images = $this->get('images');		$documents = $this->get('documents');		$folders = $this->get('folders');		$state = $this->get('state');		$this->baseURL = JURI::root();		$this->images = &$images;		$this->documents = &$documents;		$this->folders = &$folders;		$this->state = &$state;		parent::display($tpl);	}	function setFolder($index = 0)	{		if (isset($this->folders[$index]))		{			$this->_tmp_folder = &$this->folders[$index];		}		else		{			$this->_tmp_folder = new JObject;		}	}	function setImage($index = 0)	{		if (isset($this->images[$index]))		{			$this->_tmp_img = &$this->images[$index];		}		else		{			$this->_tmp_img = new JObject;		}	}	function setDoc($index = 0)	{		if (isset($this->documents[$index]))		{			$this->_tmp_doc = &$this->documents[$index];		}		else		{			$this->_tmp_doc = new JObject;		}	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_admin * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('bootstrap.tooltip');?><form action="<?php echo JRoute::_('index.php?option=com_admin&amp;view=help'); ?>" method="post" name="adminForm" id="adminForm">	<div class="row-fluid">		<div id="sidebar" class="span3">			<div id="filter-bar" class="btn-toolbar">				<div class="filter-search input-append">					<label for="helpsearch" class="element-invisible"><?php echo JText::_('COM_ADMIN_SEARCH');?></label>					<input type="text" name="helpsearch" class="input-small" placeholder="<?php echo JText::_('COM_ADMIN_SEARCH'); ?>" id="helpsearch" value="<?php echo $this->escape($this->help_search);?>" title="<?php echo JText::_('COM_ADMIN_SEARCH'); ?>" /><button class="btn tip hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button><button class="btn tip" type="button" onclick="f=document.adminForm;f.helpsearch.value='';f.submit()" class="hasTooltip" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>"><i class="icon-remove"></i></button>				</div>			</div>			<div class="clearfix"> </div>			<div class="sidebar-nav">				<ul class="nav nav-list">					<li><?php echo JHtml::_('link', JHelp::createUrl('JHELP_START_HERE'), JText::_('COM_ADMIN_START_HERE'), array('target' => 'helpFrame')) ?></li>					<li><?php echo JHtml::_('link', $this->latest_version_check, JText::_('COM_ADMIN_LATEST_VERSION_CHECK'), array('target' => 'helpFrame')) ?></li>					<li><?php echo JHtml::_('link', 'http://www.gnu.org/licenses/gpl-2.0.html', JText::_('COM_ADMIN_LICENSE'), array('target' => 'helpFrame')) ?></li>					<li><?php echo JHtml::_('link', JHelp::createUrl('JHELP_GLOSSARY'), JText::_('COM_ADMIN_GLOSSARY'), array('target' => 'helpFrame')) ?></li>					<hr class="hr-condensed" />					<li class="nav-header"><?php echo JText::_('COM_ADMIN_ALPHABETICAL_INDEX'); ?></li>					<?php foreach ($this->toc as $k => $v):?>						<li>						    <?php $url = JHelp::createUrl('JHELP_'.strtoupper($k)); ?>							<?php echo JHtml::_('link', $url, $v, array('target' => 'helpFrame'));?>						</li>					<?php endforeach;?>				</ul>			</div>		</div>		<div class="span9">			<iframe name="helpFrame" height="2100px" src="<?php echo $this->page;?>" class="helpFrame table table-bordered"></iframe>		</div>	</div>	<input class="textarea" type="hidden" name="option" value="com_admin" /></form>
<?php/** * @package     Joomla.Legacy * @subpackage  Controller * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Controller tailored to suit most form-based admin operations. * * @package     Joomla.Legacy * @subpackage  Controller * @since       12.2 * @todo        Add ability to set redirect manually to better cope with frontend usage. */class JControllerForm extends JControllerLegacy{	/**	 * The context for storing internal data, e.g. record.	 *	 * @var    string	 * @since  12.2	 */	protected $context;	/**	 * The URL option for the component.	 *	 * @var    string	 * @since  12.2	 */	protected $option;	/**	 * The URL view item variable.	 *	 * @var    string	 * @since  12.2	 */	protected $view_item;	/**	 * The URL view list variable.	 *	 * @var    string	 * @since  12.2	 */	protected $view_list;	/**	 * The prefix to use with controller messages.	 *	 * @var    string	 * @since  12.2	 */	protected $text_prefix;	/**	 * Constructor.	 *	 * @param   array  $config  An optional associative array of configuration settings.	 *	 * @see     JControllerLegacy	 * @since   12.2	 * @throws  Exception	 */	public function __construct($config = array())	{		parent::__construct($config);		// Guess the option as com_NameOfController		if (empty($this->option))		{			$this->option = 'com_' . strtolower($this->getName());		}		// Guess the JText message prefix. Defaults to the option.		if (empty($this->text_prefix))		{			$this->text_prefix = strtoupper($this->option);		}		// Guess the context as the suffix, eg: OptionControllerContent.		if (empty($this->context))		{			$r = null;			if (!preg_match('/(.*)Controller(.*)/i', get_class($this), $r))			{				throw new Exception(JText::_('JLIB_APPLICATION_ERROR_CONTROLLER_GET_NAME'), 500);			}			$this->context = strtolower($r[2]);		}		// Guess the item view as the context.		if (empty($this->view_item))		{			$this->view_item = $this->context;		}		// Guess the list view as the plural of the item view.		if (empty($this->view_list))		{			// @TODO Probably worth moving to an inflector class based on			// http://kuwamoto.org/2007/12/17/improved-pluralizing-in-php-actionscript-and-ror/			// Simple pluralisation based on public domain snippet by Paul Osman			// For more complex types, just manually set the variable in your class.			$plural = array(				array('/(x|ch|ss|sh)$/i', "$1es"),				array('/([^aeiouy]|qu)y$/i', "$1ies"),				array('/([^aeiouy]|qu)ies$/i', "$1y"),				array('/(bu)s$/i', "$1ses"),				array('/s$/i', "s"),				array('/$/', "s"));			// Check for matches using regular expressions			foreach ($plural as $pattern)			{				if (preg_match($pattern[0], $this->view_item))				{					$this->view_list = preg_replace($pattern[0], $pattern[1], $this->view_item);					break;				}			}		}		// Apply, Save & New, and Save As copy should be standard on forms.		$this->registerTask('apply', 'save');		$this->registerTask('save2new', 'save');		$this->registerTask('save2copy', 'save');	}	/**	 * Method to add a new record.	 *	 * @return  mixed  True if the record can be added, a error object if not.	 *	 * @since   12.2	 */	public function add()	{		$app = JFactory::getApplication();		$context = "$this->option.edit.$this->context";		// Access check.		if (!$this->allowAdd())		{			// Set the internal error and also the redirect error.			$this->setError(JText::_('JLIB_APPLICATION_ERROR_CREATE_RECORD_NOT_PERMITTED'));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_list					. $this->getRedirectToListAppend(), false				)			);			return false;		}		// Clear the record edit information from the session.		$app->setUserState($context . '.data', null);		// Redirect to the edit screen.		$this->setRedirect(			JRoute::_(				'index.php?option=' . $this->option . '&view=' . $this->view_item				. $this->getRedirectToItemAppend(), false			)		);		return true;	}	/**	 * Method to check if you can add a new record.	 *	 * Extended classes can override this if necessary.	 *	 * @param   array  $data  An array of input data.	 *	 * @return  boolean	 *	 * @since   12.2	 */	protected function allowAdd($data = array())	{		$user = JFactory::getUser();		return ($user->authorise('core.create', $this->option) || count($user->getAuthorisedCategories($this->option, 'core.create')));	}	/**	 * Method to check if you can add a new record.	 *	 * Extended classes can override this if necessary.	 *	 * @param   array   $data  An array of input data.	 * @param   string  $key   The name of the key for the primary key; default is id.	 *	 * @return  boolean	 *	 * @since   12.2	 */	protected function allowEdit($data = array(), $key = 'id')	{		return JFactory::getUser()->authorise('core.edit', $this->option);	}	/**	 * Method to check if you can save a new or existing record.	 *	 * Extended classes can override this if necessary.	 *	 * @param   array   $data  An array of input data.	 * @param   string  $key   The name of the key for the primary key.	 *	 * @return  boolean	 *	 * @since   12.2	 */	protected function allowSave($data, $key = 'id')	{		$recordId = isset($data[$key]) ? $data[$key] : '0';		if ($recordId)		{			return $this->allowEdit($data, $key);		}		else		{			return $this->allowAdd($data);		}	}	/**	 * Method to run batch operations.	 *	 * @param   JModelLegacy  $model  The model of the component being processed.	 *	 * @return	boolean	 True if successful, false otherwise and internal error is set.	 *	 * @since	12.2	 */	public function batch($model)	{		$vars = $this->input->post->get('batch', array(), 'array');		$cid  = $this->input->post->get('cid', array(), 'array');		// Build an array of item contexts to check		$contexts = array();		foreach ($cid as $id)		{			// If we're coming from com_categories, we need to use extension vs. option			if (isset($this->extension))			{				$option = $this->extension;			}			else			{				$option = $this->option;			}			$contexts[$id] = $option . '.' . $this->context . '.' . $id;		}		// Attempt to run the batch operation.		if ($model->batch($vars, $cid, $contexts))		{			$this->setMessage(JText::_('JLIB_APPLICATION_SUCCESS_BATCH'));			return true;		}		else		{			$this->setMessage(JText::sprintf('JLIB_APPLICATION_ERROR_BATCH_FAILED', $model->getError()));			return false;		}	}	/**	 * Method to cancel an edit.	 *	 * @param   string  $key  The name of the primary key of the URL variable.	 *	 * @return  boolean  True if access level checks pass, false otherwise.	 *	 * @since   12.2	 */	public function cancel($key = null)	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$app = JFactory::getApplication();		$model = $this->getModel();		$table = $model->getTable();		$checkin = property_exists($table, 'checked_out');		$context = "$this->option.edit.$this->context";		if (empty($key))		{			$key = $table->getKeyName();		}		$recordId = $app->input->getInt($key);		// Attempt to check-in the current record.		if ($recordId)		{			// Check we are holding the id in the edit list.			if (!$this->checkEditId($context, $recordId))			{				// Somehow the person just went to the form - we don't allow that.				$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_UNHELD_ID', $recordId));				$this->setMessage($this->getError(), 'error');				$this->setRedirect(					JRoute::_(						'index.php?option=' . $this->option . '&view=' . $this->view_list						. $this->getRedirectToListAppend(), false					)				);				return false;			}			if ($checkin)			{				if ($model->checkin($recordId) === false)				{					// Check-in failed, go back to the record and display a notice.					$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_CHECKIN_FAILED', $model->getError()));					$this->setMessage($this->getError(), 'error');					$this->setRedirect(						JRoute::_(							'index.php?option=' . $this->option . '&view=' . $this->view_item							. $this->getRedirectToItemAppend($recordId, $key), false						)					);					return false;				}			}		}		// Clean the session data and redirect.		$this->releaseEditId($context, $recordId);		$app->setUserState($context . '.data', null);		$this->setRedirect(			JRoute::_(				'index.php?option=' . $this->option . '&view=' . $this->view_list				. $this->getRedirectToListAppend(), false			)		);		return true;	}	/**	 * Method to edit an existing record.	 *	 * @param   string  $key     The name of the primary key of the URL variable.	 * @param   string  $urlVar  The name of the URL variable if different from the primary key	 * (sometimes required to avoid router collisions).	 *	 * @return  boolean  True if access level check and checkout passes, false otherwise.	 *	 * @since   12.2	 */	public function edit($key = null, $urlVar = null)	{		$app   = JFactory::getApplication();		$model = $this->getModel();		$table = $model->getTable();		$cid   = $this->input->post->get('cid', array(), 'array');		$context = "$this->option.edit.$this->context";		// Determine the name of the primary key for the data.		if (empty($key))		{			$key = $table->getKeyName();		}		// To avoid data collisions the urlVar may be different from the primary key.		if (empty($urlVar))		{			$urlVar = $key;		}		// Get the previous record id (if any) and the current record id.		$recordId = (int) (count($cid) ? $cid[0] : $this->input->getInt($urlVar));		$checkin = property_exists($table, 'checked_out');		// Access check.		if (!$this->allowEdit(array($key => $recordId), $key))		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_EDIT_NOT_PERMITTED'));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_list					. $this->getRedirectToListAppend(), false				)			);			return false;		}		// Attempt to check-out the new record for editing and redirect.		if ($checkin && !$model->checkout($recordId))		{			// Check-out failed, display a notice but allow the user to see the record.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_CHECKOUT_FAILED', $model->getError()));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_item					. $this->getRedirectToItemAppend($recordId, $urlVar), false				)			);			return false;		}		else		{			// Check-out succeeded, push the new record id into the session.			$this->holdEditId($context, $recordId);			$app->setUserState($context . '.data', null);			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_item					. $this->getRedirectToItemAppend($recordId, $urlVar), false				)			);			return true;		}	}	/**	 * Method to get a model object, loading it if required.	 *	 * @param   string  $name    The model name. Optional.	 * @param   string  $prefix  The class prefix. Optional.	 * @param   array   $config  Configuration array for model. Optional.	 *	 * @return  object  The model.	 *	 * @since   12.2	 */	public function getModel($name = '', $prefix = '', $config = array('ignore_request' => true))	{		if (empty($name))		{			$name = $this->context;		}		return parent::getModel($name, $prefix, $config);	}	/**	 * Gets the URL arguments to append to an item redirect.	 *	 * @param   integer  $recordId  The primary key id for the item.	 * @param   string   $urlVar    The name of the URL variable for the id.	 *	 * @return  string  The arguments to append to the redirect URL.	 *	 * @since   12.2	 */	protected function getRedirectToItemAppend($recordId = null, $urlVar = 'id')	{		$tmpl   = $this->input->get('tmpl');		$layout = $this->input->get('layout', 'edit');		$append = '';		// Setup redirect info.		if ($tmpl)		{			$append .= '&tmpl=' . $tmpl;		}		if ($layout)		{			$append .= '&layout=' . $layout;		}		if ($recordId)		{			$append .= '&' . $urlVar . '=' . $recordId;		}		return $append;	}	/**	 * Gets the URL arguments to append to a list redirect.	 *	 * @return  string  The arguments to append to the redirect URL.	 *	 * @since   12.2	 */	protected function getRedirectToListAppend()	{		$tmpl = JFactory::getApplication()->input->get('tmpl');		$append = '';		// Setup redirect info.		if ($tmpl)		{			$append .= '&tmpl=' . $tmpl;		}		return $append;	}	/**	 * Function that allows child controller access to model data	 * after the data has been saved.	 *	 * @param   JModelLegacy  $model      The data model object.	 * @param   array         $validData  The validated data.	 *	 * @return  void	 *	 * @since   12.2	 */	protected function postSaveHook(JModelLegacy $model, $validData = array())	{	}	/**	 * Method to save a record.	 *	 * @param   string  $key     The name of the primary key of the URL variable.	 * @param   string  $urlVar  The name of the URL variable if different from the primary key (sometimes required to avoid router collisions).	 *	 * @return  boolean  True if successful, false otherwise.	 *	 * @since   12.2	 */	public function save($key = null, $urlVar = null)	{		// Check for request forgeries.		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$app   = JFactory::getApplication();		$lang  = JFactory::getLanguage();		$model = $this->getModel();		$table = $model->getTable();		$data  = $this->input->post->get('jform', array(), 'array');		$checkin = property_exists($table, 'checked_out');		$context = "$this->option.edit.$this->context";		$task = $this->getTask();		// Determine the name of the primary key for the data.		if (empty($key))		{			$key = $table->getKeyName();		}		// To avoid data collisions the urlVar may be different from the primary key.		if (empty($urlVar))		{			$urlVar = $key;		}		$recordId = $this->input->getInt($urlVar);		if (!$this->checkEditId($context, $recordId))		{			// Somehow the person just went to the form and tried to save it. We don't allow that.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_UNHELD_ID', $recordId));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_list					. $this->getRedirectToListAppend(), false				)			);			return false;		}		// Populate the row id from the session.		$data[$key] = $recordId;		// The save2copy task needs to be handled slightly differently.		if ($task == 'save2copy')		{			// Check-in the original row.			if ($checkin && $model->checkin($data[$key]) === false)			{				// Check-in failed. Go back to the item and display a notice.				$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_CHECKIN_FAILED', $model->getError()));				$this->setMessage($this->getError(), 'error');				$this->setRedirect(					JRoute::_(						'index.php?option=' . $this->option . '&view=' . $this->view_item						. $this->getRedirectToItemAppend($recordId, $urlVar), false					)				);				return false;			}			// Reset the ID and then treat the request as for Apply.			$data[$key] = 0;			$task = 'apply';		}		// Access check.		if (!$this->allowSave($data, $key))		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_SAVE_NOT_PERMITTED'));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_list					. $this->getRedirectToListAppend(), false				)			);			return false;		}		// Validate the posted data.		// Sometimes the form needs some posted data, such as for plugins and modules.		$form = $model->getForm($data, false);		if (!$form)		{			$app->enqueueMessage($model->getError(), 'error');			return false;		}		// Test whether the data is valid.		$validData = $model->validate($form, $data);		// Check for validation errors.		if ($validData === false)		{			// Get the validation messages.			$errors = $model->getErrors();			// Push up to three validation messages out to the user.			for ($i = 0, $n = count($errors); $i < $n && $i < 3; $i++)			{				if ($errors[$i] instanceof Exception)				{					$app->enqueueMessage($errors[$i]->getMessage(), 'warning');				}				else				{					$app->enqueueMessage($errors[$i], 'warning');				}			}			// Save the data in the session.			$app->setUserState($context . '.data', $data);			// Redirect back to the edit screen.			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_item					. $this->getRedirectToItemAppend($recordId, $urlVar), false				)			);			return false;		}		if (!isset($validData['metadata']['tags']))		{			$validData['metadata']['tags'] = null;		}		// Attempt to save the data.		if (!$model->save($validData))		{			// Save the data in the session.			$app->setUserState($context . '.data', $validData);			// Redirect back to the edit screen.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_SAVE_FAILED', $model->getError()));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_item					. $this->getRedirectToItemAppend($recordId, $urlVar), false				)			);			return false;		}		// Save succeeded, so check-in the record.		if ($checkin && $model->checkin($validData[$key]) === false)		{			// Save the data in the session.			$app->setUserState($context . '.data', $validData);			// Check-in failed, so go back to the record and display a notice.			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_CHECKIN_FAILED', $model->getError()));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(				JRoute::_(					'index.php?option=' . $this->option . '&view=' . $this->view_item					. $this->getRedirectToItemAppend($recordId, $urlVar), false				)			);			return false;		}		$this->setMessage(			JText::_(				($lang->hasKey($this->text_prefix . ($recordId == 0 && $app->isSite() ? '_SUBMIT' : '') . '_SAVE_SUCCESS')					? $this->text_prefix					: 'JLIB_APPLICATION') . ($recordId == 0 && $app->isSite() ? '_SUBMIT' : '') . '_SAVE_SUCCESS'			)		);		// Redirect the user and adjust session state based on the chosen task.		switch ($task)		{			case 'apply':				// Set the record data in the session.				$recordId = $model->getState($this->context . '.id');				$this->holdEditId($context, $recordId);				$app->setUserState($context . '.data', null);				$model->checkout($recordId);				// Redirect back to the edit screen.				$this->setRedirect(					JRoute::_(						'index.php?option=' . $this->option . '&view=' . $this->view_item						. $this->getRedirectToItemAppend($recordId, $urlVar), false					)				);				break;			case 'save2new':				// Clear the record id and data from the session.				$this->releaseEditId($context, $recordId);				$app->setUserState($context . '.data', null);				// Redirect back to the edit screen.				$this->setRedirect(					JRoute::_(						'index.php?option=' . $this->option . '&view=' . $this->view_item						. $this->getRedirectToItemAppend(null, $urlVar), false					)				);				break;			default:				// Clear the record id and data from the session.				$this->releaseEditId($context, $recordId);				$app->setUserState($context . '.data', null);				// Redirect to the list screen.				$this->setRedirect(					JRoute::_(						'index.php?option=' . $this->option . '&view=' . $this->view_list						. $this->getRedirectToListAppend(), false					)				);				break;		}		// Invoke the postSave method to allow for the child class to access the model.		$this->postSaveHook($model, $validData);		return true;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_cache'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">		<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-select fltrt">			<label class="selectlabel" for="filter_client_id">				<?php echo JText::_('COM_CACHE_SELECT_CLIENT'); ?>			</label>			<select name="filter_client_id" class="inputbox" id="filter_client_id">				<?php echo JHtml::_('select.options', CacheHelper::getClientOptions(), 'value', 'text', $this->state->get('clientId'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div><table class="adminlist">	<thead>		<tr>			<th class="title row-number-col">				<?php echo JText::_('COM_CACHE_NUM'); ?>			</th>			<th class="checkmark-col">				<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />			</th>			<th class="title nowrap">				<?php echo JHtml::_('grid.sort',  'COM_CACHE_GROUP', 'group', $listDirn, $listOrder); ?>			</th>			<th class="width-5 center nowrap">				<?php echo JHtml::_('grid.sort',  'COM_CACHE_NUMBER_OF_FILES', 'count', $listDirn, $listOrder); ?>			</th>			<th class="width-10 center">				<?php echo JHtml::_('grid.sort',  'COM_CACHE_SIZE', 'size', $listDirn, $listOrder); ?>			</th>		</tr>	</thead>	<tbody>		<?php		$i = 0;		foreach ($this->data as $folder => $item) : ?>		<tr class="row<?php echo $i % 2; ?>">			<td>				<?php echo $this->pagination->getRowOffset($i); ?>			</td>			<td>				<input type="checkbox" id="cb<?php echo $i;?>" name="cid[]" title="<?php echo JText::sprintf('JGRID_CHECKBOX_ROW_N', ($i + 1)); ?>" value="<?php echo $item->group; ?>" onclick="Joomla.isChecked(this.checked);" />			</td>			<td>				<span class="bold">					<?php echo $item->group; ?>				</span>			</td>			<td class="center">				<?php echo $item->count; ?>			</td>			<td class="center">				<?php echo JHtml::_('number.bytes', $item->size*1024); ?>			</td>		</tr>		<?php $i++; endforeach; ?>	</tbody></table><?php echo $this->pagination->getListFooter(); ?><input type="hidden" name="task" value="" /><input type="hidden" name="boxchecked" value="0" /><input type="hidden" name="client" value="<?php echo $this->client->id;?>" /><input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" /><input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" /><?php echo JHtml::_('form.token'); ?></div></form>
<?php/** * @package     Joomla.Site * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * HTML View class for the Tags component * * @package     Joomla.Site * @subpackage  com_tags * @since       3.1 */class TagsViewTag extends JViewLegacy{	public function display($tpl = null)	{		$app      = JFactory::getApplication();		$document = JFactory::getDocument();		$document->link = JRoute::_(TagsHelperRoute::getTagRoute($app->input->getInt('id')));		$app->input->set('limit', $app->getCfg('feed_limit'));		$params = $app->getParams();		$siteEmail = $app->getCfg('mailfrom');		$fromName  = $app->getCfg('fromname');		$feedEmail = $app->getCfg('feed_email', 'author');		$document->editor = $fromName;		if ($feedEmail != "none")		{			$document->editorEmail = $siteEmail;		}		// Get some data from the model		$items    = $this->get('Items');		$tag = $this->get('Item');		foreach ($items as $item)		{			// Strip HTML from feed item title			$title = $this->escape($item->core_title);			$title = html_entity_decode($title, ENT_COMPAT, 'UTF-8');			// URL link to tagged item			// Change to new routing once it is merged			$link = JRoute::_($item->link);			// Strip HTML from feed item description text			$description = $item->core_body;			$author			= $item->core_created_by_alias ? $item->core_created_by_alias : $item->author;			$date = ($item->displayDate ? date('r', strtotime($item->displayDate)) : '');			// Load individual item creator class			$feeditem = new JFeedItem;			$feeditem->title       = $title;			$feeditem->link        = $link;			$feeditem->description = $description;			$feeditem->date        = $date;			$feeditem->category    = $item->title;			$feeditem->author      = $author;			if ($feedEmail == 'site')			{				$item->authorEmail = $siteEmail;			}			elseif ($feedEmail === 'author')			{				$item->authorEmail = $row->author_email;			}			// Loads item info into RSS array			$document->addItem($feeditem);		}	}}
<?php/** * @package     Joomla.Platform * @subpackage  Database * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Query Building Class. * * @package     Joomla.Platform * @subpackage  Database * @since       11.3 */class JDatabaseQueryPostgresql extends JDatabaseQuery implements JDatabaseQueryLimitable{	/**	 * @var    object  The FOR UPDATE element used in "FOR UPDATE"  lock	 * @since  11.3	 */	protected $forUpdate = null;	/**	 * @var    object  The FOR SHARE element used in "FOR SHARE"  lock	 * @since  11.3	 */	protected $forShare = null;	/**	 * @var    object  The NOWAIT element used in "FOR SHARE" and "FOR UPDATE" lock	 * @since  11.3	 */	protected $noWait = null;	/**	 * @var    object  The LIMIT element	 * @since  11.3	 */	protected $limit = null;	/**	 * @var    object  The OFFSET element	 * @since  11.3	 */	protected $offset = null;	/**	 * @var    object  The RETURNING element of INSERT INTO	 * @since  11.3	 */	protected $returning = null;	/**	 * Magic function to convert the query to a string, only for postgresql specific query	 *	 * @return  string	The completed query.	 *	 * @since   11.3	 */	public function __toString()	{		$query = '';		switch ($this->type)		{			case 'select':				$query .= (string) $this->select;				$query .= (string) $this->from;				if ($this->join)				{					// Special case for joins					foreach ($this->join as $join)					{						$query .= (string) $join;					}				}				if ($this->where)				{					$query .= (string) $this->where;				}				if ($this->group)				{					$query .= (string) $this->group;				}				if ($this->having)				{					$query .= (string) $this->having;				}				if ($this->order)				{					$query .= (string) $this->order;				}				if ($this->limit)				{					$query .= (string) $this->limit;				}				if ($this->offset)				{					$query .= (string) $this->offset;				}				if ($this->forUpdate)				{					$query .= (string) $this->forUpdate;				}				else				{					if ($this->forShare)					{						$query .= (string) $this->forShare;					}				}				if ($this->noWait)				{					$query .= (string) $this->noWait;				}				break;			case 'update':				$query .= (string) $this->update;				$query .= (string) $this->set;				if ($this->join)				{					$onWord = ' ON ';					// Workaround for special case of JOIN with UPDATE					foreach ($this->join as $join)					{						$joinElem = $join->getElements();						$joinArray = explode($onWord, $joinElem[0]);						$this->from($joinArray[0]);						$this->where($joinArray[1]);					}					$query .= (string) $this->from;				}				if ($this->where)				{					$query .= (string) $this->where;				}				break;			case 'insert':				$query .= (string) $this->insert;				if ($this->values)				{					if ($this->columns)					{						$query .= (string) $this->columns;					}					$elements = $this->values->getElements();					if (!($elements[0] instanceof $this))					{						$query .= ' VALUES ';					}					$query .= (string) $this->values;					if ($this->returning)					{						$query .= (string) $this->returning;					}				}				break;			default:				$query = parent::__toString();				break;		}		return $query;	}	/**	 * Clear data from the query or a specific clause of the query.	 *	 * @param   string  $clause  Optionally, the name of the clause to clear, or nothing to clear the whole query.	 *	 * @return  void	 *	 * @since   11.3	 */	public function clear($clause = null)	{		switch ($clause)		{			case 'limit':				$this->limit = null;				break;			case 'offset':				$this->offset = null;				break;			case 'forUpdate':				$this->forUpdate = null;				break;			case 'forShare':				$this->forShare = null;				break;			case 'noWait':				$this->noWait = null;				break;			case 'returning':				$this->returning = null;				break;			case 'select':			case 'update':			case 'delete':			case 'insert':			case 'from':			case 'join':			case 'set':			case 'where':			case 'group':			case 'having':			case 'order':			case 'columns':			case 'values':				parent::clear($clause);				break;			default:				$this->type = null;				$this->limit = null;				$this->offset = null;				$this->forUpdate = null;				$this->forShare = null;				$this->noWait = null;				$this->returning = null;				parent::clear($clause);				break;		}		return $this;	}	/**	 * Casts a value to a char.	 *	 * Ensure that the value is properly quoted before passing to the method.	 *	 * Usage:	 * $query->select($query->castAsChar('a'));	 *	 * @param   string  $value  The value to cast as a char.	 *	 * @return  string  Returns the cast value.	 *	 * @since   11.1	 */	public function castAsChar($value)	{		return $value . '::text';	}	/**	 * Concatenates an array of column names or values.	 *	 * Usage:	 * $query->select($query->concatenate(array('a', 'b')));	 *	 * @param   array   $values     An array of values to concatenate.	 * @param   string  $separator  As separator to place between each value.	 *	 * @return  string  The concatenated values.	 *	 * @since   11.3	 */	public function concatenate($values, $separator = null)	{		if ($separator)		{			return implode(' || ' . $this->quote($separator) . ' || ', $values);		}		else		{			return implode(' || ', $values);		}	}	/**	 * Gets the current date and time.	 *	 * @return  string  Return string used in query to obtain	 *	 * @since   11.3	 */	public function currentTimestamp()	{		return 'NOW()';	}	/**	 * Sets the FOR UPDATE lock on select's output row	 *	 * @param   string   $table_name  The table to lock	 * @param   boolean  $glue        The glue by which to join the conditions. Defaults to ',' .	 *	 * @return  JDatabaseQuery  FOR UPDATE query element	 *	 * @since   11.3	 */	public function forUpdate ($table_name, $glue = ',')	{		$this->type = 'forUpdate';		if ( is_null($this->forUpdate) )		{			$glue = strtoupper($glue);			$this->forUpdate = new JDatabaseQueryElement('FOR UPDATE', 'OF ' . $table_name, "$glue ");		}		else		{			$this->forUpdate->append($table_name);		}		return $this;	}	/**	 * Sets the FOR SHARE lock on select's output row	 *	 * @param   string   $table_name  The table to lock	 * @param   boolean  $glue        The glue by which to join the conditions. Defaults to ',' .	 *	 * @return  JDatabaseQuery  FOR SHARE query element	 *	 * @since   11.3	 */	public function forShare ($table_name, $glue = ',')	{		$this->type = 'forShare';		if ( is_null($this->forShare) )		{			$glue = strtoupper($glue);			$this->forShare = new JDatabaseQueryElement('FOR SHARE', 'OF ' . $table_name, "$glue ");		}		else		{			$this->forShare->append($table_name);		}		return $this;	}	/**	 * Used to get a string to extract year from date column.	 *	 * Usage:	 * $query->select($query->year($query->quoteName('dateColumn')));	 *	 * @param   string  $date  Date column containing year to be extracted.	 *	 * @return  string  Returns string to extract year from a date.	 *	 * @since   12.1	 */	public function year($date)	{		return 'EXTRACT (YEAR FROM ' . $date . ')';	}	/**	 * Used to get a string to extract month from date column.	 *	 * Usage:	 * $query->select($query->month($query->quoteName('dateColumn')));	 *	 * @param   string  $date  Date column containing month to be extracted.	 *	 * @return  string  Returns string to extract month from a date.	 *	 * @since   12.1	 */	public function month($date)	{		return 'EXTRACT (MONTH FROM ' . $date . ')';	}	/**	 * Used to get a string to extract day from date column.	 *	 * Usage:	 * $query->select($query->day($query->quoteName('dateColumn')));	 *	 * @param   string  $date  Date column containing day to be extracted.	 *	 * @return  string  Returns string to extract day from a date.	 *	 * @since   12.1	 */	public function day($date)	{		return 'EXTRACT (DAY FROM ' . $date . ')';	}	/**	 * Used to get a string to extract hour from date column.	 *	 * Usage:	 * $query->select($query->hour($query->quoteName('dateColumn')));	 *	 * @param   string  $date  Date column containing hour to be extracted.	 *	 * @return  string  Returns string to extract hour from a date.	 *	 * @since   12.1	 */	public function hour($date)	{		return 'EXTRACT (HOUR FROM ' . $date . ')';	}	/**	 * Used to get a string to extract minute from date column.	 *	 * Usage:	 * $query->select($query->minute($query->quoteName('dateColumn')));	 *	 * @param   string  $date  Date column containing minute to be extracted.	 *	 * @return  string  Returns string to extract minute from a date.	 *	 * @since   12.1	 */	public function minute($date)	{		return 'EXTRACT (MINUTE FROM ' . $date . ')';	}	/**	 * Used to get a string to extract seconds from date column.	 *	 * Usage:	 * $query->select($query->second($query->quoteName('dateColumn')));	 *	 * @param   string  $date  Date column containing second to be extracted.	 *	 * @return  string  Returns string to extract second from a date.	 *	 * @since   12.1	 */	public function second($date)	{		return 'EXTRACT (SECOND FROM ' . $date . ')';	}	/**	 * Sets the NOWAIT lock on select's output row	 *	 * @return  JDatabaseQuery  NO WAIT query element	 *	 * @since   11.3	 */	public function noWait ()	{		$this->type = 'noWait';		if ( is_null($this->noWait) )		{			$this->noWait = new JDatabaseQueryElement('NOWAIT', null);		}		return $this;	}	/**	 * Set the LIMIT clause to the query	 *	 * @param   int  $limit  An int of how many row will be returned	 *	 * @return  JDatabaseQuery  Returns this object to allow chaining.	 *	 * @since   11.3	 */	public function limit( $limit = 0 )	{		if (is_null($this->limit))		{			$this->limit = new JDatabaseQueryElement('LIMIT', (int) $limit);		}		return $this;	}	/**	 * Set the OFFSET clause to the query	 *	 * @param   int  $offset  An int for skipping row	 *	 * @return  JDatabaseQuery  Returns this object to allow chaining.	 *	 * @since   11.3	 */	public function offset( $offset = 0 )	{		if (is_null($this->offset))		{			$this->offset = new JDatabaseQueryElement('OFFSET', (int) $offset);		}		return $this;	}	/**	 * Add the RETURNING element to INSERT INTO statement.	 *	 * @param   mixed  $pkCol  The name of the primary key column.	 *	 * @return  JDatabaseQuery  Returns this object to allow chaining.	 *	 * @since   11.3	 */	public function returning( $pkCol )	{		if (is_null($this->returning))		{			$this->returning = new JDatabaseQueryElement('RETURNING', $pkCol);		}		return $this;	}	/**	 * Sets the offset and limit for the result set, if the database driver supports it.	 *	 * Usage:	 * $query->setLimit(100, 0); (retrieve 100 rows, starting at first record)	 * $query->setLimit(50, 50); (retrieve 50 rows, starting at 50th record)	 *	 * @param   integer  $limit   The limit for the result set	 * @param   integer  $offset  The offset for the result set	 *	 * @return  JDatabaseQuery  Returns this object to allow chaining.	 *	 * @since   12.1	 */	public function setLimit($limit = 0, $offset = 0)	{		$this->limit  = (int) $limit;		$this->offset = (int) $offset;		return $this;	}	/**	 * Method to modify a query already in string format with the needed	 * additions to make the query limited to a particular number of	 * results, or start at a particular offset.	 *	 * @param   string   $query   The query in string format	 * @param   integer  $limit   The limit for the result set	 * @param   integer  $offset  The offset for the result set	 *	 * @return string	 *	 * @since 12.1	 */	public function processLimit($query, $limit, $offset = 0)	{		if ($limit > 0)		{			$query .= ' LIMIT ' . $limit;		}		if ($offset > 0)		{			$query .= ' OFFSET ' . $offset;		}		return $query;	}	/**	 * Add to the current date and time in Postgresql.	 * Usage:	 * $query->select($query->dateAdd());	 * Prefixing the interval with a - (negative sign) will cause subtraction to be used.	 *	 * @param   datetime  $date      The date to add to	 * @param   string    $interval  The string representation of the appropriate number of units	 * @param   string    $datePart  The part of the date to perform the addition on	 *	 * @return  string  The string with the appropriate sql for addition of dates	 *	 * @since   13.1	 * @note Not all drivers support all units. Check appropriate references	 * @link http://www.postgresql.org/docs/9.0/static/functions-datetime.html.	 */	public function dateAdd($date, $interval, $datePart)	{		if (substr($interval, 0, 1) != '-')		{			return "timestamp '" . $date . "' + interval '" . $interval . " " . $datePart . "'";		}		else		{			return "timestamp '" . $date . "' - interval '" . ltrim($interval, '-') . " " . $datePart . "'";		}	}}
<?php/** * @package     Joomla.Platform * @subpackage  Linkedin * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die();/** * Joomla Platform class for interacting with a Linkedin API instance. * * @package     Joomla.Platform * @subpackage  Linkedin * @since       13.1 */class JLinkedin{	/**	 * @var    JRegistry  Options for the Linkedin object.	 * @since  13.1	 */	protected $options;	/**	 * @var    JHttp  The HTTP client object to use in sending HTTP requests.	 * @since  13.1	 */	protected $client;	/**	 * @var JLinkedinOAuth The OAuth client.	 * @since 13.1	 */	protected $oauth;	/**	 * @var    JLinkedinPeople  Linkedin API object for people.	 * @since  13.1	 */	protected $people;	/**	 * @var    JLinkedinGroups  Linkedin API object for groups.	 * @since  13.1	 */	protected $groups;	/**	 * @var    JLinkedinCompanies  Linkedin API object for companies.	 * @since  13.1	 */	protected $companies;	/**	 * @var    JLinkedinJobs  Linkedin API object for jobs.	 * @since  13.1	 */	protected $jobs;	/**	 * @var    JLinkedinStream  Linkedin API object for social stream.	 * @since  13.1	 */	protected $stream;	/**	 * @var    JLinkedinCommunications  Linkedin API object for communications.	 * @since  13.1	 */	protected $communications;	/**	 * Constructor.	 *	 * @param   JLinkedinOauth  $oauth    OAuth object	 * @param   JRegistry       $options  Linkedin options object.	 * @param   JHttp           $client   The HTTP client object.	 *	 * @since   13.1	 */	public function __construct(JLinkedinOauth $oauth = null, JRegistry $options = null, JHttp $client = null)	{		$this->oauth = $oauth;		$this->options = isset($options) ? $options : new JRegistry;		$this->client  = isset($client) ? $client : new JHttp($this->options);		// Setup the default API url if not already set.		$this->options->def('api.url', 'https://api.linkedin.com');	}	/**	 * Magic method to lazily create API objects	 *	 * @param   string  $name  Name of property to retrieve	 *	 * @return  JLinkedinObject  Linkedin API object (statuses, users, favorites, etc.).	 *	 * @since   13.1	 */	public function __get($name)	{		switch ($name)		{			case 'people':				if ($this->people == null)				{					$this->people = new JLinkedinPeople($this->options, $this->client, $this->oauth);				}				return $this->people;			case 'groups':				if ($this->groups == null)				{					$this->groups = new JLinkedinGroups($this->options, $this->client, $this->oauth);				}				return $this->groups;			case 'companies':				if ($this->companies == null)				{					$this->companies = new JLinkedinCompanies($this->options, $this->client, $this->oauth);				}				return $this->companies;			case 'jobs':				if ($this->jobs == null)				{					$this->jobs = new JLinkedinJobs($this->options, $this->client, $this->oauth);				}				return $this->jobs;			case 'stream':				if ($this->stream == null)				{					$this->stream = new JLinkedinStream($this->options, $this->client, $this->oauth);				}				return $this->stream;			case 'communications':				if ($this->communications == null)				{					$this->communications = new JLinkedinCommunications($this->options, $this->client, $this->oauth);				}				return $this->communications;		}	}	/**	 * Get an option from the JLinkedin instance.	 *	 * @param   string  $key  The name of the option to get.	 *	 * @return  mixed  The option value.	 *	 * @since   13.1	 */	public function getOption($key)	{		return $this->options->get($key);	}	/**	 * Set an option for the Linkedin instance.	 *	 * @param   string  $key    The name of the option to set.	 * @param   mixed   $value  The option value to set.	 *	 * @return  JLinkedin  This object for method chaining.	 *	 * @since   13.1	 */	public function setOption($key, $value)	{		$this->options->set($key, $value);		return $this;	}}
<?php/** * @package    Joomla.Administrator * * @copyright  Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license    GNU General Public License version 2 or later; see LICENSE.txt */if (version_compare(PHP_VERSION, '5.3.1', '<')){	die('Your host needs to use PHP 5.3.1 or higher to run this version of Joomla!');}/** * Constant that is checked in included files to prevent direct access. * define() is used in the installation folder rather than "const" to not error for PHP 5.2 and lower */define('_JEXEC', 1);if (file_exists(__DIR__ . '/defines.php')){	include_once __DIR__ . '/defines.php';}if (!defined('_JDEFINES')){	define('JPATH_BASE', __DIR__);	require_once JPATH_BASE.'/includes/defines.php';}require_once JPATH_BASE.'/includes/framework.php';require_once JPATH_BASE.'/includes/helper.php';require_once JPATH_BASE.'/includes/toolbar.php';// Mark afterLoad in the profiler.JDEBUG ? $_PROFILER->mark('afterLoad') : null;// Instantiate the application.$app = JFactory::getApplication('administrator');// Initialise the application.$app->initialise(	array('language' => $app->getUserState('application.lang')));// Mark afterIntialise in the profiler.JDEBUG ? $_PROFILER->mark('afterInitialise') : null;// Route the application.$app->route();// Mark afterRoute in the profiler.JDEBUG ? $_PROFILER->mark('afterRoute') : null;// Dispatch the application.$app->dispatch();// Mark afterDispatch in the profiler.JDEBUG ? $_PROFILER->mark('afterDispatch') : null;// Render the application.$app->render();// Mark afterRender in the profiler.JDEBUG ? $_PROFILER->mark('afterRender') : null;// Return the response.echo $app;
<?php/** * @package     Joomla.Libraries * @subpackage  Installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.base.adapterinstance');jimport('joomla.filesystem.folder');/** * Plugin installer * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 */class JInstallerAdapterPlugin extends JAdapterInstance{	/**	 * Install function routing	 *	 * @var    string	 * @since  3.1	 * */	protected $route = 'install';	/**	 * The installation manifest XML object	 *	 * @var	 * @since  3.1	 * */	protected $manifest = null;	/**	 * A path to the PHP file that the scriptfile declaration in	 * the manifest refers to.	 *	 * @var	 * @since  3.1	 * */	protected $manifest_script = null;	/**	 * Name of the extension	 *	 * @var	 * @since  3.1	 * */	protected $name = null;	/**	 *	 *	 * @var	 * @since  3.1	 * */	protected $scriptElement = null;	/**	 * @var	 * @since  3.1	 */	protected $oldFiles = null;	/**	 * Custom loadLanguage method	 *	 * @param   string  $path  The path where to find language files.	 *	 * @return  void	 *	 * @since   3.1	 */	public function loadLanguage($path = null)	{		$source = $this->parent->getPath('source');		if (!$source)		{			$this->parent->setPath('source', JPATH_PLUGINS . '/' . $this->parent->extension->folder . '/' . $this->parent->extension->element);		}		$this->manifest = $this->parent->getManifest();		$element = $this->manifest->files;		if ($element)		{			$group = strtolower((string) $this->manifest->attributes()->group);			$name = '';			if (count($element->children()))			{				foreach ($element->children() as $file)				{					if ((string) $file->attributes()->plugin)					{						$name = strtolower((string) $file->attributes()->plugin);						break;					}				}			}			if ($name)			{				$extension = "plg_${group}_${name}";				$lang = JFactory::getLanguage();				$source = $path ? $path : JPATH_PLUGINS . "/$group/$name";				$folder = (string) $element->attributes()->folder;				if ($folder && file_exists("$path/$folder"))				{					$source = "$path/$folder";				}				$lang->load($extension . '.sys', $source, null, false, false)					|| $lang->load($extension . '.sys', JPATH_ADMINISTRATOR, null, false, false)					|| $lang->load($extension . '.sys', $source, $lang->getDefault(), false, false)					|| $lang->load($extension . '.sys', JPATH_ADMINISTRATOR, $lang->getDefault(), false, false);			}		}	}	/**	 * Custom install method	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function install()	{		// Get a database connector object		$db = $this->parent->getDbo();		// Get the extension manifest object		$this->manifest = $this->parent->getManifest();		$xml = $this->manifest;		/*		 * ---------------------------------------------------------------------------------------------		 * Manifest Document Setup Section		 * ---------------------------------------------------------------------------------------------		 */		// Set the extension name		$name = (string) $xml->name;		$name = JFilterInput::getInstance()->clean($name, 'string');		$this->set('name', $name);		// Get the plugin description		$description = (string) $xml->description;		if ($description)		{			$this->parent->set('message', JText::_($description));		}		else		{			$this->parent->set('message', '');		}		/*		 * Backward Compatibility		 * @todo Deprecate in future version		 */		$type = (string) $xml->attributes()->type;		// Set the installation path		if (count($xml->files->children()))		{			foreach ($xml->files->children() as $file)			{				if ((string) $file->attributes()->$type)				{					$element = (string) $file->attributes()->$type;					break;				}			}		}		$group = (string) $xml->attributes()->group;		if (!empty($element) && !empty($group))		{			$this->parent->setPath('extension_root', JPATH_PLUGINS . '/' . $group . '/' . $element);		}		else		{			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PLG_INSTALL_NO_FILE', JText::_('JLIB_INSTALLER_' . $this->route)));			return false;		}		// Check if we should enable overwrite settings		// Check to see if a plugin by the same name is already installed.		$query = $db->getQuery(true)			->select($db->quoteName('extension_id'))			->from($db->quoteName('#__extensions'))			->where($db->quoteName('folder') . ' = ' . $db->quote($group))			->where($db->quoteName('element') . ' = ' . $db->quote($element));		$db->setQuery($query);		try		{			$db->execute();		}		catch (RuntimeException $e)		{			// Install failed, roll back changes			$this->parent				->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PLG_INSTALL_ROLLBACK', JText::_('JLIB_INSTALLER_' . $this->route), $db->stderr(true)));			return false;		}		$id = $db->loadResult();		// If it's on the fs...		if (file_exists($this->parent->getPath('extension_root')) && (!$this->parent->isOverwrite() || $this->parent->isUpgrade()))		{			$updateElement = $xml->update;			// Upgrade manually set or update function available or update tag detected			if ($this->parent->isUpgrade() || ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'update'))				|| $updateElement)			{				// Force this one				$this->parent->setOverwrite(true);				$this->parent->setUpgrade(true);				if ($id)				{					// If there is a matching extension mark this as an update; semantics really					$this->route = 'update';				}			}			elseif (!$this->parent->isOverwrite())			{				// Overwrite is set				// We didn't have overwrite set, find an update function or find an update tag so lets call it safe				$this->parent					->abort(					JText::sprintf(						'JLIB_INSTALLER_ABORT_PLG_INSTALL_DIRECTORY', JText::_('JLIB_INSTALLER_' . $this->route),						$this->parent->getPath('extension_root')					)				);				return false;			}		}		/*		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, let's load it; we'll copy it later (don't have destination yet).		if ((string) $xml->scriptfile)		{			$manifestScript = (string) $xml->scriptfile;			$manifestScriptFile = $this->parent->getPath('source') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// If a dash is present in the group name, remove it			$groupClass = str_replace('-', '', $group);			// Set the class name			$classname = 'plg' . $groupClass . $element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		// Run preflight if possible (since we know we're not an update)		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'preflight'))		{			if ($this->parent->manifestClass->preflight($this->route, $this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_PLG_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Create msg object; first use here		$msg = ob_get_contents();		ob_end_clean();		/*		 * ---------------------------------------------------------------------------------------------		 * Filesystem Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// If the plugin directory does not exist, lets create it		$created = false;		if (!file_exists($this->parent->getPath('extension_root')))		{			if (!$created = JFolder::create($this->parent->getPath('extension_root')))			{				$this->parent					->abort(					JText::sprintf(						'JLIB_INSTALLER_ABORT_PLG_INSTALL_CREATE_DIRECTORY', JText::_('JLIB_INSTALLER_' . $this->route),						$this->parent->getPath('extension_root')					)				);				return false;			}		}		// If we're updating at this point when there is always going to be an extension_root find the old XML files		if ($this->route == 'update')		{			// Hunt for the original XML file			$old_manifest = null;			// Create a new installer because findManifest sets stuff; side effects!			$tmpInstaller = new JInstaller;			// Look in the extension root			$tmpInstaller->setPath('source', $this->parent->getPath('extension_root'));			if ($tmpInstaller->findManifest())			{				$old_manifest = $tmpInstaller->getManifest();				$this->oldFiles = $old_manifest->files;			}		}		/*		 * If we created the plugin directory and will want to remove it if we		 * have to roll back the installation, let's add it to the installation		 * step stack		 */		if ($created)		{			$this->parent->pushStep(array('type' => 'folder', 'path' => $this->parent->getPath('extension_root')));		}		// Copy all necessary files		if ($this->parent->parseFiles($xml->files, -1, $this->oldFiles) === false)		{			// Install failed, roll back changes			$this->parent->abort();			return false;		}		// Parse optional tags -- media and language files for plugins go in admin app		$this->parent->parseMedia($xml->media, 1);		$this->parent->parseLanguages($xml->languages, 1);		// If there is a manifest script, lets copy it.		if ($this->get('manifest_script'))		{			$path['src'] = $this->parent->getPath('source') . '/' . $this->get('manifest_script');			$path['dest'] = $this->parent->getPath('extension_root') . '/' . $this->get('manifest_script');			if (!file_exists($path['dest']))			{				if (!$this->parent->copyFiles(array($path)))				{					// Install failed, rollback changes					$this->parent						->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PLG_INSTALL_MANIFEST', JText::_('JLIB_INSTALLER_' . $this->route)));					return false;				}			}		}		/*		 * ---------------------------------------------------------------------------------------------		 * Database Processing Section		 * ---------------------------------------------------------------------------------------------		 */		$row = JTable::getInstance('extension');		// Was there a plugin with the same name already installed?		if ($id)		{			if (!$this->parent->isOverwrite())			{				// Install failed, roll back changes				$this->parent					->abort(					JText::sprintf(						'JLIB_INSTALLER_ABORT_PLG_INSTALL_ALLREADY_EXISTS', JText::_('JLIB_INSTALLER_' . $this->route),						$this->get('name')					)				);				return false;			}			$row->load($id);			$row->name = $this->get('name');			$row->manifest_cache = $this->parent->generateManifestCache();			// Update the manifest cache and name			$row->store();		}		else		{			// Store in the extensions table (1.6)			$row->name = $this->get('name');			$row->type = 'plugin';			$row->ordering = 0;			$row->element = $element;			$row->folder = $group;			$row->enabled = 0;			$row->protected = 0;			$row->access = 1;			$row->client_id = 0;			$row->params = $this->parent->getParams();			// Custom data			$row->custom_data = '';			// System data			$row->system_data = '';			$row->manifest_cache = $this->parent->generateManifestCache();			// Editor plugins are published by default			if ($group == 'editors')			{				$row->enabled = 1;			}			if (!$row->store())			{				// Install failed, roll back changes				$this->parent					->abort(					JText::sprintf('JLIB_INSTALLER_ABORT_PLG_INSTALL_ROLLBACK', JText::_('JLIB_INSTALLER_' . $this->route), $db->stderr(true))				);				return false;			}			// Since we have created a plugin item, we add it to the installation step stack			// so that if we have to rollback the changes we can undo it.			$this->parent->pushStep(array('type' => 'extension', 'id' => $row->extension_id));			$id = $row->extension_id;		}		// Let's run the queries for the plugin		if (strtolower($this->route) == 'install')		{			$result = $this->parent->parseSQLFiles($this->manifest->install->sql);			if ($result === false)			{				// Install failed, rollback changes				$this->parent					->abort(					JText::sprintf('JLIB_INSTALLER_ABORT_PLG_INSTALL_SQL_ERROR', JText::_('JLIB_INSTALLER_' . $this->route), $db->stderr(true))				);				return false;			}			// Set the schema version to be the latest update version			if ($this->manifest->update)			{				$this->parent->setSchemaVersion($this->manifest->update->schemas, $row->extension_id);			}		}		elseif (strtolower($this->route) == 'update')		{			if ($this->manifest->update)			{				$result = $this->parent->parseSchemaUpdates($this->manifest->update->schemas, $row->extension_id);				if ($result === false)				{					// Install failed, rollback changes					$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PLG_UPDATE_SQL_ERROR', $db->stderr(true)));					return false;				}			}		}		// Run the custom method based on the route		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, $this->route))		{			if ($this->parent->manifestClass->{$this->route}($this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_PLG_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		/**		 * ---------------------------------------------------------------------------------------------		 * Finalization and Cleanup Section		 * ---------------------------------------------------------------------------------------------		 */		// Lastly, we will copy the manifest file to its appropriate place.		if (!$this->parent->copyManifest(-1))		{			// Install failed, rollback changes			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PLG_INSTALL_COPY_SETUP', JText::_('JLIB_INSTALLER_' . $this->route)));			return false;		}		// And now we run the postflight		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'postflight'))		{			$this->parent->manifestClass->postflight($this->route, $this);		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		return $id;	}	/**	 * Custom update method	 *	 * @return   boolean  True on success	 *	 * @since    3.1	 */	public function update()	{		// Set the overwrite setting		$this->parent->setOverwrite(true);		$this->parent->setUpgrade(true);		// Set the route for the install		$this->route = 'update';		// Go to install which handles updates properly		return $this->install();	}	/**	 * Custom uninstall method	 *	 * @param   integer  $id  The id of the plugin to uninstall	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function uninstall($id)	{		$this->route = 'uninstall';		$row = null;		$retval = true;		$db = $this->parent->getDbo();		// First order of business will be to load the plugin object table from the database.		// This should give us the necessary information to proceed.		$row = JTable::getInstance('extension');		if (!$row->load((int) $id))		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PLG_UNINSTALL_ERRORUNKOWNEXTENSION'), JLog::WARNING, 'jerror');			return false;		}		// Is the plugin we are trying to uninstall a core one?		// Because that is not a good idea...		if ($row->protected)		{			JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_PLG_UNINSTALL_WARNCOREPLUGIN', $row->name), JLog::WARNING, 'jerror');			return false;		}		// Get the plugin folder so we can properly build the plugin path		if (trim($row->folder) == '')		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PLG_UNINSTALL_FOLDER_FIELD_EMPTY'), JLog::WARNING, 'jerror');			return false;		}		// Set the plugin root path		$this->parent->setPath('extension_root', JPATH_PLUGINS . '/' . $row->folder . '/' . $row->element);		$this->parent->setPath('source', $this->parent->getPath('extension_root'));		$this->parent->findManifest();		$this->manifest = $this->parent->getManifest();		// Attempt to load the language file; might have uninstall strings		$this->parent->setPath('source', JPATH_PLUGINS . '/' . $row->folder . '/' . $row->element);		$this->loadLanguage(JPATH_PLUGINS . '/' . $row->folder . '/' . $row->element);		/**		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, let's load it; we'll copy it later (don't have dest yet)		$manifestScript = (string) $this->manifest->scriptfile;		if ($manifestScript)		{			$manifestScriptFile = $this->parent->getPath('source') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// If a dash is present in the folder, remove it			$folderClass = str_replace('-', '', $row->folder);			// Set the class name			$classname = 'plg' . $folderClass . $row->element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		// Run preflight if possible (since we know we're not an update)		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'preflight'))		{			if ($this->parent->manifestClass->preflight($this->route, $this) === false)			{				// Preflight failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_PLG_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Create the $msg object and append messages from preflight		$msg = ob_get_contents();		ob_end_clean();		// Let's run the queries for the plugin		$utfresult = $this->parent->parseSQLFiles($this->manifest->uninstall->sql);		if ($utfresult === false)		{			// Install failed, rollback changes			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_PLG_UNINSTALL_SQL_ERROR', $db->stderr(true)));			return false;		}		// Run the custom uninstall method if possible		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'uninstall'))		{			$this->parent->manifestClass->uninstall($this);		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		// Remove the plugin files		$this->parent->removeFiles($this->manifest->files, -1);		// Remove all media and languages as well		$this->parent->removeFiles($this->manifest->media);		$this->parent->removeFiles($this->manifest->languages, 1);		// Remove the schema version		$query = $db->getQuery(true)			->delete('#__schemas')			->where('extension_id = ' . $row->extension_id);		$db->setQuery($query);		$db->execute();		// Now we will no longer need the plugin object, so let's delete it		$row->delete($row->extension_id);		unset($row);		// Remove the plugin's folder		JFolder::delete($this->parent->getPath('extension_root'));		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		return $retval;	}	/**	 * Custom discover method	 *	 * @return  array  JExtension) list of extensions available	 *	 * @since   3.1	 */	public function discover()	{		$results = array();		$folder_list = JFolder::folders(JPATH_SITE . '/plugins');		foreach ($folder_list as $folder)		{			$file_list = JFolder::files(JPATH_SITE . '/plugins/' . $folder, '\.xml$');			foreach ($file_list as $file)			{				$manifest_details = JInstaller::parseXMLInstallFile(JPATH_SITE . '/plugins/' . $folder . '/' . $file);				$file = JFile::stripExt($file);				// Ignore example plugins				if ($file == 'example')				{					continue;				}				$extension = JTable::getInstance('extension');				$extension->set('type', 'plugin');				$extension->set('client_id', 0);				$extension->set('element', $file);				$extension->set('folder', $folder);				$extension->set('name', $file);				$extension->set('state', -1);				$extension->set('manifest_cache', json_encode($manifest_details));				$extension->set('params', '{}');				$results[] = $extension;			}			$folder_list = JFolder::folders(JPATH_SITE . '/plugins/' . $folder);			foreach ($folder_list as $plugin_folder)			{				$file_list = JFolder::files(JPATH_SITE . '/plugins/' . $folder . '/' . $plugin_folder, '\.xml$');				foreach ($file_list as $file)				{					$manifest_details = JInstaller::parseXMLInstallFile(						JPATH_SITE . '/plugins/' . $folder . '/' . $plugin_folder . '/' . $file					);					$file = JFile::stripExt($file);					if ($file == 'example')					{						continue;					}					// Ignore example plugins					$extension = JTable::getInstance('extension');					$extension->set('type', 'plugin');					$extension->set('client_id', 0);					$extension->set('element', $file);					$extension->set('folder', $folder);					$extension->set('name', $file);					$extension->set('state', -1);					$extension->set('manifest_cache', json_encode($manifest_details));					$extension->set('params', '{}');					$results[] = $extension;				}			}		}		return $results;	}	/**	 * Custom discover_install method.	 *	 * @return  mixed	 *	 * @since   3.1	 */	public function discover_install()	{		/*		 * Plugins use the extensions table as their primary store		 * Similar to modules and templates, rather easy		 * If it's not in the extensions table we just add it		 */		$client = JApplicationHelper::getClientInfo($this->parent->extension->client_id);		if (is_dir($client->path . '/plugins/' . $this->parent->extension->folder . '/' . $this->parent->extension->element))		{			$manifestPath = $client->path . '/plugins/' . $this->parent->extension->folder . '/' . $this->parent->extension->element . '/'				. $this->parent->extension->element . '.xml';		}		else		{			$manifestPath = $client->path . '/plugins/' . $this->parent->extension->folder . '/' . $this->parent->extension->element . '.xml';		}		$this->parent->manifest = $this->parent->isManifest($manifestPath);		$description = (string) $this->parent->manifest->description;		if ($description)		{			$this->parent->set('message', JText::_($description));		}		else		{			$this->parent->set('message', '');		}		$this->parent->setPath('manifest', $manifestPath);		$manifest_details = JInstaller::parseXMLInstallFile($manifestPath);		$this->parent->extension->manifest_cache = json_encode($manifest_details);		$this->parent->extension->state = 0;		$this->parent->extension->name = $manifest_details['name'];		$this->parent->extension->enabled = ('editors' == $this->parent->extension->folder) ? 1 : 0;		$this->parent->extension->params = $this->parent->getParams();		if ($this->parent->extension->store())		{			return $this->parent->extension->get('extension_id');		}		else		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PLG_DISCOVER_STORE_DETAILS'), JLog::WARNING, 'jerror');			return false;		}	}	/**	 * Refreshes the extension table cache.	 *	 * @return  boolean  Result of operation, true if updated, false on failure.	 *	 * @since   3.1	 */	public function refreshManifestCache()	{		/*		 * Plugins use the extensions table as their primary store		 * Similar to modules and templates, rather easy		 * If it's not in the extensions table we just add it		 */		$client = JApplicationHelper::getClientInfo($this->parent->extension->client_id);		$manifestPath = $client->path . '/plugins/' . $this->parent->extension->folder . '/' . $this->parent->extension->element . '/'			. $this->parent->extension->element . '.xml';		$this->parent->manifest = $this->parent->isManifest($manifestPath);		$this->parent->setPath('manifest', $manifestPath);		$manifest_details = JInstaller::parseXMLInstallFile($this->parent->getPath('manifest'));		$this->parent->extension->manifest_cache = json_encode($manifest_details);		$this->parent->extension->name = $manifest_details['name'];		if ($this->parent->extension->store())		{			return true;		}		else		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_PLG_REFRESH_MANIFEST_CACHE'), JLog::WARNING, 'jerror');			return false;		}	}}/** * Deprecated class placeholder. You should use JInstallerAdapterPlugin instead. * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 * @deprecated  4.0 * @codeCoverageIgnore */class JInstallerPlugin extends JInstallerAdapterPlugin{}
<?php/** * @package     Joomla.Administrator * @subpackage  com_languages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;if (!JFactory::getUser()->authorise('core.manage', 'com_languages')){	return JError::raiseWarning(404, JText::_('JERROR_ALERTNOAUTHOR'));}$controller	= JControllerLegacy::getInstance('Languages');$controller->execute(JFactory::getApplication()->input->get('task'));$controller->redirect();
<?php/** * @package     Joomla.Administrator * @subpackage  com_config * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$app = JFactory::getApplication();$template = $app->getTemplate();// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');JHtml::_('bootstrap.framework');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (document.formvalidator.isValid(document.id('component-form')))		{			Joomla.submitform(task, document.getElementById('component-form'));		}	}</script><form action="<?php echo JRoute::_('index.php?option=com_config');?>" id="component-form" method="post" name="adminForm" autocomplete="off" class="form-validate">	<?php	echo JHtml::_('tabs.start', 'config-tabs-' . $this->component->option.'_configuration', array('useCookie' => 1));		$fieldSets = $this->form->getFieldsets();		foreach ($fieldSets as $name => $fieldSet) :			$label = empty($fieldSet->label) ? 'COM_CONFIG_'.$name.'_FIELDSET_LABEL' : $fieldSet->label;			echo JHtml::_('tabs.panel', JText::_($label), 'publishing-details');			if (isset($fieldSet->description) && !empty($fieldSet->description)) :				echo '<p class="tab-description">'.JText::_($fieldSet->description).'</p>';			endif;	?>		<ul class="config-option-list">		<?php		foreach ($this->form->getFieldset($name) as $field):		?>			<li>			<?php if (!$field->hidden) : ?>			<?php echo $field->label; ?>			<?php endif; ?>			<?php echo $field->input; ?>			</li>		<?php		endforeach;		?>		</ul>	<div class="clr"></div>	<?php		endforeach;	echo JHtml::_('tabs.end');	?>	<div>		<input type="hidden" name="id" value="<?php echo $this->component->id;?>" />		<input type="hidden" name="component" value="<?php echo $this->component->option;?>" />		<input type="hidden" name="return" value="<?php echo $this->return;?>" />		<input type="hidden" name="task" value="" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;if (!JFactory::getUser()->authorise('core.manage', 'com_users')){	return JError::raiseWarning(404, JText::_('JERROR_ALERTNOAUTHOR'));}JLoader::register('UsersHelper', __DIR__ . '/helpers/users.php');$controller	= JControllerLegacy::getInstance('Users');$controller->execute(JFactory::getApplication()->input->get('task'));$controller->redirect();
<?php/** * @package     Joomla.Administrator * @subpackage  com_languages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');JHtml::_('formbehavior.chosen', 'select');JHtml::_('bootstrap.tooltip');$user		= JFactory::getUser();$userId		= $user->get('id');$n			= count($this->items);$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));$canOrder	= $user->authorise('core.edit.state', 'com_languages');$saveOrder	= $listOrder == 'a.ordering';?><form action="<?php echo JRoute::_('index.php?option=com_languages&view=languages'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_LANGUAGES_SEARCH_IN_TITLE'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_LANGUAGES_SEARCH_IN_TITLE'); ?>" />			</div>			<div class="btn-group pull-left">				<button class="btn hasTooltip" type="submit" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button class="btn hasTooltip" type="button" title="<?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?>" onclick="document.id('filter_search').value='';this.form.submit();"><i class="icon-remove"></i></button>			</div>		</div>		<div class="clearfix"> </div>		<table class="table table-striped">			<thead>				<tr>					<th width="5">						<?php echo JText::_('JGRID_HEADING_ROW_NUMBER'); ?>					</th>					<th width="20">						<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />					</th>					<th class="title">						<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>					</th>					<th class="title">						<?php echo JHtml::_('grid.sort', 'COM_LANGUAGES_HEADING_TITLE_NATIVE', 'a.title_native', $listDirn, $listOrder); ?>					</th>					<th width="5%" class="nowrap">						<?php echo JHtml::_('grid.sort', 'COM_LANGUAGES_FIELD_LANG_TAG_LABEL', 'a.lang_code', $listDirn, $listOrder); ?>					</th>					<th width="5%" class="nowrap">						<?php echo JHtml::_('grid.sort', 'COM_LANGUAGES_FIELD_LANG_CODE_LABEL', 'a.sef', $listDirn, $listOrder); ?>					</th>					<th width="5%" class="nowrap">						<?php echo JHtml::_('grid.sort', 'COM_LANGUAGES_HEADING_LANG_IMAGE', 'a.image', $listDirn, $listOrder); ?>					</th>					<th width="10%" class="nowrap">						<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ORDERING', 'a.ordering', $listDirn, $listOrder); ?>						<?php if ($canOrder && $saveOrder) :?>							<?php echo JHtml::_('grid.order', $this->items, 'filesave.png', 'languages.saveorder'); ?>						<?php endif; ?>					</th>					<th width="5%" class="center nowrap">						<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ACCESS', 'a.access', $listDirn, $listOrder); ?>					</th>					<th width="5%" class="nowrap">						<?php echo JHtml::_('grid.sort', 'COM_LANGUAGES_HOMEPAGE', '', $listDirn, $listOrder); ?>					</th>					<th width="1%" class="center nowrap">						<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.lang_id', $listDirn, $listOrder); ?>					</th>				</tr>			</thead>			<tfoot>				<tr>					<td colspan="11">						<?php echo $this->pagination->getListFooter(); ?>					</td>				</tr>			</tfoot>			<tbody>			<?php			foreach ($this->items as $i => $item) :				$ordering  = ($listOrder == 'a.ordering');				$canCreate = $user->authorise('core.create',     'com_languages');				$canEdit   = $user->authorise('core.edit',       'com_languages');				$canChange = $user->authorise('core.edit.state', 'com_languages');			?>				<tr class="row<?php echo $i % 2; ?>">					<td>						<?php echo $this->pagination->getRowOffset($i); ?>					</td>					<td>						<?php echo JHtml::_('grid.id', $i, $item->lang_id); ?>					</td>					<td>						<?php echo JHtml::_('jgrid.published', $item->published, $i, 'languages.', $canChange);?>						<span class="editlinktip hasTip" title="<?php echo JText::_('JGLOBAL_EDIT_ITEM');?>::<?php echo $this->escape($item->title); ?>">						<?php if ($canEdit) : ?>							<a href="<?php echo JRoute::_('index.php?option=com_languages&task=language.edit&lang_id='.(int) $item->lang_id); ?>">								<?php echo $this->escape($item->title); ?></a>						<?php else : ?>								<?php echo $this->escape($item->title); ?>						<?php endif; ?>						</span>					</td>					<td>						<?php echo $this->escape($item->title_native); ?>					</td>					<td>						<?php echo $this->escape($item->lang_code); ?>					</td>					<td>						<?php echo $this->escape($item->sef); ?>					</td>					<td>						<?php echo $this->escape($item->image); ?>					</td>					<td class="order">						<?php if ($canChange) : ?>							<div class="input-prepend">								<?php if ($saveOrder) :?>									<?php if ($listDirn == 'asc') : ?>										<span class="add-on"><?php echo $this->pagination->orderUpIcon($i, true, 'languages.orderup', 'JLIB_HTML_MOVE_UP', $ordering); ?></span><span class="add-on"><?php echo $this->pagination->orderDownIcon($i, $this->pagination->total, true, 'languages.orderdown', 'JLIB_HTML_MOVE_DOWN', $ordering); ?></span>									<?php elseif ($listDirn == 'desc') : ?>										<span class="add-on"><?php echo $this->pagination->orderUpIcon($i, true, 'languages.orderdown', 'JLIB_HTML_MOVE_UP', $ordering); ?></span><span class="add-on"><?php echo $this->pagination->orderDownIcon($i, $this->pagination->total, true, 'languages.orderup', 'JLIB_HTML_MOVE_DOWN', $ordering); ?></span>									<?php endif; ?>								<?php endif; ?>								<?php $disabled = $saveOrder ? '' : 'disabled="disabled"'; ?>								<?php if (!$disabled = $saveOrder) : echo "<span class=\"add-on tip\" title=\"".JText::_('JDISABLED')."\"><i class=\"icon-ban-circle\"></i></span>"; endif;?><input type="text" name="order[]" size="5" value="<?php echo $item->ordering;?>" <?php echo $disabled ?> class="width-20 text-area-order" />							</div>						<?php else : ?>							<?php echo $item->ordering; ?>						<?php endif; ?>					</td>					<td class="center">						<?php echo $this->escape($item->access_level); ?>					</td>					<td>						<?php if ($item->home == '1') : ?>							<?php echo JText::_('JYES');?>						<?php else:?>							<?php echo JText::_('JNO');?>						<?php endif;?>					</td>					<td class="center">						<?php echo $this->escape($item->lang_id); ?>					</td>				</tr>				<?php endforeach; ?>			</tbody>		</table>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Platform * @subpackage  Cache * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Joomla! Cache page type object * * @package     Joomla.Platform * @subpackage  Cache * @since       11.1 */class JCacheControllerPage extends JCacheController{	/**	 * @var    integer  ID property for the cache page object.	 * @since  11.1	 */	protected $_id;	/**	 * @var    string  Cache group	 * @since  11.1	 */	protected $_group;	/**	 * @var    object  Cache lock test	 * @since  11.1	 */	protected $_locktest = null;	/**	 * Get the cached page data	 *	 * @param   string   $id          The cache data id	 * @param   string   $group       The cache data group	 * @param   boolean  $wrkarounds  True to use wrkarounds	 *	 * @return  boolean  True if the cache is hit (false else)	 *	 * @since   11.1	 */	public function get($id = false, $group = 'page', $wrkarounds = true)	{		// If an id is not given, generate it from the request		if ($id == false)		{			$id = $this->_makeId();		}		// If the etag matches the page id ... set a no change header and exit : utilize browser cache		if (!headers_sent() && isset($_SERVER['HTTP_IF_NONE_MATCH']))		{			$etag = stripslashes($_SERVER['HTTP_IF_NONE_MATCH']);			if ($etag == $id)			{				$browserCache = isset($this->options['browsercache']) ? $this->options['browsercache'] : false;				if ($browserCache)				{					$this->_noChange();				}			}		}		// We got a cache hit... set the etag header and echo the page data		$data = $this->cache->get($id, $group);		$this->_locktest = new stdClass;		$this->_locktest->locked = null;		$this->_locktest->locklooped = null;		if ($data === false)		{			$this->_locktest = $this->cache->lock($id, $group);			if ($this->_locktest->locked == true && $this->_locktest->locklooped == true)			{				$data = $this->cache->get($id, $group);			}		}		if ($data !== false)		{			$data = unserialize(trim($data));			if ($wrkarounds === true)			{				$data = JCache::getWorkarounds($data);			}			$this->_setEtag($id);			if ($this->_locktest->locked == true)			{				$this->cache->unlock($id, $group);			}			return $data;		}		// Set id and group placeholders		$this->_id = $id;		$this->_group = $group;		return false;	}	/**	 * Stop the cache buffer and store the cached data	 *	 * @param   mixed    $data        The data to store	 * @param   string   $id          The cache data id	 * @param   string   $group       The cache data group	 * @param   boolean  $wrkarounds  True to use wrkarounds	 *	 * @return  boolean  True if cache stored	 *	 * @since   11.1	 */	public function store($data, $id, $group = null, $wrkarounds = true)	{		// Get page data from JResponse body		$data = JResponse::getBody();		// Get id and group and reset the placeholders		$id = $this->_id;		$group = $this->_group;		$this->_id = null;		$this->_group = null;		// Only attempt to store if page data exists		if ($data)		{			$data = $wrkarounds == false ? $data : JCache::setWorkarounds($data);			if ($this->_locktest->locked == false)			{				$this->_locktest = $this->cache->lock($id, $group);			}			$sucess = $this->cache->store(serialize($data), $id, $group);			if ($this->_locktest->locked == true)			{				$this->cache->unlock($id, $group);			}			return $sucess;		}		return false;	}	/**	 * Generate a page cache id	 *	 * @return  string  MD5 Hash : page cache id	 *	 * @since   11.1	 * @todo    Discuss whether this should be coupled to a data hash or a request	 * hash ... perhaps hashed with a serialized request	 */	protected function _makeId()	{		return JCache::makeId();	}	/**	 * There is no change in page data so send an	 * unmodified header and die gracefully	 *	 * @return  void	 *	 * @since   11.1	 */	protected function _noChange()	{		$app = JFactory::getApplication();		// Send not modified header and exit gracefully		header('HTTP/1.x 304 Not Modified', true);		$app->close();	}	/**	 * Set the ETag header in the response	 *	 * @param   string  $etag  The entity tag (etag) to set	 *	 * @return  void	 *	 * @since   11.1	 */	protected function _setEtag($etag)	{		JResponse::setHeader('ETag', $etag, true);	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Finder.Weblinks * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_BASE') or die;// Load the base adapter.require_once JPATH_ADMINISTRATOR . '/components/com_finder/helpers/indexer/adapter.php';/** * Finder adapter for Joomla Web Links. * * @package     Joomla.Plugin * @subpackage  Finder.Weblinks * @since       2.5 */class PlgFinderWeblinks extends FinderIndexerAdapter{	/**	 * The plugin identifier.	 *	 * @var    string	 * @since  2.5	 */	protected $context = 'Weblinks';	/**	 * The extension name.	 *	 * @var    string	 * @since  2.5	 */	protected $extension = 'com_weblinks';	/**	 * The sublayout to use when rendering the results.	 *	 * @var    string	 * @since  2.5	 */	protected $layout = 'weblink';	/**	 * The type of content that the adapter indexes.	 *	 * @var    string	 * @since  2.5	 */	protected $type_title = 'Web Link';	/**	 * The table name.	 *	 * @var    string	 * @since  2.5	 */	protected $table = '#__weblinks';	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * Method to update the item link information when the item category is	 * changed. This is fired when the item category is published or unpublished	 * from the list view.	 *	 * @param   string   $extension  The extension whose category has been updated.	 * @param   array    $pks        A list of primary key ids of the content that has changed state.	 * @param   integer  $value      The value of the state that the content has been changed to.	 *	 * @return  void	 *	 * @since   2.5	 */	public function onFinderCategoryChangeState($extension, $pks, $value)	{		// Make sure we're handling com_weblinks categories		if ($extension == 'com_weblinks')		{			$this->categoryStateChange($pks, $value);		}	}	/**	 * Method to remove the link information for items that have been deleted.	 *	 * @param   string  $context  The context of the action being performed.	 * @param   JTable  $table    A JTable object containing the record to be deleted	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderAfterDelete($context, $table)	{		if ($context == 'com_weblinks.weblink')		{			$id = $table->id;		}		elseif ($context == 'com_finder.index')		{			$id = $table->link_id;		}		else		{			return true;		}		// Remove the items.		return $this->remove($id);	}	/**	 * Method to determine if the access level of an item changed.	 *	 * @param   string   $context  The context of the content passed to the plugin.	 * @param   JTable   $row      A JTable object	 * @param   boolean  $isNew    If the content has just been created	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderAfterSave($context, $row, $isNew)	{		// We only want to handle web links here. We need to handle front end and back end editing.		if ($context == 'com_weblinks.weblink' || $context == 'com_weblinks.form' )		{			// Check if the access levels are different			if (!$isNew && $this->old_access != $row->access)			{				// Process the change.				$this->itemAccessChange($row);			}			// Reindex the item			$this->reindex($row->id);		}		// Check for access changes in the category		if ($context == 'com_categories.category')		{			// Check if the access levels are different			if (!$isNew && $this->old_cataccess != $row->access)			{				$this->categoryAccessChange($row);			}		}		return true;	}	/**	 * Method to reindex the link information for an item that has been saved.	 * This event is fired before the data is actually saved so we are going	 * to queue the item to be indexed later.	 *	 * @param   string   $context  The context of the content passed to the plugin.	 * @param   JTable   $row     A JTable object	 * @param   boolean  $isNew    If the content is just about to be created	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	public function onFinderBeforeSave($context, $row, $isNew)	{		// We only want to handle web links here		if ($context == 'com_weblinks.weblink' || $context == 'com_weblinks.form')		{			// Query the database for the old access level if the item isn't new			if (!$isNew)			{				$this->checkItemAccess($row);			}		}		// Check for access levels from the category		if ($context == 'com_categories.category')		{			// Query the database for the old access level if the item isn't new			if (!$isNew)			{				$this->checkCategoryAccess($row);			}		}		return true;	}	/**	 * Method to update the link information for items that have been changed	 * from outside the edit screen. This is fired when the item is published,	 * unpublished, archived, or unarchived from the list view.	 *	 * @param   string   $context  The context for the content passed to the plugin.	 * @param   array    $pks      A list of primary key ids of the content that has changed state.	 * @param   integer  $value    The value of the state that the content has been changed to.	 *	 * @return  void	 *	 * @since   2.5	 */	public function onFinderChangeState($context, $pks, $value)	{		// We only want to handle web links here		if ($context == 'com_weblinks.weblink' || $context == 'com_weblinks.form')		{			$this->itemStateChange($pks, $value);		}		// Handle when the plugin is disabled		if ($context == 'com_plugins.plugin' && $value === 0)		{			$this->pluginDisable($pks);		}	}	/**	 * Method to index an item. The item must be a FinderIndexerResult object.	 *	 * @param   FinderIndexerResult  $item    The item to index as an FinderIndexerResult object.	 * @param   string               $format  The item format	 *	 * @return  void	 *	 * @since   2.5	 * @throws  Exception on database error.	 */	protected function index(FinderIndexerResult $item, $format = 'html')	{		// Check if the extension is enabled		if (JComponentHelper::isEnabled($this->extension) == false)		{			return;		}		$item->setLanguage();		// Initialize the item parameters.		$registry = new JRegistry;		$registry->loadString($item->params);		$item->params = $registry;		$registry = new JRegistry;		$registry->loadString($item->metadata);		$item->metadata = $registry;		// Build the necessary route and path information.		$item->url = $this->getURL($item->id, $this->extension, $this->layout);		$item->route = WeblinksHelperRoute::getWeblinkRoute($item->slug, $item->catslug);		$item->path = FinderIndexerHelper::getContentPath($item->route);		/*		 * Add the meta-data processing instructions based on the newsfeeds		 * configuration parameters.		 */		// Add the meta-author.		$item->metaauthor = $item->metadata->get('author');		// Handle the link to the meta-data.		$item->addInstruction(FinderIndexer::META_CONTEXT, 'link');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metakey');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metadesc');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'metaauthor');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'author');		$item->addInstruction(FinderIndexer::META_CONTEXT, 'created_by_alias');		// Add the type taxonomy data.		$item->addTaxonomy('Type', 'Web Link');		// Add the category taxonomy data.		$item->addTaxonomy('Category', $item->category, $item->cat_state, $item->cat_access);		// Add the language taxonomy data.		$item->addTaxonomy('Language', $item->language);		// Get content extras.		FinderIndexerHelper::getContentExtras($item);		// Index the item.		$this->indexer->index($item);	}	/**	 * Method to setup the indexer to be run.	 *	 * @return  boolean  True on success.	 *	 * @since   2.5	 */	protected function setup()	{		// Load dependent classes.		require_once JPATH_SITE . '/components/com_weblinks/helpers/route.php';		return true;	}	/**	 * Method to get the SQL query used to retrieve the list of content items.	 *	 * @param   mixed  $query  A JDatabaseQuery object or null.	 *	 * @return  JDatabaseQuery  A database object.	 *	 * @since   2.5	 */	protected function getListQuery($query = null)	{		$db = JFactory::getDbo();		// Check if we can use the supplied SQL query.		$query = $query instanceof JDatabaseQuery ? $query : $db->getQuery(true)			->select('a.id, a.catid, a.title, a.alias, a.url AS link, a.description AS summary')			->select('a.metakey, a.metadesc, a.metadata, a.language, a.access, a.ordering')			->select('a.created_by_alias, a.modified, a.modified_by')			->select('a.publish_up AS publish_start_date, a.publish_down AS publish_end_date')			->select('a.state AS state, a.created AS start_date, a.params')			->select('c.title AS category, c.published AS cat_state, c.access AS cat_access');		// Handle the alias CASE WHEN portion of the query		$case_when_item_alias = ' CASE WHEN ';		$case_when_item_alias .= $query->charLength('a.alias', '!=', '0');		$case_when_item_alias .= ' THEN ';		$a_id = $query->castAsChar('a.id');		$case_when_item_alias .= $query->concatenate(array($a_id, 'a.alias'), ':');		$case_when_item_alias .= ' ELSE ';		$case_when_item_alias .= $a_id.' END as slug';		$query->select($case_when_item_alias);		$case_when_category_alias = ' CASE WHEN ';		$case_when_category_alias .= $query->charLength('c.alias', '!=', '0');		$case_when_category_alias .= ' THEN ';		$c_id = $query->castAsChar('c.id');		$case_when_category_alias .= $query->concatenate(array($c_id, 'c.alias'), ':');		$case_when_category_alias .= ' ELSE ';		$case_when_category_alias .= $c_id.' END as catslug';		$query->select($case_when_category_alias)			->from('#__weblinks AS a')			->join('LEFT', '#__categories AS c ON c.id = a.catid');		return $query;	}	/**	 * Method to get the query clause for getting items to update by time.	 *	 * @param   string  $time  The modified timestamp.	 *	 * @return  JDatabaseQuery  A database object.	 *	 * @since   2.5	 */	protected function getUpdateQueryByTime($time)	{		// Build an SQL query based on the modified time.		$query = $this->db->getQuery(true)			->where('a.date >= ' . $this->db->quote($time));		return $query;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Content Component Category Tree * * @package     Joomla.Site * @subpackage  com_content * @since       1.6 */class ContentCategories extends JCategories{	public function __construct($options = array())	{		$options['table'] = '#__content';		$options['extension'] = 'com_content';		parent::__construct($options);	}}
<?php/** * @package     Joomla.Libraries * @subpackage  Installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.filesystem.file');jimport('joomla.filesystem.folder');jimport('joomla.filesystem.path');/** * Installer helper class * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 */abstract class JInstallerHelper{	/**	 * Downloads a package	 *	 * @param   string  $url     URL of file to download	 * @param   string  $target  Download target filename [optional]	 *	 * @return  mixed  Path to downloaded package or boolean false on failure	 *	 * @since   3.1	 */	public static function downloadPackage($url, $target = false)	{		$config = JFactory::getConfig();		// Capture PHP errors		$track_errors = ini_get('track_errors');		ini_set('track_errors', true);		// Set user agent		$version = new JVersion;		ini_set('user_agent', $version->getUserAgent('Installer'));		$http = JHttpFactory::getHttp();		$response = $http->get($url);		if (302 == $response->code && isset($response->headers['Location']))		{			return self::downloadPackage($response->headers['Location']);		}		elseif (200 != $response->code)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_DOWNLOAD_SERVER_CONNECT'), JLog::WARNING, 'jerror');			return false;		}		if (isset($response->headers['Content-Disposition']))		{			$contentfilename = explode("\"", $response->headers['Content-Disposition']);			$target = $contentfilename[1];		}		// Set the target path if not given		if (!$target)		{			$target = $config->get('tmp_path') . '/' . self::getFilenameFromURL($url);		}		else		{			$target = $config->get('tmp_path') . '/' . basename($target);		}		// Write buffer to file		JFile::write($target, $response->body);		// Restore error tracking to what it was before		ini_set('track_errors', $track_errors);		// Bump the max execution time because not using built in php zip libs are slow		@set_time_limit(ini_get('max_execution_time'));		// Return the name of the downloaded package		return basename($target);	}	/**	 * Unpacks a file and verifies it as a Joomla element package	 * Supports .gz .tar .tar.gz and .zip	 *	 * @param   string  $p_filename  The uploaded package filename or install directory	 *	 * @return  mixed  Array on success or boolean false on failure	 *	 * @since   3.1	 */	public static function unpack($p_filename)	{		// Path to the archive		$archivename = $p_filename;		// Temporary folder to extract the archive into		$tmpdir = uniqid('install_');		// Clean the paths to use for archive extraction		$extractdir = JPath::clean(dirname($p_filename) . '/' . $tmpdir);		$archivename = JPath::clean($archivename);		// Do the unpacking of the archive		try		{			JArchive::extract($archivename, $extractdir);		}		catch (Exception $e)		{			return false;		}		/*		 * Let's set the extraction directory and package file in the result array so we can		 * cleanup everything properly later on.		 */		$retval['extractdir'] = $extractdir;		$retval['packagefile'] = $archivename;		/*		 * Try to find the correct install directory.  In case the package is inside a		 * subdirectory detect this and set the install directory to the correct path.		 *		 * List all the items in the installation directory.  If there is only one, and		 * it is a folder, then we will set that folder to be the installation folder.		 */		$dirList = array_merge(JFolder::files($extractdir, ''), JFolder::folders($extractdir, ''));		if (count($dirList) == 1)		{			if (JFolder::exists($extractdir . '/' . $dirList[0]))			{				$extractdir = JPath::clean($extractdir . '/' . $dirList[0]);			}		}		/*		 * We have found the install directory so lets set it and then move on		 * to detecting the extension type.		 */		$retval['dir'] = $extractdir;		/*		 * Get the extension type and return the directory/type array on success or		 * false on fail.		 */		$retval['type'] = self::detectType($extractdir);		if ($retval['type'])		{			return $retval;		}		else		{			return false;		}	}	/**	 * Method to detect the extension type from a package directory	 *	 * @param   string  $p_dir  Path to package directory	 *	 * @return  mixed  Extension type string or boolean false on fail	 *	 * @since   3.1	 */	public static function detectType($p_dir)	{		// Search the install dir for an XML file		$files = JFolder::files($p_dir, '\.xml$', 1, true);		if (!count($files))		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_NOTFINDXMLSETUPFILE'), JLog::WARNING, 'jerror');			return false;		}		foreach ($files as $file)		{			$xml = simplexml_load_file($file);			if (!$xml)			{				continue;			}			if ($xml->getName() != 'extension')			{				unset($xml);				continue;			}			$type = (string) $xml->attributes()->type;			// Free up memory			unset($xml);			return $type;		}		JLog::add(JText::_('JLIB_INSTALLER_ERROR_NOTFINDJOOMLAXMLSETUPFILE'), JLog::WARNING, 'jerror');		// Free up memory.		unset($xml);		return false;	}	/**	 * Gets a file name out of a url	 *	 * @param   string  $url  URL to get name from	 *	 * @return  mixed   String filename or boolean false if failed	 *	 * @since   3.1	 */	public static function getFilenameFromURL($url)	{		if (is_string($url))		{			$parts = explode('/', $url);			return $parts[count($parts) - 1];		}		return false;	}	/**	 * Clean up temporary uploaded package and unpacked extension	 *	 * @param   string  $package    Path to the uploaded package file	 * @param   string  $resultdir  Path to the unpacked extension	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public static function cleanupInstall($package, $resultdir)	{		$config = JFactory::getConfig();		// Does the unpacked extension directory exist?		if (is_dir($resultdir))		{			JFolder::delete($resultdir);		}		// Is the package file a valid file?		if (is_file($package))		{			JFile::delete($package);		}		elseif (is_file(JPath::clean($config->get('tmp_path') . '/' . $package)))		{			// It might also be just a base filename			JFile::delete(JPath::clean($config->get('tmp_path') . '/' . $package));		}	}	/**	 * Splits contents of a sql file into array of discreet queries.	 * Queries need to be delimited with end of statement marker ';'	 *	 * @param   string  $query  The SQL statement.	 *	 * @return  array  Array of queries	 *	 * @since   3.1	 * @deprecated  13.3  Use JDatabaseDriver::splitSql() directly	 * @codeCoverageIgnore	 */	public static function splitSql($query)	{		JLog::add('JInstallerHelper::splitSql() is deprecated. Use JDatabaseDriver::splitSql() instead.', JLog::WARNING, 'deprecated');		$db = JFactory::getDbo();		return $db->splitSql($query);	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_languages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Languages Override Controller * * @package     Joomla.Administrator * @subpackage  com_languages * @since       2.5 */class LanguagesControllerOverride extends JControllerForm{	/**	 * Method to edit an existing override	 *	 * @param   	string	$key		The name of the primary key of the URL variable (not used here).	 * @param   	string	$urlVar	The name of the URL variable if different from the primary key (not used here).	 *	 * @return  void	 *	 * @since		2.5	 */	public function edit($key = null, $urlVar = null)	{		$app     = JFactory::getApplication();		$cid     = $this->input->post->get('cid', array(), 'array');		$context = "$this->option.edit.$this->context";		// Get the constant name		$recordId = (count($cid) ? $cid[0] : $this->input->get('id'));		// Access check		if (!$this->allowEdit())		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_EDIT_NOT_PERMITTED'));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_list.$this->getRedirectToListAppend(), false));			return;		}		$app->setUserState($context.'.data', null);		$this->setRedirect('index.php?option='.$this->option.'&view='.$this->view_item.$this->getRedirectToItemAppend($recordId, 'id'));	}	/**	 * Method to save an override	 *	 * @param   	string	$key		The name of the primary key of the URL variable (not used here).	 * @param   	string	$urlVar	The name of the URL variable if different from the primary key (not used here).	 *	 * @return  void	 *	 * @since		2.5	 */	public function save($key = null, $urlVar = null)	{		// Check for request forgeries		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$app     = JFactory::getApplication();		$model   = $this->getModel();		$data    = $this->input->post->get('jform', array(), 'array');		$context = "$this->option.edit.$this->context";		$task    = $this->getTask();		$recordId = $this->input->get('id');		$data['id'] = $recordId;		// Access check		if (!$this->allowSave($data, 'id'))		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_SAVE_NOT_PERMITTED'));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_list.$this->getRedirectToListAppend(), false));			return;		}		// Validate the posted data		$form = $model->getForm($data, false);		if (!$form)		{			$app->enqueueMessage($model->getError(), 'error');			return;		}		// Require helper for filter functions called by JForm		require_once JPATH_COMPONENT.'/helpers/languages.php';		// Test whether the data is valid.		$validData = $model->validate($form, $data);		// Check for validation errors.		if ($validData === false)		{			// Get the validation messages			$errors	= $model->getErrors();			// Push up to three validation messages out to the user.			for ($i = 0, $n = count($errors); $i < $n && $i < 3; $i++)			{				if ($errors[$i] instanceof Exception)				{					$app->enqueueMessage($errors[$i]->getMessage(), 'warning');				}				else				{					$app->enqueueMessage($errors[$i], 'warning');				}			}			// Save the data in the session			$app->setUserState($context.'.data', $data);			// Redirect back to the edit screen			$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_item.$this->getRedirectToItemAppend($recordId, 'id'), false));			return;		}		// Attempt to save the data		if (!$model->save($validData))		{			// Save the data in the session			$app->setUserState($context.'.data', $validData);			// Redirect back to the edit screen			$this->setError(JText::sprintf('JLIB_APPLICATION_ERROR_SAVE_FAILED', $model->getError()));			$this->setMessage($this->getError(), 'error');			$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_item.$this->getRedirectToItemAppend($recordId, 'id'), false));			return;		}		// Add message of success		$this->setMessage(JText::_('COM_LANGUAGES_VIEW_OVERRIDE_SAVE_SUCCESS'));		// Redirect the user and adjust session state based on the chosen task		switch ($task)		{			case 'apply':				// Set the record data in the session				$recordId = $model->getState($this->context.'.id');				$app->setUserState($context.'.data', null);				// Redirect back to the edit screen				$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_item.$this->getRedirectToItemAppend($validData['key'], 'id'), false));				break;			case 'save2new':				// Clear the record id and data from the session				$app->setUserState($context.'.data', null);				// Redirect back to the edit screen				$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_item.$this->getRedirectToItemAppend(null, 'id'), false));				break;			default:				// Clear the record id and data from the session				$app->setUserState($context.'.data', null);				// Redirect to the list screen				$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_list.$this->getRedirectToListAppend(), false));				break;		}	}	/**	 * Method to cancel an edit	 *	 * @param   	string	$key	The name of the primary key of the URL variable (not used here).	 *	 * @return  void	 *	 * @since		2.5	 */	public function cancel($key = null, $test = null)	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$app     = JFactory::getApplication();		$context = "$this->option.edit.$this->context";		$app->setUserState($context.'.data',	null);		$this->setRedirect(JRoute::_('index.php?option='.$this->option.'&view='.$this->view_list.$this->getRedirectToListAppend(), false));	}}
<?php/** * @package     Joomla.Site * @subpackage  Templates.beez3 * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Create shortcut$urls = json_decode($this->item->urls);// Create shortcuts to some parameters.$params = $this->item->params;if ($urls && (!empty($urls->urla) || !empty($urls->urlb) || !empty($urls->urlc))) :?><div class="content-links">	<ul class="nav nav-tabs nav-stacked">		<?php			$urlarray = array(			array($urls->urla, $urls->urlatext, $urls->targeta, 'a'),			array($urls->urlb, $urls->urlbtext, $urls->targetb, 'b'),			array($urls->urlc, $urls->urlctext, $urls->targetc, 'c')			);			foreach ($urlarray as $url) :				$link = $url[0];				$label = $url[1];				$target = $url[2];				$id = $url[3];				if ( ! $link) :					continue;				endif;				// If no label is present, take the link				$label = ($label) ? $label : $link;				// If no target is present, use the default				$target = $target ? $target : $params->get('target'.$id);				?>			<li class="content-links-<?php echo $id; ?>">				<?php					// Compute the correct link					switch ($target)					{						case 1:							// open in a new window							echo '<a href="'. htmlspecialchars($link) .'" target="_blank"  rel="nofollow">'.								htmlspecialchars($label) .'</a>';							break;						case 2:							// open in a popup window							$attribs = 'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=600,height=600';							echo "<a href=\"" . htmlspecialchars($link) . "\" onclick=\"window.open(this.href, 'targetWindow', '".$attribs."'); return false;\">".								htmlspecialchars($label).'</a>';							break;						case 3:							// open in a modal window							JHtml::_('behavior.modal', 'a.modal'); ?>							<a class="modal" href="<?php echo htmlspecialchars($link); ?>"  rel="{handler: 'iframe', size: {x:600, y:600}}">								<?php echo htmlspecialchars($label) . ' </a>';							break;						default:							// open in parent window							echo '<a href="'.  htmlspecialchars($link) . '" rel="nofollow">'.								htmlspecialchars($label) . ' </a>';							break;					}				?>				</li>		<?php endforeach; ?>	</ul></div><?php endif; ?>
<?php/** * @package     Joomla.Administrator * @subpackage  com_media * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;jimport('joomla.filesystem.file');jimport('joomla.filesystem.folder');/** * Folder Media Controller * * @package     Joomla.Administrator * @subpackage  com_media * @since       1.5 */class MediaControllerFolder extends JControllerLegacy{	/**	 * Deletes paths from the current path	 *	 * @return  boolean	 *	 * @since   1.5	 */	public function delete()	{		JSession::checkToken('request') or jexit(JText::_('JINVALID_TOKEN'));		$user	= JFactory::getUser();		// Get some data from the request		$tmpl   = $this->input->get('tmpl');		$paths  = $this->input->get('rm', array(), 'array');		$folder = $this->input->get('folder', '', 'path');		$redirect = 'index.php?option=com_media&folder=' . $folder;		if ($tmpl == 'component')		{			// We are inside the iframe			$redirect .= '&view=mediaList&tmpl=component';		}		$this->setRedirect($redirect);		// Just return if there's nothing to do		if (empty($paths))		{			return true;		}		if (!$user->authorise('core.delete', 'com_media'))		{			// User is not authorised to delete			JError::raiseWarning(403, JText::_('JLIB_APPLICATION_ERROR_DELETE_NOT_PERMITTED'));			return false;		}		// Set FTP credentials, if given		JClientHelper::setCredentialsFromRequest('ftp');		$ret = true;		JPluginHelper::importPlugin('content');		$dispatcher	= JEventDispatcher::getInstance();		if (count($paths))		{			foreach ($paths as $path)			{				if ($path !== JFile::makeSafe($path))				{					$dirname = htmlspecialchars($path, ENT_COMPAT, 'UTF-8');					JError::raiseWarning(100, JText::sprintf('COM_MEDIA_ERROR_UNABLE_TO_DELETE_FOLDER_WARNDIRNAME', substr($dirname, strlen(COM_MEDIA_BASE))));					continue;				}				$fullPath = JPath::clean(implode(DIRECTORY_SEPARATOR, array(COM_MEDIA_BASE, $folder, $path)));				$object_file = new JObject(array('filepath' => $fullPath));				if (is_file($object_file->filepath))				{					// Trigger the onContentBeforeDelete event.					$result = $dispatcher->trigger('onContentBeforeDelete', array('com_media.file', &$object_file));					if (in_array(false, $result, true))					{						// There are some errors in the plugins						JError::raiseWarning(100, JText::plural('COM_MEDIA_ERROR_BEFORE_DELETE', count($errors = $object_file->getErrors()), implode('<br />', $errors)));						continue;					}					$ret &= JFile::delete($object_file->filepath);					// Trigger the onContentAfterDelete event.					$dispatcher->trigger('onContentAfterDelete', array('com_media.file', &$object_file));					$this->setMessage(JText::sprintf('COM_MEDIA_DELETE_COMPLETE', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));				}				elseif (is_dir($object_file->filepath))				{					$contents = JFolder::files($object_file->filepath, '.', true, false, array('.svn', 'CVS', '.DS_Store', '__MACOSX', 'index.html'));					if (empty($contents))					{						// Trigger the onContentBeforeDelete event.						$result = $dispatcher->trigger('onContentBeforeDelete', array('com_media.folder', &$object_file));						if (in_array(false, $result, true))						{							// There are some errors in the plugins							JError::raiseWarning(100, JText::plural('COM_MEDIA_ERROR_BEFORE_DELETE', count($errors = $object_file->getErrors()), implode('<br />', $errors)));							continue;						}						$ret &= !JFolder::delete($object_file->filepath);						// Trigger the onContentAfterDelete event.						$dispatcher->trigger('onContentAfterDelete', array('com_media.folder', &$object_file));						$this->setMessage(JText::sprintf('COM_MEDIA_DELETE_COMPLETE', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));					}					else					{						//This makes no sense...						JError::raiseWarning(100, JText::sprintf('COM_MEDIA_ERROR_UNABLE_TO_DELETE_FOLDER_NOT_EMPTY', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));					}				}			}		}		return $ret;	}	/**	 * Create a folder	 *	 * @return  boolean	 *	 * @since   1.5	 */	public function create()	{		// Check for request forgeries		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		$user  = JFactory::getUser();		$folder      = $this->input->get('foldername', '');		$folderCheck = (string) $this->input->get('foldername', null, 'raw');		$parent      = $this->input->get('folderbase', '', 'path');		$this->setRedirect('index.php?option=com_media&folder=' . $parent . '&tmpl=' . $this->input->get('tmpl', 'index'));		if (strlen($folder) > 0)		{			if (!$user->authorise('core.create', 'com_media'))			{				// User is not authorised to delete				JError::raiseWarning(403, JText::_('JLIB_APPLICATION_ERROR_CREATE_NOT_PERMITTED'));				return false;			}			// Set FTP credentials, if given			JClientHelper::setCredentialsFromRequest('ftp');			$this->input->set('folder', $parent);			if (($folderCheck !== null) && ($folder !== $folderCheck))			{				$this->setMessage(JText::_('COM_MEDIA_ERROR_UNABLE_TO_CREATE_FOLDER_WARNDIRNAME'));				return false;			}			$path = JPath::clean(COM_MEDIA_BASE . '/' . $parent . '/' . $folder);			if (!is_dir($path) && !is_file($path))			{				// Trigger the onContentBeforeSave event.				$object_file = new JObject(array('filepath' => $path));				JPluginHelper::importPlugin('content');				$dispatcher	= JEventDispatcher::getInstance();				$result = $dispatcher->trigger('onContentBeforeSave', array('com_media.folder', &$object_file));				if (in_array(false, $result, true))				{					// There are some errors in the plugins					JError::raiseWarning(100, JText::plural('COM_MEDIA_ERROR_BEFORE_SAVE', count($errors = $object_file->getErrors()), implode('<br />', $errors)));					return false;				}				JFolder::create($object_file->filepath);				$data = "<html>\n<body bgcolor=\"#FFFFFF\">\n</body>\n</html>";				JFile::write($object_file->filepath . "/index.html", $data);				// Trigger the onContentAfterSave event.				$dispatcher->trigger('onContentAfterSave', array('com_media.folder', &$object_file, true));				$this->setMessage(JText::sprintf('COM_MEDIA_CREATE_COMPLETE', substr($object_file->filepath, strlen(COM_MEDIA_BASE))));			}			$this->input->set('folder', ($parent) ? $parent.'/'.$folder : $folder);		}		return true;	}}
<?php/** * @package     Joomla.Platform * @subpackage  Cache * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Joomla! Cache view type object * * @package     Joomla.Platform * @subpackage  Cache * @since       11.1 */class JCacheControllerView extends JCacheController{	/**	 * Get the cached view data	 *	 * @param   object   &$view       The view object to cache output for	 * @param   string   $method      The method name of the view method to cache output for	 * @param   string   $id          The cache data id	 * @param   boolean  $wrkarounds  True to enable workarounds.	 *	 * @return  boolean  True if the cache is hit (false else)	 *	 * @since   11.1	 */	public function get( $view, $method = 'display' , $id = false, $wrkarounds = true )	{		// If an id is not given generate it from the request		if ($id == false)		{			$id = $this->_makeId($view, $method);		}		$data = $this->cache->get($id);		$locktest = new stdClass;		$locktest->locked = null;		$locktest->locklooped = null;		if ($data === false)		{			$locktest = $this->cache->lock($id, null);			// If the loop is completed and returned true it means the lock has been set.			// If looped is true try to get the cached data again; it could exist now.			if ($locktest->locked == true && $locktest->locklooped == true)			{				$data = $this->cache->get($id);			}			// False means that locking is either turned off or maxtime has been exceeded.			// Execute the view.		}		if ($data !== false)		{			$data = unserialize(trim($data));			if ($wrkarounds === true)			{				echo JCache::getWorkarounds($data);			}			else			{				// No workarounds, so all data is stored in one piece				echo (isset($data)) ? $data : null;			}			if ($locktest->locked == true)			{				$this->cache->unlock($id);			}			return true;		}		/*		 * No hit so we have to execute the view		 */		if (method_exists($view, $method))		{			// If previous lock failed try again			if ($locktest->locked == false)			{				$locktest = $this->cache->lock($id);			}			// Capture and echo output			ob_start();			ob_implicit_flush(false);			$view->$method();			$data = ob_get_contents();			ob_end_clean();			echo $data;			/*			 * For a view we have a special case.  We need to cache not only the output from the view, but the state			 * of the document head after the view has been rendered.  This will allow us to properly cache any attached			 * scripts or stylesheets or links or any other modifications that the view has made to the document object			 */			$cached = array();			$cached = $wrkarounds == true ? JCache::setWorkarounds($data) : $data;			// Store the cache data			$this->cache->store(serialize($cached), $id);			if ($locktest->locked == true)			{				$this->cache->unlock($id);			}		}		return false;	}	/**	 * Generate a view cache id.	 *	 * @param   object  &$view   The view object to cache output for	 * @param   string  $method  The method name to cache for the view object	 *	 * @return  string  MD5 Hash : view cache id	 *	 * @since   11.1	 */	protected function _makeId(&$view, $method)	{		return md5(serialize(array(JCache::makeId(), get_class($view), $method)));	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Extended Utility class for the Users component. * * @package     Joomla.Administrator * @subpackage  com_users * @since       2.5 */class JHtmlUsers{	/**	 * Display an image.	 *	 * @param   string  $src  The source of the image	 *	 * @return  string  A <img> element if the specified file exists, otherwise, a null string	 *	 * @since   2.5	 */	public static function image($src)	{		$src = preg_replace('#[^A-Z0-9\-_\./]#i', '', $src);		$file = JPATH_SITE . '/' . $src;		jimport('joomla.filesystem.path');		JPath::check($file);		if (!file_exists($file))		{			return '';		}		return '<img src="' . JUri::root() . $src . '" alt="" />';	}	/**	 * Displays an icon to add a note for this user.	 *	 * @param   integer  $userId  The user ID	 *	 * @return  string  A link to add a note	 *	 * @since   2.5	 */	public static function addNote($userId)	{		$title = JText::_('COM_USERS_ADD_NOTE');		return '<a href="' . JRoute::_('index.php?option=com_users&task=note.add&u_id=' . (int) $userId) . '">'			. '<span class="label label-info"><i class="icon-vcard"></i>' . $title . '</span></a>';	}	/**	 * Displays an icon to filter the notes list on this user.	 *	 * @param   integer  $count   The number of notes for the user	 * @param   integer  $userId  The user ID	 *	 * @return  string  A link to apply a filter	 *	 * @since   2.5	 */	public static function filterNotes($count, $userId)	{		if (empty($count))		{			return '';		}		$title = JText::_('COM_USERS_FILTER_NOTES');		return '<a href="' . JRoute::_('index.php?option=com_users&view=notes&filter_search=uid:' . (int) $userId) . '">'			. JHtml::_('image', 'admin/filter_16.png', 'COM_USERS_NOTES', array('title' => $title), true) . '</a>';	}	/**	 * Displays a note icon.	 *	 * @param   integer  $count   The number of notes for the user	 * @param   integer  $userId  The user ID	 *	 * @return  string  A link to a modal window with the user notes	 *	 * @since   2.5	 */	public static function notes($count, $userId)	{		if (empty($count))		{			return '';		}		$title = JText::plural('COM_USERS_N_USER_NOTES', $count);		return '<a class="modal"'			. ' href="' . JRoute::_('index.php?option=com_users&view=notes&tmpl=component&layout=modal&u_id=' . (int) $userId) . '"'			. ' rel="{handler: \'iframe\', size: {x: 800, y: 450}}">'			. '<span class="label label-info"><i class="icon-drawer-2"></i>' . $title . '</span></a>';	}	/**	 * Build an array of block/unblock user states to be used by jgrid.state,	 * State options will be different for any user	 * and for currently logged in user	 *	 * @param   boolean  $self  True if state array is for currently logged in user	 *	 * @return  array  a list of possible states to display	 *	 * @since  3.0	 */	public static function blockStates( $self = false)	{		if ($self)		{			$states = array(				1 => array(					'task'				=> 'unblock',					'text'				=> '',					'active_title'		=> 'COM_USERS_USER_FIELD_BLOCK_DESC',					'inactive_title'	=> '',					'tip'				=> true,					'active_class'		=> 'unpublish',					'inactive_class'	=> 'unpublish'				),				0 => array(					'task'				=> 'block',					'text'				=> '',					'active_title'		=> '',					'inactive_title'	=> 'COM_USERS_USERS_ERROR_CANNOT_BLOCK_SELF',					'tip'				=> true,					'active_class'		=> 'publish',					'inactive_class'	=> 'publish'				)			);		}		else		{			$states = array(				1 => array(					'task'				=> 'unblock',					'text'				=> '',					'active_title'		=> 'COM_USERS_TOOLBAR_UNBLOCK',					'inactive_title'	=> '',					'tip'				=> true,					'active_class'		=> 'unpublish',					'inactive_class'	=> 'unpublish'				),				0 => array(					'task'				=> 'block',					'text'				=> '',					'active_title'		=> 'COM_USERS_USER_FIELD_BLOCK_DESC',					'inactive_title'	=> '',					'tip'				=> true,					'active_class'		=> 'publish',					'inactive_class'	=> 'publish'				)			);		}		return $states;	}	/**	 * Build an array of activate states to be used by jgrid.state,	 *	 * @return  array  a list of possible states to display	 *	 * @since  3.0	 */	public static function activateStates()	{		$states = array(			1	=> array(				'task'				=> 'activate',				'text'				=> '',				'active_title'		=> 'COM_USERS_TOOLBAR_ACTIVATE',				'inactive_title'	=> '',				'tip'				=> true,				'active_class'		=> 'unpublish',				'inactive_class'	=> 'unpublish'			),			0	=> array(				'task'				=> '',				'text'				=> '',				'active_title'		=> '',				'inactive_title'	=> 'COM_USERS_ACTIVATED',				'tip'				=> true,				'active_class'		=> 'publish',				'inactive_class'	=> 'publish'			)		);		return $states;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User group model. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersModelGroup extends JModelAdmin{	/**	 * @var		string	The event to trigger after saving the data.	 * @since   1.6	 */	protected $event_after_save = 'onUserAfterSaveGroup';	/**	 * @var		string	The event to trigger after before the data.	 * @since   1.6	 */	protected $event_before_save = 'onUserBeforeSaveGroup';	/**	 * Returns a reference to the a Table object, always creating it.	 *	 * @param   type	The table type to instantiate	 * @param   string	A prefix for the table class name. Optional.	 * @param   array  Configuration array for model. Optional.	 * @return  JTable	A database object	 * @since   1.6	*/	public function getTable($type = 'Usergroup', $prefix = 'JTable', $config = array())	{		$return = JTable::getInstance($type, $prefix, $config);		return $return;	}	/**	 * Method to get the record form.	 *	 * @param   array  $data		An optional array of data for the form to interogate.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		$app = JFactory::getApplication();		// Get the form.		$form = $this->loadForm('com_users.group', 'group', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_users.edit.group.data', array());		if (empty($data))		{			$data = $this->getItem();		}		$this->preprocessData('com_users.group', $data);		return $data;	}	/**	 * Override preprocessForm to load the user plugin group instead of content.	 *	 * @param   object	A form object.	 * @param   mixed	The data expected for the form.	 * @throws	Exception if there is an error in the form event.	 * @since   1.6	 */	protected function preprocessForm(JForm $form, $data, $groups = '')	{		$obj = is_array($data) ? JArrayHelper::toObject($data, 'JObject') : $data;		if (isset($obj->parent_id) && $obj->parent_id == 0 && $obj->id > 0)		{			$form->setFieldAttribute('parent_id', 'type', 'hidden');			$form->setFieldAttribute('parent_id', 'hidden', 'true');		}		parent::preprocessForm($form, $data, 'user');	}	/**	 * Method to save the form data.	 *	 * @param   array  The form data.	 * @return  boolean  True on success.	 * @since   1.6	 */	public function save($data)	{		// Include the content plugins for events.		JPluginHelper::importPlugin('user');		// Check the super admin permissions for group		// We get the parent group permissions and then check the group permissions manually		// We have to calculate the group permissions manually because we haven't saved the group yet		$parentSuperAdmin = JAccess::checkGroup($data['parent_id'], 'core.admin');		// Get core.admin rules from the root asset		$rules = JAccess::getAssetRules('root.1')->getData('core.admin');		// Get the value for the current group (will be true (allowed), false (denied), or null (inherit)		$groupSuperAdmin = $rules['core.admin']->allow($data['id']);		// We only need to change the $groupSuperAdmin if the parent is true or false. Otherwise, the value set in the rule takes effect.		if ($parentSuperAdmin === false)		{			// If parent is false (Denied), effective value will always be false			$groupSuperAdmin = false;		}		elseif ($parentSuperAdmin === true)		{			// If parent is true (allowed), group is true unless explicitly set to false			$groupSuperAdmin = ($groupSuperAdmin === false) ? false : true;		}		// Check for non-super admin trying to save with super admin group		$iAmSuperAdmin	= JFactory::getUser()->authorise('core.admin');		if ((!$iAmSuperAdmin) && ($groupSuperAdmin))		{			try			{				throw new Exception(JText::_('JLIB_USER_ERROR_NOT_SUPERADMIN'));			}			catch (Exception $e)			{				$this->setError($e->getMessage());				return false;			}		}		// Check for super-admin changing self to be non-super-admin		// First, are we a super admin>		if ($iAmSuperAdmin)		{			// Next, are we a member of the current group?			$myGroups = JAccess::getGroupsByUser(JFactory::getUser()->get('id'), false);			if (in_array($data['id'], $myGroups))			{				// Now, would we have super admin permissions without the current group?				$otherGroups = array_diff($myGroups, array($data['id']));				$otherSuperAdmin = false;				foreach ($otherGroups as $otherGroup)				{					$otherSuperAdmin = ($otherSuperAdmin) ? $otherSuperAdmin : JAccess::checkGroup($otherGroup, 'core.admin');				}				// If we would not otherwise have super admin permissions				// and the current group does not have super admin permissions, throw an exception				if ((!$otherSuperAdmin) && (!$groupSuperAdmin))				{					try					{						throw new Exception(JText::_('JLIB_USER_ERROR_CANNOT_DEMOTE_SELF'));					}					catch (Exception $e)					{						$this->setError($e->getMessage());						return false;					}				}			}		}		// Proceed with the save		return parent::save($data);	}	/**	 * Method to delete rows.	 *	 * @param   array  An array of item ids.	 * @return  boolean  Returns true on success, false on failure.	 * @since   1.6	 */	public function delete(&$pks)	{		// Typecast variable.		$pks = (array) $pks;		$user	= JFactory::getUser();		$groups = JAccess::getGroupsByUser($user->get('id'));		// Get a row instance.		$table = $this->getTable();		// Load plugins.		JPluginHelper::importPlugin('user');		$dispatcher = JEventDispatcher::getInstance();		// Check if I am a Super Admin		$iAmSuperAdmin	= $user->authorise('core.admin');		// do not allow to delete groups to which the current user belongs		foreach ($pks as $i => $pk)		{			if (in_array($pk, $groups))			{				JError::raiseWarning(403, JText::_('COM_USERS_DELETE_ERROR_INVALID_GROUP'));				return false;			}		}		// Iterate the items to delete each one.		foreach ($pks as $i => $pk)		{			if ($table->load($pk))			{				// Access checks.				$allow = $user->authorise('core.edit.state', 'com_users');				// Don't allow non-super-admin to delete a super admin				$allow = (!$iAmSuperAdmin && JAccess::checkGroup($pk, 'core.admin')) ? false : $allow;				if ($allow)				{					// Fire the onUserBeforeDeleteGroup event.					$dispatcher->trigger('onUserBeforeDeleteGroup', array($table->getProperties()));					if (!$table->delete($pk))					{						$this->setError($table->getError());						return false;					} else {						// Trigger the onUserAfterDeleteGroup event.						$dispatcher->trigger('onUserAfterDeleteGroup', array($table->getProperties(), true, $this->getError()));					}				} else {					// Prune items that you can't change.					unset($pks[$i]);					JError::raiseWarning(403, JText::_('JERROR_CORE_DELETE_NOT_PERMITTED'));				}			} else {				$this->setError($table->getError());				return false;			}		}		return true;	}}
<?php/** * @package     Joomla.Plugin * @subpackage  Editors-xtd.pagebreak * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Editor Pagebreak buton * * @package     Joomla.Plugin * @subpackage  Editors-xtd.pagebreak * @since       1.5 */class PlgButtonPagebreak extends JPlugin{	/**	 * Load the language file on instantiation.	 *	 * @var    boolean	 * @since  3.1	 */	protected $autoloadLanguage = true;	/**	 * Display the button	 *	 * @return array A two element array of (imageName, textToInsert)	 */	public function onDisplay($name)	{		JHtml::_('behavior.modal');		$link = 'index.php?option=com_content&amp;view=article&amp;layout=pagebreak&amp;tmpl=component&amp;e_name='.$name;		$button = new JObject;		$button->modal = true;		$button->link  = $link;		$button->text  = JText::_('PLG_EDITORSXTD_PAGEBREAK_BUTTON_PAGEBREAK');		$button->name  = 'copy';		$button->options = "{handler: 'iframe', size: {x: 500, y: 300}}";		return $button;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.multiselect');$user		= JFactory::getUser();$userId		= $user->get('id');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));$canOrder	= $user->authorise('core.edit.state', 'com_weblinks.category');$saveOrder	= $listOrder == 'a.ordering';?><form action="<?php echo JRoute::_('index.php?option=com_weblinks&view=weblinks'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_WEBLINKS_SEARCH_IN_TITLE'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_published">				<?php echo JText::_('JOPTION_SELECT_PUBLISHED'); ?>			</label>			<select name="filter_published" class="inputbox" id="filter_published">				<option value=""><?php echo JText::_('JOPTION_SELECT_PUBLISHED');?></option>				<?php echo JHtml::_('select.options', JHtml::_('jgrid.publishedOptions'), 'value', 'text', $this->state->get('filter.state'), true);?>			</select>			<label class="selectlabel" for="filter_category_id">				<?php echo JText::_('JOPTION_SELECT_CATEGORY'); ?>			</label>			<select name="filter_category_id" class="inputbox" id="filter_category_id">				<option value=""><?php echo JText::_('JOPTION_SELECT_CATEGORY');?></option>				<?php echo JHtml::_('select.options', JHtml::_('category.options', 'com_weblinks'), 'value', 'text', $this->state->get('filter.category_id'));?>			</select>            <label class="selectlabel" for="filter_access">				<?php echo JText::_('JOPTION_SELECT_ACCESS'); ?>			</label>			<select name="filter_access" class="inputbox" id="filter_access">				<option value=""><?php echo JText::_('JOPTION_SELECT_ACCESS');?></option>				<?php echo JHtml::_('select.options', JHtml::_('access.assetgroups'), 'value', 'text', $this->state->get('filter.access'));?>			</select>			<label class="selectlabel" for="filter_language">				<?php echo JText::_('JOPTION_SELECT_LANGUAGE'); ?>			</label>			<select name="filter_language" class="inputbox" id="filter_language">				<option value=""><?php echo JText::_('JOPTION_SELECT_LANGUAGE');?></option>				<?php echo JHtml::_('select.options', JHtml::_('contentlanguage.existing', true, true), 'value', 'text', $this->state->get('filter.language'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					<input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" />				</th>				<th class="title">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<th class="nowrap state-col">					<?php echo JHtml::_('grid.sort', 'JSTATUS', 'a.state', $listDirn, $listOrder); ?>				</th>				<th class="nowrap title category-col">					<?php echo JHtml::_('grid.sort', 'JCATEGORY', 'category_title', $listDirn, $listOrder); ?>				</th>				<th class="nowrap ordering-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ORDERING', 'a.ordering', $listDirn, $listOrder); ?>					<?php if ($canOrder && $saveOrder) :?>						<?php echo JHtml::_('grid.order', $this->items, 'filesave.png', 'weblinks.saveorder'); ?>					<?php endif; ?>				</th>				<th class="title access-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ACCESS', 'a.access', $listDirn, $listOrder); ?>				</th>				<th class="hits-col">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_HITS', 'a.hits', $listDirn, $listOrder); ?>				</th>				<th class="width-5">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_LANGUAGE', 'a.language', $listDirn, $listOrder); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>		<?php foreach ($this->items as $i => $item) :			$ordering   = ($listOrder == 'a.ordering');			$item->cat_link	= JRoute::_('index.php?option=com_categories&extension=com_weblinks&task=edit&type=other&cid[]=' . $item->catid);			$canCreate  = $user->authorise('core.create',     'com_weblinks.category.' . $item->catid);			$canEdit    = $user->authorise('core.edit',       'com_weblinks.category.' . $item->catid);			$canCheckin = $user->authorise('core.manage',     'com_checkin') || $item->checked_out == $user->get('id') || $item->checked_out == 0;			$canChange  = $user->authorise('core.edit.state', 'com_weblinks.category.' . $item->catid) && $canCheckin;			?>			<tr class="row<?php echo $i % 2; ?>">				<td>					<?php echo JHtml::_('grid.id', $i, $item->id); ?>				</td>				<td>					<?php if ($item->checked_out) : ?>						<?php echo JHtml::_('jgrid.checkedout', $i, $item->editor, $item->checked_out_time, 'weblinks.', $canCheckin); ?>					<?php endif; ?>					<?php if ($canEdit) : ?>						<a href="<?php echo JRoute::_('index.php?option=com_weblinks&task=weblink.edit&id='.(int) $item->id); ?>">							<?php echo $this->escape($item->title); ?></a>					<?php else : ?>							<?php echo $this->escape($item->title); ?>					<?php endif; ?>					<p class="smallsub">						<?php echo JText::sprintf('JGLOBAL_LIST_ALIAS', $this->escape($item->alias));?></p>				</td>				<td class="center">					<?php echo JHtml::_('jgrid.published', $item->state, $i, 'weblinks.', $canChange, 'cb', $item->publish_up, $item->publish_down); ?>				</td>				<td class="center">					<?php echo $this->escape($item->category_title); ?>				</td>				<td class="order">					<?php if ($canChange) : ?>						<?php if ($saveOrder) :?>							<?php if ($listDirn == 'asc') : ?>								<span><?php echo $this->pagination->orderUpIcon($i, ($item->catid == @$this->items[$i - 1]->catid), 'weblinks.orderup', 'JLIB_HTML_MOVE_UP', $ordering); ?></span>								<span><?php echo $this->pagination->orderDownIcon($i, $this->pagination->total, ($item->catid == @$this->items[$i + 1]->catid), 'weblinks.orderdown', 'JLIB_HTML_MOVE_DOWN', $ordering); ?></span>							<?php elseif ($listDirn == 'desc') : ?>								<span><?php echo $this->pagination->orderUpIcon($i, ($item->catid == @$this->items[$i - 1]->catid), 'weblinks.orderdown', 'JLIB_HTML_MOVE_UP', $ordering); ?></span>								<span><?php echo $this->pagination->orderDownIcon($i, $this->pagination->total, ($item->catid == @$this->items[$i + 1]->catid), 'weblinks.orderup', 'JLIB_HTML_MOVE_DOWN', $ordering); ?></span>							<?php endif; ?>						<?php endif; ?>						<?php $disabled = $saveOrder ?  '' : 'disabled="disabled"'; ?>						<input type="text" name="order[]" value="<?php echo $item->ordering;?>" <?php echo $disabled ?> class="text-area-order" title="<?php echo $item->title; ?> order" />					<?php else : ?>						<?php echo $item->ordering; ?>					<?php endif; ?>				</td>				<td class="center">					<?php echo $this->escape($item->access_level); ?>				</td>				<td class="center">					<?php echo $item->hits; ?>				</td>				<td class="center">					<?php if ($item->language == '*') : ?>						<?php echo JText::alt('JALL', 'language'); ?>					<?php else:?>						<?php echo $item->language_title ? $this->escape($item->language_title) : JText::_('JUNDEFINED'); ?>					<?php endif;?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table><?php echo $this->pagination->getListFooter(); ?>	<div class="clr"> </div>	<?php //Load the batch processing form. ?>	<?php echo $this->loadTemplate('batch'); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?></div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');JHtml::_('behavior.formvalidation');?><script type="text/javascript">	Joomla.submitbutton = function(task)	{		if (task == 'menu.cancel' || document.formvalidator.isValid(document.id('item-form')))		{			Joomla.submitform(task, document.getElementById('item-form'));		}	}</script><div class="menu-edit"><form action="<?php echo JRoute::_('index.php?option=com_menus&layout=edit&id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="item-form"><div class="col main-section">	<fieldset class="adminform">		<legend><?php echo JText::_('COM_MENUS_MENU_DETAILS');?></legend>			<ul class="adminformlist">				<li><?php echo $this->form->getLabel('title'); ?>				<?php echo $this->form->getInput('title'); ?></li>				<li><?php echo $this->form->getLabel('menutype'); ?>				<?php echo $this->form->getInput('menutype'); ?></li>				<li><?php echo $this->form->getLabel('description'); ?>				<?php echo $this->form->getInput('description'); ?></li>			</ul>	</fieldset>	<input type="hidden" name="task" value="" />	<?php echo JHtml::_('form.token'); ?>	</div></form><div class="clr"></div></div>
<?php/** * @package     Joomla.Administrator * @subpackage  com_newsfeeds * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Newsfeeds list controller class. * * @package     Joomla.Administrator * @subpackage  com_newsfeeds * @since       1.6 */class NewsfeedsControllerNewsfeeds extends JControllerAdmin{	/**	 * Proxy for getModel.	 */	public function getModel($name = 'Newsfeed', $prefix = 'NewsfeedsModel', $config = array('ignore_request' => true))	{		$model = parent::getModel($name, $prefix, $config);		return $model;	}	/**	 * Method to save the submitted ordering values for records via AJAX.	 *	 * @return  void	 *	 * @since   3.0	 */	public function saveOrderAjax()	{		// Get the input		$input = JFactory::getApplication()->input;		$pks = $input->post->get('cid', array(), 'array');		$order = $input->post->get('order', array(), 'array');		// Sanitize the input		JArrayHelper::toInteger($pks);		JArrayHelper::toInteger($order);		// Get the model		$model = $this->getModel();		// Save the ordering		$return = $model->saveorder($pks, $order);		if ($return)		{			echo "1";		}		// Close the application		JFactory::getApplication()->close();	}	protected function postDeleteHook(JModelLegacy $model, $ids = null)	{	}}
<?php/** * @package     Joomla.Libraries * @subpackage  CMS * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Route Helper * * A class providing basic routing for urls that are for content types found in * the #__content_types table and rows found in the #__ucm_content table. * * @package     Joomla.Libraries * @subpackage  CMS * @since       3.1 */class JHelperRoute{	/**	 * @var    array  Holds the reverse lookup	 * @since  3.1	 */	protected static $lookup;	/**	 * @var    string  Option for the extension (such as com_content)	 * @since  3.1	 */	protected  $extension;	/**	 * @var    string  Value of the primary key in the content type table	 * @since  3.1	 */	protected  $id;	/**	 * @var    string  Name of the view for the url	 * @since  3.1	 */	protected  $view;	/**	 * A method to get the route for a specific item	 *	 * @param   integer  $id         Value of the primary key for the item in its content table	 * @param   string   $typealias  The type_alias for the item being routed. Of the form extension.view.	 * @param   string   $link       The link to be routed	 * @param   string   $language   The language of the content for multilingual sites	 * @param   integer  $catid      Optional category id	 *	 * @return  string  The route of the item	 *	 * @since   3.1	 */	public function getRoute($id, $typealias, $link = '', $language = null, $catid = null)	{		$typeExploded = explode('.', $typealias);		$this->view = $typeExploded[1];		$this->extension = $typeExploded[0];		$name = ucfirst(substr_replace($this->extension, '', 0, 4));		if (isset($this->view))		{			$needles = array(				$this->view  => array((int) $id)			);		}		if (empty($link))		{			// Create the link			$link = 'index.php?option=' . $this->extension . '&view=' . $this->view . '&id=' . $id;		}		if ($catid > 1)		{			$categories = JCategories::getInstance($name);			if ($categories)			{				$category = $categories->get((int) $catid);				if ($category)				{					$needles['category'] = array_reverse($category->getPath());					$needles['categories'] = $needles['category'];					$link .= '&catid=' . $catid;				}			}		}		// Deal with languages only if needed		if (!empty($language) && $language != '*' && JLanguageMultilang::isEnabled())		{			$db		= JFactory::getDbo();			$query	= $db->getQuery(true)				->select('a.sef AS sef')				->select('a.lang_code AS lang_code')				->from('#__languages AS a');			$db->setQuery($query);			$langs = $db->loadObjectList();			foreach ($langs as $lang)			{				if ($language == $lang->lang_code)				{					$link .= '&lang=' . $lang->sef;					$needles['language'] = $language;				}			}		}			if ($item = self::findItem($needles))			{				$link .= '&Itemid=' . $item;			}			elseif ($item = self::findItem())			{				$link .= '&Itemid=' . $item;			}		return $link;	}	/**	 * Method to find the item in the menu structure	 *	 * @param   array  $needles  Array of lookup values	 *	 * @return  mixed	 *	 * @since   3.1	 */	protected function findItem($needles = array())	{		$app		= JFactory::getApplication();		$menus		= $app->getMenu('site');		$language	= isset($needles['language']) ? $needles['language'] : '*';		// Prepare the reverse lookup array.		if (!isset(self::$lookup[$language]))		{			self::$lookup[$language] = array();			$component = JComponentHelper::getComponent($this->extension);			$attributes = array('component_id');			$values = array($component->id);			if ($language != '*')			{				$attributes[] = 'language';				$values[] = array($needles['language'], '*');			}			$items = $menus->getItems($attributes, $values);			foreach ($items as $item)			{				if (isset($item->query) && isset($item->query['view']))				{					$view = $item->query['view'];					if (!isset(self::$lookup[$language][$view]))					{						self::$lookup[$language][$view] = array();					}					if (isset($item->query['id']))					{						if (is_array($item->query['id']))						{							$item->query['id'] = $item->query['id'][0];						}						/*						 * Here it will become a bit tricky						 * $language != * can override existing entries						 * $language == * cannot override existing entries						 */						if (!isset(self::$lookup[$language][$view][$item->query['id']]) || $item->language != '*')						{							self::$lookup[$language][$view][$item->query['id']] = $item->id;						}					}				}			}		}		if ($needles)		{			foreach ($needles as $view => $ids)			{				if (isset(self::$lookup[$language][$view]))				{					foreach ($ids as $id)					{						if (isset(self::$lookup[$language][$view][(int) $id]))						{							return self::$lookup[$language][$view][(int) $id];						}					}				}			}		}		$active = $menus->getActive();		if ($active && $active->component == $this->extension && ($active->language == '*' || !JLanguageMultilang::isEnabled()))		{			return $active->id;		}		// If not found, return language specific home link		$default = $menus->getDefault($language);		return !empty($default->id) ? $default->id : null;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User model. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersModelUser extends JModelAdmin{	/**	 * Returns a reference to the a Table object, always creating it.	 *	 * @param   string  $type    The table type to instantiate	 * @param   string  $prefix  A prefix for the table class name. Optional.	 * @param   array   $config  Configuration array for model. Optional.	 *	 * @return  JTable  A database object	 *	 * @since   1.6	*/	public function getTable($type = 'User', $prefix = 'JTable', $config = array())	{		$table = JTable::getInstance($type, $prefix, $config);		return $table;	}	/**	 * Method to get a single record.	 *	 * @param   integer  $pk  The id of the primary key.	 *	 * @return  mixed  Object on success, false on failure.	 *	 * @since   1.6	 */	public function getItem($pk = null)	{		$result = parent::getItem($pk);		$result->tags = new JHelperTags;		$result->tags->getTagIds($result->id, 'com_users.user');		// Get the dispatcher and load the users plugins.		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('user');		// Trigger the data preparation event.		$results = $dispatcher->trigger('onContentPrepareData', array('com_users.user', $result));		return $result;	}	/**	 * Method to get the record form.	 *	 * @param   array    $data      An optional array of data for the form to interogate.	 * @param   boolean  $loadData  True if the form is to load its own data (default case), false if not.	 *	 * @return  mixed  A JForm object on success, false on failure	 *	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		$app = JFactory::getApplication();		$plugin = JPluginHelper::getPlugin('user', 'joomla');		$pluginParams = new JRegistry($plugin->params);		// Get the form.		$form = $this->loadForm('com_users.user', 'user', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		// Passwords fields are required when mail to user is set to No in joomla user plugin		$userId = $form->getValue('id');		if ($userId === 0 && $pluginParams->get('mail_to_user') === "0")		{			$form->setFieldAttribute('password', 'required', 'true');			$form->setFieldAttribute('password2', 'required', 'true');		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 *	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_users.edit.user.data', array());		if (empty($data))		{			$data = $this->getItem();		}		JPluginHelper::importPlugin('user');		$this->preprocessData('com_users.profile', $data);		return $data;	}	/**	 * Override JModelAdmin::preprocessForm to ensure the correct plugin group is loaded.	 *	 * @param   JForm   $form   A JForm object.	 * @param   mixed   $data   The data expected for the form.	 * @param   string  $group  The name of the plugin group to import (defaults to "content").	 *	 * @return  void	 *	 * @since   1.6	 * @throws  Exception if there is an error in the form event.	 */	protected function preprocessForm(JForm $form, $data, $group = 'user')	{		parent::preprocessForm($form, $data, $group);	}	/**	 * Method to save the form data.	 *	 * @param   array  $data  The form data.	 *	 * @return  boolean  True on success.	 *	 * @since   1.6	 */	public function save($data)	{		$pk			= (!empty($data['id'])) ? $data['id'] : (int) $this->getState('user.id');		$user		= JUser::getInstance($pk);		$my = JFactory::getUser();		if ($data['block'] && $pk == $my->id && !$my->block)		{			$this->setError(JText::_('COM_USERS_USERS_ERROR_CANNOT_BLOCK_SELF'));			return false;		}		// Make sure that we are not removing ourself from Super Admin group		$iAmSuperAdmin = $my->authorise('core.admin');		if ($iAmSuperAdmin && $my->get('id') == $pk)		{			// Check that at least one of our new groups is Super Admin			$stillSuperAdmin = false;			$myNewGroups = $data['groups'];			foreach ($myNewGroups as $group)			{				$stillSuperAdmin = ($stillSuperAdmin) ? ($stillSuperAdmin) : JAccess::checkGroup($group, 'core.admin');			}			if (!$stillSuperAdmin)			{				$this->setError(JText::_('COM_USERS_USERS_ERROR_CANNOT_DEMOTE_SELF'));				return false;			}		}		// Bind the data.		if (!$user->bind($data))		{			$this->setError($user->getError());			return false;		}		// Store the data.		if (!$user->save())		{			$this->setError($user->getError());			return false;		}		$this->setState('user.id', $user->id);		return true;	}	/**	 * Method to delete rows.	 *	 * @param   array  &$pks  An array of item ids.	 *	 * @return  boolean  Returns true on success, false on failure.	 *	 * @since   1.6	 */	public function delete(&$pks)	{		$user	= JFactory::getUser();		$table	= $this->getTable();		$pks	= (array) $pks;		// Check if I am a Super Admin		$iAmSuperAdmin	= $user->authorise('core.admin');		// Trigger the onUserBeforeSave event.		JPluginHelper::importPlugin('user');		$dispatcher = JEventDispatcher::getInstance();		if (in_array($user->id, $pks))		{			$this->setError(JText::_('COM_USERS_USERS_ERROR_CANNOT_DELETE_SELF'));			return false;		}		// Iterate the items to delete each one.		foreach ($pks as $i => $pk)		{			if ($table->load($pk))			{				// Access checks.				$allow = $user->authorise('core.delete', 'com_users');				// Don't allow non-super-admin to delete a super admin				$allow = (!$iAmSuperAdmin && JAccess::check($pk, 'core.admin')) ? false : $allow;				if ($allow)				{					// Get users data for the users to delete.					$user_to_delete = JFactory::getUser($pk);					// Fire the onUserBeforeDelete event.					$dispatcher->trigger('onUserBeforeDelete', array($table->getProperties()));					if (!$table->delete($pk))					{						$this->setError($table->getError());						return false;					}					else					{						// Trigger the onUserAfterDelete event.						$dispatcher->trigger('onUserAfterDelete', array($user_to_delete->getProperties(), true, $this->getError()));					}				}				else				{					// Prune items that you can't change.					unset($pks[$i]);					JError::raiseWarning(403, JText::_('JERROR_CORE_DELETE_NOT_PERMITTED'));				}			}			else			{				$this->setError($table->getError());				return false;			}		}		return true;	}	/**	 * Method to block user records.	 *	 * @param   array    &$pks   The ids of the items to publish.	 * @param   integer  $value  The value of the published state	 *	 * @return  boolean  True on success.	 *	 * @since   1.6	 */	public function block(&$pks, $value = 1)	{		$app		= JFactory::getApplication();		$dispatcher	= JEventDispatcher::getInstance();		$user		= JFactory::getUser();		// Check if I am a Super Admin		$iAmSuperAdmin	= $user->authorise('core.admin');		$table		= $this->getTable();		$pks		= (array) $pks;		JPluginHelper::importPlugin('user');		// Access checks.		foreach ($pks as $i => $pk)		{			if ($value == 1 && $pk == $user->get('id'))			{				// Cannot block yourself.				unset($pks[$i]);				JError::raiseWarning(403, JText::_('COM_USERS_USERS_ERROR_CANNOT_BLOCK_SELF'));			}			elseif ($table->load($pk))			{				$old	= $table->getProperties();				$allow	= $user->authorise('core.edit.state', 'com_users');				// Don't allow non-super-admin to delete a super admin				$allow = (!$iAmSuperAdmin && JAccess::check($pk, 'core.admin')) ? false : $allow;				// Prepare the logout options.				$options = array(					'clientid' => 0				);				if ($allow)				{					// Skip changing of same state					if ($table->block == $value)					{						unset($pks[$i]);						continue;					}					$table->block = (int) $value;				// If unblocking, also change password reset count to zero to unblock reset					if ($table->block === 0)					{						$table->resetCount = 0;					}					// Allow an exception to be thrown.					try					{						if (!$table->check())						{							$this->setError($table->getError());							return false;						}						// Trigger the onUserBeforeSave event.						$result = $dispatcher->trigger('onUserBeforeSave', array($old, false, $table->getProperties()));						if (in_array(false, $result, true))						{							// Plugin will have to raise it's own error or throw an exception.							return false;						}						// Store the table.						if (!$table->store())						{							$this->setError($table->getError());							return false;						}						// Trigger the onAftereStoreUser event						$dispatcher->trigger('onUserAfterSave', array($table->getProperties(), false, true, null));					}					catch (Exception $e)					{						$this->setError($e->getMessage());						return false;					}					// Log the user out.					if ($value)					{						$app->logout($table->id, $options);					}				}				else				{					// Prune items that you can't change.					unset($pks[$i]);					JError::raiseWarning(403, JText::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'));				}			}		}		return true;	}	/**	 * Method to activate user records.	 *	 * @param   array  &$pks  The ids of the items to activate.	 *	 * @return  boolean  True on success.	 *	 * @since   1.6	 */	public function activate(&$pks)	{		$dispatcher	= JEventDispatcher::getInstance();		$user		= JFactory::getUser();		// Check if I am a Super Admin		$iAmSuperAdmin	= $user->authorise('core.admin');		$table		= $this->getTable();		$pks		= (array) $pks;		JPluginHelper::importPlugin('user');		// Access checks.		foreach ($pks as $i => $pk)		{			if ($table->load($pk))			{				$old	= $table->getProperties();				$allow	= $user->authorise('core.edit.state', 'com_users');				// Don't allow non-super-admin to delete a super admin				$allow = (!$iAmSuperAdmin && JAccess::check($pk, 'core.admin')) ? false : $allow;				if (empty($table->activation))				{					// Ignore activated accounts.					unset($pks[$i]);				}				elseif ($allow)				{					$table->block		= 0;					$table->activation	= '';					// Allow an exception to be thrown.					try					{						if (!$table->check())						{							$this->setError($table->getError());							return false;						}						// Trigger the onUserBeforeSave event.						$result = $dispatcher->trigger('onUserBeforeSave', array($old, false, $table->getProperties()));						if (in_array(false, $result, true))						{							// Plugin will have to raise it's own error or throw an exception.							return false;						}						// Store the table.						if (!$table->store())						{							$this->setError($table->getError());							return false;						}						// Fire the onAftereStoreUser event						$dispatcher->trigger('onUserAfterSave', array($table->getProperties(), false, true, null));					}					catch (Exception $e)					{						$this->setError($e->getMessage());						return false;					}				}				else				{					// Prune items that you can't change.					unset($pks[$i]);					JError::raiseWarning(403, JText::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'));				}			}		}		return true;	}	/**	 * Method to perform batch operations on an item or a set of items.	 *	 * @param   array  $commands  An array of commands to perform.	 * @param   array  $pks       An array of item ids.	 * @param   array  $contexts  An array of item contexts.	 *	 * @return  boolean  Returns true on success, false on failure.	 *	 * @since   2.5	 */	public function batch($commands, $pks, $contexts)	{		// Sanitize user ids.		$pks = array_unique($pks);		JArrayHelper::toInteger($pks);		// Remove any values of zero.		if (array_search(0, $pks, true))		{			unset($pks[array_search(0, $pks, true)]);		}		if (empty($pks))		{			$this->setError(JText::_('COM_USERS_USERS_NO_ITEM_SELECTED'));			return false;		}		$done = false;		if (!empty($commands['group_id']))		{			$cmd = JArrayHelper::getValue($commands, 'group_action', 'add');			if (!$this->batchUser((int) $commands['group_id'], $pks, $cmd))			{				return false;			}			$done = true;		}		if (!$done)		{			$this->setError(JText::_('JLIB_APPLICATION_ERROR_INSUFFICIENT_BATCH_INFORMATION'));			return false;		}		// Clear the cache		$this->cleanCache();		return true;	}	/**	 * Perform batch operations	 *	 * @param   integer  $group_id  The group ID which assignments are being edited	 * @param   array    $user_ids  An array of user IDs on which to operate	 * @param   string   $action    The action to perform	 *	 * @return  boolean  True on success, false on failure	 *	 * @since   1.6	 */	public function batchUser($group_id, $user_ids, $action)	{		// Get the DB object		$db = $this->getDbo();		JArrayHelper::toInteger($user_ids);		// Non-super admin cannot work with super-admin group		if ((!JFactory::getUser()->get('isRoot') && JAccess::checkGroup($group_id, 'core.admin')) || $group_id < 1)		{			$this->setError(JText::_('COM_USERS_ERROR_INVALID_GROUP'));			return false;		}		switch ($action)		{			// Sets users to a selected group			case 'set':				$doDelete	= 'all';				$doAssign	= true;				break;			// Remove users from a selected group			case 'del':				$doDelete	= 'group';				break;			// Add users to a selected group			case 'add':			default:				$doAssign	= true;				break;		}		// Remove the users from the group if requested.		if (isset($doDelete))		{			$query = $db->getQuery(true);			// Remove users from the group			$query->delete($db->quoteName('#__user_usergroup_map'))				->where($db->quoteName('user_id') . ' IN (' . implode(',', $user_ids) . ')');			// Only remove users from selected group			if ($doDelete == 'group')			{				$query->where($db->quoteName('group_id') . ' = ' . (int) $group_id);			}			$db->setQuery($query);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				$this->setError($e->getMessage());				return false;			}		}		// Assign the users to the group if requested.		if (isset($doAssign))		{			$query = $db->getQuery(true);			// First, we need to check if the user is already assigned to a group			$query->select($db->quoteName('user_id'))				->from($db->quoteName('#__user_usergroup_map'))				->where($db->quoteName('group_id') . ' = ' . (int) $group_id);			$db->setQuery($query);			$users = $db->loadColumn();			// Build the values clause for the assignment query.			$query->clear();			$groups = false;			foreach ($user_ids as $id)			{				if (!in_array($id, $users))				{					$query->values($id . ',' . $group_id);					$groups = true;				}			}			// If we have no users to process, throw an error to notify the user			if (!$groups)			{				$this->setError(JText::_('COM_USERS_ERROR_NO_ADDITIONS'));				return false;			}			$query->insert($db->quoteName('#__user_usergroup_map'))				->columns(array($db->quoteName('user_id'), $db->quoteName('group_id')));			$db->setQuery($query);			try			{				$db->execute();			}			catch (RuntimeException $e)			{				$this->setError($e->getMessage());				return false;			}		}		return true;	}	/**	 * Gets the available groups.	 *	 * @return  array  An array of groups	 *	 * @since   1.6	 */	public function getGroups()	{		$user = JFactory::getUser();		if ($user->authorise('core.edit', 'com_users') && $user->authorise('core.manage', 'com_users'))		{			$model = JModelLegacy::getInstance('Groups', 'UsersModel', array('ignore_request' => true));			return $model->getItems();		}		else		{			return null;		}	}	/**	 * Gets the groups this object is assigned to	 *	 * @param   integer  $userId  The user ID to retrieve the groups for	 *	 * @return  array  An array of assigned groups	 *	 * @since   1.6	 */	public function getAssignedGroups($userId = null)	{		$userId = (!empty($userId)) ? $userId : (int) $this->getState('user.id');		if (empty($userId))		{			$result = array();			$config = JComponentHelper::getParams('com_users');			if ($groupId = $config->get('new_usertype'))			{				$result[] = $groupId;			}		}		else		{			$result = JUserHelper::getUserGroups($userId);		}		return $result;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');// Load the tooltip behavior.JHtml::_('behavior.tooltip');$listOrder = $this->escape($this->state->get('list.ordering'));$listDirn  = $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_users&view=debuggroup&user_id='.(int) $this->state->get('filter.user_id'));?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>		<div id="filter-bar" class="btn-toolbar">			<div class="filter-search btn-group pull-left">				<input type="text" name="filter_search" id="filter_search" placeholder="<?php echo JText::_('COM_USERS_SEARCH_ASSETS'); ?>" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_USERS_SEARCH_ASSETS'); ?>" />			</div>			<div class="btn-group pull-left">				<button type="submit" class="btn tip" title="<?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?>"><i class="icon-search"></i></button>				<button type="button" class="btn tip" onclick="document.id('filter_search').value='';this.form.submit();" title="<?php echo JText::_('JSEARCH_RESET'); ?>"><i class="icon-remove"></i></button>			</div>		</div>		<div class="clearfix"> </div>		<table class="table table-striped">			<thead>				<tr>					<th class="left">						<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ASSET_TITLE', 'a.title', $listDirn, $listOrder); ?>					</th>					<th class="left">						<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_ASSET_NAME', 'a.name', $listDirn, $listOrder); ?>					</th>					<?php foreach ($this->actions as $key => $action) : ?>					<th width="5%" class="nowrap center">						<span class="hasTip" title="<?php echo htmlspecialchars(JText::_($key) . '::' . JText::_($action[1]), ENT_COMPAT, 'UTF-8'); ?>"><?php echo JText::_($key); ?></span>					</th>					<?php endforeach; ?>					<th width="5%" class="nowrap center">						<?php echo JHtml::_('grid.sort', 'COM_USERS_HEADING_LFT', 'a.lft', $listDirn, $listOrder); ?>					</th>					<th width="1%" class="nowrap center">						<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>					</th>				</tr>			</thead>			<tfoot>				<tr>					<td colspan="15">						<?php echo $this->pagination->getListFooter(); ?>					</td>				</tr>			</tfoot>			<tbody>				<tr class="row1">					<td colspan="15">						<div>							<?php echo JText::_('COM_USERS_DEBUG_LEGEND'); ?>							<span class="btn disabled btn-micro btn-warning"><i class="icon-white icon-ban-circle"></i></span> <?php echo JText::_('COM_USERS_DEBUG_IMPLICIT_DENY');?>							<span class="btn disabled btn-micro btn-success"><i class="icon-white icon-ok"></i></span> <?php echo JText::_('COM_USERS_DEBUG_EXPLICIT_ALLOW');?>							<span class="btn disabled btn-micro btn-danger"><i class="icon-white icon-remove"></i></span> <?php echo JText::_('COM_USERS_DEBUG_EXPLICIT_DENY');?>						</div>					</td>				</tr>				<?php foreach ($this->items as $i => $item) : ?>					<tr class="row0">						<td>							<?php echo $this->escape($item->title); ?>						</td>						<td class="nowrap">							<?php echo str_repeat('<span class="gi">|&mdash;</span>', $item->level) ?>							<?php echo $this->escape($item->name); ?>						</td>						<?php foreach ($this->actions as $action) : ?>							<?php							$name  = $action[0];							$check = $item->checks[$name];							if ($check === true) :								$class  = 'icon-ok';								$button = 'btn-success';							elseif ($check === false) :								$class  = 'icon-remove';								$button = 'btn-danger';							elseif ($check === null) :								$class  = 'icon-ban-circle';								$button = 'btn-warning';							else :								$class  = '';								$button = '';							endif;							?>						<td class="center">							<span class="btn disabled btn-micro <?php echo $button; ?>">								<i class="icon-white <?php echo $class; ?>"></i>							</span>						</td>						<?php endforeach; ?>						<td class="center">							<?php echo (int) $item->lft; ?>							- <?php echo (int) $item->rgt; ?>						</td>						<td class="center">							<?php echo (int) $item->id; ?>						</td>					</tr>				<?php endforeach; ?>			</tbody>		</table>		<input type="hidden" name="task" value="" />		<input type="hidden" name="boxchecked" value="0" />		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />		<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Administrator * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;/** * Finder language helper class. * * @package     Joomla.Administrator * @subpackage  com_finder * @since       2.5 */class FinderHelperLanguage{	/**	 * Method to return a plural language code for a taxonomy branch.	 *	 * @param   string  Branch title.	 *	 * @return  string  Language key code.	 */	public static function branchPlural($branchName)	{		$return = preg_replace('/[^a-zA-Z0-9]+/', '_', strtoupper($branchName));		return 'PLG_FINDER_QUERY_FILTER_BRANCH_P_'.$return;	}	/**	 * Method to return a singular language code for a taxonomy branch.	 *	 * @param   string  Branch name.	 *	 * @return  string  Language key code.	 */	public static function branchSingular($branchName)	{		$return = preg_replace('/[^a-zA-Z0-9]+/', '_', strtoupper($branchName));		return 'PLG_FINDER_QUERY_FILTER_BRANCH_S_'.$return;	}	/**	 * Method to load Smart Search component language file.	 *	 * @return  void	 *	 * @since   2.5	 */	public static function loadComponentLanguage()	{		$lang = JFactory::getLanguage();		$lang->load('com_finder', JPATH_SITE);	}	/**	 * Method to load Smart Search plug-in language files.	 *	 * @return  void	 *	 * @since   2.5	 */	public static function loadPluginLanguage()	{		static $loaded = false;		// If already loaded, don't load again.		if ($loaded)		{			return;		}		$loaded = true;		// Get array of all the enabled Smart Search plug-in names.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('name')			->from($db->quoteName('#__extensions'))			->where($db->quoteName('type') . ' = ' .  $db->quote('plugin'))			->where($db->quoteName('folder') . ' = ' .  $db->quote('finder'))			->where($db->quoteName('enabled') . ' = 1');		$db->setQuery($query);		$plugins = $db->loadObjectList();		if (empty($plugins))		{			return;		}		// Load generic language strings.		$lang = JFactory::getLanguage();		$lang->load('plg_content_finder', JPATH_ADMINISTRATOR);		// Load language file for each plug-in.		foreach ($plugins as $plugin)		{			$lang->load($plugin->name, JPATH_ADMINISTRATOR);		}	}}
<?php/** * @package     Joomla.Platform * @subpackage  Base * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Adapter Instance Class * * @package     Joomla.Platform * @subpackage  Base * @since       11.1 */class JAdapterInstance extends JObject{	/**	 * Parent	 *	 * @var    JInstaller	 * @since  11.1	 */	protected $parent = null;	/**	 * Database	 *	 * @var    JDatabaseDriver	 * @since  11.1	 */	protected $db = null;	/**	 * Constructor	 *	 * @param   JAdapter         $parent   Parent object	 * @param   JDatabaseDriver  $db       Database object	 * @param   array            $options  Configuration Options	 *	 * @since   11.1	 */	public function __construct($parent, $db, $options = array())	{		// Set the properties from the options array that is passed in		$this->setProperties($options);		// Set the parent and db in case $options for some reason overrides it.		$this->parent = $parent;		// Pull in the global dbo in case something happened to it.		$this->db = $db ? $db : JFactory::getDbo();	}	/**	 * Retrieves the parent object	 *	 * @return  object parent	 *	 * @since   11.1	 */	public function getParent()	{		return $this->parent;	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_users * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * User controller class. * * @package     Joomla.Administrator * @subpackage  com_users * @since       1.6 */class UsersControllerUser extends JControllerForm{	/**	 * @var    string  The prefix to use with controller messages.	 * @since  1.6	 */	protected $text_prefix = 'COM_USERS_USER';	/**	 * Overrides JControllerForm::allowEdit	 *	 * Checks that non-Super Admins are not editing Super Admins.	 *	 * @param   array   $data  An array of input data.	 * @param   string  $key   The name of the key for the primary key.	 *	 * @return  boolean  True if allowed, false otherwise.	 *	 * @since   1.6	 */	protected function allowEdit($data = array(), $key = 'id')	{		// Check if this person is a Super Admin		if (JAccess::check($data[$key], 'core.admin'))		{			// If I'm not a Super Admin, then disallow the edit.			if (!JFactory::getUser()->authorise('core.admin'))			{				return false;			}		}		return parent::allowEdit($data, $key);	}	/**	 * Method to run batch operations.	 *	 * @param   object  $model  The model.	 *	 * @return  boolean  True on success, false on failure	 *	 * @since   2.5	 */	public function batch($model = null)	{		JSession::checkToken() or jexit(JText::_('JINVALID_TOKEN'));		// Set the model		$model = $this->getModel('User', '', array());		// Preset the redirect		$this->setRedirect(JRoute::_('index.php?option=com_users&view=users' . $this->getRedirectToListAppend(), false));		return parent::batch($model);	}	/**	 * Overrides parent save method to check the submitted passwords match.	 *	 * @param   string  $key     The name of the primary key of the URL variable.	 * @param   string  $urlVar  The name of the URL variable if different from the primary key (sometimes required to avoid router collisions).	 *	 * @return  boolean  True if successful, false otherwise.	 *	 * @since   1.6	 */	public function save($key = null, $urlVar = null)	{		$data = $this->input->post->get('jform', array(), 'array');		// TODO: JForm should really have a validation handler for this.		if (isset($data['password']) && isset($data['password2']))		{			// Check the passwords match.			if ($data['password'] != $data['password2'])			{				$this->setMessage(JText::_('JLIB_USER_ERROR_PASSWORD_NOT_MATCH'), 'warning');				$this->setRedirect(JRoute::_('index.php?option=com_users&view=user&layout=edit', false));			}			unset($data['password2']);		}		return parent::save();	}	/**	 * Function that allows child controller access to model data after the data has been saved.	 *	 * @param   JModelLegacy  $model      The data model object.	 * @param   array         $validData  The validated data.	 *	 * @return  void	 *	 * @since   3.1	 */	protected function postSaveHook(JModelLegacy $model, $validData = array())	{		return;	}}
<?php/** * @package     Joomla.Site * @subpackage  Layout * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('JPATH_BASE') or die;?><div id="sidebar">	<div class="sidebar-nav">		<?php if ($displayData->displayMenu) : ?>		<ul id="submenu" class="nav nav-list">			<?php foreach ($displayData->list as $item) :			if (isset ($item[2]) && $item[2] == 1) : ?>				<li class="active">			<?php else : ?>				<li>			<?php endif;			if ($displayData->hide) : ?>				<a class="nolink"><?php echo $item[0]; ?>			<?php else :				if (strlen($item[1])) : ?>					<a href="<?php echo JFilterOutput::ampReplace($item[1]); ?>"><?php echo $item[0]; ?></a>				<?php else : ?>					<?php echo $item[0]; ?>				<?php endif;			endif; ?>			</li>			<?php endforeach; ?>		</ul>		<?php endif; ?>	</div></div>
<?php/** * @package     Joomla.Platform * @subpackage  Form * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Form Field class for the Joomla Platform. * Supports a one line text field. * * @package     Joomla.Platform * @subpackage  Form * @link        http://www.w3.org/TR/html-markup/input.text.html#input.text * @since       11.1 */class JFormFieldText extends JFormField{	/**	 * The form field type.	 *	 * @var    string	 *	 * @since  11.1	 */	protected $type = 'Text';	/**	 * Method to get the field input markup.	 *	 * @return  string  The field input markup.	 *	 * @since   11.1	 */	protected function getInput()	{		// Initialize some field attributes.		$size = $this->element['size'] ? ' size="' . (int) $this->element['size'] . '"' : '';		$maxLength = $this->element['maxlength'] ? ' maxlength="' . (int) $this->element['maxlength'] . '"' : '';		$class = $this->element['class'] ? ' class="' . (string) $this->element['class'] . '"' : '';		$readonly = ((string) $this->element['readonly'] == 'true') ? ' readonly="readonly"' : '';		$disabled = ((string) $this->element['disabled'] == 'true') ? ' disabled="disabled"' : '';		$required = $this->required ? ' required="required" aria-required="true"' : '';		// Initialize JavaScript field attributes.		$onchange = $this->element['onchange'] ? ' onchange="' . (string) $this->element['onchange'] . '"' : '';		return '<input type="text" name="' . $this->name . '" id="' . $this->id . '" value="'			. htmlspecialchars($this->value, ENT_COMPAT, 'UTF-8') . '"' . $class . $size . $disabled . $readonly . $onchange . $maxLength . $required . '/>';	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::_('behavior.multiselect');$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><div id="installer-discover">	<form action="<?php echo JRoute::_('index.php?option=com_installer&view=discover');?>" method="post" name="adminForm" id="adminForm">		<?php if (!empty( $this->sidebar)) : ?>    <div id="j-sidebar-container" class="span2">      <?php echo $this->sidebar; ?>    </div>      <div id="j-main-container" class="span10">  <?php else : ?>    <div id="j-main-container">  <?php endif;?>    	<?php if ($this->showMessage) : ?>  		<?php echo $this->loadTemplate('message'); ?>  	<?php endif; ?>    	<?php if ($this->ftp) : ?>  		<?php echo $this->loadTemplate('ftp'); ?>  	<?php endif; ?>    	<!-- Begin Content -->  		<?php if (count($this->items)) : ?>  		<table class="table table-striped">  			<thead>  				<tr>  					<th width="20"><input type="checkbox" name="checkall-toggle" value="" title="<?php echo JText::_('JGLOBAL_CHECK_ALL'); ?>" onclick="Joomla.checkAll(this)" /></th>  					<th class="nowrap"><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_NAME', 'name', $listDirn, $listOrder); ?></th>  					<th class="center"><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_TYPE', 'type', $listDirn, $listOrder); ?></th>  					<th width="10%" class="center"><?php echo JText::_('JVERSION'); ?></th>  					<th width="10%" class="center"><?php echo JText::_('JDATE'); ?></th>  					<th><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_FOLDER', 'folder', $listDirn, $listOrder); ?></th>  					<th><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_CLIENT', 'client_id', $listDirn, $listOrder); ?></th>  					<th width="15%" class="center"><?php echo JText::_('JAUTHOR'); ?></th>  					<th width="10"><?php echo JHtml::_('grid.sort', 'COM_INSTALLER_HEADING_ID', 'extension_id', $listDirn, $listOrder); ?></th>  				</tr>  			</thead>  			<tfoot><tr><td colspan="10"><?php echo $this->pagination->getListFooter(); ?></td></tr>  			</tfoot>  			<tbody>  			<?php foreach ($this->items as $i => $item) : ?>  				<tr class="row<?php echo $i % 2;?>">  					<td><?php echo JHtml::_('grid.id', $i, $item->extension_id); ?></td>  					<td><span class="bold hasTip" title="<?php echo htmlspecialchars($item->name.'::'.$item->description); ?>"><?php echo $item->name; ?></span></td>  					<td class="center"><?php echo JText::_('COM_INSTALLER_TYPE_' . $item->type); ?></td>  					<td class="center"><?php echo @$item->version != '' ? $item->version : '&#160;'; ?></td>  					<td class="center"><?php echo @$item->creationDate != '' ? $item->creationDate : '&#160;'; ?></td>  					<td class="center"><?php echo @$item->folder != '' ? $item->folder : JText::_('COM_INSTALLER_TYPE_NONAPPLICABLE'); ?></td>  					<td class="center"><?php echo $item->client; ?></td>  					<td class="center">  						<span class="editlinktip hasTip" title="<?php echo addslashes(htmlspecialchars(JText::_('COM_INSTALLER_AUTHOR_INFORMATION').'::'.$item->author_info)); ?>">  							<?php echo @$item->author != '' ? $item->author : '&#160;'; ?>  						</span>  					</td>  					<td><?php echo $item->extension_id ?></td>  				</tr>  			<?php endforeach; ?>  			</tbody>  		</table>  		<?php echo JText::_('COM_INSTALLER_MSG_DISCOVER_DESCRIPTION'); ?>  		<?php else : ?>  			<p>  				<?php echo JText::_('COM_INSTALLER_MSG_DISCOVER_DESCRIPTION'); ?>  			</p>  			<div class="alert">  				<?php echo JText::_('COM_INSTALLER_MSG_DISCOVER_NOEXTENSION'); ?>  			</div>  		<?php endif; ?>    		<input type="hidden" name="task" value="" />  		<input type="hidden" name="boxchecked" value="0" />  		<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />  		<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />  		<?php echo JHtml::_('form.token'); ?>		</div>	</form></div>
<?php/** * @package     Joomla.Administrator * @subpackage  Template.hathor * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;// Include the component HTML helpers.JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('script', 'system/multiselect.js', false, true);$user		= JFactory::getUser();$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));?><form action="<?php echo JRoute::_('index.php?option=com_templates&view=styles'); ?>" method="post" name="adminForm" id="adminForm"><?php if (!empty( $this->sidebar)) : ?>	<div id="j-sidebar-container" class="span2">		<?php echo $this->sidebar; ?>	</div>	<div id="j-main-container" class="span10"><?php else : ?>	<div id="j-main-container"><?php endif;?>	<fieldset id="filter-bar">	<legend class="element-invisible"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></legend>		<div class="filter-search">			<label class="filter-search-lbl" for="filter_search"><?php echo JText::_('JSEARCH_FILTER_LABEL'); ?></label>			<input type="text" name="filter_search" id="filter_search" value="<?php echo $this->escape($this->state->get('filter.search')); ?>" title="<?php echo JText::_('COM_TEMPLATES_STYLES_FILTER_SEARCH_DESC'); ?>" />			<button type="submit"><?php echo JText::_('JSEARCH_FILTER_SUBMIT'); ?></button>			<button type="button" onclick="document.id('filter_search').value='';this.form.submit();"><?php echo JText::_('JSEARCH_FILTER_CLEAR'); ?></button>		</div>		<div class="filter-select">			<label class="selectlabel" for="filter_template"><?php echo JText::_('COM_TEMPLATES_FILTER_TEMPLATE'); ?></label>			<select name="filter_template" class="inputbox" id="filter_template">				<option value="0"><?php echo JText::_('COM_TEMPLATES_FILTER_TEMPLATE'); ?></option>				<?php echo JHtml::_('select.options', TemplatesHelper::getTemplateOptions($this->state->get('filter.client_id')), 'value', 'text', $this->state->get('filter.template'));?>			</select>			<label class="selectlabel" for="filter_client_id"><?php echo JText::_('JGLOBAL_FILTER_CLIENT'); ?></label>			<select name="filter_client_id" class="inputbox" id="filter_client_id">				<option value="*"><?php echo JText::_('JGLOBAL_FILTER_CLIENT'); ?></option>				<?php echo JHtml::_('select.options', TemplatesHelper::getClientOptions(), 'value', 'text', $this->state->get('filter.client_id'));?>			</select>			<button type="submit" id="filter-go">				<?php echo JText::_('JSUBMIT'); ?></button>		</div>	</fieldset>	<div class="clr"> </div>	<table class="adminlist">		<thead>			<tr>				<th class="checkmark-col">					&#160;				</th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_TEMPLATES_HEADING_STYLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<th class="width-10">					<?php echo JHtml::_('grid.sort', 'JCLIENT', 'a.client_id', $listDirn, $listOrder); ?>				</th>				<th>					<?php echo JHtml::_('grid.sort', 'COM_TEMPLATES_HEADING_TEMPLATE', 'a.template', $listDirn, $listOrder); ?>				</th>				<th class="width-5">					<?php echo JHtml::_('grid.sort', 'COM_TEMPLATES_HEADING_DEFAULT', 'a.home', $listDirn, $listOrder); ?>				</th>				<th class="width-5">					<?php echo JText::_('COM_TEMPLATES_HEADING_ASSIGNED'); ?>				</th>				<th class="nowrap id-col">					<?php echo JHtml::_('grid.sort', 'JGRID_HEADING_ID', 'a.id', $listDirn, $listOrder); ?>				</th>			</tr>		</thead>		<tbody>			<?php foreach ($this->items as $i => $item) :				$canCreate = $user->authorise('core.create',     'com_templates');				$canEdit   = $user->authorise('core.edit',       'com_templates');				$canChange = $user->authorise('core.edit.state', 'com_templates');			?>			<tr class="row<?php echo $i % 2; ?>">				<td class="center">					<?php echo JHtml::_('grid.id', $i, $item->id); ?>				</td>				<td>					<?php if ($this->preview && $item->client_id == '0') : ?>						<a target="_blank"href="<?php echo JURI::root().'index.php?tp=1&templateStyle='.(int) $item->id ?>"  class="jgrid hasTip" title="<?php echo  htmlspecialchars(JText::_('COM_TEMPLATES_TEMPLATE_PREVIEW')); ?>::<?php echo htmlspecialchars($item->title);?>" ><span class="state icon-16-preview"><span class="text"><?php echo JText::_('COM_TEMPLATES_TEMPLATE_PREVIEW'); ?></span></span></a>					<?php elseif ($item->client_id == '1') : ?>						<span class="jgrid hasTip" title="<?php echo  htmlspecialchars(JText::_('COM_TEMPLATES_TEMPLATE_NO_PREVIEW_ADMIN')); ?>" ><span class="state icon-16-nopreview"><span class="text"><?php echo JText::_('COM_TEMPLATES_TEMPLATE_NO_PREVIEW_ADMIN'); ?></span></span></span>					<?php else: ?>						<span class="jgrid hasTip" title="<?php echo  htmlspecialchars(JText::_('COM_TEMPLATES_TEMPLATE_NO_PREVIEW')); ?>" ><span class="state icon-16-nopreview"><span class="text"><?php echo JText::_('COM_TEMPLATES_TEMPLATE_NO_PREVIEW'); ?></span></span></span>					<?php endif; ?>					<?php if ($canEdit) : ?>					<a href="<?php echo JRoute::_('index.php?option=com_templates&task=style.edit&id='.(int) $item->id); ?>">						<?php echo $this->escape($item->title);?></a>					<?php else : ?>						<?php echo $this->escape($item->title);?>					<?php endif; ?>				</td>				<td class="center">					<?php echo $item->client_id == 0 ? JText::_('JSITE') : JText::_('JADMINISTRATOR'); ?>				</td>				<td>					<label for="cb<?php echo $i;?>">						<?php echo $this->escape($item->template);?>					</label>				</td>				<td class="center">					<?php if ($item->home == '0' || $item->home == '1'):?>						<?php echo JHtml::_('jgrid.isdefault', $item->home != '0', $i, 'styles.', $canChange && $item->home != '1');?>					<?php elseif ($canChange):?>						<a href="<?php echo JRoute::_('index.php?option=com_templates&task=styles.unsetDefault&cid[]='.$item->id.'&'.JSession::getFormToken().'=1');?>">							<?php echo JHtml::_('image', 'mod_languages/' . $item->image . '.gif', $item->language_title, array('title' => JText::sprintf('COM_TEMPLATES_GRID_UNSET_LANGUAGE', $item->language_title)), true);?>						</a>					<?php else:?>						<?php echo JHtml::_('image', 'mod_languages/' . $item->image . '.gif', $item->language_title, array('title' => $item->language_title), true);?>					<?php endif;?>				</td>				<td class="center">					<?php if ($item->assigned > 0) : ?>						<?php echo JHtml::_('image', 'admin/tick.png', JText::plural('COM_TEMPLATES_ASSIGNED', $item->assigned), array('title' => JText::plural('COM_TEMPLATES_ASSIGNED', $item->assigned)), true); ?>					<?php else : ?>						&#160;					<?php endif; ?>				</td>				<td class="center">					<?php echo (int) $item->id; ?>				</td>			</tr>			<?php endforeach; ?>		</tbody>	</table>	<?php echo $this->pagination->getListFooter(); ?>	<input type="hidden" name="task" value="" />	<input type="hidden" name="boxchecked" value="0" />	<input type="hidden" name="filter_order" value="<?php echo $listOrder; ?>" />	<input type="hidden" name="filter_order_Dir" value="<?php echo $listDirn; ?>" />	<?php echo JHtml::_('form.token'); ?>	</div></form>
<?php/** * @package     Joomla.Site * @subpackage  com_tags * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers');JHtml::_('behavior.tooltip');JHtml::_('behavior.framework');// Get the user object.$user = JFactory::getUser();// Check if user is allowed to add/edit based on tags permissions.$canEdit = $user->authorise('core.edit', 'com_tags');$canCreate = $user->authorise('core.create', 'com_tags');$canEditState = $user->authorise('core.edit.state', 'com_tags');$columns = $this->params->get('tag_columns', 1);// Avoid division by 0 and negative columns.if ($columns < 1){	$columns = 1;}$bsspans = floor(12 / $columns);if ($bsspans < 1){	$bsspans = 1;}$bscolumns = min($columns, floor(12 / $bsspans));$n = count($this->items);?><form action="<?php echo htmlspecialchars(JUri::getInstance()->toString()); ?>" method="post" name="adminForm" id="adminForm">	<?php if ($this->params->get('filter_field') != 'hide' || $this->params->get('show_pagination_limit')) : ?>	<fieldset class="filters btn-toolbar">		<?php if ($this->params->get('filter_field') !== '0') : ?>			<div class="btn-group">				<label class="filter-search-lbl element-invisible" for="filter-search">					<?php echo JText::_('COM_TAGS_TITLE_FILTER_LABEL') . '&#160;'; ?>				</label>				<input type="text" name="filter-search" id="filter-search" value="<?php echo $this->escape($this->state->get('list.filter')); ?>" class="inputbox" onchange="document.adminForm.submit();" title="<?php echo JText::_('COM_TAGS_FILTER_SEARCH_DESC'); ?>" placeholder="<?php echo JText::_('COM_TAGS_TITLE_FILTER_LABEL'); ?>" />			</div>		<?php endif; ?>		<?php if ($this->params->get('show_pagination_limit')) : ?>			<div class="btn-group pull-right">				<label for="limit" class="element-invisible">					<?php echo JText::_('JGLOBAL_DISPLAY_NUM'); ?>				</label>				<?php echo $this->pagination->getLimitBox(); ?>			</div>		<?php endif; ?>		<input type="hidden" name="filter_order" value="" />		<input type="hidden" name="filter_order_Dir" value="" />		<input type="hidden" name="limitstart" value="" />		<input type="hidden" name="task" value="" />		<div class="clearfix"></div>	</fieldset>	<?php endif; ?><?php if ($this->items == false || $n == 0) : ?>	<p><?php echo JText::_('COM_TAGS_NO_TAGS'); ?></p><?php else : ?>	<?php foreach ($this->items as $i => $item) : ?>		<?php if ($n == 1 || $i == 0 || $bscolumns == 1 || $i % $bscolumns == 0) : ?>			<ul class="thumbnails">		<?php endif; ?>		<?php if ((!empty($item->access)) && in_array($item->access, $this->user->getAuthorisedViewLevels())) : ?> 			<li class="cat-list-row<?php echo $i % 2; ?>" >				<h3>					<a href="<?php echo JRoute::_(TagsHelperRoute::getTagRoute($item->id . ':' . $item->alias)); ?>">						<?php echo $this->escape($item->title); ?>					</a>				</h3>		<?php endif; ?>		<?php if ($this->params->get('all_tags_show_tag_image') && !empty($item->images)) : ?>			<?php $images  = json_decode($item->images); ?>			<span class="tag-body">			<?php if (!empty($images->image_intro)): ?>				<?php $imgfloat = (empty($images->float_intro)) ? $this->params->get('float_intro') : $images->float_intro; ?>				<div class="pull-<?php echo htmlspecialchars($imgfloat); ?> item-image">					<img				<?php if ($images->image_intro_caption) : ?>					<?php echo 'class="caption"' . ' title="' . htmlspecialchars($images->image_intro_caption) . '"'; ?>				<?php endif; ?>				src="<?php echo $images->image_intro; ?>" alt="<?php echo htmlspecialchars($images->image_fulltext_alt); ?>"/>				</div>			<?php endif; ?>			</span>		<?php endif; ?>		<div class="caption">			<?php if ($this->params->get('all_tags_show_tag_description', 1)) : ?>				<span class="tag-body">					<?php echo JHtml::_('string.truncate', $item->description, $this->params->get('tag_list_item_maximum_characters')); ?>				</span>			<?php endif; ?>			<?php if ($this->params->get('all_tags_show_tag_hits')) : ?>				<span class="list-hits badge badge-info">					<?php echo JText::sprintf('JGLOBAL_HITS_COUNT', $item->hits); ?>				</span>			<?php endif; ?>		</div>	</li>		<?php if (($i == 0 && $n == 1) || $i == $n - 1 || $bscolumns == 1 || (($i + 1) % $bscolumns == 0)) : ?>			</ul>		<?php endif; ?>	<?php endforeach; ?><?php endif;?><?php // Add pagination links ?><?php if (!empty($this->items)) : ?>	<?php if (($this->params->def('show_pagination', 2) == 1  || ($this->params->get('show_pagination') == 2)) && ($this->pagination->pagesTotal > 1)) : ?>	<div class="pagination">		<?php if ($this->params->def('show_pagination_results', 1)) : ?>			<p class="counter pull-right">				<?php echo $this->pagination->getPagesCounter(); ?>			</p>		<?php endif; ?>		<?php echo $this->pagination->getPagesLinks(); ?>	</div>	<?php endif; ?></form><?php endif; ?>
<?php/** * @package     Joomla.Administrator * @subpackage  com_menus * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;jimport('joomla.filesystem.folder');/** * Menu Item Types Model for Menus. * * @package     Joomla.Administrator * @subpackage  com_menus * @since       1.6 */class MenusModelMenutypes extends JModelLegacy{	/**	 * A reverse lookup of the base link URL to Title	 *	 * @var	array	 */	protected $rlu = array();	/**	 * Method to get the reverse lookup of the base link URL to Title	 *	 * @return  array  Array of reverse lookup of the base link URL to Title	 * @since   1.6	 */	public function getReverseLookup()	{		if (empty($this->rlu))		{			$this->getTypeOptions();		}		return $this->rlu;	}	/**	 * Method to get the available menu item type options.	 *	 * @return  array  Array of groups with menu item types.	 * @since   1.6	 */	public function getTypeOptions()	{		jimport('joomla.filesystem.file');		$lang = JFactory::getLanguage();		$list = array();		// Get the list of components.		$db = JFactory::getDbo();		$query = $db->getQuery(true)			->select('name, element AS ' . $db->quoteName('option'))			->from('#__extensions')			->where('type = ' . $db->quote('component'))			->where('enabled = 1')			->order('name ASC');		$db->setQuery($query);		$components = $db->loadObjectList();		foreach ($components as $component)		{			if ($options = $this->getTypeOptionsByComponent($component->option))			{				$list[$component->name] = $options;				// Create the reverse lookup for link-to-name.				foreach ($options as $option)				{					if (isset($option->request))					{						$this->rlu[MenusHelper::getLinkKey($option->request)] = $option->get('title');						if (isset($option->request['option']))						{								$lang->load($option->request['option'].'.sys', JPATH_ADMINISTRATOR, null, false, false)							||	$lang->load($option->request['option'].'.sys', JPATH_ADMINISTRATOR.'/components/'.$option->request['option'], null, false, false)							||	$lang->load($option->request['option'].'.sys', JPATH_ADMINISTRATOR, $lang->getDefault(), false, false)							||	$lang->load($option->request['option'].'.sys', JPATH_ADMINISTRATOR.'/components/'.$option->request['option'], $lang->getDefault(), false, false);						}					}				}			}		}		return $list;	}	protected function getTypeOptionsByComponent($component)	{		$options = array();		$mainXML = JPATH_SITE.'/components/'.$component.'/metadata.xml';		if (is_file($mainXML))		{			$options = $this->getTypeOptionsFromXML($mainXML, $component);		}		if (empty($options))		{			$options = $this->getTypeOptionsFromMVC($component);		}		return $options;	}	protected function getTypeOptionsFromXML($file, $component)	{		$options = array();		// Attempt to load the xml file.		if (!$xml = simplexml_load_file($file))		{			return false;		}		// Look for the first menu node off of the root node.		if (!$menu = $xml->xpath('menu[1]'))		{			return false;		}		else		{			$menu = $menu[0];		}		// If we have no options to parse, just add the base component to the list of options.		if (!empty($menu['options']) && $menu['options'] == 'none')		{			// Create the menu option for the component.			$o = new JObject;			$o->title		= (string) $menu['name'];			$o->description	= (string) $menu['msg'];			$o->request		= array('option' => $component);			$options[] = $o;			return $options;		}		// Look for the first options node off of the menu node.		if (!$optionsNode = $menu->xpath('options[1]'))		{			return false;		}		else		{			$optionsNode = $optionsNode[0];		}		// Make sure the options node has children.		if (!$children = $optionsNode->children())		{			return false;		}		else		{			// Process each child as an option.			foreach ($children as $child)			{				if ($child->getName() == 'option')				{					// Create the menu option for the component.					$o = new JObject;					$o->title		= (string) $child['name'];					$o->description	= (string) $child['msg'];					$o->request		= array('option' => $component, (string) $optionsNode['var'] => (string) $child['value']);					$options[] = $o;				}				elseif ($child->getName() == 'default')				{					// Create the menu option for the component.					$o = new JObject;					$o->title		= (string) $child['name'];					$o->description	= (string) $child['msg'];					$o->request		= array('option' => $component);					$options[] = $o;				}			}		}		return $options;	}	protected function getTypeOptionsFromMVC($component)	{		$options = array();		// Get the views for this component.		$path = JPATH_SITE . '/components/' . $component . '/views';		if (is_dir($path))		{			$views = JFolder::folders($path);		}		else		{			return false;		}		foreach ($views as $view)		{			// Ignore private views.			if (strpos($view, '_') !== 0)			{				// Determine if a metadata file exists for the view.				$file = $path.'/'.$view.'/metadata.xml';				if (is_file($file))				{					// Attempt to load the xml file.					if ($xml = simplexml_load_file($file))					{						// Look for the first view node off of the root node.						if ($menu = $xml->xpath('view[1]'))						{							$menu = $menu[0];							// If the view is hidden from the menu, discard it and move on to the next view.							if (!empty($menu['hidden']) && $menu['hidden'] == 'true')							{								unset($xml);								continue;							}							// Do we have an options node or should we process layouts?							// Look for the first options node off of the menu node.							if ($optionsNode = $menu->xpath('options[1]'))							{								$optionsNode = $optionsNode[0];								// Make sure the options node has children.								if ($children = $optionsNode->children())								{									// Process each child as an option.									foreach ($children as $child)									{										if ($child->getName() == 'option')										{											// Create the menu option for the component.											$o = new JObject;											$o->title		= (string) $child['name'];											$o->description	= (string) $child['msg'];											$o->request		= array('option' => $component, 'view' => $view, (string) $optionsNode['var'] => (string) $child['value']);											$options[] = $o;										}										elseif ($child->getName() == 'default')										{											// Create the menu option for the component.											$o = new JObject;											$o->title		= (string) $child['name'];											$o->description	= (string) $child['msg'];											$o->request		= array('option' => $component, 'view' => $view);											$options[] = $o;										}									}								}							}							else {								$options = array_merge($options, (array) $this->getTypeOptionsFromLayouts($component, $view));							}						}						unset($xml);					}				}				else {					$options = array_merge($options, (array) $this->getTypeOptionsFromLayouts($component, $view));				}			}		}		return $options;	}	protected function getTypeOptionsFromLayouts($component, $view)	{		$options = array();		$layouts = array();		$layoutNames = array();		$templateLayouts = array();		$lang = JFactory::getLanguage();		// Get the layouts from the view folder.		$path = JPATH_SITE . '/components/' . $component . '/views/' . $view . '/tmpl';		if (is_dir($path))		{			$layouts = array_merge($layouts, JFolder::files($path, '.xml$', false, true));		}		else		{			return $options;		}		// build list of standard layout names		foreach ($layouts as $layout)		{			// Ignore private layouts.			if (strpos(basename($layout), '_') === false)			{				$file = $layout;				// Get the layout name.				$layoutNames[] = basename($layout, '.xml');			}		}		// get the template layouts		// TODO: This should only search one template -- the current template for this item (default of specified)		$folders = JFolder::folders(JPATH_SITE . '/templates', '', false, true);		// Array to hold association between template file names and templates		$templateName = array();		foreach ($folders as $folder)		{			if (is_dir($folder . '/html/' . $component . '/' . $view))			{				$template = basename($folder);				$lang->load('tpl_'.$template.'.sys', JPATH_SITE, null, false, false)				||	$lang->load('tpl_'.$template.'.sys', JPATH_SITE.'/templates/'.$template, null, false, false)				||	$lang->load('tpl_'.$template.'.sys', JPATH_SITE, $lang->getDefault(), false, false)				||	$lang->load('tpl_'.$template.'.sys', JPATH_SITE.'/templates/'.$template, $lang->getDefault(), false, false);				$templateLayouts = JFolder::files($folder . '/html/' . $component . '/' . $view, '.xml$', false, true);				foreach ($templateLayouts as $layout)				{					$file = $layout;					// Get the layout name.					$templateLayoutName = basename($layout, '.xml');					// add to the list only if it is not a standard layout					if (array_search($templateLayoutName, $layoutNames) === false)					{						$layouts[] = $layout;						// Set template name array so we can get the right template for the layout						$templateName[$layout] = basename($folder);					}				}			}		}		// Process the found layouts.		foreach ($layouts as $layout)		{			// Ignore private layouts.			if (strpos(basename($layout), '_') === false)			{				$file = $layout;				// Get the layout name.				$layout = basename($layout, '.xml');				// Create the menu option for the layout.				$o = new JObject;				$o->title		= ucfirst($layout);				$o->description	= '';				$o->request		= array('option' => $component, 'view' => $view);				// Only add the layout request argument if not the default layout.				if ($layout != 'default')				{					// If the template is set, add in format template:layout so we save the template name					$o->request['layout'] = (isset($templateName[$file])) ? $templateName[$file] . ':' . $layout : $layout;				}				// Load layout metadata if it exists.				if (is_file($file))				{					// Attempt to load the xml file.					if ($xml = simplexml_load_file($file))					{						// Look for the first view node off of the root node.						if ($menu = $xml->xpath('layout[1]'))						{							$menu = $menu[0];							// If the view is hidden from the menu, discard it and move on to the next view.							if (!empty($menu['hidden']) && $menu['hidden'] == 'true')							{								unset($xml);								unset($o);								continue;							}							// Populate the title and description if they exist.							if (!empty($menu['title']))							{								$o->title = trim((string) $menu['title']);							}							if (!empty($menu->message[0]))							{								$o->description = trim((string) $menu->message[0]);							}						}					}				}				// Add the layout to the options array.				$options[] = $o;			}		}		return $options;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$class = ' class="first"';JHtml::_('bootstrap.tooltip');$item = $displayData->item;$items = $displayData->get('items');$params = $displayData->params;$extension = $displayData->get('extension');$className = substr($extension, 4);// This will work for the core components but not necessarily for other components// that may have different pluralisation rules.if (substr($className, -1) == 's'){	$className = rtrim($className, 's');}
<?php/** * @package     Joomla.Site * @subpackage  com_finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('_JEXEC') or die;// Get the mime type class.$mime = !empty($this->result->mime) ? 'mime-' . $this->result->mime : null;// Get the base url.$base = JURI::getInstance()->toString(array('scheme', 'host', 'port'));// Get the route with highlighting information.if (!empty($this->query->highlight) && empty($this->result->mime) && $this->params->get('highlight_terms', 1) && JPluginHelper::isEnabled('system', 'highlight')){	$route = $this->result->route . '&highlight=' . base64_encode(json_encode($this->query->highlight));} else {	$route = $this->result->route;}?><li>	<h4 class="result-title <?php echo $mime; ?>"><a href="<?php echo JRoute::_($route); ?>"><?php echo $this->result->title; ?></a></h4>	<?php if ($this->params->get('show_description', 1)) : ?>	<p class="result-text<?php echo $this->pageclass_sfx; ?>">		<?php echo JHtml::_('string.truncate', $this->result->description, $this->params->get('description_length', 255)); ?>	</p>	<?php endif; ?>	<?php if ($this->params->get('show_url', 1)) : ?>	<small class="small result-url<?php echo $this->pageclass_sfx; ?>"><?php echo $base . JRoute::_($this->result->route); ?></small>	<?php endif; ?></li>
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;JHtml::addIncludePath(JPATH_COMPONENT.'/helpers/html');JHtml::_('behavior.tooltip');JHtml::_('behavior.framework');// Create some shortcuts.$params		= &$this->item->params;$n			= count($this->items);$listOrder	= $this->escape($this->state->get('list.ordering'));$listDirn	= $this->escape($this->state->get('list.direction'));// check for at least one editable article$isEditable = false;if (!empty($this->items)){	foreach ($this->items as $article)	{		if ($article->params->get('access-edit'))		{			$isEditable = true;			break;		}	}}?><?php if (empty($this->items)) : ?>	<?php if ($this->params->get('show_no_articles', 1)) : ?>	<p><?php echo JText::_('COM_CONTENT_NO_ARTICLES'); ?></p>	<?php endif; ?><?php else : ?><form action="<?php echo htmlspecialchars(JUri::getInstance()->toString()); ?>" method="post" name="adminForm" id="adminForm" class="form-inline">	<?php if ($this->params->get('show_headings') || $this->params->get('filter_field') != 'hide' || $this->params->get('show_pagination_limit')) :?>	<fieldset class="filters btn-toolbar">		<?php if ($this->params->get('filter_field') != 'hide') :?>			<div class="btn-group">				<label class="filter-search-lbl element-invisible" for="filter-search">					<?php echo JText::_('COM_CONTENT_'.$this->params->get('filter_field').'_FILTER_LABEL').'&#160;'; ?>				</label>				<input type="text" name="filter-search" id="filter-search" value="<?php echo $this->escape($this->state->get('list.filter')); ?>" class="inputbox" onchange="document.adminForm.submit();" title="<?php echo JText::_('COM_CONTENT_FILTER_SEARCH_DESC'); ?>" placeholder="<?php echo JText::_('COM_CONTENT_'.$this->params->get('filter_field').'_FILTER_LABEL'); ?>" />			</div>		<?php endif; ?>		<?php if ($this->params->get('show_pagination_limit')) : ?>			<div class="btn-group pull-right">				<label for="limit" class="element-invisible">					<?php echo JText::_('JGLOBAL_DISPLAY_NUM'); ?>				</label>				<?php echo $this->pagination->getLimitBox(); ?>			</div>		<?php endif; ?>		<input type="hidden" name="filter_order" value="" />		<input type="hidden" name="filter_order_Dir" value="" />		<input type="hidden" name="limitstart" value="" />		<input type="hidden" name="task" value="" />		<div class="clearfix"></div>	</fieldset>	<?php endif; ?>	<table class="category table table-striped table-bordered table-hover">		<?php if ($this->params->get('show_headings')) : ?>		<thead>			<tr>				<th id="categorylist_header_title">					<?php echo JHtml::_('grid.sort', 'JGLOBAL_TITLE', 'a.title', $listDirn, $listOrder); ?>				</th>				<?php if ($date = $this->params->get('list_show_date')) : ?>					<th id="categorylist_header_date">						<?php if ($date == "created") : ?>							<?php echo JHtml::_('grid.sort', 'COM_CONTENT_'.$date.'_DATE', 'a.created', $listDirn, $listOrder); ?>						<?php elseif ($date == "modified") : ?>							<?php echo JHtml::_('grid.sort', 'COM_CONTENT_'.$date.'_DATE', 'a.modified', $listDirn, $listOrder); ?>						<?php elseif ($date == "published") : ?>							<?php echo JHtml::_('grid.sort', 'COM_CONTENT_'.$date.'_DATE', 'a.publish_up', $listDirn, $listOrder); ?>						<?php endif; ?>					</th>				<?php endif; ?>				<?php if ($this->params->get('list_show_author')) : ?>					<th id="categorylist_header_author">						<?php echo JHtml::_('grid.sort', 'JAUTHOR', 'author', $listDirn, $listOrder); ?>					</th>				<?php endif; ?>				<?php if ($this->params->get('list_show_hits')) : ?>					<th id="categorylist_header_hits">						<?php echo JHtml::_('grid.sort', 'JGLOBAL_HITS', 'a.hits', $listDirn, $listOrder); ?>					</th>				<?php endif; ?>				<?php if ($isEditable) : ?>					<th id="categorylist_header_edit"><?php echo JText::_('COM_CONTENT_EDIT_ITEM'); ?></th>				<?php endif; ?>			</tr>		</thead>		<?php endif; ?>		<tbody>			<?php foreach ($this->items as $i => $article) : ?>				<?php if ($this->items[$i]->state == 0) : ?>				 <tr class="system-unpublished cat-list-row<?php echo $i % 2; ?>">				<?php else: ?>				<tr class="cat-list-row<?php echo $i % 2; ?>" >				<?php endif; ?>					<td headers="categorylist_header_title" class="list-title">						<?php if (in_array($article->access, $this->user->getAuthorisedViewLevels())) : ?>							<a href="<?php echo JRoute::_(ContentHelperRoute::getArticleRoute($article->slug, $article->catid)); ?>">								<?php echo $this->escape($article->title); ?>							</a>						<?php else: ?>							<?php							echo $this->escape($article->title).' : ';							$menu		= JFactory::getApplication()->getMenu();							$active		= $menu->getActive();							$itemId		= $active->id;							$link = JRoute::_('index.php?option=com_users&view=login&Itemid='.$itemId);							$returnURL = JRoute::_(ContentHelperRoute::getArticleRoute($article->slug));							$fullURL = new JURI($link);							$fullURL->setVar('return', base64_encode($returnURL));							?>							<a href="<?php echo $fullURL; ?>" class="register">								<?php echo JText::_('COM_CONTENT_REGISTER_TO_READ_MORE'); ?>							</a>						<?php endif; ?>						<?php if ($article->state == 0) : ?>							<span class="list-published label label-warning">								<?php echo JText::_('JUNPUBLISHED'); ?>							</span>						<?php endif; ?>					</td>					<?php if ($this->params->get('list_show_date')) : ?>						<td headers="categorylist_header_date" class="list-date small">							<?php							echo JHtml::_(								'date', $article->displayDate,								$this->escape($this->params->get('date_format', JText::_('DATE_FORMAT_LC3')))							); ?>						</td>					<?php endif; ?>					<?php if ($this->params->get('list_show_author', 1)) : ?>						<td headers="categorylist_header_author" class="list-author">							<?php if (!empty($article->author) || !empty($article->created_by_alias)) : ?>								<?php $author = $article->author ?>								<?php $author = ($article->created_by_alias ? $article->created_by_alias : $author);?>								<?php if (!empty($article->contactid ) &&  $this->params->get('link_author') == true):?>									<?php echo JHtml::_(											'link',											JRoute::_('index.php?option=com_contact&view=contact&id='.$article->contactid),											$author									); ?>								<?php else :?>									<?php echo JText::sprintf('COM_CONTENT_WRITTEN_BY', $author); ?>								<?php endif; ?>							<?php endif; ?>						</td>					<?php endif; ?>					<?php if ($this->params->get('list_show_hits', 1)) : ?>						<td headers="categorylist_header_hits" class="list-hits">							<span class="badge badge-info">								<?php echo JText::sprintf('JGLOBAL_HITS_COUNT', $article->hits); ?>							</span>						</td>					<?php endif; ?>					<?php if ($isEditable) : ?>						<td headers="categorylist_header_edit" class="list-edit">							<?php if ($article->params->get('access-edit')) : ?>								<?php echo JHtml::_('icon.edit', $article, $params); ?>							<?php endif; ?>						</td>					<?php endif; ?>				</tr>			<?php endforeach; ?>		</tbody>	</table><?php endif; ?><?php // Code to add a link to submit an article. ?><?php if ($this->category->getParams()->get('access-create')) : ?>	<?php echo JHtml::_('icon.create', $this->category, $this->category->params); ?><?php  endif; ?><?php // Add pagination links ?><?php if (!empty($this->items)) : ?>	<?php if (($this->params->def('show_pagination', 2) == 1  || ($this->params->get('show_pagination') == 2)) && ($this->pagination->pagesTotal > 1)) : ?>	<div class="pagination">		<?php if ($this->params->def('show_pagination_results', 1)) : ?>			<p class="counter pull-right">				<?php echo $this->pagination->getPagesCounter(); ?>			</p>		<?php endif; ?>		<?php echo $this->pagination->getPagesLinks(); ?>	</div>	<?php endif; ?></form><?php  endif; ?>
<?php/** * @package     Joomla.Libraries * @subpackage  Installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;jimport('joomla.base.adapterinstance');jimport('joomla.filesystem.folder');/** * Component installer * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 */class JInstallerAdapterComponent extends JAdapterInstance{	/**	 * Copy of the XML manifest file	 *	 * @var    string	 * @since  3.1	 */	protected $manifest = null;	/**	 * Name of the extension	 *	 * @var    string	 * @since  3.1	 * */	protected $name = null;	/**	 * The unique identifier for the extension (e.g. mod_login)	 *	 * @var    string	 * @since  3.1	 * */	protected $element = null;	/**	 * The list of current files fo the Joomla! CMS administrator that are installed and is read	 * from the manifest on disk in the update area to handle doing a diff	 * and deleting files that are in the old files list and not in the new	 * files list.	 *	 * @var    array	 * @since  3.1	 * */	protected $oldAdminFiles = null;	/**	 * The list of current files that are installed and is read	 * from the manifest on disk in the update area to handle doing a diff	 * and deleting files that are in the old files list and not in the new	 * files list.	 *	 * @var    array	 * @since  3.1	 * */	protected $oldFiles = null;	/**	 * A path to the PHP file that the scriptfile declaration in	 * the manifest refers to.	 *	 * @var    string	 * @since  3.1	 * */	protected $manifest_script = null;	/**	 * For legacy installations this is a path to the PHP file that the scriptfile declaration in the	 * manifest refers to.	 *	 * @var    string	 * @since  3.1	 * */	protected $install_script = null;	/**	 * Custom loadLanguage method	 *	 * @param   string  $path  The path language files are on.	 *	 * @return  void	 *	 * @since   3.1	 */	public function loadLanguage($path = null)	{		$source = $this->parent->getPath('source');		if (!$source)		{			$this->parent				->setPath(				'source',				($this->parent->extension->client_id ? JPATH_ADMINISTRATOR : JPATH_SITE) .				'/components/' . $this->parent->extension->element			);		}		$this->manifest = $this->parent->getManifest();		$name = strtolower(JFilterInput::getInstance()->clean((string) $this->manifest->name, 'cmd'));		if (substr($name, 0, 4) == 'com_')		{			$extension = $name;		}		else		{			$extension = 'com_' . $name;		}		$lang = JFactory::getLanguage();		$source = $path ? $path : ($this->parent->extension->client_id ? JPATH_ADMINISTRATOR : JPATH_SITE) . '/components/' . $extension;		if ($this->manifest->administration->files)		{			$element = $this->manifest->administration->files;		}		elseif ($this->manifest->files)		{			$element = $this->manifest->files;		}		else		{			$element = null;		}		if ($element)		{			$folder = (string) $element->attributes()->folder;			if ($folder && file_exists($path . '/' . $folder))			{				$source = $path . '/' . $folder;			}		}		$lang->load($extension . '.sys', $source, null, false, false) || $lang->load($extension . '.sys', JPATH_ADMINISTRATOR, null, false, false)			|| $lang->load($extension . '.sys', $source, $lang->getDefault(), false, false)			|| $lang->load($extension . '.sys', JPATH_ADMINISTRATOR, $lang->getDefault(), false, false);	}	/**	 * Custom install method for components	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function install()	{		// Get a database connector object		$db = $this->parent->getDbo();		// Get the extension manifest object		$this->manifest = $this->parent->getManifest();		/*		 * ---------------------------------------------------------------------------------------------		 * Manifest Document Setup Section		 * ---------------------------------------------------------------------------------------------		 */		// Set the extension's name		$name = strtolower(JFilterInput::getInstance()->clean((string) $this->manifest->name, 'cmd'));		if (substr($name, 0, 4) == 'com_')		{			$element = $name;		}		else		{			$element = 'com_' . $name;		}		$this->set('name', $name);		$this->set('element', $element);		// Get the component description		$this->parent->set('message', JText::_((string) $this->manifest->description));		// Set the installation target paths		$this->parent->setPath('extension_site', JPath::clean(JPATH_SITE . '/components/' . $this->get('element')));		$this->parent->setPath('extension_administrator', JPath::clean(JPATH_ADMINISTRATOR . '/components/' . $this->get('element')));		// Copy the admin path as it's used as a common base		$this->parent->setPath('extension_root', $this->parent->getPath('extension_administrator'));		/*		 * ---------------------------------------------------------------------------------------------		 * Basic Checks Section		 * ---------------------------------------------------------------------------------------------		 */		// Make sure that we have an admin element		if (!$this->manifest->administration)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_INSTALL_ADMIN_ELEMENT'), JLog::WARNING, 'jerror');			return false;		}		/*		 * ---------------------------------------------------------------------------------------------		 * Filesystem Processing Section		 * ---------------------------------------------------------------------------------------------		 */		/*		 * If the component site or admin directory already exists, then we will assume that the component is already		 * installed or another component is using that directory.		 */		if (file_exists($this->parent->getPath('extension_site')) || file_exists($this->parent->getPath('extension_administrator')))		{			// Look for an update function or update tag			$updateElement = $this->manifest->update;			// Upgrade manually set or update function available or update tag detected			if ($this->parent->isUpgrade() || ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'update'))				|| $updateElement)			{				// Transfer control to the update function				return $this->update();			}			elseif (!$this->parent->isOverwrite())			{				// Overwrite is set.				// We didn't have overwrite set, find an update function or find an update tag so lets call it safe				if (file_exists($this->parent->getPath('extension_site')))				{					// If the site exists say so.					JLog::add(						JText::sprintf('JLIB_INSTALLER_ERROR_COMP_INSTALL_DIR_SITE', $this->parent->getPath('extension_site')),						JLog::WARNING, 'jerror'					);				}				else				{					// If the admin exists say so					JLog::add(						JText::sprintf('JLIB_INSTALLER_ERROR_COMP_INSTALL_DIR_ADMIN', $this->parent->getPath('extension_administrator')),						JLog::WARNING, 'jerror'					);				}				return false;			}		}		/*		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, lets load it; we'll copy it later (don't have dest yet)		$manifestScript = (string) $this->manifest->scriptfile;		if ($manifestScript)		{			$manifestScriptFile = $this->parent->getPath('source') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// Set the class name			$classname = $this->get('element') . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		// Run preflight if possible (since we know we're not an update)		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'preflight'))		{			if ($this->parent->manifestClass->preflight('install', $this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Create msg object; first use here		$msg = ob_get_contents();		ob_end_clean();		// If the component directory does not exist, let's create it		$created = false;		if (!file_exists($this->parent->getPath('extension_site')))		{			if (!$created = JFolder::create($this->parent->getPath('extension_site')))			{				JLog::add(					JText::sprintf('JLIB_INSTALLER_ERROR_COMP_INSTALL_FAILED_TO_CREATE_DIRECTORY_SITE', $this->parent->getPath('extension_site')),					JLog::WARNING, 'jerror'				);				return false;			}		}		/*		 * Since we created the component directory and we will want to remove it if we have to roll back		 * the installation, let's add it to the installation step stack		 */		if ($created)		{			$this->parent->pushStep(array('type' => 'folder', 'path' => $this->parent->getPath('extension_site')));		}		// If the component admin directory does not exist, let's create it		$created = false;		if (!file_exists($this->parent->getPath('extension_administrator')))		{			if (!$created = JFolder::create($this->parent->getPath('extension_administrator')))			{				JLog::add(					JText::sprintf('JLIB_INSTALLER_ERROR_COMP_INSTALL_FAILED_TO_CREATE_DIRECTORY_ADMIN', $this->parent->getPath('extension_administrator')),					JLog::WARNING, 'jerror'				);				// Install failed, rollback any changes				$this->parent->abort();				return false;			}		}		/*		 * Since we created the component admin directory and we will want to remove it if we have to roll		 * back the installation, let's add it to the installation step stack		 */		if ($created)		{			$this->parent->pushStep(array('type' => 'folder', 'path' => $this->parent->getPath('extension_administrator')));		}		// Copy site files		if ($this->manifest->files)		{			if ($this->parent->parseFiles($this->manifest->files) === false)			{				// Install failed, rollback any changes				$this->parent->abort();				return false;			}		}		// Copy admin files		if ($this->manifest->administration->files)		{			if ($this->parent->parseFiles($this->manifest->administration->files, 1) === false)			{				// Install failed, rollback any changes				$this->parent->abort();				return false;			}		}		// Parse optional tags		$this->parent->parseMedia($this->manifest->media);		$this->parent->parseLanguages($this->manifest->languages);		$this->parent->parseLanguages($this->manifest->administration->languages, 1);		// If there is a manifest script, let's copy it.		if ($this->get('manifest_script'))		{			$path['src'] = $this->parent->getPath('source') . '/' . $this->get('manifest_script');			$path['dest'] = $this->parent->getPath('extension_administrator') . '/' . $this->get('manifest_script');			if (!file_exists($path['dest']) || $this->parent->isOverwrite())			{				if (!$this->parent->copyFiles(array($path)))				{					// Install failed, rollback changes					$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_MANIFEST'));					return false;				}			}		}		/*		 * ---------------------------------------------------------------------------------------------		 * Database Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// Run the install queries for the component		if (isset($this->manifest->install->sql))		{			$result = $this->parent->parseSQLFiles($this->manifest->install->sql);			if ($result === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_SQL_ERROR', $db->stderr(true)));				return false;			}		}		/**		 * ---------------------------------------------------------------------------------------------		 * Custom Installation Script Section		 * ---------------------------------------------------------------------------------------------		 */		/*		 * If we have an install script, let's include it, execute the custom		 * install method, and append the return value from the custom install		 * method to the installation message.		 */		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'install'))		{			if ($this->parent->manifestClass->install($this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		/**		 * ---------------------------------------------------------------------------------------------		 * Finalization and Cleanup Section		 * ---------------------------------------------------------------------------------------------		 */		// Add an entry to the extension table with a whole heap of defaults		$row = JTable::getInstance('extension');		$row->set('name', $this->get('name'));		$row->set('type', 'component');		$row->set('element', $this->get('element'));		// There is no folder for components		$row->set('folder', '');		$row->set('enabled', 1);		$row->set('protected', 0);		$row->set('access', 0);		$row->set('client_id', 1);		$row->set('params', $this->parent->getParams());		$row->set('manifest_cache', $this->parent->generateManifestCache());		if (!$row->store())		{			// Install failed, roll back changes			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_ROLLBACK', $db->stderr(true)));			return false;		}		$eid = $row->extension_id;		// Clobber any possible pending updates		$update = JTable::getInstance('update');		$uid = $update->find(array('element' => $this->get('element'), 'type' => 'component', 'client_id' => 1, 'folder' => ''));		if ($uid)		{			$update->delete($uid);		}		// We will copy the manifest file to its appropriate place.		if (!$this->parent->copyManifest())		{			// Install failed, rollback changes			$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_COPY_SETUP'));			return false;		}		// Time to build the admin menus		if (!$this->_buildAdminMenus($row->extension_id))		{			JLog::add(JText::_('JLIB_INSTALLER_ABORT_COMP_BUILDADMINMENUS_FAILED'), JLog::WARNING, 'jerror');			// @todo remove code: $this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_ROLLBACK', $db->stderr(true)));			// @todo remove code: return false;		}		// Set the schema version to be the latest update version		if ($this->manifest->update)		{			$this->parent->setSchemaVersion($this->manifest->update->schemas, $eid);		}		// Register the component container just under root in the assets table.		$asset = JTable::getInstance('Asset');		$asset->name = $row->element;		$asset->parent_id = 1;		$asset->rules = '{}';		$asset->title = $row->name;		$asset->setLocation(1, 'last-child');		if (!$asset->store())		{			// Install failed, roll back changes			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_ROLLBACK', $db->stderr(true)));			return false;		}		// And now we run the postflight		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'postflight'))		{			$this->parent->manifestClass->postflight('install', $this);		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		return $row->extension_id;	}	/**	 * Custom update method for components	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	public function update()	{		// Get a database connector object		$db = $this->parent->getDbo();		// Set the overwrite setting		$this->parent->setOverwrite(true);		// Get the extension manifest object		$this->manifest = $this->parent->getManifest();		/**		 * ---------------------------------------------------------------------------------------------		 * Manifest Document Setup Section		 * ---------------------------------------------------------------------------------------------		 */		// Set the extension's name		$name = strtolower(JFilterInput::getInstance()->clean((string) $this->manifest->name, 'cmd'));		if (substr($name, 0, 4) == 'com_')		{			$element = $name;		}		else		{			$element = 'com_' . $name;		}		$this->set('name', $name);		$this->set('element', $element);		// Get the component description		$description = (string) $this->manifest->description;		if ($description)		{			$this->parent->set('message', JText::_($description));		}		else		{			$this->parent->set('message', '');		}		// Set the installation target paths		$this->parent->setPath('extension_site', JPath::clean(JPATH_SITE . '/components/' . $this->get('element')));		$this->parent->setPath('extension_administrator', JPath::clean(JPATH_ADMINISTRATOR . '/components/' . $this->get('element')));		// Copy the admin path as it's used as a common base		$this->parent->setPath('extension_root', $this->parent->getPath('extension_administrator'));		// Hunt for the original XML file		$old_manifest = null;		// Create a new installer because findManifest sets stuff		// Look in the administrator first		$tmpInstaller = new JInstaller;		$tmpInstaller->setPath('source', $this->parent->getPath('extension_administrator'));		if (!$tmpInstaller->findManifest())		{			// Then the site			$tmpInstaller->setPath('source', $this->parent->getPath('extension_site'));			if ($tmpInstaller->findManifest())			{				$old_manifest = $tmpInstaller->getManifest();			}		}		else		{			$old_manifest = $tmpInstaller->getManifest();		}		// Should do this above perhaps?		if ($old_manifest)		{			$this->oldAdminFiles = $old_manifest->administration->files;			$this->oldFiles = $old_manifest->files;		}		else		{			$this->oldAdminFiles = null;			$this->oldFiles = null;		}		/**		 * ---------------------------------------------------------------------------------------------		 * Basic Checks Section		 * ---------------------------------------------------------------------------------------------		 */		// Make sure that we have an admin element		if (!$this->manifest->administration)		{			JLog::add(JText::_('JLIB_INSTALLER_ABORT_COMP_UPDATE_ADMIN_ELEMENT'), JLog::WARNING, 'jerror');			return false;		}		/**		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, lets load it; we'll copy it later (don't have dest yet)		$manifestScript = (string) $this->manifest->scriptfile;		if ($manifestScript)		{			$manifestScriptFile = $this->parent->getPath('source') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// Set the class name			$classname = $element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		// Run preflight if possible (since we know we're not an update)		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'preflight'))		{			if ($this->parent->manifestClass->preflight('update', $this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Create msg object; first use here		$msg = ob_get_contents();		ob_end_clean();		/**		 * ---------------------------------------------------------------------------------------------		 * Filesystem Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// If the component directory does not exist, let's create it		$created = false;		if (!file_exists($this->parent->getPath('extension_site')))		{			if (!$created = JFolder::create($this->parent->getPath('extension_site')))			{				JLog::add(					JText::sprintf('JLIB_INSTALLER_ERROR_COMP_UPDATE_FAILED_TO_CREATE_DIRECTORY_SITE', $this->parent->getPath('extension_site')),					JLog::WARNING, 'jerror'				);				return false;			}		}		/*		 * Since we created the component directory and will want to remove it if we have to roll back		 * the installation, lets add it to the installation step stack		 */		if ($created)		{			$this->parent->pushStep(array('type' => 'folder', 'path' => $this->parent->getPath('extension_site')));		}		// If the component admin directory does not exist, let's create it		$created = false;		if (!file_exists($this->parent->getPath('extension_administrator')))		{			if (!$created = JFolder::create($this->parent->getPath('extension_administrator')))			{				JLog::add(					JText::sprintf('JLIB_INSTALLER_ERROR_COMP_UPDATE_FAILED_TO_CREATE_DIRECTORY_ADMIN', $this->parent->getPath('extension_administrator')),					JLog::WARNING, 'jerror'				);				// Install failed, rollback any changes				$this->parent->abort();				return false;			}		}		/*		 * Since we created the component admin directory and we will want to remove it if we have to roll		 * back the installation, let's add it to the installation step stack		 */		if ($created)		{			$this->parent->pushStep(array('type' => 'folder', 'path' => $this->parent->getPath('extension_administrator')));		}		// Find files to copy		if ($this->manifest->files)		{			if ($this->parent->parseFiles($this->manifest->files, 0, $this->oldFiles) === false)			{				// Install failed, rollback any changes				$this->parent->abort();				return false;			}		}		if ($this->manifest->administration->files)		{			if ($this->parent->parseFiles($this->manifest->administration->files, 1, $this->oldAdminFiles) === false)			{				// Install failed, rollback any changes				$this->parent->abort();				return false;			}		}		// Parse optional tags		$this->parent->parseMedia($this->manifest->media);		$this->parent->parseLanguages($this->manifest->languages);		$this->parent->parseLanguages($this->manifest->administration->languages, 1);		// If there is a manifest script, let's copy it.		if ($this->get('manifest_script'))		{			$path['src'] = $this->parent->getPath('source') . '/' . $this->get('manifest_script');			$path['dest'] = $this->parent->getPath('extension_administrator') . '/' . $this->get('manifest_script');			if (!file_exists($path['dest']) || $this->parent->isOverwrite())			{				if (!$this->parent->copyFiles(array($path)))				{					// Install failed, rollback changes					$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_UPDATE_MANIFEST'));					return false;				}			}		}		/**		 * ---------------------------------------------------------------------------------------------		 * Database Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// Let's run the update queries for the component		$row = JTable::getInstance('extension');		$eid = $row->find(array('element' => strtolower($this->get('element')), 'type' => 'component'));		if ($this->manifest->update)		{			$result = $this->parent->parseSchemaUpdates($this->manifest->update->schemas, $eid);			if ($result === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_UPDATE_SQL_ERROR', $db->stderr(true)));				return false;			}		}		// Time to build the admin menus		if (!$this->_buildAdminMenus($eid))		{			JLog::add(JText::_('JLIB_INSTALLER_ABORT_COMP_BUILDADMINMENUS_FAILED'), JLog::WARNING, 'jerror');			// $this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_ROLLBACK', $db->stderr(true)));			// Return false;		}		/**		 * ---------------------------------------------------------------------------------------------		 * Custom Installation Script Section		 * ---------------------------------------------------------------------------------------------		 */		/*		 * If we have an install script, let's include it, execute the custom		 * update method, and append the return value from the custom update		 * method to the installation message.		 */		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'update'))		{			if ($this->parent->manifestClass->update($this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		/**		 * ---------------------------------------------------------------------------------------------		 * Finalization and Cleanup Section		 * ---------------------------------------------------------------------------------------------		 */		// Clobber any possible pending updates		$update = JTable::getInstance('update');		$uid = $update->find(array('element' => $this->get('element'), 'type' => 'component', 'client_id' => 1, 'folder' => ''));		if ($uid)		{			$update->delete($uid);		}		// Update an entry to the extension table		if ($eid)		{			$row->load($eid);		}		else		{			// Set the defaults			// There is no folder for components			$row->folder = '';			$row->enabled = 1;			$row->protected = 0;			$row->access = 1;			$row->client_id = 1;			$row->params = $this->parent->getParams();		}		$row->name = $this->get('name');		$row->type = 'component';		$row->element = $this->get('element');		$row->manifest_cache = $this->parent->generateManifestCache();		if (!$row->store())		{			// Install failed, roll back changes			$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_UPDATE_ROLLBACK', $db->stderr(true)));			return false;		}		// We will copy the manifest file to its appropriate place.		if (!$this->parent->copyManifest())		{			// Install failed, rollback changes			$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_UPDATE_COPY_SETUP'));			return false;		}		// And now we run the postflight		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'postflight'))		{			$this->parent->manifestClass->postflight('update', $this);		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		return $row->extension_id;	}	/**	 * Custom uninstall method for components	 *	 * @param   integer  $id  The unique extension id of the component to uninstall	 *	 * @return  mixed  Return value for uninstall method in component uninstall file	 *	 * @since   3.1	 */	public function uninstall($id)	{		$db = $this->parent->getDbo();		$row = null;		$retval = true;		// First order of business will be to load the component object table from the database.		// This should give us the necessary information to proceed.		$row = JTable::getInstance('extension');		if (!$row->load((int) $id))		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_ERRORUNKOWNEXTENSION'), JLog::WARNING, 'jerror');			return false;		}		// Is the component we are trying to uninstall a core one?		// Because that is not a good idea...		if ($row->protected)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_WARNCORECOMPONENT'), JLog::WARNING, 'jerror');			return false;		}		// Get the admin and site paths for the component		$this->parent->setPath('extension_administrator', JPath::clean(JPATH_ADMINISTRATOR . '/components/' . $row->element));		$this->parent->setPath('extension_site', JPath::clean(JPATH_SITE . '/components/' . $row->element));		// Copy the admin path as it's used as a common base		$this->parent->setPath('extension_root', $this->parent->getPath('extension_administrator'));		/**		 * ---------------------------------------------------------------------------------------------		 * Manifest Document Setup Section		 * ---------------------------------------------------------------------------------------------		 */		// Find and load the XML install file for the component		$this->parent->setPath('source', $this->parent->getPath('extension_administrator'));		// Get the package manifest object		// We do findManifest to avoid problem when uninstalling a list of extension: getManifest cache its manifest file		$this->parent->findManifest();		$this->manifest = $this->parent->getManifest();		if (!$this->manifest)		{			// Make sure we delete the folders if no manifest exists			JFolder::delete($this->parent->getPath('extension_administrator'));			JFolder::delete($this->parent->getPath('extension_site'));			// Remove the menu			$this->_removeAdminMenus($row);			// Raise a warning			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_ERRORREMOVEMANUALLY'), JLog::WARNING, 'jerror');			// Return			return false;		}		// Set the extensions name		$name = strtolower(JFilterInput::getInstance()->clean((string) $this->manifest->name, 'cmd'));		if (substr($name, 0, 4) == 'com_')		{			$element = $name;		}		else		{			$element = 'com_' . $name;		}		$this->set('name', $name);		$this->set('element', $element);		// Attempt to load the admin language file; might have uninstall strings		$this->loadLanguage(JPATH_ADMINISTRATOR . '/components/' . $element);		/**		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading and Uninstall		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, lets load it; we'll copy it later (don't have dest yet)		$scriptFile = (string) $this->manifest->scriptfile;		if ($scriptFile)		{			$manifestScriptFile = $this->parent->getPath('source') . '/' . $scriptFile;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// Set the class name			$classname = $row->element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $scriptFile);			}		}		ob_start();		ob_implicit_flush(false);		// Run uninstall if possible		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'uninstall'))		{			$this->parent->manifestClass->uninstall($this);		}		$msg = ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		/**		 * ---------------------------------------------------------------------------------------------		 * Database Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// Let's run the uninstall queries for the component		if (isset($this->manifest->uninstall->sql))		{			$result = $this->parent->parseSQLFiles($this->manifest->uninstall->sql);			if ($result === false)			{				// Install failed, rollback changes				JLog::add(JText::sprintf('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_SQL_ERROR', $db->stderr(true)), JLog::WARNING, 'jerror');				$retval = false;			}		}		$this->_removeAdminMenus($row);		/**		 * ---------------------------------------------------------------------------------------------		 * Filesystem Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// Let's remove those language files and media in the JROOT/images/ folder that are		// associated with the component we are uninstalling		$this->parent->removeFiles($this->manifest->media);		$this->parent->removeFiles($this->manifest->languages);		$this->parent->removeFiles($this->manifest->administration->languages, 1);		// Remove the schema version		$query = $db->getQuery(true)			->delete('#__schemas')			->where('extension_id = ' . $id);		$db->setQuery($query);		$db->execute();		// Remove the component container in the assets table.		$asset = JTable::getInstance('Asset');		if ($asset->loadByName($element))		{			$asset->delete();		}		// Remove categories for this component		$query = $db->getQuery(true)			->delete('#__categories')			->where('extension=' . $db->quote($element), 'OR')			->where('extension LIKE ' . $db->quote($element . '.%'));		$db->setQuery($query);		$db->execute();		// Clobber any possible pending updates		$update = JTable::getInstance('update');		$uid = $update->find(array('element' => $row->element, 'type' => 'component', 'client_id' => 1, 'folder' => ''));		if ($uid)		{			$update->delete($uid);		}		// Now we need to delete the installation directories. This is the final step in uninstalling the component.		if (trim($row->element))		{			// Delete the component site directory			if (is_dir($this->parent->getPath('extension_site')))			{				if (!JFolder::delete($this->parent->getPath('extension_site')))				{					JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_FAILED_REMOVE_DIRECTORY_SITE'), JLog::WARNING, 'jerror');					$retval = false;				}			}			// Delete the component admin directory			if (is_dir($this->parent->getPath('extension_administrator')))			{				if (!JFolder::delete($this->parent->getPath('extension_administrator')))				{					JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_FAILED_REMOVE_DIRECTORY_ADMIN'), JLog::WARNING, 'jerror');					$retval = false;				}			}			// Now we will no longer need the extension object, so let's delete it and free up memory			$row->delete($row->extension_id);			unset($row);			return $retval;		}		else		{			// No component option defined... cannot delete what we don't know about			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_UNINSTALL_NO_OPTION'), JLog::WARNING, 'jerror');			return false;		}	}	/**	 * Method to build menu database entries for a component	 *	 * @return  boolean  True if successful	 *	 * @since   3.1	 */	protected function _buildAdminMenus()	{		$db = $this->parent->getDbo();		$table = JTable::getInstance('menu');		$option = $this->get('element');		// If a component exists with this option in the table then we don't need to add menus		$query = $db->getQuery(true)			->select('m.id, e.extension_id')			->from('#__menu AS m')			->join('LEFT', '#__extensions AS e ON m.component_id = e.extension_id')			->where('m.parent_id = 1')			->where('m.client_id = 1')			->where('e.element = ' . $db->quote($option));		$db->setQuery($query);		$componentrow = $db->loadObject();		// Check if menu items exist		if ($componentrow)		{			// Don't do anything if overwrite has not been enabled			if (!$this->parent->isOverwrite())			{				return true;			}			// Remove existing menu items if overwrite has been enabled			if ($option)			{				// If something goes wrong, there's no way to rollback TODO: Search for better solution				$this->_removeAdminMenus($componentrow);			}			$component_id = $componentrow->extension_id;		}		else		{			// Lets find the extension id			$query->clear()				->select('e.extension_id')				->from('#__extensions AS e')				->where('e.element = ' . $db->quote($option));			$db->setQuery($query);			// TODO Find Some better way to discover the component_id			$component_id = $db->loadResult();		}		// Ok, now its time to handle the menus.  Start with the component root menu, then handle submenus.		$menuElement = $this->manifest->administration->menu;		if ($menuElement)		{			$data = array();			$data['menutype'] = 'main';			$data['client_id'] = 1;			$data['title'] = (string) trim($menuElement);			$data['alias'] = (string) $menuElement;			$data['link'] = 'index.php?option=' . $option;			$data['type'] = 'component';			$data['published'] = 0;			$data['parent_id'] = 1;			$data['component_id'] = $component_id;			$data['img'] = ((string) $menuElement->attributes()->img) ? (string) $menuElement->attributes()->img : 'class:component';			$data['home'] = 0;			try			{				$table->setLocation(1, 'last-child');			}			catch (InvalidArgumentException $e)			{				JLog::add($e->getMessage(), JLog::WARNING, 'jerror');				return false;			}			if (!$table->bind($data) || !$table->check() || !$table->store())			{				// The menu item already exists. Delete it and retry instead of throwing an error.				$query = $db->getQuery(true)					->select('id')					->from('#__menu')					->where('menutype = ' . $db->quote('main'))					->where('client_id = 1')					->where('link = ' . $db->quote('index.php?option=' . $option))					->where('type = ' . $db->quote('component'))					->where('parent_id = 1')					->where('home = 0');				$db->setQuery($query);				$menu_id = $db->loadResult();				if (!$menu_id)				{					// Oops! Could not get the menu ID. Go back and rollback changes.					JError::raiseWarning(1, $table->getError());					return false;				}				else				{					// Remove the old menu item					$query = $db->getQuery(true)						->delete('#__menu')						->where('id = ' . (int) $menu_id);					$db->setQuery($query);					$db->query();					// Retry creating the menu item					$table->setLocation(1, 'last-child');					if (!$table->bind($data) || !$table->check() || !$table->store())					{						// Install failed, warn user and rollback changes						JError::raiseWarning(1, $table->getError());						return false;					}				}			}			/*			 * Since we have created a menu item, we add it to the installation step stack			 * so that if we have to rollback the changes we can undo it.			 */			$this->parent->pushStep(array('type' => 'menu', 'id' => $component_id));		}		// No menu element was specified, Let's make a generic menu item		else		{			$data = array();			$data['menutype'] = 'main';			$data['client_id'] = 1;			$data['title'] = $option;			$data['alias'] = $option;			$data['link'] = 'index.php?option=' . $option;			$data['type'] = 'component';			$data['published'] = 0;			$data['parent_id'] = 1;			$data['component_id'] = $component_id;			$data['img'] = 'class:component';			$data['home'] = 0;			try			{				$table->setLocation(1, 'last-child');			}			catch (InvalidArgumentException $e)			{				JLog::add($e->getMessage(), JLog::WARNING, 'jerror');				return false;			}			if (!$table->bind($data) || !$table->check() || !$table->store())			{				// Install failed, warn user and rollback changes				JLog::add($table->getError(), JLog::WARNING, 'jerror');				return false;			}			/*			 * Since we have created a menu item, we add it to the installation step stack			 * so that if we have to rollback the changes we can undo it.			 */			$this->parent->pushStep(array('type' => 'menu', 'id' => $component_id));		}		/*		 * Process SubMenus		 */		if (!$this->manifest->administration->submenu)		{			return true;		}		$parent_id = $table->id;		foreach ($this->manifest->administration->submenu->menu as $child)		{			$data = array();			$data['menutype'] = 'main';			$data['client_id'] = 1;			$data['title'] = (string) trim($child);			$data['alias'] = (string) $child;			$data['type'] = 'component';			$data['published'] = 0;			$data['parent_id'] = $parent_id;			$data['component_id'] = $component_id;			$data['img'] = ((string) $child->attributes()->img) ? (string) $child->attributes()->img : 'class:component';			$data['home'] = 0;			// Set the sub menu link			if ((string) $child->attributes()->link)			{				$data['link'] = 'index.php?' . $child->attributes()->link;			}			else			{				$request = array();				if ((string) $child->attributes()->act)				{					$request[] = 'act=' . $child->attributes()->act;				}				if ((string) $child->attributes()->task)				{					$request[] = 'task=' . $child->attributes()->task;				}				if ((string) $child->attributes()->controller)				{					$request[] = 'controller=' . $child->attributes()->controller;				}				if ((string) $child->attributes()->view)				{					$request[] = 'view=' . $child->attributes()->view;				}				if ((string) $child->attributes()->layout)				{					$request[] = 'layout=' . $child->attributes()->layout;				}				if ((string) $child->attributes()->sub)				{					$request[] = 'sub=' . $child->attributes()->sub;				}				$qstring = (count($request)) ? '&' . implode('&', $request) : '';				$data['link'] = 'index.php?option=' . $option . $qstring;			}			$table = JTable::getInstance('menu');			try			{				$table->setLocation($parent_id, 'last-child');			}			catch (InvalidArgumentException $e)			{				return false;			}			if (!$table->bind($data) || !$table->check() || !$table->store())			{				// Install failed, rollback changes				return false;			}			/*			 * Since we have created a menu item, we add it to the installation step stack			 * so that if we have to rollback the changes we can undo it.			 */			$this->parent->pushStep(array('type' => 'menu', 'id' => $component_id));		}		return true;	}	/**	 * Method to remove admin menu references to a component	 *	 * @param   object  &$row  Component table object.	 *	 * @return  boolean  True if successful.	 *	 * @since   3.1	 */	protected function _removeAdminMenus(&$row)	{		$db = $this->parent->getDbo();		$table = JTable::getInstance('menu');		$id = $row->extension_id;		// Get the ids of the menu items		$query = $db->getQuery(true)			->select('id')			->from('#__menu')			->where($db->quoteName('client_id') . ' = 1')			->where($db->quoteName('component_id') . ' = ' . (int) $id);		$db->setQuery($query);		$ids = $db->loadColumn();		// Check for error		if (!empty($ids))		{			// Iterate the items to delete each one.			foreach ($ids as $menuid)			{				if (!$table->delete((int) $menuid))				{					$this->setError($table->getError());					return false;				}			}			// Rebuild the whole tree			$table->rebuild();		}		return true;	}	/**	 * Custom rollback method	 * - Roll back the component menu item	 *	 * @param   array  $step  Installation step to rollback.	 *	 * @return  boolean  True on success	 *	 * @since   3.1	 */	protected function _rollback_menu($step)	{		return $this->_removeAdminMenus((object) array('extension_id' => $step['id']));	}	/**	 * Discover unregistered extensions.	 *	 * @return  array  A list of extensions.	 *	 * @since   3.1	 */	public function discover()	{		$results = array();		$site_components = JFolder::folders(JPATH_SITE . '/components');		$admin_components = JFolder::folders(JPATH_ADMINISTRATOR . '/components');		foreach ($site_components as $component)		{			if (file_exists(JPATH_SITE . '/components/' . $component . '/' . str_replace('com_', '', $component) . '.xml'))			{				$manifest_details = JInstaller::parseXMLInstallFile(					JPATH_SITE . '/components/' . $component . '/' . str_replace('com_', '', $component) . '.xml'				);				$extension = JTable::getInstance('extension');				$extension->set('type', 'component');				$extension->set('client_id', 0);				$extension->set('element', $component);				$extension->set('folder', '');				$extension->set('name', $component);				$extension->set('state', -1);				$extension->set('manifest_cache', json_encode($manifest_details));				$extension->set('params', '{}');				$results[] = $extension;			}		}		foreach ($admin_components as $component)		{			if (file_exists(JPATH_ADMINISTRATOR . '/components/' . $component . '/' . str_replace('com_', '', $component) . '.xml'))			{				$manifest_details = JInstaller::parseXMLInstallFile(					JPATH_ADMINISTRATOR . '/components/' . $component . '/' . str_replace('com_', '', $component) . '.xml'				);				$extension = JTable::getInstance('extension');				$extension->set('type', 'component');				$extension->set('client_id', 1);				$extension->set('element', $component);				$extension->set('folder', '');				$extension->set('name', $component);				$extension->set('state', -1);				$extension->set('manifest_cache', json_encode($manifest_details));				$extension->set('params', '{}');				$results[] = $extension;			}		}		return $results;	}	/**	 * Install unregistered extensions that have been discovered.	 *	 * @return  mixed	 *	 * @since   3.1	 */	public function discover_install()	{		// Need to find to find where the XML file is since we don't store this normally		$client = JApplicationHelper::getClientInfo($this->parent->extension->client_id);		$short_element = str_replace('com_', '', $this->parent->extension->element);		$manifestPath = $client->path . '/components/' . $this->parent->extension->element . '/' . $short_element . '.xml';		$this->parent->manifest = $this->parent->isManifest($manifestPath);		$this->parent->setPath('manifest', $manifestPath);		$this->parent->setPath('source', $client->path . '/components/' . $this->parent->extension->element);		$this->parent->setPath('extension_root', $this->parent->getPath('source'));		$manifest_details = JInstaller::parseXMLInstallFile($this->parent->getPath('manifest'));		$this->parent->extension->manifest_cache = json_encode($manifest_details);		$this->parent->extension->state = 0;		$this->parent->extension->name = $manifest_details['name'];		$this->parent->extension->enabled = 1;		$this->parent->extension->params = $this->parent->getParams();		try		{			$this->parent->extension->store();		}		catch (RuntimeException $e)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_DISCOVER_STORE_DETAILS'), JLog::WARNING, 'jerror');			return false;		}		// Now we need to run any SQL it has, languages, media or menu stuff		// Get a database connector object		$db = $this->parent->getDbo();		// Get the extension manifest object		$this->manifest = $this->parent->getManifest();		/**		 * ---------------------------------------------------------------------------------------------		 * Manifest Document Setup Section		 * ---------------------------------------------------------------------------------------------		 */		// Set the extensions name		$name = strtolower(JFilterInput::getInstance()->clean((string) $this->manifest->name, 'cmd'));		if (substr($name, 0, 4) == 'com_')		{			$element = $name;		}		else		{			$element = 'com_' . $name;		}		$this->set('name', $name);		$this->set('element', $element);		// Get the component description		$description = (string) $this->manifest->description;		if ($description)		{			$this->parent->set('message', JText::_((string) $description));		}		else		{			$this->parent->set('message', '');		}		// Set the installation target paths		$this->parent->setPath('extension_site', JPath::clean(JPATH_SITE . '/components/' . $this->get('element')));		$this->parent->setPath('extension_administrator', JPath::clean(JPATH_ADMINISTRATOR . '/components/' . $this->get('element')));		// Copy the admin path as it's used as a common base		$this->parent->setPath('extension_root', $this->parent->getPath('extension_administrator'));		/**		 * ---------------------------------------------------------------------------------------------		 * Basic Checks Section		 * ---------------------------------------------------------------------------------------------		 */		// Make sure that we have an admin element		if (!$this->manifest->administration)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_INSTALL_ADMIN_ELEMENT'), JLog::WARNING, 'jerror');			return false;		}		/**		 * ---------------------------------------------------------------------------------------------		 * Installer Trigger Loading		 * ---------------------------------------------------------------------------------------------		 */		// If there is an manifest class file, lets load it; we'll copy it later (don't have dest yet)		$manifestScript = (string) $this->manifest->scriptfile;		if ($manifestScript)		{			$manifestScriptFile = $this->parent->getPath('source') . '/' . $manifestScript;			if (is_file($manifestScriptFile))			{				// Load the file				include_once $manifestScriptFile;			}			// Set the class name			$classname = $element . 'InstallerScript';			if (class_exists($classname))			{				// Create a new instance				$this->parent->manifestClass = new $classname($this);				// And set this so we can copy it later				$this->set('manifest_script', $manifestScript);			}		}		// Run preflight if possible (since we know we're not an update)		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'preflight'))		{			if ($this->parent->manifestClass->preflight('discover_install', $this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Create msg object; first use here		$msg = ob_get_contents();		ob_end_clean();		/*		 *		 * Normally we would copy files and create directories, lets skip to the optional files		 * Note: need to dereference things!		 * Parse optional tags		 * @todo remove code: $this->parent->parseMedia($this->manifest->media);		 *		 * We don't do language because 1.6 suggests moving to extension based languages		 * @todo remove code: $this->parent->parseLanguages($this->manifest->languages);		 * @todo remove code: $this->parent->parseLanguages($this->manifest->administration->languages, 1);		 */		/**		 * ---------------------------------------------------------------------------------------------		 * Database Processing Section		 * ---------------------------------------------------------------------------------------------		 */		// Let's run the install queries for the component		if (isset($this->manifest->install->sql))		{			$utfresult = $this->parent->parseSQLFiles($this->manifest->install->sql);			if ($utfresult === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_SQL_ERROR', $db->stderr(true)));				return false;			}		}		// Time to build the admin menus		if (!$this->_buildAdminMenus($this->parent->extension->extension_id))		{			JLog::add(JText::_('JLIB_INSTALLER_ABORT_COMP_BUILDADMINMENUS_FAILED'), JLog::WARNING, 'jerror');			// @todo remove code: $this->parent->abort(JText::sprintf('JLIB_INSTALLER_ABORT_COMP_INSTALL_ROLLBACK', $db->stderr(true)));			// @todo remove code: return false;		}		/**		 * ---------------------------------------------------------------------------------------------		 * Custom Installation Script Section		 * ---------------------------------------------------------------------------------------------		 */		/*		 * If we have an install script, lets include it, execute the custom		 * discover_install method, and append the return value from the custom discover_install		 * method to the installation message.		 */		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'install'))		{			if ($this->parent->manifestClass->install($this) === false)			{				// Install failed, rollback changes				$this->parent->abort(JText::_('JLIB_INSTALLER_ABORT_COMP_INSTALL_CUSTOM_INSTALL_FAILURE'));				return false;			}		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		/**		 * ---------------------------------------------------------------------------------------------		 * Finalization and Cleanup Section		 * ---------------------------------------------------------------------------------------------		 */		// Clobber any possible pending updates		$update = JTable::getInstance('update');		$uid = $update->find(array('element' => $this->get('element'), 'type' => 'component', 'client_id' => 1, 'folder' => ''));		if ($uid)		{			$update->delete($uid);		}		// And now we run the postflight		ob_start();		ob_implicit_flush(false);		if ($this->parent->manifestClass && method_exists($this->parent->manifestClass, 'postflight'))		{			$this->parent->manifestClass->postflight('discover_install', $this);		}		// Append messages		$msg .= ob_get_contents();		ob_end_clean();		if ($msg != '')		{			$this->parent->set('extension_message', $msg);		}		return $this->parent->extension->extension_id;	}	/**	 * Refreshes the extension table cache	 *	 * @return  boolean  Result of operation, true if updated, false on failure	 *	 * @since   3.1	 */	public function refreshManifestCache()	{		// Need to find to find where the XML file is since we don't store this normally		$client = JApplicationHelper::getClientInfo($this->parent->extension->client_id);		$short_element = str_replace('com_', '', $this->parent->extension->element);		$manifestPath = $client->path . '/components/' . $this->parent->extension->element . '/' . $short_element . '.xml';		$this->parent->manifest = $this->parent->isManifest($manifestPath);		$this->parent->setPath('manifest', $manifestPath);		$manifest_details = JInstaller::parseXMLInstallFile($this->parent->getPath('manifest'));		$this->parent->extension->manifest_cache = json_encode($manifest_details);		$this->parent->extension->name = $manifest_details['name'];		try		{			return $this->parent->extension->store();		}		catch (RuntimeException $e)		{			JLog::add(JText::_('JLIB_INSTALLER_ERROR_COMP_REFRESH_MANIFEST_CACHE'), JLog::WARNING, 'jerror');			return false;		}	}}/** * Deprecated class placeholder. You should use JInstallerAdapterComponent instead. * * @package     Joomla.Libraries * @subpackage  Installer * @since       3.1 * @deprecated  4.0 * @codeCoverageIgnore */class JInstallerComponent extends JInstallerAdapterComponent{}
<?php/** * @package     Joomla.Site * @subpackage  com_content * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;$class = ' class="first"';JHtml::_('bootstrap.tooltip');$lang	= JFactory::getLanguage();if (count($this->items[$this->parent->id]) > 0 && $this->maxLevelcat != 0) :?>	<?php foreach($this->items[$this->parent->id] as $id => $item) : ?>		<?php		if ($this->params->get('show_empty_categories_cat') || $item->numitems || count($item->getChildren())) :		if (!isset($this->items[$this->parent->id][$id + 1]))		{			$class = ' class="last"';		}		?>		<div <?php echo $class; ?> >		<?php $class = ''; ?>			<h3 class="page-header item-title">				<a href="<?php echo JRoute::_(ContentHelperRoute::getCategoryRoute($item->id));?>">				<?php echo $this->escape($item->title); ?></a>				<?php if ($this->params->get('show_cat_num_articles_cat') == 1) :?>					<span class="badge badge-info tip hasTooltip" title="<?php echo JText::_('COM_CONTENT_NUM_ITEMS'); ?>">						<?php echo $item->numitems; ?>					</span>				<?php endif; ?>				<?php if (count($item->getChildren()) > 0) : ?>					<a href="#category-<?php echo $item->id;?>" data-toggle="collapse" data-toggle="button" class="btn btn-mini pull-right"><span class="icon-plus"></span></a>				<?php endif;?>			</h3>			<?php if ($this->params->get('show_subcat_desc_cat') == 1) :?>				<?php if ($item->description) : ?>					<div class="category-desc">						<?php echo JHtml::_('content.prepare', $item->description, '', 'com_content.categories'); ?>					</div>				<?php endif; ?>			<?php endif; ?>			<?php if (count($item->getChildren()) > 0) :?>				<div class="collapse fade" id="category-<?php echo $item->id;?>">				<?php				$this->items[$item->id] = $item->getChildren();				$this->parent = $item;				$this->maxLevelcat--;				echo $this->loadTemplate('items');				$this->parent = $item->getParent();				$this->maxLevelcat++;				?>				</div>			<?php endif; ?>		</div>		<?php endif; ?>	<?php endforeach; ?><?php endif; ?>
<?php/** * @package     Joomla.Plugin * @subpackage  Content.finder * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Finder Content Plugin * * @package     Joomla.Plugin * @subpackage  Content.finder * @since       2.5 */class PlgContentFinder extends JPlugin{	/**	 * Finder after save content method	 * Article is passed by reference, but after the save, so no changes will be saved.	 * Method is called right after the content is saved	 *	 * @param   string  The context of the content passed to the plugin (added in 1.6)	 * @param   object		A JTableContent object	 * @param   bool		If the content has just been created	 * @since	2.5	 */	public function onContentAfterSave($context, $article, $isNew)	{		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('finder');		// Trigger the onFinderAfterSave event.		$dispatcher->trigger('onFinderAfterSave', array($context, $article, $isNew));	}	/**	 * Finder before save content method	 * Article is passed by reference, but after the save, so no changes will be saved.	 * Method is called right after the content is saved	 *	 * @param   string  The context of the content passed to the plugin (added in 1.6)	 * @param   object		A JTableContent object	 * @param   bool		If the content is just about to be created	 * @since   2.5	 */	public function onContentBeforeSave($context, $article, $isNew)	{		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('finder');		// Trigger the onFinderBeforeSave event.		$dispatcher->trigger('onFinderBeforeSave', array($context, $article, $isNew));	}	/**	 * Finder after delete content method	 * Article is passed by reference, but after the save, so no changes will be saved.	 * Method is called right after the content is saved	 *	 * @param   string  The context of the content passed to the plugin (added in 1.6)	 * @param   object		A JTableContent object	 * @since   2.5	 */	public function onContentAfterDelete($context, $article)	{		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('finder');		// Trigger the onFinderAfterDelete event.		$dispatcher->trigger('onFinderAfterDelete', array($context, $article));	}	/**	 * Finder change state content method	 * Method to update the link information for items that have been changed	 * from outside the edit screen. This is fired when the item is published,	 * unpublished, archived, or unarchived from the list view.	 *	 * @param   string   $context  The context for the content passed to the plugin.	 * @param   array    $pks      A list of primary key ids of the content that has changed state.	 * @param   integer  $value    The value of the state that the content has been changed to.	 * @since   2.5	 */	public function onContentChangeState($context, $pks, $value)	{		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('finder');		// Trigger the onFinderChangeState event.		$dispatcher->trigger('onFinderChangeState', array($context, $pks, $value));	}	/**	 * Finder change category state content method	 * Article is passed by reference, but after the save, so no changes will be saved.	 * Method is called right after the content is saved	 *	 * @param   string   $extension  The extension whose category has been updated.	 * @param   array    $pks        A list of primary key ids of the content that has changed state.	 * @param   integer  $value      The value of the state that the content has been changed to.	 * @since   2.5	 */	public function onCategoryChangeState($extension, $pks, $value)	{		$dispatcher	= JEventDispatcher::getInstance();		JPluginHelper::importPlugin('finder');		// Trigger the onFinderCategoryChangeState event.		$dispatcher->trigger('onFinderCategoryChangeState', array($extension, $pks, $value));	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_installer * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;include_once __DIR__ . '/../default/view.php';/** * Extension Manager Manage View * * @package     Joomla.Administrator * @subpackage  com_installer * @since       1.6 */class InstallerViewDiscover extends InstallerViewDefault{	/**	 * Display the view	 *	 * @param   string  $tpl  Template	 *	 * @return  void	 *	 * @since   1.6	 */	public function display($tpl = null)	{		// Get data from the model		$this->state		= $this->get('State');		$this->items		= $this->get('Items');		$this->pagination	= $this->get('Pagination');		parent::display($tpl);	}	/**	 * Add the page title and toolbar.	 *	 * @return  void	 *	 * @since   1.6	 */	protected function addToolbar()	{		$canDo	= InstallerHelper::getActions();		/*		 * Set toolbar items for the page		 */		JToolbarHelper::custom('discover.install', 'upload', 'upload', 'JTOOLBAR_INSTALL', true, false);		JToolbarHelper::custom('discover.refresh', 'refresh', 'refresh', 'COM_INSTALLER_TOOLBAR_DISCOVER', false, false);		JToolbarHelper::divider();		parent::addToolbar();		JToolbarHelper::help('JHELP_EXTENSIONS_EXTENSION_MANAGER_DISCOVER');	}}
<?php/** * @package     Joomla.Platform * @subpackage  Profiler * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * Utility class to assist in the process of benchmarking the execution * of sections of code to understand where time is being spent. * * @package     Joomla.Platform * @subpackage  Profiler * @since       11.1 */class JProfiler{	/**	 * @var    integer  The start time.	 * @since  12.1	 */	protected $start = 0;	/**	 * @var    string  The prefix to use in the output	 * @since  12.1	 */	protected $prefix = '';	/**	 * @var    array  The buffer of profiling messages.	 * @since  12.1	 */	protected $buffer = null;	/**	 * @var    float	 * @since  12.1	 */	protected $previousTime = 0.0;	/**	 * @var    float	 * @since  12.1	 */	protected $previousMem = 0.0;	/**	 * @var    array  JProfiler instances container.	 * @since  11.3	 */	protected static $instances = array();	/**	 * Constructor	 *	 * @param   string  $prefix  Prefix for mark messages	 *	 * @since  11.1	 */	public function __construct($prefix = '')	{		$this->start = $this->getmicrotime();		$this->prefix = $prefix;		$this->buffer = array();	}	/**	 * Returns the global Profiler object, only creating it	 * if it doesn't already exist.	 *	 * @param   string  $prefix  Prefix used to distinguish profiler objects.	 *	 * @return  JProfiler  The Profiler object.	 *	 * @since   11.1	 */	public static function getInstance($prefix = '')	{		if (empty(self::$instances[$prefix]))		{			self::$instances[$prefix] = new JProfiler($prefix);		}		return self::$instances[$prefix];	}	/**	 * Output a time mark	 *	 * The mark is returned as text enclosed in <div> tags	 * with a CSS class of 'profiler'.	 *	 * @param   string  $label  A label for the time mark	 *	 * @return  string  Mark enclosed in <div> tags	 *	 * @since   11.1	 */	public function mark($label)	{		$current = self::getmicrotime() - $this->start;		$currentMem = 0;		$currentMem = memory_get_usage() / 1048576;		$mark = sprintf(			'<code>%s %.3f seconds (+%.3f); %0.2f MB (%s%0.3f) - %s</code>',			$this->prefix,			$current,			$current - $this->previousTime,			$currentMem,			($currentMem > $this->previousMem) ? '+' : '', $currentMem - $this->previousMem,			$label		);		$this->previousTime = $current;		$this->previousMem = $currentMem;		$this->buffer[] = $mark;		return $mark;	}	/**	 * Get the current time.	 *	 * @return  float The current time	 *	 * @since   11.1	 */	public static function getmicrotime()	{		list ($usec, $sec) = explode(' ', microtime());		return ((float) $usec + (float) $sec);	}	/**	 * Get information about current memory usage.	 *	 * @return  integer  The memory usage	 *	 * @link    PHP_MANUAL#memory_get_usage	 * @since   11.1	 * @deprecated  12.3  Use PHP's native memory_get_usage()	 */	public function getMemory()	{		return memory_get_usage();	}	/**	 * Get all profiler marks.	 *	 * Returns an array of all marks created since the Profiler object	 * was instantiated.  Marks are strings as per {@link JProfiler::mark()}.	 *	 * @return  array  Array of profiler marks	 */	public function getBuffer()	{		return $this->buffer;	}}
<?php/** * @package     Joomla.Site * @subpackage  com_weblinks * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;?><div class="categories-list<?php echo $displayData->pageclass_sfx;?>"><?php if ($displayData->params->get('show_page_heading')) : ?><h1>	<?php echo $displayData->escape($displayData->params->get('page_heading')); ?></h1><?php endif; ?><?php if ($displayData->params->get('show_base_description')) : ?>	<?php //If there is a description in the menu parameters use that; ?>		<?php if($displayData->params->get('categories_description')) : ?>			<div class="category-desc base-desc">			<?php echo JHtml::_('content.prepare', $displayData->params->get('categories_description'), '',  $displayData->extension . '.categories'); ?>			</div>		<?php else : ?>			<?php //Otherwise get one from the database if it exists. ?>			<?php  if ($displayData->parent->description) : ?>				<div class="category-desc base-desc">					<?php echo JHtml::_('content.prepare', $displayData->parent->description, '', $displayData->parent->extension . '.categories'); ?>				</div>			<?php endif; ?>		<?php endif; ?>	<?php endif; ?>
<?php/** * @package     Joomla.Platform * @subpackage  MediaWiki * * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE */defined('JPATH_PLATFORM') or die;/** * MediaWiki API Users class for the Joomla Platform. * * @package     Joomla.Platform * @subpackage  MediaWiki * @since       12.3 */class JMediawikiUsers extends JMediawikiObject{	/**     * Method to login and get authentication tokens.     *     * @param   string  $lgname      User Name.     * @param   string  $lgpassword  Password.     * @param   string  $lgdomain    Domain (optional).     *     * @return  object     *     * @since   12.3     */	public function login($lgname, $lgpassword, $lgdomain = null)	{		// Build the request path.		$path = '?action=login&lgname=' . $lgname . '&lgpassword=' . $lgpassword;		if (isset($lgdomain))		{			$path .= '&lgdomain=' . $lgdomain;		}		// Send the request.		$response = $this->client->post($this->fetchUrl($path), null);		// Request path with login token.		$path = '?action=login&lgname=' . $lgname . '&lgpassword=' . $lgpassword . '&lgtoken=' . $this->validateResponse($response)->login['token'];		if (isset($lgdomain))		{			$path .= '&lgdomain=' . $lgdomain;		}		// Set the session cookies returned.		$headers = (array) $this->options->get('headers');		$headers['Cookie'] = !empty($headers['Cookie']) ? empty($headers['Cookie']) : '';		$headers['Cookie'] = $headers['Cookie'] . $response->headers['Set-Cookie'];		$this->options->set('headers', $headers);		// Send the request again with the token.		$response = $this->client->post($this->fetchUrl($path), null);		$response_body = $this->validateResponse($response);		$headers = (array) $this->options->get('headers');		$cookie_prefix = $response_body->login['cookieprefix'];		$cookie = $cookie_prefix . 'UserID=' . $response_body->login['lguserid'] . '; ' . $cookie_prefix			. 'UserName=' . $response_body->login['lgusername'];		$headers['Cookie'] = $headers['Cookie'] . '; ' . $response->headers['Set-Cookie'] . '; ' . $cookie;		$this->options->set('headers', $headers);		return $this->validateResponse($response);	}	/**	 * Method to logout and clear session data.	 *	 * @return  object	 *	 * @since   12.3	 */	public function logout()	{		// Build the request path.		$path = '?action=login';		// @TODO clear internal data as well		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get user information.	 *	 * @param   array  $ususers  A list of users to obtain the same information for.	 * @param   array  $usprop   What pieces of information to include.	 *     * @return  object     *     * @since   12.3     */	public function getUserInfo(array $ususers, array $usprop = null)	{		// Build the request path.		$path = '?action=query&list=users';		// Append users to the request.		$path .= '&ususers=' . $this->buildParameter($ususers);		if (isset($usprop))		{			$path .= '&usprop' . $this->buildParameter($usprop);		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get current user information.	 *	 * @param   array  $uiprop  What pieces of information to include.     *     * @return  object     *     * @since   12.3     */	public function getCurrentUserInfo(array $uiprop = null)	{		// Build the request path.		$path = '?action=query&meta=userinfo';		if (isset($uiprop))		{			$path .= '&uiprop' . $this->buildParameter($uiprop);		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to get user contributions.     *     * @param   string   $ucuser        The users to retrieve contributions for.	 * @param   string   $ucuserprefix  Retrieve contibutions for all users whose names begin with this value.     * @param   integer  $uclimit       The users to retrieve contributions for.     * @param   string   $ucstart       The start timestamp to return from.     * @param   string   $ucend         The end timestamp to return to.     * @param   boolean  $uccontinue    When more results are available, use this to continue.     * @param   string   $ucdir         In which direction to enumerate.     * @param   array    $ucnamespace   Only list contributions in these namespaces.     * @param   array    $ucprop        Include additional pieces of information.     * @param   array    $ucshow        Show only items that meet this criteria.     * @param   string   $uctag         Only list revisions tagged with this tag.     * @param   string   $uctoponly     Only list changes which are the latest revision     *     * @return  object     *     * @since   12.3     */	public function getUserContribs($ucuser = null, $ucuserprefix = null, $uclimit = null, $ucstart = null, $ucend = null, $uccontinue = null,		$ucdir = null, array $ucnamespace = null, array $ucprop = null, array $ucshow = null, $uctag = null, $uctoponly = null)	{		// Build the request path.		$path = '?action=query&list=usercontribs';		if (isset($ucuser))		{			$path .= '&ucuser=' . $ucuser;		}		if (isset($ucuserprefix))		{			$path .= '&ucuserprefix=' . $ucuserprefix;		}		if (isset($uclimit))		{			$path .= '&uclimit=' . $uclimit;		}		if (isset($ucstart))		{			$path .= '&ucstart=' . $ucstart;		}		if (isset($ucend))		{			$path .= '&ucend=' . $ucend;		}		if ($uccontinue)		{			$path .= '&uccontinue=';		}		if (isset($ucdir))		{			$path .= '&ucdir=' . $ucdir;		}		if (isset($ucnamespace))		{			$path .= '&ucnamespace=' . $this->buildParameter($ucnamespace);		}		if (isset($ucprop))		{			$path .= '&ucprop=' . $this->buildParameter($ucprop);		}		if (isset($ucshow))		{			$path .= '&ucshow=' . $this->buildParameter($ucshow);		}		if (isset($uctag))		{			$path .= '&uctag=' . $uctag;		}		if (isset($uctoponly))		{			$path .= '&uctoponly=' . $uctoponly;		}		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to block a user.	 *	 * @param   string   $user           Username, IP address or IP range you want to block.	 * @param   string   $expiry         Relative expiry time, Default: never.	 * @param   string   $reason         Reason for block (optional).	 * @param   boolean  $anononly       Block anonymous users only.	 * @param   boolean  $nocreate       Prevent account creation.	 * @param   boolean  $autoblock      Automatically block the last used IP address, and any subsequent IP addresses they try to login from.	 * @param   boolean  $noemail        Prevent user from sending e-mail through the wiki.	 * @param   boolean  $hidename       Hide the username from the block log.	 * @param   boolean  $allowusertalk  Allow the user to edit their own talk page.	 * @param   boolean  $reblock        If the user is already blocked, overwrite the existing block.	 * @param   boolean  $watchuser      Watch the user/IP's user and talk pages.     *     * @return  object     *     * @since   12.3     */	public function blockUser($user, $expiry = null, $reason = null, $anononly = null, $nocreate = null, $autoblock = null, $noemail = null,		$hidename = null, $allowusertalk = null, $reblock = null, $watchuser = null)	{		// Get the token.		$token = $this->getToken($user, 'block');		// Build the request path.		$path = '?action=unblock';		// Build the request data.		$data = array(			'user' => $user,			'token' => $token,			'expiry' => $expiry,			'reason' => $reason,			'anononly' => $anononly,			'nocreate' => $nocreate,			'autoblock' => $autoblock,			'noemail' => $noemail,			'hidename' => $hidename,			'allowusetalk' => $allowusertalk,			'reblock' => $reblock,			'watchuser' => $watchuser		);		// Send the request.		$response = $this->client->post($this->fetchUrl($path), $data);		return $this->validateResponse($response);	}	/**     * Method to unblock a user.	 *	 * @param   string  $user    Username, IP address or IP range you want to unblock.	 * @param   string  $reason  Reason for unblock (optional).     *     * @return  object     *     * @since   12.3     */	public function unBlockUserByName($user, $reason = null)	{		// Get the token.		$token = $this->getToken($user, 'unblock');		// Build the request path.		$path = '?action=unblock';		// Build the request data.		$data = array(				'user' => $user,				'token' => $token,				'reason' => $reason,		);		// Send the request.		$response = $this->client->post($this->fetchUrl($path), $data);		return $this->validateResponse($response);	}	/**	 * Method to unblock a user.	 *	 * @param   int     $id      Username, IP address or IP range you want to unblock.	 * @param   string  $reason  Reason for unblock (optional).	 *	 * @return  object	 *	 * @since   12.3	 */	public function unBlockUserByID($id, $reason = null)	{		// Get the token.		$token = $this->getToken($id, 'unblock');		// Build the request path.		$path = '?action=unblock';		// Build the request data.		$data = array(			'id' => $id,			'token' => $token,			'reason' => $reason,		);		// Send the request.		$response = $this->client->get($this->fetchUrl($path));		return $this->validateResponse($response);	}	/**     * Method to assign a user to a group.	 *	 * @param   string  $username  User name.	 * @param   array   $add       Add the user to these groups.	 * @param   array   $remove    Remove the user from these groups.	 * @param   string  $reason    Reason for the change.     *     * @return  object     *     * @since   12.3     */	public function assignGroup($username, $add = null, $remove = null, $reason = null)	{		// Get the token.		$token = $this->getToken($username, 'unblock');		// Build the request path.		$path = '?action=userrights';		// Build the request data.		$data = array(			'username' => $username,			'token' => $token,			'add' => $add,			'remove' => $remove,			'reason' => $reason		);		// Send the request.		$response = $this->client->post($this->fetchUrl($path), $data);		return $this->validateResponse($response);	}	/**     * Method to email a user.	 *	 * @param   string   $target   User to send email to.	 * @param   string   $subject  Subject header.	 * @param   string   $text     Mail body.	 * @param   boolean  $ccme     Send a copy of this mail to me.     *     * @return  object     *     * @since   12.3     */	public function emailUser($target, $subject = null, $text = null, $ccme = null)	{		// Get the token.		$token = $this->getToken($target, 'emailuser');		// Build the request path.		$path = '?action=emailuser';		// Build the request data.		$data = array(			'target' => $target,			'token' => $token,			'subject' => $subject,			'text' => $text,			'ccme' => $ccme		);		// Send the request.		$response = $this->client->post($this->fetchUrl($path), $data);		return $this->validateResponse($response);	}	/**	 * Method to get access token.	 *	 * @param   string  $user     The User to get token.	 * @param   string  $intoken  The type of token.	 *	 * @return  object	 *	 * @since   12.3	 */	public function getToken($user, $intoken)	{		// Build the request path.		$path = '?action=query&prop=info&intoken=' . $intoken . '&titles=User:' . $user;		// Send the request.		$response = $this->client->post($this->fetchUrl($path), null);		return (string) $this->validateResponse($response)->query->pages->page[$intoken . 'token'];	}}
<?php/** * @package     Joomla.Administrator * @subpackage  com_messages * * @copyright   Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved. * @license     GNU General Public License version 2 or later; see LICENSE.txt */defined('_JEXEC') or die;/** * Private Message model. * * @package     Joomla.Administrator * @subpackage  com_messages * @since       1.6 */class MessagesModelMessage extends JModelAdmin{	/**	 * message	 */	protected $item;	/**	 * Method to auto-populate the model state.	 *	 * Note. Calling getState in this method will result in recursion.	 *	 * @since   1.6	 */	protected function populateState()	{		parent::populateState();		$input = JFactory::getApplication()->input;		$user = JFactory::getUser();		$this->setState('user.id', $user->get('id'));		$messageId = (int) $input->getInt('message_id');		$this->setState('message.id', $messageId);		$replyId = (int) $input->getInt('reply_id');		$this->setState('reply.id', $replyId);	}	/**	 * Check that recipient user is the one trying to delete and then call parent delete method	 *	 * @param   array  &$pks  An array of record primary keys.	 *	 * @return  boolean  True if successful, false if an error occurs.	 *	 * @since  3.1	 */	public function delete(&$pks)	{		$pks = (array) $pks;		$table = $this->getTable();		$user = JFactory::getUser();		// Iterate the items to delete each one.		foreach ($pks as $i => $pk)		{			if ($table->load($pk))			{				if ($table->user_id_to !== $user->id)				{					// Prune items that you can't change.					unset($pks[$i]);					JLog::add(JText::_('JLIB_APPLICATION_ERROR_DELETE_NOT_PERMITTED'), JLog::WARNING, 'jerror');					return false;				}			}			else			{				$this->setError($table->getError());				return false;			}		}		return parent::delete($pks);	}	/**	 * Returns a Table object, always creating it.	 *	 * @param   type	The table type to instantiate	 * @param   string	A prefix for the table class name. Optional.	 * @param   array  Configuration array for model. Optional.	 * @return  JTable	A database object	 * @since   1.6	*/	public function getTable($type = 'Message', $prefix = 'MessagesTable', $config = array())	{		return JTable::getInstance($type, $prefix, $config);	}	/**	 * Method to get a single record.	 *	 * @param   integer	The id of the primary key.	 * @return  mixed  Object on success, false on failure.	 * @since   1.6	 */	public function getItem($pk = null)	{		if (!isset($this->item))		{			if ($this->item = parent::getItem($pk))			{				// Prime required properties.				if (empty($this->item->message_id))				{					// Prepare data for a new record.					if ($replyId = $this->getState('reply.id'))					{						// If replying to a message, preload some data.						$db		= $this->getDbo();						$query	= $db->getQuery(true)							->select('subject, user_id_from')							->from('#__messages')							->where('message_id = '.(int) $replyId);						try						{							$message = $db->setQuery($query)->loadObject();						}						catch (RuntimeException $e)						{							$this->setError($e->getMessage());							return false;						}						$this->item->set('user_id_to', $message->user_id_from);						$re = JText::_('COM_MESSAGES_RE');						if (stripos($message->subject, $re) !== 0)						{							$this->item->set('subject', $re.$message->subject);						}					}				}				elseif ($this->item->user_id_to != JFactory::getUser()->id)				{					$this->setError(JText::_('JERROR_ALERTNOAUTHOR'));					return false;				}				else {					// Mark message read					$db		= $this->getDbo();					$query	= $db->getQuery(true)						->update('#__messages')						->set('state = 1')						->where('message_id = '.$this->item->message_id);					$db->setQuery($query)->execute();				}			}			// Get the user name for an existing messasge.			if ($this->item->user_id_from && $fromUser = new JUser($this->item->user_id_from))			{				$this->item->set('from_user_name', $fromUser->name);			}		}		return $this->item;	}	/**	 * Method to get the record form.	 *	 * @param   array  $data		Data for the form.	 * @param   boolean	$loadData	True if the form is to load its own data (default case), false if not.	 * @return  JForm	A JForm object on success, false on failure	 * @since   1.6	 */	public function getForm($data = array(), $loadData = true)	{		// Get the form.		$form = $this->loadForm('com_messages.message', 'message', array('control' => 'jform', 'load_data' => $loadData));		if (empty($form))		{			return false;		}		return $form;	}	/**	 * Method to get the data that should be injected in the form.	 *	 * @return  mixed  The data for the form.	 * @since   1.6	 */	protected function loadFormData()	{		// Check the session for previously entered form data.		$data = JFactory::getApplication()->getUserState('com_messages.edit.message.data', array());		if (empty($data))		{			$data = $this->getItem();		}		$this->preprocessData('com_messages.message', $data);		return $data;	}	/**	 * Checks that the current user matches the message recipient and calls the parent publish method	 *	 * @param   array    &$pks   A list of the primary keys to change.	 * @param   integer  $value  The value of the published state.	 *	 * @return  boolean  True on success.	 *	 * @since   3.1	 */	public function publish(&$pks, $value = 1)	{		$user = JFactory::getUser();		$table = $this->getTable();		$pks = (array) $pks;		// Check that the recipient matches the current user		foreach ($pks as $i => $pk)		{			$table->reset();			if ($table->load($pk))			{				if ($table->user_id_to !== $user->id)				{					// Prune items that you can't change.					unset($pks[$i]);					JLog::add(JText::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'), JLog::WARNING, 'jerror');					return false;				}			}		}		return parent::publish($pks, $value);	}	/**	 * Method to save the form data.	 *	 * @param   array  The form data.	 *	 * @return  boolean  True on success.	 */	public function save($data)	{		$table = $this->getTable();		// Bind the data.		if (!$table->bind($data))		{			$this->setError($table->getError());			return false;		}		// Assign empty values.		if (empty($table->user_id_from))		{			$table->user_id_from = JFactory::getUser()->get('id');		}		if ((int) $table->date_time == 0)		{			$table->date_time = JFactory::getDate()->toSql();		}		// Check the data.		if (!$table->check())		{			$this->setError($table->getError());			return false;		}		// Load the recipient user configuration.		$model = JModelLegacy::getInstance('Config', 'MessagesModel', array('ignore_request' => true));		$model->setState('user.id', $table->user_id_to);		$config = $model->getItem();		if (empty($config))		{			$this->setError($model->getError());			return false;		}		if ($config->get('locked', false))		{			$this->setError(JText::_('COM_MESSAGES_ERR_SEND_FAILED'));			return false;		}		// Store the data.		if (!$table->store())		{			$this->setError($table->getError());			return false;		}		if ($config->get('mail_on_new', true))		{			// Load the user details (already valid from table check).			$fromUser = JUser::getInstance($table->user_id_from);			$toUser = JUser::getInstance($table->user_id_to);			$debug = JFactory::getConfig()->get('debug_lang');			$default_language = JComponentHelper::getParams('com_languages')->get('administrator');			$lang = JLanguage::getInstance($toUser->getParam('admin_language', $default_language), $debug);			$lang->load('com_messages', JPATH_ADMINISTRATOR);			$siteURL  = JURI::root() . 'administrator/index.php?option=com_messages&view=message&message_id='.$table->message_id;			$sitename = JFactory::getApplication()->getCfg('sitename');			$subject = sprintf($lang->_('COM_MESSAGES_NEW_MESSAGE_ARRIVED'), $sitename);			$msg     = sprintf($lang->_('COM_MESSAGES_PLEASE_LOGIN'), $siteURL);			JFactory::getMailer()->sendMail($fromUser->email, $fromUser->name, $toUser->email, $subject, $msg);		}		return true;	}}
