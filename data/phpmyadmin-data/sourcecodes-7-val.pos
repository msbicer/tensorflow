<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'import.js';/** * Does the common work */require './libraries/server_common.inc.php';/** * Displays the links */require './libraries/server_links.inc.php';$import_type = 'server';require './libraries/display_import.lib.php';/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin */if (! defined('PHPMYADMIN')) {    exit;}/** * Check parameters */require_once './libraries/common.inc.php';require_once './libraries/server_common.inc.php';PMA_checkParameters(array('is_superuser', 'url_query'), true, false);// Don't print all these links if in an Ajax requestif (!$GLOBALS['is_ajax_request']) {    /**     * Counts amount of navigation tabs     */    $server_links_count_tabs = 0;    /**     * Put something in $sub_part     */    if (! isset($sub_part)) {        $sub_part = '';    }    /**     * Displays tab links     * Put the links we assume are used less, towards the end     */    $tabs = array();    $tabs['databases']['icon'] = 's_db.png';    $tabs['databases']['link'] = 'server_databases.php';    $tabs['databases']['text'] = __('Databases');    $tabs['sql']['icon'] = 'b_sql.png';    $tabs['sql']['link'] = 'server_sql.php';    $tabs['sql']['text'] = __('SQL');    $tabs['status']['icon'] = 's_status.png';    $tabs['status']['link'] = 'server_status.php';    $tabs['status']['text'] = __('Status');    /*$tabs['process']['icon'] = 's_process.png';    $tabs['process']['link'] = 'server_processlist.php';    $tabs['process']['text'] = __('Processes');*/    if ($is_superuser && !PMA_DRIZZLE) {        $tabs['rights']['icon'] = 's_rights.png';        $tabs['rights']['link'] = 'server_privileges.php';        $tabs['rights']['text'] = __('Users');    }    $tabs['export']['icon'] = 'b_export.png';    $tabs['export']['link'] = 'server_export.php';    $tabs['export']['text'] = __('Export');    $tabs['import']['icon'] = 'b_import.png';    $tabs['import']['link'] = 'server_import.php';    $tabs['import']['text'] = __('Import');    $tabs['settings']['icon'] = 'b_tblops.png';    $tabs['settings']['link'] = 'prefs_manage.php';    $tabs['settings']['text'] = __('Settings');    $tabs['settings']['active'] = in_array(basename($GLOBALS['PMA_PHP_SELF']),        array('prefs_forms.php', 'prefs_manage.php'));    $tabs['synchronize']['icon'] = 's_sync.png';    $tabs['synchronize']['link'] = 'server_synchronize.php';    $tabs['synchronize']['text'] = __('Synchronize');    if (! empty($binary_logs)) {        $tabs['binlog']['icon'] = 's_tbl.png';        $tabs['binlog']['link'] = 'server_binlog.php';        $tabs['binlog']['text'] = __('Binary log');    }    if ($is_superuser && !PMA_DRIZZLE) {        $tabs['replication']['icon'] = 's_replication.png';        $tabs['replication']['link'] = 'server_replication.php';        $tabs['replication']['text'] = __('Replication');    }    $tabs['vars']['icon'] = 's_vars.png';    $tabs['vars']['link'] = 'server_variables.php';    $tabs['vars']['text'] = __('Variables');    $tabs['charset']['icon'] = 's_asci.png';    $tabs['charset']['link'] = 'server_collations.php';    $tabs['charset']['text'] = __('Charsets');    if (PMA_DRIZZLE) {        $tabs['plugins']['icon'] = 'b_engine.png';        $tabs['plugins']['link'] = 'server_plugins.php';        $tabs['plugins']['text'] = __('Plugins');    } else {        $tabs['engine']['icon'] = 'b_engine.png';        $tabs['engine']['link'] = 'server_engines.php';        $tabs['engine']['text'] = __('Engines');    }    echo PMA_generate_html_tabs($tabs, array());    unset($tabs);    /**     * Displays a message     */    if (!empty($message)) {        PMA_showMessage($message);        unset($message);    }}// end if ($GLOBALS['is_ajax_request'] == true)?>
<?php/** * Front controller for setup script * * @package    phpMyAdmin-setup * @copyright  Copyright (c) 2008, Piotr Przybylski <piotrprz@gmail.com> * @license    http://www.gnu.org/licenses/gpl.html GNU GPL 2.0 *//** * Core libraries. */require './lib/common.inc.php';$page = filter_input(INPUT_GET, 'page');$page = preg_replace('/[^a-z]/', '', $page);if ($page === '') {    $page = 'index';}if (!file_exists("./setup/frames/$page.inc.php")) {    // it will happen only when enterung URL by hand, we don't care for these cases    die(__('Wrong GET file attribute value'));}// Handle done action info$action_done = filter_input(INPUT_GET, 'action_done');$action_done = preg_replace('/[^a-z_]/', '', $action_done);// send no-cache headersrequire './libraries/header_http.inc.php';?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>phpMyAdmin setup</title><link href="../favicon.ico" rel="icon" type="image/x-icon" /><link href="../favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="styles.css" rel="stylesheet" type="text/css" /><script type="text/javascript" src="../js/jquery/jquery-1.6.2.js"></script><script type="text/javascript" src="../js/jquery/jquery-ui-1.8.16.custom.js"></script><script type="text/javascript" src="../js/jquery/jquery.json-2.2.js"></script><script type="text/javascript" src="../js/config.js"></script><script type="text/javascript" src="scripts.js"></script></head><body><h1><span class="blue">php</span><span class="orange">MyAdmin</span>  setup</h1><div id="menu"><?phprequire './setup/frames/menu.inc.php';?></div><div id="page"><?phprequire "./setup/frames/$page.inc.php";?></div></body></html>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * Interface to the improved MySQL extension (MySQLi) * * @package PhpMyAdmin-DBI-MySQLi */if (! defined('PHPMYADMIN')) {    exit;}require_once './libraries/logging.lib.php';/** * MySQL client API */if (!defined('PMA_MYSQL_CLIENT_API')) {    $client_api = explode('.', mysqli_get_client_info());    define('PMA_MYSQL_CLIENT_API', (int)sprintf('%d%02d%02d', $client_api[0], $client_api[1], intval($client_api[2])));    unset($client_api);}/** * some PHP versions are reporting extra messages like "No index used in query" */mysqli_report(MYSQLI_REPORT_OFF);/** * some older mysql client libs are missing these constants ... */if (! defined('MYSQLI_BINARY_FLAG')) {   define('MYSQLI_BINARY_FLAG', 128);}/** * @see http://bugs.php.net/36007 */if (! defined('MYSQLI_TYPE_NEWDECIMAL')) {    define('MYSQLI_TYPE_NEWDECIMAL', 246);}if (! defined('MYSQLI_TYPE_BIT')) {    define('MYSQLI_TYPE_BIT', 16);}// for Drizzleif (! defined('MYSQLI_TYPE_VARCHAR')) {    define('MYSQLI_TYPE_VARCHAR', 15);}/** * Helper function for connecting to the database server * * @param   mysqli  $link * @param   string  $host * @param   string  $user * @param   string  $password * @param   string  $dbname * @param   int     $server_port * @param   string  $server_socket * @param   int     $client_flags * @param   bool    $persistent * @return  bool */function PMA_DBI_real_connect($link, $host, $user, $password, $dbname, $server_port, $server_socket, $client_flags = null, $persistent = false){    global $cfg;    // mysqli persistent connections only on PHP 5.3+    if (PMA_PHP_INT_VERSION >= 50300) {        if ($cfg['PersistentConnections'] || $persistent) {            $host = 'p:' . $host;        }    }    if ($client_flags === null) {        return @mysqli_real_connect(            $link,            $host,            $user,            $password,            $dbname,            $server_port,            $server_socket        );    } else {        return @mysqli_real_connect(            $link,            $host,            $user,            $password,            $dbname,            $server_port,            $server_socket,            $client_flags        );    }}/** * connects to the database server * * @param   string  $user           mysql user name * @param   string  $password       mysql user password * @param   bool    $is_controluser * @param   array   $server host/port/socket * @param   bool    $auxiliary_connection (when true, don't go back to login if connection fails) * @return  mixed   false on error or a mysqli object on success */function PMA_DBI_connect($user, $password, $is_controluser = false, $server = null, $auxiliary_connection = false){    global $cfg;    if ($server) {        $server_port   = (empty($server['port']))            ? false            : (int)$server['port'];        $server_socket = (empty($server['socket']))            ? ''            : $server['socket'];        $server['host'] = (empty($server['host']))            ? 'localhost'            : $server['host'];    } else {        $server_port   = (empty($cfg['Server']['port']))            ? false            : (int) $cfg['Server']['port'];        $server_socket = (empty($cfg['Server']['socket']))            ? null            : $cfg['Server']['socket'];    }    // NULL enables connection to the default socket    $link = mysqli_init();    mysqli_options($link, MYSQLI_OPT_LOCAL_INFILE, true);    $client_flags = 0;    /* Optionally compress connection */    if ($cfg['Server']['compress'] && defined('MYSQLI_CLIENT_COMPRESS')) {        $client_flags |= MYSQLI_CLIENT_COMPRESS;    }    /* Optionally enable SSL */    if ($cfg['Server']['ssl'] && defined('MYSQLI_CLIENT_SSL')) {        $client_flags |= MYSQLI_CLIENT_SSL;    }    if (!$server) {        $return_value = @PMA_DBI_real_connect(            $link,            $cfg['Server']['host'],            $user,            $password,            false,            $server_port,            $server_socket,            $client_flags        );        // Retry with empty password if we're allowed to        if ($return_value == false && isset($cfg['Server']['nopassword']) && $cfg['Server']['nopassword'] && !$is_controluser) {            $return_value = @PMA_DBI_real_connect(                $link,                $cfg['Server']['host'],                $user,                '',                false,                $server_port,                $server_socket,                $client_flags            );        }    } else {        $return_value = @PMA_DBI_real_connect(            $link,            $server['host'],            $user,            $password,            false,            $server_port,            $server_socket        );    }    if ($return_value == false) {        if ($is_controluser) {            trigger_error(                __('Connection for controluser as defined in your configuration failed.'),                E_USER_WARNING            );            return false;        }        // we could be calling PMA_DBI_connect() to connect to another        // server, for example in the Synchronize feature, so do not        // go back to main login if it fails        if (! $auxiliary_connection) {            PMA_log_user($user, 'mysql-denied');            PMA_auth_fails();        } else {            return false;        }    } else {        PMA_DBI_postConnect($link, $is_controluser);    }    return $link;}/** * selects given database * * @param string  $dbname  database name to select * @param mysqli  $link    the mysqli object * @return boolean */function PMA_DBI_select_db($dbname, $link = null){    if (empty($link)) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    return mysqli_select_db($link, $dbname);}/** * runs a query and returns the result * * @param   string  $query    query to execute * @param   mysqli  $link     mysqli object * @param   int     $options * @return  mysqli_result|bool */function PMA_DBI_real_query($query, $link, $options){    if ($options == ($options | PMA_DBI_QUERY_STORE)) {        $method = MYSQLI_STORE_RESULT;    } elseif ($options == ($options | PMA_DBI_QUERY_UNBUFFERED)) {        $method = MYSQLI_USE_RESULT;    } else {        $method = 0;    }    return mysqli_query($link, $query, $method);}/** * returns array of rows with associative and numeric keys from $result * * @param   mysqli_result  $result * @return  array */function PMA_DBI_fetch_array($result){    return mysqli_fetch_array($result, MYSQLI_BOTH);}/** * returns array of rows with associative keys from $result * * @param   mysqli_result  $result * @return  array */function PMA_DBI_fetch_assoc($result){    return mysqli_fetch_array($result, MYSQLI_ASSOC);}/** * returns array of rows with numeric keys from $result * * @param   mysqli_result  $result * @return  array */function PMA_DBI_fetch_row($result){    return mysqli_fetch_array($result, MYSQLI_NUM);}/** * Adjusts the result pointer to an arbitrary row in the result * * @param   $result * @param   $offset * @return  bool  true on success, false on failure */function PMA_DBI_data_seek($result, $offset){    return mysqli_data_seek($result, $offset);}/** * Frees memory associated with the result * * @param  mysqli_result  $result */function PMA_DBI_free_result($result){    if ($result instanceof mysqli_result) {        mysqli_free_result($result);    }}/** * Check if there are any more query results from a multi query * * @param   mysqli  $link  the mysqli object * @return  bool         true or false */function PMA_DBI_more_results($link = null){    if (empty($link)) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    return mysqli_more_results($link);}/** * Prepare next result from multi_query * * @param   mysqli  $link  the mysqli object * @return  bool         true or false */function PMA_DBI_next_result($link = null){    if (empty($link)) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    return mysqli_next_result($link);}/** * Returns a string representing the type of connection used * * @param   resource  $link  mysql link * @return  string          type of connection used */function PMA_DBI_get_host_info($link = null){    if (null === $link) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    return mysqli_get_host_info($link);}/** * Returns the version of the MySQL protocol used * * @param   resource  $link  mysql link * @return  integer         version of the MySQL protocol used */function PMA_DBI_get_proto_info($link = null){    if (null === $link) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    return mysqli_get_proto_info($link);}/** * returns a string that represents the client library version * * @return  string          MySQL client library version */function PMA_DBI_get_client_info(){    return mysqli_get_client_info();}/** * returns last error message or false if no errors occured * * @param   resource  $link  mysql link * @return  string|bool  $error or false */function PMA_DBI_getError($link = null){    $GLOBALS['errno'] = 0;    /* Treat false same as null because of controllink */    if ($link === false) {        $link = null;    }    if (null === $link && isset($GLOBALS['userlink'])) {        $link =& $GLOBALS['userlink'];        // Do not stop now. We still can get the error code        // with mysqli_connect_errno()//    } else {//        return false;    }    if (null !== $link) {        $error_number = mysqli_errno($link);        $error_message = mysqli_error($link);    } else {        $error_number = mysqli_connect_errno();        $error_message = mysqli_connect_error();    }    if (0 == $error_number) {        return false;    }    // keep the error number for further check after the call to PMA_DBI_getError()    $GLOBALS['errno'] = $error_number;    return PMA_DBI_formatError($error_number, $error_message);}/** * returns the number of rows returned by last query * * @param   mysqli_result  $result * @return  string|int */function PMA_DBI_num_rows($result){    // see the note for PMA_DBI_try_query();    if (!is_bool($result)) {        return @mysqli_num_rows($result);    } else {        return 0;    }}/** * returns last inserted auto_increment id for given $link or $GLOBALS['userlink'] * * @param   mysqli  $link  the mysqli object * @return  string|int */function PMA_DBI_insert_id($link = null){    if (empty($link)) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    // When no controluser is defined, using mysqli_insert_id($link)    // does not always return the last insert id due to a mixup with    // the tracking mechanism, but this works:    return PMA_DBI_fetch_value('SELECT LAST_INSERT_ID();', 0, 0, $link);    // Curiously, this problem does not happen with the mysql extension but    // there is another problem with BIGINT primary keys so PMA_DBI_insert_id()    // in the mysql extension also uses this logic.}/** * returns the number of rows affected by last query * * @param   mysqli   $link            the mysqli object * @param   boolean  $get_from_cache * @return  string|int */function PMA_DBI_affected_rows($link = null, $get_from_cache = true){    if (empty($link)) {        if (isset($GLOBALS['userlink'])) {            $link = $GLOBALS['userlink'];        } else {            return false;        }    }    if ($get_from_cache) {        return $GLOBALS['cached_affected_rows'];    } else {        return mysqli_affected_rows($link);    }}/** * returns metainfo for fields in $result * * @param   mysqli_result  $result * @return  array  meta info for fields in $result */function PMA_DBI_get_fields_meta($result){    // Build an associative array for a type look up    $typeAr = array();    $typeAr[MYSQLI_TYPE_DECIMAL]     = 'real';    $typeAr[MYSQLI_TYPE_NEWDECIMAL]  = 'real';    $typeAr[MYSQLI_TYPE_BIT]         = 'int';    $typeAr[MYSQLI_TYPE_TINY]        = 'int';    $typeAr[MYSQLI_TYPE_SHORT]       = 'int';    $typeAr[MYSQLI_TYPE_LONG]        = 'int';    $typeAr[MYSQLI_TYPE_FLOAT]       = 'real';    $typeAr[MYSQLI_TYPE_DOUBLE]      = 'real';    $typeAr[MYSQLI_TYPE_NULL]        = 'null';    $typeAr[MYSQLI_TYPE_TIMESTAMP]   = 'timestamp';    $typeAr[MYSQLI_TYPE_LONGLONG]    = 'int';    $typeAr[MYSQLI_TYPE_INT24]       = 'int';    $typeAr[MYSQLI_TYPE_DATE]        = 'date';    $typeAr[MYSQLI_TYPE_TIME]        = 'time';    $typeAr[MYSQLI_TYPE_DATETIME]    = 'datetime';    $typeAr[MYSQLI_TYPE_YEAR]        = 'year';    $typeAr[MYSQLI_TYPE_NEWDATE]     = 'date';    $typeAr[MYSQLI_TYPE_ENUM]        = 'unknown';    $typeAr[MYSQLI_TYPE_SET]         = 'unknown';    $typeAr[MYSQLI_TYPE_TINY_BLOB]   = 'blob';    $typeAr[MYSQLI_TYPE_MEDIUM_BLOB] = 'blob';    $typeAr[MYSQLI_TYPE_LONG_BLOB]   = 'blob';    $typeAr[MYSQLI_TYPE_BLOB]        = 'blob';    $typeAr[MYSQLI_TYPE_VAR_STRING]  = 'string';    $typeAr[MYSQLI_TYPE_STRING]      = 'string';    $typeAr[MYSQLI_TYPE_VARCHAR]     = 'string'; // for Drizzle    // MySQL returns MYSQLI_TYPE_STRING for CHAR    // and MYSQLI_TYPE_CHAR === MYSQLI_TYPE_TINY    // so this would override TINYINT and mark all TINYINT as string    // https://sf.net/tracker/?func=detail&aid=1532111&group_id=23067&atid=377408    //$typeAr[MYSQLI_TYPE_CHAR]        = 'string';    $typeAr[MYSQLI_TYPE_GEOMETRY]    = 'geometry';    $typeAr[MYSQLI_TYPE_BIT]         = 'bit';    $fields = mysqli_fetch_fields($result);    // this happens sometimes (seen under MySQL 4.0.25)    if (!is_array($fields)) {        return false;    }    foreach ($fields as $k => $field) {        $fields[$k]->_type = $field->type;        $fields[$k]->type = $typeAr[$field->type];        $fields[$k]->_flags = $field->flags;        $fields[$k]->flags = PMA_DBI_field_flags($result, $k);        // Enhance the field objects for mysql-extension compatibilty        //$flags = explode(' ', $fields[$k]->flags);        //array_unshift($flags, 'dummy');        $fields[$k]->multiple_key            = (int) (bool) ($fields[$k]->_flags & MYSQLI_MULTIPLE_KEY_FLAG);        $fields[$k]->primary_key            = (int) (bool) ($fields[$k]->_flags & MYSQLI_PRI_KEY_FLAG);        $fields[$k]->unique_key            = (int) (bool) ($fields[$k]->_flags & MYSQLI_UNIQUE_KEY_FLAG);        $fields[$k]->not_null            = (int) (bool) ($fields[$k]->_flags & MYSQLI_NOT_NULL_FLAG);        $fields[$k]->unsigned            = (int) (bool) ($fields[$k]->_flags & MYSQLI_UNSIGNED_FLAG);        $fields[$k]->zerofill            = (int) (bool) ($fields[$k]->_flags & MYSQLI_ZEROFILL_FLAG);        $fields[$k]->numeric            = (int) (bool) ($fields[$k]->_flags & MYSQLI_NUM_FLAG);        $fields[$k]->blob            = (int) (bool) ($fields[$k]->_flags & MYSQLI_BLOB_FLAG);    }    return $fields;}/** * return number of fields in given $result * * @param   mysqli_result  $result * @return  int  field count */function PMA_DBI_num_fields($result){    return mysqli_num_fields($result);}/** * returns the length of the given field $i in $result * * @param   mysqli_result  $result * @param   int            $i       field * @return  int  length of field */function PMA_DBI_field_len($result, $i){    return mysqli_fetch_field_direct($result, $i)->length;}/** * returns name of $i. field in $result * * @param   mysqli_result  $result * @param   int            $i       field * @return  string  name of $i. field in $result */function PMA_DBI_field_name($result, $i){    return mysqli_fetch_field_direct($result, $i)->name;}/** * returns concatenated string of human readable field flags * * @param   mysqli_result  $result * @param   int            $i       field * @return  string  field flags */function PMA_DBI_field_flags($result, $i){    // This is missing from PHP 5.2.5, see http://bugs.php.net/bug.php?id=44846    if (! defined('MYSQLI_ENUM_FLAG')) {        define('MYSQLI_ENUM_FLAG', 256); // see MySQL source include/mysql_com.h    }    $f = mysqli_fetch_field_direct($result, $i);    $type = $f->type;    $charsetnr = $f->charsetnr;    $f = $f->flags;    $flags = '';    if ($f & MYSQLI_UNIQUE_KEY_FLAG) {        $flags .= 'unique ';    }    if ($f & MYSQLI_NUM_FLAG) {        $flags .= 'num ';    }    if ($f & MYSQLI_PART_KEY_FLAG) {        $flags .= 'part_key ';    }    if ($f & MYSQLI_SET_FLAG) {        $flags .= 'set ';    }    if ($f & MYSQLI_TIMESTAMP_FLAG) {        $flags .= 'timestamp ';    }    if ($f & MYSQLI_AUTO_INCREMENT_FLAG) {        $flags .= 'auto_increment ';    }    if ($f & MYSQLI_ENUM_FLAG) {        $flags .= 'enum ';    }    // See http://dev.mysql.com/doc/refman/6.0/en/c-api-datatypes.html:    // to determine if a string is binary, we should not use MYSQLI_BINARY_FLAG    // but instead the charsetnr member of the MYSQL_FIELD    // structure. Watch out: some types like DATE returns 63 in charsetnr    // so we have to check also the type.    // Unfortunately there is no equivalent in the mysql extension.    if (($type == MYSQLI_TYPE_TINY_BLOB || $type == MYSQLI_TYPE_BLOB || $type == MYSQLI_TYPE_MEDIUM_BLOB || $type == MYSQLI_TYPE_LONG_BLOB || $type == MYSQLI_TYPE_VAR_STRING || $type == MYSQLI_TYPE_STRING) && 63 == $charsetnr) {        $flags .= 'binary ';    }    if ($f & MYSQLI_ZEROFILL_FLAG) {        $flags .= 'zerofill ';    }    if ($f & MYSQLI_UNSIGNED_FLAG) {        $flags .= 'unsigned ';    }    if ($f & MYSQLI_BLOB_FLAG) {        $flags .= 'blob ';    }    if ($f & MYSQLI_MULTIPLE_KEY_FLAG) {        $flags .= 'multiple_key ';    }    if ($f & MYSQLI_UNIQUE_KEY_FLAG) {        $flags .= 'unique_key ';    }    if ($f & MYSQLI_PRI_KEY_FLAG) {        $flags .= 'primary_key ';    }    if ($f & MYSQLI_NOT_NULL_FLAG) {        $flags .= 'not_null ';    }    return trim($flags);}?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * query by example the whole database * * @package PhpMyAdmin *//** * requirements */require_once './libraries/common.inc.php';/** * Gets the relation settings */$cfgRelation = PMA_getRelationsParam();/** * A query has been submitted -> (maybe) execute it */$message_to_display = false;if (isset($_REQUEST['submit_sql']) && ! empty($sql_query)) {    if (! preg_match('@^SELECT@i', $sql_query)) {        $message_to_display = true;    } else {        $goto      = 'db_sql.php';        include './sql.php';        exit;    }}$sub_part  = '_qbe';require './libraries/db_common.inc.php';$url_query .= '&amp;goto=db_qbe.php';$url_params['goto'] = 'db_qbe.php';require './libraries/db_info.inc.php';if ($message_to_display) {    PMA_Message::error(__('You have to choose at least one column to display'))->display();}unset($message_to_display);/** * Initialize some variables */$col_cnt = PMA_ifSetOr($_REQUEST['col_cnt'], 3, 'numeric');$add_col = PMA_ifSetOr($_REQUEST['add_col'], 0, 'numeric');$add_row = PMA_ifSetOr($_REQUEST['add_row'], 0, 'numeric');$rows    = PMA_ifSetOr($_REQUEST['rows'],    0, 'numeric');$ins_col = PMA_ifSetOr($_REQUEST['ins_col'], null, 'array');$del_col = PMA_ifSetOr($_REQUEST['del_col'], null, 'array');$prev_criteria = isset($_REQUEST['prev_criteria'])    ? $_REQUEST['prev_criteria']    : array();$criteria = isset($_REQUEST['criteria'])    ? $_REQUEST['criteria']    : array_fill(0, $col_cnt, '');$ins_row = isset($_REQUEST['ins_row'])    ? $_REQUEST['ins_row']    : array_fill(0, $col_cnt, '');$del_row = isset($_REQUEST['del_row'])    ? $_REQUEST['del_row']    : array_fill(0, $col_cnt, '');$and_or_row = isset($_REQUEST['and_or_row'])    ? $_REQUEST['and_or_row']    : array_fill(0, $col_cnt, '');$and_or_col = isset($_REQUEST['and_or_col'])    ? $_REQUEST['and_or_col']    : array_fill(0, $col_cnt, '');// minimum width$form_column_width = 12;$col = max($col_cnt + $add_col, 0);$row = max($rows + $add_row, 0);// The tables list sent by a previously submitted formif (PMA_isValid($_REQUEST['TableList'], 'array')) {    foreach ($_REQUEST['TableList'] as $each_table) {        $tbl_names[$each_table] = ' selected="selected"';    }} // end if// this was a work in progress, deactivated for now//$columns = PMA_DBI_get_columns_full($GLOBALS['db']);//$tables  = PMA_DBI_get_columns_full($GLOBALS['db']);/** * Prepares the form */$tbl_result     = PMA_DBI_query('SHOW TABLES FROM ' . PMA_backquote($db) . ';', null, PMA_DBI_QUERY_STORE);$tbl_result_cnt = PMA_DBI_num_rows($tbl_result);if (0 == $tbl_result_cnt) {    PMA_Message::error(__('No tables found in database.'))->display();    include './libraries/footer.inc.php';    exit;}// The tables list gets from MySQLwhile (list($tbl) = PMA_DBI_fetch_row($tbl_result)) {    $fld_results = PMA_DBI_get_columns($db, $tbl);    if (empty($tbl_names[$tbl]) && !empty($_REQUEST['TableList'])) {        $tbl_names[$tbl] = '';    } else {        $tbl_names[$tbl] = ' selected="selected"';    } //  end if    // The fields list per selected tables    if ($tbl_names[$tbl] == ' selected="selected"') {        $each_table = PMA_backquote($tbl);        $fld[]  = $each_table . '.*';        foreach ($fld_results as $each_field) {            $each_field = $each_table . '.' . PMA_backquote($each_field['Field']);            $fld[] = $each_field;            // increase the width if necessary            $form_column_width = max(strlen($each_field), $form_column_width);        } // end foreach    } // end if} // end whilePMA_DBI_free_result($tbl_result);// largest width found$realwidth = $form_column_width . 'ex';/** * Displays the Query by example form *//** * Enter description here... * * @param array     $columns * @param integer   $column_number * @param string    $selected */function showColumnSelectCell($columns, $column_number, $selected = ''){    ?>    <td align="center">        <select name="Field[<?php echo $column_number; ?>]" size="1">            <option value="">&nbsp;</option>    <?php    foreach ($columns as $column) {        if ($column === $selected) {            $sel = ' selected="selected"';        } else {            $sel = '';        }        echo '<option value="' . htmlspecialchars($column) . '"' . $sel . '>'            . str_replace(' ', '&nbsp;', htmlspecialchars($column)) . '</option>' . "\n";    }    ?>        </select>    </td>    <?php}?><?php if (!empty($tab_designer['link'])) {        $tab_designer['link'] = htmlentities($tab_designer['link']);        $tab_designer['link'] = $tab_designer['link'] . PMA_generate_common_url($url_params);        if (! empty($tab_designer['args'])) {            foreach ($tab_designer['args'] as $param => $value) {                $tab_designer['link'] .= PMA_get_arg_separator('html') . urlencode($param) . '='                    . urlencode($value);            }        }    }    if (! empty($tab['fragment'])) {        $tab['link'] .= $tab['fragment'];    }    if (isset($tab_designer['link'])) {?><div id="visual_builder_anchor" class="notice hide">    <span id="footnote_1"><?php printf(__('Switch to %svisual builder%s'), ' <a href="' . $tab_designer['link'] . PMA_get_arg_separator('html') . 'query=1">', '</a>'); ?>    </span></div><?php    }?><form action="db_qbe.php" method="post"><fieldset><table class="data" style="width: 100%;"><tr class="odd noclick">    <th><?php echo __('Column'); ?>:</th><?php$z = 0;for ($x = 0; $x < $col; $x++) {    if (isset($ins_col[$x]) && $ins_col[$x] == 'on') {        showColumnSelectCell($fld, $z);        $z++;    }    if (! empty($del_col) && isset($del_col[$x]) && $del_col[$x] == 'on') {        continue;    }    $selected = '';    if (isset($Field[$x])) {        $selected = $Field[$x];        $curField[$z] = $Field[$x];    }    showColumnSelectCell($fld, $z, $selected);    $z++;} // end for?></tr><!-- Sort row --><tr class="even noclick">    <th><?php echo __('Sort'); ?>:</th><?php$z = 0;for ($x = 0; $x < $col; $x++) {    if (!empty($ins_col) && isset($ins_col[$x]) && $ins_col[$x] == 'on') {        ?>    <td align="center">        <select style="width: <?php echo $realwidth; ?>" name="Sort[<?php echo $z; ?>]" size="1">            <option value="">&nbsp;</option>            <option value="ASC"><?php echo __('Ascending'); ?></option>            <option value="DESC"><?php echo __('Descending'); ?></option>        </select>    </td>        <?php        $z++;    } // end if    echo "\n";    if (!empty($del_col) && isset($del_col[$x]) && $del_col[$x] == 'on') {        continue;    }    ?>    <td align="center">        <select style="width: <?php echo $realwidth; ?>" name="Sort[<?php echo $z; ?>]" size="1">            <option value="">&nbsp;</option>    <?php    echo "\n";    // If they have chosen all fields using the * selector,    // then sorting is not available    // Fix for Bug #570698    if (isset($Sort[$x]) && isset($Field[$x])     && substr($Field[$x], -2) == '.*') {        $Sort[$x] = '';    } //end if    if (isset($Sort[$x]) && $Sort[$x] == 'ASC') {        $curSort[$z] = $Sort[$x];        $sel         = ' selected="selected"';    } else {        $sel         = '';    } // end if    echo '                ';    echo '<option value="ASC"' . $sel . '>' . __('Ascending') . '</option>' . "\n";    if (isset($Sort[$x]) && $Sort[$x] == 'DESC') {        $curSort[$z] = $Sort[$x];        $sel         = ' selected="selected"';    } else {        $sel         = '';    } // end if    echo '                ';    echo '<option value="DESC"' . $sel . '>' . __('Descending') . '</option>' . "\n";    ?>        </select>    </td>    <?php    $z++;    echo "\n";} // end for?></tr><!-- Show row --><tr class="odd noclick">    <th><?php echo __('Show'); ?>:</th><?php$z = 0;for ($x = 0; $x < $col; $x++) {    if (!empty($ins_col) && isset($ins_col[$x]) && $ins_col[$x] == 'on') {        ?>    <td align="center">        <input type="checkbox" name="Show[<?php echo $z; ?>]" />    </td>        <?php        $z++;    } // end if    echo "\n";    if (!empty($del_col) && isset($del_col[$x]) && $del_col[$x] == 'on') {        continue;    }    if (isset($Show[$x])) {        $checked     = ' checked="checked"';        $curShow[$z] = $Show[$x];    } else {        $checked     =  '';    }    ?>    <td align="center">        <input type="checkbox" name="Show[<?php echo $z; ?>]"<?php echo $checked; ?> />    </td>    <?php    $z++;    echo "\n";} // end for?></tr><!-- Criteria row --><tr class="even noclick">    <th><?php echo __('Criteria'); ?>:</th><?php$z = 0;for ($x = 0; $x < $col; $x++) {    if (!empty($ins_col) && isset($ins_col[$x]) && $ins_col[$x] == 'on') {        ?>    <td align="center">        <input type="text" name="criteria[<?php echo $z; ?>]" value="" class="textfield" style="width: <?php echo $realwidth; ?>" size="20" />    </td>        <?php        $z++;    } // end if    echo "\n";    if (!empty($del_col) && isset($del_col[$x]) && $del_col[$x] == 'on') {        continue;    }    if (isset($criteria[$x])) {        $tmp_criteria = $criteria[$x];    }    if ((empty($prev_criteria) || ! isset($prev_criteria[$x]))        || $prev_criteria[$x] != htmlspecialchars($tmp_criteria)) {        $curCriteria[$z]   = $tmp_criteria;    } else {        $curCriteria[$z]   = $prev_criteria[$x];    }    ?>    <td align="center">        <input type="hidden" name="prev_criteria[<?php echo $z; ?>]" value="<?php echo htmlspecialchars($curCriteria[$z]); ?>" />        <input type="text" name="criteria[<?php echo $z; ?>]" value="<?php echo htmlspecialchars($tmp_criteria); ?>" class="textfield" style="width: <?php echo $realwidth; ?>" size="20" />    </td>    <?php    $z++;    echo "\n";} // end for?></tr><!-- And/Or columns and rows --><?php$w = 0;$odd_row = true;for ($y = 0; $y <= $row; $y++) {    if (isset($ins_row[$y]) && $ins_row[$y] == 'on') {        $chk['or']  = ' checked="checked"';        $chk['and'] = '';        ?><tr class="<?php echo $odd_row ? 'odd' : 'even'; ?> noclick">    <td align="<?php echo $cell_align_right; ?>" nowrap="nowrap">        <!-- Row controls -->        <table cellpadding="0" cellspacing="0" border="0">        <tr>            <td align="<?php echo $cell_align_right; ?>" nowrap="nowrap">                <small><?php echo __('Ins'); ?>:</small>                <input type="checkbox" name="ins_row[<?php echo $w; ?>]" />            </td>            <td align="<?php echo $cell_align_right; ?>">                <strong><?php echo __('And'); ?>:</strong>            </td>            <td>                <input type="radio" name="and_or_row[<?php echo $w; ?>]" value="and"<?php echo $chk['and']; ?> />                &nbsp;            </td>        </tr>        <tr>            <td align="<?php echo $cell_align_right; ?>" nowrap="nowrap">                <small><?php echo __('Del'); ?>:</small>                <input type="checkbox" name="del_row[<?php echo $w; ?>]" />            </td>            <td align="<?php echo $cell_align_right; ?>">                <strong><?php echo __('Or'); ?>:</strong>            </td>            <td>                <input type="radio" name="and_or_row[<?php echo $w; ?>]" value="or"<?php echo $chk['or']; ?> />                &nbsp;            </td>        </tr>        </table>    </td>        <?php        $z = 0;        for ($x = 0; $x < $col; $x++) {            if (isset($ins_col[$x]) && $ins_col[$x] == 'on') {                echo "\n";                $or = 'Or' . $w . '[' . $z . ']';                ?>    <td align="center">        <input type="text" name="Or<?php echo $or; ?>" class="textfield" style="width: <?php echo $realwidth; ?>" size="20" />    </td>                <?php                $z++;            } // end if            if (isset($del_col[$x]) && $del_col[$x] == 'on') {                continue;            }            echo "\n";            $or = 'Or' . $w . '[' . $z . ']';            ?>    <td align="center">        <input type="text" name="Or<?php echo $or; ?>" class="textfield" style="width: <?php echo $realwidth; ?>" size="20" />    </td>            <?php            $z++;        } // end for        $w++;        echo "\n";        ?></tr>        <?php        $odd_row =! $odd_row;    } // end if    if (isset($del_row[$y]) && $del_row[$y] == 'on') {        continue;    }    if (isset($and_or_row[$y])) {        $curAndOrRow[$w] = $and_or_row[$y];    }    if (isset($and_or_row[$y]) && $and_or_row[$y] == 'and') {        $chk['and'] =  ' checked="checked"';        $chk['or']  =  '';    } else {        $chk['or']  =  ' checked="checked"';        $chk['and'] =  '';    }    echo "\n";    ?><tr class="<?php echo $odd_row ? 'odd' : 'even'; ?> noclick">    <td align="<?php echo $cell_align_right; ?>" nowrap="nowrap">        <!-- Row controls -->        <table border="0" cellpadding="0" cellspacing="0">        <tr>            <td align="<?php echo $cell_align_right; ?>" nowrap="nowrap">                <small><?php echo __('Ins'); ?>:</small>                <input type="checkbox" name="ins_row[<?php echo $w; ?>]" />            </td>            <td align="<?php echo $cell_align_right; ?>">                <strong><?php echo __('And'); ?>:</strong>            </td>            <td>                <input type="radio" name="and_or_row[<?php echo $w; ?>]" value="and"<?php echo $chk['and']; ?> />            </td>        </tr>        <tr>            <td align="<?php echo $cell_align_right; ?>" nowrap="nowrap">                <small><?php echo __('Del'); ?>:</small>                <input type="checkbox" name="del_row[<?php echo $w; ?>]" />            </td>            <td align="<?php echo $cell_align_right; ?>">                <strong><?php echo __('Or'); ?>:</strong>            </td>            <td>                <input type="radio" name="and_or_row[<?php echo $w; ?>]" value="or"<?php echo $chk['or']; ?> />            </td>        </tr>        </table>    </td>    <?php    $z = 0;    for ($x = 0; $x < $col; $x++) {        if (!empty($ins_col) && isset($ins_col[$x]) && $ins_col[$x] == 'on') {            echo "\n";            $or = 'Or' . $w . '[' . $z . ']';            ?>    <td align="center">        <input type="text" name="Or<?php echo $or; ?>" class="textfield" style="width: <?php echo $realwidth; ?>" size="20" />    </td>            <?php            $z++;        } // end if        if (!empty($del_col) && isset($del_col[$x]) && $del_col[$x] == 'on') {            continue;        }        echo "\n";        $or = 'Or' . $y;        if (! isset(${$or})) {            ${$or} = '';        }        if (!empty(${$or}) && isset(${$or}[$x])) {            $tmp_or = ${$or}[$x];        } else {            $tmp_or     = '';        }        ?>    <td align="center">        <input type="text" name="Or<?php echo $w . '[' . $z . ']'; ?>" value="<?php echo htmlspecialchars($tmp_or); ?>" class="textfield" style="width: <?php echo $realwidth; ?>" size="20" />    </td>        <?php        if (!empty(${$or}) && isset(${$or}[$x])) {            ${'cur' . $or}[$z] = ${$or}[$x];        }        $z++;    } // end for    $w++;    echo "\n";    ?></tr>    <?php    echo "\n";    $odd_row =! $odd_row;} // end for?><!-- Modify columns --><tr class="even noclick">    <th><?php echo __('Modify'); ?>:</th><?php$z = 0;for ($x = 0; $x < $col; $x++) {    if (!empty($ins_col) && isset($ins_col[$x]) && $ins_col[$x] == 'on') {        $curAndOrCol[$z] = $and_or_col[$y];        if ($and_or_col[$z] == 'or') {            $chk['or']  = ' checked="checked"';            $chk['and'] = '';        } else {            $chk['and'] = ' checked="checked"';            $chk['or']  = '';        }        ?>    <td align="center">        <strong><?php echo __('Or'); ?>:</strong>        <input type="radio" name="and_or_col[<?php echo $z; ?>]" value="or"<?php echo $chk['or']; ?> />        &nbsp;&nbsp;<strong><?php echo __('And'); ?>:</strong>        <input type="radio" name="and_or_col[<?php echo $z; ?>]" value="and"<?php echo $chk['and']; ?> />        <br />        <?php echo __('Ins') . "\n"; ?>        <input type="checkbox" name="ins_col[<?php echo $z; ?>]" />        &nbsp;&nbsp;<?php echo __('Del') . "\n"; ?>        <input type="checkbox" name="del_col[<?php echo $z; ?>]" />    </td>        <?php        $z++;    } // end if    echo "\n";    if (!empty($del_col) && isset($del_col[$x]) && $del_col[$x] == 'on') {        continue;    }    if (isset($and_or_col[$y])) {        $curAndOrCol[$z] = $and_or_col[$y];    }    if (isset($and_or_col[$z]) && $and_or_col[$z] == 'or') {        $chk['or']  = ' checked="checked"';        $chk['and'] = '';    } else {        $chk['and'] = ' checked="checked"';        $chk['or']  = '';    }    ?>    <td align="center">        <strong><?php echo __('Or'); ?>:</strong>        <input type="radio" name="and_or_col[<?php echo $z; ?>]" value="or"<?php echo $chk['or']; ?> />        &nbsp;&nbsp;<strong><?php echo __('And'); ?>:</strong>        <input type="radio" name="and_or_col[<?php echo $z; ?>]" value="and"<?php echo $chk['and']; ?> />        <br />        <?php echo __('Ins') . "\n"; ?>        <input type="checkbox" name="ins_col[<?php echo $z; ?>]" />        &nbsp;&nbsp;<?php echo __('Del') . "\n"; ?>        <input type="checkbox" name="del_col[<?php echo $z; ?>]" />    </td>    <?php    $z++;    echo "\n";} // end for?>    </tr></table><!-- Other controls --><?php$w--;$url_params['db']       = $db;$url_params['col_cnt']  = $z;$url_params['rows']     = $w;echo PMA_generate_common_hidden_inputs($url_params);?></fieldset><fieldset class="tblFooters"><table border="0" cellpadding="2" cellspacing="1"><tr>    <td nowrap="nowrap">        <?php echo __('Add/Delete criteria rows'); ?>:        <select size="1" name="add_row">            <option value="-3">-3</option>            <option value="-2">-2</option>            <option value="-1">-1</option>            <option value="0" selected="selected">0</option>            <option value="1">1</option>            <option value="2">2</option>            <option value="3">3</option>        </select>    </td>    <td width="10">&nbsp;</td>    <td nowrap="nowrap"><?php echo __('Add/Delete columns'); ?>:        <select size="1" name="add_col">            <option value="-3">-3</option>            <option value="-2">-2</option>            <option value="-1">-1</option>            <option value="0" selected="selected">0</option>            <option value="1">1</option>            <option value="2">2</option>            <option value="3">3</option>        </select>    </td>    <td width="10">&nbsp;</td>    <!-- Generates a query -->    <td><input type="submit" name="modify" value="<?php echo __('Update Query'); ?>" /></td></tr></table></fieldset><table><tr><td>        <fieldset>            <legend><?php echo __('Use Tables'); ?></legend><?php$options = '';$numTableListOptions = 0;foreach ($tbl_names as $key => $val) {    $options .= '                        ';    $options .= '<option value="' . htmlspecialchars($key) . '"' . $val . '>'        . str_replace(' ', '&nbsp;', htmlspecialchars($key)) . '</option>' . "\n";    $numTableListOptions++;}?>            <select name="TableList[]" multiple="multiple" id="listTable"                size="<?php echo ($numTableListOptions > 30) ? '15' : '7'; ?>">                <?php echo $options; ?>            </select>        </fieldset>        <fieldset class="tblFooters">            <input type="submit" name="modify" value="<?php echo __('Update Query'); ?>" />        </fieldset>    </td>    <td width="20">&nbsp;</td>    <td>        <fieldset>            <legend><?php echo sprintf(__('SQL query on database <b>%s</b>:'), PMA_getDbLink($db)); ?>                </legend>            <textarea cols="80" name="sql_query" id="textSqlquery"                rows="<?php echo ($numTableListOptions > 30) ? '15' : '7'; ?>"                dir="<?php echo $text_dir; ?>"><?php// 1. SELECT$last_select = 0;if (! isset($qry_select)) {    $qry_select         = '';}for ($x = 0; $x < $col; $x++) {    if (!empty($curField[$x]) && isset($curShow[$x]) && $curShow[$x] == 'on') {        if ($last_select) {            $qry_select .=  ', ';        }        $qry_select     .= $curField[$x];        $last_select    = 1;    }} // end forif (!empty($qry_select)) {    echo  'SELECT ' . htmlspecialchars($qry_select) . "\n";}// 2. FROM// Create LEFT JOINS out of Relations// If we can use Relations we could make some left joins.// First find out if relations are available in this database.// First we need the really needed Tables - those in TableList might still be// all Tables.if (isset($Field) && count($Field) > 0) {    // Initialize some variables    $tab_all    = array();    $col_all    = array();    $tab_wher   = array();    $tab_know   = array();    $tab_left   = array();    $col_where  = array();    $fromclause = '';    // We only start this if we have fields, otherwise it would be dumb    foreach ($Field as $value) {        $parts             = explode('.', $value);        if (!empty($parts[0]) && !empty($parts[1])) {            $tab_raw       = $parts[0];            $tab           = str_replace('`', '', $tab_raw);            $tab_all[$tab] = $tab;            $col_raw       = $parts[1];            $col_all[]     = $tab . '.' . str_replace('`', '', $col_raw);         }    } // end while    // Check 'where' clauses    if ($cfgRelation['relwork'] && count($tab_all) > 0) {        // Now we need all tables that we have in the where clause        $crit_cnt         = count($criteria);        for ($x = 0; $x < $crit_cnt; $x++) {            $curr_tab     = explode('.', $Field[$x]);            if (!empty($curr_tab[0]) && !empty($curr_tab[1])) {                $tab_raw  = $curr_tab[0];                $tab      = str_replace('`', '', $tab_raw);                $col_raw  = $curr_tab[1];                $col1     = str_replace('`', '', $col_raw);                $col1     = $tab . '.' . $col1;                // Now we know that our array has the same numbers as $criteria                // we can check which of our columns has a where clause                if (!empty($criteria[$x])) {                    if (substr($criteria[$x], 0, 1) == '=' || stristr($criteria[$x], 'is')) {                        $col_where[$col] = $col1;                        $tab_wher[$tab]  = $tab;                    }                } // end if            } // end if        } // end for        // Cleans temp vars w/o further use        unset($tab_raw);        unset($col_raw);        unset($col1);        if (count($tab_wher) == 1) {            // If there is exactly one column that has a decent where-clause            // we will just use this            $master = key($tab_wher);        } else {            // Now let's find out which of the tables has an index            // (When the control user is the same as the normal user            // because he is using one of his databases as pmadb,            // the last db selected is not always the one where we need to work)            PMA_DBI_select_db($db);            foreach ($tab_all as $tab) {                $indexes = PMA_DBI_get_table_indexes($db, $tab);                foreach ($indexes as $ind) {                    $col1 = $tab . '.' . $ind['Column_name'];                    if (isset($col_all[$col1])) {                        if ($ind['Non_unique'] == 0) {                            if (isset($col_where[$col1])) {                                $col_unique[$col1] = 'Y';                            } else {                                $col_unique[$col1] = 'N';                            }                        } else {                            if (isset($col_where[$col1])) {                                $col_index[$col1] = 'Y';                            } else {                                $col_index[$col1] = 'N';                            }                        }                    }                } // end while (each col of tab)            } // end while (each tab)            // now we want to find the best.            if (isset($col_unique) && count($col_unique) > 0) {                $col_cand = $col_unique;                $needsort = 1;            } elseif (isset($col_index) && count($col_index) > 0) {                $col_cand = $col_index;                $needsort = 1;            } elseif (isset($col_where) && count($col_where) > 0) {                $col_cand = $tab_wher;                $needsort = 0;            } else {                $col_cand = $tab_all;                $needsort = 0;            }            // If we came up with $col_unique (very good) or $col_index (still            // good) as $col_cand we want to check if we have any 'Y' there            // (that would mean that they were also found in the whereclauses            // which would be great). if yes, we take only those            if ($needsort == 1) {                foreach ($col_cand as $col => $is_where) {                    $tab           = explode('.', $col);                    $tab           = $tab[0];                    if ($is_where == 'Y') {                        $vg[$col]  = $tab;                    } else {                        $sg[$col]  = $tab;                    }                }                if (isset($vg)) {                    $col_cand      = $vg;                    // Candidates restricted in index+where                } else {                    $col_cand      = $sg;                    // None of the candidates where in a where-clause                }            }            // If our array of candidates has more than one member we'll just            // find the smallest table.            // Of course the actual query would be faster if we check for            // the Criteria which gives the smallest result set in its table,            // but it would take too much time to check this            if (count($col_cand) > 1) {                // Of course we only want to check each table once                $checked_tables = $col_cand;                foreach ($col_cand as $tab) {                    if ($checked_tables[$tab] != 1) {                        $tsize[$tab] = PMA_Table::countRecords($db, $tab, false);                        $checked_tables[$tab] = 1;                    }                    $csize[$tab] = $tsize[$tab];                }                asort($csize);                reset($csize);                $master = key($csize); // Smallest            } else {                reset($col_cand);                $master = current($col_cand); // Only one single candidate            }        } // end if (exactly one where clause)        $tab_left = $tab_all;        unset($tab_left[$master]);        $tab_know[$master] = $master;        $run   = 0;        $emerg = '';        while (count($tab_left) > 0) {            if ($run % 2 == 0) {                PMA_getRelatives('master');            } else {                PMA_getRelatives('foreign');            }            $run++;            if ($run > 5) {                foreach ($tab_left as $tab) {                    $emerg .= ', ' . PMA_backquote($tab);                    unset($tab_left[$tab]);                }            }        } // end while        $qry_from = PMA_backquote($master) . $emerg . $fromclause;    } // end if ($cfgRelation['relwork'] && count($tab_all) > 0)} // end count($Field) > 0// In case relations are not defined, just generate the FROM clause// from the list of tables, however we don't generate any JOINif (empty($qry_from) && isset($tab_all)) {    $qry_from = implode(', ', $tab_all);}// Now let's see what we gotif (!empty($qry_from)) {    echo 'FROM ' . htmlspecialchars($qry_from) . "\n";}// 3. WHERE$qry_where          = '';$criteria_cnt       = 0;for ($x = 0; $x < $col; $x++) {    if (!empty($curField[$x]) && !empty($curCriteria[$x]) && $x && isset($last_where) && isset($curAndOrCol)) {        $qry_where  .= ' ' . strtoupper($curAndOrCol[$last_where]) . ' ';    }    if (!empty($curField[$x]) && !empty($curCriteria[$x])) {        $qry_where  .= '(' . $curField[$x] . ' ' . $curCriteria[$x] . ')';        $last_where = $x;        $criteria_cnt++;    }} // end forif ($criteria_cnt > 1) {    $qry_where      = '(' . $qry_where . ')';}// OR rows ${'cur' . $or}[$x]if (! isset($curAndOrRow)) {    $curAndOrRow          = array();}for ($y = 0; $y <= $row; $y++) {    $criteria_cnt         = 0;    $qry_orwhere          = '';    $last_orwhere         = '';    for ($x = 0; $x < $col; $x++) {        if (!empty($curField[$x]) && !empty(${'curOr' . $y}[$x]) && $x) {            $qry_orwhere  .= ' ' . strtoupper($curAndOrCol[$last_orwhere]) . ' ';        }        if (!empty($curField[$x]) && !empty(${'curOr' . $y}[$x])) {            $qry_orwhere  .= '(' . $curField[$x]                          .  ' '                          .  ${'curOr' . $y}[$x]                          .  ')';            $last_orwhere = $x;            $criteria_cnt++;        }    } // end for    if ($criteria_cnt > 1) {        $qry_orwhere      = '(' . $qry_orwhere . ')';    }    if (!empty($qry_orwhere)) {        $qry_where .= "\n"                   .  strtoupper(isset($curAndOrRow[$y]) ? $curAndOrRow[$y] . ' ' : '')                   .  $qry_orwhere;    } // end if} // end forif (!empty($qry_where) && $qry_where != '()') {    echo 'WHERE ' . htmlspecialchars($qry_where) . "\n";} // end if// 4. ORDER BY$last_orderby = 0;if (! isset($qry_orderby)) {    $qry_orderby      = '';}for ($x = 0; $x < $col; $x++) {    if ($last_orderby && $x && !empty($curField[$x]) && !empty($curSort[$x])) {        $qry_orderby  .=  ', ';    }    if (!empty($curField[$x]) && !empty($curSort[$x])) {        // if they have chosen all fields using the * selector,        // then sorting is not available        // Fix for Bug #570698        if (substr($curField[$x], -2) != '.*') {            $qry_orderby  .=  $curField[$x] . ' ' . $curSort[$x];            $last_orderby = 1;        }    }} // end forif (!empty($qry_orderby)) {    echo 'ORDER BY ' . htmlspecialchars($qry_orderby) . "\n";}?>        </textarea>        </fieldset>        <fieldset class="tblFooters">            <input type="submit" name="submit_sql" value="<?php echo __('Submit Query'); ?>" />        </fieldset>    </td></tr></table></form><?php/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'jquery/jquery-ui-1.8.16.custom.js';$GLOBALS['js_include'][] = 'db_structure.js';$GLOBALS['js_include'][] = 'tbl_change.js';$GLOBALS['js_include'][] = 'jquery/timepicker.js';$GLOBALS['js_include'][] = 'jquery/jquery.sprintf.js';/** * Prepares the tables list if the user where not redirected to this script * because there is no table in the database ($is_info is true) */if (empty($is_info)) {    // Drops/deletes/etc. multiple tables if required    if ((!empty($submit_mult) && isset($selected_tbl))        || isset($mult_btn)    ) {        $action = 'db_structure.php';        $err_url = 'db_structure.php?'. PMA_generate_common_url($db);        // see bug #2794840; in this case, code path is:        // db_structure.php -> libraries/mult_submits.inc.php -> sql.php        // -> db_structure.php and if we got an error on the multi submit,        // we must display it here and not call again mult_submits.inc.php        if (! isset($error) || false === $error) {            include './libraries/mult_submits.inc.php';        }        if (empty($message)) {            $message = PMA_Message::success();        }    }    include './libraries/db_common.inc.php';    $url_query .= '&amp;goto=db_structure.php';    // Gets the database structure    $sub_part = '_structure';    include './libraries/db_info.inc.php';    if (!PMA_DRIZZLE) {        include_once './libraries/replication.inc.php';    } else {        $server_slave_status = false;    }}require_once './libraries/bookmark.lib.php';require_once './libraries/mysql_charsets.lib.php';$db_collation = PMA_getDbCollation($db);// in a separate file to avoid redeclaration of functions in some code pathsrequire_once './libraries/db_structure.lib.php';$titles = PMA_buildActionTitles();// 1. No tablesif ($num_tables == 0) {    echo '<p>' . __('No tables found in database') . '</p>' . "\n";    if (empty($db_is_information_schema)) {        include './libraries/display_create_table.lib.php';    } // end if (Create Table dialog)    /**     * Displays the footer     */    include_once './libraries/footer.inc.php';    exit;}// else// 2. Shows table informations/** * Displays the tables list */echo '<div id="tableslistcontainer">';$_url_params = array(    'pos' => $pos,    'db'  => $db);// Add the sort options if they existsif (isset($_REQUEST['sort'])) {    $_url_params['sort'] = $_REQUEST['sort'];}if (isset($_REQUEST['sort_order'])) {    $_url_params['sort_order'] = $_REQUEST['sort_order'];}PMA_listNavigator(    $total_num_tables, $pos, $_url_params, 'db_structure.php',    'frame_content', $GLOBALS['cfg']['MaxTableList']);?><form method="post" action="db_structure.php" name="tablesForm" id="tablesForm"><?phpecho PMA_generate_common_hidden_inputs($db);PMA_TableHeader($db_is_information_schema, $server_slave_status);$i = $sum_entries = 0;$sum_size       = (double) 0;$overhead_size  = (double) 0;$overhead_check = '';$checked        = !empty($checkall) ? ' checked="checked"' : '';$num_columns    = $cfg['PropertiesNumColumns'] > 1    ? ceil($num_tables / $cfg['PropertiesNumColumns']) + 1    : 0;$row_count      = 0;$hidden_fields = array();$odd_row       = true;$sum_row_count_pre = '';$tableReductionCount = 0;   // the amount to reduce the table count byforeach ($tables as $keyname => $each_table) {    if (PMA_BS_IsHiddenTable($keyname)) {        $tableReductionCount++;        continue;    }    // Get valid statistics whatever is the table type    $table_is_view = false;    $table_encoded = urlencode($each_table['TABLE_NAME']);    // Sets parameters for links    $tbl_url_query = $url_query . '&amp;table=' . $table_encoded;    // do not list the previous table's size info for a view    $formatted_size = '-';    $unit = '';    switch ( $each_table['ENGINE']) {        // MyISAM, ISAM or Heap table: Row count, data size and index size        // are accurate; data size is accurate for ARCHIVE    case 'MyISAM' :    case 'ISAM' :    case 'HEAP' :    case 'MEMORY' :    case 'ARCHIVE' :    case 'Aria' :    case 'Maria' :        if ($db_is_information_schema) {            $each_table['Rows'] = PMA_Table::countRecords(                $db, $each_table['Name']            );        }        if ($is_show_stats) {            $tblsize                    =  doubleval($each_table['Data_length']) + doubleval($each_table['Index_length']);            $sum_size                   += $tblsize;            list($formatted_size, $unit) =  PMA_formatByteDown($tblsize, 3, ($tblsize > 0) ? 1 : 0);            if (isset($each_table['Data_free']) && $each_table['Data_free'] > 0) {                list($formatted_overhead, $overhead_unit)     = PMA_formatByteDown($each_table['Data_free'], 3, ($each_table['Data_free'] > 0) ? 1 : 0);                $overhead_size           += $each_table['Data_free'];            }        }        break;    case 'InnoDB' :    case 'PBMS' :        // InnoDB table: Row count is not accurate but data and index sizes are.        // PBMS table in Drizzle: TABLE_ROWS is taken from table cache, so it may be unavailable        if (($each_table['ENGINE'] == 'InnoDB'            && $each_table['TABLE_ROWS'] < $GLOBALS['cfg']['MaxExactCount'])            || !isset($each_table['TABLE_ROWS'])        ) {            $each_table['COUNTED'] = true;            $each_table['TABLE_ROWS'] = PMA_Table::countRecords(                $db, $each_table['TABLE_NAME'],                $force_exact = true, $is_view = false            );        } else {            $each_table['COUNTED'] = false;        }        // Drizzle doesn't provide data and index length, check for null        if ($is_show_stats && $each_table['Data_length'] !== null) {            $tblsize                    =  $each_table['Data_length'] + $each_table['Index_length'];            $sum_size                   += $tblsize;            list($formatted_size, $unit) =  PMA_formatByteDown($tblsize, 3, ($tblsize > 0) ? 1 : 0);        }        //$display_rows                   =  ' - ';        break;    // Mysql 5.0.x (and lower) uses MRG_MyISAM and MySQL 5.1.x (and higher) uses MRG_MYISAM    // Both are aliases for MERGE    case 'MRG_MyISAM' :    case 'MRG_MYISAM' :    case 'MERGE' :    case 'BerkeleyDB' :        // Merge or BerkleyDB table: Only row count is accurate.        if ($is_show_stats) {            $formatted_size =  ' - ';            $unit          =  '';        }        break;        // for a view, the ENGINE is sometimes reported as null,        // or on some servers it's reported as "SYSTEM VIEW"    case null :    case 'SYSTEM VIEW' :    case 'FunctionEngine' :        // if table is broken, Engine is reported as null, so one more test        if ($each_table['TABLE_TYPE'] == 'VIEW') {            // countRecords() takes care of $cfg['MaxExactCountViews']            $each_table['TABLE_ROWS'] = PMA_Table::countRecords(                $db, $each_table['TABLE_NAME'],                $force_exact = true, $is_view = true            );            $table_is_view = true;        }        break;    default :        // Unknown table type.        if ($is_show_stats) {            $formatted_size =  __('unknown');            $unit          =  '';        }    } // end switch    if (! PMA_Table::isMerge($db, $each_table['TABLE_NAME'])) {        $sum_entries += $each_table['TABLE_ROWS'];    }    if (isset($each_table['Collation'])) {        $collation = '<dfn title="'            . PMA_getCollationDescr($each_table['Collation']) . '">'            . $each_table['Collation'] . '</dfn>';    } else {        $collation = '---';    }    if ($is_show_stats) {        if (isset($formatted_overhead)) {            $overhead = '<a href="tbl_structure.php?'                . $tbl_url_query . '#showusage"><span>' . $formatted_overhead                . '</span> <span class="unit">' . $overhead_unit . '</span></a>' . "\n";            unset($formatted_overhead);            $overhead_check .=                "document.getElementById('checkbox_tbl_" . ($i + 1) . "').checked = true;";        } else {            $overhead = '-';        }    } // end if    $alias = (!empty($tooltip_aliasname) && isset($tooltip_aliasname[$each_table['TABLE_NAME']]))               ? str_replace(' ', '&nbsp;', htmlspecialchars($tooltip_truename[$each_table['TABLE_NAME']]))               : str_replace(' ', '&nbsp;', htmlspecialchars($each_table['TABLE_NAME']));    $truename = (!empty($tooltip_truename) && isset($tooltip_truename[$each_table['TABLE_NAME']]))               ? str_replace(' ', '&nbsp;', htmlspecialchars($tooltip_truename[$each_table['TABLE_NAME']]))               : str_replace(' ', '&nbsp;', htmlspecialchars($each_table['TABLE_NAME']));    $i++;    $row_count++;    if ($table_is_view) {        $hidden_fields[] = '<input type="hidden" name="views[]" value="'            .  htmlspecialchars($each_table['TABLE_NAME']) . '" />';    }    /*     * Always activate links for Browse, Search and Empty, even if     * the icons are greyed, because     * 1. for views, we don't know the number of rows at this point     * 2. for tables, another source could have populated them since the     *    page was generated     *     * I could have used the PHP ternary conditional operator but I find     * the code easier to read without this operator.     */    if ($each_table['TABLE_ROWS'] > 0 || $table_is_view) {        $may_have_rows = true;    } else {        $may_have_rows = false;    }    $browse_table = '<a href="sql.php?' . $tbl_url_query . '&amp;pos=0">';    if ($may_have_rows) {        $browse_table .= $titles['Browse'];    } else {        $browse_table .= $titles['NoBrowse'];    }    $browse_table .= '</a>';    $search_table = '<a href="tbl_select.php?' . $tbl_url_query . '">';    if ($may_have_rows) {        $search_table .= $titles['Search'];    } else {        $search_table .= $titles['NoSearch'];    }    $search_table .= '</a>';    $browse_table_label = '<a href="sql.php?' . $tbl_url_query . '&amp;pos=0">' . $truename . '</a>';    if (! $db_is_information_schema) {        $empty_table = '<a ';        if ($GLOBALS['cfg']['AjaxEnable']) {            $empty_table .= 'class="truncate_table_anchor"';        }        $empty_table .= ' href="sql.php?' . $tbl_url_query             . '&amp;sql_query=';        $empty_table .= urlencode('TRUNCATE ' . PMA_backquote($each_table['TABLE_NAME']))             . '&amp;message_to_show='             . urlencode(sprintf(__('Table %s has been emptied'), htmlspecialchars($each_table['TABLE_NAME'])))             .'">';        if ($may_have_rows) {            $empty_table .= $titles['Empty'];        } else {            $empty_table .= $titles['NoEmpty'];        }        $empty_table .= '</a>';        $drop_query = 'DROP '            . ($table_is_view ? 'VIEW' : 'TABLE')            . ' ' . PMA_backquote($each_table['TABLE_NAME']);        $drop_message = sprintf(            $table_is_view ? __('View %s has been dropped') : __('Table %s has been dropped'),            str_replace(' ', '&nbsp;', htmlspecialchars($each_table['TABLE_NAME']))        );    }    $tracking_icon = '';    if (PMA_Tracker::isActive()) {        if (PMA_Tracker::isTracked($GLOBALS["db"], $truename)) {            $tracking_icon = '<a href="tbl_tracking.php?' . $url_query                . '&amp;table=' . $truename . '">'                . PMA_getImage('eye.png', __('Tracking is active.'))                . '</a>';        } elseif (PMA_Tracker::getVersion($GLOBALS["db"], $truename) > 0) {            $tracking_icon = '<a href="tbl_tracking.php?' . $url_query                . '&amp;table=' . $truename . '">'                . PMA_getImage('eye.png', __('Tracking is not active.'))                . '</a>';        }    }    if ($num_columns > 0        && $num_tables > $num_columns        && ($row_count % $num_columns) == 0    ) {        $row_count = 1;        $odd_row = true;        ?>    </tr></tbody></table>        <?php        PMA_TableHeader(false, $server_slave_status);    }    $ignored = false;    $do = false;    if ($server_slave_status) {        ////////////////////////////////////////////////////////////////        if ((strlen(array_search($truename, $server_slave_Do_Table)) > 0)            || (strlen(array_search($db, $server_slave_Do_DB)) > 0)            || (count($server_slave_Do_DB) == 1 && count($server_slave_Ignore_DB) == 1)        ) {            $do = true;        }        foreach ($server_slave_Wild_Do_Table as $db_table) {            $table_part = PMA_extract_db_or_table($db_table, 'table');            if (($db == PMA_extract_db_or_table($db_table, 'db'))                && (preg_match("@^" . substr($table_part, 0, strlen($table_part) - 1) . "@", $truename))            ) {                $do = true;            }        }        ////////////////////////////////////////////////////////////////////        if ((strlen(array_search($truename, $server_slave_Ignore_Table)) > 0)            || (strlen(array_search($db, $server_slave_Ignore_DB)) > 0)        ) {            $ignored = true;        }        foreach ($server_slave_Wild_Ignore_Table as $db_table) {            $table_part = PMA_extract_db_or_table($db_table, 'table');            if (($db == PMA_extract_db_or_table($db_table))                && (preg_match("@^" . substr($table_part, 0, strlen($table_part) - 1) . "@", $truename))            ) {                $ignored = true;            }        }        unset($table_part);    }    ?><tr class="<?php echo $odd_row ? 'odd' : 'even'; $odd_row = ! $odd_row; ?>">    <td align="center">        <input type="checkbox" name="selected_tbl[]"            value="<?php echo htmlspecialchars($each_table['TABLE_NAME']); ?>"            id="checkbox_tbl_<?php echo $i; ?>"<?php echo $checked; ?> /></td>    <th><?php echo $browse_table_label; ?>        <?php echo (! empty($tracking_icon) ? $tracking_icon : ''); ?>    </th>   <?php if ($server_slave_status) { ?><td align="center"><?php        echo $ignored            ? PMA_getImage('s_cancel.png', 'NOT REPLICATED')            : ''.        $do            ? PMA_getImage('s_success.png', 'REPLICATED')            : ''; ?></td><?php } ?>    <td align="center"><?php echo $browse_table; ?></td>    <td align="center">        <a href="tbl_structure.php?<?php echo $tbl_url_query; ?>">            <?php echo $titles['Structure']; ?></a></td>    <td align="center"><?php echo $search_table; ?></td>    <?php if (! $db_is_information_schema) { ?>    <td align="center" class="insert_table">        <a <?php echo ($GLOBALS['cfg']['AjaxEnable'] ? 'class="ajax"' : ''); ?> href="tbl_change.php?<?php echo $tbl_url_query; ?>">            <?php echo $titles['Insert']; ?></a></td>    <td align="center"><?php echo $empty_table; ?></td>    <td align="center">    <a <?php echo ($GLOBALS['cfg']['AjaxEnable'] ? 'class="drop_table_anchor"' : ''); ?> href="sql.php?<?php echo $tbl_url_query;            ?>&amp;reload=1&amp;purge=1&amp;sql_query=<?php            echo urlencode($drop_query); ?>&amp;message_to_show=<?php            echo urlencode($drop_message); ?>" >            <?php echo $titles['Drop']; ?></a></td>    <?php } // end if (! $db_is_information_schema)    // there is a null value in the ENGINE    // - when the table needs to be repaired, or    // - when it's a view    //  so ensure that we'll display "in use" below for a table    //  that needs to be repaired    if (isset($each_table['TABLE_ROWS']) && ($each_table['ENGINE'] != null || $table_is_view)) {        $row_count_pre = '';        $show_superscript = '';        if ($table_is_view) {            // Drizzle views use FunctionEngine, and the only place where they are available are I_S and D_D            // schemas, where we do exact counting            if ($each_table['TABLE_ROWS'] >= $GLOBALS['cfg']['MaxExactCountViews']                && $each_table['ENGINE'] != 'FunctionEngine'            ) {                $row_count_pre = '~';                $sum_row_count_pre = '~';                $show_superscript = PMA_showHint(                    PMA_sanitize(                        sprintf(                            __('This view has at least this number of rows. Please refer to %sdocumentation%s.'),                            '[a@./Documentation.html#cfg_MaxExactCountViews@_blank]',                            '[/a]'                        )                    )                );            }        } elseif ($each_table['ENGINE'] == 'InnoDB' && (! $each_table['COUNTED'])) {            // InnoDB table: we did not get an accurate row count            $row_count_pre = '~';            $sum_row_count_pre = '~';            $show_superscript = '';        }    ?>    <td class="value tbl_rows"><?php echo $row_count_pre . PMA_formatNumber($each_table['TABLE_ROWS'], 0) . $show_superscript; ?></td>        <?php if (!($cfg['PropertiesNumColumns'] > 1)) { ?>    <td nowrap="nowrap"><?php echo ($table_is_view ? __('View') : $each_table['ENGINE']); ?></td>            <?php if (isset($collation)) { ?>    <td nowrap="nowrap"><?php echo $collation ?></td>            <?php } ?>        <?php } ?>        <?php if ($is_show_stats) { ?>    <td class="value tbl_size"><a        href="tbl_structure.php?<?php echo $tbl_url_query; ?>#showusage"        ><?php echo '<span>' . $formatted_size . '</span> <span class="unit">' . $unit . '</span>'; ?></a></td>    <td class="value tbl_overhead"><?php echo $overhead; ?></td>        <?php } // end if ?>    <?php } elseif ($table_is_view) { ?>    <td class="value">-</td>    <td><?php echo __('View'); ?></td>    <td>---</td>        <?php if ($is_show_stats) { ?>    <td class="value">-</td>    <td class="value">-</td>        <?php } ?>    <?php } else { ?>    <td colspan="<?php echo ($colspan_for_structure - ($db_is_information_schema ? 5 : 8)) ?>"        align="center">        <?php echo __('in use'); ?></td>    <?php } // end if (isset($each_table['TABLE_ROWS'])) else ?></tr>    <?php} // end foreach// Show Summaryif ($is_show_stats) {    list($sum_formatted, $unit) = PMA_formatByteDown($sum_size, 3, 1);    list($overhead_formatted, $overhead_unit)        = PMA_formatByteDown($overhead_size, 3, 1);}?></tbody><tbody id="tbl_summary_row"><tr><th></th>    <th align="center" nowrap="nowrap" class="tbl_num">        <?php            // for blobstreaming - if the number of tables is 0, set tableReductionCount to 0            // (we don't want negative numbers here)            if ($num_tables == 0) {                $tableReductionCount = 0;            }            echo sprintf(                _ngettext('%s table', '%s tables', $num_tables - $tableReductionCount),                PMA_formatNumber($num_tables - $tableReductionCount, 0)            );        ?>    </th>    <?php        if ($server_slave_status) {            echo '    <th>' . __('Replication') . '</th>' . "\n";        }    ?>    <th colspan="<?php echo ($db_is_information_schema ? 3 : 6) ?>" align="center">        <?php echo __('Sum'); ?></th>    <th class="value tbl_rows"><?php echo $sum_row_count_pre . PMA_formatNumber($sum_entries, 0); ?></th><?phpif (!($cfg['PropertiesNumColumns'] > 1)) {    $default_engine = PMA_DBI_fetch_value('SHOW VARIABLES LIKE \'storage_engine\';', 0, 1);    echo '    <th align="center">' . "\n"       . '        <dfn title="'       . sprintf(__('%s is the default storage engine on this MySQL server.'), $default_engine)       . '">' .$default_engine . '</dfn></th>' . "\n";    // we got a case where $db_collation was empty    echo '    <th align="center">' . "\n";    if (! empty($db_collation)) {        echo '        <dfn title="'            . PMA_getCollationDescr($db_collation) . ' (' . __('Default') . ')">' . $db_collation            . '</dfn>';    }    echo '</th>';}if ($is_show_stats) {    ?>    <th class="value tbl_size"><?php echo $sum_formatted . ' ' . $unit; ?></th>    <th class="value tbl_overhead"><?php echo $overhead_formatted . ' ' . $overhead_unit; ?></th>    <?php}?></tr></tbody></table><div class="clearfloat"><?php// Check all tables url$checkall_url = 'db_structure.php?' . PMA_generate_common_url($db);?><img class="selectallarrow" src="<?php echo $pmaThemeImage .'arrow_'.$text_dir.'.png'; ?>"    width="38" height="22" alt="<?php echo __('With selected:'); ?>" /><a href="<?php echo $checkall_url; ?>&amp;checkall=1"    onclick="if (markAllRows('tablesForm')) return false;">    <?php echo __('Check All'); ?></a>/<a href="<?php echo $checkall_url; ?>"    onclick="if (unMarkAllRows('tablesForm')) return false;">    <?php echo __('Uncheck All'); ?></a><?php if ($overhead_check != '') { ?>/<a href="#" onclick="unMarkAllRows('tablesForm');    <?php echo $overhead_check; ?> return false;">    <?php echo __('Check tables having overhead'); ?></a><?php } ?><select name="submit_mult" class="autosubmit" style="margin: 0 3em 0 3em;"><?phpecho '    <option value="' . __('With selected:') . '" selected="selected">'     . __('With selected:') . '</option>' . "\n";echo '    <option value="export" >'     . __('Export') . '</option>' . "\n";echo '    <option value="print" >'    . __('Print view') . '</option>' . "\n";if (!$db_is_information_schema && !$cfg['DisableMultiTableMaintenance']) {    echo '    <option value="empty_tbl" >'         . __('Empty') . '</option>' . "\n";    echo '    <option value="drop_tbl" >'         . __('Drop') . '</option>' . "\n";    echo '    <option value="check_tbl" >'         . __('Check table') . '</option>' . "\n";    if (!PMA_DRIZZLE) {        echo '    <option value="optimize_tbl" >'             . __('Optimize table') . '</option>' . "\n";        echo '    <option value="repair_tbl" >'             . __('Repair table') . '</option>' . "\n";    }    echo '    <option value="analyze_tbl" >'         . __('Analyze table') . '</option>' . "\n";    echo '    <option value="add_prefix_tbl" >'         . __('Add prefix to table') . '</option>' . "\n";    echo '    <option value="replace_prefix_tbl" >'         . __('Replace table prefix') . '</option>' . "\n";    echo '    <option value="copy_tbl_change_prefix" >'         . __('Copy table with prefix') . '</option>' . "\n";}?></select><script type="text/javascript"><!--// Fake js to allow the use of the <noscript> tag//--></script><noscript>    <input type="submit" value="<?php echo __('Go'); ?>" /></noscript><?php echo implode("\n", $hidden_fields) . "\n"; ?></div></form><?php// display again the table list navigatorPMA_listNavigator(    $total_num_tables, $pos, $_url_params, 'db_structure.php',    'frame_content', $GLOBALS['cfg']['MaxTableList']);?></div><hr /><?php/** * Work on the database *//* DATABASE WORK *//* Printable view of a table */echo '<p>';echo '<a href="db_printview.php?' . $url_query . '">';echo PMA_getIcon('b_print.png', __('Print view'), true) . '</a>';echo '<a href="./db_datadict.php?' . $url_query . '">';echo PMA_getIcon('b_tblanalyse.png', __('Data Dictionary'), true) . '</a>';echo '</p>';if (empty($db_is_information_schema)) {    include './libraries/display_create_table.lib.php';} // end if (Create Table dialog)/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * displays status variables with descriptions and some hints an optmizing *  + reset status variables * * @package PhpMyAdmin *//** * no need for variables importing * @ignore */if (! defined('PMA_NO_VARIABLES_IMPORT')) {    define('PMA_NO_VARIABLES_IMPORT', true);}if (isset($_REQUEST['ajax_request']) && $_REQUEST['ajax_request'] == true) {    $GLOBALS['is_header_sent'] = true;}require_once './libraries/common.inc.php';/** * Ajax request */if (isset($_REQUEST['ajax_request']) && $_REQUEST['ajax_request'] == true) {    // Send with correct charset    header('Content-Type: text/html; charset=UTF-8');    // real-time charting data    if (isset($_REQUEST['chart_data'])) {        switch($_REQUEST['type']) {        // Process and Connections realtime chart        case 'proc':            $c = PMA_DBI_fetch_result("SHOW GLOBAL STATUS WHERE Variable_name = 'Connections'", 0, 1);            $result = PMA_DBI_query('SHOW PROCESSLIST');            $num_procs = PMA_DBI_num_rows($result);            $ret = array(                'x'      => microtime(true) * 1000,                'y_proc' => $num_procs,                'y_conn' => $c['Connections']            );            exit(json_encode($ret));        // Query realtime chart        case 'queries':            if (PMA_DRIZZLE) {                $sql = "SELECT concat('Com_', variable_name), variable_value                    FROM data_dictionary.GLOBAL_STATEMENTS                    WHERE variable_value > 0                      UNION                    SELECT variable_name, variable_value                    FROM data_dictionary.GLOBAL_STATUS                    WHERE variable_name = 'Questions'";                $queries = PMA_DBI_fetch_result($sql, 0, 1);            } else {                $queries = PMA_DBI_fetch_result(                    "SHOW GLOBAL STATUS                    WHERE (Variable_name LIKE 'Com_%' OR Variable_name = 'Questions')                        AND Value > 0", 0, 1                );            }            cleanDeprecated($queries);            // admin commands are not queries            unset($queries['Com_admin_commands']);            $questions = $queries['Questions'];            unset($queries['Questions']);            //$sum=array_sum($queries);            $ret = array(                'x'         => microtime(true) * 1000,                'y'         => $questions,                'pointInfo' => $queries            );            exit(json_encode($ret));        // Traffic realtime chart        case 'traffic':            $traffic = PMA_DBI_fetch_result(                "SHOW GLOBAL STATUS                WHERE Variable_name = 'Bytes_received'                    OR Variable_name = 'Bytes_sent'", 0, 1            );            $ret = array(                'x'          => microtime(true) * 1000,                'y_sent'     => $traffic['Bytes_sent'],                'y_received' => $traffic['Bytes_received']            );            exit(json_encode($ret));        // Data for the monitor        case 'chartgrid':            $ret = json_decode($_REQUEST['requiredData'], true);            $statusVars = array();            $serverVars = array();            $sysinfo = $cpuload = $memory = 0;            $pName = '';            /* Accumulate all required variables and data */            // For each chart            foreach ($ret as $chart_id => $chartNodes) {                // For each data series                foreach ($chartNodes as $node_id => $nodeDataPoints) {                    // For each data point in the series (usually just 1)                    foreach ($nodeDataPoints as $point_id => $dataPoint) {                        $pName = $dataPoint['name'];                        switch ($dataPoint['type']) {                        /* We only collect the status and server variables here to                         * read them all in one query, and only afterwards assign them.                         * Also do some white list filtering on the names                        */                        case 'servervar':                            if (!preg_match('/[^a-zA-Z_]+/', $pName)) {                                $serverVars[] = $pName;                            }                            break;                        case 'statusvar':                            if (!preg_match('/[^a-zA-Z_]+/', $pName)) {                                $statusVars[] = $pName;                            }                            break;                        case 'proc':                            $result = PMA_DBI_query('SHOW PROCESSLIST');                            $ret[$chart_id][$node_id][$point_id]['value'] = PMA_DBI_num_rows($result);                            break;                        case 'cpu':                            if (!$sysinfo) {                                include_once 'libraries/sysinfo.lib.php';                                $sysinfo = getSysInfo();                            }                            if (!$cpuload) {                                $cpuload = $sysinfo->loadavg();                            }                            if (PHP_OS == 'Linux') {                                $ret[$chart_id][$node_id][$point_id]['idle'] = $cpuload['idle'];                                $ret[$chart_id][$node_id][$point_id]['busy'] = $cpuload['busy'];                            } else                                $ret[$chart_id][$node_id][$point_id]['value'] = $cpuload['loadavg'];                            break;                        case 'memory':                            if (!$sysinfo) {                                include_once 'libraries/sysinfo.lib.php';                                $sysinfo = getSysInfo();                            }                            if (!$memory) {                                $memory  = $sysinfo->memory();                            }                            $ret[$chart_id][$node_id][$point_id]['value'] = $memory[$pName];                            break;                        } /* switch */                    } /* foreach */                } /* foreach */            } /* foreach */            // Retrieve all required status variables            if (count($statusVars)) {                $statusVarValues = PMA_DBI_fetch_result(                    "SHOW GLOBAL STATUS                    WHERE Variable_name='" . implode("' OR Variable_name='", $statusVars) . "'", 0, 1                );            } else {                $statusVarValues = array();            }            // Retrieve all required server variables            if (count($serverVars)) {                $serverVarValues = PMA_DBI_fetch_result(                    "SHOW GLOBAL VARIABLES                    WHERE Variable_name='" . implode("' OR Variable_name='", $serverVars) . "'", 0, 1                );            } else {                $serverVarValues = array();            }            // ...and now assign them            foreach ($ret as $chart_id => $chartNodes) {                foreach ($chartNodes as $node_id => $nodeDataPoints) {                    foreach ($nodeDataPoints as $point_id => $dataPoint) {                        switch($dataPoint['type']) {                        case 'statusvar':                            $ret[$chart_id][$node_id][$point_id]['value'] = $statusVarValues[$dataPoint['name']];                            break;                        case 'servervar':                            $ret[$chart_id][$node_id][$point_id]['value'] = $serverVarValues[$dataPoint['name']];                            break;                        }                    }                }            }            $ret['x'] = microtime(true) * 1000;            exit(json_encode($ret));        }    }    if (isset($_REQUEST['log_data'])) {        if (PMA_MYSQL_INT_VERSION < 50106) {            /* FIXME: why this? */            exit('""');        }        $start = intval($_REQUEST['time_start']);        $end = intval($_REQUEST['time_end']);        if ($_REQUEST['type'] == 'slow') {            $q = 'SELECT start_time, user_host, Sec_to_Time(Sum(Time_to_Sec(query_time))) as query_time, Sec_to_Time(Sum(Time_to_Sec(lock_time))) as lock_time, '.                 'SUM(rows_sent) AS rows_sent, SUM(rows_examined) AS rows_examined, db, sql_text, COUNT(sql_text) AS \'#\' '.                 'FROM `mysql`.`slow_log` WHERE start_time > FROM_UNIXTIME(' . $start . ') '.                 'AND start_time < FROM_UNIXTIME(' . $end . ') GROUP BY sql_text';            $result = PMA_DBI_try_query($q);            $return = array('rows' => array(), 'sum' => array());            $type = '';            while ($row = PMA_DBI_fetch_assoc($result)) {                $type = strtolower(substr($row['sql_text'], 0, strpos($row['sql_text'], ' ')));                switch($type) {                case 'insert':                case 'update':                    // Cut off big inserts and updates, but append byte count therefor                    if (strlen($row['sql_text']) > 220) {                        $row['sql_text'] = substr($row['sql_text'], 0, 200)                            . '... ['                            .  implode(' ', PMA_formatByteDown(strlen($row['sql_text']), 2, 2))                            . ']';                    }                    break;                default:                    break;                }                if (!isset($return['sum'][$type])) {                    $return['sum'][$type] = 0;                }                $return['sum'][$type] += $row['#'];                $return['rows'][] = $row;            }            $return['sum']['TOTAL'] = array_sum($return['sum']);            $return['numRows'] = count($return['rows']);            PMA_DBI_free_result($result);            exit(json_encode($return));        }        if ($_REQUEST['type'] == 'general') {            $limitTypes = (isset($_REQUEST['limitTypes']) && $_REQUEST['limitTypes'])                            ? 'AND argument REGEXP \'^(INSERT|SELECT|UPDATE|DELETE)\' ' : '';            $q = 'SELECT TIME(event_time) as event_time, user_host, thread_id, server_id, argument, count(argument) as \'#\' '.                 'FROM `mysql`.`general_log` WHERE command_type=\'Query\' '.                 'AND event_time > FROM_UNIXTIME(' . $start . ') AND event_time < FROM_UNIXTIME(' . $end . ') '.                 $limitTypes . 'GROUP by argument'; // HAVING count > 1';            $result = PMA_DBI_try_query($q);            $return = array('rows' => array(), 'sum' => array());            $type = '';            $insertTables = array();            $insertTablesFirst = -1;            $i = 0;            $removeVars = isset($_REQUEST['removeVariables']) && $_REQUEST['removeVariables'];            while ($row = PMA_DBI_fetch_assoc($result)) {                preg_match('/^(\w+)\s/', $row['argument'], $match);                $type = strtolower($match[1]);                if (!isset($return['sum'][$type])) {                    $return['sum'][$type] = 0;                }                $return['sum'][$type] += $row['#'];                switch($type) {                case 'insert':                    // Group inserts if selected                    if ($removeVars && preg_match('/^INSERT INTO (`|\'|"|)([^\s\\1]+)\\1/i', $row['argument'], $matches)) {                        $insertTables[$matches[2]]++;                        if ($insertTables[$matches[2]] > 1) {                            $return['rows'][$insertTablesFirst]['#'] = $insertTables[$matches[2]];                            // Add a ... to the end of this query to indicate that there's been other queries                            if ($return['rows'][$insertTablesFirst]['argument'][strlen($return['rows'][$insertTablesFirst]['argument'])-1] != '.') {                                $return['rows'][$insertTablesFirst]['argument'] .= '<br/>...';                            }                            // Group this value, thus do not add to the result list                            continue 2;                        } else {                            $insertTablesFirst = $i;                            $insertTables[$matches[2]] += $row['#'] - 1;                        }                    }                    // No break here                case 'update':                    // Cut off big inserts and updates, but append byte count therefor                    if (strlen($row['argument']) > 220) {                        $row['argument'] = substr($row['argument'], 0, 200)                            . '... ['                            .  implode(' ', PMA_formatByteDown(strlen($row['argument'])), 2, 2)                            . ']';                    }                    break;                default:                    break;                }                $return['rows'][] = $row;                $i++;            }            $return['sum']['TOTAL'] = array_sum($return['sum']);            $return['numRows'] = count($return['rows']);            PMA_DBI_free_result($result);            exit(json_encode($return));        }    }    if (isset($_REQUEST['logging_vars'])) {        if (isset($_REQUEST['varName']) && isset($_REQUEST['varValue'])) {            $value = PMA_sqlAddslashes($_REQUEST['varValue']);            if (!is_numeric($value)) {                $value="'" . $value . "'";            }            if (! preg_match("/[^a-zA-Z0-9_]+/", $_REQUEST['varName'])) {                PMA_DBI_query('SET GLOBAL ' . $_REQUEST['varName'] . ' = ' . $value);            }        }        $loggingVars = PMA_DBI_fetch_result('SHOW GLOBAL VARIABLES WHERE Variable_name IN ("general_log","slow_query_log","long_query_time","log_output")', 0, 1);        exit(json_encode($loggingVars));    }    if (isset($_REQUEST['query_analyzer'])) {        $return = array();        if (strlen($_REQUEST['database'])) {            PMA_DBI_select_db($_REQUEST['database']);        }        if ($profiling = PMA_profilingSupported()) {            PMA_DBI_query('SET PROFILING=1;');        }        // Do not cache query        $query = preg_replace('/^(\s*SELECT)/i', '\\1 SQL_NO_CACHE', $_REQUEST['query']);        $result = PMA_DBI_try_query($query);        $return['affectedRows'] = $GLOBALS['cached_affected_rows'];        $result = PMA_DBI_try_query('EXPLAIN ' . $query);        while ($row = PMA_DBI_fetch_assoc($result)) {            $return['explain'][] = $row;        }        // In case an error happened        $return['error'] = PMA_DBI_getError();        PMA_DBI_free_result($result);        if ($profiling) {            $return['profiling'] = array();            $result = PMA_DBI_try_query('SELECT seq,state,duration FROM INFORMATION_SCHEMA.PROFILING WHERE QUERY_ID=1 ORDER BY seq');            while ($row = PMA_DBI_fetch_assoc($result)) {                $return['profiling'][]= $row;            }            PMA_DBI_free_result($result);        }        exit(json_encode($return));    }    if (isset($_REQUEST['advisor'])) {        include 'libraries/Advisor.class.php';        $advisor = new Advisor();        exit(json_encode($advisor->run()));    }}/** * Replication library */if (PMA_DRIZZLE) {    $server_master_status = false;    $server_slave_status = false;} else {    include_once './libraries/replication.inc.php';    include_once './libraries/replication_gui.lib.php';}/** * JS Includes */$GLOBALS['js_include'][] = 'server_status.js';$GLOBALS['js_include'][] = 'jquery/jquery-ui-1.8.16.custom.js';$GLOBALS['js_include'][] = 'jquery/jquery.tablesorter.js';$GLOBALS['js_include'][] = 'jquery/jquery.cookie.js'; // For tab persistence// Charting$GLOBALS['js_include'][] = 'highcharts/highcharts.js';/* Files required for chart exporting */$GLOBALS['js_include'][] = 'highcharts/exporting.js';/* < IE 9 doesn't support canvas natively */if (PMA_USR_BROWSER_AGENT == 'IE' && PMA_USR_BROWSER_VER < 9) {    $GLOBALS['js_include'][] = 'canvg/flashcanvas.js';}$GLOBALS['js_include'][] = 'canvg/canvg.js';/** * flush status variables if requested */if (isset($_REQUEST['flush'])) {    $_flush_commands = array(        'STATUS',        'TABLES',        'QUERY CACHE',    );    if (in_array($_REQUEST['flush'], $_flush_commands)) {        PMA_DBI_query('FLUSH ' . $_REQUEST['flush'] . ';');    }    unset($_flush_commands);}/** * Kills a selected process */if (!empty($_REQUEST['kill'])) {    if (PMA_DBI_try_query('KILL ' . $_REQUEST['kill'] . ';')) {        $message = PMA_Message::success(__('Thread %s was successfully killed.'));    } else {        $message = PMA_Message::error(__('phpMyAdmin was unable to kill thread %s. It probably has already been closed.'));    }    $message->addParam($_REQUEST['kill']);    //$message->display();}/** * get status from server */$server_status = PMA_DBI_fetch_result('SHOW GLOBAL STATUS', 0, 1);if (PMA_DRIZZLE) {    // Drizzle doesn't put query statistics into variables, add it    $sql = "SELECT concat('Com_', variable_name), variable_value        FROM data_dictionary.GLOBAL_STATEMENTS";    $statements = PMA_DBI_fetch_result($sql, 0, 1);    $server_status = array_merge($server_status, $statements);}/** * for some calculations we require also some server settings */$server_variables = PMA_DBI_fetch_result('SHOW GLOBAL VARIABLES', 0, 1);/** * cleanup of some deprecated values */cleanDeprecated($server_status);/** * calculate some values */// Key_buffer_fractionif (isset($server_status['Key_blocks_unused'])    && isset($server_variables['key_cache_block_size'])    && isset($server_variables['key_buffer_size'])) {    $server_status['Key_buffer_fraction_%']        = 100        - $server_status['Key_blocks_unused']        * $server_variables['key_cache_block_size']        / $server_variables['key_buffer_size']        * 100;} elseif (isset($server_status['Key_blocks_used'])        && isset($server_variables['key_buffer_size'])) {    $server_status['Key_buffer_fraction_%']        = $server_status['Key_blocks_used']        * 1024        / $server_variables['key_buffer_size'];}// Ratio for key read/writeif (isset($server_status['Key_writes'])    && isset($server_status['Key_write_requests'])    && $server_status['Key_write_requests'] > 0) {    $server_status['Key_write_ratio_%'] = 100 * $server_status['Key_writes'] / $server_status['Key_write_requests'];}if (isset($server_status['Key_reads'])    && isset($server_status['Key_read_requests'])    && $server_status['Key_read_requests'] > 0) {    $server_status['Key_read_ratio_%'] = 100 * $server_status['Key_reads'] / $server_status['Key_read_requests'];}// Threads_cache_hitrateif (isset($server_status['Threads_created'])    && isset($server_status['Connections'])    && $server_status['Connections'] > 0) {    $server_status['Threads_cache_hitrate_%']        = 100 - $server_status['Threads_created'] / $server_status['Connections'] * 100;}/** * split variables in sections */$allocations = array(    // variable name => section    // variable names match when they begin with the given string    'Com_'              => 'com',    'Innodb_'           => 'innodb',    'Ndb_'              => 'ndb',    'Handler_'          => 'handler',    'Qcache_'           => 'qcache',    'Threads_'          => 'threads',    'Slow_launch_threads' => 'threads',    'Binlog_cache_'     => 'binlog_cache',    'Created_tmp_'      => 'created_tmp',    'Key_'              => 'key',    'Delayed_'          => 'delayed',    'Not_flushed_delayed_rows' => 'delayed',    'Flush_commands'    => 'query',    'Last_query_cost'   => 'query',    'Slow_queries'      => 'query',    'Queries'           => 'query',    'Prepared_stmt_count' => 'query',    'Select_'           => 'select',    'Sort_'             => 'sort',    'Open_tables'       => 'table',    'Opened_tables'     => 'table',    'Open_table_definitions' => 'table',    'Opened_table_definitions' => 'table',    'Table_locks_'      => 'table',    'Rpl_status'        => 'repl',    'Slave_'            => 'repl',    'Tc_'               => 'tc',    'Ssl_'              => 'ssl',    'Open_files'        => 'files',    'Open_streams'      => 'files',    'Opened_files'      => 'files',);$sections = array(    // section => section name (description)    'com'           => 'Com',    'query'         => __('SQL query'),    'innodb'        => 'InnoDB',    'ndb'           => 'NDB',    'handler'       => __('Handler'),    'qcache'        => __('Query cache'),    'threads'       => __('Threads'),    'binlog_cache'  => __('Binary log'),    'created_tmp'   => __('Temporary data'),    'delayed'       => __('Delayed inserts'),    'key'           => __('Key cache'),    'select'        => __('Joins'),    'repl'          => __('Replication'),    'sort'          => __('Sorting'),    'table'         => __('Tables'),    'tc'            => __('Transaction coordinator'),    'files'         => __('Files'),    'ssl'           => 'SSL',    'other'         => __('Other'));/** * define some needfull links/commands */// variable or section name => (name => url)$links = array();$links['table'][__('Flush (close) all tables')]    = $PMA_PHP_SELF . '?flush=TABLES&amp;' . PMA_generate_common_url();$links['table'][__('Show open tables')]    = 'sql.php?sql_query=' . urlencode('SHOW OPEN TABLES') .        '&amp;goto=server_status.php&amp;' . PMA_generate_common_url();if ($server_master_status) {    $links['repl'][__('Show slave hosts')]        = 'sql.php?sql_query=' . urlencode('SHOW SLAVE HOSTS') .            '&amp;goto=server_status.php&amp;' . PMA_generate_common_url();    $links['repl'][__('Show master status')] = '#replication_master';}if ($server_slave_status) {    $links['repl'][__('Show slave status')] = '#replication_slave';}$links['repl']['doc'] = 'replication';$links['qcache'][__('Flush query cache')]    = $PMA_PHP_SELF . '?flush=' . urlencode('QUERY CACHE') . '&amp;' .        PMA_generate_common_url();$links['qcache']['doc'] = 'query_cache';//$links['threads'][__('Show processes')]//    = 'server_processlist.php?' . PMA_generate_common_url();$links['threads']['doc'] = 'mysql_threads';$links['key']['doc'] = 'myisam_key_cache';$links['binlog_cache']['doc'] = 'binary_log';$links['Slow_queries']['doc'] = 'slow_query_log';$links['innodb'][__('Variables')]    = 'server_engines.php?engine=InnoDB&amp;' . PMA_generate_common_url();$links['innodb'][__('InnoDB Status')]    = 'server_engines.php?engine=InnoDB&amp;page=Status&amp;' .        PMA_generate_common_url();$links['innodb']['doc'] = 'innodb';// Variable to contain all com_ variables (query statistics)$used_queries = array();// Variable to map variable names to their respective section name// (used for js category filtering)$allocationMap = array();// Variable to mark used sections$categoryUsed = array();// sort vars into arraysforeach ($server_status as $name => $value) {    $section_found = false;    foreach ($allocations as $filter => $section) {        if (strpos($name, $filter) !== false) {            $allocationMap[$name] = $section;            $categoryUsed[$section] = true;            $section_found = true;            if ($section == 'com' && $value > 0) {                $used_queries[$name] = $value;            }            break; // Only exits inner loop        }    }    if (!$section_found) {        $allocationMap[$name] = 'other';        $categoryUsed['other'] = true;    }}if (PMA_DRIZZLE) {    $used_queries = PMA_DBI_fetch_result(        'SELECT * FROM data_dictionary.global_statements',        0,        1    );    unset($used_queries['admin_commands']);} else {    // admin commands are not queries (e.g. they include COM_PING,    // which is excluded from $server_status['Questions'])    unset($used_queries['Com_admin_commands']);}/* Ajax request refresh */if (isset($_REQUEST['show']) && isset($_REQUEST['ajax_request'])) {    switch($_REQUEST['show']) {    case 'query_statistics':        printQueryStatistics();        exit();    case 'server_traffic':        printServerTraffic();        exit();    case 'variables_table':        // Prints the variables table        printVariablesTable();        exit();    default:        break;    }}$server_db_isLocal = strtolower($cfg['Server']['host']) == 'localhost'                              || $cfg['Server']['host'] == '127.0.0.1'                              || $cfg['Server']['host'] == '::1';PMA_AddJSVar(    'pma_token',    $_SESSION[' PMA_token ']);PMA_AddJSVar(    'url_query',    str_replace('&amp;', '&', PMA_generate_common_url($db)));PMA_AddJSVar(    'server_time_diff',    'new Date().getTime() - ' . (microtime(true) * 1000),    false);PMA_AddJSVar(    'server_os',    PHP_OS);PMA_AddJSVar(    'is_superuser',    PMA_isSuperuser());PMA_AddJSVar(    'server_db_isLocal',    $server_db_isLocal);PMA_AddJSVar(    'profiling_docu',    PMA_showMySQLDocu('general-thread-states', 'general-thread-states'));PMA_AddJSVar(    'explain_docu',    PMA_showMySQLDocu('explain-output', 'explain-output'));/** * start output */ /** * Does the common work */require './libraries/server_common.inc.php';/** * Displays the links */require './libraries/server_links.inc.php';?><div id="serverstatus">    <h2><?php/** * Displays the sub-page heading */if ($GLOBALS['cfg']['MainPageIconic']) {    echo PMA_getImage('s_status.png');}echo __('Runtime Information');?></h2>    <div id="serverStatusTabs">        <ul>            <li><a href="#statustabs_traffic"><?php echo __('Server'); ?></a></li>            <li><a href="#statustabs_queries"><?php echo __('Query statistics'); ?></a></li>            <li><a href="#statustabs_allvars"><?php echo __('All status variables'); ?></a></li>            <li class="jsfeature"><a href="#statustabs_charting"><?php echo __('Monitor'); ?></a></li>            <li class="jsfeature"><a href="#statustabs_advisor"><?php echo __('Advisor'); ?></a></li>        </ul>        <div id="statustabs_traffic" class="clearfloat">            <div class="buttonlinks jsfeature">                <a class="tabRefresh" href="<?php echo $PMA_PHP_SELF . '?show=server_traffic&amp;' . PMA_generate_common_url(); ?>" >                    <img src="<?php echo $GLOBALS['pmaThemeImage'];?>ajax_clock_small.gif" alt="ajax clock" style="display: none;" />                    <?php echo __('Refresh'); ?>                </a>                <span class="refreshList" style="display:none;">                    <label for="id_trafficChartRefresh"><?php echo __('Refresh rate: '); ?></label>                    <?php refreshList('trafficChartRefresh'); ?>                </span>                <a class="tabChart livetrafficLink" href="#">                    <?php echo __('Live traffic chart'); ?>                </a>                <a class="tabChart liveconnectionsLink" href="#">                    <?php echo __('Live conn./process chart'); ?>                </a>            </div>            <div class="tabInnerContent">                <?php printServerTraffic(); ?>            </div>        </div>        <div id="statustabs_queries" class="clearfloat">            <div class="buttonlinks jsfeature">                <a class="tabRefresh"  href="<?php echo $PMA_PHP_SELF . '?show=query_statistics&amp;' . PMA_generate_common_url(); ?>" >                    <img src="<?php echo $GLOBALS['pmaThemeImage'];?>ajax_clock_small.gif" alt="ajax clock" style="display: none;" />                    <?php echo __('Refresh'); ?>                </a>                <span class="refreshList" style="display:none;">                    <label for="id_queryChartRefresh"><?php echo __('Refresh rate: '); ?></label>                       <?php refreshList('queryChartRefresh'); ?>                </span>                <a class="tabChart livequeriesLink" href="#">                    <?php echo __('Live query chart'); ?>                </a>            </div>            <div class="tabInnerContent">                <?php printQueryStatistics(); ?>            </div>        </div>        <div id="statustabs_allvars" class="clearfloat">            <fieldset id="tableFilter" class="jsfeature">                <div class="buttonlinks">                    <a class="tabRefresh" href="<?php echo $PMA_PHP_SELF . '?show=variables_table&amp;' . PMA_generate_common_url(); ?>" >                        <img src="<?php echo $GLOBALS['pmaThemeImage'];?>ajax_clock_small.gif" alt="ajax clock" style="display: none;" />                        <?php echo __('Refresh'); ?>                    </a>                </div>                <legend><?php echo __('Filters'); ?></legend>                <div class="formelement">                    <label for="filterText"><?php echo __('Containing the word:'); ?></label>                    <input name="filterText" type="text" id="filterText" style="vertical-align: baseline;" />                </div>                <div class="formelement">                    <input type="checkbox" name="filterAlert" id="filterAlert" />                    <label for="filterAlert"><?php echo __('Show only alert values'); ?></label>                </div>                <div class="formelement">                    <select id="filterCategory" name="filterCategory">                        <option value=''><?php echo __('Filter by category...'); ?></option>                <?php                        foreach ($sections as $section_id => $section_name) {                            if (isset($categoryUsed[$section_id])) {                ?>                                <option value='<?php echo $section_id; ?>'><?php echo $section_name; ?></option>                <?php                            }                        }                ?>                    </select>                </div>                <div class="formelement">                    <input type="checkbox" name="dontFormat" id="dontFormat" />                    <label for="dontFormat"><?php echo __('Show unformatted values'); ?></label>                </div>            </fieldset>            <div id="linkSuggestions" class="defaultLinks" style="display:none">                <p class="notice"><?php echo __('Related links:'); ?>                <?php                foreach ($links as $section_name => $section_links) {                    echo '<span class="status_' . $section_name . '"> ';                    $i=0;                    foreach ($section_links as $link_name => $link_url) {                        if ($i > 0) {                            echo ', ';                        }                        if ('doc' == $link_name) {                            echo PMA_showMySQLDocu($link_url, $link_url);                        } else {                            echo '<a href="' . $link_url . '">' . $link_name . '</a>';                        }                        $i++;                    }                    echo '</span>';                }                unset($link_url, $link_name, $i);                ?>                </p>            </div>            <div class="tabInnerContent">                <?php printVariablesTable(); ?>            </div>        </div>        <div id="statustabs_charting" class="jsfeature">            <?php printMonitor(); ?>        </div>        <div id="statustabs_advisor" class="jsfeature">            <div class="tabLinks">                <?php echo PMA_getImage('play.png'); ?> <a href="#startAnalyzer"><?php echo __('Run analyzer'); ?></a>                <?php echo PMA_getImage('b_help.png'); ?> <a href="#openAdvisorInstructions"><?php echo __('Instructions'); ?></a>            </div>            <div class="tabInnerContent clearfloat">            </div>            <div id="advisorInstructionsDialog" style="display:none;">            <?php            echo '<p>';            echo __('The Advisor system can provide recommendations on server variables by analyzing the server status variables.');            echo '</p> <p>';            echo __('Do note however that this system provides recommendations based on simple calculations and by rule of thumb which may not necessarily apply to your system.');            echo '</p> <p>';            echo __('Prior to changing any of the configuration, be sure to know what you are changing (by reading the documentation) and how to undo the change. Wrong tuning can have a very negative effect on performance.');            echo '</p> <p>';            echo __('The best way to tune your system would be to change only one setting at a time, observe or benchmark your database, and undo the change if there was no clearly measurable improvement.');            echo '</p>';            ?>            </div>        </div>    </div></div><?phpfunction printQueryStatistics(){    global $server_status, $used_queries, $url_query, $PMA_PHP_SELF;    $hour_factor   = 3600 / $server_status['Uptime'];    $total_queries = array_sum($used_queries);    ?>    <h3 id="serverstatusqueries">        <?php        /* l10n: Questions is the name of a MySQL Status variable */        echo sprintf(__('Questions since startup: %s'), PMA_formatNumber($total_queries, 0)) . ' ';        echo PMA_showMySQLDocu('server-status-variables', 'server-status-variables', false, 'statvar_Questions');        ?>        <br />        <span>        <?php        echo '&oslash; ' . __('per hour') . ': ';        echo PMA_formatNumber($total_queries * $hour_factor, 0);        echo '<br />';        echo '&oslash; ' . __('per minute') . ': ';        echo PMA_formatNumber($total_queries * 60 / $server_status['Uptime'], 0);        echo '<br />';        if ($total_queries / $server_status['Uptime'] >= 1) {            echo '&oslash; ' . __('per second') . ': ';            echo PMA_formatNumber($total_queries / $server_status['Uptime'], 0);        }        ?>        </span>    </h3>    <?php    // reverse sort by value to show most used statements first    arsort($used_queries);    $odd_row        = true;    $count_displayed_rows = 0;    $perc_factor    = 100 / $total_queries; //(- $server_status['Connections']);    ?>        <table id="serverstatusqueriesdetails" class="data sortable noclick">        <col class="namecol" />        <col class="valuecol" span="3" />        <thead>            <tr><th><?php echo __('Statements'); ?></th>                <th><?php                    /* l10n: # = Amount of queries */                    echo __('#');                    ?>                </th>                <th>&oslash; <?php echo __('per hour'); ?></th>                <th>%</th>            </tr>        </thead>        <tbody>    <?php    $chart_json = array();    $query_sum = array_sum($used_queries);    $other_sum = 0;    foreach ($used_queries as $name => $value) {        $odd_row = !$odd_row;        // For the percentage column, use Questions - Connections, because        // the number of connections is not an item of the Query types        // but is included in Questions. Then the total of the percentages is 100.        $name = str_replace(array('Com_', '_'), array('', ' '), $name);        // Group together values that make out less than 2% into "Other", but only if we have more than 6 fractions already        if ($value < $query_sum * 0.02 && count($chart_json)>6) {            $other_sum += $value;        } else {            $chart_json[$name] = $value;        }    ?>            <tr class="<?php echo $odd_row ? 'odd' : 'even'; ?>">                <th class="name"><?php echo htmlspecialchars($name); ?></th>                <td class="value"><?php echo htmlspecialchars(PMA_formatNumber($value, 5, 0, true)); ?></td>                <td class="value"><?php echo                    htmlspecialchars(PMA_formatNumber($value * $hour_factor, 4, 1, true)); ?></td>                <td class="value"><?php echo                    htmlspecialchars(PMA_formatNumber($value * $perc_factor, 0, 2)); ?>%</td>            </tr>    <?php    }    ?>        </tbody>        </table>        <div id="serverstatusquerieschart">            <span style="display:none;">        <?php            if ($other_sum > 0) {                $chart_json[__('Other')] = $other_sum;            }            echo json_encode($chart_json);        ?>            </span>        </div>        <?php}function printServerTraffic(){    global $server_status, $PMA_PHP_SELF;    global $server_master_status, $server_slave_status, $replication_types;    $hour_factor    = 3600 / $server_status['Uptime'];    /**     * starttime calculation     */    $start_time = PMA_DBI_fetch_value(        'SELECT UNIX_TIMESTAMP() - ' . $server_status['Uptime']    );    ?>    <h3><?php    echo sprintf(        __('Network traffic since startup: %s'),        implode(' ', PMA_formatByteDown($server_status['Bytes_received'] + $server_status['Bytes_sent'], 3, 1))    );    ?>    </h3>    <p>    <?php    echo sprintf(        __('This MySQL server has been running for %1$s. It started up on %2$s.'),        PMA_timespanFormat($server_status['Uptime']),        PMA_localisedDate($start_time)    ) . "\n";    ?>    </p>    <?php    if ($server_master_status || $server_slave_status) {        echo '<p class="notice">';        if ($server_master_status && $server_slave_status) {            echo __('This MySQL server works as <b>master</b> and <b>slave</b> in <b>replication</b> process.');        } elseif ($server_master_status) {            echo __('This MySQL server works as <b>master</b> in <b>replication</b> process.');        } elseif ($server_slave_status) {            echo __('This MySQL server works as <b>slave</b> in <b>replication</b> process.');        }        echo ' ';        echo __('For further information about replication status on the server, please visit the <a href="#replication">replication section</a>.');        echo '</p>';    }    /* if the server works as master or slave in replication process, display useful information */    if ($server_master_status || $server_slave_status) {    ?>      <hr class="clearfloat" />      <h3><a name="replication"></a><?php echo __('Replication status'); ?></h3>    <?php        foreach ($replication_types as $type) {            if (${"server_{$type}_status"}) {                PMA_replication_print_status_table($type);            }        }        unset($types);    }    ?>    <table id="serverstatustraffic" class="data noclick">    <thead>    <tr>        <th colspan="2"><?php echo __('Traffic') . '&nbsp;' . PMA_showHint(__('On a busy server, the byte counters may overrun, so those statistics as reported by the MySQL server may be incorrect.')); ?></th>        <th>&oslash; <?php echo __('per hour'); ?></th>    </tr>    </thead>    <tbody>    <tr class="odd">        <th class="name"><?php echo __('Received'); ?></th>        <td class="value"><?php echo            implode(' ',                PMA_formatByteDown($server_status['Bytes_received'], 3, 1)); ?></td>        <td class="value"><?php echo            implode(' ',                PMA_formatByteDown(                    $server_status['Bytes_received'] * $hour_factor, 3, 1)); ?></td>    </tr>    <tr class="even">        <th class="name"><?php echo __('Sent'); ?></th>        <td class="value"><?php echo            implode(' ',                PMA_formatByteDown($server_status['Bytes_sent'], 3, 1)); ?></td>        <td class="value"><?php echo            implode(' ',                PMA_formatByteDown(                    $server_status['Bytes_sent'] * $hour_factor, 3, 1)); ?></td>    </tr>    <tr class="odd">        <th class="name"><?php echo __('Total'); ?></th>        <td class="value"><?php echo            implode(' ',                PMA_formatByteDown(                    $server_status['Bytes_received'] + $server_status['Bytes_sent'], 3, 1)            ); ?></td>        <td class="value"><?php echo            implode(' ',                PMA_formatByteDown(                    ($server_status['Bytes_received'] + $server_status['Bytes_sent'])                    * $hour_factor, 3, 1)            ); ?></td>    </tr>    </tbody>    </table>    <table id="serverstatusconnections" class="data noclick">    <thead>    <tr>        <th colspan="2"><?php echo __('Connections'); ?></th>        <th>&oslash; <?php echo __('per hour'); ?></th>        <th>%</th>    </tr>    </thead>    <tbody>    <tr class="odd">        <th class="name"><?php echo __('max. concurrent connections'); ?></th>        <td class="value"><?php echo            PMA_formatNumber($server_status['Max_used_connections'], 0); ?>  </td>        <td class="value">--- </td>        <td class="value">--- </td>    </tr>    <tr class="even">        <th class="name"><?php echo __('Failed attempts'); ?></th>        <td class="value"><?php echo            PMA_formatNumber($server_status['Aborted_connects'], 4, 1, true); ?></td>        <td class="value"><?php echo            PMA_formatNumber($server_status['Aborted_connects'] * $hour_factor,                4, 2, true); ?></td>        <td class="value"><?php echo            $server_status['Connections'] > 0          ? PMA_formatNumber(                $server_status['Aborted_connects'] * 100 / $server_status['Connections'],                0, 2, true) . '%'          : '--- '; ?></td>    </tr>    <tr class="odd">        <th class="name"><?php echo __('Aborted'); ?></th>        <td class="value"><?php echo            PMA_formatNumber($server_status['Aborted_clients'], 4, 1, true); ?></td>        <td class="value"><?php echo            PMA_formatNumber($server_status['Aborted_clients'] * $hour_factor,                4, 2, true); ?></td>        <td class="value"><?php echo            $server_status['Connections'] > 0          ? PMA_formatNumber(                $server_status['Aborted_clients'] * 100 / $server_status['Connections'],                0, 2, true) . '%'          : '--- '; ?></td>    </tr>    <tr class="even">        <th class="name"><?php echo __('Total'); ?></th>        <td class="value"><?php echo            PMA_formatNumber($server_status['Connections'], 4, 0); ?></td>        <td class="value"><?php echo            PMA_formatNumber($server_status['Connections'] * $hour_factor,                4, 2); ?></td>        <td class="value"><?php echo            PMA_formatNumber(100, 0, 2); ?>%</td>    </tr>    </tbody>    </table>    <?php    $url_params = array();    $show_full_sql = !empty($_REQUEST['full']);    if ($show_full_sql) {        $url_params['full'] = 1;        $full_text_link = 'server_status.php' . PMA_generate_common_url(array(), 'html', '?');    } else {        $full_text_link = 'server_status.php' . PMA_generate_common_url(array('full' => 1));    }    if (PMA_DRIZZLE) {        $sql_query = "SELECT                p.id       AS Id,                p.username AS User,                p.host     AS Host,                p.db       AS db,                p.command  AS Command,                p.time     AS Time,                p.state    AS State,                " . ($show_full_sql ? 's.query' : 'left(p.info, ' . (int)$GLOBALS['cfg']['MaxCharactersInDisplayedSQL'] . ')') . " AS Info            FROM data_dictionary.PROCESSLIST p                " . ($show_full_sql ? 'LEFT JOIN data_dictionary.SESSIONS s ON s.session_id = p.id' : '');    } else {        $sql_query = $show_full_sql            ? 'SHOW FULL PROCESSLIST'            : 'SHOW PROCESSLIST';    }    $result = PMA_DBI_query($sql_query);    /**     * Displays the page     */    ?>    <table id="tableprocesslist" class="data clearfloat noclick">    <thead>    <tr>        <th><?php echo __('Processes'); ?></th>        <th><?php echo __('ID'); ?></th>        <th><?php echo __('User'); ?></th>        <th><?php echo __('Host'); ?></th>        <th><?php echo __('Database'); ?></th>        <th><?php echo __('Command'); ?></th>        <th><?php echo __('Time'); ?></th>        <th><?php echo __('Status'); ?></th>        <th><?php            echo __('SQL query');            if (! PMA_DRIZZLE) {                ?>            <a href="<?php echo $full_text_link; ?>"                title="<?php echo $show_full_sql ? __('Truncate Shown Queries') : __('Show Full Queries'); ?>">                <img src="<?php echo $GLOBALS['pmaThemeImage'] . 's_' . ($show_full_sql ? 'partial' : 'full'); ?>text.png"                alt="<?php echo $show_full_sql ? __('Truncate Shown Queries') : __('Show Full Queries'); ?>" />            </a>            <?php } ?>        </th>    </tr>    </thead>    <tbody>    <?php    $odd_row = true;    while ($process = PMA_DBI_fetch_assoc($result)) {        $url_params['kill'] = $process['Id'];        $kill_process = 'server_status.php' . PMA_generate_common_url($url_params);        ?>    <tr class="<?php echo $odd_row ? 'odd' : 'even'; ?>">        <td><a href="<?php echo $kill_process ; ?>"><?php echo __('Kill'); ?></a></td>        <td class="value"><?php echo $process['Id']; ?></td>        <td><?php echo $process['User']; ?></td>        <td><?php echo $process['Host']; ?></td>        <td><?php echo ((! isset($process['db']) || ! strlen($process['db'])) ? '<i>' . __('None') . '</i>' : $process['db']); ?></td>        <td><?php echo $process['Command']; ?></td>        <td class="value"><?php echo $process['Time']; ?></td>        <td><?php echo (empty($process['State']) ? '---' : $process['State']); ?></td>        <td>        <?php        if (empty($process['Info'])) {            echo '---';        } else {            if (!$show_full_sql && strlen($process['Info']) > $GLOBALS['cfg']['MaxCharactersInDisplayedSQL']) {                echo htmlspecialchars(substr($process['Info'], 0, $GLOBALS['cfg']['MaxCharactersInDisplayedSQL'])) . '[...]';            } else {                echo PMA_SQP_formatHtml(PMA_SQP_parse($process['Info']));            }        }        ?>        </td>    </tr>        <?php        $odd_row = ! $odd_row;    }    ?>    </tbody>    </table>    <?php}function printVariablesTable(){    global $server_status, $server_variables, $allocationMap, $links;    /**     * Messages are built using the message name     */    $strShowStatus = array(        'Aborted_clients' => __('The number of connections that were aborted because the client died without closing the connection properly.'),        'Aborted_connects' => __('The number of failed attempts to connect to the MySQL server.'),        'Binlog_cache_disk_use' => __('The number of transactions that used the temporary binary log cache but that exceeded the value of binlog_cache_size and used a temporary file to store statements from the transaction.'),        'Binlog_cache_use' => __('The number of transactions that used the temporary binary log cache.'),        'Connections' => __('The number of connection attempts (successful or not) to the MySQL server.'),        'Created_tmp_disk_tables' => __('The number of temporary tables on disk created automatically by the server while executing statements. If Created_tmp_disk_tables is big, you may want to increase the tmp_table_size  value to cause temporary tables to be memory-based instead of disk-based.'),        'Created_tmp_files' => __('How many temporary files mysqld has created.'),        'Created_tmp_tables' => __('The number of in-memory temporary tables created automatically by the server while executing statements.'),        'Delayed_errors' => __('The number of rows written with INSERT DELAYED for which some error occurred (probably duplicate key).'),        'Delayed_insert_threads' => __('The number of INSERT DELAYED handler threads in use. Every different table on which one uses INSERT DELAYED gets its own thread.'),        'Delayed_writes' => __('The number of INSERT DELAYED rows written.'),        'Flush_commands'  => __('The number of executed FLUSH statements.'),        'Handler_commit' => __('The number of internal COMMIT statements.'),        'Handler_delete' => __('The number of times a row was deleted from a table.'),        'Handler_discover' => __('The MySQL server can ask the NDB Cluster storage engine if it knows about a table with a given name. This is called discovery. Handler_discover indicates the number of time tables have been discovered.'),        'Handler_read_first' => __('The number of times the first entry was read from an index. If this is high, it suggests that the server is doing a lot of full index scans; for example, SELECT col1 FROM foo, assuming that col1 is indexed.'),        'Handler_read_key' => __('The number of requests to read a row based on a key. If this is high, it is a good indication that your queries and tables are properly indexed.'),        'Handler_read_next' => __('The number of requests to read the next row in key order. This is incremented if you are querying an index column with a range constraint or if you are doing an index scan.'),        'Handler_read_prev' => __('The number of requests to read the previous row in key order. This read method is mainly used to optimize ORDER BY ... DESC.'),        'Handler_read_rnd' => __('The number of requests to read a row based on a fixed position. This is high if you are doing a lot of queries that require sorting of the result. You probably have a lot of queries that require MySQL to scan whole tables or you have joins that don\'t use keys properly.'),        'Handler_read_rnd_next' => __('The number of requests to read the next row in the data file. This is high if you are doing a lot of table scans. Generally this suggests that your tables are not properly indexed or that your queries are not written to take advantage of the indexes you have.'),        'Handler_rollback' => __('The number of internal ROLLBACK statements.'),        'Handler_update' => __('The number of requests to update a row in a table.'),        'Handler_write' => __('The number of requests to insert a row in a table.'),        'Innodb_buffer_pool_pages_data' => __('The number of pages containing data (dirty or clean).'),        'Innodb_buffer_pool_pages_dirty' => __('The number of pages currently dirty.'),        'Innodb_buffer_pool_pages_flushed' => __('The number of buffer pool pages that have been requested to be flushed.'),        'Innodb_buffer_pool_pages_free' => __('The number of free pages.'),        'Innodb_buffer_pool_pages_latched' => __('The number of latched pages in InnoDB buffer pool. These are pages currently being read or written or that can\'t be flushed or removed for some other reason.'),        'Innodb_buffer_pool_pages_misc' => __('The number of pages busy because they have been allocated for administrative overhead such as row locks or the adaptive hash index. This value can also be calculated as Innodb_buffer_pool_pages_total - Innodb_buffer_pool_pages_free - Innodb_buffer_pool_pages_data.'),        'Innodb_buffer_pool_pages_total' => __('Total size of buffer pool, in pages.'),        'Innodb_buffer_pool_read_ahead_rnd' => __('The number of "random" read-aheads InnoDB initiated. This happens when a query is to scan a large portion of a table but in random order.'),        'Innodb_buffer_pool_read_ahead_seq' => __('The number of sequential read-aheads InnoDB initiated. This happens when InnoDB does a sequential full table scan.'),        'Innodb_buffer_pool_read_requests' => __('The number of logical read requests InnoDB has done.'),        'Innodb_buffer_pool_reads' => __('The number of logical reads that InnoDB could not satisfy from buffer pool and had to do a single-page read.'),        'Innodb_buffer_pool_wait_free' => __('Normally, writes to the InnoDB buffer pool happen in the background. However, if it\'s necessary to read or create a page and no clean pages are available, it\'s necessary to wait for pages to be flushed first. This counter counts instances of these waits. If the buffer pool size was set properly, this value should be small.'),        'Innodb_buffer_pool_write_requests' => __('The number writes done to the InnoDB buffer pool.'),        'Innodb_data_fsyncs' => __('The number of fsync() operations so far.'),        'Innodb_data_pending_fsyncs' => __('The current number of pending fsync() operations.'),        'Innodb_data_pending_reads' => __('The current number of pending reads.'),        'Innodb_data_pending_writes' => __('The current number of pending writes.'),        'Innodb_data_read' => __('The amount of data read so far, in bytes.'),        'Innodb_data_reads' => __('The total number of data reads.'),        'Innodb_data_writes' => __('The total number of data writes.'),        'Innodb_data_written' => __('The amount of data written so far, in bytes.'),        'Innodb_dblwr_pages_written' => __('The number of pages that have been written for doublewrite operations.'),        'Innodb_dblwr_writes' => __('The number of doublewrite operations that have been performed.'),        'Innodb_log_waits' => __('The number of waits we had because log buffer was too small and we had to wait for it to be flushed before continuing.'),        'Innodb_log_write_requests' => __('The number of log write requests.'),        'Innodb_log_writes' => __('The number of physical writes to the log file.'),        'Innodb_os_log_fsyncs' => __('The number of fsync() writes done to the log file.'),        'Innodb_os_log_pending_fsyncs' => __('The number of pending log file fsyncs.'),        'Innodb_os_log_pending_writes' => __('Pending log file writes.'),        'Innodb_os_log_written' => __('The number of bytes written to the log file.'),        'Innodb_pages_created' => __('The number of pages created.'),        'Innodb_page_size' => __('The compiled-in InnoDB page size (default 16KB). Many values are counted in pages; the page size allows them to be easily converted to bytes.'),        'Innodb_pages_read' => __('The number of pages read.'),        'Innodb_pages_written' => __('The number of pages written.'),        'Innodb_row_lock_current_waits' => __('The number of row locks currently being waited for.'),        'Innodb_row_lock_time_avg' => __('The average time to acquire a row lock, in milliseconds.'),        'Innodb_row_lock_time' => __('The total time spent in acquiring row locks, in milliseconds.'),        'Innodb_row_lock_time_max' => __('The maximum time to acquire a row lock, in milliseconds.'),        'Innodb_row_lock_waits' => __('The number of times a row lock had to be waited for.'),        'Innodb_rows_deleted' => __('The number of rows deleted from InnoDB tables.'),        'Innodb_rows_inserted' => __('The number of rows inserted in InnoDB tables.'),        'Innodb_rows_read' => __('The number of rows read from InnoDB tables.'),        'Innodb_rows_updated' => __('The number of rows updated in InnoDB tables.'),        'Key_blocks_not_flushed' => __('The number of key blocks in the key cache that have changed but haven\'t yet been flushed to disk. It used to be known as Not_flushed_key_blocks.'),        'Key_blocks_unused' => __('The number of unused blocks in the key cache. You can use this value to determine how much of the key cache is in use.'),        'Key_blocks_used' => __('The number of used blocks in the key cache. This value is a high-water mark that indicates the maximum number of blocks that have ever been in use at one time.'),        'Key_read_requests' => __('The number of requests to read a key block from the cache.'),        'Key_reads' => __('The number of physical reads of a key block from disk. If Key_reads is big, then your key_buffer_size value is probably too small. The cache miss rate can be calculated as Key_reads/Key_read_requests.'),        'Key_write_requests' => __('The number of requests to write a key block to the cache.'),        'Key_writes' => __('The number of physical writes of a key block to disk.'),        'Last_query_cost' => __('The total cost of the last compiled query as computed by the query optimizer. Useful for comparing the cost of different query plans for the same query. The default value of 0 means that no query has been compiled yet.'),        'Max_used_connections' => __('The maximum number of connections that have been in use simultaneously since the server started.'),        'Not_flushed_delayed_rows' => __('The number of rows waiting to be written in INSERT DELAYED queues.'),        'Opened_tables' => __('The number of tables that have been opened. If opened tables is big, your table cache value is probably too small.'),        'Open_files' => __('The number of files that are open.'),        'Open_streams' => __('The number of streams that are open (used mainly for logging).'),        'Open_tables' => __('The number of tables that are open.'),        'Qcache_free_blocks' => __('The number of free memory blocks in query cache. High numbers can indicate fragmentation issues, which may be solved by issuing a FLUSH QUERY CACHE statement.'),        'Qcache_free_memory' => __('The amount of free memory for query cache.'),        'Qcache_hits' => __('The number of cache hits.'),        'Qcache_inserts' => __('The number of queries added to the cache.'),        'Qcache_lowmem_prunes' => __('The number of queries that have been removed from the cache to free up memory for caching new queries. This information can help you tune the query cache size. The query cache uses a least recently used (LRU) strategy to decide which queries to remove from the cache.'),        'Qcache_not_cached' => __('The number of non-cached queries (not cachable, or not cached due to the query_cache_type setting).'),        'Qcache_queries_in_cache' => __('The number of queries registered in the cache.'),        'Qcache_total_blocks' => __('The total number of blocks in the query cache.'),        'Rpl_status' => __('The status of failsafe replication (not yet implemented).'),        'Select_full_join' => __('The number of joins that do not use indexes. If this value is not 0, you should carefully check the indexes of your tables.'),        'Select_full_range_join' => __('The number of joins that used a range search on a reference table.'),        'Select_range_check' => __('The number of joins without keys that check for key usage after each row. (If this is not 0, you should carefully check the indexes of your tables.)'),        'Select_range' => __('The number of joins that used ranges on the first table. (It\'s normally not critical even if this is big.)'),        'Select_scan' => __('The number of joins that did a full scan of the first table.'),        'Slave_open_temp_tables' => __('The number of temporary tables currently open by the slave SQL thread.'),        'Slave_retried_transactions' => __('Total (since startup) number of times the replication slave SQL thread has retried transactions.'),        'Slave_running' => __('This is ON if this server is a slave that is connected to a master.'),        'Slow_launch_threads' => __('The number of threads that have taken more than slow_launch_time seconds to create.'),        'Slow_queries' => __('The number of queries that have taken more than long_query_time seconds.'),        'Sort_merge_passes' => __('The number of merge passes the sort algorithm has had to do. If this value is large, you should consider increasing the value of the sort_buffer_size system variable.'),        'Sort_range' => __('The number of sorts that were done with ranges.'),        'Sort_rows' => __('The number of sorted rows.'),        'Sort_scan' => __('The number of sorts that were done by scanning the table.'),        'Table_locks_immediate' => __('The number of times that a table lock was acquired immediately.'),        'Table_locks_waited' => __('The number of times that a table lock could not be acquired immediately and a wait was needed. If this is high, and you have performance problems, you should first optimize your queries, and then either split your table or tables or use replication.'),        'Threads_cached' => __('The number of threads in the thread cache. The cache hit rate can be calculated as Threads_created/Connections. If this value is red you should raise your thread_cache_size.'),        'Threads_connected' => __('The number of currently open connections.'),        'Threads_created' => __('The number of threads created to handle connections. If Threads_created is big, you may want to increase the thread_cache_size value. (Normally this doesn\'t give a notable performance improvement if you have a good thread implementation.)'),        'Threads_running' => __('The number of threads that are not sleeping.')    );    /**     * define some alerts     */    // name => max value before alert    $alerts = array(        // lower is better        // variable => max value        'Aborted_clients' => 0,        'Aborted_connects' => 0,        'Binlog_cache_disk_use' => 0,        'Created_tmp_disk_tables' => 0,        'Handler_read_rnd' => 0,        'Handler_read_rnd_next' => 0,        'Innodb_buffer_pool_pages_dirty' => 0,        'Innodb_buffer_pool_reads' => 0,        'Innodb_buffer_pool_wait_free' => 0,        'Innodb_log_waits' => 0,        'Innodb_row_lock_time_avg' => 10, // ms        'Innodb_row_lock_time_max' => 50, // ms        'Innodb_row_lock_waits' => 0,        'Slow_queries' => 0,        'Delayed_errors' => 0,        'Select_full_join' => 0,        'Select_range_check' => 0,        'Sort_merge_passes' => 0,        'Opened_tables' => 0,        'Table_locks_waited' => 0,        'Qcache_lowmem_prunes' => 0,        'Qcache_free_blocks' => isset($server_status['Qcache_total_blocks']) ? $server_status['Qcache_total_blocks'] / 5 : 0,        'Slow_launch_threads' => 0,        // depends on Key_read_requests        // normaly lower then 1:0.01        'Key_reads' => isset($server_status['Key_read_requests']) ? (0.01 * $server_status['Key_read_requests']) : 0,        // depends on Key_write_requests        // normaly nearly 1:1        'Key_writes' => isset($server_status['Key_write_requests']) ? (0.9 * $server_status['Key_write_requests']) : 0,        'Key_buffer_fraction' => 0.5,        // alert if more than 95% of thread cache is in use        'Threads_cached' => isset($server_variables['thread_cache_size']) ? 0.95 * $server_variables['thread_cache_size'] : 0        // higher is better        // variable => min value        //'Handler read key' => '> ',    );?><table class="data sortable noclick" id="serverstatusvariables">    <col class="namecol" />    <col class="valuecol" />    <col class="descrcol" />    <thead>        <tr>            <th><?php echo __('Variable'); ?></th>            <th><?php echo __('Value'); ?></th>            <th><?php echo __('Description'); ?></th>        </tr>    </thead>    <tbody>    <?php    $odd_row = false;    foreach ($server_status as $name => $value) {            $odd_row = !$odd_row;?>        <tr class="<?php echo $odd_row ? 'odd' : 'even'; echo isset($allocationMap[$name])?' s_' . $allocationMap[$name]:''; ?>">            <th class="name"><?php            echo htmlspecialchars(str_replace('_', ' ', $name));            /* Fields containing % are calculated, they can not be described in MySQL documentation */            if (strpos($name, '%') === FALSE) {                 echo PMA_showMySQLDocu('server-status-variables', 'server-status-variables', false, 'statvar_' . $name);            }            ?>            </th>            <td class="value"><span class="formatted"><?php            if (isset($alerts[$name])) {                if ($value > $alerts[$name]) {                    echo '<span class="attention">';                } else {                    echo '<span class="allfine">';                }            }            if ('%' === substr($name, -1, 1)) {                echo htmlspecialchars(PMA_formatNumber($value, 0, 2)) . ' %';            } elseif (strpos($name, 'Uptime') !== false) {                echo htmlspecialchars(PMA_timespanFormat($value));            } elseif (is_numeric($value) && $value == (int) $value && $value > 1000) {                echo htmlspecialchars(PMA_formatNumber($value, 3, 1));            } elseif (is_numeric($value) && $value == (int) $value) {                echo htmlspecialchars(PMA_formatNumber($value, 3, 0));            } elseif (is_numeric($value)) {                echo htmlspecialchars(PMA_formatNumber($value, 3, 1));            } else {                echo htmlspecialchars($value);            }            if (isset($alerts[$name])) {                echo '</span>';            }            ?></span><span style="display:none;" class="original"><?php echo $value; ?></span>            </td>            <td class="descr">            <?php            if (isset($strShowStatus[$name ])) {                echo $strShowStatus[$name];            }            if (isset($links[$name])) {                foreach ($links[$name] as $link_name => $link_url) {                    if ('doc' == $link_name) {                        echo PMA_showMySQLDocu($link_url, $link_url);                    } else {                        echo ' <a href="' . $link_url . '">' . $link_name . '</a>' .                        "\n";                    }                }                unset($link_url, $link_name);            }            ?>            </td>        </tr>    <?php    }    ?>    </tbody>    </table>    <?php}function printMonitor(){    global $server_status, $server_db_isLocal;?>    <div class="tabLinks" style="display:none;">        <a href="#pauseCharts">            <?php echo PMA_getImage('play.png'); ?>            <?php echo __('Start Monitor'); ?>        </a>        <a href="#settingsPopup" rel="popupLink" style="display:none;">            <?php echo PMA_getImage('s_cog.png'); ?>            <?php echo __('Settings'); ?>        </a>        <?php if (!PMA_DRIZZLE) { ?>        <a href="#monitorInstructionsDialog">            <?php echo PMA_getImage('b_help.png'); ?>            <?php echo __('Instructions/Setup'); ?>        </a>        <?php } ?>        <a href="#endChartEditMode" style="display:none;">            <?php echo PMA_getImage('s_okay.png'); ?>            <?php echo __('Done rearranging/editing charts'); ?>        </a>    </div>    <div class="popupContent settingsPopup">        <a href="#addNewChart">            <?php echo PMA_getImage('b_chart.png'); ?>            <?php echo __('Add chart'); ?>        </a>        <a href="#rearrangeCharts"><?php echo PMA_getImage('b_tblops.png'); ?><?php echo __('Rearrange/edit charts'); ?></a>        <div class="clearfloat paddingtop"></div>        <div class="floatleft">            <?php            echo __('Refresh rate') . '<br />';            refreshList('gridChartRefresh', 5, Array(2, 3, 4, 5, 10, 20, 40, 60, 120, 300, 600, 1200));        ?><br />        </div>        <div class="floatleft">            <?php echo __('Chart columns'); ?> <br />            <select name="chartColumns">                <option>1</option>                <option>2</option>                <option>3</option>                <option>4</option>                <option>5</option>                <option>6</option>                <option>7</option>                <option>8</option>                <option>9</option>                <option>10</option>            </select>        </div>        <div class="clearfloat paddingtop">        <b><?php echo __('Chart arrangement'); ?></b> <?php echo PMA_showHint(__('The arrangement of the charts is stored to the browsers local storage. You may want to export it if you have a complicated set up.')); ?><br/>        <a href="#importMonitorConfig"><?php echo __('Import'); ?></a>&nbsp;&nbsp;<a href="#exportMonitorConfig"><?php echo __('Export'); ?></a>&nbsp;&nbsp;<a href="#clearMonitorConfig"><?php echo __('Reset to default'); ?></a>        </div>    </div>    <div id="monitorInstructionsDialog" title="<?php echo __('Monitor Instructions'); ?>" style="display:none;">        <?php echo __('The phpMyAdmin Monitor can assist you in optimizing the server configuration and track down time intensive queries. For the latter you will need to set log_output to \'TABLE\' and have either the slow_query_log or general_log enabled. Note however, that the general_log produces a lot of data and increases server load by up to 15%'); ?>    <?php if (PMA_MYSQL_INT_VERSION < 50106) { ?>        <p>        <?php echo PMA_getImage('s_attention.png'); ?>        <?php            echo __('Unfortunately your Database server does not support logging to table, which is a requirement for analyzing the database logs with phpMyAdmin. Logging to table is supported by MySQL 5.1.6 and onwards. You may still use the server charting features however.');        ?>        </p>    <?php    } else {    ?>        <p></p>        <img class="ajaxIcon" src="<?php echo $GLOBALS['pmaThemeImage']; ?>ajax_clock_small.gif" alt="Loading" />        <div class="ajaxContent"></div>        <div class="monitorUse" style="display:none;">            <p></p>            <?php                echo '<strong>';                echo __('Using the monitor:');                echo '</strong><p>';                echo __('Your browser will refresh all displayed charts in a regular interval. You may add charts and change the refresh rate under \'Settings\', or remove any chart using the cog icon on each respective chart.');                echo '</p><p>';                echo __('To display queries from the logs, select the relevant time span on any chart by holding down the left mouse button and panning over the chart. Once confirmed, this will load a table of grouped queries, there you may click on any occuring SELECT statements to further analyze them.');                echo '</p>';            ?>            <p>            <?php echo PMA_getImage('s_attention.png'); ?>            <?php                echo '<strong>';                echo __('Please note:');                echo '</strong><br />';                echo __('Enabling the general_log may increase the server load by 5-15%. Also be aware that generating statistics from the logs is a load intensive task, so it is advisable to select only a small time span and to disable the general_log and empty its table once monitoring is not required any more.');            ?>            </p>        </div>    <?php } ?>    </div>    <div id="addChartDialog" title="<?php echo __('Add chart'); ?>" style="display:none;">        <div id="tabGridVariables">            <p><input type="text" name="chartTitle" value="<?php echo __('Chart Title'); ?>" /></p>            <input type="radio" name="chartType" value="preset" id="chartPreset" />            <label for="chartPreset"><?php echo __('Preset chart'); ?></label>            <select name="presetCharts"></select><br/>            <input type="radio" name="chartType" value="variable" id="chartStatusVar" checked="checked" />            <label for="chartStatusVar"><?php echo __('Status variable(s)'); ?></label><br/>            <div id="chartVariableSettings">                <label for="chartSeries"><?php echo __('Select series:'); ?></label><br />                <select id="chartSeries" name="varChartList" size="1">                    <option><?php echo __('Commonly monitored'); ?></option>                    <option>Processes</option>                    <option>Questions</option>                    <option>Connections</option>                    <option>Bytes_sent</option>                    <option>Bytes_received</option>                    <option>Threads_connected</option>                    <option>Created_tmp_disk_tables</option>                    <option>Handler_read_first</option>                    <option>Innodb_buffer_pool_wait_free</option>                    <option>Key_reads</option>                    <option>Open_tables</option>                    <option>Select_full_join</option>                    <option>Slow_queries</option>                </select><br />                <label for="variableInput"><?php echo __('or type variable name:'); ?> </label>                <input type="text" name="variableInput" id="variableInput" />                <p></p>                <input type="checkbox" name="differentialValue" id="differentialValue" value="differential" checked="checked" />                <label for="differentialValue"><?php echo __('Display as differential value'); ?></label><br />                <input type="checkbox" id="useDivisor" name="useDivisor" value="1" />                <label for="useDivisor"><?php echo __('Apply a divisor'); ?></label>                <span class="divisorInput" style="display:none;">                    <input type="text" name="valueDivisor" size="4" value="1" />                    (<a href="#kibDivisor"><?php echo __('KiB'); ?></a>, <a href="#mibDivisor"><?php echo __('MiB'); ?></a>)                </span><br />                <input type="checkbox" id="useUnit" name="useUnit" value="1" />                <label for="useUnit"><?php echo __('Append unit to data values'); ?></label>                <span class="unitInput" style="display:none;">                    <input type="text" name="valueUnit" size="4" value="" />                </span>                <p>                    <a href="#submitAddSeries"><b><?php echo __('Add this series'); ?></b></a>                    <span id="clearSeriesLink" style="display:none;">                       | <a href="#submitClearSeries"><?php echo __('Clear series'); ?></a>                    </span>                </p>                <?php echo __('Series in Chart:'); ?><br/>                <span id="seriesPreview">                <i><?php echo __('None'); ?></i>                </span>            </div>        </div>    </div>    <!-- For generic use -->    <div id="emptyDialog" title="Dialog" style="display:none;">    </div>    <?php if (!PMA_DRIZZLE) { ?>    <div id="logAnalyseDialog" title="<?php echo __('Log statistics'); ?>" style="display:none;">        <p> <?php echo __('Selected time range:'); ?>        <input type="text" name="dateStart" class="datetimefield" value="" /> -        <input type="text" name="dateEnd" class="datetimefield" value="" /></p>        <input type="checkbox" id="limitTypes" value="1" checked="checked" />        <label for="limitTypes">            <?php echo __('Only retrieve SELECT,INSERT,UPDATE and DELETE Statements'); ?>        </label>        <br/>        <input type="checkbox" id="removeVariables" value="1" checked="checked" />        <label for="removeVariables">            <?php echo __('Remove variable data in INSERT statements for better grouping'); ?>        </label>        <?php        echo '<p>';        echo __('Choose from which log you want the statistics to be generated from.');        echo '</p><p>';        echo __('Results are grouped by query text.');        echo '</p>';        ?>    </div>    <div id="queryAnalyzerDialog" title="<?php echo __('Query analyzer'); ?>" style="display:none;">        <textarea id="sqlquery"> </textarea>        <p></p>        <div class="placeHolder"></div>    </div>    <?php } ?>    <table border="0" class="clearfloat" id="chartGrid">    </table>    <div id="logTable">        <br/>    </div>    <script type="text/javascript">        variableNames = [ <?php            $i=0;            foreach ($server_status as $name=>$value) {                if (is_numeric($value)) {                    if ($i++ > 0) {                        echo ", ";                    }                    echo "'" . $name . "'";                }            }            ?> ];    </script><?php}/* Builds a <select> list for refresh rates */function refreshList($name, $defaultRate=5, $refreshRates=Array(1, 2, 5, 10, 20, 40, 60, 120, 300, 600)){?>    <select name="<?php echo $name; ?>" id="id_<?php echo $name; ?>">        <?php            foreach ($refreshRates as $rate) {                $selected = ($rate == $defaultRate)?' selected="selected"':'';                if ($rate<60) {                    echo '<option value="' . $rate . '"' . $selected . '>' . sprintf(_ngettext('%d second', '%d seconds', $rate), $rate) . '</option>';                } else {                    echo '<option value="' . $rate . '"' . $selected . '>' . sprintf(_ngettext('%d minute', '%d minutes', $rate/60), $rate/60) . '</option>';                }            }        ?>    </select><?php}/** * cleanup of some deprecated values * * @param array &$server_status */function cleanDeprecated(&$server_status){    $deprecated = array(        'Com_prepare_sql' => 'Com_stmt_prepare',        'Com_execute_sql' => 'Com_stmt_execute',        'Com_dealloc_sql' => 'Com_stmt_close',    );    foreach ($deprecated as $old => $new) {        if (isset($server_status[$old]) && isset($server_status[$new])) {            unset($server_status[$old]);        }    }}/** * Sends the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * Main export hanling code * @package PhpMyAdmin *//** * Get the variables sent or posted to this script and a core script */require_once './libraries/common.inc.php';require_once './libraries/zip.lib.php';require_once './libraries/plugin_interface.lib.php';PMA_checkParameters(array('what', 'export_type'));// Scan plugins$export_list = PMA_getPlugins(    './libraries/export/',    array(        'export_type' => $export_type,        'single_table' => isset($single_table)));// Backward compatbility$type = $what;// Check export typeif (! isset($export_list[$type])) {    die(__('Bad type!'));}/** * valid compression methods */$compression_methods = array(    'zip',    'gzip',    'bzip2',);/** * init and variable checking */$compression = false;$onserver = false;$save_on_server = false;$buffer_needed = false;// Is it a quick or custom export?if ($_REQUEST['quick_or_custom'] == 'quick') {    $quick_export = true;} else {    $quick_export = false;}if ($_REQUEST['output_format'] == 'astext') {    $asfile = false;} else {    $asfile = true;    if (in_array($_REQUEST['compression'], $compression_methods)) {        $compression = $_REQUEST['compression'];        $buffer_needed = true;    }    if (($quick_export && !empty($_REQUEST['quick_export_onserver'])) || (!$quick_export && !empty($_REQUEST['onserver']))) {        if ($quick_export) {            $onserver = $_REQUEST['quick_export_onserver'];        } else {            $onserver = $_REQUEST['onserver'];        }        // Will we save dump on server?        $save_on_server = ! empty($cfg['SaveDir']) && $onserver;    }}// Does export require to be into file?if (isset($export_list[$type]['force_file']) && ! $asfile) {    $message = PMA_Message::error(__('Selected export type has to be saved in file!'));    include_once './libraries/header.inc.php';    if ($export_type == 'server') {        $active_page = 'server_export.php';        include './server_export.php';    } elseif ($export_type == 'database') {        $active_page = 'db_export.php';        include './db_export.php';    } else {        $active_page = 'tbl_export.php';        include './tbl_export.php';    }    exit();}// Generate error url and check for needed variablesif ($export_type == 'server') {    $err_url = 'server_export.php?' . PMA_generate_common_url();} elseif ($export_type == 'database' && strlen($db)) {    $err_url = 'db_export.php?' . PMA_generate_common_url($db);    // Check if we have something to export    if (isset($table_select)) {        $tables = $table_select;    } else {        $tables = array();    }} elseif ($export_type == 'table' && strlen($db) && strlen($table)) {    $err_url = 'tbl_export.php?' . PMA_generate_common_url($db, $table);} else {    die(__('Bad parameters!'));}// Get the functions specific to the export typerequire './libraries/export/' . PMA_securePath($type) . '.php';/** * Increase time limit for script execution and initializes some variables */@set_time_limit($cfg['ExecTimeLimit']);if (!empty($cfg['MemoryLimit'])) {    @ini_set('memory_limit', $cfg['MemoryLimit']);}// Start with empty buffer$dump_buffer = '';$dump_buffer_len = 0;// We send fake headers to avoid browser timeout when buffering$time_start = time();/** * Output handler for all exports, if needed buffering, it stores data into * $dump_buffer, otherwise it prints thems out. * * @param string  $line  the insert statement * @return  bool    Whether output succeeded */function PMA_exportOutputHandler($line){    global $time_start, $dump_buffer, $dump_buffer_len, $save_filename;    // Kanji encoding convert feature    if ($GLOBALS['output_kanji_conversion']) {        $line = PMA_kanji_str_conv($line, $GLOBALS['knjenc'], isset($GLOBALS['xkana']) ? $GLOBALS['xkana'] : '');    }    // If we have to buffer data, we will perform everything at once at the end    if ($GLOBALS['buffer_needed']) {        $dump_buffer .= $line;        if ($GLOBALS['onfly_compression']) {            $dump_buffer_len += strlen($line);            if ($dump_buffer_len > $GLOBALS['memory_limit']) {                if ($GLOBALS['output_charset_conversion']) {                    $dump_buffer = PMA_convert_string('utf-8', $GLOBALS['charset_of_file'], $dump_buffer);                }                // as bzipped                if ($GLOBALS['compression'] == 'bzip2'  && @function_exists('bzcompress')) {                    $dump_buffer = bzcompress($dump_buffer);                } elseif ($GLOBALS['compression'] == 'gzip' && @function_exists('gzencode')) {                    // as a gzipped file                    // without the optional parameter level because it bug                    $dump_buffer = gzencode($dump_buffer);                }                if ($GLOBALS['save_on_server']) {                    $write_result = @fwrite($GLOBALS['file_handle'], $dump_buffer);                    if (!$write_result || ($write_result != strlen($dump_buffer))) {                        $GLOBALS['message'] = PMA_Message::error(__('Insufficient space to save the file %s.'));                        $GLOBALS['message']->addParam($save_filename);                        return false;                    }                } else {                    echo $dump_buffer;                }                $dump_buffer = '';                $dump_buffer_len = 0;            }        } else {            $time_now = time();            if ($time_start >= $time_now + 30) {                $time_start = $time_now;                header('X-pmaPing: Pong');            } // end if        }    } else {        if ($GLOBALS['asfile']) {            if ($GLOBALS['output_charset_conversion']) {                $line = PMA_convert_string('utf-8', $GLOBALS['charset_of_file'], $line);            }            if ($GLOBALS['save_on_server'] && strlen($line) > 0) {                $write_result = @fwrite($GLOBALS['file_handle'], $line);                if (!$write_result || ($write_result != strlen($line))) {                    $GLOBALS['message'] = PMA_Message::error(__('Insufficient space to save the file %s.'));                    $GLOBALS['message']->addParam($save_filename);                    return false;                }                $time_now = time();                if ($time_start >= $time_now + 30) {                    $time_start = $time_now;                    header('X-pmaPing: Pong');                } // end if            } else {                // We export as file - output normally                echo $line;            }        } else {            // We export as html - replace special chars            echo htmlspecialchars($line);        }    }    return true;} // end of the 'PMA_exportOutputHandler()' function// Defines the default <CR><LF> format. For SQL always use \n as MySQL wants this on all platforms.if ($what == 'sql') {    $crlf = "\n";} else {    $crlf = PMA_whichCrlf();}$output_kanji_conversion = function_exists('PMA_kanji_str_conv') && $type != 'xls';// Do we need to convert charset?$output_charset_conversion = $asfile && $GLOBALS['PMA_recoding_engine'] != PMA_CHARSET_NONE    && isset($charset_of_file) && $charset_of_file != 'utf-8'    && $type != 'xls';// Use on the fly compression?$onfly_compression = $GLOBALS['cfg']['CompressOnFly'] && ($compression == 'gzip' || $compression == 'bzip2');if ($onfly_compression) {    $memory_limit = trim(@ini_get('memory_limit'));    // 2 MB as default    if (empty($memory_limit)) {        $memory_limit = 2 * 1024 * 1024;    }    if (strtolower(substr($memory_limit, -1)) == 'm') {        $memory_limit = (int)substr($memory_limit, 0, -1) * 1024 * 1024;    } elseif (strtolower(substr($memory_limit, -1)) == 'k') {        $memory_limit = (int)substr($memory_limit, 0, -1) * 1024;    } elseif (strtolower(substr($memory_limit, -1)) == 'g') {        $memory_limit = (int)substr($memory_limit, 0, -1) * 1024 * 1024 * 1024;    } else {        $memory_limit = (int)$memory_limit;    }    // Some of memory is needed for other thins and as treshold.    // Nijel: During export I had allocated (see memory_get_usage function)    //        approx 1.2MB so this comes from that.    if ($memory_limit > 1500000) {        $memory_limit -= 1500000;    }    // Some memory is needed for compression, assume 1/3    $memory_limit /= 8;}// Generate filename and mime type if neededif ($asfile) {    $pma_uri_parts = parse_url($cfg['PmaAbsoluteUri']);    if ($export_type == 'server') {        if (isset($remember_template)) {            $GLOBALS['PMA_Config']->setUserValue('pma_server_filename_template',                'Export/file_template_server', $filename_template);        }    } elseif ($export_type == 'database') {        if (isset($remember_template)) {            $GLOBALS['PMA_Config']->setUserValue('pma_db_filename_template',                'Export/file_template_database', $filename_template);        }    } else {        if (isset($remember_template)) {            $GLOBALS['PMA_Config']->setUserValue('pma_table_filename_template',                'Export/file_template_table', $filename_template);        }    }    $filename = PMA_expandUserString($filename_template);    $filename = PMA_sanitize_filename($filename);    // Grab basic dump extension and mime type    // Check if the user already added extension; get the substring where the extension would be if it was included    $extension_start_pos = strlen($filename) - strlen($export_list[$type]['extension']) - 1;    $user_extension = substr($filename, $extension_start_pos, strlen($filename));    $required_extension = "." . $export_list[$type]['extension'];    if (strtolower($user_extension) != $required_extension) {        $filename  .= $required_extension;    }    $mime_type  = $export_list[$type]['mime_type'];    // If dump is going to be compressed, set correct mime_type and add    // compression to extension    if ($compression == 'bzip2') {        $filename  .= '.bz2';        $mime_type = 'application/x-bzip2';    } elseif ($compression == 'gzip') {        $filename  .= '.gz';        $mime_type = 'application/x-gzip';    } elseif ($compression == 'zip') {        $filename  .= '.zip';        $mime_type = 'application/zip';    }}// Open file on server if neededif ($save_on_server) {    $save_filename = PMA_userDir($cfg['SaveDir']) . preg_replace('@[/\\\\]@', '_', $filename);    unset($message);    if (file_exists($save_filename) && ((!$quick_export && empty($onserverover)) || ($quick_export && $_REQUEST['quick_export_onserverover'] != 'saveitover'))) {        $message = PMA_Message::error(__('File %s already exists on server, change filename or check overwrite option.'));        $message->addParam($save_filename);    } else {        if (is_file($save_filename) && !is_writable($save_filename)) {            $message = PMA_Message::error(__('The web server does not have permission to save the file %s.'));            $message->addParam($save_filename);        } else {            if (!$file_handle = @fopen($save_filename, 'w')) {                $message = PMA_Message::error(__('The web server does not have permission to save the file %s.'));                $message->addParam($save_filename);            }        }    }    if (isset($message)) {        include_once './libraries/header.inc.php';        if ($export_type == 'server') {            $active_page = 'server_export.php';            include './server_export.php';        } elseif ($export_type == 'database') {            $active_page = 'db_export.php';            include './db_export.php';        } else {            $active_page = 'tbl_export.php';            include './tbl_export.php';        }        exit();    }}/** * Send headers depending on whether the user chose to download a dump file * or not */if (!$save_on_server) {    if ($asfile) {        // Download        // (avoid rewriting data containing HTML with anchors and forms;        // this was reported to happen under Plesk)        @ini_set('url_rewriter.tags', '');        $filename = PMA_sanitize_filename($filename);        PMA_download_header($filename, $mime_type);    } else {        // HTML        if ($export_type == 'database') {            $num_tables = count($tables);            if ($num_tables == 0) {                $message = PMA_Message::error(__('No tables found in database.'));                include_once './libraries/header.inc.php';                $active_page = 'db_export.php';                include './db_export.php';                exit();            }        }        $backup_cfgServer = $cfg['Server'];        include_once './libraries/header.inc.php';        $cfg['Server'] = $backup_cfgServer;        unset($backup_cfgServer);        echo "\n" . '<div align="' . $cell_align_left . '">' . "\n";        //echo '    <pre>' . "\n";        /**         * Displays a back button with all the $_REQUEST data in the URL (store in a variable to also display after the textarea)         */         $back_button = '<p>[ <a href="';        if ($export_type == 'server') {           $back_button .= 'server_export.php?' . PMA_generate_common_url();         } elseif ($export_type == 'database') {            $back_button .= 'db_export.php?' . PMA_generate_common_url($db);        } else {            $back_button .= 'tbl_export.php?' . PMA_generate_common_url($db, $table);        }        // Convert the multiple select elements from an array to a string        if ($export_type == 'server' && isset($_REQUEST['db_select'])) {            $_REQUEST['db_select'] = implode(",", $_REQUEST['db_select']);        } elseif ($export_type == 'database' && isset($_REQUEST['table_select'])) {            $_REQUEST['table_select'] = implode(",", $_REQUEST['table_select']);        }        foreach ($_REQUEST as $name => $value) {            $back_button .= '&' . urlencode($name) . '=' . urlencode($value);        }        $back_button .= '&repopulate=1">Back</a> ]</p>';        echo $back_button;        echo '    <form name="nofunction">' . "\n"           // remove auto-select for now: there is no way to select           // only a part of the text; anyway, it should obey           // $cfg['TextareaAutoSelect']           //. '        <textarea name="sqldump" cols="50" rows="30" onclick="this.select();" id="textSQLDUMP" wrap="OFF">' . "\n";           . '        <textarea name="sqldump" cols="50" rows="30" id="textSQLDUMP" wrap="OFF">' . "\n";    } // end download}// Fake loop just to allow skip of remain of this code by break, I'd really// need exceptions here :-)do {    // Add possibly some comments to export    if (!PMA_exportHeader()) {        break;    }    // Will we need relation & co. setup?    $do_relation = isset($GLOBALS[$what . '_relation']);    $do_comments = isset($GLOBALS[$what . '_include_comments']);    $do_mime     = isset($GLOBALS[$what . '_mime']);    if ($do_relation || $do_comments || $do_mime) {        $cfgRelation = PMA_getRelationsParam();    }    if ($do_mime) {        include_once './libraries/transformations.lib.php';    }    // Include dates in export?    $do_dates   = isset($GLOBALS[$what . '_dates']);    /**     * Builds the dump     */    // Gets the number of tables if a dump of a database has been required    if ($export_type == 'server') {        if (isset($db_select)) {            $tmp_select = implode($db_select, '|');            $tmp_select = '|' . $tmp_select . '|';        }        // Walk over databases        foreach ($GLOBALS['pma']->databases as $current_db) {            if ((isset($tmp_select) && strpos(' ' . $tmp_select, '|' . $current_db . '|'))                || ! isset($tmp_select)) {                if (!PMA_exportDBHeader($current_db)) {                    break 2;                }                if (!PMA_exportDBCreate($current_db)) {                    break 2;                }                if (function_exists('PMA_exportRoutines') && strpos($GLOBALS['sql_structure_or_data'], 'structure') !== false && isset($GLOBALS['sql_procedure_function'])) {                    PMA_exportRoutines($current_db);                }                $tables = PMA_DBI_get_tables($current_db);                $views = array();                foreach ($tables as $table) {                    // if this is a view, collect it for later; views must be exported                    // after the tables                    $is_view = PMA_Table::isView($current_db, $table);                    if ($is_view) {                        $views[] = $table;                    }                    if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {                        // for a view, export a stand-in definition of the table                        // to resolve view dependencies                        if (!PMA_exportStructure($current_db, $table, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, $is_view ? 'stand_in' : 'create_table', $export_type)) {                            break 3;                        }                    }                    // if this is a view or a merge table, don't export data                    if (($GLOBALS[$what . '_structure_or_data'] == 'data' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') && !($is_view || PMA_Table::isMerge($current_db, $table))) {                        $local_query  = 'SELECT * FROM ' . PMA_backquote($current_db) . '.' . PMA_backquote($table);                        if (!PMA_exportData($current_db, $table, $crlf, $err_url, $local_query)) {                            break 3;                        }                    }                    // now export the triggers (needs to be done after the data because                    // triggers can modify already imported tables)                    if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {                        if (!PMA_exportStructure($current_db, $table, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, 'triggers', $export_type)) {                            break 2;                        }                    }                }                foreach ($views as $view) {                    // no data export for a view                    if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {                        if (!PMA_exportStructure($current_db, $view, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, 'create_view', $export_type)) {                            break 3;                        }                    }                }                if (!PMA_exportDBFooter($current_db)) {                    break 2;                }            }        }    } elseif ($export_type == 'database') {        if (!PMA_exportDBHeader($db)) {            break;        }        if (function_exists('PMA_exportRoutines') && strpos($GLOBALS['sql_structure_or_data'], 'structure') !== false && isset($GLOBALS['sql_procedure_function'])) {            PMA_exportRoutines($db);        }        $i = 0;        $views = array();        // $tables contains the choices from the user (via $table_select)        foreach ($tables as $table) {            // if this is a view, collect it for later; views must be exported after            // the tables            $is_view = PMA_Table::isView($db, $table);            if ($is_view) {                $views[] = $table;            }            if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {                // for a view, export a stand-in definition of the table                // to resolve view dependencies                if (!PMA_exportStructure($db, $table, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, $is_view ? 'stand_in' : 'create_table', $export_type)) {                    break 2;                }            }            // if this is a view or a merge table, don't export data            if (($GLOBALS[$what . '_structure_or_data'] == 'data' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') && !($is_view || PMA_Table::isMerge($db, $table))) {                $local_query  = 'SELECT * FROM ' . PMA_backquote($db) . '.' . PMA_backquote($table);                if (!PMA_exportData($db, $table, $crlf, $err_url, $local_query)) {                    break 2;                }            }            // now export the triggers (needs to be done after the data because            // triggers can modify already imported tables)            if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {                if (!PMA_exportStructure($db, $table, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, 'triggers', $export_type)) {                    break 2;                }            }        }        foreach ($views as $view) {            // no data export for a view            if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {                if (!PMA_exportStructure($db, $view, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, 'create_view', $export_type)) {                    break 2;                }            }        }        if (!PMA_exportDBFooter($db)) {            break;        }    } else {        if (!PMA_exportDBHeader($db)) {            break;        }        // We export just one table        // $allrows comes from the form when "Dump all rows" has been selected        if ($allrows == '0' && $limit_to > 0 && $limit_from >= 0) {            $add_query  = ' LIMIT '                        . (($limit_from > 0) ? $limit_from . ', ' : '')                        . $limit_to;        } else {            $add_query  = '';        }        $is_view = PMA_Table::isView($db, $table);        if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {            if (!PMA_exportStructure($db, $table, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, $is_view ? 'create_view' : 'create_table', $export_type)) {                break;            }        }        // If this is an export of a single view, we have to export data;        // for example, a PDF report        // if it is a merge table, no data is exported        if (($GLOBALS[$what . '_structure_or_data'] == 'data' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') && ! PMA_Table::isMerge($db, $table)) {            if (!empty($sql_query)) {                // only preg_replace if needed                if (!empty($add_query)) {                    // remove trailing semicolon before adding a LIMIT                    $sql_query = preg_replace('%;\s*$%', '', $sql_query);                }                $local_query = $sql_query . $add_query;                PMA_DBI_select_db($db);            } else {                $local_query  = 'SELECT * FROM ' . PMA_backquote($db) . '.' . PMA_backquote($table) . $add_query;            }            if (!PMA_exportData($db, $table, $crlf, $err_url, $local_query)) {                break;            }        }        // now export the triggers (needs to be done after the data because        // triggers can modify already imported tables)        if ($GLOBALS[$what . '_structure_or_data'] == 'structure' || $GLOBALS[$what . '_structure_or_data'] == 'structure_and_data') {            if (!PMA_exportStructure($db, $table, $crlf, $err_url, $do_relation, $do_comments, $do_mime, $do_dates, 'triggers', $export_type)) {                break 2;            }        }        if (!PMA_exportDBFooter($db)) {            break;        }    }    if (!PMA_exportFooter()) {        break;    }} while (false);// End of fake loopif ($save_on_server && isset($message)) {    include_once './libraries/header.inc.php';    if ($export_type == 'server') {        $active_page = 'server_export.php';        include './server_export.php';    } elseif ($export_type == 'database') {        $active_page = 'db_export.php';        include './db_export.php';    } else {        $active_page = 'tbl_export.php';        include './tbl_export.php';    }    exit();}/** * Send the dump as a file... */if (!empty($asfile)) {    // Convert the charset if required.    if ($output_charset_conversion) {        $dump_buffer = PMA_convert_string('utf-8', $GLOBALS['charset_of_file'], $dump_buffer);    }    // Do the compression    // 1. as a zipped file    if ($compression == 'zip') {        if (@function_exists('gzcompress')) {            $zipfile = new zipfile();            $zipfile -> addFile($dump_buffer, substr($filename, 0, -4));            $dump_buffer = $zipfile -> file();        }    } elseif ($compression == 'bzip2') {        // 2. as a bzipped file        if (@function_exists('bzcompress')) {            $dump_buffer = bzcompress($dump_buffer);        }    } elseif ($compression == 'gzip') {        // 3. as a gzipped file        if (@function_exists('gzencode') && !@ini_get('zlib.output_compression')) {            // without the optional parameter level because it bug            $dump_buffer = gzencode($dump_buffer);        }    }    /* If ve saved on server, we have to close file now */    if ($save_on_server) {        $write_result = @fwrite($file_handle, $dump_buffer);        fclose($file_handle);        if (strlen($dump_buffer) !=0 && (!$write_result || ($write_result != strlen($dump_buffer)))) {            $message = new PMA_Message(__('Insufficient space to save the file %s.'), PMA_Message::ERROR, $save_filename);        } else {            $message = new PMA_Message(__('Dump has been saved to file %s.'), PMA_Message::SUCCESS, $save_filename);        }        include_once './libraries/header.inc.php';        if ($export_type == 'server') {            $active_page = 'server_export.php';            include_once './server_export.php';        } elseif ($export_type == 'database') {            $active_page = 'db_export.php';            include_once './db_export.php';        } else {            $active_page = 'tbl_export.php';            include_once './tbl_export.php';        }        exit();    } else {        echo $dump_buffer;    }} else {    /**     * Displays the dump...     *     * Close the html tags and add the footers if dump is displayed on screen     */    echo '</textarea>' . "\n"       . '    </form>' . "\n";    echo $back_button;    echo "\n";    echo '</div>' . "\n";    echo "\n";?><script type="text/javascript">//<![CDATA[    var bodyWidth=null; var bodyHeight=null;    if (document.getElementById('textSQLDUMP')) {        bodyWidth  = self.innerWidth;        bodyHeight = self.innerHeight;        if (!bodyWidth && !bodyHeight) {            if (document.compatMode && document.compatMode == "BackCompat") {                bodyWidth  = document.body.clientWidth;                bodyHeight = document.body.clientHeight;            } else if (document.compatMode && document.compatMode == "CSS1Compat") {                bodyWidth  = document.documentElement.clientWidth;                bodyHeight = document.documentElement.clientHeight;            }        }        document.getElementById('textSQLDUMP').style.width=(bodyWidth-50) + 'px';        document.getElementById('textSQLDUMP').style.height=(bodyHeight-100) + 'px';    }//]]></script><?php    include './libraries/footer.inc.php';} // end if?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * Functions for event management. * * @package PhpMyAdmin */if (! defined('PHPMYADMIN')) {    exit;}/** * Sets required globals */function PMA_EVN_setGlobals(){    global $event_status, $event_type, $event_interval;    $event_status        = array(                               'query'   => array('ENABLE',                                                  'DISABLE',                                                  'DISABLE ON SLAVE'),                               'display' => array('ENABLED',                                                  'DISABLED',                                                  'SLAVESIDE_DISABLED')                           );    $event_type          = array('RECURRING',                                 'ONE TIME');    $event_interval      = array('YEAR',                                 'QUARTER',                                 'MONTH',                                 'DAY',                                 'HOUR',                                 'MINUTE',                                 'WEEK',                                 'SECOND',                                 'YEAR_MONTH',                                 'DAY_HOUR',                                 'DAY_MINUTE',                                 'DAY_SECOND',                                 'HOUR_MINUTE',                                 'HOUR_SECOND',                                 'MINUTE_SECOND');}/** * Main function for the events functionality */function PMA_EVN_main(){    global $db;    PMA_EVN_setGlobals();    /**     * Process all requests     */    PMA_EVN_handleEditor();    PMA_EVN_handleExport();    /**     * Display a list of available events     */    $columns = "`EVENT_NAME`, `EVENT_TYPE`, `STATUS`";    $where   = "EVENT_SCHEMA='" . PMA_sqlAddSlashes($db) . "'";    $query   = "SELECT $columns FROM `INFORMATION_SCHEMA`.`EVENTS` "             . "WHERE $where ORDER BY `EVENT_NAME` ASC;";    $items   = PMA_DBI_fetch_result($query);    echo PMA_RTE_getList('event', $items);    /**     * Display a link for adding a new event, if     * the user has the privileges and a link to     * toggle the state of the event scheduler.     */    echo PMA_EVN_getFooterLinks();} // end PMA_EVN_main()/** * Handles editor requests for adding or editing an item */function PMA_EVN_handleEditor(){    global $_REQUEST, $_POST, $errors, $db;    if (! empty($_REQUEST['editor_process_add'])        || ! empty($_REQUEST['editor_process_edit'])    ) {        $sql_query = '';        $item_query = PMA_EVN_getQueryFromRequest();        if (! count($errors)) { // set by PMA_RTN_getQueryFromRequest()            // Execute the created query            if (! empty($_REQUEST['editor_process_edit'])) {                // Backup the old trigger, in case something goes wrong                $create_item = PMA_DBI_get_definition(                    $db,                    'EVENT',                    $_REQUEST['item_original_name']                );                $drop_item = "DROP EVENT " . PMA_backquote($_REQUEST['item_original_name']) . ";\n";                $result = PMA_DBI_try_query($drop_item);                if (! $result) {                    $errors[] = sprintf(__('The following query has failed: "%s"'), $drop_item) . '<br />'                                      . __('MySQL said: ') . PMA_DBI_getError(null);                } else {                    $result = PMA_DBI_try_query($item_query);                    if (! $result) {                        $errors[] = sprintf(__('The following query has failed: "%s"'), $item_query) . '<br />'                                          . __('MySQL said: ') . PMA_DBI_getError(null);                        // We dropped the old item, but were unable to create the new one                        // Try to restore the backup query                        $result = PMA_DBI_try_query($create_item);                        if (! $result) {                            // OMG, this is really bad! We dropped the query, failed to create a new one                            // and now even the backup query does not execute!                            // This should not happen, but we better handle this just in case.                            $errors[] = __('Sorry, we failed to restore the dropped event.') . '<br />'                                              . __('The backed up query was:') . "\"$create_item\"" . '<br />'                                              . __('MySQL said: ') . PMA_DBI_getError(null);                        }                    } else {                        $message = PMA_Message::success(__('Event %1$s has been modified.'));                        $message->addParam(PMA_backquote($_REQUEST['item_name']));                        $sql_query = $drop_item . $item_query;                    }                }            } else {                // 'Add a new item' mode                $result = PMA_DBI_try_query($item_query);                if (! $result) {                    $errors[] = sprintf(__('The following query has failed: "%s"'), $item_query) . '<br /><br />'                                      . __('MySQL said: ') . PMA_DBI_getError(null);                } else {                    $message = PMA_Message::success(__('Event %1$s has been created.'));                    $message->addParam(PMA_backquote($_REQUEST['item_name']));                    $sql_query = $item_query;                }            }        }        if (count($errors)) {            $message = PMA_Message::error(__('<b>One or more errors have occured while processing your request:</b>'));            $message->addString('<ul>');            foreach ($errors as $string) {                $message->addString('<li>' . $string . '</li>');            }            $message->addString('</ul>');        }        $output = PMA_showMessage($message, $sql_query);        if ($GLOBALS['is_ajax_request']) {            $extra_data = array();            if ($message->isSuccess()) {                $columns = "`EVENT_NAME`, `EVENT_TYPE`, `STATUS`";                $where   = "EVENT_SCHEMA='" . PMA_sqlAddSlashes($db) . "' "                         . "AND EVENT_NAME='" . PMA_sqlAddSlashes($_REQUEST['item_name']) . "'";                $query   = "SELECT $columns FROM `INFORMATION_SCHEMA`.`EVENTS` WHERE $where;";                $event   = PMA_DBI_fetch_single_row($query);                $extra_data['name'] = htmlspecialchars(strtoupper($_REQUEST['item_name']));                $extra_data['new_row'] = PMA_EVN_getRowForList($event);                $extra_data['insert'] = ! empty($event);                $response = $output;            } else {                $response = $message;            }            PMA_ajaxResponse($response, $message->isSuccess(), $extra_data);        }    }    /**     * Display a form used to add/edit a trigger, if necessary     */    if (count($errors) || ( empty($_REQUEST['editor_process_add']) && empty($_REQUEST['editor_process_edit'])        && (! empty($_REQUEST['add_item']) || ! empty($_REQUEST['edit_item'])        || ! empty($_REQUEST['item_changetype'])))    ) { // FIXME: this must be simpler than that        $operation = '';        if (! empty($_REQUEST['item_changetype'])) {            $operation = 'change';        }        // Get the data for the form (if any)        if (! empty($_REQUEST['add_item'])) {            $title = PMA_RTE_getWord('add');            $item = PMA_EVN_getDataFromRequest();            $mode = 'add';        } else if (! empty($_REQUEST['edit_item'])) {            $title = __("Edit event");            if (! empty($_REQUEST['item_name'])                && empty($_REQUEST['editor_process_edit'])                && empty($_REQUEST['item_changetype'])            ) {                $item = PMA_EVN_getDataFromName($_REQUEST['item_name']);                if ($item !== false) {                    $item['item_original_name'] = $item['item_name'];                }            } else {                $item = PMA_EVN_getDataFromRequest();            }            $mode = 'edit';        }        if ($item !== false) {            // Show form            $editor = PMA_EVN_getEditorForm($mode, $operation, $item);            if ($GLOBALS['is_ajax_request']) {                $extra_data = array('title' => $title);                PMA_ajaxResponse($editor, true, $extra_data);            } else {                echo "\n\n<h2>$title</h2>\n\n$editor";                unset($_POST);                include './libraries/footer.inc.php';            }            // exit;        } else {            $message  = __('Error in processing request') . ' : ';            $message .= sprintf(                PMA_RTE_getWord('not_found'),                htmlspecialchars(PMA_backquote($_REQUEST['item_name'])),                htmlspecialchars(PMA_backquote($db))            );            $message = PMA_message::error($message);            if ($GLOBALS['is_ajax_request']) {                PMA_ajaxResponse($message, false);            } else {                $message->display();            }        }    }} // end PMA_EVN_handleEditor()/** * This function will generate the values that are required to for the editor * * @return  array    Data necessary to create the editor. */function PMA_EVN_getDataFromRequest(){    $retval = array();    $indices = array('item_name',                     'item_original_name',                     'item_status',                     'item_execute_at',                     'item_interval_value',                     'item_interval_field',                     'item_starts',                     'item_ends',                     'item_definition',                     'item_preserve',                     'item_comment',                     'item_definer');    foreach ($indices as $index) {        $retval[$index] = isset($_REQUEST[$index]) ? $_REQUEST[$index] : '';    }    $retval['item_type']        = 'ONE TIME';    $retval['item_type_toggle'] = 'RECURRING';    if (isset($_REQUEST['item_type']) && $_REQUEST['item_type'] == 'RECURRING') {        $retval['item_type']        = 'RECURRING';        $retval['item_type_toggle'] = 'ONE TIME';    }    return $retval;} // end PMA_EVN_getDataFromRequest()/** * This function will generate the values that are required to complete * the "Edit event" form given the name of a event. * * @param   string   $name   The name of the event. * * @return  array    Data necessary to create the editor. */function PMA_EVN_getDataFromName($name){    global $db;    $retval = array();    $columns = "`EVENT_NAME`, `STATUS`, `EVENT_TYPE`, `EXECUTE_AT`, "             . "`INTERVAL_VALUE`, `INTERVAL_FIELD`, `STARTS`, `ENDS`, "             . "`EVENT_DEFINITION`, `ON_COMPLETION`, `DEFINER`, `EVENT_COMMENT`";    $where   = "EVENT_SCHEMA='" . PMA_sqlAddSlashes($db) . "' "             . "AND EVENT_NAME='" . PMA_sqlAddSlashes($name) . "'";    $query   = "SELECT $columns FROM `INFORMATION_SCHEMA`.`EVENTS` WHERE $where;";    $item    = PMA_DBI_fetch_single_row($query);    if (! $item) {        return false;    }    $retval['item_name']   = $item['EVENT_NAME'];    $retval['item_status'] = $item['STATUS'];    $retval['item_type']   = $item['EVENT_TYPE'];    if ($retval['item_type'] == 'RECURRING') {        $retval['item_type_toggle'] = 'ONE TIME';    } else {        $retval['item_type_toggle'] = 'RECURRING';    }    $retval['item_execute_at']     = $item['EXECUTE_AT'];    $retval['item_interval_value'] = $item['INTERVAL_VALUE'];    $retval['item_interval_field'] = $item['INTERVAL_FIELD'];    $retval['item_starts']         = $item['STARTS'];    $retval['item_ends']           = $item['ENDS'];    $retval['item_preserve']       = '';    if ($item['ON_COMPLETION'] == 'PRESERVE') {        $retval['item_preserve']   = " checked='checked'";    }    $retval['item_definition'] = $item['EVENT_DEFINITION'];    $retval['item_definer']    = $item['DEFINER'];    $retval['item_comment']    = $item['EVENT_COMMENT'];    return $retval;} // end PMA_EVN_getDataFromName()/** * Displays a form used to add/edit an event * * @param   string   $mode      If the editor will be used edit an event *                              or add a new one: 'edit' or 'add'. * @param   string   $operation If the editor was previously invoked with *                              JS turned off, this will hold the name of *                              the current operation * @param   array    $item      Data for the event returned by *                              PMA_EVN_getDataFromRequest() or *                              PMA_EVN_getDataFromName() * * @return  string   HTML code for the editor. */function PMA_EVN_getEditorForm($mode, $operation, $item){    global $db, $table, $event_status, $event_type, $event_interval;    // Escape special characters    $need_escape = array(                       'item_original_name',                       'item_name',                       'item_type',                       'item_execute_at',                       'item_interval_value',                       'item_starts',                       'item_ends',                       'item_definition',                       'item_definer',                       'item_comment'                   );    foreach ($need_escape as $index) {        $item[$index] = htmlentities($item[$index], ENT_QUOTES);    }    $original_data = '';    if ($mode == 'edit') {        $original_data = "<input name='item_original_name' "                       . "type='hidden' value='{$item['item_original_name']}'/>\n";    }    // Handle some logic first    if ($operation == 'change') {        if ($item['item_type'] == 'RECURRING') {            $item['item_type']         = 'ONE TIME';            $item['item_type_toggle']  = 'RECURRING';        } else {            $item['item_type']         = 'RECURRING';            $item['item_type_toggle']  = 'ONE TIME';        }    }    if ($item['item_type'] == 'ONE TIME') {        $isrecurring_class = ' hide';        $isonetime_class   = '';    } else {        $isrecurring_class = '';        $isonetime_class   = ' hide';    }    // Create the output    $retval  = "";    $retval .= "<!-- START " . strtoupper($mode) . " EVENT FORM -->\n\n";    $retval .= "<form class='rte_form' action='db_events.php' method='post'>\n";    $retval .= "<input name='{$mode}_item' type='hidden' value='1' />\n";    $retval .= $original_data;    $retval .= PMA_generate_common_hidden_inputs($db, $table) . "\n";    $retval .= "<fieldset>\n";    $retval .= "<legend>" . __('Details') . "</legend>\n";    $retval .= "<table class='rte_table' style='width: 100%'>\n";    $retval .= "<tr>\n";    $retval .= "    <td style='width: 20%;'>" . __('Event name') . "</td>\n";    $retval .= "    <td><input type='text' name='item_name' \n";    $retval .= "               value='{$item['item_name']}'\n";    $retval .= "               maxlength='64' /></td>\n";    $retval .= "</tr>\n";    $retval .= "<tr>\n";    $retval .= "    <td>" . __('Status') . "</td>\n";    $retval .= "    <td>\n";    $retval .= "        <select name='item_status'>\n";    foreach ($event_status['display'] as $key => $value) {        $selected = "";        if (! empty($item['item_status']) && $item['item_status'] == $value) {            $selected = " selected='selected'";        }        $retval .= "<option$selected>$value</option>";    }    $retval .= "        </select>\n";    $retval .= "    </td>\n";    $retval .= "</tr>\n";    $retval .= "<tr>\n";    $retval .= "    <td>" . __('Event type') . "</td>\n";    $retval .= "    <td>\n";    if ($GLOBALS['is_ajax_request']) {        $retval .= "        <select name='item_type'>";        foreach ($event_type as $key => $value) {            $selected = "";            if (! empty($item['item_type']) && $item['item_type'] == $value) {                $selected = " selected='selected'";            }            $retval .= "<option$selected>$value</option>";        }        $retval .= "        </select>\n";    } else {        $retval .= "        <input name='item_type' type='hidden' \n";        $retval .= "               value='{$item['item_type']}' />\n";        $retval .= "        <div style='width: 49%; float: left; text-align: center; font-weight: bold;'>\n";        $retval .= "            {$item['item_type']}\n";        $retval .= "        </div>\n";        $retval .= "        <input style='width: 49%;' type='submit'\n";        $retval .= "               name='item_changetype'\n";        $retval .= "               value='";        $retval .= sprintf(__('Change to %s'), $item['item_type_toggle']);        $retval .= "' />\n";    }    $retval .= "    </td>\n";    $retval .= "</tr>\n";    $retval .= "<tr class='onetime_event_row $isonetime_class'>\n";    $retval .= "    <td>" . __('Execute at') . "</td>\n";    $retval .= "    <td class='nowrap'>\n";    $retval .= "        <input type='text' name='item_execute_at'\n";    $retval .= "               value='{$item['item_execute_at']}'\n";    $retval .= "               class='datetimefield' />\n";    $retval .= "    </td>\n";    $retval .= "</tr>\n";    $retval .= "<tr class='recurring_event_row $isrecurring_class'>\n";    $retval .= "    <td>" . __('Execute every') . "</td>\n";    $retval .= "    <td>\n";    $retval .= "        <input style='width: 49%;' type='text'\n";    $retval .= "               name='item_interval_value'\n";    $retval .= "               value='{$item['item_interval_value']}' />\n";    $retval .= "        <select style='width: 49%;' name='item_interval_field'>";    foreach ($event_interval as $key => $value) {        $selected = "";        if (! empty($item['item_interval_field'])            && $item['item_interval_field'] == $value        ) {            $selected = " selected='selected'";        }        $retval .= "<option$selected>$value</option>";    }    $retval .= "        </select>\n";    $retval .= "    </td>\n";    $retval .= "</tr>\n";    $retval .= "<tr class='recurring_event_row$isrecurring_class'>\n";    $retval .= "    <td>" . _pgettext('Start of recurring event', 'Start') . "</td>\n";    $retval .= "    <td class='nowrap'>\n";    $retval .= "        <input type='text'\n name='item_starts'\n";    $retval .= "               value='{$item['item_starts']}'\n";    $retval .= "               class='datetimefield' />\n";    $retval .= "    </td>\n";    $retval .= "</tr>\n";    $retval .= "<tr class='recurring_event_row$isrecurring_class'>\n";    $retval .= "    <td>" . _pgettext('End of recurring event', 'End') . "</td>\n";    $retval .= "    <td class='nowrap'>\n";    $retval .= "        <input type='text' name='item_ends'\n";    $retval .= "               value='{$item['item_ends']}'\n";    $retval .= "               class='datetimefield' />\n";    $retval .= "    </td>\n";    $retval .= "</tr>\n";    $retval .= "<tr>\n";    $retval .= "    <td>" . __('Definition') . "</td>\n";    $retval .= "    <td><textarea name='item_definition' rows='15' cols='40'>";    $retval .= $item['item_definition'];    $retval .= "</textarea></td>\n";    $retval .= "</tr>\n";    $retval .= "<tr>\n";    $retval .= "    <td>" . __('On completion preserve') . "</td>\n";    $retval .= "    <td><input type='checkbox' name='item_preserve'{$item['item_preserve']} /></td>\n";    $retval .= "</tr>\n";    $retval .= "<tr>\n";    $retval .= "    <td>" . __('Definer') . "</td>\n";    $retval .= "    <td><input type='text' name='item_definer'\n";    $retval .= "               value='{$item['item_definer']}' /></td>\n";    $retval .= "</tr>\n";    $retval .= "<tr>\n";    $retval .= "    <td>" . __('Comment') . "</td>\n";    $retval .= "    <td><input type='text' name='item_comment' maxlength='64'\n";    $retval .= "               value='{$item['item_comment']}' /></td>\n";    $retval .= "</tr>\n";    $retval .= "</table>\n";    $retval .= "</fieldset>\n";    if ($GLOBALS['is_ajax_request']) {        $retval .= "<input type='hidden' name='editor_process_{$mode}'\n";        $retval .= "       value='true' />\n";        $retval .= "<input type='hidden' name='ajax_request' value='true' />\n";    } else {        $retval .= "<fieldset class='tblFooters'>\n";        $retval .= "    <input type='submit' name='editor_process_{$mode}'\n";        $retval .= "           value='" . __('Go') . "' />\n";        $retval .= "</fieldset>\n";    }    $retval .= "</form>\n\n";    $retval .= "<!-- END " . strtoupper($mode) . " EVENT FORM -->\n\n";    return $retval;} // end PMA_EVN_getEditorForm()/** * Composes the query necessary to create an event from an HTTP request. * * @return  string  The CREATE EVENT query. */function PMA_EVN_getQueryFromRequest(){    global $_REQUEST, $errors, $event_status, $event_type, $event_interval;    $query = 'CREATE ';    if (! empty($_REQUEST['item_definer'])) {        if (strpos($_REQUEST['item_definer'], '@') !== false) {            $arr = explode('@', $_REQUEST['item_definer']);            $query .= 'DEFINER=' . PMA_backquote($arr[0]);            $query .= '@' . PMA_backquote($arr[1]) . ' ';        } else {            $errors[] = __('The definer must be in the "username@hostname" format');        }    }    $query .= 'EVENT ';    if (! empty($_REQUEST['item_name'])) {        $query .= PMA_backquote($_REQUEST['item_name']) . ' ';    } else {        $errors[] = __('You must provide an event name');    }    $query .= 'ON SCHEDULE ';    if (! empty($_REQUEST['item_type']) && in_array($_REQUEST['item_type'], $event_type)) {        if ($_REQUEST['item_type'] == 'RECURRING') {            if (! empty($_REQUEST['item_interval_value'])                && !empty($_REQUEST['item_interval_field'])                && in_array($_REQUEST['item_interval_field'], $event_interval)            ) {                $query .= 'EVERY ' . intval($_REQUEST['item_interval_value']) . ' ';                $query .= $_REQUEST['item_interval_field'] . ' ';            } else {                $errors[] = __('You must provide a valid interval value for the event.');            }            if (! empty($_REQUEST['item_starts'])) {                $query .= "STARTS '" . PMA_sqlAddSlashes($_REQUEST['item_starts']) . "' ";            }            if (! empty($_REQUEST['item_ends'])) {                $query .= "ENDS '" . PMA_sqlAddSlashes($_REQUEST['item_ends']) . "' ";            }        } else {            if (! empty($_REQUEST['item_execute_at'])) {                $query .= "AT '" . PMA_sqlAddSlashes($_REQUEST['item_execute_at']) . "' ";            } else {                $errors[] = __('You must provide a valid execution time for the event.');            }        }    } else {        $errors[] = __('You must provide a valid type for the event.');    }    $query .= 'ON COMPLETION ';    if (empty($_REQUEST['item_preserve'])) {        $query .= 'NOT ';    }    $query .= 'PRESERVE ';    if (! empty($_REQUEST['item_status'])) {        foreach ($event_status['display'] as $key => $value) {            if ($value == $_REQUEST['item_status']) {                $query .= $event_status['query'][$key] . ' ';                break;            }        }    }    $query .= 'DO ';    if (! empty($_REQUEST['item_definition'])) {        $query .= $_REQUEST['item_definition'];    } else {        $errors[] = __('You must provide an event definition.');    }    return $query;} // end PMA_EVN_getQueryFromRequest()?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'import.js';/** * Gets tables informations and displays top links */require './libraries/db_common.inc.php';require './libraries/db_info.inc.php';$import_type = 'database';require './libraries/display_import.lib.php';/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'import.js';/** * Gets tables informations and displays top links */require_once './libraries/tbl_common.php';$url_query .= '&amp;goto=tbl_import.php&amp;back=tbl_import.php';require_once './libraries/tbl_info.inc.php';/** * Displays top menu links */require_once './libraries/tbl_links.inc.php';$import_type = 'table';require_once './libraries/display_import.lib.php';/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * session handling * * @todo    add failover or warn if sessions are not configured properly * @todo    add an option to use mm-module for session handler * @see     http://www.php.net/session * @package PhpMyAdmin */if (! defined('PHPMYADMIN')) {    exit;}// verify if PHP supports session, die if it does notif (!@function_exists('session_name')) {    PMA_warnMissingExtension('session', true);} elseif (ini_get('session.auto_start') == true && session_name() != 'phpMyAdmin') {    // Do not delete the existing session, it might be used by other    // applications; instead just close it.    session_write_close();}// disable starting of sessions before all settings are done// does not work, besides how it is written in php manual//ini_set('session.auto_start', 0);// session cookie settingssession_set_cookie_params(0, $GLOBALS['PMA_Config']->getCookiePath(),    '', $GLOBALS['PMA_Config']->isHttps(), true);// cookies are safer (use @ini_set() in case this function is disabled)@ini_set('session.use_cookies', true);// optionally set session_save_path$path = $GLOBALS['PMA_Config']->get('SessionSavePath');if (!empty($path)) {    session_save_path($path);}// but not all user allow cookies@ini_set('session.use_only_cookies', false);// do not force transparent session ids, see bug #3398788//@ini_set('session.use_trans_sid', true);@ini_set('url_rewriter.tags',    'a=href,frame=src,input=src,form=fakeentry,fieldset=');//ini_set('arg_separator.output', '&amp;');// delete session/cookies when browser is closed@ini_set('session.cookie_lifetime', 0);// warn but dont work with bug@ini_set('session.bug_compat_42', false);@ini_set('session.bug_compat_warn', true);// use more secure session ids@ini_set('session.hash_function', 1);// some pages (e.g. stylesheet) may be cached on clients, but not in shared// proxy serverssession_cache_limiter('private');// start the session// on some servers (for example, sourceforge.net), we get a permission error// on the session data directory, so I add some "@"// See bug #1538132. This would block normal behavior on a cluster//ini_set('session.save_handler', 'files');$session_name = 'phpMyAdmin';@session_name($session_name);if (! isset($_COOKIE[$session_name])) {    // on first start of session we check for errors    // f.e. session dir cannot be accessed - session file not created    $orig_error_count = $GLOBALS['error_handler']->countErrors();    $r = session_start();    if ($r !== true || $orig_error_count != $GLOBALS['error_handler']->countErrors()) {        setcookie($session_name, '', 1);        /*         * Session initialization is done before selecting language, so we         * can not use translations here.         */        PMA_fatalError('Cannot start session without errors, please check errors given in your PHP and/or webserver log file and configure your PHP installation properly.');    }    unset($orig_error_count);} else {    session_start();}/** * Token which is used for authenticating access queries. * (we use "space PMA_token space" to prevent overwriting) */if (! isset($_SESSION[' PMA_token '])) {    $_SESSION[' PMA_token '] = md5(uniqid(rand(), true));}/** * tries to secure session from hijacking and fixation * should be called before login and after successfull login * (only required if sensitive information stored in session) * */function PMA_secureSession(){    // prevent session fixation and XSS    session_regenerate_id(true);    $_SESSION[' PMA_token '] = md5(uniqid(rand(), true));}?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * this file is register_globals safe * * @todo    move JavaScript out of here into .js files * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';$is_superuser = PMA_isSuperuser();/** * Gets a core script and starts output buffering work */require_once './libraries/sql_query_form.lib.php';/** * starts output buffering if requested and supported */require_once './libraries/ob.lib.php';PMA_outBufferPre();/** * load relation params */$cfgRelation = PMA_getRelationsParam();/** * load bookmark support */require_once './libraries/bookmark.lib.php';$querydisplay_tabs = array(    'sql',    'files',    'history',    'full',);if (isset($_REQUEST['querydisplay_tab']) && in_array($_REQUEST['querydisplay_tab'], $querydisplay_tabs)) {    $querydisplay_tab = $_REQUEST['querydisplay_tab'];} else {    $querydisplay_tab = $GLOBALS['cfg']['QueryWindowDefTab'];}/** * $_REQUEST['no_js'] is set if open new window by JavaScript failed * so this page is loaded in main frame */$no_js = PMA_ifSetOr($_REQUEST['no_js'], false);if ($no_js) {    $querydisplay_tab = 'full';    $tabs = false;} else {    $tabs = array();    $tabs['sql']['icon']   = 'b_sql.png';    $tabs['sql']['text']   = __('SQL');    $tabs['sql']['fragment']   = '#';    $tabs['sql']['attr']   = 'onclick="PMA_querywindowCommit(\'sql\');return false;"';    $tabs['sql']['active'] = (bool) ($querydisplay_tab == 'sql');    $tabs['import']['icon']   = 'b_import.png';    $tabs['import']['text']   = __('Import files');    $tabs['import']['fragment']   = '#';    $tabs['import']['attr']   = 'onclick="PMA_querywindowCommit(\'files\');return false;"';    $tabs['import']['active'] = (bool) ($querydisplay_tab == 'files');    $tabs['history']['icon']   = 'b_bookmark.png';    $tabs['history']['text']   = __('SQL history');    $tabs['history']['fragment']   = '#';    $tabs['history']['attr']   = 'onclick="PMA_querywindowCommit(\'history\');return false;"';    $tabs['history']['active'] = (bool) ($querydisplay_tab == 'history');    if ($GLOBALS['cfg']['QueryWindowDefTab'] == 'full') {        $tabs['all']['text']   = __('All');        $tabs['all']['fragment']   = '#';        $tabs['all']['attr']   = 'onclick="PMA_querywindowCommit(\'full\');return false;"';        $tabs['all']['active'] = (bool) ($querydisplay_tab == 'full');    }}$titles['Change'] = PMA_getIcon('b_edit.png', __('Change'));$url_query = PMA_generate_common_url($db, $table);if (! empty($sql_query)) {    $show_query = 1;}if ($no_js) {    // ... we redirect to appropriate query sql page    // works only full if $db and $table is also stored/grabbed from $_COOKIE    if (strlen($table)) {        include './tbl_sql.php';    } elseif (strlen($db)) {        include './db_sql.php';    } else {        include './server_sql.php';    }    exit;}/** * Defines the query to be displayed in the query textarea */if (! empty($show_query)) {    $query_to_display = $sql_query;} else {    $query_to_display = '';}$sql_query = '';/** * prepare JavaScript functionality */$js_include[] = 'common.js';$js_include[] = 'querywindow.js';if (PMA_isValid($_REQUEST['auto_commit'], 'identical', 'true')) {    $js_events[] = array(        'event'     => 'load',        'function'  => 'PMA_queryAutoCommit',    );}if (PMA_isValid($_REQUEST['init'])) {    $js_events[] = array(        'event'     => 'load',        'function'  => 'PMA_querywindowResize',    );}// always set focus to the textareaif ($querydisplay_tab == 'sql' || $querydisplay_tab == 'full') {    $js_events[] = array(        'event'     => 'load',        'function'  => 'PMA_querywindowSetFocus',    );}/** * start HTTP/HTML output */require_once './libraries/header_http.inc.php';require_once './libraries/header_meta_style.inc.php';require_once './libraries/header_scripts.inc.php';?></head><body id="bodyquerywindow"><div id="querywindowcontainer"><?phpif ($tabs) {    echo PMA_generate_html_tabs($tabs, array());    unset($tabs);}PMA_sqlQueryForm($query_to_display, $querydisplay_tab);// Hidden forms and query frame interaction stuff$_sql_history = PMA_getHistory($GLOBALS['cfg']['Server']['user']);if (! empty($_sql_history) && ($querydisplay_tab == 'history' || $querydisplay_tab == 'full')) {    $tab = $querydisplay_tab != 'full' ? 'sql' : 'full';    echo __('SQL history') . ':<br />'        . '<ul>';    foreach ($_sql_history as $query) {        echo '<li>' . "\n";        // edit link        $url_params = array(            'querydisplay_tab' => $tab,            'sql_query' => $query['sqlquery'],            'db' => $query['db'],            'table' => $query['table'],        );        echo '<a href="querywindow.php' . PMA_generate_common_url($url_params)            . '">' . $titles['Change'] . '</a>';        // execute link        $url_params['auto_commit'] = 'true';        echo '<a href="import.php' . PMA_generate_common_url($url_params) . '"'            . ' target="frame_content">';        if (! empty($query['db'])) {            echo '[';            echo htmlspecialchars(PMA_backquote($query['db']));            if (! empty($query['table'])) {                echo '.' . htmlspecialchars(PMA_backquote($query['table']));            }            echo  '] ';        }        if (strlen($query['sqlquery']) > 120) {            echo '<span title="' . htmlspecialchars($query['sqlquery']) . '">';            echo htmlspecialchars(substr($query['sqlquery'], 0, 50)) . ' [...] ';            echo htmlspecialchars(substr($query['sqlquery'], -50));            echo '</span>';        } else {            echo htmlspecialchars($query['sqlquery']);        }        echo '</a>' . "\n";        echo '</li>' . "\n";    }    unset($tab, $_sql_history, $query);    echo '</ul>' . "\n";}?><form action="querywindow.php" method="post" name="hiddenqueryform"    id="hiddenqueryform">    <?php echo PMA_generate_common_hidden_inputs('', ''); ?>    <input type="hidden" name="db" value="<?php echo htmlspecialchars($db); ?>" />    <input type="hidden" name="table" value="<?php echo htmlspecialchars($table); ?>" />    <input type="hidden" name="sql_query" value="" />    <input type="hidden" name="querydisplay_tab" value="<?php echo $querydisplay_tab; ?>" /></form></div></body></html>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * displays the pma logo, links and db and server selection in left frame * * @package PhpMyAdmin */if (! defined('PHPMYADMIN')) {    exit;}/** * */if (empty($query_url)) {    // avoid putting here $db because it could display a db name    // to which the next user does not have access    $query_url = PMA_generate_common_url();}// display Logo, depending on $GLOBALS['cfg']['LeftDisplayLogo']if ($GLOBALS['cfg']['LeftDisplayLogo']) {    $logo = 'phpMyAdmin';    if (@file_exists($GLOBALS['pmaThemeImage'] . 'logo_left.png')) {        $logo = '<img src="' . $GLOBALS['pmaThemeImage'] . 'logo_left.png" '            .'alt="' . $logo . '" id="imgpmalogo" />';    } elseif (@file_exists($GLOBALS['pmaThemeImage'] . 'pma_logo2.png')) {        $logo = '<img src="' . $GLOBALS['pmaThemeImage'] . 'pma_logo2.png" '            .'alt="' . $logo . '" id="imgpmalogo" />';    }    echo '<div id="pmalogo">' . "\n";    if ($GLOBALS['cfg']['LeftLogoLink']) {        echo '<a href="' . htmlspecialchars($GLOBALS['cfg']['LeftLogoLink']);        switch ($GLOBALS['cfg']['LeftLogoLinkWindow']) {            case 'new':                echo '" target="_blank"';                break;            case 'main':                // do not add our parameters for an external link                if (substr(strtolower($GLOBALS['cfg']['LeftLogoLink']), 0, 4) !== '://') {                    echo '?' . $query_url . '" target="frame_content"';                } else {                    echo '" target="_blank"';                }        }        echo '>' . $logo . '</a>' . "\n";    } else {        echo $logo . "\n";    }    echo '</div>' . "\n";} // end of display logo?><div id="leftframelinks"><?php    echo '<a href="main.php?' . $query_url . '"'        .' title="' . __('Home') . '">'        .($GLOBALS['cfg']['MainPageIconic']            ? PMA_getImage('b_home.png', __('Home'))            : __('Home'))        .'</a>' . "\n";    // if we have chosen server    if ($server != 0) {        // Logout for advanced authentication        if ($GLOBALS['cfg']['Server']['auth_type'] != 'config') {            echo ($GLOBALS['cfg']['MainPageIconic'] ? '' : ' - ');            echo '<a href="index.php?' . $query_url . '&amp;old_usr='                .urlencode($PHP_AUTH_USER) . '" target="_parent"'                .' title="' . __('Log out') . '" >'                .($GLOBALS['cfg']['MainPageIconic']                    ? PMA_getImage('s_loggoff.png', __('Log out'))                    : __('Log out'))                .'</a>' . "\n";        } // end if ($GLOBALS['cfg']['Server']['auth_type'] != 'config'        $anchor = 'querywindow.php?' . PMA_generate_common_url($db, $table);        if ($GLOBALS['cfg']['MainPageIconic']) {            $query_frame_link_text = PMA_getImage('b_selboard.png', __('Query window'));        } else {            echo '<br />' . "\n";            $query_frame_link_text = __('Query window');        }        echo '<a href="' . $anchor . '&amp;no_js=true"'            .' title="' . __('Query window') . '"';        echo ' onclick="if (window.parent.open_querywindow()) return false;"';        echo '>' . $query_frame_link_text . '</a>' . "\n";    } // end if ($server != 0)    echo '    <a href="Documentation.html" target="documentation"'        .' title="' . __('phpMyAdmin documentation') . '" >';    if ($GLOBALS['cfg']['MainPageIconic']) {        echo PMA_getImage('b_docs.png', __('phpMyAdmin documentation'));    } else {        echo '<br />' . __('phpMyAdmin documentation');    }    echo '</a>';    $documentation_link = PMA_showMySQLDocu('', '', true);    if ($GLOBALS['cfg']['MainPageIconic']) {        echo $documentation_link . "\n";    } else {        preg_match('/<a[^>]*>/', $documentation_link, $matches);        $link = $matches[0];        echo substr($link, 0, strlen($link) - 1) . ' title="' . __('Documentation') . '" >'            . '<br />' . __('Documentation') . '</a>';    }    $params = array('uniqid' => uniqid());    if (!empty($GLOBALS['db'])) {        $params['db'] = $GLOBALS['db'];    }    echo '<a href="navigation.php?' . PMA_generate_common_url($params)        . '" title="' . __('Reload navigation frame') . '" target="frame_navigation">';    if ($GLOBALS['cfg']['MainPageIconic']) {        echo PMA_getImage('s_reload', __('Reload navigation frame'));    } else {        echo '<br />' . __('Reload navigation frame');    }    echo '</a>';echo '</div>' . "\n";/** * Displays the MySQL servers choice form */if ($GLOBALS['cfg']['LeftDisplayServers'] && (count($GLOBALS['cfg']['Servers']) > 1 || $server == 0 && count($GLOBALS['cfg']['Servers']) == 1)) {    echo '<div id="serverinfo">';    include './libraries/select_server.lib.php';    PMA_select_server(true, true);    echo '</div><br />';} // end if LeftDisplayServers?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';/** * Runs common work */$GLOBALS['js_include'][] = 'functions.js';$GLOBALS['js_include'][] = 'makegrid.js';$GLOBALS['js_include'][] = 'sql.js';$GLOBALS['js_include'][] = 'codemirror/lib/codemirror.js';$GLOBALS['js_include'][] = 'codemirror/mode/mysql/mysql.js';require './libraries/db_common.inc.php';require_once './libraries/sql_query_form.lib.php';// After a syntax error, we return to this script// with the typed query in the textarea.$goto = 'db_sql.php';$back = 'db_sql.php';/** * Gets informations about the database and, if it is empty, move to the * "db_structure.php" script where table can be created */require './libraries/db_info.inc.php';if ($num_tables == 0 && empty($db_query_force)) {    $sub_part   = '';    $is_info    = true;    include './db_structure.php';    exit();}/** * Query box, bookmark, insert data from textfile */PMA_sqlQueryForm(true, false, isset($_REQUEST['delimiter']) ? htmlspecialchars($_REQUEST['delimiter']) : ';');/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * library for displaying table with results from all sort of select queries * * @package PhpMyAdmin *//** * */require_once './libraries/Index.class.php';/** * Defines the display mode to use for the results of a SQL query * * It uses a synthetic string that contains all the required informations. * In this string: *   - the first two characters stand for the action to do while *     clicking on the "edit" link (e.g. 'ur' for update a row, 'nn' for no *     edit link...); *   - the next two characters stand for the action to do while *     clicking on the "delete" link (e.g. 'kp' for kill a process, 'nn' for *     no delete link...); *   - the next characters are boolean values (1/0) and respectively stand *     for sorting links, navigation bar, "insert a new row" link, the *     bookmark feature, the expand/collapse text/blob fields button and *     the "display printable view" option. *     Of course '0'/'1' means the feature won't/will be enabled. * * @param string  &$the_disp_mode the synthetic value for display_mode (see a few *                                lines above for explanations) * @param integer &$the_total     the total number of rows returned by the SQL query *                                without any programmatically appended "LIMIT" clause *                                (just a copy of $unlim_num_rows if it exists, else *                                computed inside this function) * * @return  array    an array with explicit indexes for all the display *                   elements * * @global  string   the database name * @global  string   the table name * @global  integer  the total number of rows returned by the SQL query *                   without any programmatically appended "LIMIT" clause * @global  array    the properties of the fields returned by the query * @global  string   the URL to return to in case of error in a SQL *                   statement * * @access  private * * @see     PMA_displayTable() */function PMA_setDisplayMode(&$the_disp_mode, &$the_total){    global $db, $table;    global $unlim_num_rows, $fields_meta;    global $err_url;    // 1. Initializes the $do_display array    $do_display              = array();    $do_display['edit_lnk']  = $the_disp_mode[0] . $the_disp_mode[1];    $do_display['del_lnk']   = $the_disp_mode[2] . $the_disp_mode[3];    $do_display['sort_lnk']  = (string) $the_disp_mode[4];    $do_display['nav_bar']   = (string) $the_disp_mode[5];    $do_display['ins_row']   = (string) $the_disp_mode[6];    $do_display['bkm_form']  = (string) $the_disp_mode[7];    $do_display['text_btn']  = (string) $the_disp_mode[8];    $do_display['pview_lnk'] = (string) $the_disp_mode[9];    // 2. Display mode is not "false for all elements" -> updates the    // display mode    if ($the_disp_mode != 'nnnn000000') {        if (isset($GLOBALS['printview']) && $GLOBALS['printview'] == '1') {            // 2.0 Print view -> set all elements to false!            $do_display['edit_lnk']  = 'nn'; // no edit link            $do_display['del_lnk']   = 'nn'; // no delete link            $do_display['sort_lnk']  = (string) '0';            $do_display['nav_bar']   = (string) '0';            $do_display['ins_row']   = (string) '0';            $do_display['bkm_form']  = (string) '0';            $do_display['text_btn']  = (string) '0';            $do_display['pview_lnk'] = (string) '0';        } elseif ($GLOBALS['is_count'] || $GLOBALS['is_analyse']            || $GLOBALS['is_maint'] || $GLOBALS['is_explain']            ) {            // 2.1 Statement is a "SELECT COUNT", a            //     "CHECK/ANALYZE/REPAIR/OPTIMIZE", an "EXPLAIN" one or            //     contains a "PROC ANALYSE" part            $do_display['edit_lnk']  = 'nn'; // no edit link            $do_display['del_lnk']   = 'nn'; // no delete link            $do_display['sort_lnk']  = (string) '0';            $do_display['nav_bar']   = (string) '0';            $do_display['ins_row']   = (string) '0';            $do_display['bkm_form']  = (string) '1';            if ($GLOBALS['is_maint']) {                $do_display['text_btn']  = (string) '1';            } else {                $do_display['text_btn']  = (string) '0';            }            $do_display['pview_lnk'] = (string) '1';        } elseif ($GLOBALS['is_show']) {            // 2.2 Statement is a "SHOW..."            /**             * 2.2.1             * @todo defines edit/delete links depending on show statement             */            $tmp = preg_match('@^SHOW[[:space:]]+(VARIABLES|(FULL[[:space:]]+)?PROCESSLIST|STATUS|TABLE|GRANTS|CREATE|LOGS|DATABASES|FIELDS)@i', $GLOBALS['sql_query'], $which);            if (isset($which[1]) && strpos(' ' . strtoupper($which[1]), 'PROCESSLIST') > 0) {                $do_display['edit_lnk'] = 'nn'; // no edit link                $do_display['del_lnk']  = 'kp'; // "kill process" type edit link            } else {                // Default case -> no links                $do_display['edit_lnk'] = 'nn'; // no edit link                $do_display['del_lnk']  = 'nn'; // no delete link            }            // 2.2.2 Other settings            $do_display['sort_lnk']  = (string) '0';            $do_display['nav_bar']   = (string) '0';            $do_display['ins_row']   = (string) '0';            $do_display['bkm_form']  = (string) '1';            $do_display['text_btn']  = (string) '1';            $do_display['pview_lnk'] = (string) '1';        } else {            // 2.3 Other statements (ie "SELECT" ones) -> updates            //     $do_display['edit_lnk'], $do_display['del_lnk'] and            //     $do_display['text_btn'] (keeps other default values)            $prev_table = $fields_meta[0]->table;            $do_display['text_btn']  = (string) '1';            for ($i = 0; $i < $GLOBALS['fields_cnt']; $i++) {                $is_link = ($do_display['edit_lnk'] != 'nn'                            || $do_display['del_lnk'] != 'nn'                            || $do_display['sort_lnk'] != '0'                            || $do_display['ins_row'] != '0');                // 2.3.2 Displays edit/delete/sort/insert links?                if ($is_link                    && ($fields_meta[$i]->table == '' || $fields_meta[$i]->table != $prev_table)                ) {                    $do_display['edit_lnk'] = 'nn'; // don't display links                    $do_display['del_lnk']  = 'nn';                    /**                     * @todo May be problematic with same fields names in two joined table.                     */                    // $do_display['sort_lnk'] = (string) '0';                    $do_display['ins_row']  = (string) '0';                    if ($do_display['text_btn'] == '1') {                        break;                    }                } // end if (2.3.2)                // 2.3.3 Always display print view link                $do_display['pview_lnk']    = (string) '1';                $prev_table = $fields_meta[$i]->table;            } // end for        } // end if..elseif...else (2.1 -> 2.3)    } // end if (2)    // 3. Gets the total number of rows if it is unknown    if (isset($unlim_num_rows) && $unlim_num_rows != '') {        $the_total = $unlim_num_rows;    } elseif (($do_display['nav_bar'] == '1' || $do_display['sort_lnk'] == '1')             && (strlen($db) && !empty($table))) {        $the_total   = PMA_Table::countRecords($db, $table);    }    // 4. If navigation bar or sorting fields names URLs should be    //    displayed but there is only one row, change these settings to    //    false    if ($do_display['nav_bar'] == '1' || $do_display['sort_lnk'] == '1') {        // - Do not display sort links if less than 2 rows.        // - For a VIEW we (probably) did not count the number of rows        //   so don't test this number here, it would remove the possibility        //   of sorting VIEW results.        if (isset($unlim_num_rows) && $unlim_num_rows < 2 && ! PMA_Table::isView($db, $table)) {            // force display of navbar for vertical/horizontal display-choice.            // $do_display['nav_bar']  = (string) '0';            $do_display['sort_lnk'] = (string) '0';        }    } // end if (3)    // 5. Updates the synthetic var    $the_disp_mode = join('', $do_display);    return $do_display;} // end of the 'PMA_setDisplayMode()' function/** * Return true if we are executing a query in the form of * "SELECT * FROM <a table> ..." * * @return boolean */function PMA_isSelect(){    // global variables set from sql.php    global $is_count, $is_export, $is_func, $is_analyse;    global $analyzed_sql;    return ! ($is_count || $is_export || $is_func || $is_analyse)        && count($analyzed_sql[0]['select_expr']) == 0        && isset($analyzed_sql[0]['queryflags']['select_from'])        && count($analyzed_sql[0]['table_ref']) == 1;}/** * Displays a navigation button * * @param string  $caption            iconic caption for button * @param string  $title              text for button * @param integer $pos                position for next query * @param string  $html_sql_query     query ready for display * @param string  $onsubmit           optional onsubmit clause * @param string  $input_for_real_end optional hidden field for special treatment * @param string  $onclick            optional onclick clause * * @return nothing * * @global string   $db             the database name * @global string   $table          the table name * @global string   $goto           the URL to go back in case of errors * * @access private * * @see     PMA_displayTableNavigation() */function PMA_displayTableNavigationOneButton($caption, $title, $pos, $html_sql_query, $onsubmit = '', $input_for_real_end = '', $onclick = ''){    global $db, $table, $goto;    $caption_output = '';    // for true or 'both'    if ($GLOBALS['cfg']['NavigationBarIconic']) {        $caption_output .= $caption;    }    // for false or 'both'    if (false === $GLOBALS['cfg']['NavigationBarIconic'] || 'both' === $GLOBALS['cfg']['NavigationBarIconic']) {        $caption_output .= '&nbsp;' . $title;    }    $title_output = ' title="' . $title . '"';        ?><td>    <form action="sql.php" method="post" <?php echo $onsubmit; ?>>        <?php echo PMA_generate_common_hidden_inputs($db, $table); ?>        <input type="hidden" name="sql_query" value="<?php echo $html_sql_query; ?>" />        <input type="hidden" name="pos" value="<?php echo $pos; ?>" />        <input type="hidden" name="goto" value="<?php echo $goto; ?>" />        <?php echo $input_for_real_end; ?>        <input type="submit" name="navig" <?php echo ($GLOBALS['cfg']['AjaxEnable'] ? ' class="ajax" ' : '' ); ?> value="<?php echo $caption_output; ?>"<?php echo $title_output . $onclick; ?> />    </form></td><?php} // end function PMA_displayTableNavigationOneButton()/** * Displays a navigation bar to browse among the results of a SQL query * * @param integer $pos_next                  the offset for the "next" page * @param integer $pos_prev                  the offset for the "previous" page * @param string  $sql_query                 the URL-encoded query * @param string  $id_for_direction_dropdown the id for the direction dropdown * * @return nothing * * @global  string   $db             the database name * @global  string   $table          the table name * @global  string   $goto           the URL to go back in case of errors * @global  integer  $num_rows       the total number of rows returned by the *                                   SQL query * @global  integer  $unlim_num_rows the total number of rows returned by the *                                   SQL any programmatically appended "LIMIT" clause * @global  boolean  $is_innodb      whether its InnoDB or not * @global  array    $showtable      table definitions * * @access  private * * @see     PMA_displayTable() */function PMA_displayTableNavigation($pos_next, $pos_prev, $sql_query, $id_for_direction_dropdown){    global $db, $table, $goto;    global $num_rows, $unlim_num_rows;    global $is_innodb;    global $showtable;    // here, using htmlentities() would cause problems if the query    // contains accented characters    $html_sql_query = htmlspecialchars($sql_query);    /**     * @todo move this to a central place     * @todo for other future table types     */    $is_innodb = (isset($showtable['Type']) && $showtable['Type'] == 'InnoDB');    ?><!-- Navigation bar --><table border="0" cellpadding="0" cellspacing="0" class="navigation"><tr>    <td class="navigation_separator"></td>    <?php    // Move to the beginning or to the previous page    if ($_SESSION['tmp_user_values']['pos'] && $_SESSION['tmp_user_values']['max_rows'] != 'all') {        PMA_displayTableNavigationOneButton('&lt;&lt;', _pgettext('First page', 'Begin'), 0, $html_sql_query);        PMA_displayTableNavigationOneButton('&lt;', _pgettext('Previous page', 'Previous'), $pos_prev, $html_sql_query);    } // end move back    $nbTotalPage = 1;    //page redirection    // (unless we are showing all records)    if ('all' != $_SESSION['tmp_user_values']['max_rows']) { //if1        $pageNow = @floor($_SESSION['tmp_user_values']['pos'] / $_SESSION['tmp_user_values']['max_rows']) + 1;        $nbTotalPage = @ceil($unlim_num_rows / $_SESSION['tmp_user_values']['max_rows']);        if ($nbTotalPage > 1) { //if2       ?>   <td>        <?php            $_url_params = array(                'db'        => $db,                'table'     => $table,                'sql_query' => $sql_query,                'goto'      => $goto,            );            //<form> to keep the form alignment of button < and <<            // and also to know what to execute when the selector changes            echo '<form action="sql.php' . PMA_generate_common_url($_url_params). '" method="post">';            echo PMA_pageselector(                $_SESSION['tmp_user_values']['max_rows'],                $pageNow,                $nbTotalPage,                200,                5,                5,                20,                10            );        ?>        </form>    </td>        <?php        } //_if2    } //_if1    // Display the "Show all" button if allowed    if (($num_rows < $unlim_num_rows) && ($GLOBALS['cfg']['ShowAll'] || ($GLOBALS['cfg']['MaxRows'] * 5 >= $unlim_num_rows))) {        echo "\n";        ?>    <td>        <form action="sql.php" method="post">            <?php echo PMA_generate_common_hidden_inputs($db, $table); ?>            <input type="hidden" name="sql_query" value="<?php echo $html_sql_query; ?>" />            <input type="hidden" name="pos" value="0" />            <input type="hidden" name="session_max_rows" value="all" />            <input type="hidden" name="goto" value="<?php echo $goto; ?>" />            <input type="submit" name="navig" value="<?php echo __('Show all'); ?>" />        </form>    </td>        <?php    } // end show all    // Move to the next page or to the last one    if (($_SESSION['tmp_user_values']['pos'] + $_SESSION['tmp_user_values']['max_rows'] < $unlim_num_rows)        && $num_rows >= $_SESSION['tmp_user_values']['max_rows']        && $_SESSION['tmp_user_values']['max_rows'] != 'all'    ) {        // display the Next button        PMA_displayTableNavigationOneButton(            '&gt;',            _pgettext('Next page', 'Next'),            $pos_next,            $html_sql_query        );        // prepare some options for the End button        if ($is_innodb && $unlim_num_rows > $GLOBALS['cfg']['MaxExactCount']) {            $input_for_real_end = '<input id="real_end_input" type="hidden" name="find_real_end" value="1" />';            // no backquote around this message            $onclick = '';        } else {            $input_for_real_end = $onclick = '';        }        // display the End button        PMA_displayTableNavigationOneButton(            '&gt;&gt;',            _pgettext('Last page', 'End'),            @((ceil($unlim_num_rows / $_SESSION['tmp_user_values']['max_rows'])- 1) * $_SESSION['tmp_user_values']['max_rows']),            $html_sql_query,            'onsubmit="return ' . (($_SESSION['tmp_user_values']['pos'] + $_SESSION['tmp_user_values']['max_rows'] < $unlim_num_rows && $num_rows >= $_SESSION['tmp_user_values']['max_rows']) ? 'true' : 'false') . '"',            $input_for_real_end,            $onclick        );    } // end move toward    // show separator if pagination happen    if ($nbTotalPage > 1) {        echo '<td><div class="navigation_separator">|</div></td>';    }    ?>    <td>        <div class="save_edited hide">            <input type="submit" value="<?php echo __('Save edited data'); ?>" />            <div class="navigation_separator">|</div>        </div>    </td>    <td>        <div class="restore_column hide">            <input type="submit" value="<?php echo __('Restore column order'); ?>" />            <div class="navigation_separator">|</div>        </div>    </td><?php // if displaying a VIEW, $unlim_num_rows could be zero because      // of $cfg['MaxExactCountViews']; in this case, avoid passing      // the 5th parameter to checkFormElementInRange()      // (this means we can't validate the upper limit ?>    <td class="navigation_goto">        <form action="sql.php" method="post"    onsubmit="return (checkFormElementInRange(this, 'session_max_rows', '<?php echo str_replace('\'', '\\\'', __('%d is not valid row number.')); ?>', 1) &amp;&amp; checkFormElementInRange(this, 'pos', '<?php echo str_replace('\'', '\\\'', __('%d is not valid row number.')); ?>', 0<?php echo $unlim_num_rows > 0 ? ',' . $unlim_num_rows - 1 : ''; ?>))">            <?php echo PMA_generate_common_hidden_inputs($db, $table); ?>            <input type="hidden" name="sql_query" value="<?php echo $html_sql_query; ?>" />            <input type="hidden" name="goto" value="<?php echo $goto; ?>" />            <input type="submit" name="navig" <?php echo ($GLOBALS['cfg']['AjaxEnable'] ? ' class="ajax"' : ''); ?> value="<?php echo __('Show'); ?> :" />            <?php echo __('Start row') . ': ' . "\n"; ?>            <input type="text" name="pos" size="3" value="<?php echo (($pos_next >= $unlim_num_rows) ? 0 : $pos_next); ?>" class="textfield" onfocus="this.select()" />            <?php echo __('Number of rows') . ': ' . "\n"; ?>            <input type="text" name="session_max_rows" size="3" value="<?php echo (($_SESSION['tmp_user_values']['max_rows'] != 'all') ? $_SESSION['tmp_user_values']['max_rows'] : $GLOBALS['cfg']['MaxRows']); ?>" class="textfield" onfocus="this.select()" />        <?php        if ($GLOBALS['cfg']['ShowDisplayDirection']) {            // Display mode (horizontal/vertical and repeat headers)            echo __('Mode') . ': ' . "\n";            $choices = array(                'horizontal'        => __('horizontal'),                'horizontalflipped' => __('horizontal (rotated headers)'),                'vertical'          => __('vertical'));            echo PMA_generate_html_dropdown('disp_direction', $choices, $_SESSION['tmp_user_values']['disp_direction'], $id_for_direction_dropdown);            unset($choices);        }        printf(            __('Headers every %s rows'),            '<input type="text" size="3" name="repeat_cells" value="' . $_SESSION['tmp_user_values']['repeat_cells'] . '" class="textfield" />'        );        echo "\n";        ?>        </form>    </td>    <td class="navigation_separator"></td></tr></table>    <?php} // end of the 'PMA_displayTableNavigation()' function/** * Displays the headers of the results table * * @param array   &$is_display                 which elements to display * @param array   &$fields_meta                the list of fields properties * @param integer $fields_cnt                  the total number of fields returned by the SQL query * @param array   $analyzed_sql                the analyzed query * @param string  $sort_expression             sort expression * @param string  $sort_expression_nodirection sort expression without direction * @param string  $sort_direction              sort direction * * @return  boolean  $clause_is_unique * * @global  string   $db               the database name * @global  string   $table            the table name * @global  string   $goto             the URL to go back in case of errors * @global  string   $sql_query        the SQL query * @global  integer  $num_rows         the total number of rows returned by the *                                     SQL query * @global  array    $vertical_display informations used with vertical display *                                     mode * * @access  private * * @see     PMA_displayTable() */function PMA_displayTableHeaders(&$is_display, &$fields_meta, $fields_cnt = 0, $analyzed_sql = '', $sort_expression, $sort_expression_nodirection, $sort_direction){    global $db, $table, $goto;    global $sql_query, $num_rows;    global $vertical_display, $highlight_columns;    // required to generate sort links that will remember whether the    // "Show all" button has been clicked    $sql_md5 = md5($GLOBALS['sql_query']);    $session_max_rows = $_SESSION['tmp_user_values']['query'][$sql_md5]['max_rows'];    if ($analyzed_sql == '') {        $analyzed_sql = array();    }    // can the result be sorted?    if ($is_display['sort_lnk'] == '1') {        // Just as fallback        $unsorted_sql_query     = $sql_query;        if (isset($analyzed_sql[0]['unsorted_query'])) {            $unsorted_sql_query = $analyzed_sql[0]['unsorted_query'];        }        // Handles the case of multiple clicks on a column's header        // which would add many spaces before "ORDER BY" in the        // generated query.        $unsorted_sql_query = trim($unsorted_sql_query);        // sorting by indexes, only if it makes sense (only one table ref)        if (isset($analyzed_sql)            && isset($analyzed_sql[0])            && isset($analyzed_sql[0]['querytype'])            && $analyzed_sql[0]['querytype'] == 'SELECT'            && isset($analyzed_sql[0]['table_ref'])            && count($analyzed_sql[0]['table_ref']) == 1        ) {            // grab indexes data:            $indexes = PMA_Index::getFromTable($table, $db);            // do we have any index?            if ($indexes) {                if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'                    || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'                ) {                    $span = $fields_cnt;                    if ($is_display['edit_lnk'] != 'nn') {                        $span++;                    }                    if ($is_display['del_lnk'] != 'nn') {                        $span++;                    }                    if ($is_display['del_lnk'] != 'kp' && $is_display['del_lnk'] != 'nn') {                        $span++;                    }                } else {                    $span = $num_rows + floor($num_rows/$_SESSION['tmp_user_values']['repeat_cells']) + 1;                }                echo '<form action="sql.php" method="post">' . "\n";                echo PMA_generate_common_hidden_inputs($db, $table);                echo __('Sort by key') . ': <select name="sql_query" class="autosubmit">' . "\n";                $used_index = false;                $local_order = (isset($sort_expression) ? $sort_expression : '');                foreach ($indexes as $index) {                    $asc_sort = '`' . implode('` ASC, `', array_keys($index->getColumns())) . '` ASC';                    $desc_sort = '`' . implode('` DESC, `', array_keys($index->getColumns())) . '` DESC';                    $used_index = $used_index || $local_order == $asc_sort || $local_order == $desc_sort;                    if (preg_match('@(.*)([[:space:]](LIMIT (.*)|PROCEDURE (.*)|FOR UPDATE|LOCK IN SHARE MODE))@is', $unsorted_sql_query, $my_reg)) {                        $unsorted_sql_query_first_part = $my_reg[1];                        $unsorted_sql_query_second_part = $my_reg[2];                    } else {                        $unsorted_sql_query_first_part = $unsorted_sql_query;                        $unsorted_sql_query_second_part = '';                    }                    echo '<option value="'                        . htmlspecialchars($unsorted_sql_query_first_part  . "\n" . ' ORDER BY ' . $asc_sort . $unsorted_sql_query_second_part)                        . '"' . ($local_order == $asc_sort ? ' selected="selected"' : '')                        . '>' . htmlspecialchars($index->getName()) . ' ('                        . __('Ascending') . ')</option>';                    echo '<option value="'                        . htmlspecialchars($unsorted_sql_query_first_part . "\n" . ' ORDER BY ' . $desc_sort . $unsorted_sql_query_second_part)                        . '"' . ($local_order == $desc_sort ? ' selected="selected"' : '')                        . '>' . htmlspecialchars($index->getName()) . ' ('                        . __('Descending') . ')</option>';                }                echo '<option value="' . htmlspecialchars($unsorted_sql_query) . '"' . ($used_index ? '' : ' selected="selected"') . '>' . __('None') . '</option>';                echo '</select>' . "\n";                echo '<noscript><input type="submit" value="' . __('Go') . '" /></noscript>';                echo '</form>' . "\n";            }        }    }    // Output data needed for grid editing    echo '<input id="save_cells_at_once" type="hidden" value="' . $GLOBALS['cfg']['SaveCellsAtOnce'] . '" />';    echo '<div class="common_hidden_inputs">';    echo PMA_generate_common_hidden_inputs($db, $table);    echo '</div>';    // Output data needed for column reordering and show/hide column    if (PMA_isSelect()) {        // generate the column order, if it is set        $pmatable = new PMA_Table($GLOBALS['table'], $GLOBALS['db']);        $col_order = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_ORDER);        if ($col_order) {            echo '<input id="col_order" type="hidden" value="' . implode(',', $col_order) . '" />';        }        $col_visib = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_VISIB);        if ($col_visib) {            echo '<input id="col_visib" type="hidden" value="' . implode(',', $col_visib) . '" />';        }        // generate table create time        if (! PMA_Table::isView($GLOBALS['table'], $GLOBALS['db'])) {            echo '<input id="table_create_time" type="hidden" value="' .                PMA_Table::sGetStatusInfo($GLOBALS['db'], $GLOBALS['table'], 'Create_time') . '" />';        }    }    $vertical_display['emptypre']   = 0;    $vertical_display['emptyafter'] = 0;    $vertical_display['textbtn']    = '';    // Display options (if we are not in print view)    if (! (isset($GLOBALS['printview']) && $GLOBALS['printview'] == '1')) {        echo '<form method="post" action="sql.php" name="displayOptionsForm" id="displayOptionsForm"';        if ($GLOBALS['cfg']['AjaxEnable']) {            echo ' class="ajax" ';        }        echo '>';        $url_params = array(            'db' => $db,            'table' => $table,            'sql_query' => $sql_query,            'goto' => $goto,            'display_options_form' => 1        );        echo PMA_generate_common_hidden_inputs($url_params);        echo '<br />';        PMA_generate_slider_effect('displayoptions', __('Options'));        echo '<fieldset>';        echo '<div class="formelement">';        $choices = array(            'P'   => __('Partial texts'),            'F'   => __('Full texts')        );        PMA_display_html_radio('display_text', $choices, $_SESSION['tmp_user_values']['display_text']);        echo '</div>';        // prepare full/partial text button or link        $url_params_full_text = array(            'db' => $db,            'table' => $table,            'sql_query' => $sql_query,            'goto' => $goto,            'full_text_button' => 1        );        if ($_SESSION['tmp_user_values']['display_text']=='F') {            // currently in fulltext mode so show the opposite link            $tmp_image_file = $GLOBALS['pmaThemeImage'] . 's_partialtext.png';            $tmp_txt = __('Partial texts');            $url_params_full_text['display_text'] = 'P';        } else {            $tmp_image_file = $GLOBALS['pmaThemeImage'] . 's_fulltext.png';            $tmp_txt = __('Full texts');            $url_params_full_text['display_text'] = 'F';        }        $tmp_image = '<img class="fulltext" src="' . $tmp_image_file . '" alt="' . $tmp_txt . '" title="' . $tmp_txt . '" />';        $tmp_url = 'sql.php' . PMA_generate_common_url($url_params_full_text);        $full_or_partial_text_link = PMA_linkOrButton($tmp_url, $tmp_image, array(), false);        unset($tmp_image_file, $tmp_txt, $tmp_url, $tmp_image);        if ($GLOBALS['cfgRelation']['relwork'] && $GLOBALS['cfgRelation']['displaywork']) {            echo '<div class="formelement">';            $choices = array(                'K'   => __('Relational key'),                'D'   => __('Relational display column')            );            PMA_display_html_radio('relational_display', $choices, $_SESSION['tmp_user_values']['relational_display']);            echo '</div>';        }        echo '<div class="formelement">';        PMA_display_html_checkbox('display_binary', __('Show binary contents'), ! empty($_SESSION['tmp_user_values']['display_binary']), false);        echo '<br />';        PMA_display_html_checkbox('display_blob', __('Show BLOB contents'), ! empty($_SESSION['tmp_user_values']['display_blob']), false);        echo '<br />';        PMA_display_html_checkbox('display_binary_as_hex', __('Show binary contents as HEX'), ! empty($_SESSION['tmp_user_values']['display_binary_as_hex']), false);        echo '</div>';        // I would have preferred to name this "display_transformation".        // This is the only way I found to be able to keep this setting sticky        // per SQL query, and at the same time have a default that displays        // the transformations.        echo '<div class="formelement">';        PMA_display_html_checkbox('hide_transformation', __('Hide browser transformation'), ! empty($_SESSION['tmp_user_values']['hide_transformation']), false);        echo '</div>';        if (! PMA_DRIZZLE) {            echo '<div class="formelement">';            $choices = array(                'GEOM'  => __('Geometry'),                'WKT'   => __('Well Known Text'),                'WKB'   => __('Well Known Binary')            );            PMA_display_html_radio('geometry_display', $choices, $_SESSION['tmp_user_values']['geometry_display']);            echo '</div>';        }        echo '<div class="clearfloat"></div>';        echo '</fieldset>';        echo '<fieldset class="tblFooters">';        echo '<input type="submit" value="' . __('Go') . '" />';        echo '</fieldset>';        echo '</div>';        echo '</form>';    }    // Start of form for multi-rows edit/delete/export    if ($is_display['del_lnk'] == 'dr' || $is_display['del_lnk'] == 'kp') {        echo '<form method="post" action="tbl_row_action.php" name="resultsForm" id="resultsForm"';        if ($GLOBALS['cfg']['AjaxEnable']) {            echo ' class="ajax" ';        }        echo '>' . "\n";        echo PMA_generate_common_hidden_inputs($db, $table, 1);        echo '<input type="hidden" name="goto"             value="sql.php" />' . "\n";    }    echo '<table id="table_results" class="data';    if ($GLOBALS['cfg']['AjaxEnable']) {        echo ' ajax';    }    echo '">' . "\n";    if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'        || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'    ) {        echo '<thead><tr>' . "\n";    }    // 1. Displays the full/partial text button (part 1)...    if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'        || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'    ) {        $colspan  = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn')                  ? ' colspan="4"'                  : '';    } else {        $rowspan  = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn')                  ? ' rowspan="4"'                  : '';    }    //     ... before the result table    if (($is_display['edit_lnk'] == 'nn' && $is_display['del_lnk'] == 'nn')        && $is_display['text_btn'] == '1'    ) {        $vertical_display['emptypre'] = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? 4 : 0;        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            ?>    <th colspan="<?php echo $fields_cnt; ?>"></th></tr><tr>            <?php            // end horizontal/horizontalflipped mode        } else {            ?><tr>    <th colspan="<?php echo $num_rows + floor($num_rows/$_SESSION['tmp_user_values']['repeat_cells']) + 1; ?>"></th></tr>            <?php        } // end vertical mode    }    //     ... at the left column of the result table header if possible    //     and required    elseif (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && $is_display['text_btn'] == '1'    ) {        $vertical_display['emptypre'] = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? 4 : 0;        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            ?>                <th <?php echo $colspan; ?>><?php echo $full_or_partial_text_link;?></th>            <?php            // end horizontal/horizontalflipped mode        } else {            $vertical_display['textbtn'] = '    <th ' . $rowspan . ' valign="middle">' . "\n"                                         . '        ' . "\n"                                         . '    </th>' . "\n";        } // end vertical mode    }    //     ... elseif no button, displays empty(ies) col(s) if required    elseif (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')             && ($is_display['edit_lnk'] != 'nn' || $is_display['del_lnk'] != 'nn')) {        $vertical_display['emptypre'] = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? 4 : 0;        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            ?>    <td<?php echo $colspan; ?>></td>            <?php            // end horizontal/horizontalfipped mode        } else {            $vertical_display['textbtn'] = '    <td' . $rowspan . '></td>' . "\n";        } // end vertical mode    }    //     ... elseif display an empty column if the actions links are disabled to match the rest of the table    elseif ($GLOBALS['cfg']['RowActionLinks'] == 'none'        && ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal' || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped')    ) {        echo '<th></th>';    }    // 2. Displays the fields' name    // 2.0 If sorting links should be used, checks if the query is a "JOIN"    //     statement (see 2.1.3)    // 2.0.1 Prepare Display column comments if enabled ($GLOBALS['cfg']['ShowBrowseComments']).    //       Do not show comments, if using horizontalflipped mode, because of space usage    if ($GLOBALS['cfg']['ShowBrowseComments']        && $_SESSION['tmp_user_values']['disp_direction'] != 'horizontalflipped'    ) {        $comments_map = array();        if (isset($analyzed_sql[0]) && is_array($analyzed_sql[0])) {            foreach ($analyzed_sql[0]['table_ref'] as $tbl) {                $tb = $tbl['table_true_name'];                $comments_map[$tb] = PMA_getComments($db, $tb);                unset($tb);            }        }    }    if ($GLOBALS['cfgRelation']['commwork'] && $GLOBALS['cfgRelation']['mimework'] && $GLOBALS['cfg']['BrowseMIME'] && ! $_SESSION['tmp_user_values']['hide_transformation']) {        include_once './libraries/transformations.lib.php';        $GLOBALS['mime_map'] = PMA_getMIME($db, $table);    }    // See if we have to highlight any header fields of a WHERE query.    // Uses SQL-Parser results.    $highlight_columns = array();    if (isset($analyzed_sql) && isset($analyzed_sql[0])        && isset($analyzed_sql[0]['where_clause_identifiers'])    ) {        $wi = 0;        if (isset($analyzed_sql[0]['where_clause_identifiers']) && is_array($analyzed_sql[0]['where_clause_identifiers'])) {            foreach ($analyzed_sql[0]['where_clause_identifiers'] AS $wci_nr => $wci) {                $highlight_columns[$wci] = 'true';            }        }    }    if (PMA_isSelect()) {        // prepare to get the column order, if available        $pmatable = new PMA_Table($GLOBALS['table'], $GLOBALS['db']);        $col_order = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_ORDER);        $col_visib = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_VISIB);    } else {        $col_order = false;        $col_visib = false;    }    for ($j = 0; $j < $fields_cnt; $j++) {        // assign $i with appropriate column order        $i = $col_order ? $col_order[$j] : $j;        //  See if this column should get highlight because it's used in the        //  where-query.        if (isset($highlight_columns[$fields_meta[$i]->name]) || isset($highlight_columns[PMA_backquote($fields_meta[$i]->name)])) {            $condition_field = true;        } else {            $condition_field = false;        }        // 2.0 Prepare comment-HTML-wrappers for each row, if defined/enabled.        if (isset($comments_map)            && isset($comments_map[$fields_meta[$i]->table])            && isset($comments_map[$fields_meta[$i]->table][$fields_meta[$i]->name])        ) {            $comments = '<span class="tblcomment">' . htmlspecialchars($comments_map[$fields_meta[$i]->table][$fields_meta[$i]->name]) . '</span>';        } else {            $comments = '';        }        // 2.1 Results can be sorted        if ($is_display['sort_lnk'] == '1') {            // 2.1.1 Checks if the table name is required; it's the case            //       for a query with a "JOIN" statement and if the column            //       isn't aliased, or in queries like            //       SELECT `1`.`master_field` , `2`.`master_field`            //       FROM `PMA_relation` AS `1` , `PMA_relation` AS `2`            if (isset($fields_meta[$i]->table) && strlen($fields_meta[$i]->table)) {                $sort_tbl = PMA_backquote($fields_meta[$i]->table) . '.';            } else {                $sort_tbl = '';            }            // 2.1.2 Checks if the current column is used to sort the            //       results            // the orgname member does not exist for all MySQL versions            // but if found, it's the one on which to sort            $name_to_use_in_sort = $fields_meta[$i]->name;            $is_orgname = false;            if (isset($fields_meta[$i]->orgname) && strlen($fields_meta[$i]->orgname)) {                $name_to_use_in_sort = $fields_meta[$i]->orgname;                $is_orgname = true;            }            // $name_to_use_in_sort might contain a space due to            // formatting of function expressions like "COUNT(name )"            // so we remove the space in this situation            $name_to_use_in_sort = str_replace(' )', ')', $name_to_use_in_sort);            if (empty($sort_expression)) {                $is_in_sort = false;            } else {                // Field name may be preceded by a space, or any number                // of characters followed by a dot (tablename.fieldname)                // so do a direct comparison for the sort expression;                // this avoids problems with queries like                // "SELECT id, count(id)..." and clicking to sort                // on id or on count(id).                // Another query to test this:                // SELECT p.*, FROM_UNIXTIME(p.temps) FROM mytable AS p                // (and try clicking on each column's header twice)                if (! empty($sort_tbl)                    && strpos($sort_expression_nodirection, $sort_tbl) === false                    && strpos($sort_expression_nodirection, '(') === false                ) {                    $sort_expression_nodirection = $sort_tbl . $sort_expression_nodirection;                }                $is_in_sort = (str_replace('`', '', $sort_tbl) . $name_to_use_in_sort == str_replace('`', '', $sort_expression_nodirection) ? true : false);            }            // 2.1.3 Check the field name for a bracket.            //       If it contains one, it's probably a function column            //       like 'COUNT(`field`)'            //       It still might be a column name of a view. See bug #3383711            //       Check is_orgname.            if (strpos($name_to_use_in_sort, '(') !== false && ! $is_orgname) {                $sort_order = "\n" . 'ORDER BY ' . $name_to_use_in_sort . ' ';            } else {                $sort_order = "\n" . 'ORDER BY ' . $sort_tbl . PMA_backquote($name_to_use_in_sort) . ' ';            }            unset($name_to_use_in_sort);            unset($is_orgname);            // 2.1.4 Do define the sorting URL            if (! $is_in_sort) {                // patch #455484 ("Smart" order)                $GLOBALS['cfg']['Order'] = strtoupper($GLOBALS['cfg']['Order']);                if ($GLOBALS['cfg']['Order'] === 'SMART') {                    $sort_order .= (preg_match('@time|date@i', $fields_meta[$i]->type)) ? 'DESC' : 'ASC';                } else {                    $sort_order .= $GLOBALS['cfg']['Order'];                }                $order_img   = '';            } elseif ('DESC' == $sort_direction) {                $sort_order .= ' ASC';                $order_img   = ' ' . PMA_getImage('s_desc.png', __('Descending'), array('class' => "soimg$i", 'title' => ''));                $order_img  .= ' ' . PMA_getImage('s_asc.png', __('Ascending'), array('class' => "soimg$i hide", 'title' => ''));            } else {                $sort_order .= ' DESC';                $order_img   = ' ' . PMA_getImage('s_asc.png', __('Ascending'), array('class' => "soimg$i", 'title' => ''));                $order_img  .= ' ' . PMA_getImage('s_desc.png', __('Descending'), array('class' => "soimg$i hide", 'title' => ''));            }            if (preg_match('@(.*)([[:space:]](LIMIT (.*)|PROCEDURE (.*)|FOR UPDATE|LOCK IN SHARE MODE))@is', $unsorted_sql_query, $regs3)) {                $sorted_sql_query = $regs3[1] . $sort_order . $regs3[2];            } else {                $sorted_sql_query = $unsorted_sql_query . $sort_order;            }            $_url_params = array(                'db'                => $db,                'table'             => $table,                'sql_query'         => $sorted_sql_query,                'session_max_rows'  => $session_max_rows            );            $order_url  = 'sql.php' . PMA_generate_common_url($_url_params);            // 2.1.5 Displays the sorting URL            // enable sort order swapping for image            $order_link_params = array();            if (isset($order_img) && $order_img!='') {                if (strstr($order_img, 'asc')) {                    $order_link_params['onmouseover'] = "$('.soimg$i').toggle()";                    $order_link_params['onmouseout']  = "$('.soimg$i').toggle()";                } elseif (strstr($order_img, 'desc')) {                    $order_link_params['onmouseover'] = "$('.soimg$i').toggle()";                    $order_link_params['onmouseout']  = "$('.soimg$i').toggle()";                }            }            if ($GLOBALS['cfg']['HeaderFlipType'] == 'auto') {                if (PMA_USR_BROWSER_AGENT == 'IE') {                    $GLOBALS['cfg']['HeaderFlipType'] = 'css';                } else {                    $GLOBALS['cfg']['HeaderFlipType'] = 'fake';                }            }            if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'                && $GLOBALS['cfg']['HeaderFlipType'] == 'css'            ) {                $order_link_params['style'] = 'direction: ltr; writing-mode: tb-rl;';            }            $order_link_params['title'] = __('Sort');            $order_link_content = ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped' && $GLOBALS['cfg']['HeaderFlipType'] == 'fake' ? PMA_flipstring(htmlspecialchars($fields_meta[$i]->name), "<br />\n") : htmlspecialchars($fields_meta[$i]->name));            $order_link = PMA_linkOrButton($order_url, $order_link_content . $order_img, $order_link_params, false, true);            if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'                || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'            ) {                echo '<th';                $th_class = array();                $th_class[] = 'draggable';                if ($col_visib && !$col_visib[$j]) {                    $th_class[] = 'hide';                }                if ($condition_field) {                    $th_class[] = 'condition';                }                $th_class[] = 'column_heading';                if ($GLOBALS['cfg']['BrowsePointerEnable'] == true) {                    $th_class[] = 'pointer';                }                if ($GLOBALS['cfg']['BrowseMarkerEnable'] == true) {                    $th_class[] = 'marker';                }                echo ' class="' . implode(' ', $th_class) . '"';                if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped') {                    echo ' valign="bottom"';                }                echo '>' . $order_link . $comments . '</th>';            }            $vertical_display['desc'][] = '    <th '                . 'class="draggable'                . ($condition_field ? ' condition' : '')                . '">' . "\n"                . $order_link . $comments . '    </th>' . "\n";        } // end if (2.1)        // 2.2 Results can't be sorted        else {            if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'                || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'            ) {                echo '<th';                $th_class = array();                $th_class[] = 'draggable';                if ($col_visib && !$col_visib[$j]) {                    $th_class[] = 'hide';                }                if ($condition_field) {                    $th_class[] = 'condition';                }                echo ' class="' . implode(' ', $th_class) . '"';                if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped') {                    echo ' valign="bottom"';                }                if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'                    && $GLOBALS['cfg']['HeaderFlipType'] == 'css'                ) {                    echo ' style="direction: ltr; writing-mode: tb-rl;"';                }                echo '>';                if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'                    && $GLOBALS['cfg']['HeaderFlipType'] == 'fake'                ) {                    echo PMA_flipstring(htmlspecialchars($fields_meta[$i]->name), '<br />');                } else {                    echo htmlspecialchars($fields_meta[$i]->name);                }                echo "\n" . $comments . '</th>';            }            $vertical_display['desc'][] = '    <th '                . 'class="draggable'                . ($condition_field ? ' condition"' : '')                . '">' . "\n"                . '        ' . htmlspecialchars($fields_meta[$i]->name) . "\n"                . $comments . '    </th>';        } // end else (2.2)    } // end for    // 3. Displays the needed checkboxes at the right    //    column of the result table header if possible and required...    if (($GLOBALS['cfg']['RowActionLinks'] == 'right' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && ($is_display['edit_lnk'] != 'nn' || $is_display['del_lnk'] != 'nn')        && $is_display['text_btn'] == '1'    ) {        $vertical_display['emptyafter'] = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? 4 : 1;        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            echo "\n";            ?>        <th <?php echo $colspan; ?>><?php echo $full_or_partial_text_link;?></th>            <?php            // end horizontal/horizontalflipped mode        } else {            $vertical_display['textbtn'] = '    <th ' . $rowspan . ' valign="middle">' . "\n"                                         . '        ' . "\n"                                         . '    </th>' . "\n";        } // end vertical mode    }    //     ... elseif no button, displays empty columns if required    // (unless coming from Browse mode print view)    elseif (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && ($is_display['edit_lnk'] == 'nn' && $is_display['del_lnk'] == 'nn')        && (! $GLOBALS['is_header_sent'])    ) {        $vertical_display['emptyafter'] = ($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? 4 : 1;        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            echo "\n";            ?><td<?php echo $colspan; ?>></td>            <?php            // end horizontal/horizontalflipped mode        } else {            $vertical_display['textbtn'] = '    <td' . $rowspan . '></td>' . "\n";        } // end vertical mode    }    if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'        || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'    ) {        ?></tr></thead>        <?php    }    return true;} // end of the 'PMA_displayTableHeaders()' function/** * Prepares the display for a value * * @param string $class           class of table cell * @param bool   $condition_field whether to add CSS class condition * @param string $value           value to display * * @return  string  the td */function PMA_buildValueDisplay($class, $condition_field, $value){    return '<td align="left"' . ' class="' . $class . ($condition_field ? ' condition' : '') . '">' . $value . '</td>';}/** * Prepares the display for a null value * * @param string $class           class of table cell * @param bool   $condition_field whether to add CSS class condition * @param object $meta            the meta-information about this field * @param string $align           cell allignment * * @return  string  the td */function PMA_buildNullDisplay($class, $condition_field, $meta, $align = ''){    // the null class is needed for grid editing    return '<td ' . $align . ' class="' . PMA_addClass($class, $condition_field, $meta, '') . ' null"><i>NULL</i></td>';}/** * Prepares the display for an empty value * * @param string $class           class of table cell * @param bool   $condition_field whether to add CSS class condition * @param object $meta            the meta-information about this field * @param string $align           cell allignment * * @return  string  the td */function PMA_buildEmptyDisplay($class, $condition_field, $meta, $align = ''){    $nowrap = ' nowrap';    return '<td ' . $align . ' class="' . PMA_addClass($class, $condition_field, $meta, $nowrap)  . '"></td>';}/** * Adds the relavant classes. * * @param string $class              class of table cell * @param bool   $condition_field    whether to add CSS class condition * @param object $meta               the meta-information about this field * @param string $nowrap             avoid wrapping * @param bool   $is_field_truncated is field truncated (display ...) * @param string $transform_function transformation function * @param string $default_function   default transformation function * * @return string the list of classes */function PMA_addClass($class, $condition_field, $meta, $nowrap, $is_field_truncated = false, $transform_function = '', $default_function = ''){    // Define classes to be added to this data field based on the type of data    $enum_class = '';    if (strpos($meta->flags, 'enum') !== false) {        $enum_class = ' enum';    }    $set_class = '';    if (strpos($meta->flags, 'set') !== false) {        $set_class = ' set';    }    $bit_class = '';    if (strpos($meta->type, 'bit') !== false) {        $bit_class = ' bit';    }    $mime_type_class = '';    if (isset($meta->mimetype)) {        $mime_type_class = ' ' . preg_replace('/\//', '_', $meta->mimetype);    }    $result = $class . ($condition_field ? ' condition' : '') . $nowrap    . ' ' . ($is_field_truncated ? ' truncated' : '')    . ($transform_function != $default_function ? ' transformed' : '')    . $enum_class . $set_class . $bit_class . $mime_type_class;    return $result;}/** * Displays the body of the results table * * @param integer &$dt_result   the link id associated to the query which results have *                              to be displayed * @param array   &$is_display  which elements to display * @param array   $map          the list of relations * @param array   $analyzed_sql the analyzed query * * @return  boolean  always true * * @global string   $db                the database name * @global string   $table             the table name * @global string   $goto              the URL to go back in case of errors * @global string   $sql_query         the SQL query * @global array    $fields_meta       the list of fields properties * @global integer  $fields_cnt        the total number of fields returned by *                                      the SQL query * @global array    $vertical_display  informations used with vertical display *                                      mode * @global array    $highlight_columns column names to highlight * @global array    $row               current row data * * @access private * * @see     PMA_displayTable() */function PMA_displayTableBody(&$dt_result, &$is_display, $map, $analyzed_sql){    global $db, $table, $goto;    global $sql_query, $fields_meta, $fields_cnt;    global $vertical_display, $highlight_columns;    global $row; // mostly because of browser transformations, to make the row-data accessible in a plugin    $url_sql_query          = $sql_query;    // query without conditions to shorten URLs when needed, 200 is just    // guess, it should depend on remaining URL length    if (isset($analyzed_sql)        && isset($analyzed_sql[0])        && isset($analyzed_sql[0]['querytype'])        && $analyzed_sql[0]['querytype'] == 'SELECT'        && strlen($sql_query) > 200    ) {        $url_sql_query = 'SELECT ';        if (isset($analyzed_sql[0]['queryflags']['distinct'])) {            $url_sql_query .= ' DISTINCT ';        }        $url_sql_query .= $analyzed_sql[0]['select_expr_clause'];        if (!empty($analyzed_sql[0]['from_clause'])) {            $url_sql_query .= ' FROM ' . $analyzed_sql[0]['from_clause'];        }    }    if (! is_array($map)) {        $map = array();    }    $row_no                         = 0;    $vertical_display['edit']       = array();    $vertical_display['copy']       = array();    $vertical_display['delete']     = array();    $vertical_display['data']       = array();    $vertical_display['row_delete'] = array();    // name of the class added to all grid editable elements    $grid_edit_class = 'grid_edit';    // prepare to get the column order, if available    if (PMA_isSelect()) {        $pmatable = new PMA_Table($GLOBALS['table'], $GLOBALS['db']);        $col_order = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_ORDER);        $col_visib = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_VISIB);    } else {        $col_order = false;        $col_visib = false;    }    // Correction University of Virginia 19991216 in the while below    // Previous code assumed that all tables have keys, specifically that    // the phpMyAdmin GUI should support row delete/edit only for such    // tables.    // Although always using keys is arguably the prescribed way of    // defining a relational table, it is not required. This will in    // particular be violated by the novice.    // We want to encourage phpMyAdmin usage by such novices. So the code    // below has been changed to conditionally work as before when the    // table being displayed has one or more keys; but to display    // delete/edit options correctly for tables without keys.    $odd_row = true;    while ($row = PMA_DBI_fetch_row($dt_result)) {        // "vertical display" mode stuff        if ($row_no != 0 && $_SESSION['tmp_user_values']['repeat_cells'] != 0            && !($row_no % $_SESSION['tmp_user_values']['repeat_cells'])            && ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped')        ) {            echo '<tr>' . "\n";            if ($vertical_display['emptypre'] > 0) {                echo '    <th colspan="' . $vertical_display['emptypre'] . '">' . "\n"                    .'        &nbsp;</th>' . "\n";            } else if ($GLOBALS['cfg']['RowActionLinks'] == 'none') {                echo '    <th></th>' . "\n";            }            foreach ($vertical_display['desc'] as $val) {                echo $val;            }            if ($vertical_display['emptyafter'] > 0) {                echo '    <th colspan="' . $vertical_display['emptyafter'] . '">' . "\n"                    .'        &nbsp;</th>' . "\n";            }            echo '</tr>' . "\n";        } // end if        $alternating_color_class = ($odd_row ? 'odd' : 'even');        $odd_row = ! $odd_row;        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            // pointer code part            echo '<tr class="' . $alternating_color_class . '">';        }        // 1. Prepares the row        // 1.1 Results from a "SELECT" statement -> builds the        //     WHERE clause to use in links (a unique key if possible)        /**         * @todo $where_clause could be empty, for example a table         *       with only one field and it's a BLOB; in this case,         *       avoid to display the delete and edit links         */        list($where_clause, $clause_is_unique, $condition_array) = PMA_getUniqueCondition($dt_result, $fields_cnt, $fields_meta, $row);        $where_clause_html = urlencode($where_clause);        // 1.2 Defines the URLs for the modify/delete link(s)        if ($is_display['edit_lnk'] != 'nn' || $is_display['del_lnk'] != 'nn') {            // We need to copy the value or else the == 'both' check will always return true            if ($GLOBALS['cfg']['PropertiesIconic'] === 'both') {                $iconic_spacer = '<div class="nowrap">';            } else {                $iconic_spacer = '';            }            // 1.2.1 Modify link(s)            if ($is_display['edit_lnk'] == 'ur') { // update row case                $_url_params = array(                    'db'               => $db,                    'table'            => $table,                    'where_clause'     => $where_clause,                    'clause_is_unique' => $clause_is_unique,                    'sql_query'        => $url_sql_query,                    'goto'             => 'sql.php',                );                $edit_url = 'tbl_change.php' . PMA_generate_common_url($_url_params + array('default_action' => 'update'));                $copy_url = 'tbl_change.php' . PMA_generate_common_url($_url_params + array('default_action' => 'insert'));                $edit_str = PMA_getIcon('b_edit.png', __('Edit'));                $copy_str = PMA_getIcon('b_insrow.png', __('Copy'));                // Class definitions required for grid editing jQuery scripts                $edit_anchor_class = "edit_row_anchor";                if ( $clause_is_unique == 0) {                    $edit_anchor_class .= ' nonunique';                }            } // end if (1.2.1)            // 1.2.2 Delete/Kill link(s)            if ($is_display['del_lnk'] == 'dr') { // delete row case                $_url_params = array(                    'db'        => $db,                    'table'     => $table,                    'sql_query' => $url_sql_query,                    'message_to_show' => __('The row has been deleted'),                    'goto'      => (empty($goto) ? 'tbl_sql.php' : $goto),                );                $lnk_goto = 'sql.php' . PMA_generate_common_url($_url_params, 'text');                $del_query = 'DELETE FROM ' . PMA_backquote($db) . '.' . PMA_backquote($table)                    . ' WHERE ' . $where_clause . ($clause_is_unique ? '' : ' LIMIT 1');                $_url_params = array(                    'db'        => $db,                    'table'     => $table,                    'sql_query' => $del_query,                    'message_to_show' => __('The row has been deleted'),                    'goto'      => $lnk_goto,                );                $del_url  = 'sql.php' . PMA_generate_common_url($_url_params);                $js_conf  = 'DELETE FROM ' . PMA_jsFormat($db) . '.' . PMA_jsFormat($table)                          . ' WHERE ' . PMA_jsFormat($where_clause, false)                          . ($clause_is_unique ? '' : ' LIMIT 1');                $del_str = PMA_getIcon('b_drop.png', __('Delete'));            } elseif ($is_display['del_lnk'] == 'kp') { // kill process case                $_url_params = array(                    'db'        => $db,                    'table'     => $table,                    'sql_query' => $url_sql_query,                    'goto'      => 'main.php',                );                $lnk_goto = 'sql.php' . PMA_generate_common_url($_url_params, 'text');                $_url_params = array(                    'db'        => 'mysql',                    'sql_query' => 'KILL ' . $row[0],                    'goto'      => $lnk_goto,                );                $del_url  = 'sql.php' . PMA_generate_common_url($_url_params);                $del_query = 'KILL ' . $row[0];                $js_conf  = 'KILL ' . $row[0];                $del_str = PMA_getIcon('b_drop.png', __('Kill'));            } // end if (1.2.2)            // 1.3 Displays the links at left if required            if (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')                && ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'                || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped')            ) {                if (! isset($js_conf)) {                    $js_conf = '';                }                echo PMA_generateCheckboxAndLinks('left', $del_url, $is_display, $row_no, $where_clause, $where_clause_html, $condition_array, $del_query, 'l', $edit_url, $copy_url, $edit_anchor_class, $edit_str, $copy_str, $del_str, $js_conf);            } elseif (($GLOBALS['cfg']['RowActionLinks'] == 'none')                && ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'                || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped')            ) {                if (! isset($js_conf)) {                    $js_conf = '';                }                echo PMA_generateCheckboxAndLinks('none', $del_url, $is_display, $row_no, $where_clause, $where_clause_html, $condition_array, $del_query, 'l', $edit_url, $copy_url, $edit_anchor_class, $edit_str, $copy_str, $del_str, $js_conf);            } // end if (1.3)        } // end if (1)        // 2. Displays the rows' values        for ($j = 0; $j < $fields_cnt; ++$j) {            // assign $i with appropriate column order            $i = $col_order ? $col_order[$j] : $j;            $meta    = $fields_meta[$i];            $not_null_class = $meta->not_null ? 'not_null' : '';            $relation_class = isset($map[$meta->name]) ? 'relation' : '';            $hide_class = ($col_visib && !$col_visib[$j] &&                           // hide per <td> only if the display direction is not vertical                           $_SESSION['tmp_user_values']['disp_direction'] != 'vertical') ? 'hide' : '';            // handle datetime-related class, for grid editing            if (substr($meta->type, 0, 9) == 'timestamp' || $meta->type == 'datetime') {                $field_type_class = 'datetimefield';            } else if ($meta->type == 'date') {                $field_type_class = 'datefield';            } else {                $field_type_class = '';            }            $pointer = $i;            $is_field_truncated = false;            //If the previous column had blob data, we need to reset the class            // to $inline_edit_class            $class = 'data ' . $grid_edit_class . ' ' . $not_null_class . ' ' . $relation_class . ' ' . $hide_class . ' ' . $field_type_class; //' ' . $alternating_color_class .            //  See if this column should get highlight because it's used in the            //  where-query.            if (isset($highlight_columns) && (isset($highlight_columns[$meta->name]) || isset($highlight_columns[PMA_backquote($meta->name)]))) {                $condition_field = true;            } else {                $condition_field = false;            }            if ($_SESSION['tmp_user_values']['disp_direction'] == 'vertical' && (! isset($GLOBALS['printview']) || ($GLOBALS['printview'] != '1'))) {                // the row number corresponds to a data row, not HTML table row                $class .= ' row_' . $row_no;                if ($GLOBALS['cfg']['BrowsePointerEnable'] == true) {                    $class .= ' vpointer';                }                if ($GLOBALS['cfg']['BrowseMarkerEnable'] == true) {                    $class .= ' vmarker';                }            }// end if            // Wrap MIME-transformations. [MIME]            $default_function = 'default_function'; // default_function            $transform_function = $default_function;            $transform_options = array();            if ($GLOBALS['cfgRelation']['mimework'] && $GLOBALS['cfg']['BrowseMIME']) {                if (isset($GLOBALS['mime_map'][$meta->name]['mimetype']) && isset($GLOBALS['mime_map'][$meta->name]['transformation']) && !empty($GLOBALS['mime_map'][$meta->name]['transformation'])) {                    $include_file = PMA_securePath($GLOBALS['mime_map'][$meta->name]['transformation']);                    if (file_exists('./libraries/transformations/' . $include_file)) {                        $transformfunction_name = str_replace('.inc.php', '', $GLOBALS['mime_map'][$meta->name]['transformation']);                        include_once './libraries/transformations/' . $include_file;                        if (function_exists('PMA_transformation_' . $transformfunction_name)) {                            $transform_function = 'PMA_transformation_' . $transformfunction_name;                            $transform_options  = PMA_transformation_getOptions((isset($GLOBALS['mime_map'][$meta->name]['transformation_options']) ? $GLOBALS['mime_map'][$meta->name]['transformation_options'] : ''));                            $meta->mimetype     = str_replace('_', '/', $GLOBALS['mime_map'][$meta->name]['mimetype']);                        }                    } // end if file_exists                } // end if transformation is set            } // end if mime/transformation works.            $_url_params = array(                'db'            => $db,                'table'         => $table,                'where_clause'  => $where_clause,                'transform_key' => $meta->name,            );            if (! empty($sql_query)) {                $_url_params['sql_query'] = $url_sql_query;            }            $transform_options['wrapper_link'] = PMA_generate_common_url($_url_params);            // n u m e r i c            if ($meta->numeric == 1) {                // if two fields have the same name (this is possible                //       with self-join queries, for example), using $meta->name                //       will show both fields NULL even if only one is NULL,                //       so use the $pointer                if (! isset($row[$i]) || is_null($row[$i])) {                    $vertical_display['data'][$row_no][$i]     =  PMA_buildNullDisplay($class, $condition_field, $meta, 'align="right"');                } elseif ($row[$i] != '') {                    $nowrap = ' nowrap';                    $where_comparison = ' = ' . $row[$i];                    $vertical_display['data'][$row_no][$i]     = '<td align="right"' . PMA_prepare_row_data($class, $condition_field, $analyzed_sql, $meta, $map, $row[$i], $transform_function, $default_function, $nowrap, $where_comparison, $transform_options, $is_field_truncated);                } else {                    $vertical_display['data'][$row_no][$i]     = PMA_buildEmptyDisplay($class, $condition_field, $meta, 'align="right"');                }            //  b l o b            } elseif (stristr($meta->type, 'BLOB')) {                // PMA_mysql_fetch_fields returns BLOB in place of                // TEXT fields type so we have to ensure it's really a BLOB                $field_flags = PMA_DBI_field_flags($dt_result, $i);                if (stristr($field_flags, 'BINARY')) {                    // remove 'grid_edit' from $class as we can't edit binary data.                    $class = str_replace('grid_edit', '', $class);                    if (! isset($row[$i]) || is_null($row[$i])) {                        $vertical_display['data'][$row_no][$i]     =  PMA_buildNullDisplay($class, $condition_field, $meta);                    } else {                        // for blobstreaming                        // if valid BS reference exists                        if (PMA_BS_IsPBMSReference($row[$i], $db)) {                            $blobtext = PMA_BS_CreateReferenceLink($row[$i], $db);                        } else {                            $blobtext = PMA_handle_non_printable_contents('BLOB', (isset($row[$i]) ? $row[$i] : ''), $transform_function, $transform_options, $default_function, $meta, $_url_params);                        }                        $vertical_display['data'][$row_no][$i]     =  PMA_buildValueDisplay($class, $condition_field, $blobtext);                        unset($blobtext);                    }                // not binary:                } else {                    if (! isset($row[$i]) || is_null($row[$i])) {                        $vertical_display['data'][$row_no][$i]     =  PMA_buildNullDisplay($class, $condition_field, $meta);                    } elseif ($row[$i] != '') {                        // if a transform function for blob is set, none of these replacements will be made                        if (PMA_strlen($row[$i]) > $GLOBALS['cfg']['LimitChars'] && $_SESSION['tmp_user_values']['display_text'] == 'P') {                            $row[$i] = PMA_substr($row[$i], 0, $GLOBALS['cfg']['LimitChars']) . '...';                            $is_field_truncated = true;                        }                        // displays all space characters, 4 space                        // characters for tabulations and <cr>/<lf>                        $row[$i]     = ($default_function != $transform_function ? $transform_function($row[$i], $transform_options, $meta) : $default_function($row[$i], array(), $meta));                        if ($is_field_truncated) {                            $class .= ' truncated';                        }                        $vertical_display['data'][$row_no][$i]     = PMA_buildValueDisplay($class, $condition_field, $row[$i]);                    } else {                        $vertical_display['data'][$row_no][$i]     = PMA_buildEmptyDisplay($class, $condition_field, $meta);                    }                }            // g e o m e t r y            } elseif ($meta->type == 'geometry') {                // Remove 'grid_edit' from $class as we do not allow to inline-edit geometry data.                $class = str_replace('grid_edit', '', $class);                if (! isset($row[$i]) || is_null($row[$i])) {                    $vertical_display['data'][$row_no][$i] = PMA_buildNullDisplay($class, $condition_field, $meta);                } elseif ($row[$i] != '') {                    // Display as [GEOMETRY - (size)]                    if ('GEOM' == $_SESSION['tmp_user_values']['geometry_display']) {                        $geometry_text = PMA_handle_non_printable_contents(                            'GEOMETRY', (isset($row[$i]) ? $row[$i] : ''), $transform_function,                            $transform_options, $default_function, $meta                        );                        $vertical_display['data'][$row_no][$i] = PMA_buildValueDisplay(                            $class, $condition_field, $geometry_text                        );                    // Display in Well Known Text(WKT) format.                    } elseif ('WKT' == $_SESSION['tmp_user_values']['geometry_display']) {                        $where_comparison = ' = ' . $row[$i];                        // Convert to WKT format                        $wktval = PMA_asWKT($row[$i]);                        if (PMA_strlen($wktval) > $GLOBALS['cfg']['LimitChars']                            && $_SESSION['tmp_user_values']['display_text'] == 'P'                        ) {                            $wktval = PMA_substr($wktval, 0, $GLOBALS['cfg']['LimitChars']) . '...';                            $is_field_truncated = true;                        }                        $vertical_display['data'][$row_no][$i] = '<td ' . PMA_prepare_row_data(                            $class, $condition_field, $analyzed_sql, $meta, $map, $wktval, $transform_function,                            $default_function, '', $where_comparison, $transform_options, $is_field_truncated                        );                    // Display in  Well Known Binary(WKB) format.                    } else {                        if ($_SESSION['tmp_user_values']['display_binary']) {                            $where_comparison = ' = ' . $row[$i];                            if ($_SESSION['tmp_user_values']['display_binary_as_hex']                                && PMA_contains_nonprintable_ascii($row[$i])                            ) {                                $wkbval = PMA_substr(bin2hex($row[$i]), 8);                            } else {                                $wkbval = htmlspecialchars(PMA_replace_binary_contents($row[$i]));                            }                            if (PMA_strlen($wkbval) > $GLOBALS['cfg']['LimitChars']                                && $_SESSION['tmp_user_values']['display_text'] == 'P'                            ) {                                $wkbval = PMA_substr($wkbval, 0, $GLOBALS['cfg']['LimitChars']) . '...';                                $is_field_truncated = true;                            }                            $vertical_display['data'][$row_no][$i] = '<td ' . PMA_prepare_row_data(                                $class, $condition_field, $analyzed_sql, $meta, $map, $wkbval, $transform_function,                                $default_function, '', $where_comparison, $transform_options, $is_field_truncated                            );                        } else {                            $wkbval = PMA_handle_non_printable_contents(                                'BINARY', $row[$i], $transform_function, $transform_options, $default_function, $meta, $_url_params                            );                            $vertical_display['data'][$row_no][$i] = PMA_buildValueDisplay($class, $condition_field, $wkbval);                        }                    }                } else {                    $vertical_display['data'][$row_no][$i] = PMA_buildEmptyDisplay($class, $condition_field, $meta);                }            // n o t   n u m e r i c   a n d   n o t   B L O B            } else {                if (! isset($row[$i]) || is_null($row[$i])) {                    $vertical_display['data'][$row_no][$i]     =  PMA_buildNullDisplay($class, $condition_field, $meta);                } elseif ($row[$i] != '') {                    // support blanks in the key                    $relation_id = $row[$i];                    // Cut all fields to $GLOBALS['cfg']['LimitChars']                    // (unless it's a link-type transformation)                    if (PMA_strlen($row[$i]) > $GLOBALS['cfg']['LimitChars'] && $_SESSION['tmp_user_values']['display_text'] == 'P' && !strpos($transform_function, 'link') === true) {                        $row[$i] = PMA_substr($row[$i], 0, $GLOBALS['cfg']['LimitChars']) . '...';                        $is_field_truncated = true;                    }                    // displays special characters from binaries                    $field_flags = PMA_DBI_field_flags($dt_result, $i);                    $formatted = false;                    if (isset($meta->_type) && $meta->_type === MYSQLI_TYPE_BIT) {                        $row[$i]     = PMA_printable_bit_value($row[$i], $meta->length);                        // some results of PROCEDURE ANALYSE() are reported as                        // being BINARY but they are quite readable,                        // so don't treat them as BINARY                    } elseif (stristr($field_flags, 'BINARY') && $meta->type == 'string' && !(isset($GLOBALS['is_analyse']) && $GLOBALS['is_analyse'])) {                        if ($_SESSION['tmp_user_values']['display_binary']) {                            // user asked to see the real contents of BINARY                            // fields                            if ($_SESSION['tmp_user_values']['display_binary_as_hex'] && PMA_contains_nonprintable_ascii($row[$i])) {                                $row[$i] = bin2hex($row[$i]);                            } else {                                $row[$i] = htmlspecialchars(PMA_replace_binary_contents($row[$i]));                            }                        } else {                            // we show the BINARY message and field's size                            // (or maybe use a transformation)                            $row[$i] = PMA_handle_non_printable_contents('BINARY', $row[$i], $transform_function, $transform_options, $default_function, $meta, $_url_params);                            $formatted = true;                        }                    }                    if ($formatted) {                        $vertical_display['data'][$row_no][$i]     = PMA_buildValueDisplay($class, $condition_field, $row[$i]);                    } else {                        // transform functions may enable no-wrapping:                        $function_nowrap = $transform_function . '_nowrap';                        $bool_nowrap = (($default_function != $transform_function && function_exists($function_nowrap)) ? $function_nowrap($transform_options) : false);                        // do not wrap if date field type                        $nowrap = ((preg_match('@DATE|TIME@i', $meta->type) || $bool_nowrap) ? ' nowrap' : '');                        $where_comparison = ' = \'' . PMA_sqlAddSlashes($row[$i]) . '\'';                        $vertical_display['data'][$row_no][$i]     = '<td ' . PMA_prepare_row_data($class, $condition_field, $analyzed_sql, $meta, $map, $row[$i], $transform_function, $default_function, $nowrap, $where_comparison, $transform_options, $is_field_truncated);                    }                } else {                    $vertical_display['data'][$row_no][$i]     = PMA_buildEmptyDisplay($class, $condition_field, $meta);                }            }            // output stored cell            if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'                || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'            ) {                echo $vertical_display['data'][$row_no][$i];            }            if (isset($vertical_display['rowdata'][$i][$row_no])) {                $vertical_display['rowdata'][$i][$row_no] .= $vertical_display['data'][$row_no][$i];            } else {                $vertical_display['rowdata'][$i][$row_no] = $vertical_display['data'][$row_no][$i];            }        } // end for (2)        // 3. Displays the modify/delete links on the right if required        if (($GLOBALS['cfg']['RowActionLinks'] == 'right' || $GLOBALS['cfg']['RowActionLinks'] == 'both')            && ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped')        ) {            if (! isset($js_conf)) {                $js_conf = '';            }            echo PMA_generateCheckboxAndLinks('right', $del_url, $is_display, $row_no, $where_clause, $where_clause_html, $condition_array, $del_query, 'r', $edit_url, $copy_url, $edit_anchor_class, $edit_str, $copy_str, $del_str, $js_conf);        } // end if (3)        if ($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal'            || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped'        ) {            ?></tr>            <?php        } // end if        // 4. Gather links of del_urls and edit_urls in an array for later        //    output        if (! isset($vertical_display['edit'][$row_no])) {            $vertical_display['edit'][$row_no]       = '';            $vertical_display['copy'][$row_no]       = '';            $vertical_display['delete'][$row_no]     = '';            $vertical_display['row_delete'][$row_no] = '';        }        $vertical_class = ' row_' . $row_no;        if ($GLOBALS['cfg']['BrowsePointerEnable'] == true) {            $vertical_class .= ' vpointer';        }        if ($GLOBALS['cfg']['BrowseMarkerEnable'] == true) {            $vertical_class .= ' vmarker';        }        if (!empty($del_url) && $is_display['del_lnk'] != 'kp') {            $vertical_display['row_delete'][$row_no] .= PMA_generateCheckboxForMulti($del_url, $is_display, $row_no, $where_clause_html, $condition_array, $del_query, '[%_PMA_CHECKBOX_DIR_%]', $alternating_color_class . $vertical_class);        } else {            unset($vertical_display['row_delete'][$row_no]);        }        if (isset($edit_url)) {            $vertical_display['edit'][$row_no]   .= PMA_generateEditLink($edit_url, $alternating_color_class . ' ' . $edit_anchor_class . $vertical_class, $edit_str, $where_clause, $where_clause_html);        } else {            unset($vertical_display['edit'][$row_no]);        }        if (isset($copy_url)) {            $vertical_display['copy'][$row_no]   .= PMA_generateCopyLink($copy_url, $copy_str, $where_clause, $where_clause_html, $alternating_color_class . $vertical_class);        } else {            unset($vertical_display['copy'][$row_no]);        }        if (isset($del_url)) {            if (! isset($js_conf)) {                $js_conf = '';            }            $vertical_display['delete'][$row_no] .= PMA_generateDeleteLink($del_url, $del_str, $js_conf, $alternating_color_class . $vertical_class);        } else {            unset($vertical_display['delete'][$row_no]);        }        echo (($_SESSION['tmp_user_values']['disp_direction'] == 'horizontal' || $_SESSION['tmp_user_values']['disp_direction'] == 'horizontalflipped') ? "\n" : '');        $row_no++;    } // end while    // this is needed by PMA_displayTable() to generate the proper param    // in the multi-edit and multi-delete form    return $clause_is_unique;} // end of the 'PMA_displayTableBody()' function/** * Do display the result table with the vertical direction mode. * * @return  boolean  always true * * @global  array    $vertical_display the information to display * * @access  private * * @see     PMA_displayTable() */function PMA_displayVerticalTable(){    global $vertical_display;    // Displays "multi row delete" link at top if required    if ($GLOBALS['cfg']['RowActionLinks'] != 'right'        && is_array($vertical_display['row_delete'])        && (count($vertical_display['row_delete']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if ($GLOBALS['cfg']['RowActionLinks'] == 'none') {            // if we are not showing the RowActionLinks, then we need to show the Multi-Row-Action checkboxes            echo '<th></th>' . "\n";        }        echo $vertical_display['textbtn'];        $cell_displayed = 0;        foreach ($vertical_display['row_delete'] as $val) {            if (($cell_displayed != 0) && ($_SESSION['tmp_user_values']['repeat_cells'] != 0) && !($cell_displayed % $_SESSION['tmp_user_values']['repeat_cells'])) {                echo '<th' .                     (($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? ' rowspan="4"' : '') .                     '></th>' . "\n";            }            echo str_replace('[%_PMA_CHECKBOX_DIR_%]', '_left', $val);            $cell_displayed++;        } // end while        echo '</tr>' . "\n";    } // end if    // Displays "edit" link at top if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['edit'])        && (count($vertical_display['edit']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if (! is_array($vertical_display['row_delete'])) {            echo $vertical_display['textbtn'];        }        foreach ($vertical_display['edit'] as $val) {            echo $val;        } // end while        echo '</tr>' . "\n";    } // end if    // Displays "copy" link at top if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['copy'])        && (count($vertical_display['copy']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if (! is_array($vertical_display['row_delete'])) {            echo $vertical_display['textbtn'];        }        foreach ($vertical_display['copy'] as $val) {            echo $val;        } // end while        echo '</tr>' . "\n";    } // end if    // Displays "delete" link at top if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'left' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['delete'])        && (count($vertical_display['delete']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if (! is_array($vertical_display['edit']) && ! is_array($vertical_display['row_delete'])) {            echo $vertical_display['textbtn'];        }        foreach ($vertical_display['delete'] as $val) {            echo $val;        } // end while        echo '</tr>' . "\n";    } // end if    if (PMA_isSelect()) {        // prepare to get the column order, if available        $pmatable = new PMA_Table($GLOBALS['table'], $GLOBALS['db']);        $col_order = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_ORDER);        $col_visib = $pmatable->getUiProp(PMA_Table::PROP_COLUMN_VISIB);    } else {        $col_order = false;        $col_visib = false;    }    // Displays data    foreach ($vertical_display['desc'] AS $j => $val) {        // assign appropriate key with current column order        $key = $col_order ? $col_order[$j] : $j;        echo '<tr' . (($col_visib && !$col_visib[$j]) ? ' class="hide"' : '') . '>' . "\n";        echo $val;        $cell_displayed = 0;        foreach ($vertical_display['rowdata'][$key] as $subval) {            if (($cell_displayed != 0) && ($_SESSION['tmp_user_values']['repeat_cells'] != 0) and !($cell_displayed % $_SESSION['tmp_user_values']['repeat_cells'])) {                echo $val;            }            echo $subval;            $cell_displayed++;        } // end while        echo '</tr>' . "\n";    } // end while    // Displays "multi row delete" link at bottom if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'right' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['row_delete'])        && (count($vertical_display['row_delete']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        echo $vertical_display['textbtn'];        $cell_displayed = 0;        foreach ($vertical_display['row_delete'] as $val) {            if (($cell_displayed != 0) && ($_SESSION['tmp_user_values']['repeat_cells'] != 0) && !($cell_displayed % $_SESSION['tmp_user_values']['repeat_cells'])) {                echo '<th' .                     (($is_display['edit_lnk'] != 'nn' && $is_display['del_lnk'] != 'nn') ? ' rowspan="4"' : '') .                     '></th>' . "\n";            }            echo str_replace('[%_PMA_CHECKBOX_DIR_%]', '_right', $val);            $cell_displayed++;        } // end while        echo '</tr>' . "\n";    } // end if    // Displays "edit" link at bottom if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'right' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['edit'])        && (count($vertical_display['edit']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if (! is_array($vertical_display['row_delete'])) {            echo $vertical_display['textbtn'];        }        foreach ($vertical_display['edit'] as $val) {            echo $val;        } // end while        echo '</tr>' . "\n";    } // end if    // Displays "copy" link at bottom if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'right' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['copy'])        && (count($vertical_display['copy']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if (! is_array($vertical_display['row_delete'])) {            echo $vertical_display['textbtn'];        }        foreach ($vertical_display['copy'] as $val) {            echo $val;        } // end while        echo '</tr>' . "\n";    } // end if    // Displays "delete" link at bottom if required    if (($GLOBALS['cfg']['RowActionLinks'] == 'right' || $GLOBALS['cfg']['RowActionLinks'] == 'both')        && is_array($vertical_display['delete'])        && (count($vertical_display['delete']) > 0 || !empty($vertical_display['textbtn']))    ) {        echo '<tr>' . "\n";        if (! is_array($vertical_display['edit']) && ! is_array($vertical_display['row_delete'])) {            echo $vertical_display['textbtn'];        }        foreach ($vertical_display['delete'] as $val) {            echo $val;        } // end while        echo '</tr>' . "\n";    }    return true;} // end of the 'PMA_displayVerticalTable' function/** * Checks the posted options for viewing query resutls * and sets appropriate values in the session. * * @todo    make maximum remembered queries configurable * @todo    move/split into SQL class!? * @todo    currently this is called twice unnecessary * @todo    ignore LIMIT and ORDER in query!? * * @return nothing */function PMA_displayTable_checkConfigParams(){    $sql_md5 = md5($GLOBALS['sql_query']);    $_SESSION['tmp_user_values']['query'][$sql_md5]['sql'] = $GLOBALS['sql_query'];    if (PMA_isValid($_REQUEST['disp_direction'], array('horizontal', 'vertical', 'horizontalflipped'))) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['disp_direction'] = $_REQUEST['disp_direction'];        unset($_REQUEST['disp_direction']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['disp_direction'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['disp_direction'] = $GLOBALS['cfg']['DefaultDisplay'];    }    if (PMA_isValid($_REQUEST['repeat_cells'], 'numeric')) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['repeat_cells'] = $_REQUEST['repeat_cells'];        unset($_REQUEST['repeat_cells']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['repeat_cells'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['repeat_cells'] = $GLOBALS['cfg']['RepeatCells'];    }    // as this is a form value, the type is always string so we cannot    // use PMA_isValid($_REQUEST['session_max_rows'], 'integer')    if ((PMA_isValid($_REQUEST['session_max_rows'], 'numeric')        && (int) $_REQUEST['session_max_rows'] == $_REQUEST['session_max_rows'])        || $_REQUEST['session_max_rows'] == 'all'    ) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['max_rows'] = $_REQUEST['session_max_rows'];        unset($_REQUEST['session_max_rows']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['max_rows'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['max_rows'] = $GLOBALS['cfg']['MaxRows'];    }    if (PMA_isValid($_REQUEST['pos'], 'numeric')) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['pos'] = $_REQUEST['pos'];        unset($_REQUEST['pos']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['pos'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['pos'] = 0;    }    if (PMA_isValid($_REQUEST['display_text'], array('P', 'F'))) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['display_text'] = $_REQUEST['display_text'];        unset($_REQUEST['display_text']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['display_text'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['display_text'] = 'P';    }    if (PMA_isValid($_REQUEST['relational_display'], array('K', 'D'))) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['relational_display'] = $_REQUEST['relational_display'];        unset($_REQUEST['relational_display']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['relational_display'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['relational_display'] = 'K';    }    if (PMA_isValid($_REQUEST['geometry_display'], array('WKT', 'WKB', 'GEOM'))) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['geometry_display'] = $_REQUEST['geometry_display'];        unset($_REQUEST['geometry_display']);    } elseif (empty($_SESSION['tmp_user_values']['query'][$sql_md5]['geometry_display'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['geometry_display'] = 'GEOM';    }    if (isset($_REQUEST['display_binary'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary'] = true;        unset($_REQUEST['display_binary']);    } elseif (isset($_REQUEST['display_options_form'])) {        // we know that the checkbox was unchecked        unset($_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary']);    } elseif (isset($_REQUEST['full_text_button'])) {        // do nothing to keep the value that is there in the session    } else {        // selected by default because some operations like OPTIMIZE TABLE        // and all queries involving functions return "binary" contents,        // according to low-level field flags        $_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary'] = true;    }    if (isset($_REQUEST['display_binary_as_hex'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary_as_hex'] = true;        unset($_REQUEST['display_binary_as_hex']);    } elseif (isset($_REQUEST['display_options_form'])) {        // we know that the checkbox was unchecked        unset($_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary_as_hex']);    } elseif (isset($_REQUEST['full_text_button'])) {        // do nothing to keep the value that is there in the session    } else {        // display_binary_as_hex config option        if (isset($GLOBALS['cfg']['DisplayBinaryAsHex']) && true === $GLOBALS['cfg']['DisplayBinaryAsHex']) {            $_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary_as_hex'] = true;        }    }    if (isset($_REQUEST['display_blob'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['display_blob'] = true;        unset($_REQUEST['display_blob']);    } elseif (isset($_REQUEST['display_options_form'])) {        // we know that the checkbox was unchecked        unset($_SESSION['tmp_user_values']['query'][$sql_md5]['display_blob']);    }    if (isset($_REQUEST['hide_transformation'])) {        $_SESSION['tmp_user_values']['query'][$sql_md5]['hide_transformation'] = true;        unset($_REQUEST['hide_transformation']);    } elseif (isset($_REQUEST['display_options_form'])) {        // we know that the checkbox was unchecked        unset($_SESSION['tmp_user_values']['query'][$sql_md5]['hide_transformation']);    }    // move current query to the last position, to be removed last    // so only least executed query will be removed if maximum remembered queries    // limit is reached    $tmp = $_SESSION['tmp_user_values']['query'][$sql_md5];    unset($_SESSION['tmp_user_values']['query'][$sql_md5]);    $_SESSION['tmp_user_values']['query'][$sql_md5] = $tmp;    // do not exceed a maximum number of queries to remember    if (count($_SESSION['tmp_user_values']['query']) > 10) {        array_shift($_SESSION['tmp_user_values']['query']);        //echo 'deleting one element ...';    }    // populate query configuration    $_SESSION['tmp_user_values']['display_text'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['display_text'];    $_SESSION['tmp_user_values']['relational_display'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['relational_display'];    $_SESSION['tmp_user_values']['geometry_display'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['geometry_display'];    $_SESSION['tmp_user_values']['display_binary'] = isset($_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary']) ? true : false;    $_SESSION['tmp_user_values']['display_binary_as_hex'] = isset($_SESSION['tmp_user_values']['query'][$sql_md5]['display_binary_as_hex']) ? true : false;    $_SESSION['tmp_user_values']['display_blob'] = isset($_SESSION['tmp_user_values']['query'][$sql_md5]['display_blob']) ? true : false;    $_SESSION['tmp_user_values']['hide_transformation'] = isset($_SESSION['tmp_user_values']['query'][$sql_md5]['hide_transformation']) ? true : false;    $_SESSION['tmp_user_values']['pos'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['pos'];    $_SESSION['tmp_user_values']['max_rows'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['max_rows'];    $_SESSION['tmp_user_values']['repeat_cells'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['repeat_cells'];    $_SESSION['tmp_user_values']['disp_direction'] = $_SESSION['tmp_user_values']['query'][$sql_md5]['disp_direction'];    /*     * debugging    echo '<pre>';    var_dump($_SESSION['tmp_user_values']);    echo '</pre>';     */}/** * Displays a table of results returned by a SQL query. * This function is called by the "sql.php" script. * * @param integer &$dt_result     the link id associated to the query which results have *                                to be displayed * @param array   &$the_disp_mode the display mode * @param array   $analyzed_sql   the analyzed query * * @global  string   $db                the database name * @global  string   $table             the table name * @global  string   $goto              the URL to go back in case of errors * @global  string   $sql_query         the current SQL query * @global  integer  $num_rows          the total number of rows returned by the *                                      SQL query * @global  integer  $unlim_num_rows    the total number of rows returned by the *                                      SQL query without any programmatically *                                      appended "LIMIT" clause * @global  array    $fields_meta       the list of fields properties * @global  integer  $fields_cnt        the total number of fields returned by *                                      the SQL query * @global  array    $vertical_display  informations used with vertical display *                                      mode * @global  array    $highlight_columns column names to highlight * @global  array    $cfgRelation       the relation settings * @global  array    $showtable         table definitions * * @access  private * * @see     PMA_showMessage(), PMA_setDisplayMode(), *          PMA_displayTableNavigation(), PMA_displayTableHeaders(), *          PMA_displayTableBody(), PMA_displayResultsOperations() * * @return nothing */function PMA_displayTable(&$dt_result, &$the_disp_mode, $analyzed_sql){    global $db, $table, $goto;    global $sql_query, $num_rows, $unlim_num_rows, $fields_meta, $fields_cnt;    global $vertical_display, $highlight_columns;    global $cfgRelation;    global $showtable;    // why was this called here? (already called from sql.php)    //PMA_displayTable_checkConfigParams();    /**     * @todo move this to a central place     * @todo for other future table types     */    $is_innodb = (isset($showtable['Type']) && $showtable['Type'] == 'InnoDB');    if ($is_innodb        && ! isset($analyzed_sql[0]['queryflags']['union'])        && ! isset($analyzed_sql[0]['table_ref'][1]['table_name'])        && (empty($analyzed_sql[0]['where_clause']) || $analyzed_sql[0]['where_clause'] == '1 ')    ) {        // "j u s t   b r o w s i n g"        $pre_count = '~';        $after_count = PMA_showHint(PMA_sanitize(__('May be approximate. See [a@./Documentation.html#faq3_11@Documentation]FAQ 3.11[/a]')));    } else {        $pre_count = '';        $after_count = '';    }    // 1. ----- Prepares the work -----    // 1.1 Gets the informations about which functionalities should be    //     displayed    $total      = '';    $is_display = PMA_setDisplayMode($the_disp_mode, $total);    // 1.2 Defines offsets for the next and previous pages    if ($is_display['nav_bar'] == '1') {        if ($_SESSION['tmp_user_values']['max_rows'] == 'all') {            $pos_next     = 0;            $pos_prev     = 0;        } else {            $pos_next     = $_SESSION['tmp_user_values']['pos'] + $_SESSION['tmp_user_values']['max_rows'];            $pos_prev     = $_SESSION['tmp_user_values']['pos'] - $_SESSION['tmp_user_values']['max_rows'];            if ($pos_prev < 0) {                $pos_prev = 0;            }        }    } // end if    // 1.3 Find the sort expression    // we need $sort_expression and $sort_expression_nodirection    // even if there are many table references    if (! empty($analyzed_sql[0]['order_by_clause'])) {        $sort_expression = trim(str_replace('  ', ' ', $analyzed_sql[0]['order_by_clause']));        /**         * Get rid of ASC|DESC         */        preg_match('@(.*)([[:space:]]*(ASC|DESC))@si', $sort_expression, $matches);        $sort_expression_nodirection = isset($matches[1]) ? trim($matches[1]) : $sort_expression;        $sort_direction = isset($matches[2]) ? trim($matches[2]) : '';        unset($matches);    } else {        $sort_expression = $sort_expression_nodirection = $sort_direction = '';    }    // 1.4 Prepares display of first and last value of the sorted column    if (! empty($sort_expression_nodirection)) {        if (strpos($sort_expression_nodirection, '.') === false) {            $sort_table = $table;            $sort_column = $sort_expression_nodirection;        } else {            list($sort_table, $sort_column) = explode('.', $sort_expression_nodirection);        }        $sort_table = PMA_unQuote($sort_table);        $sort_column = PMA_unQuote($sort_column);        // find the sorted column index in row result        // (this might be a multi-table query)        $sorted_column_index = false;        foreach ($fields_meta as $key => $meta) {            if ($meta->table == $sort_table && $meta->name == $sort_column) {                $sorted_column_index = $key;                break;            }        }        if ($sorted_column_index !== false) {            // fetch first row of the result set            $row = PMA_DBI_fetch_row($dt_result);            // initializing default arguments            $default_function = 'default_function';            $transform_function = $default_function;            $transform_options = array();            // check for non printable sorted row data            $meta = $fields_meta[$sorted_column_index];            if (stristr($meta->type, 'BLOB') || $meta->type == 'geometry') {                $column_for_first_row = PMA_handle_non_printable_contents($meta->type, $row[$sorted_column_index], $transform_function, $transform_options, $default_function, $meta, null);            } else {                $column_for_first_row = $row[$sorted_column_index];            }            $column_for_first_row = strtoupper(substr($column_for_first_row, 0, $GLOBALS['cfg']['LimitChars']));            // fetch last row of the result set            PMA_DBI_data_seek($dt_result, $num_rows - 1);            $row = PMA_DBI_fetch_row($dt_result);            // check for non printable sorted row data            $meta = $fields_meta[$sorted_column_index];            if (stristr($meta->type, 'BLOB') || $meta->type == 'geometry') {                $column_for_last_row = PMA_handle_non_printable_contents($meta->type, $row[$sorted_column_index], $transform_function, $transform_options, $default_function, $meta, null);            } else {                $column_for_last_row = $row[$sorted_column_index];            }            $column_for_last_row = strtoupper(substr($column_for_last_row, 0, $GLOBALS['cfg']['LimitChars']));            // reset to first row for the loop in PMA_displayTableBody()            PMA_DBI_data_seek($dt_result, 0);            // we could also use here $sort_expression_nodirection            $sorted_column_message = ' [' . htmlspecialchars($sort_column) . ': <strong>' . htmlspecialchars($column_for_first_row) . ' - ' . htmlspecialchars($column_for_last_row) . '</strong>]';            unset($row, $column_for_first_row, $column_for_last_row, $meta, $default_function, $transform_function, $transform_options);        }        unset($sorted_column_index, $sort_table, $sort_column);    }    // 2. ----- Displays the top of the page -----    // 2.1 Displays a messages with position informations    if ($is_display['nav_bar'] == '1' && isset($pos_next)) {        if (isset($unlim_num_rows) && $unlim_num_rows != $total) {            $selectstring = ', ' . $unlim_num_rows . ' ' . __('in query');        } else {            $selectstring = '';        }        if (! empty($analyzed_sql[0]['limit_clause'])) {            $limit_data = PMA_analyzeLimitClause($analyzed_sql[0]['limit_clause']);            $first_shown_rec = $limit_data['start'];            if ($limit_data['length'] < $total) {                $last_shown_rec = $limit_data['start'] + $limit_data['length'] - 1;            } else {                $last_shown_rec = $limit_data['start'] + $total - 1;            }        } elseif ($_SESSION['tmp_user_values']['max_rows'] == 'all' || $pos_next > $total) {            $first_shown_rec = $_SESSION['tmp_user_values']['pos'];            $last_shown_rec  = $total - 1;        } else {            $first_shown_rec = $_SESSION['tmp_user_values']['pos'];            $last_shown_rec  = $pos_next - 1;        }        if (PMA_Table::isView($db, $table)            && $total == $GLOBALS['cfg']['MaxExactCountViews']        ) {            $message = PMA_Message::notice(__('This view has at least this number of rows. Please refer to %sdocumentation%s.'));            $message->addParam('[a@./Documentation.html#cfg_MaxExactCount@_blank]');            $message->addParam('[/a]');            $message_view_warning = PMA_showHint($message);        } else {            $message_view_warning = false;        }        $message = PMA_Message::success(__('Showing rows'));        $message->addMessage($first_shown_rec);        if ($message_view_warning) {            $message->addMessage('...', ' - ');            $message->addMessage($message_view_warning);            $message->addMessage('(');        } else {            $message->addMessage($last_shown_rec, ' - ');            $message->addMessage(' (');            $message->addMessage($pre_count  . PMA_formatNumber($total, 0));            $message->addString(__('total'));            if (!empty($after_count)) {                $message->addMessage($after_count);            }            $message->addMessage($selectstring, '');            $message->addMessage(', ', '');        }        $messagge_qt = PMA_Message::notice(__('Query took %01.4f sec'));        $messagge_qt->addParam($GLOBALS['querytime']);        $message->addMessage($messagge_qt, '');        $message->addMessage(')', '');        $message->addMessage(isset($sorted_column_message) ? $sorted_column_message : '', '');        PMA_showMessage($message, $sql_query, 'success');    } elseif (! isset($GLOBALS['printview']) || $GLOBALS['printview'] != '1') {        PMA_showMessage(__('Your SQL query has been executed successfully'), $sql_query, 'success');    }    // 2.3 Displays the navigation bars    if (! strlen($table)) {        if (isset($analyzed_sql[0]['query_type'])            && $analyzed_sql[0]['query_type'] == 'SELECT'        ) {            // table does not always contain a real table name,            // for example in MySQL 5.0.x, the query SHOW STATUS            // returns STATUS as a table name            $table = $fields_meta[0]->table;        } else {            $table = '';        }    }    if ($is_display['nav_bar'] == '1' && empty($analyzed_sql[0]['limit_clause'])) {        PMA_displayTableNavigation($pos_next, $pos_prev, $sql_query, 'top_direction_dropdown');        echo "\n";    } elseif (! isset($GLOBALS['printview']) || $GLOBALS['printview'] != '1') {        echo "\n" . '<br /><br />' . "\n";    }    // 2b ----- Get field references from Database -----    // (see the 'relation' configuration variable)    // initialize map    $map = array();    // find tables    $target=array();    if (isset($analyzed_sql[0]['table_ref']) && is_array($analyzed_sql[0]['table_ref'])) {        foreach ($analyzed_sql[0]['table_ref'] AS $table_ref_position => $table_ref) {            $target[] = $analyzed_sql[0]['table_ref'][$table_ref_position]['table_true_name'];        }    }    $tabs    = '(\'' . join('\',\'', $target) . '\')';    if (! strlen($table)) {        $exist_rel = false;    } else {        // To be able to later display a link to the related table,        // we verify both types of relations: either those that are        // native foreign keys or those defined in the phpMyAdmin        // configuration storage. If no PMA storage, we won't be able        // to use the "column to display" notion (for example show        // the name related to a numeric id).        $exist_rel = PMA_getForeigners($db, $table, '', 'both');        if ($exist_rel) {            foreach ($exist_rel AS $master_field => $rel) {                $display_field = PMA_getDisplayField($rel['foreign_db'], $rel['foreign_table']);                $map[$master_field] = array($rel['foreign_table'],                                      $rel['foreign_field'],                                      $display_field,                                      $rel['foreign_db']);            } // end while        } // end if    } // end if    // end 2b    // 3. ----- Displays the results table -----    PMA_displayTableHeaders($is_display, $fields_meta, $fields_cnt, $analyzed_sql, $sort_expression, $sort_expression_nodirection, $sort_direction);    $url_query = '';    echo '<tbody>' . "\n";    $clause_is_unique = PMA_displayTableBody($dt_result, $is_display, $map, $analyzed_sql);    // vertical output case    if ($_SESSION['tmp_user_values']['disp_direction'] == 'vertical') {        PMA_displayVerticalTable();    } // end if    unset($vertical_display);    echo '</tbody>' . "\n";    ?></table>    <?php    // 4. ----- Displays the link for multi-fields edit and delete    if ($is_display['del_lnk'] == 'dr' && $is_display['del_lnk'] != 'kp') {        $delete_text = $is_display['del_lnk'] == 'dr' ? __('Delete') : __('Kill');        $_url_params = array(            'db'        => $db,            'table'     => $table,            'sql_query' => $sql_query,            'goto'      => $goto,        );        $uncheckall_url = 'sql.php' . PMA_generate_common_url($_url_params);        $_url_params['checkall'] = '1';        $checkall_url = 'sql.php' . PMA_generate_common_url($_url_params);        if ($_SESSION['tmp_user_values']['disp_direction'] == 'vertical') {            $checkall_params['onclick'] = 'if (setCheckboxes(\'resultsForm\', true)) return false;';            $uncheckall_params['onclick'] = 'if (setCheckboxes(\'resultsForm\', false)) return false;';        } else {            $checkall_params['onclick'] = 'if (markAllRows(\'resultsForm\')) return false;';            $uncheckall_params['onclick'] = 'if (unMarkAllRows(\'resultsForm\')) return false;';        }        $checkall_link = PMA_linkOrButton($checkall_url, __('Check All'), $checkall_params, false);        $uncheckall_link = PMA_linkOrButton($uncheckall_url, __('Uncheck All'), $uncheckall_params, false);        if ($_SESSION['tmp_user_values']['disp_direction'] != 'vertical') {            echo '<img class="selectallarrow" width="38" height="22"'                .' src="' . $GLOBALS['pmaThemeImage'] . 'arrow_' . $GLOBALS['text_dir'] . '.png' . '"'                .' alt="' . __('With selected:') . '" />';        }        echo $checkall_link . "\n"            .' / ' . "\n"            .$uncheckall_link . "\n"            .'<i>' . __('With selected:') . '</i>' . "\n";        PMA_buttonOrImage(            'submit_mult', 'mult_submit', 'submit_mult_change',            __('Change'), 'b_edit.png', 'edit'        );        PMA_buttonOrImage(            'submit_mult', 'mult_submit', 'submit_mult_delete',            $delete_text, 'b_drop.png', 'delete'        );        if (isset($analyzed_sql[0]) && $analyzed_sql[0]['querytype'] == 'SELECT') {            PMA_buttonOrImage(                'submit_mult', 'mult_submit', 'submit_mult_export',                __('Export'), 'b_tblexport.png', 'export'            );        }        echo "\n";        echo '<input type="hidden" name="sql_query"'            .' value="' . htmlspecialchars($sql_query) . '" />' . "\n";        if (! empty($GLOBALS['url_query'])) {            echo '<input type="hidden" name="url_query"'                .' value="' . $GLOBALS['url_query'] . '" />' . "\n";        }        echo '<input type="hidden" name="clause_is_unique"'            .' value="' . $clause_is_unique . '" />' . "\n";        echo '</form>' . "\n";    }    // 5. ----- Displays the navigation bar at the bottom if required -----    if ($is_display['nav_bar'] == '1' && empty($analyzed_sql[0]['limit_clause'])) {        echo '<br />' . "\n";        PMA_displayTableNavigation($pos_next, $pos_prev, $sql_query, 'bottom_direction_dropdown');    } elseif (! isset($GLOBALS['printview']) || $GLOBALS['printview'] != '1') {        echo "\n" . '<br /><br />' . "\n";    }    // 6. ----- Displays "Query results operations"    if (! isset($GLOBALS['printview']) || $GLOBALS['printview'] != '1') {        PMA_displayResultsOperations($the_disp_mode, $analyzed_sql);    }} // end of the 'PMA_displayTable()' functionfunction default_function($buffer){    $buffer = htmlspecialchars($buffer);    $buffer = str_replace("\011", ' &nbsp;&nbsp;&nbsp;', str_replace('  ', ' &nbsp;', $buffer));    $buffer = preg_replace("@((\015\012)|(\015)|(\012))@", '<br />', $buffer);    return $buffer;}/** * Displays operations that are available on results. * * @param array $the_disp_mode the display mode * @param array $analyzed_sql  the analyzed query * * @global  string   $db                the database name * @global  string   $table             the table name * @global  string   $sql_query         the current SQL query * @global  integer  $unlim_num_rows    the total number of rows returned by the *                                      SQL query without any programmatically *                                      appended "LIMIT" clause * * @access  private * * @see     PMA_showMessage(), PMA_setDisplayMode(), *          PMA_displayTableNavigation(), PMA_displayTableHeaders(), *          PMA_displayTableBody(), PMA_displayResultsOperations() * * @return nothing */function PMA_displayResultsOperations($the_disp_mode, $analyzed_sql){    global $db, $table, $sql_query, $unlim_num_rows, $fields_meta;    $header_shown = false;    $header = '<fieldset><legend>' . __('Query results operations') . '</legend>';    if ($the_disp_mode[6] == '1' || $the_disp_mode[9] == '1') {        // Displays "printable view" link if required        if ($the_disp_mode[9] == '1') {            if (!$header_shown) {                echo $header;                $header_shown = true;            }            $_url_params = array(                'db'        => $db,                'table'     => $table,                'printview' => '1',                'sql_query' => $sql_query,            );            $url_query = PMA_generate_common_url($_url_params);            echo PMA_linkOrButton(                'sql.php' . $url_query,                PMA_getIcon('b_print.png', __('Print view'), true),                '', true, true, 'print_view'            ) . "\n";            if ($_SESSION['tmp_user_values']['display_text']) {                $_url_params['display_text'] = 'F';                echo PMA_linkOrButton(                    'sql.php' . PMA_generate_common_url($_url_params),                    PMA_getIcon('b_print.png', __('Print view (with full texts)'), true),                    '', true, true, 'print_view'                ) . "\n";                unset($_url_params['display_text']);            }        } // end displays "printable view"    }    // Export link    // (the url_query has extra parameters that won't be used to export)    // (the single_table parameter is used in display_export.lib.php    //  to hide the SQL and the structure export dialogs)    // If the parser found a PROCEDURE clause    // (most probably PROCEDURE ANALYSE()) it makes no sense to    // display the Export link).    if (isset($analyzed_sql[0]) && $analyzed_sql[0]['querytype'] == 'SELECT' && ! isset($printview) && ! isset($analyzed_sql[0]['queryflags']['procedure'])) {        if (isset($analyzed_sql[0]['table_ref'][0]['table_true_name']) && ! isset($analyzed_sql[0]['table_ref'][1]['table_true_name'])) {            $_url_params['single_table'] = 'true';        }        if (!$header_shown) {            echo $header;            $header_shown = true;        }        $_url_params['unlim_num_rows'] = $unlim_num_rows;        /**         * At this point we don't know the table name; this can happen         * for example with a query like         * SELECT bike_code FROM (SELECT bike_code FROM bikes) tmp         * As a workaround we set in the table parameter the name of the         * first table of this database, so that tbl_export.php and         * the script it calls do not fail         */        if (empty($_url_params['table']) && !empty($_url_params['db'])) {            $_url_params['table'] = PMA_DBI_fetch_value("SHOW TABLES");            /* No result (probably no database selected) */            if ($_url_params['table'] === false) {                unset($_url_params['table']);            }        }        echo PMA_linkOrButton(            'tbl_export.php' . PMA_generate_common_url($_url_params),            PMA_getIcon('b_tblexport.png', __('Export'), true),            '', true, true, ''        ) . "\n";        // show chart        echo PMA_linkOrButton(            'tbl_chart.php' . PMA_generate_common_url($_url_params),            PMA_getIcon('b_chart.png', __('Display chart'), true),            '', true, true, ''        ) . "\n";        // show GIS chart        $geometry_found = false;        // If atleast one geometry field is found        foreach ($fields_meta as $meta) {            if ($meta->type == 'geometry') {                $geometry_found = true;                break;            }        }        if ($geometry_found) {            echo PMA_linkOrButton(                'tbl_gis_visualization.php' . PMA_generate_common_url($_url_params),                PMA_getIcon('b_globe.gif', __('Visualize GIS data'), true),                '', true, true, ''            ) . "\n";        }    }    // CREATE VIEW    /**     *     * @todo detect privileges to create a view     *       (but see 2006-01-19 note in display_create_table.lib.php,     *        I think we cannot detect db-specific privileges reliably)     * Note: we don't display a Create view link if we found a PROCEDURE clause     */    if (!$header_shown) {        echo $header;        $header_shown = true;    }    if (!PMA_DRIZZLE && !isset($analyzed_sql[0]['queryflags']['procedure'])) {        echo PMA_linkOrButton(            'view_create.php' . $url_query,            PMA_getIcon('b_views.png', __('Create view'), true),            '', true, true, ''        ) . "\n";    }    if ($header_shown) {        echo '</fieldset><br />';    }}/** * Verifies what to do with non-printable contents (binary or BLOB) * in Browse mode. * * @param string $category           BLOB|BINARY|GEOMETRY * @param string $content            the binary content * @param string $transform_function transformation function * @param string $transform_options  transformation parameters * @param string $default_function   default transformation function * @param object $meta               the meta-information about this field * @param array  $url_params         parameters that should go to the download link * * @return  mixed  string or float */function PMA_handle_non_printable_contents($category, $content, $transform_function, $transform_options, $default_function, $meta, $url_params = array()){    $result = '[' . $category;    if (is_null($content)) {        $result .= ' - NULL';        $size = 0;    } elseif (isset($content)) {        $size = strlen($content);        $display_size = PMA_formatByteDown($size, 3, 1);        $result .= ' - '. $display_size[0] . ' ' . $display_size[1];    }    $result .= ']';    if (strpos($transform_function, 'octetstream')) {        $result = $content;    }    if ($size > 0) {        if ($default_function != $transform_function) {            $result = $transform_function($result, $transform_options, $meta);        } else {            $result = $default_function($result, array(), $meta);            if (stristr($meta->type, 'BLOB') && $_SESSION['tmp_user_values']['display_blob']) {                // in this case, restart from the original $content                $result = htmlspecialchars(PMA_replace_binary_contents($content));            }            /* Create link to download */            if (count($url_params) > 0) {                $result = '<a href="tbl_get_field.php' . PMA_generate_common_url($url_params) . '">' . $result . '</a>';            }        }    }    return($result);}/** * Prepares the displayable content of a data cell in Browse mode, * taking into account foreign key description field and transformations * * @param string $class              css classes for the td element * @param bool   $condition_field    whether the column is a part of the where clause * @param string $analyzed_sql       the analyzed query * @param object $meta               the meta-information about this field * @param array  $map                the list of relations * @param string $data               data * @param string $transform_function transformation function * @param string $default_function   default function * @param string $nowrap             'nowrap' if the content should not be wrapped * @param string $where_comparison   data for the where cluase * @param array  $transform_options  array of options for transformation * @param bool   $is_field_truncated whether the field is truncated * * @return  string  formatted data */function PMA_prepare_row_data($class, $condition_field, $analyzed_sql, $meta, $map, $data, $transform_function, $default_function, $nowrap, $where_comparison, $transform_options, $is_field_truncated ){    $result = ' class="' . PMA_addClass($class, $condition_field, $meta, $nowrap, $is_field_truncated, $transform_function, $default_function) . '">';    if (isset($analyzed_sql[0]['select_expr']) && is_array($analyzed_sql[0]['select_expr'])) {        foreach ($analyzed_sql[0]['select_expr'] AS $select_expr_position => $select_expr) {            $alias = $analyzed_sql[0]['select_expr'][$select_expr_position]['alias'];            if (isset($alias) && strlen($alias)) {                $true_column = $analyzed_sql[0]['select_expr'][$select_expr_position]['column'];                if ($alias == $meta->name) {                    // this change in the parameter does not matter                    // outside of the function                    $meta->name = $true_column;                } // end if            } // end if        } // end foreach    } // end if    if (isset($map[$meta->name])) {        // Field to display from the foreign table?        if (isset($map[$meta->name][2]) && strlen($map[$meta->name][2])) {            $dispsql     = 'SELECT ' . PMA_backquote($map[$meta->name][2])                . ' FROM ' . PMA_backquote($map[$meta->name][3])                . '.' . PMA_backquote($map[$meta->name][0])                . ' WHERE ' . PMA_backquote($map[$meta->name][1])                . $where_comparison;            $dispresult  = PMA_DBI_try_query($dispsql, null, PMA_DBI_QUERY_STORE);            if ($dispresult && PMA_DBI_num_rows($dispresult) > 0) {                list($dispval) = PMA_DBI_fetch_row($dispresult, 0);            } else {                $dispval = __('Link not found');            }            @PMA_DBI_free_result($dispresult);        } else {            $dispval     = '';        } // end if... else...        if (isset($GLOBALS['printview']) && $GLOBALS['printview'] == '1') {            $result .= ($transform_function != $default_function ? $transform_function($data, $transform_options, $meta) : $transform_function($data, array(), $meta)) . ' <code>[-&gt;' . $dispval . ']</code>';        } else {            if ('K' == $_SESSION['tmp_user_values']['relational_display']) {                // user chose "relational key" in the display options, so                // the title contains the display field                $title = (! empty($dispval))? ' title="' . htmlspecialchars($dispval) . '"' : '';            } else {                $title = ' title="' . htmlspecialchars($data) . '"';            }            $_url_params = array(                'db'    => $map[$meta->name][3],                'table' => $map[$meta->name][0],                'pos'   => '0',                'sql_query' => 'SELECT * FROM '                                    . PMA_backquote($map[$meta->name][3]) . '.' . PMA_backquote($map[$meta->name][0])                                    . ' WHERE ' . PMA_backquote($map[$meta->name][1])                                    . $where_comparison,            );            $result .= '<a href="sql.php' . PMA_generate_common_url($_url_params)                 . '"' . $title . '>';            if ($transform_function != $default_function) {                // always apply a transformation on the real data,                // not on the display field                $result .= $transform_function($data, $transform_options, $meta);            } else {                if ('D' == $_SESSION['tmp_user_values']['relational_display']) {                    // user chose "relational display field" in the                    // display options, so show display field in the cell                    $result .= $transform_function($dispval, array(), $meta);                } else {                    // otherwise display data in the cell                    $result .= $transform_function($data, array(), $meta);                }            }            $result .= '</a>';        }    } else {        $result .= ($transform_function != $default_function ? $transform_function($data, $transform_options, $meta) : $transform_function($data, array(), $meta));    }    $result .= '</td>' . "\n";    return $result;}/** * Generates a checkbox for multi-row submits * * @param string $del_url           delete url * @param array  $is_display        array with explicit indexes for all the display elements * @param string $row_no            the row number * @param string $where_clause_html url encoded where cluase * @param array  $condition_array   array of conditions in the where cluase * @param string $del_query         delete query * @param string $id_suffix         suffix for the id * @param string $class             css classes for the td element * * @return  string  the generated HTML */function PMA_generateCheckboxForMulti($del_url, $is_display, $row_no, $where_clause_html, $condition_array, $del_query, $id_suffix, $class){    $ret = '';    if (! empty($del_url) && $is_display['del_lnk'] != 'kp') {        $ret .= '<td ';        if (! empty($class)) {            $ret .= 'class="' . $class . '"';        }        $ret .= ' align="center">'           . '<input type="checkbox" id="id_rows_to_delete' . $row_no . $id_suffix . '" name="rows_to_delete[' . $where_clause_html . ']"'           . ' class="multi_checkbox"'           . ' value="' . htmlspecialchars($del_query) . '" ' . (isset($GLOBALS['checkall']) ? 'checked="checked"' : '') . ' />'           . '<input type="hidden" class="condition_array" value="' . htmlspecialchars(json_encode($condition_array)) . '" />'           . '    </td>';    }    return $ret;}/** * Generates an Edit link * * @param string $edit_url          edit url * @param string $class             css classes for td element * @param string $edit_str          text for the edit link * @param string $where_clause      where cluase * @param string $where_clause_html url encoded where cluase * * @return  string  the generated HTML */function PMA_generateEditLink($edit_url, $class, $edit_str, $where_clause, $where_clause_html){    $ret = '';    if (! empty($edit_url)) {        $ret .= '<td class="' . $class . '" align="center" ' . ' ><span class="nowrap">'           . PMA_linkOrButton($edit_url, $edit_str, array(), false);        /*         * Where clause for selecting this row uniquely is provided as         * a hidden input. Used by jQuery scripts for handling grid editing         */        if (! empty($where_clause)) {            $ret .= '<input type="hidden" class="where_clause" value ="' . $where_clause_html . '" />';        }        $ret .= '</span></td>';    }    return $ret;}/** * Generates an Copy link * * @param string $copy_url          copy url * @param string $copy_str          text for the copy link * @param string $where_clause      where clause * @param string $where_clause_html url encoded where cluase * @param string $class             css classes for the td element * * @return  string  the generated HTML */function PMA_generateCopyLink($copy_url, $copy_str, $where_clause, $where_clause_html, $class){    $ret = '';    if (! empty($copy_url)) {        $ret .= '<td ';        if (! empty($class)) {            $ret .= 'class="' . $class . '" ';        }        $ret .= 'align="center" ' . ' ><span class="nowrap">'           . PMA_linkOrButton($copy_url, $copy_str, array(), false);        /*         * Where clause for selecting this row uniquely is provided as         * a hidden input. Used by jQuery scripts for handling grid editing         */        if (! empty($where_clause)) {            $ret .= '<input type="hidden" class="where_clause" value ="' . $where_clause_html . '" />';        }        $ret .= '</span></td>';    }    return $ret;}/** * Generates a Delete link * * @param string $del_url delete url * @param string $del_str text for the delete link * @param string $js_conf text for the JS confirmation * @param string $class   css classes for the td element * * @return  string  the generated HTML */function PMA_generateDeleteLink($del_url, $del_str, $js_conf, $class){    $ret = '';    if (! empty($del_url)) {        $ret .= '<td ';        if (! empty($class)) {            $ret .= 'class="' . $class . '" ';        }        $ret .= 'align="center" ' . ' >'           . PMA_linkOrButton($del_url, $del_str, $js_conf, false)           . '</td>';    }    return $ret;}/** * Generates checkbox and links at some position (left or right) * (only called for horizontal mode) * * @param string $position          the position of the checkbox and links * @param string $del_url           delete url * @param array  $is_display        array with explicit indexes for all the display elements * @param string $row_no            row number * @param string $where_clause      where clause * @param string $where_clause_html url encoded where cluase * @param array  $condition_array   array of conditions in the where cluase * @param string $del_query         delete query * @param string $id_suffix         suffix for the id * @param string $edit_url          edit url * @param string $copy_url          copy url * @param string $class             css classes for the td elements * @param string $edit_str          text for the edit link * @param string $copy_str          text for the copy link * @param string $del_str           text for the delete link * @param string $js_conf           text for the JS confirmation * * @return  string  the generated HTML */function PMA_generateCheckboxAndLinks($position, $del_url, $is_display, $row_no, $where_clause, $where_clause_html, $condition_array, $del_query, $id_suffix, $edit_url, $copy_url, $class, $edit_str, $copy_str, $del_str, $js_conf){    $ret = '';    if ($position == 'left') {        $ret .= PMA_generateCheckboxForMulti($del_url, $is_display, $row_no, $where_clause_html, $condition_array, $del_query, $id_suffix = '_left', '', '', '');        $ret .= PMA_generateEditLink($edit_url, $class, $edit_str, $where_clause, $where_clause_html, '');        $ret .= PMA_generateCopyLink($copy_url, $copy_str, $where_clause, $where_clause_html, '');        $ret .= PMA_generateDeleteLink($del_url, $del_str, $js_conf, '', '');    } elseif ($position == 'right') {        $ret .= PMA_generateDeleteLink($del_url, $del_str, $js_conf, '', '');        $ret .= PMA_generateCopyLink($copy_url, $copy_str, $where_clause, $where_clause_html, '');        $ret .= PMA_generateEditLink($edit_url, $class, $edit_str, $where_clause, $where_clause_html, '');        $ret .= PMA_generateCheckboxForMulti($del_url, $is_display, $row_no, $where_clause_html, $condition_array, $del_query, $id_suffix = '_right', '', '', '');    } else { // $position == 'none'        $ret .= PMA_generateCheckboxForMulti($del_url, $is_display, $row_no, $where_clause_html, $condition_array, $del_query, $id_suffix = '_left', '', '', '');    }    return $ret;}?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * Gets some core libraries */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'functions.js';$GLOBALS['js_include'][] = 'jquery/jquery-ui-1.8.16.custom.js';require_once './libraries/mysql_charsets.lib.php';if (!PMA_DRIZZLE) {    include_once './libraries/replication.inc.php';}require './libraries/build_html_for_db.lib.php';PMA_checkParameters(array('new_db'));/** * Defines the url to return to in case of error in a sql statement */$err_url = 'main.php?' . PMA_generate_common_url();/** * Builds and executes the db creation sql query */$sql_query = 'CREATE DATABASE ' . PMA_backquote($new_db);if (!empty($db_collation)) {    list($db_charset) = explode('_', $db_collation);    if (in_array($db_charset, $mysql_charsets) && in_array($db_collation, $mysql_collations[$db_charset])) {        $sql_query .= ' DEFAULT' . PMA_generateCharsetQueryPart($db_collation);    }    $db_collation_for_ajax = $db_collation;    unset($db_charset, $db_collation);}$sql_query .= ';';$result = PMA_DBI_try_query($sql_query);if (! $result) {    $message = PMA_Message::rawError(PMA_DBI_getError());    // avoid displaying the not-created db name in header or navi panel    $GLOBALS['db'] = '';    $GLOBALS['table'] = '';    /**     * If in an Ajax request, just display the message with {@link PMA_ajaxResponse}     */    if ($GLOBALS['is_ajax_request'] == true) {        PMA_ajaxResponse($message, false);    }    include_once './libraries/header.inc.php';    include_once './main.php';} else {    $message = PMA_Message::success(__('Database %1$s has been created.'));    $message->addParam($new_db);    $GLOBALS['db'] = $new_db;    /**     * If in an Ajax request, build the output and send it     */    if ($GLOBALS['is_ajax_request'] == true) {        /**         * String containing the SQL Query formatted in pretty HTML         * @global array $GLOBALS['extra_data']         * @name $extra_data         */        $extra_data['sql_query'] = PMA_showMessage(null, $sql_query, 'success');        //Construct the html for the new database, so that it can be appended to the list of databases on server_databases.php        /**         * Build the array to be passed to {@link PMA_generate_common_url} to generate the links         * @global array $GLOBALS['db_url_params']         * @name $db_url_params         */        $db_url_params['db'] = $new_db;        $is_superuser = PMA_isSuperuser();        $column_order = PMA_getColumnOrder();        $url_query = PMA_generate_common_url($new_db);        /**         * String that will contain the output HTML         * @name    $new_db_string         */        $new_db_string = '<tr>';        if (empty($db_collation_for_ajax)) {            $db_collation_for_ajax = PMA_getServerCollation();        }        // $dbstats comes from the create table dialog        if (! empty($dbstats)) {            $current = array(                'SCHEMA_NAME' => $new_db,                'DEFAULT_COLLATION_NAME' => $db_collation_for_ajax,                'SCHEMA_TABLES' => '0',                'SCHEMA_TABLE_ROWS' => '0',                'SCHEMA_DATA_LENGTH' => '0',                'SCHEMA_MAX_DATA_LENGTH' => '0',                'SCHEMA_INDEX_LENGTH' => '0',                'SCHEMA_LENGTH' => '0',                'SCHEMA_DATA_FREE' => '0'            );        } else {            $current = array(                'SCHEMA_NAME' => $new_db            );        }        list($column_order, $generated_html) = PMA_buildHtmlForDb($current, $is_superuser, (isset($checkall) ? $checkall : ''), $url_query, $column_order, $replication_types, $replication_info);        $new_db_string .= $generated_html;        $new_db_string .= '</tr>';        $extra_data['new_db_string'] = $new_db_string;        PMA_ajaxResponse($message, true, $extra_data);    }    include_once './libraries/header.inc.php';    include_once './' . $cfg['DefaultTabDatabase'];}?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * manipulation of table data like inserting, replacing and updating * * usally called as form action from tbl_change.php to insert or update table rows * * * @todo 'edit_next' tends to not work as expected if used ... at least there is no order by *       it needs the original query and the row number and than replace the LIMIT clause * @package PhpMyAdmin *//** * do not import request variable into global scope * * cannot be used as long as it could happen that the $goto file that is included * at the end of this script is not updated to work without imported request variables * * @todo uncomment this if all possible included files to rely on import request variablesif (! defined('PMA_NO_VARIABLES_IMPORT')) {    define('PMA_NO_VARIABLES_IMPORT', true);} *//** * Gets some core libraries */require_once './libraries/common.inc.php';$blob_streaming_active = $GLOBALS['PMA_Config']->get('BLOBSTREAMING_PLUGINS_EXIST');// Check parametersPMA_checkParameters(array('db', 'table', 'goto'));PMA_DBI_select_db($GLOBALS['db']);/** * Initializes some variables */$goto_include = false;$GLOBALS['js_include'][] = 'makegrid.js';// Needed for generation of Inline Edit anchors$GLOBALS['js_include'][] = 'sql.js';if (isset($_REQUEST['insert_rows']) && is_numeric($_REQUEST['insert_rows']) && $_REQUEST['insert_rows'] != $cfg['InsertRows']) {    $cfg['InsertRows'] = $_REQUEST['insert_rows'];    $GLOBALS['js_include'][] = 'tbl_change.js';    include_once './libraries/header.inc.php';    include './tbl_change.php';    exit;}if (isset($_REQUEST['after_insert']) && in_array($_REQUEST['after_insert'], array('new_insert', 'same_insert', 'edit_next'))) {    $url_params['after_insert'] = $_REQUEST['after_insert'];    //$GLOBALS['goto'] = 'tbl_change.php';    $goto_include = 'tbl_change.php';    if (isset($_REQUEST['where_clause'])) {        if ($_REQUEST['after_insert'] == 'same_insert') {            foreach ($_REQUEST['where_clause'] as $one_where_clause) {                $url_params['where_clause'][] = $one_where_clause;            }        } elseif ($_REQUEST['after_insert'] == 'edit_next') {            foreach ($_REQUEST['where_clause'] as $one_where_clause) {                $local_query    = 'SELECT * FROM ' . PMA_backquote($GLOBALS['db']) . '.' . PMA_backquote($GLOBALS['table'])                                . ' WHERE ' . str_replace('` =', '` >', $one_where_clause)                                . ' LIMIT 1;';                $res            = PMA_DBI_query($local_query);                $row            = PMA_DBI_fetch_row($res);                $meta           = PMA_DBI_get_fields_meta($res);                // must find a unique condition based on unique key,                // not a combination of all fields                list($unique_condition, $clause_is_unique) = PMA_getUniqueCondition($res, count($meta), $meta, $row, true);                if (! empty($unique_condition)) {                    $_SESSION['edit_next'] = $unique_condition;                }                unset($unique_condition, $clause_is_unique);            }        }    }} elseif (! empty($GLOBALS['goto'])) {    if (! preg_match('@^[a-z_]+\.php$@', $GLOBALS['goto'])) {        // this should NOT happen        //$GLOBALS['goto'] = false;        $goto_include = false;    } else {        $goto_include = $GLOBALS['goto'];    }    if ($GLOBALS['goto'] == 'db_sql.php' && strlen($GLOBALS['table'])) {        $GLOBALS['table'] = '';    }}if (! $goto_include) {    if (! strlen($GLOBALS['table'])) {        $goto_include = 'db_sql.php';    } else {        $goto_include = 'tbl_sql.php';    }}// Defines the url to return in case of failure of the queryif (isset($_REQUEST['err_url'])) {    $err_url = $_REQUEST['err_url'];} else {    $err_url = 'tbl_change.php' . PMA_generate_common_url($url_params);}/** * Prepares the update/insert of a row */if (isset($_REQUEST['where_clause'])) {    // we were editing something => use the WHERE clause    $loop_array = (is_array($_REQUEST['where_clause']) ? $_REQUEST['where_clause'] : array($_REQUEST['where_clause']));    $using_key  = true;    $is_insert  = ($_REQUEST['submit_type'] == 'insert') || ($_REQUEST['submit_type'] == 'showinsert') || ($_REQUEST['submit_type'] == 'insertignore');    $is_insertignore  = ($_REQUEST['submit_type'] == 'insertignore');} else {    // new row => use indexes    $loop_array = array();    foreach ($_REQUEST['fields']['multi_edit'] as $key => $dummy) {        $loop_array[] = $key;    }    $using_key  = false;    $is_insert  = true;    $is_insertignore = false;}$query = array();$value_sets = array();$func_no_param = array(    'CONNECTION_ID',    'CURRENT_USER',    'CURDATE',    'CURTIME',    'DATABASE',    'LAST_INSERT_ID',    'NOW',    'PI',    'RAND',    'SYSDATE',    'UNIX_TIMESTAMP',    'USER',    'UTC_DATE',    'UTC_TIME',    'UTC_TIMESTAMP',    'UUID',    'VERSION',);$func_optional_param = array(    'RAND',    'UNIX_TIMESTAMP',);$gis_from_text_functions = array(    'GeomFromText',    'GeomCollFromText',    'LineFromText',    'MLineFromText',    'PointFromText',    'MPointFromText',    'PolyFromText',    'MPolyFromText',);$gis_from_wkb_functions = array(    'GeomFromWKB',    'GeomCollFromWKB',    'LineFromWKB',    'MLineFromWKB',    'PointFromWKB',    'MPointFromWKB',    'PolyFromWKB',    'MPolyFromWKB',);foreach ($loop_array as $rownumber => $where_clause) {    // skip fields to be ignored    if (! $using_key && isset($_REQUEST['insert_ignore_' . $where_clause])) {        continue;    }    // Defines the SET part of the sql query    $query_values = array();    // Map multi-edit keys to single-level arrays, dependent on how we got the fields    $me_fields        = isset($_REQUEST['fields']['multi_edit'][$rownumber])        ? $_REQUEST['fields']['multi_edit'][$rownumber]        : array();    $me_fields_name        = isset($_REQUEST['fields_name']['multi_edit'][$rownumber])        ? $_REQUEST['fields_name']['multi_edit'][$rownumber]        : null;    $me_fields_prev        = isset($_REQUEST['fields_prev']['multi_edit'][$rownumber])        ? $_REQUEST['fields_prev']['multi_edit'][$rownumber]        : null;    $me_funcs        = isset($_REQUEST['funcs']['multi_edit'][$rownumber])        ? $_REQUEST['funcs']['multi_edit'][$rownumber]        : null;    $me_fields_type        = isset($_REQUEST['fields_type']['multi_edit'][$rownumber])        ? $_REQUEST['fields_type']['multi_edit'][$rownumber]        : null;    $me_fields_null        = isset($_REQUEST['fields_null']['multi_edit'][$rownumber])        ? $_REQUEST['fields_null']['multi_edit'][$rownumber]        : null;    $me_fields_null_prev        = isset($_REQUEST['fields_null_prev']['multi_edit'][$rownumber])        ? $_REQUEST['fields_null_prev']['multi_edit'][$rownumber]        : null;    $me_auto_increment        = isset($_REQUEST['auto_increment']['multi_edit'][$rownumber])        ? $_REQUEST['auto_increment']['multi_edit'][$rownumber]        : null;    // Fetch the current values of a row to use in case we have a protected field    // @todo possibly move to ./libraries/tbl_replace_fields.inc.php    if ($is_insert && $using_key && isset($me_fields_type) && is_array($me_fields_type) && isset($where_clause)) {        $prot_row = PMA_DBI_fetch_single_row('SELECT * FROM ' . PMA_backquote($table) . ' WHERE ' . $where_clause . ';');    }    // When a select field is nullified, it's not present in $_REQUEST    // so initialize it; this way, the foreach($me_fields) will process it    foreach ($me_fields_name as $key => $val) {        if (! isset($me_fields[$key])) {            $me_fields[$key] = '';        }    }    // Iterate in the order of $me_fields_name, not $me_fields, to avoid problems    // when inserting multiple entries    foreach ($me_fields_name as $key => $field_name) {        $val = $me_fields[$key];        // Note: $key is an md5 of the fieldname. The actual fieldname is available in $me_fields_name[$key]        include './libraries/tbl_replace_fields.inc.php';        // for blobstreaming        if ($blob_streaming_active) {            $remove_blob_repo = isset($_REQUEST['remove_blob_repo_' . $key]) ? $_REQUEST['remove_blob_repo_' . $key] : null;            $upload_blob_repo = isset($_REQUEST['upload_blob_repo_' . $key]) ? $_REQUEST['upload_blob_repo_' . $key] : null;            // checks if an existing blob repository reference should be removed            if (isset($remove_blob_repo) && ! isset($upload_blob_repo)) {                $remove_blob_reference = $_REQUEST['remove_blob_ref_' . $key];                if (isset($remove_blob_reference)) {                    $val = "NULL";                }            }            // checks if this field requires a bs reference attached to it            if (isset($upload_blob_repo)) {                // get the most recent BLOB reference                $bs_reference = PMA_File::getRecentBLOBReference();                // if the most recent BLOB reference exists, set it as a field value                if (!is_null($bs_reference)) {                    $val = "'" . PMA_sqlAddSlashes($bs_reference) . "'";                }            }        }        if (empty($me_funcs[$key])) {            $cur_value = $val;        } elseif ('UUID' === $me_funcs[$key]) {            /* This way user will know what UUID new row has */            $uuid = PMA_DBI_fetch_value('SELECT UUID()');            $cur_value = "'" . $uuid . "'";        } elseif ((in_array($me_funcs[$key], $gis_from_text_functions)            && substr($val, 0, 3) == "'''")            || in_array($me_funcs[$key], $gis_from_wkb_functions)        ) {            // Remove enclosing apostrophes            $val = substr($val, 1, strlen($val) - 2);            // Remove escaping apostrophes            $val = str_replace("''", "'", $val);            $cur_value = $me_funcs[$key] . '(' . $val . ')';        } elseif (! in_array($me_funcs[$key], $func_no_param)                  || ($val != "''" && in_array($me_funcs[$key], $func_optional_param))) {            $cur_value = $me_funcs[$key] . '(' . $val . ')';        } else {            $cur_value = $me_funcs[$key] . '()';        }        //  i n s e r t        if ($is_insert) {            // no need to add column into the valuelist            if (strlen($cur_value)) {                $query_values[] = $cur_value;                // first inserted row so prepare the list of fields                if (empty($value_sets)) {                    $query_fields[] = PMA_backquote($me_fields_name[$key]);                }            }        //  u p d a t e        } elseif (!empty($me_fields_null_prev[$key])         && ! isset($me_fields_null[$key])) {            // field had the null checkbox before the update            // field no longer has the null checkbox            $query_values[] = PMA_backquote($me_fields_name[$key]) . ' = ' . $cur_value;        } elseif (empty($me_funcs[$key])         && isset($me_fields_prev[$key])         && ("'" . PMA_sqlAddSlashes($me_fields_prev[$key]) . "'" == $val)) {            // No change for this column and no MySQL function is used -> next column            continue;        } elseif (! empty($val)) {            // avoid setting a field to NULL when it's already NULL            // (field had the null checkbox before the update            //  field still has the null checkbox)            if (empty($me_fields_null_prev[$key])             || empty($me_fields_null[$key])) {                 $query_values[] = PMA_backquote($me_fields_name[$key]) . ' = ' . $cur_value;            }        }    } // end foreach ($me_fields as $key => $val)    if (count($query_values) > 0) {        if ($is_insert) {            $value_sets[] = implode(', ', $query_values);        } else {            // build update query            $query[] = 'UPDATE ' . PMA_backquote($GLOBALS['db']) . '.' . PMA_backquote($GLOBALS['table'])                . ' SET ' . implode(', ', $query_values) . ' WHERE ' . $where_clause . ($_REQUEST['clause_is_unique'] ? '' : ' LIMIT 1');        }    }} // end foreach ($loop_array as $where_clause)unset($me_fields_name, $me_fields_prev, $me_funcs, $me_fields_type, $me_fields_null, $me_fields_null_prev,    $me_auto_increment, $cur_value, $key, $val, $loop_array, $where_clause, $using_key,    $func_no_param);// Builds the sql queryif ($is_insert && count($value_sets) > 0) {    if ($is_insertignore) {        $insert_command = 'INSERT IGNORE ';    } else {        $insert_command = 'INSERT ';    }    $query[] = $insert_command . 'INTO ' . PMA_backquote($GLOBALS['db']) . '.' . PMA_backquote($GLOBALS['table'])        . ' (' . implode(', ', $query_fields) . ') VALUES (' . implode('), (', $value_sets) . ')';    unset($insert_command);    unset($query_fields);} elseif (empty($query)) {    // No change -> move back to the calling script    //    // Note: logic passes here for inline edit    $message = PMA_Message::success(__('No change'));    $active_page = $goto_include;    if (! $GLOBALS['is_ajax_request'] == true) {        include_once './libraries/header.inc.php';    }    include './' . PMA_securePath($goto_include);    exit;}unset($me_fields, $is_insertignore);/** * Executes the sql query and get the result, then move back to the calling * page */if (! empty($GLOBALS['sql_query'])) {    $url_params['sql_query'] = $GLOBALS['sql_query'];    $return_to_sql_query = $GLOBALS['sql_query'];}$GLOBALS['sql_query'] = implode('; ', $query) . ';';// to ensure that the query is displayed in case of// "insert as new row" and then "insert another new row"$GLOBALS['display_query'] = $GLOBALS['sql_query'];$total_affected_rows = 0;$last_messages = array();$warning_messages = array();$error_messages = array();foreach ($query as $single_query) {    if ($_REQUEST['submit_type'] == 'showinsert') {        $last_messages[] = PMA_Message::notice(__('Showing SQL query'));        continue;    }    if ($GLOBALS['cfg']['IgnoreMultiSubmitErrors']) {        $result = PMA_DBI_try_query($single_query);    } else {        $result = PMA_DBI_query($single_query);    }    if (! $result) {        $error_messages[] = PMA_Message::sanitize(PMA_DBI_getError());    } else {        // The next line contains a real assignment, it's not a typo        if ($tmp = @PMA_DBI_affected_rows()) {            $total_affected_rows += $tmp;        }        unset($tmp);        $insert_id = PMA_DBI_insert_id();        if ($insert_id != 0) {            // insert_id is id of FIRST record inserted in one insert, so if we            // inserted multiple rows, we had to increment this            if ($total_affected_rows > 0) {                $insert_id = $insert_id + $total_affected_rows - 1;            }            $last_message = PMA_Message::notice(__('Inserted row id: %1$d'));            $last_message->addParam($insert_id);            $last_messages[] = $last_message;        }        PMA_DBI_free_result($result);    } // end if    foreach (PMA_DBI_get_warnings() as $warning) {        $warning_messages[]            = PMA_Message::sanitize(                $warning['Level'] . ': #' . $warning['Code'] . ' ' . $warning['Message']            );    }    unset($result);}unset($single_query, $query);if ($is_insert && count($value_sets) > 0) {    $message = PMA_Message::inserted_rows($total_affected_rows);} else {    $message = PMA_Message::affected_rows($total_affected_rows);}$message->addMessages($last_messages, '<br />');if (! empty($warning_messages)) {    $message->addMessages($warning_messages, '<br />');    $message->isError(true);}if (! empty($error_messages)) {    $message->addMessages($error_messages);    $message->isError(true);}unset($error_messages, $warning_messages, $total_affected_rows, $last_messages, $last_message);if ($GLOBALS['is_ajax_request'] == true) {    /**     * If we are in grid editing, we need to process the relational and     * transformed fields, if they were edited. After that, output the correct     * link/transformed value and exit     *     * Logic taken from libraries/display_tbl.lib.php     */    if (isset($_REQUEST['rel_fields_list']) && $_REQUEST['rel_fields_list'] != '') {        //handle relations work here for updated row.        include_once './libraries/relation.lib.php';        $map = PMA_getForeigners($db, $table, '', 'both');        $rel_fields = array();        parse_str($_REQUEST['rel_fields_list'], $rel_fields);        // loop for each relation cell        foreach ( $rel_fields as $cell_index => $curr_cell_rel_field) {            foreach ( $curr_cell_rel_field as $rel_field => $rel_field_value) {                $where_comparison = "='" . $rel_field_value . "'";                $display_field = PMA_getDisplayField($map[$rel_field]['foreign_db'], $map[$rel_field]['foreign_table']);                // Field to display from the foreign table?                if (isset($display_field) && strlen($display_field)) {                    $dispsql     = 'SELECT ' . PMA_backquote($display_field)                        . ' FROM ' . PMA_backquote($map[$rel_field]['foreign_db'])                        . '.' . PMA_backquote($map[$rel_field]['foreign_table'])                        . ' WHERE ' . PMA_backquote($map[$rel_field]['foreign_field'])                        . $where_comparison;                    $dispresult  = PMA_DBI_try_query($dispsql, null, PMA_DBI_QUERY_STORE);                    if ($dispresult && PMA_DBI_num_rows($dispresult) > 0) {                        list($dispval) = PMA_DBI_fetch_row($dispresult, 0);                    } else {                        //$dispval = __('Link not found');                    }                    @PMA_DBI_free_result($dispresult);                } else {                    $dispval     = '';                } // end if... else...                if ('K' == $_SESSION['tmp_user_values']['relational_display']) {                    // user chose "relational key" in the display options, so                    // the title contains the display field                    $title = (! empty($dispval))? ' title="' . htmlspecialchars($dispval) . '"' : '';                } else {                    $title = ' title="' . htmlspecialchars($rel_field_value) . '"';                }                $_url_params = array(                    'db'    => $map[$rel_field]['foreign_db'],                    'table' => $map[$rel_field]['foreign_table'],                    'pos'   => '0',                    'sql_query' => 'SELECT * FROM '                                        . PMA_backquote($map[$rel_field]['foreign_db']) . '.' . PMA_backquote($map[$rel_field]['foreign_table'])                                        . ' WHERE ' . PMA_backquote($map[$rel_field]['foreign_field'])                                        . $where_comparison                );                $output = '<a href="sql.php' . PMA_generate_common_url($_url_params) . '"' . $title . '>';                if ('D' == $_SESSION['tmp_user_values']['relational_display']) {                    // user chose "relational display field" in the                    // display options, so show display field in the cell                    $output .= (!empty($dispval)) ? htmlspecialchars($dispval) : '';                } else {                    // otherwise display data in the cell                    $output .= htmlspecialchars($rel_field_value);                }                $output .= '</a>';                $extra_data['relations'][$cell_index] = $output;            }        }   // end of loop for each relation cell    }    if (isset($_REQUEST['do_transformations']) && $_REQUEST['do_transformations'] == true ) {        include_once './libraries/transformations.lib.php';        //if some posted fields need to be transformed, generate them here.        $mime_map = PMA_getMIME($db, $table);        if ($mime_map === false) {            $mime_map = array();        }        $edited_values = array();        parse_str($_REQUEST['transform_fields_list'], $edited_values);        foreach ($mime_map as $transformation) {            $include_file = PMA_securePath($transformation['transformation']);            $column_name = $transformation['column_name'];            foreach ($edited_values as $cell_index => $curr_cell_edited_values) {                if (isset($curr_cell_edited_values[$column_name])) {                    $column_data = $curr_cell_edited_values[$column_name];                    $_url_params = array(                        'db'            => $db,                        'table'         => $table,                        'where_clause'  => $_REQUEST['where_clause'],                        'transform_key' => $column_name,                    );                    if (file_exists('./libraries/transformations/' . $include_file)) {                        $transformfunction_name = str_replace('.inc.php', '', $transformation['transformation']);                        include_once './libraries/transformations/' . $include_file;                        if (function_exists('PMA_transformation_' . $transformfunction_name)) {                            $transform_function = 'PMA_transformation_' . $transformfunction_name;                            $transform_options  = PMA_transformation_getOptions((isset($transformation['transformation_options']) ? $transformation['transformation_options'] : ''));                            $transform_options['wrapper_link'] = PMA_generate_common_url($_url_params);                        }                    }                    $extra_data['transformations'][$cell_index] = $transform_function($column_data, $transform_options);                }            }   // end of loop for each transformation cell        }   // end of loop for each $mime_map    }    /**Get the total row count of the table*/    $extra_data['row_count'] = PMA_Table::countRecords($_REQUEST['db'], $_REQUEST['table']);    $extra_data['sql_query'] = PMA_showMessage($message, $GLOBALS['display_query']);    PMA_ajaxResponse($message, $message->isSuccess(), $extra_data);}if (isset($return_to_sql_query)) {    $disp_query = $GLOBALS['sql_query'];    $disp_message = $message;    unset($message);    $GLOBALS['sql_query'] = $return_to_sql_query;}$GLOBALS['js_include'][] = 'tbl_change.js';// in case we call sql.php which needs those:$GLOBALS['js_include'][] = 'jquery/jquery-ui-1.8.16.custom.js';$active_page = $goto_include;/** * If user asked for "and then Insert another new row" we have to remove * WHERE clause information so that tbl_change.php does not go back * to the current record */if (isset($_REQUEST['after_insert']) && 'new_insert' == $_REQUEST['after_insert']) {        unset($_REQUEST['where_clause']);}/** * Load header. */require_once './libraries/header.inc.php';/** * Load target page. */require './' . PMA_securePath($goto_include);exit;?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * Gets some core libraries */require_once './libraries/common.inc.php';// Check parametersPMA_checkParameters(array('db', 'table'));/** * Defines the url to return to in case of error in a sql statement */$err_url = 'tbl_sql.php?' . PMA_generate_common_url($db, $table);/** * Selects the database to work with */PMA_DBI_select_db($db);$goto = $cfg['DefaultTabTable'];/** * $_REQUEST['target_db'] could be empty in case we came from an input field * (when there are many databases, no drop-down) */if (empty($_REQUEST['target_db'])) {    $_REQUEST['target_db'] = $db;}/** * A target table name has been sent to this script -> do the work */if (PMA_isValid($_REQUEST['new_name'])) {    if ($db == $_REQUEST['target_db'] && $table == $_REQUEST['new_name']) {        if (isset($_REQUEST['submit_move'])) {            $message = PMA_Message::error(__('Can\'t move table to same one!'));        } else {            $message = PMA_Message::error(__('Can\'t copy table to same one!'));        }        $result = false;    } else {        $result = PMA_Table::moveCopy($db, $table, $_REQUEST['target_db'], $_REQUEST['new_name'],            $_REQUEST['what'], isset($_REQUEST['submit_move']), 'one_table');        if (isset($_REQUEST['submit_move'])) {            $message = PMA_Message::success(__('Table %s has been moved to %s.'));        } else {            $message = PMA_Message::success(__('Table %s has been copied to %s.'));        }        $old = PMA_backquote($db) . '.' . PMA_backquote($table);        $message->addParam($old);        $new = PMA_backquote($_REQUEST['target_db']) . '.' . PMA_backquote($_REQUEST['new_name']);        $message->addParam($new);        /* Check: Work on new table or on old table? */        if (isset($_REQUEST['submit_move']) || PMA_isValid($_REQUEST['switch_to_new'])) {            $db        = $_REQUEST['target_db'];            $table     = $_REQUEST['new_name'];        }        if ( $_REQUEST['ajax_request'] == true) {            $extra_data['sql_query'] = PMA_showMessage(null, $sql_query);            $extra_data['db'] = $GLOBALS['db'];            PMA_ajaxResponse($message, $message->isSuccess(), $extra_data);        }        $reload = 1;    }} else {    /**     * No new name for the table!     */    $message = PMA_Message::error(__('The table name is empty!'));    $result = false;}/** * Back to the calling script */$_message = $message;unset($message);?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin *//** * */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'export.js';/** * Gets tables informations and displays top links */require_once './libraries/tbl_common.php';$url_query .= '&amp;goto=tbl_export.php&amp;back=tbl_export.php';require_once './libraries/tbl_info.inc.php';// Dump of a table$export_page_title = __('View dump (schema) of table');// When we have some query, we need to remove LIMIT from that and possibly// generate WHERE clause (if we are asked to export specific rows)if (! empty($sql_query)) {    // Parse query so we can work with tokens    $parsed_sql = PMA_SQP_parse($sql_query);    $analyzed_sql = PMA_SQP_analyze($parsed_sql);    // Need to generate WHERE clause?    if (isset($where_clause)) {        // Yes => rebuild query from scratch; this doesn't work with nested        // selects :-(        $sql_query = 'SELECT ';        if (isset($analyzed_sql[0]['queryflags']['distinct'])) {            $sql_query .= ' DISTINCT ';        }        $sql_query .= $analyzed_sql[0]['select_expr_clause'];        if (!empty($analyzed_sql[0]['from_clause'])) {            $sql_query .= ' FROM ' . $analyzed_sql[0]['from_clause'];        }        $wheres = array();        if (isset($where_clause) && is_array($where_clause)         && count($where_clause) > 0) {            $wheres[] = '(' . implode(') OR (', $where_clause) . ')';        }        if (!empty($analyzed_sql[0]['where_clause'])) {            $wheres[] = $analyzed_sql[0]['where_clause'];        }        if (count($wheres) > 0) {            $sql_query .= ' WHERE (' . implode(') AND (', $wheres) . ')';        }        if (!empty($analyzed_sql[0]['group_by_clause'])) {            $sql_query .= ' GROUP BY ' . $analyzed_sql[0]['group_by_clause'];        }        if (!empty($analyzed_sql[0]['having_clause'])) {            $sql_query .= ' HAVING ' . $analyzed_sql[0]['having_clause'];        }        if (!empty($analyzed_sql[0]['order_by_clause'])) {            $sql_query .= ' ORDER BY ' . $analyzed_sql[0]['order_by_clause'];        }    } else {        // Just crop LIMIT clause        $sql_query = $analyzed_sql[0]['section_before_limit'] . $analyzed_sql[0]['section_after_limit'];    }    $message = PMA_Message::success();}/** * Displays top menu links */require './libraries/tbl_links.inc.php';$export_type = 'table';require_once './libraries/display_export.lib.php';/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin */if (! defined('PHPMYADMIN')) {    exit;}// Get relations & co. status$cfgRelation = PMA_getRelationsParam();require_once './libraries/file_listing.php';require_once './libraries/plugin_interface.lib.php';function PMA_exportCheckboxCheck($str){    if (isset($GLOBALS['cfg']['Export'][$str]) && $GLOBALS['cfg']['Export'][$str]) {        echo ' checked="checked"';    }}function PMA_exportIsActive($what, $val){    if (isset($GLOBALS['cfg']['Export'][$what]) &&  $GLOBALS['cfg']['Export'][$what] == $val) {        echo ' checked="checked"';    }}/* Scan for plugins */$export_list = PMA_getPlugins('./libraries/export/', array('export_type' => $export_type, 'single_table' => isset($single_table)));/* Fail if we didn't find any plugin */if (empty($export_list)) {    PMA_Message::error( __('Could not load export plugins, please check your installation!'))->display();    include './libraries/footer.inc.php';}?><form method="post" action="export.php" name="dump"><?phpif ($export_type == 'server') {    echo PMA_generate_common_hidden_inputs('', '', 1);} elseif ($export_type == 'database') {    echo PMA_generate_common_hidden_inputs($db, '', 1);} else {    echo PMA_generate_common_hidden_inputs($db, $table, 1);}// just to keep this value for possible next display of this form after saving on serverif (isset($single_table)) {    echo '<input type="hidden" name="single_table" value="TRUE" />' . "\n";}echo '<input type="hidden" name="export_type" value="' . $export_type . '" />' . "\n";// If the export method was not set, the default is quickif (isset($_GET['export_method'])) {    $cfg['Export']['method'] = $_GET['export_method'];} elseif (! isset($cfg['Export']['method'])) {    $cfg['Export']['method'] = 'quick';}// The export method (quick, custom or custom-no-form)echo '<input type="hidden" name="export_method" value="' . htmlspecialchars($cfg['Export']['method']) . '" />';if (isset($_GET['sql_query'])) {    echo '<input type="hidden" name="sql_query" value="' . htmlspecialchars($_GET['sql_query']) . '" />' . "\n";} elseif (! empty($sql_query)) {    echo '<input type="hidden" name="sql_query" value="' . htmlspecialchars($sql_query) . '" />' . "\n";}?><div class="exportoptions" id="header">    <h2>        <?php echo PMA_getImage('b_export.png', __('Export')); ?>        <?php        if ($export_type == 'server') {            echo __('Exporting databases from the current server');        } elseif ($export_type == 'database') {            printf(__('Exporting tables from "%s" database'), htmlspecialchars($db));        } else {            printf(__('Exporting rows from "%s" table'), htmlspecialchars($table));        }?>    </h2></div><div class="exportoptions" id="quick_or_custom">    <h3><?php echo __('Export Method:'); ?></h3>    <ul>        <li>            <?php echo '<input type="radio" name="quick_or_custom" value="quick" id="radio_quick_export"';            if (isset($_GET['quick_or_custom'])) {                $export_method = $_GET['quick_or_custom'];                if ($export_method == 'custom' || $export_method == 'custom_no_form') {                    echo ' />';                } else {                    echo ' checked="checked" />';                }            } elseif ($cfg['Export']['method'] == 'custom' || $cfg['Export']['method'] == 'custom-no-form') {                echo ' />';            } else {                echo ' checked="checked" />';            }            echo '<label for ="radio_quick_export">' . __('Quick - display only the minimal options') . '</label>'; ?>        </li>        <li>            <?php echo '<input type="radio" name="quick_or_custom" value="custom" id="radio_custom_export"';            if (isset($_GET['quick_or_custom'])) {                $export_method = $_GET['quick_or_custom'];                if ($export_method == 'custom' || $export_method == 'custom_no_form') {                    echo ' checked="checked" />';                } else {                    echo ' />';                }            } elseif ($cfg['Export']['method'] == 'custom' || $cfg['Export']['method'] == 'custom-no-form') {                echo ' checked="checked" />';            } else {                echo ' />';            }            echo '<label for="radio_custom_export">' . __('Custom - display all possible options') . '</label>';?>        </li>    </ul></div><div class="exportoptions" id="databases_and_tables">    <?php        if ($export_type == 'server') {            echo '<h3>' . __('Database(s):') . '</h3>';        } else if ($export_type == 'database') {            echo '<h3>' . __('Table(s):') . '</h3>';        }        if (! empty($multi_values)) {            echo $multi_values;        }    ?></div><?php if (strlen($table) && ! isset($num_tables) && ! PMA_Table::isMerge($db, $table)) { ?>    <div class="exportoptions" id="rows">        <h3><?php echo __('Rows:'); ?></h3>        <ul>            <li>                <?php if (isset($_GET['allrows']) && $_GET['allrows'] == 1) {                        echo '<input type="radio" name="allrows" value="0" id="radio_allrows_0" />';                    } else {                        echo '<input type="radio" name="allrows" value="0" id="radio_allrows_0" checked="checked" />';                    }                    echo '<label for ="radio_allrows_0">' . __('Dump some row(s)') . '</label>'; ?>                <ul>                    <li><label for="limit_to"><?php echo __('Number of rows:') . '</label> <input type="text" id="limit_to" name="limit_to" size="5" value="'                . ((isset($_GET['limit_to'])) ? htmlspecialchars($_GET['limit_to']) : ((isset($unlim_num_rows) ? $unlim_num_rows : PMA_Table::countRecords($db, $table))))                . '" onfocus="this.select()" />' ?></li>                    <li><label for="limit_from"><?php echo __('Row to begin at:') . '</label> <input type="text" id="limit_from" name="limit_from" value="'                 . ((isset($_GET['limit_from'])) ? htmlspecialchars($_GET['limit_from']) : '0')                 . '" size="5" onfocus="this.select()" />'; ?></li>                </ul>            </li>            <li>                <?php if (isset($_GET['allrows']) && $_GET['allrows'] == 0) {                    echo '<input type="radio" name="allrows" value="1" id="radio_allrows_1" />';                } else {                    echo '<input type="radio" name="allrows" value="1" id="radio_allrows_1" checked="checked" />';                }                echo ' <label for="radio_allrows_1">' . __('Dump all rows') . '</label>';?>            </li>        </ul>     </div><?php } ?><?php if (isset($cfg['SaveDir']) && !empty($cfg['SaveDir'])) { ?>    <div class="exportoptions" id="output_quick_export">        <h3><?php echo __('Output:'); ?></h3>        <ul>            <li>                <input type="checkbox" name="quick_export_onserver" value="saveit"                    id="checkbox_quick_dump_onserver"                    <?php PMA_exportCheckboxCheck('quick_export_onserver'); ?> />                <label for="checkbox_quick_dump_onserver">                    <?php echo sprintf(__('Save on server in the directory <b>%s</b>'), htmlspecialchars(PMA_userDir($cfg['SaveDir']))); ?>                </label>            </li>            <li>                <input type="checkbox" name="quick_export_onserverover" value="saveitover"                id="checkbox_quick_dump_onserverover"                <?php PMA_exportCheckboxCheck('quick_export_onserver_overwrite'); ?> />                <label for="checkbox_quick_dump_onserverover"><?php echo __('Overwrite existing file(s)'); ?></label>            </li>        </ul>    </div><?php } ?><div class="exportoptions" id="output">    <h3><?php echo __('Output:'); ?></h3>    <ul id="ul_output">        <li>            <input type="radio" name="output_format" value="sendit" id="radio_dump_asfile" <?php isset($_GET['repopulate']) ? '' : PMA_exportCheckboxCheck('asfile'); ?> />            <label for="radio_dump_asfile"><?php echo __('Save output to a file'); ?></label>            <ul id="ul_save_asfile">                <?php if (isset($cfg['SaveDir']) && !empty($cfg['SaveDir'])) { ?>                <li>                    <input type="checkbox" name="onserver" value="saveit"                        id="checkbox_dump_onserver"                        <?php PMA_exportCheckboxCheck('onserver'); ?> />                    <label for="checkbox_dump_onserver">                        <?php echo sprintf(__('Save on server in the directory <b>%s</b>'), htmlspecialchars(PMA_userDir($cfg['SaveDir']))); ?>                    </label>                </li>                <li>                    <input type="checkbox" name="onserverover" value="saveitover"                    id="checkbox_dump_onserverover"                    <?php PMA_exportCheckboxCheck('onserver_overwrite'); ?> />                    <label for="checkbox_dump_onserverover"><?php echo __('Overwrite existing file(s)'); ?></label>                </li>                <?php } ?>                <li>                    <label for="filename_template" class="desc">                    <?php                    echo __('File name template:');                    $trans = new PMA_Message;                    $trans->addMessage(__('@SERVER@ will become the server name'));                    if ($export_type == 'database' || $export_type == 'table') {                        $trans->addMessage(__(', @DATABASE@ will become the database name'));                        if ($export_type == 'table') {                            $trans->addMessage(__(', @TABLE@ will become the table name'));                        }                    }                    $message = new PMA_Message(__('This value is interpreted using %1$sstrftime%2$s, so you can use time formatting strings. Additionally the following transformations will happen: %3$s. Other text will be kept as is. See the %4$sFAQ%5$s for details.'));                    $message->addParam('<a href="' . PMA_linkURL(PMA_getPHPDocLink('function.strftime.php')). '" target="documentation" title="'                        . __('Documentation') . '">', false);                    $message->addParam('</a>', false);                    $message->addParam($trans);                    $message->addParam('<a href="Documentation.html#faq6_27" target="documentation">', false);                    $message->addParam('</a>', false);                    echo PMA_showHint($message);                    ?>                    </label>                    <input type="text" name="filename_template" id="filename_template"                    <?php                        echo ' value="';                        if (isset($_GET['filename_template'])) {                            echo htmlspecialchars($_GET['filename_template']);                        } else {                            if ($export_type == 'database') {                                echo htmlspecialchars($GLOBALS['PMA_Config']->getUserValue(                                    'pma_db_filename_template',                                    $GLOBALS['cfg']['Export']['file_template_database']));                            } elseif ($export_type == 'table') {                                echo htmlspecialchars($GLOBALS['PMA_Config']->getUserValue(                                    'pma_table_filename_template',                                    $GLOBALS['cfg']['Export']['file_template_table']));                            } else {                                echo htmlspecialchars($GLOBALS['PMA_Config']->getUserValue(                                    'pma_server_filename_template',                                    $GLOBALS['cfg']['Export']['file_template_server']));                            }                    }                        echo '"';                    ?>                    />                    <input type="checkbox" name="remember_template"                        id="checkbox_remember_template"                        <?php PMA_exportCheckboxCheck('remember_file_template'); ?> />                    <label for="checkbox_remember_template">                        <?php echo __('use this for future exports'); ?></label>                </li>                <?php                // charset of file                if ($GLOBALS['PMA_recoding_engine'] != PMA_CHARSET_NONE) {                    echo '        <li><label for="select_charset_of_file" class="desc">'                        . __('Character set of the file:') . '</label>' . "\n";                    reset($cfg['AvailableCharsets']);                    echo '<select id="select_charset_of_file" name="charset_of_file" size="1">';                    foreach ($cfg['AvailableCharsets'] as $temp_charset) {                        echo '<option value="' . $temp_charset . '"';                        if (isset($_GET['charset_of_file']) && ($_GET['charset_of_file'] != $temp_charset)) {                            echo '';                        } elseif ((empty($cfg['Export']['charset']) && $temp_charset == 'utf-8')                          || $temp_charset == $cfg['Export']['charset']) {                            echo ' selected="selected"';                        }                        echo '>' . $temp_charset . '</option>';                    } // end foreach                    echo '</select></li>';                } // end if                ?>                 <?php                if (isset($_GET['compression'])) {                    $selected_compression = $_GET['compression'];                } elseif (isset($cfg['Export']['compression'])) {                    $selected_compression = $cfg['Export']['compression'];                } else {                    $selected_compression = "none";                }                // zip, gzip and bzip2 encode features                $is_zip  = ($cfg['ZipDump']  && @function_exists('gzcompress'));                $is_gzip = ($cfg['GZipDump'] && @function_exists('gzencode'));                $is_bzip2 = ($cfg['BZipDump'] && @function_exists('bzcompress'));                if ($is_zip || $is_gzip || $is_bzip2) { ?>                    <li>                    <label for="compression" class="desc"><?php echo __('Compression:'); ?></label>                    <select id="compression" name="compression">                        <option value="none"><?php echo __('None'); ?></option>                        <?php if ($is_zip) { ?>                            <option value="zip" <?php echo ($selected_compression == "zip") ? 'selected="selected"' : ''; ?>><?php echo __('zipped'); ?></option>                        <?php } if ($is_gzip) { ?>                            <option value="gzip" <?php echo ($selected_compression == "gzip") ? 'selected="selected"' : ''; ?>><?php echo __('gzipped'); ?></option>                        <?php } if ($is_bzip2) { ?>                            <option value="bzip2" <?php echo ($selected_compression == "bzip2") ? 'selected="selected"' : ''; ?>><?php echo __('bzipped'); ?></option>                        <?php } ?>                    </select>                    </li>                <?php } else { ?>                    <input type="hidden" name="compression" value="<?php echo $selected_compression; ?>" />                <?php } ?>             </ul>        </li>        <li><input type="radio" id="radio_view_as_text" name="output_format" value="astext" <?php echo (isset($_GET['repopulate']) || $GLOBALS['cfg']['Export']['asfile'] == false) ? 'checked="checked"' : '' ?>/><label for="radio_view_as_text"><?php echo __('View output as text'); ?></label></li>    </ul> </div><div class="exportoptions" id="format">    <h3><?php echo __('Format:'); ?></h3>    <?php echo PMA_pluginGetChoice('Export', 'what', $export_list, 'format'); ?></div><div class="exportoptions" id="format_specific_opts">    <h3><?php echo __('Format-specific options:'); ?></h3>    <p class="no_js_msg" id="scroll_to_options_msg"><?php echo __('Scroll down to fill in the options for the selected format and ignore the options for other formats.'); ?></p>    <?php echo PMA_pluginGetOptions('Export', $export_list); ?></div><?php if (function_exists('PMA_set_enc_form')) { ?><!-- Encoding setting form appended by Y.Kawada --><!-- Japanese encoding setting -->    <div class="exportoptions" id="kanji_encoding">        <h3><?php echo __('Encoding Conversion:'); ?></h3>        <?php echo PMA_set_enc_form('            '); ?>    </div><?php } ?><div class="exportoptions" id="submit"><?php PMA_externalBug(__('SQL compatibility mode'), 'mysql', '50027', '14515'); ?>    <input type="submit" value="<?php echo __('Go'); ?>" id="buttonGo" /></div></form>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * the navigation frame - displays server, db and table selection tree * * @package PhpMyAdmin *//** * Gets a core script and starts output buffering work */require_once './libraries/common.inc.php';/** * finish and cleanup navigation.php script execution, only to be used in navigation.php * * @access private */function PMA_exitNavigationFrame(){    echo '</body></html>';    exit;}require_once './libraries/common.lib.php';require_once './libraries/RecentTable.class.php';/** * Check if it is an ajax request to reload the recent tables list. */if ($GLOBALS['is_ajax_request'] && $_REQUEST['recent_table']) {    PMA_ajaxResponse('', true, array('options' => PMA_RecentTable::getInstance()->getHtmlSelectOption()) );}// keep the offset of the db list in session before closing itif (! isset($_SESSION['tmp_user_values']['navi_limit_offset'])) {    $_SESSION['tmp_user_values']['navi_limit_offset'] = 0;}if (! isset($_SESSION['tmp_user_values']['table_limit_offset']) || $_SESSION['tmp_user_values']['table_limit_offset_db'] != $db) {    $_SESSION['tmp_user_values']['table_limit_offset'] = 0;    $_SESSION['tmp_user_values']['table_limit_offset_db'] = $db;}if (isset($_REQUEST['pos'])) {    if (isset($_REQUEST['tpos'])) {        $_SESSION['tmp_user_values']['table_limit_offset'] = (int) $_REQUEST['pos'];    } else {        $_SESSION['tmp_user_values']['navi_limit_offset'] = (int) $_REQUEST['pos'];    }}$pos = $_SESSION['tmp_user_values']['navi_limit_offset'];$tpos = $_SESSION['tmp_user_values']['table_limit_offset'];// free the session file, for the other frames to be loaded// but only if debugging is not enabledif (empty($_SESSION['debug'])) {    session_write_close();}/** * the output compression library */require_once './libraries/ob.lib.php';PMA_outBufferPre();/* * selects the database if there is only one on current server */if ($GLOBALS['server'] && ! strlen($GLOBALS['db'])) {    $GLOBALS['db'] = $GLOBALS['pma']->databases->getSingleItem();}$db_start = $GLOBALS['db'];/** * the relation settings */$cfgRelation = PMA_getRelationsParam();/** * For re-usability, moved http-headers to a seperate file. * It can now be included by libraries/header.inc.php, querywindow.php. */require_once './libraries/header_http.inc.php';/* * Displays the frame */// xml declaration moves IE into quirks mode, making much trouble with CSS/* echo '<?xml version="1.0" encoding="utf-8"?>'; */?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"    xml:lang="<?php echo $available_languages[$lang][1]; ?>"    lang="<?php echo $available_languages[$lang][1]; ?>"    dir="<?php echo $GLOBALS['text_dir']; ?>"><head>    <link rel="icon" href="./favicon.ico" type="image/x-icon" />    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />    <title>phpMyAdmin</title>    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    <base target="frame_content" />    <link rel="stylesheet" type="text/css"        href="phpmyadmin.css.php?<?php echo PMA_generate_common_url('', ''); ?>&amp;js_frame=left&amp;nocache=<?php echo $GLOBALS['PMA_Config']->getThemeUniqueValue(); ?>" />    <?php    echo PMA_includeJS('jquery/jquery-1.6.2.js');    echo PMA_includeJS('jquery/jquery-ui-1.8.16.custom.js');    echo PMA_includeJS('jquery/jquery.qtip-1.0.0-rc3.js');    echo PMA_includeJS('navigation.js');    echo PMA_includeJS('functions.js');    echo PMA_includeJS('messages.php');    // Append the theme id to this url to invalidate the cache on a theme change    echo PMA_includeJS('get_image.js.php?theme=' . urlencode($_SESSION['PMA_Theme']->getId()));    ?>    <script type="text/javascript">    // <![CDATA[    // INIT PMA_setFrameSize    var onloadCnt = 0;    var onLoadHandler = window.onload;    var resizeHandler = window.onresize;    window.document.onresize  = resizeHandler;    window.onload = function() {        if (onloadCnt == 0) {            if (typeof(onLoadHandler) == "function") {                onLoadHandler();            }            if (typeof(PMA_setFrameSize) != 'undefined' && typeof(PMA_setFrameSize) == 'function') {                PMA_setFrameSize();            }            onloadCnt++;        }    };    window.onresize = function() {        if (typeof(resizeHandler) == "function") {            resizeHandler();        }        if (typeof(PMA_saveFrameSize) != 'undefined' && typeof(PMA_saveFrameSize) == 'function') {            PMA_saveFrameSize();        }    };    // ]]>    </script>    <?php    /*     * remove horizontal scroll bar bug in IE 6 by forcing a vertical scroll bar     */    ?>    <!--[if IE 6]>    <style type="text/css">    /* <![CDATA[ */    html {        overflow-y: scroll;    }    /* ]]> */    </style>    <![endif]--></head><body id="body_leftFrame"><?phprequire './libraries/navigation_header.inc.php';// display recently used tablesif ($GLOBALS['cfg']['LeftRecentTable'] > 0) {    echo '<div id="recentTableList">' . "\n"        .'<form method="post" action="index.php" target="_parent">' . "\n"        .PMA_generate_common_hidden_inputs() . "\n"        .PMA_RecentTable::getInstance()->getHtmlSelect()        .'<noscript>' . "\n"        .'<input type="submit" name="Go" value="' . __('Go') . '" />' . "\n"        .'</noscript>' . "\n"        .'</form>' . "\n"        .'</div>' . "\n";}if (! $GLOBALS['server']) {    // no server selected    PMA_exitNavigationFrame();} elseif (! count($GLOBALS['pma']->databases)) {    // no database available, so we break here    echo '<p>' . __('No databases') . '</p>';    PMA_exitNavigationFrame();} elseif ($GLOBALS['cfg']['LeftFrameLight'] && count($GLOBALS['pma']->databases) > 1) {    $list = $cfg['DisplayDatabasesList'];    if ($list === 'auto') {        if (empty($GLOBALS['db'])) {            $list = true;        } else {            $list = false;        }    }    if (!$list) {        // more than one database available and LeftFrameLight is true        // display db selectbox        //        // Light mode -> beginning of the select combo for databases        // Note: When javascript is active, the frameset will be changed from        // within navigation.php. With no JS (<noscript>) the whole frameset will        // be rebuilt with the new target frame.    ?>    <div id="databaseList">    <form method="post" action="index.php" target="_parent" id="left">    <?php        echo PMA_generate_common_hidden_inputs() . "\n";        echo $GLOBALS['pma']->databases->getHtmlSelectGrouped(true, $_SESSION['tmp_user_values']['navi_limit_offset'], $GLOBALS['cfg']['MaxDbList']) . "\n";        echo '<noscript>' . "\n"            .'<input type="submit" name="Go" value="' . __('Go') . '" />' . "\n"            .'</noscript>' . "\n"            .'</form>' . "\n"            . '</div>' . "\n";    } else {        echo $GLOBALS['pma']->databases->getHtmlListGrouped(true, $_SESSION['tmp_user_values']['navi_limit_offset'], $GLOBALS['cfg']['MaxDbList']) . "\n";    }    $_url_params = array('pos' => $pos);    PMA_listNavigator(count($GLOBALS['pma']->databases), $pos, $_url_params, 'navigation.php', 'frame_navigation', $GLOBALS['cfg']['MaxDbList']);}?><div id="left_tableList"><?php// Don't display expansible/collapsible database info if:// 1. $GLOBALS['server'] == 0 (no server selected)//    This is the case when there are multiple servers and//    '$GLOBALS['cfg']['ServerDefault'] = 0' is set. In that case, we want the welcome//    screen to appear with no database info displayed.// 2. there is only one database available (ie either only one database exists//    or $GLOBALS['cfg']['Servers']['only_db'] is defined and is not an array)//    In this case, the database should not be collapsible/expandable$img_plus = PMA_getImage('b_plus.png', '+', array('id' => 'el%dImg'));$img_minus = PMA_getImage('b_minus.png', '-', array('id' => 'el%dImg'));$href_left = '<a onclick="if (toggle(\'%d\')) return false;"'    .' href="navigation.php?%s" target="_self">';$element_counter = 0;if ($GLOBALS['cfg']['LeftFrameLight'] && strlen($GLOBALS['db'])) {    $table_list = PMA_getTableList($GLOBALS['db'], null, $tpos, $cfg['MaxTableList']);    $table_count = PMA_getTableCount($GLOBALS['db']);    // show selected databasename as link to DefaultTabDatabase-page    // with table count in ()    $common_url_query = PMA_generate_common_url($GLOBALS['db']);    $db_tooltip = '';    if ($GLOBALS['cfg']['ShowTooltip']      && $GLOBALS['cfgRelation']['commwork']) {        $_db_tooltip = PMA_getDbComment($GLOBALS['db']);        if ($_db_tooltip) {            $db_tooltip = $_db_tooltip;        }    }    $disp_name  = $GLOBALS['db'];    if ($db_tooltip && $GLOBALS['cfg']['ShowTooltipAliasDB']) {        $disp_name      = $db_tooltip;        $disp_name_cut  = $db_tooltip;        $db_tooltip     = $GLOBALS['db'];    }    if ($table_count >= $GLOBALS['cfg']['LeftDisplayTableFilterMinimum']) {        ?>        <span id="NavFilter">        <span id="clear_fast_filter" title="<?php echo __('Clear'); ?>">X</span>            <input type="text" class="gray" name="fast_filter" id="fast_filter" title="<?php echo __('Filter tables by name'); ?>" value="<?php echo __('Filter tables by name'); ?>" />        </span>        <?php    }    /**     * This helps reducing the navi panel size; in the right panel,     * user can find a navigator to page thru all tables.     *     */    if (! empty($table_list)) {        // upper table list paginator        if (count($table_list) <= $GLOBALS['cfg']['MaxTableList'] && $table_count > $GLOBALS['cfg']['MaxTableList']) {            $_url_params = array(              'tpos' => 'true',              'pos' => $tpos,              'db' => $GLOBALS['db']            );            PMA_listNavigator($table_count, $tpos, $_url_params, 'navigation.php', 'frame_navigation', $GLOBALS['cfg']['MaxTableList']);        }        PMA_displayTableList($table_list, true, '', $GLOBALS['db']);        // lower table list paginator        if (count($table_list) <= $GLOBALS['cfg']['MaxTableList'] && $table_count > $GLOBALS['cfg']['MaxTableList']) {            PMA_listNavigator($table_count, $tpos, $_url_params, 'navigation.php', 'frame_navigation', $GLOBALS['cfg']['MaxTableList']);        }    } else {        echo __('No tables found in database.');    }    unset($table_list);    if (!PMA_is_system_schema($db)) {        $class = '';        $GLOBALS['cfg']['AjaxEnable'] ? $class="ajax" : '';        echo '<ul id="newtable"><li><a target="frame_content" href="tbl_create.php' . PMA_generate_common_url(array('db' => $GLOBALS['db'])) . '"  class="'.$class .'" >'            . PMA_getImage('b_snewtbl.png', _pgettext('short form', 'Create table'), array('id' => "icon_newtable"))            . _pgettext('short form', 'Create table') . '</a></li></ul>';    }} elseif ($GLOBALS['cfg']['LeftFrameLight']) {    /* No need to tell user to select database if we're showing complete list */    if (!$list) {        echo '<p>' . __('Please select a database') . '</p>';    }} else {    echo '<div id="databaseList">' . "\n";    $_url_params = array('pos' => $pos);    PMA_listNavigator(count($GLOBALS['pma']->databases), $pos, $_url_params, 'navigation.php', 'frame_navigation', $GLOBALS['cfg']['MaxDbList']);    echo '</div>' . "\n";    $common_url_query = PMA_generate_common_url();    PMA_displayDbList($GLOBALS['pma']->databases->getGroupedDetails($_SESSION['tmp_user_values']['navi_limit_offset'], $GLOBALS['cfg']['MaxDbList']), $_SESSION['tmp_user_values']['navi_limit_offset'], $GLOBALS['cfg']['MaxDbList']);}/** * displays collapsable db list * * @global  integer $element_counter * @global  string $img_minus * @global  string $img_plus * @global  string $href_left * @global  string $db_start * @global  string $common_url_query * @param array   $ext_dblist extended db list * @param integer $offset * @param integer $count */function PMA_displayDbList($ext_dblist, $offset, $count){    global $element_counter, $img_minus, $img_plus, $href_left,        $db_start, $common_url_query;    // get table list, for all databases    // doing this in one step takes advantage of a single query with information_schema!    $tables_full = PMA_DBI_get_tables_full($GLOBALS['pma']->databases->getLimitedItems($offset, $count));    $url_dbgroup = '';    echo '<ul id="leftdatabaselist">';    $close_db_group = false;    foreach ($ext_dblist as $group => $db_group) {        if (count($GLOBALS['pma']->databases) > 1) {            if ($close_db_group) {                $url_dbgroup = '';                echo '</ul>';                echo '</li>';                $close_db_group = false;            }            if (count($db_group) > 1) {                $close_db_group = true;                $url_dbgroup = '&amp;dbgroup=' . urlencode($group);                $common_url_query = PMA_generate_common_url() . $url_dbgroup;                $element_counter++;                echo '<li class="dbgroup">';                if ((! empty($_REQUEST['dbgroup']) && $_REQUEST['dbgroup'] == $group)                  || $db_start == $group || strpos($db_start, $group) === 0) {                    // display + only if this db(group) is not preselected                    printf($href_left, $element_counter, PMA_generate_common_url());                    printf($img_minus, $element_counter);                } else {                    printf($href_left, $element_counter, $common_url_query);                    printf($img_plus, $element_counter);                }                echo '</a> ' . $group . "\n";                if ((! empty($_REQUEST['dbgroup']) && $_REQUEST['dbgroup'] == $group)                  || $db_start == $group || strpos($db_start, $group) === 0) {                    echo '<ul id="subel' . $element_counter . '">' . "\n";                } else {                    echo '<ul id="subel' . $element_counter . '"'                        .' style="display: none">' . "\n";                }            }        }        foreach ($db_group as $db) {            $common_url_query = PMA_generate_common_url($db['name']) . $url_dbgroup;            $element_counter++;            // Displays the database name            echo '<li>' . "\n";            if (count($GLOBALS['pma']->databases) > 1) {                // only with more than one db we need collapse ...                if ($db_start != $db['name'] || $db['num_tables'] < 1) {                    // display + only if this db is not preselected                    // or table count is 0                    printf($href_left, $element_counter, $common_url_query);                    printf($img_plus, $element_counter);                } else {                    printf($href_left, $element_counter,                        PMA_generate_common_url() . $url_dbgroup);                    printf($img_minus, $element_counter);                }                echo '</a>';                // ... and we need to refresh both frames on db selection                ?>                <a class="item"                    id="<?php echo htmlspecialchars($db['name']); ?>"                    href="index.php?<?php echo $common_url_query; ?>"                    target="_parent"                    title="<?php echo htmlspecialchars($db['comment']); ?>"                    onclick="                        if (! toggle('<?php echo $element_counter; ?>', true))                            window.parent.goTo('./navigation.php?<?php echo $common_url_query; ?>');                        window.parent.goTo('./<?php echo $GLOBALS['cfg']['DefaultTabDatabase']                            . '?' . $common_url_query; ?>', 'main');                        return false;">                    <?php                    // Might be unset if CountTables directive is false                    if (isset($db['num_tables'])) {                        if ($GLOBALS['text_dir'] === 'rtl') {                            echo ' <bdo dir="ltr">(' . $db['num_tables'] . ')</bdo> ';                        }                    }                    echo htmlspecialchars($db['disp_name']);                    if (isset($db['num_tables'])) {                        if ($GLOBALS['text_dir'] === 'ltr') {                            echo ' <bdo dir="ltr">(' . $db['num_tables'] . ')</bdo> ';                        }                    }                    ?>                </a>                <?php            } else {                // with only 1 db available we dont need to refresh navi frame                // on db selection, only phpmain                ?>                <a href="<?php echo $GLOBALS['cfg']['DefaultTabDatabase']                    . '?' . $common_url_query; ?>"                    id="<?php echo htmlspecialchars($db['name']); ?>"                    title="<?php echo htmlspecialchars($db['comment']); ?>">                    <?php                    if (isset($db['num_tables'])) {                        if ($GLOBALS['text_dir'] === 'rtl') {                            echo ' <bdo dir="ltr">(' . $db['num_tables'] . ')</bdo> ';                        }                    }                    echo htmlspecialchars($db['disp_name']);                    if (isset($db['num_tables'])) {                        if ($GLOBALS['text_dir'] === 'ltr') {                            echo ' <bdo dir="ltr">(' . $db['num_tables'] . ')</bdo> ';                        }                    }                    ?>                </a>                <?php            }            if (($GLOBALS['cfg']['Server']['CountTables'] === false) || $db['num_tables']) {                if (isset($tables_full[$db['name']])) {                    $tables = PMA_getTableList($db['name'], $tables_full[$db['name']]);                } elseif (isset($tables_full[strtolower($db['name'])])) {                    // on windows with lower_case_table_names = 1                    // MySQL returns                    // with SHOW DATABASES or information_schema.SCHEMATA: `Test`                    // but information_schema.TABLES gives `test`                    // bug #1436171                    // sf.net/tracker/?func=detail&aid=1436171&group_id=23067&atid=377408                    $tables = PMA_getTableList($db['name'], $tables_full[strtolower($db['name'])]);                } else {                    $tables = PMA_getTableList($db['name']);                }                $child_visible                    = (bool) (count($GLOBALS['pma']->databases) === 1 || $db_start == $db['name']);                PMA_displayTableList($tables, $child_visible, '', $db['name']);            } elseif ($GLOBALS['cfg']['LeftFrameLight']) {                // no tables and LeftFrameLight:                // display message no tables in selected db                echo '<p>' . __('Please select a database') . '</p>' . "\n";            }            echo '</li>' . "\n";        } // end foreach db    } // end foreach group    if ($close_db_group) {        $url_dbgroup = '';        echo '</ul>';        echo '</li>';        $close_db_group = false;    }    echo '</ul>' . "\n";}/** * display unordered list of tables * calls itself recursively if table in given list * is a list itself * * @global  integer the element counter * @global  string  html code for '-' image * @global  string  html code for '+' image * @global  string  html code for self link * @param array   $tables         array of tables/tablegroups * @param boolean $visible        whether the list is visible or not * @param string  $tab_group_full full tab group name * @param string  $table_db       db of this table */function PMA_displayTableList($tables, $visible = false,    $tab_group_full = '', $table_db = ''){    if (! is_array($tables) || count($tables) === 0) {        return;    }    global $element_counter, $img_minus, $img_plus, $href_left;    $sep = $GLOBALS['cfg']['LeftFrameTableSeparator'];    if ($visible) {        echo '<ul id="subel' . $element_counter . '">';    } else {        echo '<ul id="subel' . $element_counter . '" style="display: none">';    }    foreach ($tables as $group => $table) {        // only allow grouping if the group has more than 1 table        if (isset($table['is' . $sep . 'group']) && $table['tab' . $sep . 'count'] > 1) {            $common_url_query = $GLOBALS['common_url_query']                . '&amp;tbl_group=' . urlencode($tab_group_full . $group);            $element_counter++;            echo '<li>' . "\n";            if ($visible             && ((isset($_REQUEST['tbl_group'])               && (strpos($_REQUEST['tbl_group'], $group) === 0                || strpos($_REQUEST['tbl_group'], $sep . $group) !== false))              || strpos($GLOBALS['table'], $group) === 0)) {                printf($href_left, $element_counter,                    $GLOBALS['common_url_query'] . '&amp;tbl_group=' . $tab_group_full);                printf($img_minus, $element_counter);            } else {                printf($href_left, $element_counter, $common_url_query);                printf($img_plus, $element_counter);            }            echo '</a>';            ?>            <a href="index.php?<?php echo $common_url_query; ?>"                target="_parent"                onclick="                    if (! toggle('<?php echo $element_counter; ?>', true))                        window.parent.goTo('./navigation.php?<?php echo $common_url_query; ?>');                    window.parent.goTo('./<?php echo $GLOBALS['cfg']['DefaultTabDatabase']                        . '?' . $common_url_query; ?>', 'main');                    return false;">                <?php                if ($GLOBALS['text_dir'] === 'rtl') {                    echo ' <bdo dir="ltr">(' . $table['tab' . $sep . 'count'] . ')</bdo> ';                }                echo htmlspecialchars(substr($group, 0, strlen($group) - strlen($sep)));                if ($GLOBALS['text_dir'] === 'ltr') {                    echo ' <bdo dir="ltr">(' . $table['tab' . $sep . 'count'] . ')</bdo> ';                }                ?>            </a>            <?php            unset($table['is' . $sep . 'group']);            unset($table['tab' . $sep . 'group']);            unset($table['tab' . $sep . 'count']);            if ($visible &&              ((isset($_REQUEST['tbl_group'])                && (strpos($_REQUEST['tbl_group'], $group) === 0                || strpos($_REQUEST['tbl_group'], $sep . $group) !== false))              || strpos($GLOBALS['table'], $group) === 0)) {                PMA_displayTableList($table, true,                    $tab_group_full . $group, $table_db);            } else {                PMA_displayTableList($table, false, '', $table_db);            }            echo '</li>' . "\n";        } elseif (is_array($table)) {            // the table was not grouped because it is the only one with its prefix            while (isset($table['is' . $sep . 'group'])) {                // get the array with the actual table information                foreach ($table as $value) {                    if (is_array($value)) {                        $table = $value;                    }                }            }            $link_title = PMA_getTitleForTarget($GLOBALS['cfg']['LeftDefaultTabTable']);            // quick access icon next to each table name            echo '<li>' . "\n";            echo '<a class="tableicon" title="'                . htmlspecialchars($link_title)                . ': ' . htmlspecialchars($table['Comment'])                .' (' . PMA_formatNumber($table['Rows'], 0) . ' ' . __('Rows') . ')"'                .' id="quick_' . htmlspecialchars($table_db . '.' . $table['Name']) . '"'                .' href="' . $GLOBALS['cfg']['LeftDefaultTabTable'] . '?'                . $GLOBALS['common_url_query']                .'&amp;table=' . urlencode($table['Name'])                .'&amp;goto=' . $GLOBALS['cfg']['LeftDefaultTabTable']                . '" >';            $attr = array('id' => 'icon_' . htmlspecialchars($table_db . '.' . $table['Name']));            if (PMA_Table::isView($table_db, $table['Name'])) {                echo PMA_getImage('s_views.png', htmlspecialchars($link_title), $attr);            } else {                echo PMA_getImage('b_browse.png', htmlspecialchars($link_title), $attr);            }            echo '</a>';            // link for the table name itself            $href = $GLOBALS['cfg']['DefaultTabTable'] . '?'                .$GLOBALS['common_url_query'] . '&amp;table='                .urlencode($table['Name']) . '&amp;pos=0';            echo '<a href="' . $href            . '" title="' . htmlspecialchars(PMA_getTitleForTarget($GLOBALS['cfg']['DefaultTabTable']) . ': ' . $table['Comment']                .' (' . PMA_formatNumber($table['Rows'], 0) . ' ' . __('Rows')) . ')"'                .' id="' . htmlspecialchars($table_db . '.' . $table['Name']) . '">'                // preserve spaces in table name                . str_replace(' ', '&nbsp;', htmlspecialchars($table['disp_name'])) . '</a>';            echo '</li>' . "\n";        }    }    echo '</ul>';}echo '</div>' . "\n";PMA_exitNavigationFrame();?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * * @package PhpMyAdmin */if (! defined('PHPMYADMIN')) {    exit;}/** * */if (isset($_REQUEST['GLOBALS']) || isset($_FILES['GLOBALS'])) {    die(__("GLOBALS overwrite attempt"));}/** * Sends the beginning of the html page then returns to the calling script */// Defines the cell alignment values depending on text directionif ($GLOBALS['text_dir'] == 'ltr') {    $GLOBALS['cell_align_left']  = 'left';    $GLOBALS['cell_align_right'] = 'right';} else {    $GLOBALS['cell_align_left']  = 'right';    $GLOBALS['cell_align_right'] = 'left';}// removes the bug with the horizontal scrollbar in IE (it's allways shown, if need it or not)// xml declaration moves IE into quirks mode, making much trouble with CSS/* echo '<?xml version="1.0" encoding="utf-8"?>'; */?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php echo $GLOBALS['available_languages'][$GLOBALS['lang']][1]; ?>" lang="<?php echo $GLOBALS['available_languages'][$GLOBALS['lang']][1]; ?>" dir="<?php echo $GLOBALS['text_dir']; ?>"><head>    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    <link rel="icon" href="./favicon.ico" type="image/x-icon" />    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />    <title><?php    if (!empty($page_title)) {        echo htmlspecialchars($page_title);    } else {        echo 'phpMyAdmin';    }?></title>    <link rel="stylesheet" type="text/css" href="<?php echo defined('PMA_PATH_TO_BASEDIR') ? PMA_PATH_TO_BASEDIR : ''; ?>phpmyadmin.css.php<?php echo PMA_generate_common_url(array('server' => $GLOBALS['server'])); ?>&amp;js_frame=<?php echo isset($print_view) ? 'print' : 'right'; ?>&amp;nocache=<?php echo $GLOBALS['PMA_Config']->getThemeUniqueValue(); ?>" />    <link rel="stylesheet" type="text/css" href="<?php echo defined('PMA_PATH_TO_BASEDIR') ? PMA_PATH_TO_BASEDIR : ''; ?>print.css" media="print" />    <link rel="stylesheet" type="text/css" href="<?php echo $GLOBALS['pmaThemePath']; ?>/jquery/jquery-ui-1.8.16.custom.css" />    <meta name="robots" content="noindex,nofollow" />
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * Set of functions used to build OpenDocument Text dumps of tables * * @package PhpMyAdmin-Export * @subpackage ODT */if (! defined('PHPMYADMIN')) {    exit;}/** * */if (isset($plugin_list)) {    $hide_structure = false;    if ($plugin_param['export_type'] == 'table' && !$plugin_param['single_table']) {        $hide_structure = true;    }    $plugin_list['odt'] = array(        'text' => __('Open Document Text'),        'extension' => 'odt',        'mime_type' => 'application/vnd.oasis.opendocument.text',        'force_file' => true,        'options' => array(), /* Filled later */        'options_text' => __('Options'),        );    /* what to dump (structure/data/both) */    $plugin_list['odt']['options'][]        = array('type' => 'begin_group', 'text' => __('Dump table') , 'name' => 'general_opts');    $plugin_list['odt']['options'][]        = array('type' => 'radio', 'name' => 'structure_or_data', 'values' => array('structure' => __('structure'), 'data' => __('data'), 'structure_and_data' => __('structure and data')));    $plugin_list['odt']['options'][] = array('type' => 'end_group');    /* Structure options */    if (!$hide_structure) {        $plugin_list['odt']['options'][]            = array('type' => 'begin_group', 'name' => 'structure', 'text' => __('Object creation options'), 'force' => 'data');        if (!empty($GLOBALS['cfgRelation']['relation'])) {            $plugin_list['odt']['options'][]                = array('type' => 'bool', 'name' => 'relation', 'text' => __('Display foreign key relationships'));        }        $plugin_list['odt']['options'][]            = array('type' => 'bool', 'name' => 'comments', 'text' => __('Display comments'));        if (!empty($GLOBALS['cfgRelation']['mimework'])) {            $plugin_list['odt']['options'][]                = array('type' => 'bool', 'name' => 'mime', 'text' => __('Display MIME types'));        }        $plugin_list['odt']['options'][]            = array('type' => 'end_group');    }    /* Data */    $plugin_list['odt']['options'][]        = array('type' => 'begin_group', 'name' => 'data', 'text' => __('Data dump options'), 'force' => 'structure');    $plugin_list['odt']['options'][]        = array('type' => 'bool', 'name' => 'columns', 'text' => __('Put columns names in the first row'));    $plugin_list['odt']['options'][]        = array('type' => 'text', 'name' => 'null', 'text' => __('Replace NULL with:'));    $plugin_list['odt']['options'][]        = array('type' => 'end_group');} else {    $GLOBALS['odt_buffer'] = '';    include_once './libraries/opendocument.lib.php';    /**     * Outputs export footer     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportFooter()    {        $GLOBALS['odt_buffer'] .= '</office:text>'            . '</office:body>'            . '</office:document-content>';        if (! PMA_exportOutputHandler(PMA_createOpenDocument('application/vnd.oasis.opendocument.text', $GLOBALS['odt_buffer']))) {            return false;        }        return true;    }    /**     * Outputs export header     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportHeader()    {        $GLOBALS['odt_buffer'] .= '<?xml version="1.0" encoding="utf-8"?' . '>'            . '<office:document-content '. $GLOBALS['OpenDocumentNS'] . 'office:version="1.0">'            . '<office:body>'            . '<office:text>';        return true;    }    /**     * Outputs database header     *     * @param string $db Database name     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportDBHeader($db)    {        $GLOBALS['odt_buffer'] .= '<text:h text:outline-level="1" text:style-name="Heading_1" text:is-list-header="true">'            . __('Database') . ' ' . htmlspecialchars($db) . '</text:h>';        return true;    }    /**     * Outputs database footer     *     * @param string $db Database name     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportDBFooter($db)    {        return true;    }    /**     * Outputs CREATE DATABASE statement     *     * @param string $db Database name     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportDBCreate($db)    {        return true;    }    /**     * Outputs the content of a table in ODT format     *     * @param string $db        database name     * @param string $table     table name     * @param string $crlf      the end of line sequence     * @param string $error_url the url to go back in case of error     * @param string $sql_query SQL query for obtaining data     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportData($db, $table, $crlf, $error_url, $sql_query)    {        global $what;        // Gets the data from the database        $result      = PMA_DBI_query($sql_query, null, PMA_DBI_QUERY_UNBUFFERED);        $fields_cnt  = PMA_DBI_num_fields($result);        $fields_meta = PMA_DBI_get_fields_meta($result);        $field_flags = array();        for ($j = 0; $j < $fields_cnt; $j++) {            $field_flags[$j] = PMA_DBI_field_flags($result, $j);        }        $GLOBALS['odt_buffer'] .= '<text:h text:outline-level="2" text:style-name="Heading_2" text:is-list-header="true">'            . __('Dumping data for table') . ' ' . htmlspecialchars($table) . '</text:h>';        $GLOBALS['odt_buffer'] .= '<table:table table:name="' . htmlspecialchars($table) . '_structure">';        $GLOBALS['odt_buffer'] .= '<table:table-column table:number-columns-repeated="' . $fields_cnt . '"/>';        // If required, get fields name at the first line        if (isset($GLOBALS[$what . '_columns'])) {            $GLOBALS['odt_buffer'] .= '<table:table-row>';            for ($i = 0; $i < $fields_cnt; $i++) {                $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                    . '<text:p>' . htmlspecialchars(stripslashes(PMA_DBI_field_name($result, $i))) . '</text:p>'                    . '</table:table-cell>';            } // end for            $GLOBALS['odt_buffer'] .= '</table:table-row>';        } // end if        // Format the data        while ($row = PMA_DBI_fetch_row($result)) {            $GLOBALS['odt_buffer'] .= '<table:table-row>';            for ($j = 0; $j < $fields_cnt; $j++) {                if (!isset($row[$j]) || is_null($row[$j])) {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p>' . htmlspecialchars($GLOBALS[$what . '_null']) . '</text:p>'                        . '</table:table-cell>';                // ignore BLOB                } elseif (stristr($field_flags[$j], 'BINARY')                        && $fields_meta[$j]->blob) {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p></text:p>'                        . '</table:table-cell>';                } elseif ($fields_meta[$j]->numeric && $fields_meta[$j]->type != 'timestamp' && ! $fields_meta[$j]->blob) {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="float" office:value="' . $row[$j] . '" >'                        . '<text:p>' . htmlspecialchars($row[$j]) . '</text:p>'                        . '</table:table-cell>';                } else {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p>' . htmlspecialchars($row[$j]) . '</text:p>'                        . '</table:table-cell>';                }            } // end for            $GLOBALS['odt_buffer'] .= '</table:table-row>';        } // end while        PMA_DBI_free_result($result);        $GLOBALS['odt_buffer'] .= '</table:table>';        return true;    }    /**     * Outputs table's structure     *     * @param string $db          database name     * @param string $table       table name     * @param string $crlf        the end of line sequence     * @param string $error_url   the url to go back in case of error     * @param bool   $do_relation whether to include relation comments     * @param bool   $do_comments whether to include the pmadb-style column comments     *                            as comments in the structure; this is deprecated     *                            but the parameter is left here because export.php     *                            calls PMA_exportStructure() also for other export     *                            types which use this parameter     * @param bool   $do_mime     whether to include mime comments     * @param bool   $dates       whether to include creation/update/check dates     * @param string $export_mode 'create_table', 'triggers', 'create_view', 'stand_in'     * @param string $export_type 'server', 'database', 'table'     *     * @return bool Whether it succeeded     *     * @access public     */    function PMA_exportStructure($db, $table, $crlf, $error_url, $do_relation = false, $do_comments = false, $do_mime = false, $dates = false, $export_mode, $export_type)    {        global $cfgRelation;        /* Heading */        $GLOBALS['odt_buffer'] .= '<text:h text:outline-level="2" text:style-name="Heading_2" text:is-list-header="true">'            . __('Table structure for table') . ' ' . htmlspecialchars($table) . '</text:h>';        /**         * Get the unique keys in the table         */        $unique_keys = array();        $keys        = PMA_DBI_get_table_indexes($db, $table);        foreach ($keys as $key) {            if ($key['Non_unique'] == 0) {                $unique_keys[] = $key['Column_name'];            }        }        /**         * Gets fields properties         */        PMA_DBI_select_db($db);        // Check if we can use Relations        if ($do_relation && !empty($cfgRelation['relation'])) {            // Find which tables are related with the current one and write it in            // an array            $res_rel = PMA_getForeigners($db, $table);            if ($res_rel && count($res_rel) > 0) {                $have_rel = true;            } else {                $have_rel = false;            }        } else {               $have_rel = false;        } // end if        /**         * Displays the table structure         */        $GLOBALS['odt_buffer'] .= '<table:table table:name="' . htmlspecialchars($table) . '_data">';        $columns_cnt = 4;        if ($do_relation && $have_rel) {            $columns_cnt++;        }        if ($do_comments) {            $columns_cnt++;        }        if ($do_mime && $cfgRelation['mimework']) {            $columns_cnt++;        }        $GLOBALS['odt_buffer'] .= '<table:table-column table:number-columns-repeated="' . $columns_cnt . '"/>';        /* Header */        $GLOBALS['odt_buffer'] .= '<table:table-row>';        $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'            . '<text:p>' . __('Column') . '</text:p>'            . '</table:table-cell>';        $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'            . '<text:p>' . __('Type') . '</text:p>'            . '</table:table-cell>';        $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'            . '<text:p>' . __('Null') . '</text:p>'            . '</table:table-cell>';        $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'            . '<text:p>' . __('Default') . '</text:p>'            . '</table:table-cell>';        if ($do_relation && $have_rel) {            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . __('Links to') . '</text:p>'                . '</table:table-cell>';        }        if ($do_comments) {            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . __('Comments') . '</text:p>'                . '</table:table-cell>';            $comments = PMA_getComments($db, $table);        }        if ($do_mime && $cfgRelation['mimework']) {            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . __('MIME type') . '</text:p>'                . '</table:table-cell>';            $mime_map = PMA_getMIME($db, $table, true);        }        $GLOBALS['odt_buffer'] .= '</table:table-row>';        $columns = PMA_DBI_get_columns($db, $table);        foreach ($columns as $column) {            $field_name = $column['Field'];            $GLOBALS['odt_buffer'] .= '<table:table-row>';            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . htmlspecialchars($field_name) . '</text:p>'                . '</table:table-cell>';            $extracted_fieldspec = PMA_extractFieldSpec($column['Type']);            $type = htmlspecialchars($extracted_fieldspec['print_type']);            if (empty($type)) {                $type     = '&nbsp;';            }            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . htmlspecialchars($type) . '</text:p>'                . '</table:table-cell>';            if (!isset($column['Default'])) {                if ($column['Null'] != 'NO') {                    $column['Default'] = 'NULL';                } else {                    $column['Default'] = '';                }            } else {                $column['Default'] = $column['Default'];            }            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . (($column['Null'] == '' || $column['Null'] == 'NO') ? __('No') : __('Yes')) . '</text:p>'                . '</table:table-cell>';            $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                . '<text:p>' . htmlspecialchars($column['Default']) . '</text:p>'                . '</table:table-cell>';            if ($do_relation && $have_rel) {                if (isset($res_rel[$field_name])) {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p>' . htmlspecialchars($res_rel[$field_name]['foreign_table'] . ' (' . $res_rel[$field_name]['foreign_field'] . ')') . '</text:p>'                        . '</table:table-cell>';                }            }            if ($do_comments) {                if (isset($comments[$field_name])) {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p>' . htmlspecialchars($comments[$field_name]) . '</text:p>'                        . '</table:table-cell>';                } else {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p></text:p>'                        . '</table:table-cell>';                }            }            if ($do_mime && $cfgRelation['mimework']) {                if (isset($mime_map[$field_name])) {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p>' . htmlspecialchars(str_replace('_', '/', $mime_map[$field_name]['mimetype'])) . '</text:p>'                        . '</table:table-cell>';                } else {                    $GLOBALS['odt_buffer'] .= '<table:table-cell office:value-type="string">'                        . '<text:p></text:p>'                        . '</table:table-cell>';                }            }            $GLOBALS['odt_buffer'] .= '</table:table-row>';        } // end while        $GLOBALS['odt_buffer'] .= '</table:table>';        return true;    } // end of the 'PMA_exportStructure' function} // end else?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * dumps a database * * @package PhpMyAdmin *//** * Gets some core libraries */require_once './libraries/common.inc.php';$GLOBALS['js_include'][] = 'export.js';// $sub_part is also used in db_info.inc.php to see if we are coming from// db_export.php, in which case we don't obey $cfg['MaxTableList']$sub_part  = '_export';require_once './libraries/db_common.inc.php';$url_query .= '&amp;goto=db_export.php';require_once './libraries/db_info.inc.php';/** * Displays the form */$export_page_title = __('View dump (schema) of database');// exit if no tables in db foundif ($num_tables < 1) {    PMA_Message::error(__('No tables found in database.'))->display();    include './libraries/footer.inc.php';    exit;} // end if$checkall_url = 'db_export.php?'              . PMA_generate_common_url($db)              . '&amp;goto=db_export.php';$multi_values = '<div>';$multi_values .= '<a href="' . $checkall_url . '" onclick="setSelectOptions(\'dump\', \'table_select[]\', true); return false;">' . __('Select All') . '</a>        /        <a href="' . $checkall_url . '&amp;unselectall=1" onclick="setSelectOptions(\'dump\', \'table_select[]\', false); return false;">' . __('Unselect All') . '</a><br />';$multi_values .= '<select name="table_select[]" id="table_select" size="10" multiple="multiple">';$multi_values .= "\n";if (!empty($selected_tbl) && empty($table_select)) {    $table_select = $selected_tbl;}// Check if the selected tables are defined in $_GET (from clicking Back button on export.php)if (isset($_GET['table_select'])) {    $_GET['table_select'] = urldecode($_GET['table_select']);    $_GET['table_select'] = explode(",", $_GET['table_select']);}foreach ($tables as $each_table) {    if (isset($_GET['table_select'])) {        if (in_array($each_table['Name'], $_GET['table_select'])) {            $is_selected = ' selected="selected"';        } else {            $is_selected = '';        }    } elseif (! empty($unselectall)            || (! empty($table_select) && !in_array($each_table['Name'], $table_select))) {        $is_selected = '';    } else {        $is_selected = ' selected="selected"';    }    $table_html   = htmlspecialchars($each_table['Name']);    $multi_values .= '                <option value="' . $table_html . '"'        . $is_selected . '>'        . str_replace(' ', '&nbsp;', $table_html) . '</option>' . "\n";} // end for$multi_values .= "\n";$multi_values .= '</select></div>';$export_type = 'database';require_once './libraries/display_export.lib.php';/** * Displays the footer */require './libraries/footer.inc.php';?>
<?php/* vim: set expandtab sw=4 ts=4 sts=4: *//** * holds the database index class * * @package PhpMyAdmin *//** * @since phpMyAdmin 3.0.0 * * @package PhpMyAdmin */class PMA_Index{    /**     * Class-wide storage container for indexes (caching, singleton)     *     * @var array     */    protected static $_registry = array();    /**     * @var string The name of the schema     */    protected $_schema = '';    /**     * @var string The name of the table     */    protected $_table = '';    /**     * @var string The name of the index     */    protected $_name = '';    /**     * Columns in index     *     * @var array     */    protected $_columns = array();    /**     * The index method used (BTREE, SPATIAL, FULLTEXT, HASH, RTREE).     *     * @var string     */    protected $_type = '';    /**     * The index choice (PRIMARY, UNIQUE, INDEX, SPATIAL, FULLTEXT)     *     * @var string     */    protected $_choice = '';    /**     * Various remarks.     *     * @var string     */    protected $_remarks = '';    /**     * Any comment provided for the index with a COMMENT attribute when the     * index was created.     *     * @var string     */    protected $_comment = '';    /**     * @var integer 0 if the index cannot contain duplicates, 1 if it can.     */    protected $_non_unique = 0;    /**     * Indicates how the key is packed. NULL if it is not.     *     * @var string     */    protected $_packed = null;    /**     * Constructor     *     * @param array $params     */    public function __construct($params = array())    {        $this->set($params);    }    static public function singleton($schema, $table, $index_name = '')    {        PMA_Index::_loadIndexes($table, $schema);        if (! isset(PMA_Index::$_registry[$schema][$table][$index_name])) {            $index = new PMA_Index;            if (strlen($index_name)) {                $index->setName($index_name);                PMA_Index::$_registry[$schema][$table][$index->getName()] = $index;            }            return $index;        } else {            return PMA_Index::$_registry[$schema][$table][$index_name];        }    }    /**     * returns an array with all indexes from the given table     *     * @param string $table     * @param string $schema     * @return  array     */    static public function getFromTable($table, $schema)    {        PMA_Index::_loadIndexes($table, $schema);        if (isset(PMA_Index::$_registry[$schema][$table])) {            return PMA_Index::$_registry[$schema][$table];        } else {            return array();        }    }    /**     * return primary if set, false otherwise     *     * @param string $table     * @param string $schema     * @return  mixed primary index or false if no one exists     */    static public function getPrimary($table, $schema)    {        PMA_Index::_loadIndexes($table, $schema);        if (isset(PMA_Index::$_registry[$schema][$table]['PRIMARY'])) {            return PMA_Index::$_registry[$schema][$table]['PRIMARY'];        } else {            return false;        }    }    /**     * Load index data for table     *     * @param string $table     * @param string $schema     * @return  boolean     */    static protected function _loadIndexes($table, $schema)    {        if (isset(PMA_Index::$_registry[$schema][$table])) {            return true;        }        $_raw_indexes = PMA_DBI_get_table_indexes($schema, $table);        foreach ($_raw_indexes as $_each_index) {            $_each_index['Schema'] = $schema;            if (! isset(PMA_Index::$_registry[$schema][$table][$_each_index['Key_name']])) {                $key = new PMA_Index($_each_index);                PMA_Index::$_registry[$schema][$table][$_each_index['Key_name']] = $key;            } else {                $key = PMA_Index::$_registry[$schema][$table][$_each_index['Key_name']];            }            $key->addColumn($_each_index);        }        return true;    }    /**     * Add column to index     *     * @param array $params column params     */    public function addColumn($params)    {        if (strlen($params['Column_name'])) {            $this->_columns[$params['Column_name']] = new PMA_Index_Column($params);        }    }    public function addColumns($columns)    {        $_columns = array();        if (isset($columns['names'])) {            // coming from form            // $columns[names][]            // $columns[sub_parts][]            foreach ($columns['names'] as $key => $name) {                $sub_part = isset($columns['sub_parts'][$key]) ? $columns['sub_parts'][$key] : '';                $_columns[] = array(                    'Column_name'   => $name,                    'Sub_part'      => $sub_part,                );            }        } else {            // coming from SHOW INDEXES            // $columns[][name]            // $columns[][sub_part]            // ...            $_columns = $columns;        }        foreach ($_columns as $column) {            $this->addColumn($column);        }    }    /**     * Returns true if $column indexed in this index     *     * @param string $column     * @return  boolean     */    public function hasColumn($column)    {        return isset($this->_columns[$column]);    }    public function set($params)    {        if (isset($params['columns'])) {            $this->addColumns($params['columns']);        }        if (isset($params['Schema'])) {            $this->_schema = $params['Schema'];        }        if (isset($params['Table'])) {            $this->_table = $params['Table'];        }        if (isset($params['Key_name'])) {            $this->_name = $params['Key_name'];        }        if (isset($params['Index_type'])) {            $this->_type = $params['Index_type'];        }        if (isset($params['Comment'])) {            $this->_remarks = $params['Comment'];        }        if (isset($params['Index_comment'])) {            $this->_comment = $params['Index_comment'];        }        if (isset($params['Non_unique'])) {            $this->_non_unique = $params['Non_unique'];        }        if (isset($params['Packed'])) {            $this->_packed = $params['Packed'];        }        if ('PRIMARY' == $this->_name) {            $this->_choice = 'PRIMARY';        } elseif ('FULLTEXT' == $this->_type) {            $this->_choice = 'FULLTEXT';        } elseif ('SPATIAL' == $this->_type) {            $this->_choice = 'SPATIAL';        } elseif ('0' == $this->_non_unique) {            $this->_choice = 'UNIQUE';        } else {            $this->_choice = 'INDEX';        }    }    public function getColumnCount()    {        return count($this->_columns);    }    public function getComment()    {        return $this->_comment;    }    public function getRemarks()    {        return $this->_remarks;    }    public function getComments()    {        $comments = $this->getRemarks();        if (strlen($comments)) {            $comments .= "\n";        }        $comments .= $this->getComment();        return $comments;    }    public function getType()    {        return $this->_type;    }    public function getChoice()    {        return $this->_choice;    }    /**     * Return a list of all index choices     *     * @return  array index choices     */    static public function getIndexChoices()    {        return array(            'PRIMARY',            'INDEX',            'UNIQUE',            'SPATIAL',            'FULLTEXT',        );    }    public function generateIndexSelector()    {        $html_options = '';        foreach (PMA_Index::getIndexChoices() as $each_index_choice) {            if ($each_index_choice === 'PRIMARY'             && $this->_choice !== 'PRIMARY'             && PMA_Index::getPrimary($this->_table, $this->_schema)) {                // skip PRIMARY if there is already one in the table                continue;            }            $html_options .= '<option value="' . $each_index_choice . '"'                 . (($this->_choice == $each_index_choice) ? ' selected="selected"' : '')                 . '>'. $each_index_choice . '</option>' . "\n";        }        return $html_options;    }    public function getPacked()    {        return $this->_packed;    }    public function isPacked($as_text = false)    {        if ($as_text) {            $r = array(                '0' => __('No'),                '1' => __('Yes'),            );        } else {            $r = array(                '0' => false,                '1' => true,            );        }        if (null === $this->_packed) {            return $r[0];        }        return $this->_packed;    }    public function getNonUnique()    {        return $this->_non_unique;    }    public function isUnique($as_text = false)    {        if ($as_text) {            $r = array(                '0' => __('Yes'),                '1' => __('No'),            );        } else {            $r = array(                '0' => true,                '1' => false,            );        }        return $r[$this->_non_unique];    }    public function getName()    {        return $this->_name;    }    public function setName($name)    {        $this->_name = (string) $name;    }    public function getColumns()    {        return $this->_columns;    }    /**     * Show index data     *     * @param string      $table          The tablename     * @param array       $indexes_info   Referenced info array     * @param array       $indexes_data   Referenced data array     * @param boolean     $print_mode     * @access  public     * @return  array       Index collection array     */    static public function getView($table, $schema, $print_mode = false)    {        $indexes = PMA_Index::getFromTable($table, $schema);        $no_indexes_class = count($indexes) > 0 ? ' hide' : '';        $no_indexes  = "<div class='no_indexes_defined$no_indexes_class'>";        $no_indexes .= PMA_Message::notice(__('No index defined!'))->getDisplay();        $no_indexes .= '</div>';        $r  = '<fieldset>';        $r .= '<legend id="index_header">' . __('Indexes');        $r .= PMA_showMySQLDocu('optimization', 'optimizing-database-structure');        $r .= '</legend>';        $r .= $no_indexes;        if (count($indexes) < 1) {            $r .= '</fieldset>';            return $r;        }        if (! $print_mode) {            $r .= PMA_Index::findDuplicates($table, $schema);        }        $r .= '<table id="table_index">';        $r .= '<thead>';        $r .= '<tr>';        if (! $print_mode) {            $r .= '<th colspan="2">' . __('Action') . '</th>';        }        $r .= '<th>' . __('Keyname') . '</th>';        $r .= '<th>' . __('Type') . '</th>';        $r .= '<th>' . __('Unique') . '</th>';        $r .= '<th>' . __('Packed') . '</th>';        $r .= '<th>' . __('Column') . '</th>';        $r .= '<th>' . __('Cardinality') . '</th>';        $r .= '<th>' . __('Collation') . '</th>';        $r .= '<th>' . __('Null') . '</th>';        $r .= '<th>' . __('Comment') . '</th>';        $r .= '</tr>';        $r .= '</thead>';        $r .= '<tbody>';        $odd_row = true;        foreach ($indexes as $index) {            $row_span = ' rowspan="' . $index->getColumnCount() . '" ';            $r .= '<tr class="noclick ' . ($odd_row ? 'odd' : 'even') . '">';            if (! $print_mode) {                $this_params = $GLOBALS['url_params'];                $this_params['index'] = $index->getName();                $r .= '<td class="edit_index ';                if ($GLOBALS['cfg']['AjaxEnable']) {                    $r .= 'ajax" ';                }                $r .= '" ' . $row_span . '>'                   . '    <a href="tbl_indexes.php' . PMA_generate_common_url($this_params)                   . '">' . PMA_getIcon('b_edit.png', __('Edit')) . '</a>'                   . '</td>' . "\n";                $this_params = $GLOBALS['url_params'];                if ($index->getName() == 'PRIMARY') {                    $this_params['sql_query'] = 'ALTER TABLE ' . PMA_backquote($table) . ' DROP PRIMARY KEY';                    $this_params['message_to_show'] = __('The primary key has been dropped');                    $js_msg      = PMA_jsFormat('ALTER TABLE ' . $table . ' DROP PRIMARY KEY');                } else {                    $this_params['sql_query'] = 'ALTER TABLE ' . PMA_backquote($table) . ' DROP INDEX ' . PMA_backquote($index->getName());                    $this_params['message_to_show'] = sprintf(__('Index %s has been dropped'), $index->getName());                    $js_msg      = PMA_jsFormat('ALTER TABLE ' . $table . ' DROP INDEX ' . $index->getName());                }                $r .= '<td ' . $row_span . '>';                $r .= '<input type="hidden" class="drop_primary_key_index_msg" value="' . $js_msg . '" />';                $r .= '    <a ';                if ($GLOBALS['cfg']['AjaxEnable']) {                    $r .= 'class="drop_primary_key_index_anchor" ';                }                $r .= ' href="sql.php' . PMA_generate_common_url($this_params)                   . '" >'                   . PMA_getIcon('b_drop.png', __('Drop'))  . '</a>'                   . '</td>' . "\n";            }            $r .= '<th ' . $row_span . '>' . htmlspecialchars($index->getName()) . '</th>';            $r .= '<td ' . $row_span . '>' . htmlspecialchars($index->getType()) . '</td>';            $r .= '<td ' . $row_span . '>' . $index->isUnique(true) . '</td>';            $r .= '<td ' . $row_span . '>' . $index->isPacked(true) . '</td>';            foreach ($index->getColumns() as $column) {                if ($column->getSeqInIndex() > 1) {                    $r .= '<tr class="noclick ' . ($odd_row ? 'odd' : 'even') . '">';                }                $r .= '<td>' . htmlspecialchars($column->getName());                if ($column->getSubPart()) {                    $r .= ' (' . $column->getSubPart() . ')';                }                $r .= '</td>';                $r .= '<td>' . htmlspecialchars($column->getCardinality()) . '</td>';                $r .= '<td>' . htmlspecialchars($column->getCollation()) . '</td>';                $r .= '<td>' . htmlspecialchars($column->getNull(true)) . '</td>';                if ($column->getSeqInIndex() == 1) {                    $r .= '<td ' . $row_span . '>'                        . htmlspecialchars($index->getComments()) . '</td>';                }                $r .= '</tr>';            } // end foreach $index['Sequences']            $odd_row = ! $odd_row;        } // end while        $r .= '</tbody>';        $r .= '</table>';        $r .= '</fieldset>';        return $r;    }    public function getCompareData()    {        $data = array(            // 'Non_unique'    => $this->_non_unique,            'Packed'        => $this->_packed,            'Index_type'    => $this->_type,        );        foreach ($this->_columns as $column) {            $data['columns'][] = $column->getCompareData();        }        return $data;    }    /**     * Function to check over array of indexes and look for common problems     *     * @access  public     * @param string      name of table     * @return  string      Output HTML     */    static public function findDuplicates($table, $schema)    {        $indexes = PMA_Index::getFromTable($table, $schema);        $output  = '';        // count($indexes) < 2:        //   there is no need to check if there less than two indexes        if (count($indexes) < 2) {            return $output;        }        // remove last index from stack and ...        while ($while_index = array_pop($indexes)) {            // ... compare with every remaining index in stack            foreach ($indexes as $each_index) {                if ($each_index->getCompareData() !== $while_index->getCompareData()) {                    continue;                }                // did not find any difference                // so it makes no sense to have this two equal indexes                $message = PMA_Message::notice(__('The indexes %1$s and %2$s seem to be equal and one of them could possibly be removed.'));                $message->addParam($each_index->getName());                $message->addParam($while_index->getName());                $output .= $message->getDisplay();                // there is no need to check any further indexes if we have already                // found that this one has a duplicate                continue 2;            }        }        return $output;    }}/** * @package PhpMyAdmin */class PMA_Index_Column{    /**     * @var string The column name     */    protected $_name = '';    /**     * @var integer The column sequence number in the index, starting with 1.     */    protected $_seq_in_index = 1;    /**     * @var string How the column is sorted in the index. A (Ascending) or NULL (Not sorted)     */    protected $_collation = null;    /**     * The number of indexed characters if the column is only partly indexed,     * NULL if the entire column is indexed.     *     * @var integer     */    protected $_sub_part = null;    /**     * Contains YES if the column may contain NULL.     * If not, the column contains NO.     *     * @var string     */    protected $_null = '';    /**     * An estimate of the number of unique values in the index. This is updated     * by running ANALYZE TABLE or myisamchk -a. Cardinality is counted based on     * statistics stored as integers, so the value is not necessarily exact even     * for small tables. The higher the cardinality, the greater the chance that     * MySQL uses the index when doing joins.     *     * @var integer     */    protected $_cardinality = null;    public function __construct($params = array())    {        $this->set($params);    }    public function set($params)    {        if (isset($params['Column_name'])) {            $this->_name = $params['Column_name'];        }        if (isset($params['Seq_in_index'])) {            $this->_seq_in_index = $params['Seq_in_index'];        }        if (isset($params['Collation'])) {            $this->_collation = $params['Collation'];        }        if (isset($params['Cardinality'])) {            $this->_cardinality = $params['Cardinality'];        }        if (isset($params['Sub_part'])) {            $this->_sub_part = $params['Sub_part'];        }        if (isset($params['Null'])) {            $this->_null = $params['Null'];        }    }    public function getName()    {        return $this->_name;    }    public function getCollation()    {        return $this->_collation;    }    public function getCardinality()    {        return $this->_cardinality;    }    public function getNull($as_text = false)    {        return $as_text            ? (!$this->_null || $this->_null == 'NO' ? __('No') : __('Yes'))            : $this->_null;    }    public function getSeqInIndex()    {        return $this->_seq_in_index;    }    public function getSubPart()    {        return $this->_sub_part;    }    public function getCompareData()    {        return array(            'Column_name'   => $this->_name,            'Seq_in_index'  => $this->_seq_in_index,            'Collation'     => $this->_collation,            'Sub_part'      => $this->_sub_part,            'Null'          => $this->_null,        );    }}?>
