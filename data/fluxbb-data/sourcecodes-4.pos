<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_censoring.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_censoring.php';// Add a censor wordif (isset($_POST['add_word'])){	confirm_referrer('admin_censoring.php');	$search_for = pun_trim($_POST['new_search_for']);	$replace_with = pun_trim($_POST['new_replace_with']);	if ($search_for == '')		message($lang_admin_censoring['Must enter word message']);	$db->query('INSERT INTO '.$db->prefix.'censoring (search_for, replace_with) VALUES (\''.$db->escape($search_for).'\', \''.$db->escape($replace_with).'\')') or error('Unable to add censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php', $lang_admin_censoring['Word added redirect']);}// Update a censor wordelse if (isset($_POST['update'])){	confirm_referrer('admin_censoring.php');	$id = intval(key($_POST['update']));	$search_for = pun_trim($_POST['search_for'][$id]);	$replace_with = pun_trim($_POST['replace_with'][$id]);	if ($search_for == '')		message($lang_admin_censoring['Must enter word message']);	$db->query('UPDATE '.$db->prefix.'censoring SET search_for=\''.$db->escape($search_for).'\', replace_with=\''.$db->escape($replace_with).'\' WHERE id='.$id) or error('Unable to update censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php', $lang_admin_censoring['Word updated redirect']);}// Remove a censor wordelse if (isset($_POST['remove'])){	confirm_referrer('admin_censoring.php');	$id = intval(key($_POST['remove']));	$db->query('DELETE FROM '.$db->prefix.'censoring WHERE id='.$id) or error('Unable to delete censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php',  $lang_admin_censoring['Word removed redirect']);}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Censoring']);$focus_element = array('censoring', 'new_search_for');define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('censoring');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_censoring['Censoring head'] ?></span></h2>		<div class="box">			<form id="censoring" method="post" action="admin_censoring.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_censoring['Add word subhead'] ?></legend>						<div class="infldset">							<p><?php echo $lang_admin_censoring['Add word info'].' '.($pun_config['o_censoring'] == '1' ? sprintf($lang_admin_censoring['Censoring enabled'], '<a href="admin_options.php#censoring">'.$lang_admin_common['Options'].'</a>') : sprintf($lang_admin_censoring['Censoring disabled'], '<a href="admin_options.php#censoring">'.$lang_admin_common['Options'].'</a>')) ?></p>							<table cellspacing="0">							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_censoring['Censored word label'] ?></th>									<th class="tc2" scope="col"><?php echo $lang_admin_censoring['Replacement label'] ?></th>									<th class="hidehead" scope="col"><?php echo $lang_admin_censoring['Action label'] ?></th>								</tr>							</thead>							<tbody>								<tr>									<td class="tcl"><input type="text" name="new_search_for" size="24" maxlength="60" tabindex="1" /></td>									<td class="tc2"><input type="text" name="new_replace_with" size="24" maxlength="60" tabindex="2" /></td>									<td><input type="submit" name="add_word" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="3" /></td>								</tr>							</tbody>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_censoring['Edit remove subhead'] ?></legend>						<div class="infldset"><?php$result = $db->query('SELECT id, search_for, replace_with FROM '.$db->prefix.'censoring ORDER BY id') or error('Unable to fetch censor word list', __FILE__, __LINE__, $db->error());if ($db->num_rows($result)){?>							<table cellspacing="0" >							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_censoring['Censored word label'] ?></th>									<th class="tc2" scope="col"><?php echo $lang_admin_censoring['Replacement label'] ?></th>									<th class="hidehead" scope="col"><?php echo $lang_admin_censoring['Action label'] ?></th>								</tr>							</thead>							<tbody><?php	while ($cur_word = $db->fetch_assoc($result))		echo "\t\t\t\t\t\t\t\t".'<tr><td class="tcl"><input type="text" name="search_for['.$cur_word['id'].']" value="'.pun_htmlspecialchars($cur_word['search_for']).'" size="24" maxlength="60" /></td><td class="tc2"><input type="text" name="replace_with['.$cur_word['id'].']" value="'.pun_htmlspecialchars($cur_word['replace_with']).'" size="24" maxlength="60" /></td><td><input type="submit" name="update['.$cur_word['id'].']" value="'.$lang_admin_common['Update'].'" />&#160;<input type="submit" name="remove['.$cur_word['id'].']" value="'.$lang_admin_common['Remove'].'" /></td></tr>'."\n";?>							</tbody>							</table><?php}else	echo "\t\t\t\t\t\t\t".'<p>'.$lang_admin_censoring['No words in list'].'</p>'."\n";?>						</div>					</fieldset>				</div>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if (!$pun_user['is_admmod'])	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_index.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_index.php';$action = isset($_GET['action']) ? $_GET['action'] : null;// Check for upgradeif ($action == 'check_upgrade'){	if (!ini_get('allow_url_fopen'))		message($lang_admin_index['fopen disabled message']);	$latest_version = trim(@file_get_contents('http://fluxbb.org/latest_version'));	if (empty($latest_version))		message($lang_admin_index['Upgrade check failed message']);	if (version_compare($pun_config['o_cur_version'], $latest_version, '>='))		message($lang_admin_index['Running latest version message']);	else		message(sprintf($lang_admin_index['New version available message'], '<a href="http://fluxbb.org/">FluxBB.org</a>'));}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Index']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('index');?>	<div class="block">		<h2><span><?php echo $lang_admin_index['Forum admin head'] ?></span></h2>		<div id="adintro" class="box">			<div class="inbox">				<p><?php echo $lang_admin_index['Welcome to admin'] ?></p>				<ul>					<li><span><?php echo $lang_admin_index['Welcome 1'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 2'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 3'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 4'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 5'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 6'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 7'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 8'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 9'] ?></span></li>				</ul>			</div>		</div>		<h2 class="block2"><span><?php echo $lang_admin_index['About head'] ?></span></h2>		<div id="adstats" class="box">			<div class="inbox">				<dl>					<dt><?php echo $lang_admin_index['FluxBB version label'] ?></dt>					<dd>						<?php printf($lang_admin_index['FluxBB version data']."\n", $pun_config['o_cur_version'], '<a href="admin_index.php?action=check_upgrade">'.$lang_admin_index['Check for upgrade'].'</a>') ?>					</dd>					<dt><?php echo $lang_admin_index['Server statistics label'] ?></dt>					<dd>						<a href="admin_statistics.php"><?php echo $lang_admin_index['View server statistics'] ?></a>					</dd>					<dt><?php echo $lang_admin_index['Support label'] ?></dt>					<dd>						<a href="http://fluxbb.org/forums/index.php"><?php echo $lang_admin_index['Forum label'] ?></a> - <a href="http://fluxbb.org/community/irc.html"><?php echo $lang_admin_index['IRC label'] ?></a>					</dd>				</dl>			</div>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the help templatedefine('PUN_HELP', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');// Load the help.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/help.php';$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_help['Help']);define('PUN_ACTIVE_PAGE', 'help');require PUN_ROOT.'header.php';?><h2><span><?php echo $lang_help['BBCode'] ?></span></h2><div class="box">	<div class="inbox">		<p><a name="bbcode"></a><?php echo $lang_help['BBCode info 1'] ?></p>		<p><?php echo $lang_help['BBCode info 2'] ?></p>	</div></div><h2><span><?php echo $lang_help['Text style'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Text style info'] ?></p>		<p><code>[b]<?php echo $lang_help['Bold text'] ?>[/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><?php echo $lang_help['Bold text'] ?></strong></samp></p>		<p><code>[u]<?php echo $lang_help['Underlined text'] ?>[/u]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbu"><?php echo $lang_help['Underlined text'] ?></span></samp></p>		<p><code>[i]<?php echo $lang_help['Italic text'] ?>[/i]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Italic text'] ?></em></samp></p>		<p><code>[s]<?php echo $lang_help['Strike-through text'] ?>[/s]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbs"><?php echo $lang_help['Strike-through text'] ?></span></samp></p>		<p><code>[del]<?php echo $lang_help['Deleted text'] ?>[/del]</code> <?php echo $lang_help['produces'] ?> <samp><del><?php echo $lang_help['Deleted text'] ?></del></samp></p>		<p><code>[ins]<?php echo $lang_help['Inserted text'] ?>[/ins]</code> <?php echo $lang_help['produces'] ?> <samp><ins><?php echo $lang_help['Inserted text'] ?></ins></samp></p>		<p><code>[em]<?php echo $lang_help['Emphasised text'] ?>[/em]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Emphasised text'] ?></em></samp></p>		<p><code>[color=#FF0000]<?php echo $lang_help['Red text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: #ff0000"><?php echo $lang_help['Red text'] ?></span></samp></p>		<p><code>[color=blue]<?php echo $lang_help['Blue text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: blue"><?php echo $lang_help['Blue text'] ?></span></samp></p>		<p><code>[h]<?php echo $lang_help['Heading text'] ?>[/h]</code> <?php echo $lang_help['produces'] ?></p> <div class="postmsg"><h5><?php echo $lang_help['Heading text'] ?></h5></div>	</div></div><h2><span><?php echo $lang_help['Links and images'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Links info'] ?></p>		<p><a name="url"></a><code>[url=<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>]<?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?></a></samp></p>		<p><code>[url]<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/') ?></a></samp></p>		<p><code>[url=/help.php]<?php echo $lang_help['This help page'] ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/help.php') ?>"><?php echo $lang_help['This help page'] ?></a></samp></p>		<p><code>[email]myname@example.com[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com">myname@example.com</a></samp></p>		<p><code>[email=myname@example.com]<?php echo $lang_help['My email address'] ?>[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com"><?php echo $lang_help['My email address'] ?></a></samp></p>		<p><code>[topic=1]<?php echo $lang_help['Test topic'] ?>[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo $lang_help['Test topic'] ?></a></samp></p>		<p><code>[topic]1[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?></a></samp></p>		<p><code>[post=1]<?php echo $lang_help['Test post'] ?>[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo $lang_help['Test post'] ?></a></samp></p>		<p><code>[post]1[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?></a></samp></p>		<p><code>[forum=1]<?php echo $lang_help['Test forum'] ?>[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo $lang_help['Test forum'] ?></a></samp></p>		<p><code>[forum]1[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?></a></samp></p>		<p><code>[user=2]<?php echo $lang_help['Test user'] ?>[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo $lang_help['Test user'] ?></a></samp></p>		<p><code>[user]2[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?></a></samp></p>	</div>	<div class="inbox">		<p><a name="img"></a><?php echo $lang_help['Images info'] ?></p>		<p><code>[img=<?php echo $lang_help['FluxBB bbcode test'] ?>]<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png[/img]</code> <?php echo $lang_help['produces'] ?> <samp><img style="height: 21px" src="<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png" alt="<?php echo $lang_help['FluxBB bbcode test'] ?>" /></samp></p>	</div></div><h2><span><?php echo $lang_help['Quotes'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Quotes info'] ?></p>		<p><code>[quote=James]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>		<p><?php echo $lang_help['produces quote box'] ?></p>		<div class="postmsg">			<div class="quotebox"><cite>James <?php echo $lang_common['wrote'] ?></cite><blockquote><div><p><?php echo $lang_help['Quote text'] ?></p></div></blockquote></div>		</div>		<p><?php echo $lang_help['Quotes info 2'] ?></p>		<p><code>[quote]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>		<p><?php echo $lang_help['produces quote box'] ?></p>		<div class="postmsg">			<div class="quotebox"><blockquote><div><p><?php echo $lang_help['Quote text'] ?></p></div></blockquote></div>		</div>		<p><?php echo $lang_help['quote note'] ?></p>	</div></div><h2><span><?php echo $lang_help['Code'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Code info'] ?></p>		<p><code>[code]<?php echo $lang_help['Code text'] ?>[/code]</code></p>		<p><?php echo $lang_help['produces code box'] ?></p>		<div class="postmsg">			<div class="codebox"><pre><code><?php echo $lang_help['Code text'] ?></code></pre></div>		</div>	</div></div><h2><span><?php echo $lang_help['Lists'] ?></span></h2><div class="box">	<div class="inbox">		<p><a name="lists"></a><?php echo $lang_help['List info'] ?></p>		<p><code>[list][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>		<br /><span><?php echo $lang_help['produces list'] ?></span></p>		<div class="postmsg">			<ul><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ul>		</div>		<p><code>[list=1][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>		<br /><span><?php echo $lang_help['produces decimal list'] ?></span></p>		<div class="postmsg">			<ol class="decimal"><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ol>		</div>		<p><code>[list=a][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>		<br /><span><?php echo $lang_help['produces alpha list'] ?></span></p>		<div class="postmsg">			<ol class="alpha"><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ol>		</div>	</div></div><h2><span><?php echo $lang_help['Nested tags'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Nested tags info'] ?></p>		<p><code>[b][u]<?php echo $lang_help['Bold, underlined text'] ?>[/u][/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><span class="bbu"><?php echo $lang_help['Bold, underlined text'] ?></span></strong></samp></p>	</div></div><h2><span><?php echo $lang_help['Smilies'] ?></span></h2><div class="box">	<div class="inbox">		<p><a name="smilies"></a><?php echo $lang_help['Smilies info'] ?></p><?php// Display the smiley setrequire PUN_ROOT.'include/parser.php';$smiley_groups = array();foreach ($smilies as $smiley_text => $smiley_img)	$smiley_groups[$smiley_img][] = $smiley_text;foreach ($smiley_groups as $smiley_img => $smiley_texts)	echo "\t\t".'<p><code>'.implode('</code> '.$lang_common['and'].' <code>', $smiley_texts).'</code> <span>'.$lang_help['produces'].'</span> <samp><img src="'.pun_htmlspecialchars(get_base_url(true)).'/img/smilies/'.$smiley_img.'" width="15" height="15" alt="'.$smiley_texts[0].'" /></samp></p>'."\n";?>	</div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');// Load the index.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/index.php';// Get list of forums and topics with new posts since last visitif (!$pun_user['is_guest']){	$result = $db->query('SELECT t.forum_id, t.id, t.last_post FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.$pun_user['last_visit'].' AND t.moved_to IS NULL') or error('Unable to fetch new topics', __FILE__, __LINE__, $db->error());	$new_topics = array();	while ($cur_topic = $db->fetch_assoc($result))		$new_topics[$cur_topic['forum_id']][$cur_topic['id']] = $cur_topic['last_post'];	$tracked_topics = get_tracked_topics();}if ($pun_config['o_feed_type'] == '1')	$page_head = array('feed' => '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;type=rss" title="'.$lang_common['RSS active topics feed'].'" />');else if ($pun_config['o_feed_type'] == '2')	$page_head = array('feed' => '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;type=atom" title="'.$lang_common['Atom active topics feed'].'" />');$forum_actions = array();// Display a "mark all as read" linkif (!$pun_user['is_guest'])	$forum_actions[] = '<a href="misc.php?action=markread">'.$lang_common['Mark all as read'].'</a>';$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']));define('PUN_ALLOW_INDEX', 1);define('PUN_ACTIVE_PAGE', 'index');require PUN_ROOT.'header.php';// Print the categories and forums$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.forum_desc, f.redirect_url, f.moderators, f.num_topics, f.num_posts, f.last_post, f.last_post_id, f.last_poster FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE fp.read_forum IS NULL OR fp.read_forum=1 ORDER BY c.disp_position, c.id, f.disp_position', true) or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());$cur_category = 0;$cat_count = 0;$forum_count = 0;while ($cur_forum = $db->fetch_assoc($result)){	$moderators = '';	if ($cur_forum['cid'] != $cur_category) // A new category since last iteration?	{		if ($cur_category != 0)			echo "\t\t\t".'</tbody>'."\n\t\t\t".'</table>'."\n\t\t".'</div>'."\n\t".'</div>'."\n".'</div>'."\n\n";		++$cat_count;		$forum_count = 0;?><div id="idx<?php echo $cat_count ?>" class="blocktable">	<h2><span><?php echo pun_htmlspecialchars($cur_forum['cat_name']) ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_common['Forum'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_index['Topics'] ?></th>					<th class="tc3" scope="col"><?php echo $lang_common['Posts'] ?></th>					<th class="tcr" scope="col"><?php echo $lang_common['Last post'] ?></th>				</tr>			</thead>			<tbody><?php		$cur_category = $cur_forum['cid'];	}	++$forum_count;	$item_status = ($forum_count % 2 == 0) ? 'roweven' : 'rowodd';	$forum_field_new = '';	$icon_type = 'icon';	// Are there new posts since our last visit?	if (!$pun_user['is_guest'] && $cur_forum['last_post'] > $pun_user['last_visit'] && (empty($tracked_topics['forums'][$cur_forum['fid']]) || $cur_forum['last_post'] > $tracked_topics['forums'][$cur_forum['fid']]))	{		// There are new posts in this forum, but have we read all of them already?		foreach ($new_topics[$cur_forum['fid']] as $check_topic_id => $check_last_post)		{			if ((empty($tracked_topics['topics'][$check_topic_id]) || $tracked_topics['topics'][$check_topic_id] < $check_last_post) && (empty($tracked_topics['forums'][$cur_forum['fid']]) || $tracked_topics['forums'][$cur_forum['fid']] < $check_last_post))			{				$item_status .= ' inew';				$forum_field_new = '<span class="newtext">[ <a href="search.php?action=show_new&amp;fid='.$cur_forum['fid'].'">'.$lang_common['New posts'].'</a> ]</span>';				$icon_type = 'icon icon-new';				break;			}		}	}	// Is this a redirect forum?	if ($cur_forum['redirect_url'] != '')	{		$forum_field = '<h3><span class="redirtext">'.$lang_index['Link to'].'</span> <a href="'.pun_htmlspecialchars($cur_forum['redirect_url']).'" title="'.$lang_index['Link to'].' '.pun_htmlspecialchars($cur_forum['redirect_url']).'">'.pun_htmlspecialchars($cur_forum['forum_name']).'</a></h3>';		$num_topics = $num_posts = '-';		$item_status .= ' iredirect';		$icon_type = 'icon';	}	else	{		$forum_field = '<h3><a href="viewforum.php?id='.$cur_forum['fid'].'">'.pun_htmlspecialchars($cur_forum['forum_name']).'</a>'.(!empty($forum_field_new) ? ' '.$forum_field_new : '').'</h3>';		$num_topics = $cur_forum['num_topics'];		$num_posts = $cur_forum['num_posts'];	}	if ($cur_forum['forum_desc'] != '')		$forum_field .= "\n\t\t\t\t\t\t\t\t".'<div class="forumdesc">'.$cur_forum['forum_desc'].'</div>';	// If there is a last_post/last_poster	if ($cur_forum['last_post'] != '')		$last_post = '<a href="viewtopic.php?pid='.$cur_forum['last_post_id'].'#p'.$cur_forum['last_post_id'].'">'.format_time($cur_forum['last_post']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_forum['last_poster']).'</span>';	else if ($cur_forum['redirect_url'] != '')		$last_post = '- - -';	else		$last_post = $lang_common['Never'];	if ($cur_forum['moderators'] != '')	{		$mods_array = unserialize($cur_forum['moderators']);		$moderators = array();		foreach ($mods_array as $mod_username => $mod_id)		{			if ($pun_user['g_view_users'] == '1')				$moderators[] = '<a href="profile.php?id='.$mod_id.'">'.pun_htmlspecialchars($mod_username).'</a>';			else				$moderators[] = pun_htmlspecialchars($mod_username);		}		$moderators = "\t\t\t\t\t\t\t\t".'<p class="modlist">(<em>'.$lang_common['Moderated by'].'</em> '.implode(', ', $moderators).')</p>'."\n";	}?>				<tr class="<?php echo $item_status ?>">					<td class="tcl">						<div class="<?php echo $icon_type ?>"><div class="nosize"><?php echo forum_number_format($forum_count) ?></div></div>						<div class="tclcon">							<div>								<?php echo $forum_field."\n".$moderators ?>							</div>						</div>					</td>					<td class="tc2"><?php echo forum_number_format($num_topics) ?></td>					<td class="tc3"><?php echo forum_number_format($num_posts) ?></td>					<td class="tcr"><?php echo $last_post ?></td>				</tr><?php}// Did we output any categories and forums?if ($cur_category > 0)	echo "\t\t\t".'</tbody>'."\n\t\t\t".'</table>'."\n\t\t".'</div>'."\n\t".'</div>'."\n".'</div>'."\n\n";else	echo '<div id="idx0" class="block"><div class="box"><div class="inbox"><p>'.$lang_index['Empty board'].'</p></div></div></div>';// Collect some statistics from the databaseif (file_exists(FORUM_CACHE_DIR.'cache_users_info.php'))	include FORUM_CACHE_DIR.'cache_users_info.php';if (!defined('PUN_USERS_INFO_LOADED')){	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_users_info_cache();	require FORUM_CACHE_DIR.'cache_users_info.php';}$result = $db->query('SELECT SUM(num_topics), SUM(num_posts) FROM '.$db->prefix.'forums') or error('Unable to fetch topic/post count', __FILE__, __LINE__, $db->error());list($stats['total_topics'], $stats['total_posts']) = $db->fetch_row($result);if ($pun_user['g_view_users'] == '1')	$stats['newest_user'] = '<a href="profile.php?id='.$stats['last_user']['id'].'">'.pun_htmlspecialchars($stats['last_user']['username']).'</a>';else	$stats['newest_user'] = pun_htmlspecialchars($stats['last_user']['username']);if (!empty($forum_actions)){?><div class="linksb">	<div class="inbox crumbsplus">		<p class="subscribelink clearb"><?php echo implode(' - ', $forum_actions); ?></p>	</div></div><?php}?><div id="brdstats" class="block">	<h2><span><?php echo $lang_index['Board info'] ?></span></h2>	<div class="box">		<div class="inbox">			<dl class="conr">				<dt><strong><?php echo $lang_index['Board stats'] ?></strong></dt>				<dd><span><?php printf($lang_index['No of users'], '<strong>'.forum_number_format($stats['total_users']).'</strong>') ?></span></dd>				<dd><span><?php printf($lang_index['No of topics'], '<strong>'.forum_number_format($stats['total_topics']).'</strong>') ?></span></dd>				<dd><span><?php printf($lang_index['No of posts'], '<strong>'.forum_number_format($stats['total_posts']).'</strong>') ?></span></dd>			</dl>			<dl class="conl">				<dt><strong><?php echo $lang_index['User info'] ?></strong></dt>				<dd><span><?php printf($lang_index['Newest user'], $stats['newest_user']) ?></span></dd><?phpif ($pun_config['o_users_online'] == '1'){	// Fetch users online info and generate strings for output	$num_guests = 0;	$users = array();	$result = $db->query('SELECT user_id, ident FROM '.$db->prefix.'online WHERE idle=0 ORDER BY ident', true) or error('Unable to fetch online list', __FILE__, __LINE__, $db->error());	while ($pun_user_online = $db->fetch_assoc($result))	{		if ($pun_user_online['user_id'] > 1)		{			if ($pun_user['g_view_users'] == '1')				$users[] = "\n\t\t\t\t".'<dd><a href="profile.php?id='.$pun_user_online['user_id'].'">'.pun_htmlspecialchars($pun_user_online['ident']).'</a>';			else				$users[] = "\n\t\t\t\t".'<dd>'.pun_htmlspecialchars($pun_user_online['ident']);		}		else			++$num_guests;	}	$num_users = count($users);	echo "\t\t\t\t".'<dd><span>'.sprintf($lang_index['Users online'], '<strong>'.forum_number_format($num_users).'</strong>').'</span></dd>'."\n\t\t\t\t".'<dd><span>'.sprintf($lang_index['Guests online'], '<strong>'.forum_number_format($num_guests).'</strong>').'</span></dd>'."\n\t\t\t".'</dl>'."\n";	if ($num_users > 0)		echo "\t\t\t".'<dl id="onlinelist" class="clearb">'."\n\t\t\t\t".'<dt><strong>'.$lang_index['Online'].' </strong></dt>'."\t\t\t\t".implode(',</dd> ', $users).'</dd>'."\n\t\t\t".'</dl>'."\n";	else		echo "\t\t\t".'<div class="clearer"></div>'."\n";}else	echo "\t\t\t".'</dl>'."\n\t\t\t".'<div class="clearer"></div>'."\n";?>		</div>	</div></div><?php$footer_style = 'index';require PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if (!$pun_user['is_admmod'])	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_index.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_index.php';$action = isset($_GET['action']) ? $_GET['action'] : null;// Show phpinfo() outputif ($action == 'phpinfo' && $pun_user['g_id'] == PUN_ADMIN){	// Is phpinfo() a disabled function?	if (strpos(strtolower((string) ini_get('disable_functions')), 'phpinfo') !== false)		message($lang_admin_index['PHPinfo disabled message']);	phpinfo();	exit;}// Get the server load averages (if possible)if (@file_exists('/proc/loadavg') && is_readable('/proc/loadavg')){	// We use @ just in case	$fh = @fopen('/proc/loadavg', 'r');	$load_averages = @fread($fh, 64);	@fclose($fh);	if (($fh = @fopen('/proc/loadavg', 'r')))	{		$load_averages = fread($fh, 64);		fclose($fh);	}	else		$load_averages = '';	$load_averages = @explode(' ', $load_averages);	$server_load = isset($load_averages[2]) ? $load_averages[0].' '.$load_averages[1].' '.$load_averages[2] : $lang_admin_index['Not available'];}else if (!in_array(PHP_OS, array('WINNT', 'WIN32')) && preg_match('%averages?: ([0-9\.]+),?\s+([0-9\.]+),?\s+([0-9\.]+)%i', @exec('uptime'), $load_averages))	$server_load = $load_averages[1].' '.$load_averages[2].' '.$load_averages[3];else	$server_load = $lang_admin_index['Not available'];// Get number of current visitors$result = $db->query('SELECT COUNT(user_id) FROM '.$db->prefix.'online WHERE idle=0') or error('Unable to fetch online count', __FILE__, __LINE__, $db->error());$num_online = $db->result($result);// Collect some additional info about MySQLif ($db_type == 'mysql' || $db_type == 'mysqli' || $db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb'){	// Calculate total db size/row count	$result = $db->query('SHOW TABLE STATUS LIKE \''.$db->prefix.'%\'') or error('Unable to fetch table status', __FILE__, __LINE__, $db->error());	$total_records = $total_size = 0;	while ($status = $db->fetch_assoc($result))	{		$total_records += $status['Rows'];		$total_size += $status['Data_length'] + $status['Index_length'];	}	$total_size = file_size($total_size);}// Check for the existence of various PHP opcode caches/optimizersif (function_exists('mmcache'))	$php_accelerator = '<a href="http://'.$lang_admin_index['Turck MMCache link'].'">'.$lang_admin_index['Turck MMCache'].'</a>';else if (isset($_PHPA))	$php_accelerator = '<a href="http://'.$lang_admin_index['ionCube PHP Accelerator link'].'">'.$lang_admin_index['ionCube PHP Accelerator'].'</a>';else if (ini_get('apc.enabled'))	$php_accelerator ='<a href="http://'.$lang_admin_index['Alternative PHP Cache (APC) link'].'">'.$lang_admin_index['Alternative PHP Cache (APC)'].'</a>';else if (ini_get('zend_optimizer.optimization_level'))	$php_accelerator = '<a href="http://'.$lang_admin_index['Zend Optimizer link'].'">'.$lang_admin_index['Zend Optimizer'].'</a>';else if (ini_get('eaccelerator.enable'))	$php_accelerator = '<a href="http://'.$lang_admin_index['eAccelerator link'].'">'.$lang_admin_index['eAccelerator'].'</a>';else if (ini_get('xcache.cacher'))	$php_accelerator = '<a href="http://'.$lang_admin_index['XCache link'].'">'.$lang_admin_index['XCache'].'</a>';else	$php_accelerator = $lang_admin_index['NA'];$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Server statistics']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('index');?>	<div class="block">		<h2><span><?php echo $lang_admin_index['Server statistics head'] ?></span></h2>		<div id="adstats" class="box">			<div class="inbox">				<dl>					<dt><?php echo $lang_admin_index['Server load label'] ?></dt>					<dd>						<?php printf($lang_admin_index['Server load data']."\n", $server_load, $num_online) ?>					</dd><?php if ($pun_user['g_id'] == PUN_ADMIN): ?>					<dt><?php echo $lang_admin_index['Environment label'] ?></dt>					<dd>						<?php printf($lang_admin_index['Environment data OS'], PHP_OS) ?><br />						<?php printf($lang_admin_index['Environment data version'], phpversion(), '<a href="admin_statistics.php?action=phpinfo">'.$lang_admin_index['Show info'].'</a>') ?><br />						<?php printf($lang_admin_index['Environment data acc']."\n", $php_accelerator) ?>					</dd>					<dt><?php echo $lang_admin_index['Database label'] ?></dt>					<dd>						<?php echo implode(' ', $db->get_version())."\n" ?><?php if (isset($total_records) && isset($total_size)): ?>						<br /><?php printf($lang_admin_index['Database data rows']."\n", forum_number_format($total_records)) ?>						<br /><?php printf($lang_admin_index['Database data size']."\n", $total_size) ?><?php endif; ?>					</dd><?php endif; ?>				</dl>			</div>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');else if ($pun_user['g_view_users'] == '0')	message($lang_common['No permission'], false, '403 Forbidden');// Load the userlist.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/userlist.php';// Load the search.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/search.php';// Determine if we are allowed to view post counts$show_post_count = ($pun_config['o_show_post_count'] == '1' || $pun_user['is_admmod']) ? true : false;$username = isset($_GET['username']) && $pun_user['g_search_users'] == '1' ? pun_trim($_GET['username']) : '';$show_group = isset($_GET['show_group']) ? intval($_GET['show_group']) : -1;$sort_by = isset($_GET['sort_by']) && (in_array($_GET['sort_by'], array('username', 'registered')) || ($_GET['sort_by'] == 'num_posts' && $show_post_count)) ? $_GET['sort_by'] : 'username';$sort_dir = isset($_GET['sort_dir']) && $_GET['sort_dir'] == 'DESC' ? 'DESC' : 'ASC';// Create any SQL for the WHERE clause$where_sql = array();$like_command = ($db_type == 'pgsql') ? 'ILIKE' : 'LIKE';if ($username != '')	$where_sql[] = 'u.username '.$like_command.' \''.$db->escape(str_replace('*', '%', $username)).'\'';if ($show_group > -1)	$where_sql[] = 'u.group_id='.$show_group;// Fetch user count$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'users AS u WHERE u.id>1 AND u.group_id!='.PUN_UNVERIFIED.(!empty($where_sql) ? ' AND '.implode(' AND ', $where_sql) : '')) or error('Unable to fetch user list count', __FILE__, __LINE__, $db->error());$num_users = $db->result($result);// Determine the user offset (based on $_GET['p'])$num_pages = ceil($num_users / 50);$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);$start_from = 50 * ($p - 1);$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_common['User list']);if ($pun_user['g_search_users'] == '1')	$focus_element = array('userlist', 'username');// Generate paging links$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'userlist.php?username='.urlencode($username).'&amp;show_group='.$show_group.'&amp;sort_by='.$sort_by.'&amp;sort_dir='.$sort_dir);define('PUN_ALLOW_INDEX', 1);define('PUN_ACTIVE_PAGE', 'userlist');require PUN_ROOT.'header.php';?><div class="blockform">	<h2><span><?php echo $lang_search['User search'] ?></span></h2>	<div class="box">		<form id="userlist" method="get" action="userlist.php">			<div class="inform">				<fieldset>					<legend><?php echo $lang_ul['User find legend'] ?></legend>					<div class="infldset"><?php if ($pun_user['g_search_users'] == '1'): ?>						<label class="conl"><?php echo $lang_common['Username'] ?><br /><input type="text" name="username" value="<?php echo pun_htmlspecialchars($username) ?>" size="25" maxlength="25" /><br /></label><?php endif; ?>						<label class="conl"><?php echo $lang_ul['User group']."\n" ?>						<br /><select name="show_group">							<option value="-1"<?php if ($show_group == -1) echo ' selected="selected"' ?>><?php echo $lang_ul['All users'] ?></option><?php$result = $db->query('SELECT g_id, g_title FROM '.$db->prefix.'groups WHERE g_id!='.PUN_GUEST.' ORDER BY g_id') or error('Unable to fetch user group list', __FILE__, __LINE__, $db->error());while ($cur_group = $db->fetch_assoc($result)){	if ($cur_group['g_id'] == $show_group)		echo "\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'" selected="selected">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";	else		echo "\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";}?>						</select>						<br /></label>						<label class="conl"><?php echo $lang_search['Sort by']."\n" ?>						<br /><select name="sort_by">							<option value="username"<?php if ($sort_by == 'username') echo ' selected="selected"' ?>><?php echo $lang_common['Username'] ?></option>							<option value="registered"<?php if ($sort_by == 'registered') echo ' selected="selected"' ?>><?php echo $lang_common['Registered'] ?></option><?php if ($show_post_count): ?>							<option value="num_posts"<?php if ($sort_by == 'num_posts') echo ' selected="selected"' ?>><?php echo $lang_ul['No of posts'] ?></option><?php endif; ?>						</select>						<br /></label>						<label class="conl"><?php echo $lang_search['Sort order']."\n" ?>						<br /><select name="sort_dir">							<option value="ASC"<?php if ($sort_dir == 'ASC') echo ' selected="selected"' ?>><?php echo $lang_search['Ascending'] ?></option>							<option value="DESC"<?php if ($sort_dir == 'DESC') echo ' selected="selected"' ?>><?php echo $lang_search['Descending'] ?></option>						</select>						<br /></label>						<p class="clearb"><?php echo ($pun_user['g_search_users'] == '1' ? $lang_ul['User search info'].' ' : '').$lang_ul['User sort info']; ?></p>					</div>				</fieldset>			</div>			<p class="buttons"><input type="submit" name="search" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /></p>		</form>	</div></div><div class="linkst">	<div class="inbox">		<p class="pagelink"><?php echo $paging_links ?></p>		<div class="clearer"></div>	</div></div><div id="users1" class="blocktable">	<h2><span><?php echo $lang_common['User list'] ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_common['Username'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_common['Title'] ?></th><?php if ($show_post_count): ?>					<th class="tc3" scope="col"><?php echo $lang_common['Posts'] ?></th><?php endif; ?>					<th class="tcr" scope="col"><?php echo $lang_common['Registered'] ?></th>				</tr>			</thead>			<tbody><?php// Retrieve a list of user IDs, LIMIT is (really) expensive so we only fetch the IDs here then later fetch the remaining data$result = $db->query('SELECT u.id FROM '.$db->prefix.'users AS u WHERE u.id>1 AND u.group_id!='.PUN_UNVERIFIED.(!empty($where_sql) ? ' AND '.implode(' AND ', $where_sql) : '').' ORDER BY '.$sort_by.' '.$sort_dir.', u.id ASC LIMIT '.$start_from.', 50') or error('Unable to fetch user IDs', __FILE__, __LINE__, $db->error());if ($db->num_rows($result)){	$user_ids = array();	for ($i = 0;$cur_user_id = $db->result($result, $i);$i++)		$user_ids[] = $cur_user_id;	// Grab the users	$result = $db->query('SELECT u.id, u.username, u.title, u.num_posts, u.registered, g.g_id, g.g_user_title FROM '.$db->prefix.'users AS u LEFT JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id WHERE u.id IN('.implode(',', $user_ids).') ORDER BY '.$sort_by.' '.$sort_dir.', u.id ASC') or error('Unable to fetch user list', __FILE__, __LINE__, $db->error());	while ($user_data = $db->fetch_assoc($result))	{		$user_title_field = get_title($user_data);?>				<tr>					<td class="tcl"><?php echo '<a href="profile.php?id='.$user_data['id'].'">'.pun_htmlspecialchars($user_data['username']).'</a>' ?></td>					<td class="tc2"><?php echo $user_title_field ?></td><?php if ($show_post_count): ?>					<td class="tc3"><?php echo forum_number_format($user_data['num_posts']) ?></td><?php endif; ?>					<td class="tcr"><?php echo format_time($user_data['registered'], true) ?></td>				</tr><?php	}}else	echo "\t\t\t".'<tr>'."\n\t\t\t\t\t".'<td class="tcl" colspan="'.(($show_post_count) ? 4 : 3).'">'.$lang_search['No hits'].'</td></tr>'."\n";?>			</tbody>			</table>		</div>	</div></div><div class="linksb">	<div class="inbox">		<p class="pagelink"><?php echo $paging_links ?></p>		<div class="clearer"></div>	</div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_permissions.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_permissions.php';if (isset($_POST['form_sent'])){	confirm_referrer('admin_permissions.php');	$form = array_map('intval', $_POST['form']);	foreach ($form as $key => $input)	{		// Make sure the input is never a negative value		if($input < 0)			$input = 0;		// Only update values that have changed		if (array_key_exists('p_'.$key, $pun_config) && $pun_config['p_'.$key] != $input)			$db->query('UPDATE '.$db->prefix.'config SET conf_value='.$input.' WHERE conf_name=\'p_'.$db->escape($key).'\'') or error('Unable to update board config', __FILE__, __LINE__, $db->error());	}	// Regenerate the config cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_config_cache();	redirect('admin_permissions.php', $lang_admin_permissions['Perms updated redirect']);}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Permissions']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('permissions');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_permissions['Permissions head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_permissions.php">				<p class="submittop"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" /></p>				<div class="inform">					<input type="hidden" name="form_sent" value="1" />					<fieldset>						<legend><?php echo $lang_admin_permissions['Posting subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_permissions['BBCode label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[message_bbcode]" value="1"<?php if ($pun_config['p_message_bbcode'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[message_bbcode]" value="0"<?php if ($pun_config['p_message_bbcode'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['BBCode help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Image tag label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[message_img_tag]" value="1"<?php if ($pun_config['p_message_img_tag'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[message_img_tag]" value="0"<?php if ($pun_config['p_message_img_tag'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Image tag help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['All caps message label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[message_all_caps]" value="1"<?php if ($pun_config['p_message_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[message_all_caps]" value="0"<?php if ($pun_config['p_message_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['All caps message help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['All caps subject label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="1"<?php if ($pun_config['p_subject_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="0"<?php if ($pun_config['p_subject_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['All caps subject help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Require e-mail label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[force_guest_email]" value="1"<?php if ($pun_config['p_force_guest_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[force_guest_email]" value="0"<?php if ($pun_config['p_force_guest_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Require e-mail help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_permissions['Signatures subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_permissions['BBCode sigs label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="1"<?php if ($pun_config['p_sig_bbcode'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="0"<?php if ($pun_config['p_sig_bbcode'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['BBCode sigs help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Image tag sigs label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="1"<?php if ($pun_config['p_sig_img_tag'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="0"<?php if ($pun_config['p_sig_img_tag'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Image tag sigs help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['All caps sigs label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="1"<?php if ($pun_config['p_sig_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="0"<?php if ($pun_config['p_sig_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['All caps sigs help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Max sig length label'] ?></th>									<td>										<input type="text" name="form[sig_length]" size="5" maxlength="5" value="<?php echo $pun_config['p_sig_length'] ?>" />										<span class="clearb"><?php echo $lang_admin_permissions['Max sig length help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Max sig lines label'] ?></th>									<td>										<input type="text" name="form[sig_lines]" size="3" maxlength="3" value="<?php echo $pun_config['p_sig_lines'] ?>" />										<span class="clearb"><?php echo $lang_admin_permissions['Max sig lines help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_permissions['Registration subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Banned e-mail label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="1"<?php if ($pun_config['p_allow_banned_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="0"<?php if ($pun_config['p_allow_banned_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Banned e-mail help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Duplicate e-mail label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="1"<?php if ($pun_config['p_allow_dupe_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="0"<?php if ($pun_config['p_allow_dupe_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Duplicate e-mail help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" /></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');$action = isset($_GET['action']) ? $_GET['action'] : null;$id = isset($_GET['id']) ? intval($_GET['id']) : 0;$pid = isset($_GET['pid']) ? intval($_GET['pid']) : 0;if ($id < 1 && $pid < 1)	message($lang_common['Bad request'], false, '404 Not Found');// Load the viewtopic.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/topic.php';// If a post ID is specified we determine topic ID and page number so we can redirect to the correct messageif ($pid){	$result = $db->query('SELECT topic_id, posted FROM '.$db->prefix.'posts WHERE id='.$pid) or error('Unable to fetch topic ID', __FILE__, __LINE__, $db->error());	if (!$db->num_rows($result))		message($lang_common['Bad request'], false, '404 Not Found');	list($id, $posted) = $db->fetch_row($result);	// Determine on which page the post is located (depending on $forum_user['disp_posts'])	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'posts WHERE topic_id='.$id.' AND posted<'.$posted) or error('Unable to count previous posts', __FILE__, __LINE__, $db->error());	$num_posts = $db->result($result) + 1;	$_GET['p'] = ceil($num_posts / $pun_user['disp_posts']);}// If action=new, we redirect to the first new post (if any)else if ($action == 'new'){	if (!$pun_user['is_guest'])	{		// We need to check if this topic has been viewed recently by the user		$tracked_topics = get_tracked_topics();		$last_viewed = isset($tracked_topics['topics'][$id]) ? $tracked_topics['topics'][$id] : $pun_user['last_visit'];		$result = $db->query('SELECT MIN(id) FROM '.$db->prefix.'posts WHERE topic_id='.$id.' AND posted>'.$last_viewed) or error('Unable to fetch first new post info', __FILE__, __LINE__, $db->error());		$first_new_post_id = $db->result($result);		if ($first_new_post_id)		{			header('Location: viewtopic.php?pid='.$first_new_post_id.'#p'.$first_new_post_id);			exit;		}	}	// If there is no new post, we go to the last post	header('Location: viewtopic.php?id='.$id.'&action=last');	exit;}// If action=last, we redirect to the last postelse if ($action == 'last'){	$result = $db->query('SELECT MAX(id) FROM '.$db->prefix.'posts WHERE topic_id='.$id) or error('Unable to fetch last post info', __FILE__, __LINE__, $db->error());	$last_post_id = $db->result($result);	if ($last_post_id)	{		header('Location: viewtopic.php?pid='.$last_post_id.'#p'.$last_post_id);		exit;	}}// Fetch some info about the topicif (!$pun_user['is_guest'])	$result = $db->query('SELECT t.subject, t.closed, t.num_replies, t.sticky, t.first_post_id, f.id AS forum_id, f.forum_name, f.moderators, fp.post_replies, s.user_id AS is_subscribed FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'topic_subscriptions AS s ON (t.id=s.topic_id AND s.user_id='.$pun_user['id'].') LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.id='.$id.' AND t.moved_to IS NULL') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());else	$result = $db->query('SELECT t.subject, t.closed, t.num_replies, t.sticky, t.first_post_id, f.id AS forum_id, f.forum_name, f.moderators, fp.post_replies, 0 AS is_subscribed FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.id='.$id.' AND t.moved_to IS NULL') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());if (!$db->num_rows($result))	message($lang_common['Bad request'], false, '404 Not Found');$cur_topic = $db->fetch_assoc($result);// Sort out who the moderators are and if we are currently a moderator (or an admin)$mods_array = ($cur_topic['moderators'] != '') ? unserialize($cur_topic['moderators']) : array();$is_admmod = ($pun_user['g_id'] == PUN_ADMIN || ($pun_user['g_moderator'] == '1' && array_key_exists($pun_user['username'], $mods_array))) ? true : false;// Can we or can we not post replies?if ($cur_topic['closed'] == '0'){	if (($cur_topic['post_replies'] == '' && $pun_user['g_post_replies'] == '1') || $cur_topic['post_replies'] == '1' || $is_admmod)		$post_link = "\t\t\t".'<p class="postlink conr"><a href="post.php?tid='.$id.'">'.$lang_topic['Post reply'].'</a></p>'."\n";	else		$post_link = '';}else{	$post_link = $lang_topic['Topic closed'];	if ($is_admmod)		$post_link .= ' / <a href="post.php?tid='.$id.'">'.$lang_topic['Post reply'].'</a>';	$post_link = "\t\t\t".'<p class="postlink conr">'.$post_link.'</p>'."\n";}// Add/update this topic in our list of tracked topicsif (!$pun_user['is_guest']){	$tracked_topics = get_tracked_topics();	$tracked_topics['topics'][$id] = time();	set_tracked_topics($tracked_topics);}// Determine the post offset (based on $_GET['p'])$num_pages = ceil(($cur_topic['num_replies'] + 1) / $pun_user['disp_posts']);$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);$start_from = $pun_user['disp_posts'] * ($p - 1);// Generate paging links$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'viewtopic.php?id='.$id);if ($pun_config['o_censoring'] == '1')	$cur_topic['subject'] = censor_words($cur_topic['subject']);$quickpost = false;if ($pun_config['o_quickpost'] == '1' &&	($cur_topic['post_replies'] == '1' || ($cur_topic['post_replies'] == '' && $pun_user['g_post_replies'] == '1')) &&	($cur_topic['closed'] == '0' || $is_admmod)){	// Load the post.php language file	require PUN_ROOT.'lang/'.$pun_user['language'].'/post.php';	$required_fields = array('req_message' => $lang_common['Message']);	if ($pun_user['is_guest'])	{		$required_fields['req_username'] = $lang_post['Guest name'];		if ($pun_config['p_force_guest_email'] == '1')			$required_fields['req_email'] = $lang_common['Email'];	}	$quickpost = true;}if (!$pun_user['is_guest'] && $pun_config['o_topic_subscriptions'] == '1'){	if ($cur_topic['is_subscribed'])		// I apologize for the variable naming here. It's a mix of subscription and action I guess :-)		$subscraction = "\t\t".'<p class="subscribelink clearb"><span>'.$lang_topic['Is subscribed'].' - </span><a href="misc.php?action=unsubscribe&amp;tid='.$id.'">'.$lang_topic['Unsubscribe'].'</a></p>'."\n";	else		$subscraction = "\t\t".'<p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid='.$id.'">'.$lang_topic['Subscribe'].'</a></p>'."\n";}else	$subscraction = '';if ($pun_config['o_feed_type'] == '1')	$page_head = array('feed' => '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;tid='.$id.'&amp;type=rss" title="'.$lang_common['RSS topic feed'].'" />');else if ($pun_config['o_feed_type'] == '2')	$page_head = array('feed' => '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid='.$id.'&amp;type=atom" title="'.$lang_common['Atom topic feed'].'" />');$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), pun_htmlspecialchars($cur_topic['forum_name']), pun_htmlspecialchars($cur_topic['subject']));define('PUN_ALLOW_INDEX', 1);define('PUN_ACTIVE_PAGE', 'index');require PUN_ROOT.'header.php';?><div class="linkst">	<div class="inbox crumbsplus">		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="viewforum.php?id=<?php echo $cur_topic['forum_id'] ?>"><?php echo pun_htmlspecialchars($cur_topic['forum_name']) ?></a></li>			<li><span>&#160;</span><strong><a href="viewtopic.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></a></strong></li>		</ul>		<div class="pagepost">			<p class="pagelink conl"><?php echo $paging_links ?></p><?php echo $post_link ?>		</div>		<div class="clearer"></div>	</div></div><?phprequire PUN_ROOT.'include/parser.php';$post_count = 0; // Keep track of post numbers// Retrieve a list of post IDs, LIMIT is (really) expensive so we only fetch the IDs here then later fetch the remaining data$result = $db->query('SELECT id FROM '.$db->prefix.'posts WHERE topic_id='.$id.' ORDER BY id LIMIT '.$start_from.','.$pun_user['disp_posts']) or error('Unable to fetch post IDs', __FILE__, __LINE__, $db->error());$post_ids = array();for ($i = 0;$cur_post_id = $db->result($result, $i);$i++)	$post_ids[] = $cur_post_id;if (empty($post_ids))	error('The post table and topic table seem to be out of sync!', __FILE__, __LINE__);// Retrieve the posts (and their respective poster/online status)$result = $db->query('SELECT u.email, u.title, u.url, u.location, u.signature, u.email_setting, u.num_posts, u.registered, u.admin_note, p.id, p.poster AS username, p.poster_id, p.poster_ip, p.poster_email, p.message, p.hide_smilies, p.posted, p.edited, p.edited_by, g.g_id, g.g_user_title, o.user_id AS is_online FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'users AS u ON u.id=p.poster_id INNER JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id LEFT JOIN '.$db->prefix.'online AS o ON (o.user_id=u.id AND o.user_id!=1 AND o.idle=0) WHERE p.id IN ('.implode(',', $post_ids).') ORDER BY p.id', true) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());while ($cur_post = $db->fetch_assoc($result)){	$post_count++;	$user_avatar = '';	$user_info = array();	$user_contacts = array();	$post_actions = array();	$is_online = '';	$signature = '';	// If the poster is a registered user	if ($cur_post['poster_id'] > 1)	{		if ($pun_user['g_view_users'] == '1')			$username = '<a href="profile.php?id='.$cur_post['poster_id'].'">'.pun_htmlspecialchars($cur_post['username']).'</a>';		else			$username = pun_htmlspecialchars($cur_post['username']);		$user_title = get_title($cur_post);		if ($pun_config['o_censoring'] == '1')			$user_title = censor_words($user_title);		// Format the online indicator		$is_online = ($cur_post['is_online'] == $cur_post['poster_id']) ? '<strong>'.$lang_topic['Online'].'</strong>' : '<span>'.$lang_topic['Offline'].'</span>';		if ($pun_config['o_avatars'] == '1' && $pun_user['show_avatars'] != '0')		{			if (isset($user_avatar_cache[$cur_post['poster_id']]))				$user_avatar = $user_avatar_cache[$cur_post['poster_id']];			else				$user_avatar = $user_avatar_cache[$cur_post['poster_id']] = generate_avatar_markup($cur_post['poster_id']);		}		// We only show location, register date, post count and the contact links if "Show user info" is enabled		if ($pun_config['o_show_user_info'] == '1')		{			if ($cur_post['location'] != '')			{				if ($pun_config['o_censoring'] == '1')					$cur_post['location'] = censor_words($cur_post['location']);				$user_info[] = '<dd><span>'.$lang_topic['From'].' '.pun_htmlspecialchars($cur_post['location']).'</span></dd>';			}			$user_info[] = '<dd><span>'.$lang_topic['Registered'].' '.format_time($cur_post['registered'], true).'</span></dd>';			if ($pun_config['o_show_post_count'] == '1' || $pun_user['is_admmod'])				$user_info[] = '<dd><span>'.$lang_topic['Posts'].' '.forum_number_format($cur_post['num_posts']).'</span></dd>';			// Now let's deal with the contact links (Email and URL)			if ((($cur_post['email_setting'] == '0' && !$pun_user['is_guest']) || $pun_user['is_admmod']) && $pun_user['g_send_email'] == '1')				$user_contacts[] = '<span class="email"><a href="mailto:'.$cur_post['email'].'">'.$lang_common['Email'].'</a></span>';			else if ($cur_post['email_setting'] == '1' && !$pun_user['is_guest'] && $pun_user['g_send_email'] == '1')				$user_contacts[] = '<span class="email"><a href="misc.php?email='.$cur_post['poster_id'].'">'.$lang_common['Email'].'</a></span>';			if ($cur_post['url'] != '')			{				if ($pun_config['o_censoring'] == '1')					$cur_post['url'] = censor_words($cur_post['url']);				$user_contacts[] = '<span class="website"><a href="'.pun_htmlspecialchars($cur_post['url']).'" rel="nofollow">'.$lang_topic['Website'].'</a></span>';			}		}		if ($pun_user['is_admmod'])		{			$user_info[] = '<dd><span><a href="moderate.php?get_host='.$cur_post['id'].'" title="'.pun_htmlspecialchars($cur_post['poster_ip']).'">'.$lang_topic['IP address logged'].'</a></span></dd>';			if ($cur_post['admin_note'] != '')				$user_info[] = '<dd><span>'.$lang_topic['Note'].' <strong>'.pun_htmlspecialchars($cur_post['admin_note']).'</strong></span></dd>';		}	}	// If the poster is a guest (or a user that has been deleted)	else	{		$username = pun_htmlspecialchars($cur_post['username']);		$user_title = get_title($cur_post);		if ($pun_user['is_admmod'])			$user_info[] = '<dd><span><a href="moderate.php?get_host='.$cur_post['id'].'" title="'.pun_htmlspecialchars($cur_post['poster_ip']).'">'.$lang_topic['IP address logged'].'</a></span></dd>';		if ($pun_config['o_show_user_info'] == '1' && $cur_post['poster_email'] != '' && !$pun_user['is_guest'] && $pun_user['g_send_email'] == '1')			$user_contacts[] = '<span class="email"><a href="mailto:'.$cur_post['poster_email'].'">'.$lang_common['Email'].'</a></span>';	}	// Generation post action array (quote, edit, delete etc.)	if (!$is_admmod)	{		if (!$pun_user['is_guest'])			$post_actions[] = '<li class="postreport"><span><a href="misc.php?report='.$cur_post['id'].'">'.$lang_topic['Report'].'</a></span></li>';		if ($cur_topic['closed'] == '0')		{			if ($cur_post['poster_id'] == $pun_user['id'])			{				if ((($start_from + $post_count) == 1 && $pun_user['g_delete_topics'] == '1') || (($start_from + $post_count) > 1 && $pun_user['g_delete_posts'] == '1'))					$post_actions[] = '<li class="postdelete"><span><a href="delete.php?id='.$cur_post['id'].'">'.$lang_topic['Delete'].'</a></span></li>';				if ($pun_user['g_edit_posts'] == '1')					$post_actions[] = '<li class="postedit"><span><a href="edit.php?id='.$cur_post['id'].'">'.$lang_topic['Edit'].'</a></span></li>';			}			if (($cur_topic['post_replies'] == '' && $pun_user['g_post_replies'] == '1') || $cur_topic['post_replies'] == '1')				$post_actions[] = '<li class="postquote"><span><a href="post.php?tid='.$id.'&amp;qid='.$cur_post['id'].'">'.$lang_topic['Quote'].'</a></span></li>';		}	}	else	{		$post_actions[] = '<li class="postreport"><span><a href="misc.php?report='.$cur_post['id'].'">'.$lang_topic['Report'].'</a></span></li>';		$post_actions[] = '<li class="postdelete"><span><a href="delete.php?id='.$cur_post['id'].'">'.$lang_topic['Delete'].'</a></span></li>';		$post_actions[] = '<li class="postedit"><span><a href="edit.php?id='.$cur_post['id'].'">'.$lang_topic['Edit'].'</a></span></li>';		$post_actions[] = '<li class="postquote"><span><a href="post.php?tid='.$id.'&amp;qid='.$cur_post['id'].'">'.$lang_topic['Quote'].'</a></span></li>';	}	// Perform the main parsing of the message (BBCode, smilies, censor words etc)	$cur_post['message'] = parse_message($cur_post['message'], $cur_post['hide_smilies']);	// Do signature parsing/caching	if ($pun_config['o_signatures'] == '1' && $cur_post['signature'] != '' && $pun_user['show_sig'] != '0')	{		if (isset($signature_cache[$cur_post['poster_id']]))			$signature = $signature_cache[$cur_post['poster_id']];		else		{			$signature = parse_signature($cur_post['signature']);			$signature_cache[$cur_post['poster_id']] = $signature;		}	}?><div id="p<?php echo $cur_post['id'] ?>" class="blockpost<?php echo ($post_count % 2 == 0) ? ' roweven' : ' rowodd' ?><?php if ($cur_post['id'] == $cur_topic['first_post_id']) echo ' firstpost'; ?><?php if ($post_count == 1) echo ' blockpost1'; ?>">	<h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <a href="viewtopic.php?pid=<?php echo $cur_post['id'].'#p'.$cur_post['id'] ?>"><?php echo format_time($cur_post['posted']) ?></a></span></h2>	<div class="box">		<div class="inbox">			<div class="postbody">				<div class="postleft">					<dl>						<dt><strong><?php echo $username ?></strong></dt>						<dd class="usertitle"><strong><?php echo $user_title ?></strong></dd><?php if ($user_avatar != '') echo "\t\t\t\t\t\t".'<dd class="postavatar">'.$user_avatar.'</dd>'."\n"; ?><?php if (count($user_info)) echo "\t\t\t\t\t\t".implode("\n\t\t\t\t\t\t", $user_info)."\n"; ?><?php if (count($user_contacts)) echo "\t\t\t\t\t\t".'<dd class="usercontacts">'.implode(' ', $user_contacts).'</dd>'."\n"; ?>					</dl>				</div>				<div class="postright">					<h3><?php if ($cur_post['id'] != $cur_topic['first_post_id']) echo $lang_topic['Re'].' '; ?><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></h3>					<div class="postmsg">						<?php echo $cur_post['message']."\n" ?><?php if ($cur_post['edited'] != '') echo "\t\t\t\t\t\t".'<p class="postedit"><em>'.$lang_topic['Last edit'].' '.pun_htmlspecialchars($cur_post['edited_by']).' ('.format_time($cur_post['edited']).')</em></p>'."\n"; ?>					</div><?php if ($signature != '') echo "\t\t\t\t\t".'<div class="postsignature postmsg"><hr />'.$signature.'</div>'."\n"; ?>				</div>			</div>		</div>		<div class="inbox">			<div class="postfoot clearb">				<div class="postfootleft"><?php if ($cur_post['poster_id'] > 1) echo '<p>'.$is_online.'</p>'; ?></div><?php if (count($post_actions)) echo "\t\t\t\t".'<div class="postfootright">'."\n\t\t\t\t\t".'<ul>'."\n\t\t\t\t\t\t".implode("\n\t\t\t\t\t\t", $post_actions)."\n\t\t\t\t\t".'</ul>'."\n\t\t\t\t".'</div>'."\n" ?>			</div>		</div>	</div></div><?php}?><div class="postlinksb">	<div class="inbox crumbsplus">		<div class="pagepost">			<p class="pagelink conl"><?php echo $paging_links ?></p><?php echo $post_link ?>		</div>		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="viewforum.php?id=<?php echo $cur_topic['forum_id'] ?>"><?php echo pun_htmlspecialchars($cur_topic['forum_name']) ?></a></li>			<li><span>&#160;</span><strong><a href="viewtopic.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></a></strong></li>		</ul><?php echo $subscraction ?>		<div class="clearer"></div>	</div></div><?php// Display quick post if enabledif ($quickpost){$cur_index = 1;?><div id="quickpost" class="blockform">	<h2><span><?php echo $lang_topic['Quick post'] ?></span></h2>	<div class="box">		<form id="quickpostform" method="post" action="post.php?tid=<?php echo $id ?>" onsubmit="this.submit.disabled=true;if(process_form(this)){return true;}else{this.submit.disabled=false;return false;}">			<div class="inform">				<fieldset>					<legend><?php echo $lang_common['Write message legend'] ?></legend>					<div class="infldset txtarea">						<input type="hidden" name="form_sent" value="1" /><?php if ($pun_config['o_topic_subscriptions'] == '1' && ($pun_user['auto_notify'] == '1' || $cur_topic['is_subscribed'])): ?>						<input type="hidden" name="subscribe" value="1" /><?php endif; ?><?phpif ($pun_user['is_guest']){	$email_label = ($pun_config['p_force_guest_email'] == '1') ? '<strong>'.$lang_common['Email'].' <span>'.$lang_common['Required'].'</span></strong>' : $lang_common['Email'];	$email_form_name = ($pun_config['p_force_guest_email'] == '1') ? 'req_email' : 'email';?>						<label class="conl required"><strong><?php echo $lang_post['Guest name'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" value="<?php if (isset($_POST['req_username'])) echo pun_htmlspecialchars($username); ?>" size="25" maxlength="25" tabindex="<?php echo $cur_index++ ?>" /><br /></label>						<label class="conl<?php echo ($pun_config['p_force_guest_email'] == '1') ? ' required' : '' ?>"><?php echo $email_label ?><br /><input type="text" name="<?php echo $email_form_name ?>" value="<?php if (isset($_POST[$email_form_name])) echo pun_htmlspecialchars($email); ?>" size="50" maxlength="80" tabindex="<?php echo $cur_index++ ?>" /><br /></label>						<div class="clearer"></div><?php	echo "\t\t\t\t\t\t".'<label class="required"><strong>'.$lang_common['Message'].' <span>'.$lang_common['Required'].'</span></strong><br />';}else	echo "\t\t\t\t\t\t".'<label>';?><textarea name="req_message" rows="7" cols="75" tabindex="<?php echo $cur_index++ ?>"></textarea></label>						<ul class="bblinks">							<li><span><a href="help.php#bbcode" onclick="window.open(this.href); return false;"><?php echo $lang_common['BBCode'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>							<li><span><a href="help.php#url" onclick="window.open(this.href); return false;"><?php echo $lang_common['url tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_user['g_post_links'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>							<li><span><a href="help.php#img" onclick="window.open(this.href); return false;"><?php echo $lang_common['img tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_config['p_message_img_tag'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>							<li><span><a href="help.php#smilies" onclick="window.open(this.href); return false;"><?php echo $lang_common['Smilies'] ?></a> <?php echo ($pun_config['o_smilies'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>						</ul>					</div>				</fieldset>			</div>			<p class="buttons"><input type="submit" name="submit" tabindex="<?php echo $cur_index++ ?>" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_topic['Preview'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="p" /></p>		</form>	</div></div><?php}// Increment "num_views" for topicif ($pun_config['o_topic_views'] == '1')	$db->query('UPDATE '.$db->prefix.'topics SET num_views=num_views+1 WHERE id='.$id) or error('Unable to update topic', __FILE__, __LINE__, $db->error());$forum_id = $cur_topic['forum_id'];$footer_style = 'viewtopic';require PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Make sure no one attempts to run this script "directly"if (!defined('PUN'))	exit;// Send no-cache headersheader('Expires: Thu, 21 Jul 1977 07:30:00 GMT'); // When yours truly first set eyes on this world! :)header('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT');header('Cache-Control: post-check=0, pre-check=0', false);header('Pragma: no-cache'); // For HTTP/1.0 compatibility// Send the Content-type header in case the web server is setup to send something elseheader('Content-type: text/html; charset=utf-8');// Load the templateif (defined('PUN_ADMIN_CONSOLE'))	$tpl_file = 'admin.tpl';else if (defined('PUN_HELP'))	$tpl_file = 'help.tpl';else	$tpl_file = 'main.tpl';if (file_exists(PUN_ROOT.'style/'.$pun_user['style'].'/'.$tpl_file)){	$tpl_file = PUN_ROOT.'style/'.$pun_user['style'].'/'.$tpl_file;	$tpl_inc_dir = PUN_ROOT.'style/'.$pun_user['style'].'/';}else{	$tpl_file = PUN_ROOT.'include/template/'.$tpl_file;	$tpl_inc_dir = PUN_ROOT.'include/user/';}$tpl_main = file_get_contents($tpl_file);// START SUBST - <pun_include "*">preg_match_all('%<pun_include "([^"]+)">%i', $tpl_main, $pun_includes, PREG_SET_ORDER);foreach ($pun_includes as $cur_include){	ob_start();	$file_info = pathinfo($cur_include[1]);		if (!in_array($file_info['extension'], array('php', 'php4', 'php5', 'inc', 'html', 'txt'))) // Allow some extensions		error(sprintf($lang_common['Pun include extension'], pun_htmlspecialchars($cur_include[0]), basename($tpl_file), pun_htmlspecialchars($file_info['extension'])));			if (strpos($file_info['dirname'], '..') !== false) // Don't allow directory traversal		error(sprintf($lang_common['Pun include directory'], pun_htmlspecialchars($cur_include[0]), basename($tpl_file)));	// Allow for overriding user includes, too.	if (file_exists($tpl_inc_dir.$cur_include[1]))		require $tpl_inc_dir.$cur_include[1];	else if (file_exists(PUN_ROOT.'include/user/'.$cur_include[1]))		require PUN_ROOT.'include/user/'.$cur_include[1];	else		error(sprintf($lang_common['Pun include error'], pun_htmlspecialchars($cur_include[0]), basename($tpl_file)));	$tpl_temp = ob_get_contents();	$tpl_main = str_replace($cur_include[0], $tpl_temp, $tpl_main);	ob_end_clean();}// END SUBST - <pun_include "*">// START SUBST - <pun_language>$tpl_main = str_replace('<pun_language>', $lang_common['lang_identifier'], $tpl_main);// END SUBST - <pun_language>// START SUBST - <pun_content_direction>$tpl_main = str_replace('<pun_content_direction>', $lang_common['lang_direction'], $tpl_main);// END SUBST - <pun_content_direction>// START SUBST - <pun_head>ob_start();// Define $p if it's not set to avoid a PHP notice$p = isset($p) ? $p : null;// Is this a page that we want search index spiders to index?if (!defined('PUN_ALLOW_INDEX'))	echo '<meta name="ROBOTS" content="NOINDEX, FOLLOW" />'."\n";?><title><?php echo generate_page_title($page_title, $p) ?></title><link rel="stylesheet" type="text/css" href="style/<?php echo $pun_user['style'].'.css' ?>" /><?phpif (defined('PUN_ADMIN_CONSOLE')){	if (file_exists(PUN_ROOT.'style/'.$pun_user['style'].'/base_admin.css'))		echo '<link rel="stylesheet" type="text/css" href="style/'.$pun_user['style'].'/base_admin.css" />'."\n";	else		echo '<link rel="stylesheet" type="text/css" href="style/imports/base_admin.css" />'."\n";}if (isset($required_fields)){	// Output JavaScript to validate form (make sure required fields are filled out)?><script type="text/javascript">/* <![CDATA[ */function process_form(the_form){	var required_fields = {<?php	// Output a JavaScript object with localised field names	$tpl_temp = count($required_fields);	foreach ($required_fields as $elem_orig => $elem_trans)	{		echo "\t\t\"".$elem_orig.'": "'.addslashes(str_replace('&#160;', ' ', $elem_trans));		if (--$tpl_temp) echo "\",\n";		else echo "\"\n\t};\n";	}?>	if (document.all || document.getElementById)	{		for (var i = 0; i < the_form.length; ++i)		{			var elem = the_form.elements[i];			if (elem.name && required_fields[elem.name] && !elem.value && elem.type && (/^(?:text(?:area)?|password|file)$/i.test(elem.type)))			{				alert('"' + required_fields[elem.name] + '" <?php echo $lang_common['required field'] ?>');				elem.focus();				return false;			}		}	}	return true;}/* ]]> */</script><?php}// JavaScript tricks for IE6 and olderecho '<!--[if lte IE 6]><script type="text/javascript" src="style/imports/minmax.js"></script><![endif]-->'."\n";if (isset($page_head))	echo implode("\n", $page_head)."\n";$tpl_temp = trim(ob_get_contents());$tpl_main = str_replace('<pun_head>', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <pun_head>// START SUBST - <body>if (isset($focus_element)){	$tpl_main = str_replace('<body onload="', '<body onload="document.getElementById(\''.$focus_element[0].'\').elements[\''.$focus_element[1].'\'].focus();', $tpl_main);	$tpl_main = str_replace('<body>', '<body onload="document.getElementById(\''.$focus_element[0].'\').elements[\''.$focus_element[1].'\'].focus()">', $tpl_main);}// END SUBST - <body>// START SUBST - <pun_page>$tpl_main = str_replace('<pun_page>', htmlspecialchars(basename($_SERVER['PHP_SELF'], '.php')), $tpl_main);// END SUBST - <pun_page>// START SUBST - <pun_title>$tpl_main = str_replace('<pun_title>', '<h1><a href="index.php">'.pun_htmlspecialchars($pun_config['o_board_title']).'</a></h1>', $tpl_main);// END SUBST - <pun_title>// START SUBST - <pun_desc>$tpl_main = str_replace('<pun_desc>', '<div id="brddesc">'.$pun_config['o_board_desc'].'</div>', $tpl_main);// END SUBST - <pun_desc>// START SUBST - <pun_navlinks>$links = array();// Index should always be displayed$links[] = '<li id="navindex"'.((PUN_ACTIVE_PAGE == 'index') ? ' class="isactive"' : '').'><a href="index.php">'.$lang_common['Index'].'</a></li>';if ($pun_user['g_read_board'] == '1' && $pun_user['g_view_users'] == '1')	$links[] = '<li id="navuserlist"'.((PUN_ACTIVE_PAGE == 'userlist') ? ' class="isactive"' : '').'><a href="userlist.php">'.$lang_common['User list'].'</a></li>';if ($pun_config['o_rules'] == '1' && (!$pun_user['is_guest'] || $pun_user['g_read_board'] == '1' || $pun_config['o_regs_allow'] == '1'))	$links[] = '<li id="navrules"'.((PUN_ACTIVE_PAGE == 'rules') ? ' class="isactive"' : '').'><a href="misc.php?action=rules">'.$lang_common['Rules'].'</a></li>';if ($pun_user['g_read_board'] == '1' && $pun_user['g_search'] == '1')	$links[] = '<li id="navsearch"'.((PUN_ACTIVE_PAGE == 'search') ? ' class="isactive"' : '').'><a href="search.php">'.$lang_common['Search'].'</a></li>';if ($pun_user['is_guest']){	$links[] = '<li id="navregister"'.((PUN_ACTIVE_PAGE == 'register') ? ' class="isactive"' : '').'><a href="register.php">'.$lang_common['Register'].'</a></li>';	$links[] = '<li id="navlogin"'.((PUN_ACTIVE_PAGE == 'login') ? ' class="isactive"' : '').'><a href="login.php">'.$lang_common['Login'].'</a></li>';}else{	$links[] = '<li id="navprofile"'.((PUN_ACTIVE_PAGE == 'profile') ? ' class="isactive"' : '').'><a href="profile.php?id='.$pun_user['id'].'">'.$lang_common['Profile'].'</a></li>';	if ($pun_user['is_admmod'])		$links[] = '<li id="navadmin"'.((PUN_ACTIVE_PAGE == 'admin') ? ' class="isactive"' : '').'><a href="admin_index.php">'.$lang_common['Admin'].'</a></li>';	$links[] = '<li id="navlogout"><a href="login.php?action=out&amp;id='.$pun_user['id'].'&amp;csrf_token='.pun_hash($pun_user['id'].pun_hash(get_remote_address())).'">'.$lang_common['Logout'].'</a></li>';}// Are there any additional navlinks we should insert into the array before imploding it?if ($pun_user['g_read_board'] == '1' && $pun_config['o_additional_navlinks'] != ''){	if (preg_match_all('%([0-9]+)\s*=\s*(.*?)\n%s', $pun_config['o_additional_navlinks']."\n", $extra_links))	{		// Insert any additional links into the $links array (at the correct index)		$num_links = count($extra_links[1]);		for ($i = 0; $i < $num_links; ++$i)			array_splice($links, $extra_links[1][$i], 0, array('<li id="navextra'.($i + 1).'">'.$extra_links[2][$i].'</li>'));	}}$tpl_temp = '<div id="brdmenu" class="inbox">'."\n\t\t\t".'<ul>'."\n\t\t\t\t".implode("\n\t\t\t\t", $links)."\n\t\t\t".'</ul>'."\n\t\t".'</div>';$tpl_main = str_replace('<pun_navlinks>', $tpl_temp, $tpl_main);// END SUBST - <pun_navlinks>// START SUBST - <pun_status>$page_statusinfo = $page_topicsearches = array();if ($pun_user['is_guest'])	$page_statusinfo = '<p class="conl">'.$lang_common['Not logged in'].'</p>';else{	$page_statusinfo[] = '<li><span>'.$lang_common['Logged in as'].' <strong>'.pun_htmlspecialchars($pun_user['username']).'</strong></span></li>';	$page_statusinfo[] = '<li><span>'.sprintf($lang_common['Last visit'], format_time($pun_user['last_visit'])).'</span></li>';	if ($pun_user['is_admmod'])	{		if ($pun_config['o_report_method'] == '0' || $pun_config['o_report_method'] == '2')		{			$result_header = $db->query('SELECT 1 FROM '.$db->prefix.'reports WHERE zapped IS NULL') or error('Unable to fetch reports info', __FILE__, __LINE__, $db->error());			if ($db->result($result_header))				$page_statusinfo[] = '<li class="reportlink"><span><strong><a href="admin_reports.php">'.$lang_common['New reports'].'</a></strong></span></li>';		}		if ($pun_config['o_maintenance'] == '1')			$page_statusinfo[] = '<li class="maintenancelink"><span><strong><a href="admin_options.php#maintenance">'.$lang_common['Maintenance mode enabled'].'</a></strong></span></li>';	}	if ($pun_user['g_read_board'] == '1' && $pun_user['g_search'] == '1')	{		$page_topicsearches[] = '<a href="search.php?action=show_replies" title="'.$lang_common['Show posted topics'].'">'.$lang_common['Posted topics'].'</a>';		$page_topicsearches[] = '<a href="search.php?action=show_new" title="'.$lang_common['Show new posts'].'">'.$lang_common['New posts header'].'</a>';	}}// Quick searchesif ($pun_user['g_read_board'] == '1' && $pun_user['g_search'] == '1'){	$page_topicsearches[] = '<a href="search.php?action=show_recent" title="'.$lang_common['Show active topics'].'">'.$lang_common['Active topics'].'</a>';	$page_topicsearches[] = '<a href="search.php?action=show_unanswered" title="'.$lang_common['Show unanswered topics'].'">'.$lang_common['Unanswered topics'].'</a>';}// Generate all that jazz$tpl_temp = '<div id="brdwelcome" class="inbox">';// The status informationif (is_array($page_statusinfo)){	$tpl_temp .= "\n\t\t\t".'<ul class="conl">';	$tpl_temp .= "\n\t\t\t\t".implode("\n\t\t\t\t", $page_statusinfo);	$tpl_temp .= "\n\t\t\t".'</ul>';}else	$tpl_temp .= "\n\t\t\t".$page_statusinfo;// Generate quicklinksif (!empty($page_topicsearches)){	$tpl_temp .= "\n\t\t\t".'<ul class="conr">';	$tpl_temp .= "\n\t\t\t\t".'<li><span>'.$lang_common['Topic searches'].' '.implode(' | ', $page_topicsearches).'</span></li>';	$tpl_temp .= "\n\t\t\t".'</ul>';}$tpl_temp .= "\n\t\t\t".'<div class="clearer"></div>'."\n\t\t".'</div>';$tpl_main = str_replace('<pun_status>', $tpl_temp, $tpl_main);// END SUBST - <pun_status>// START SUBST - <pun_announcement>if ($pun_user['g_read_board'] == '1' && $pun_config['o_announcement'] == '1'){	ob_start();?><div id="announce" class="block">	<div class="hd"><h2><span><?php echo $lang_common['Announcement'] ?></span></h2></div>	<div class="box">		<div id="announce-block" class="inbox">			<div class="usercontent"><?php echo $pun_config['o_announcement_message'] ?></div>		</div>	</div></div><?php	$tpl_temp = trim(ob_get_contents());	$tpl_main = str_replace('<pun_announcement>', $tpl_temp, $tpl_main);	ob_end_clean();}else	$tpl_main = str_replace('<pun_announcement>', '', $tpl_main);// END SUBST - <pun_announcement>// START SUBST - <pun_main>ob_start();define('PUN_HEADER', 1);
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);// Tell common.php that we don't want output bufferingdefine('PUN_DISABLE_BUFFERING', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_maintenance.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_maintenance.php';$action = isset($_REQUEST['action']) ? pun_trim($_REQUEST['action']) : '';if ($action == 'rebuild'){	$per_page = isset($_GET['i_per_page']) ? intval($_GET['i_per_page']) : 0;	$start_at = isset($_GET['i_start_at']) ? intval($_GET['i_start_at']) : 0;	// Check per page is > 0	if ($per_page < 1)		message($lang_admin_maintenance['Posts must be integer message']);	@set_time_limit(0);	// If this is the first cycle of posts we empty the search index before we proceed	if (isset($_GET['i_empty_index']))	{		// This is the only potentially "dangerous" thing we can do here, so we check the referer		confirm_referrer('admin_maintenance.php');		$db->truncate_table('search_matches') or error('Unable to empty search index match table', __FILE__, __LINE__, $db->error());		$db->truncate_table('search_words') or error('Unable to empty search index words table', __FILE__, __LINE__, $db->error());		// Reset the sequence for the search words (not needed for SQLite)		switch ($db_type)		{			case 'mysql':			case 'mysqli':			case 'mysql_innodb':			case 'mysqli_innodb':				$result = $db->query('ALTER TABLE '.$db->prefix.'search_words auto_increment=1') or error('Unable to update table auto_increment', __FILE__, __LINE__, $db->error());				break;			case 'pgsql';				$result = $db->query('SELECT setval(\''.$db->prefix.'search_words_id_seq\', 1, false)') or error('Unable to update sequence', __FILE__, __LINE__, $db->error());		}	}	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_maintenance['Rebuilding search index']);?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title><?php echo generate_page_title($page_title) ?></title><style type="text/css">body {	font: 12px Verdana, Arial, Helvetica, sans-serif;	color: #333333;	background-color: #FFFFFF}h1 {	font-size: 16px;	font-weight: normal;}</style></head><body><h1><?php echo $lang_admin_maintenance['Rebuilding index info'] ?></h1><hr /><?php	$query_str = '';	require PUN_ROOT.'include/search_idx.php';	// Fetch posts to process this cycle	$result = $db->query('SELECT p.id, p.message, t.subject, t.first_post_id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id WHERE p.id >= '.$start_at.' ORDER BY p.id ASC LIMIT '.$per_page) or error('Unable to fetch posts', __FILE__, __LINE__, $db->error());	$end_at = 0;	while ($cur_item = $db->fetch_assoc($result))	{		echo '<p><span>'.sprintf($lang_admin_maintenance['Processing post'], $cur_item['id']).'</span></p>'."\n";		if ($cur_item['id'] == $cur_item['first_post_id'])			update_search_index('post', $cur_item['id'], $cur_item['message'], $cur_item['subject']);		else			update_search_index('post', $cur_item['id'], $cur_item['message']);		$end_at = $cur_item['id'];	}	// Check if there is more work to do	if ($end_at > 0)	{		$result = $db->query('SELECT id FROM '.$db->prefix.'posts WHERE id > '.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to fetch next ID', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result) > 0)			$query_str = '?action=rebuild&i_per_page='.$per_page.'&i_start_at='.$db->result($result);	}	$db->end_transaction();	$db->close();	exit('<script type="text/javascript">window.location="admin_maintenance.php'.$query_str.'"</script><hr /><p>'.sprintf($lang_admin_maintenance['Javascript redirect failed'], '<a href="admin_maintenance.php'.$query_str.'">'.$lang_admin_maintenance['Click here'].'</a>').'</p>');}if ($action == 'prune'){	$prune_from = pun_trim($_POST['prune_from']);	$prune_sticky = intval($_POST['prune_sticky']);	if (isset($_POST['prune_comply']))	{		confirm_referrer('admin_maintenance.php');		$prune_days = intval($_POST['prune_days']);		$prune_date = ($prune_days) ? time() - ($prune_days * 86400) : -1;		@set_time_limit(0);		if ($prune_from == 'all')		{			$result = $db->query('SELECT id FROM '.$db->prefix.'forums') or error('Unable to fetch forum list', __FILE__, __LINE__, $db->error());			$num_forums = $db->num_rows($result);			for ($i = 0; $i < $num_forums; ++$i)			{				$fid = $db->result($result, $i);				prune($fid, $prune_sticky, $prune_date);				update_forum($fid);			}		}		else		{			$prune_from = intval($prune_from);			prune($prune_from, $prune_sticky, $prune_date);			update_forum($prune_from);		}		// Locate any "orphaned redirect topics" and delete them		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());		$num_orphans = $db->num_rows($result);		if ($num_orphans)		{			for ($i = 0; $i < $num_orphans; ++$i)				$orphans[] = $db->result($result, $i);			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());		}		redirect('admin_maintenance.php', $lang_admin_maintenance['Posts pruned redirect']);	}	$prune_days = pun_trim($_POST['req_prune_days']);	if ($prune_days == '' || preg_match('%[^0-9]%', $prune_days))		message($lang_admin_maintenance['Days must be integer message']);	$prune_date = time() - ($prune_days * 86400);	// Concatenate together the query for counting number of topics to prune	$sql = 'SELECT COUNT(id) FROM '.$db->prefix.'topics WHERE last_post<'.$prune_date.' AND moved_to IS NULL';	if ($prune_sticky == '0')		$sql .= ' AND sticky=0';	if ($prune_from != 'all')	{		$prune_from = intval($prune_from);		$sql .= ' AND forum_id='.$prune_from;		// Fetch the forum name (just for cosmetic reasons)		$result = $db->query('SELECT forum_name FROM '.$db->prefix.'forums WHERE id='.$prune_from) or error('Unable to fetch forum name', __FILE__, __LINE__, $db->error());		$forum = '"'.pun_htmlspecialchars($db->result($result)).'"';	}	else		$forum = $lang_admin_maintenance['All forums'];	$result = $db->query($sql) or error('Unable to fetch topic prune count', __FILE__, __LINE__, $db->error());	$num_topics = $db->result($result);	if (!$num_topics)		message(sprintf($lang_admin_maintenance['No old topics message'], $prune_days));	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Prune']);	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';	generate_admin_menu('maintenance');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_maintenance['Prune head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_maintenance.php">				<div class="inform">					<input type="hidden" name="action" value="prune" />					<input type="hidden" name="prune_days" value="<?php echo $prune_days ?>" />					<input type="hidden" name="prune_sticky" value="<?php echo $prune_sticky ?>" />					<input type="hidden" name="prune_from" value="<?php echo $prune_from ?>" />					<fieldset>						<legend><?php echo $lang_admin_maintenance['Confirm prune subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_maintenance['Confirm prune info'], $prune_days, $forum, forum_number_format($num_topics)) ?></p>							<p class="warntext"><?php echo $lang_admin_maintenance['Confirm prune warn'] ?></p>						</div>					</fieldset>				</div>				<p class="buttons"><input type="submit" name="prune_comply" value="<?php echo $lang_admin_common['Prune'] ?>" /><a href="javascript:history.go(-1)"><?php echo $lang_admin_common['Go back'] ?></a></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php	require PUN_ROOT.'footer.php';	exit;}// Get the first post ID from the db$result = $db->query('SELECT id FROM '.$db->prefix.'posts ORDER BY id ASC LIMIT 1') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());if ($db->num_rows($result))	$first_id = $db->result($result);$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Maintenance']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('maintenance');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_maintenance['Maintenance head'] ?></span></h2>		<div class="box">			<form method="get" action="admin_maintenance.php">				<div class="inform">					<input type="hidden" name="action" value="rebuild" />					<fieldset>						<legend><?php echo $lang_admin_maintenance['Rebuild index subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_maintenance['Rebuild index info'], '<a href="admin_options.php#maintenance">'.$lang_admin_common['Maintenance mode'].'</a>') ?></p>							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Posts per cycle label'] ?></th>									<td>										<input type="text" name="i_per_page" size="7" maxlength="7" value="300" tabindex="1" />										<span><?php echo $lang_admin_maintenance['Posts per cycle help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Starting post label'] ?></th>									<td>										<input type="text" name="i_start_at" size="7" maxlength="7" value="<?php echo (isset($first_id)) ? $first_id : 0 ?>" tabindex="2" />										<span><?php echo $lang_admin_maintenance['Starting post help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Empty index label'] ?></th>									<td class="inputadmin">										<label><input type="checkbox" name="i_empty_index" value="1" tabindex="3" checked="checked" />&#160;&#160;<?php echo $lang_admin_maintenance['Empty index help'] ?></label>									</td>								</tr>							</table>							<p class="topspace"><?php echo $lang_admin_maintenance['Rebuild completed info'] ?></p>							<div class="fsetsubmit"><input type="submit" name="rebuild_index" value="<?php echo $lang_admin_maintenance['Rebuild index'] ?>" tabindex="4" /></div>						</div>					</fieldset>				</div>			</form>			<form method="post" action="admin_maintenance.php" onsubmit="return process_form(this)">				<div class="inform">					<input type="hidden" name="action" value="prune" />					<fieldset>						<legend><?php echo $lang_admin_maintenance['Prune subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Days old label'] ?></th>									<td>										<input type="text" name="req_prune_days" size="3" maxlength="3" tabindex="5" />										<span><?php echo $lang_admin_maintenance['Days old help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Prune sticky label'] ?></th>									<td>										<label class="conl"><input type="radio" name="prune_sticky" value="1" tabindex="6" checked="checked" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="prune_sticky" value="0" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_maintenance['Prune sticky help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Prune from label'] ?></th>									<td>										<select name="prune_from" tabindex="7">											<option value="all"><?php echo $lang_admin_maintenance['All forums'] ?></option><?php	$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id WHERE f.redirect_url IS NULL ORDER BY c.disp_position, c.id, f.disp_position') or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());	$cur_category = 0;	while ($forum = $db->fetch_assoc($result))	{		if ($forum['cid'] != $cur_category) // Are we still in the same category?		{			if ($cur_category)				echo "\t\t\t\t\t\t\t\t\t\t\t".'</optgroup>'."\n";			echo "\t\t\t\t\t\t\t\t\t\t\t".'<optgroup label="'.pun_htmlspecialchars($forum['cat_name']).'">'."\n";			$cur_category = $forum['cid'];		}		echo "\t\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$forum['fid'].'">'.pun_htmlspecialchars($forum['forum_name']).'</option>'."\n";	}?>											</optgroup>										</select>										<span><?php echo $lang_admin_maintenance['Prune from help'] ?></span>									</td>								</tr>							</table>							<p class="topspace"><?php printf($lang_admin_maintenance['Prune info'], '<a href="admin_options.php#maintenance">'.$lang_admin_common['Maintenance mode'].'</a>') ?></p>							<div class="fsetsubmit"><input type="submit" name="prune" value="<?php echo $lang_admin_common['Prune'] ?>" tabindex="8" /></div>						</div>					</fieldset>				</div>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Make sure no one attempts to run this script "directly"if (!defined('PUN'))	exit;// Make sure we have a usable language pack for admin.if (file_exists(PUN_ROOT.'lang/'.$pun_user['language'].'/admin_common.php'))	$admin_language = $pun_user['language'];else if (file_exists(PUN_ROOT.'lang/'.$pun_config['o_default_lang'].'/admin_common.php'))	$admin_language = $pun_config['o_default_lang'];else	$admin_language = 'English';// Attempt to load the admin_common language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_common.php';//// Display the admin navigation menu//function generate_admin_menu($page = ''){	global $pun_config, $pun_user, $lang_admin_common;	$is_admin = $pun_user['g_id'] == PUN_ADMIN ? true : false;?><div id="adminconsole" class="block2col">	<div id="adminmenu" class="blockmenu">		<h2><span><?php echo $lang_admin_common['Moderator menu'] ?></span></h2>		<div class="box">			<div class="inbox">				<ul>					<li<?php if ($page == 'index') echo ' class="isactive"'; ?>><a href="admin_index.php"><?php echo $lang_admin_common['Index'] ?></a></li>					<li<?php if ($page == 'users') echo ' class="isactive"'; ?>><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li><?php if ($is_admin || $pun_user['g_mod_ban_users'] == '1'): ?>					<li<?php if ($page == 'bans') echo ' class="isactive"'; ?>><a href="admin_bans.php"><?php echo $lang_admin_common['Bans'] ?></a></li><?php endif; if ($is_admin || $pun_config['o_report_method'] == '0' || $pun_config['o_report_method'] == '2'): ?>					<li<?php if ($page == 'reports') echo ' class="isactive"'; ?>><a href="admin_reports.php"><?php echo $lang_admin_common['Reports'] ?></a></li><?php endif; ?>				</ul>			</div>		</div><?php	if ($is_admin)	{?>		<h2 class="block2"><span><?php echo $lang_admin_common['Admin menu'] ?></span></h2>		<div class="box">			<div class="inbox">				<ul>					<li<?php if ($page == 'options') echo ' class="isactive"'; ?>><a href="admin_options.php"><?php echo $lang_admin_common['Options'] ?></a></li>					<li<?php if ($page == 'permissions') echo ' class="isactive"'; ?>><a href="admin_permissions.php"><?php echo $lang_admin_common['Permissions'] ?></a></li>					<li<?php if ($page == 'categories') echo ' class="isactive"'; ?>><a href="admin_categories.php"><?php echo $lang_admin_common['Categories'] ?></a></li>					<li<?php if ($page == 'forums') echo ' class="isactive"'; ?>><a href="admin_forums.php"><?php echo $lang_admin_common['Forums'] ?></a></li>					<li<?php if ($page == 'groups') echo ' class="isactive"'; ?>><a href="admin_groups.php"><?php echo $lang_admin_common['User groups'] ?></a></li>					<li<?php if ($page == 'censoring') echo ' class="isactive"'; ?>><a href="admin_censoring.php"><?php echo $lang_admin_common['Censoring'] ?></a></li>					<li<?php if ($page == 'maintenance') echo ' class="isactive"'; ?>><a href="admin_maintenance.php"><?php echo $lang_admin_common['Maintenance'] ?></a></li>				</ul>			</div>		</div><?php	}	// See if there are any plugins	$plugins = forum_list_plugins($is_admin);	// Did we find any plugins?	if (!empty($plugins))	{?>		<h2 class="block2"><span><?php echo $lang_admin_common['Plugins menu'] ?></span></h2>		<div class="box">			<div class="inbox">				<ul><?php		foreach ($plugins as $plugin_name => $plugin)			echo "\t\t\t\t\t".'<li'.(($page == $plugin_name) ? ' class="isactive"' : '').'><a href="admin_loader.php?plugin='.$plugin_name.'">'.str_replace('_', ' ', $plugin).'</a></li>'."\n";?>				</ul>			</div>		</div><?php	}?>	</div><?php}//// Delete topics from $forum_id that are "older than" $prune_date (if $prune_sticky is 1, sticky topics will also be deleted)//function prune($forum_id, $prune_sticky, $prune_date){	global $db;	$extra_sql = ($prune_date != -1) ? ' AND last_post<'.$prune_date : '';	if (!$prune_sticky)		$extra_sql .= ' AND sticky=\'0\'';	// Fetch topics to prune	$result = $db->query('SELECT id FROM '.$db->prefix.'topics WHERE forum_id='.$forum_id.$extra_sql, true) or error('Unable to fetch topics', __FILE__, __LINE__, $db->error());	$topic_ids = '';	while ($row = $db->fetch_row($result))		$topic_ids .= (($topic_ids != '') ? ',' : '').$row[0];	if ($topic_ids != '')	{		// Fetch posts to prune		$result = $db->query('SELECT id FROM '.$db->prefix.'posts WHERE topic_id IN('.$topic_ids.')', true) or error('Unable to fetch posts', __FILE__, __LINE__, $db->error());		$post_ids = '';		while ($row = $db->fetch_row($result))			$post_ids .= (($post_ids != '') ? ',' : '').$row[0];		if ($post_ids != '')		{			// Delete topics			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.$topic_ids.')') or error('Unable to prune topics', __FILE__, __LINE__, $db->error());			// Delete subscriptions			$db->query('DELETE FROM '.$db->prefix.'topic_subscriptions WHERE topic_id IN('.$topic_ids.')') or error('Unable to prune subscriptions', __FILE__, __LINE__, $db->error());			// Delete posts			$db->query('DELETE FROM '.$db->prefix.'posts WHERE id IN('.$post_ids.')') or error('Unable to prune posts', __FILE__, __LINE__, $db->error());			// We removed a bunch of posts, so now we have to update the search index			require_once PUN_ROOT.'include/search_idx.php';			strip_search_index($post_ids);		}	}}
