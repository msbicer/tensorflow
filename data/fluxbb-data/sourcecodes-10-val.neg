<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// The contents of this file are very much inspired by the file search.php// from the phpBB Group forum software phpBB2 (http://www.phpbb.com)define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';// Load the search.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/search.php';require PUN_ROOT.'lang/'.$pun_user['language'].'/forum.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');else if ($pun_user['g_search'] == '0')	message($lang_search['No search permission'], false, '403 Forbidden');require PUN_ROOT.'include/search_idx.php';// Figure out what to do :-)if (isset($_GET['action']) || isset($_GET['search_id'])){	$action = (isset($_GET['action'])) ? $_GET['action'] : null;	$forums = isset($_GET['forums']) ? (is_array($_GET['forums']) ? $_GET['forums'] : array_filter(explode(',', $_GET['forums']))) : (isset($_GET['forum']) ? array($_GET['forum']) : array());	$sort_dir = (isset($_GET['sort_dir']) && $_GET['sort_dir'] == 'DESC') ? 'DESC' : 'ASC';	$forums = array_map('intval', $forums);	// Allow the old action names for backwards compatibility reasons	if ($action == 'show_user')		$action = 'show_user_posts';	else if ($action == 'show_24h')		$action = 'show_recent';	// If a search_id was supplied	if (isset($_GET['search_id']))	{		$search_id = intval($_GET['search_id']);		if ($search_id < 1)			message($lang_common['Bad request'], false, '404 Not Found');	}	// If it's a regular search (keywords and/or author)	else if ($action == 'search')	{		$keywords = (isset($_GET['keywords'])) ? utf8_strtolower(pun_trim($_GET['keywords'])) : null;		$author = (isset($_GET['author'])) ? utf8_strtolower(pun_trim($_GET['author'])) : null;		if (preg_match('%^[\*\%]+$%', $keywords) || (pun_strlen(str_replace(array('*', '%'), '', $keywords)) < PUN_SEARCH_MIN_WORD && !is_cjk($keywords)))			$keywords = '';		if (preg_match('%^[\*\%]+$%', $author) || pun_strlen(str_replace(array('*', '%'), '', $author)) < 2)			$author = '';		if (!$keywords && !$author)			message($lang_search['No terms']);		if ($author)			$author = str_replace('*', '%', $author);		$show_as = (isset($_GET['show_as']) && $_GET['show_as'] == 'topics') ? 'topics' : 'posts';		$sort_by = (isset($_GET['sort_by'])) ? intval($_GET['sort_by']) : 0;		$search_in = (!isset($_GET['search_in']) || $_GET['search_in'] == '0') ? 0 : (($_GET['search_in'] == '1') ? 1 : -1);	}	// If it's a user search (by ID)	else if ($action == 'show_user_posts' || $action == 'show_user_topics' || $action == 'show_subscriptions')	{		$user_id = (isset($_GET['user_id'])) ? intval($_GET['user_id']) : $pun_user['id'];		if ($user_id < 2)			message($lang_common['Bad request'], false, '404 Not Found');		// Subscribed topics can only be viewed by admins, moderators and the users themselves		if ($action == 'show_subscriptions' && !$pun_user['is_admmod'] && $user_id != $pun_user['id'])			message($lang_common['No permission'], false, '403 Forbidden');	}	else if ($action == 'show_recent')		$interval = isset($_GET['value']) ? intval($_GET['value']) : 86400;	else if ($action == 'show_replies')	{		if ($pun_user['is_guest'])			message($lang_common['Bad request']);	}	else if ($action != 'show_new' && $action != 'show_unanswered')		message($lang_common['Bad request']);	// If a valid search_id was supplied we attempt to fetch the search results from the db	if (isset($search_id))	{		$ident = ($pun_user['is_guest']) ? get_remote_address() : $pun_user['username'];		$result = $db->query('SELECT search_data FROM '.$db->prefix.'search_cache WHERE id='.$search_id.' AND ident=\''.$db->escape($ident).'\'') or error('Unable to fetch search results', __FILE__, __LINE__, $db->error());		if ($row = $db->fetch_assoc($result))		{			$temp = unserialize($row['search_data']);			$search_ids = unserialize($temp['search_ids']);			$num_hits = $temp['num_hits'];			$sort_by = $temp['sort_by'];			$sort_dir = $temp['sort_dir'];			$show_as = $temp['show_as'];			$search_type = $temp['search_type'];			unset($temp);		}		else			message($lang_search['No hits']);	}	else	{		$keyword_results = $author_results = array();		// Search a specific forum?		$forum_sql = (!empty($forums) || (empty($forums) && $pun_config['o_search_all_forums'] == '0' && !$pun_user['is_admmod'])) ? ' AND t.forum_id IN ('.implode(',', $forums).')' : '';		if (!empty($author) || !empty($keywords))		{			// Flood protection			if ($pun_user['last_search'] && (time() - $pun_user['last_search']) < $pun_user['g_search_flood'] && (time() - $pun_user['last_search']) >= 0)				message(sprintf($lang_search['Search flood'], $pun_user['g_search_flood'], $pun_user['g_search_flood'] - (time() - $pun_user['last_search'])));			if (!$pun_user['is_guest'])				$db->query('UPDATE '.$db->prefix.'users SET last_search='.time().' WHERE id='.$pun_user['id']) or error('Unable to update user', __FILE__, __LINE__, $db->error());			else				$db->query('UPDATE '.$db->prefix.'online SET last_search='.time().' WHERE ident=\''.$db->escape(get_remote_address()).'\'' ) or error('Unable to update user', __FILE__, __LINE__, $db->error());			switch ($sort_by)			{				case 1:					$sort_by_sql = ($show_as == 'topics') ? 't.poster' : 'p.poster';					$sort_type = SORT_STRING;					break;				case 2:					$sort_by_sql = 't.subject';					$sort_type = SORT_STRING;					break;				case 3:					$sort_by_sql = 't.forum_id';					$sort_type = SORT_NUMERIC;					break;				case 4:					$sort_by_sql = 't.last_post';					$sort_type = SORT_NUMERIC;					break;				default:					$sort_by_sql = ($show_as == 'topics') ? 't.last_post' : 'p.posted';					$sort_type = SORT_NUMERIC;					break;			}			// If it's a search for keywords			if ($keywords)			{				// split the keywords into words				$keywords_array = split_words($keywords, false);				if (empty($keywords_array))					message($lang_search['No hits']);				// Should we search in message body or topic subject specifically?				$search_in_cond = ($search_in) ? (($search_in > 0) ? ' AND m.subject_match = 0' : ' AND m.subject_match = 1') : '';				$word_count = 0;				$match_type = 'and';				$sort_data = array();				foreach ($keywords_array as $cur_word)				{					switch ($cur_word)					{						case 'and':						case 'or':						case 'not':							$match_type = $cur_word;							break;						default:						{							if (is_cjk($cur_word))							{								$where_cond = str_replace('*', '%', $cur_word);								$where_cond = ($search_in ? (($search_in > 0) ? 'p.message LIKE \'%'.$db->escape($where_cond).'%\'' : 't.subject LIKE \'%'.$db->escape($where_cond).'%\'') : 'p.message LIKE \'%'.$db->escape($where_cond).'%\' OR t.subject LIKE \'%'.$db->escape($where_cond).'%\'');								$result = $db->query('SELECT p.id AS post_id, p.topic_id, '.$sort_by_sql.' AS sort_by FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE ('.$where_cond.') AND (fp.read_forum IS NULL OR fp.read_forum=1)'.$forum_sql, true) or error('Unable to search for posts', __FILE__, __LINE__, $db->error());							}							else								$result = $db->query('SELECT m.post_id, p.topic_id, '.$sort_by_sql.' AS sort_by FROM '.$db->prefix.'search_words AS w INNER JOIN '.$db->prefix.'search_matches AS m ON m.word_id = w.id INNER JOIN '.$db->prefix.'posts AS p ON p.id=m.post_id INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE w.word LIKE \''.$db->escape(str_replace('*', '%', $cur_word)).'\''.$search_in_cond.' AND (fp.read_forum IS NULL OR fp.read_forum=1)'.$forum_sql, true) or error('Unable to search for posts', __FILE__, __LINE__, $db->error());							$row = array();							while ($temp = $db->fetch_assoc($result))							{								$row[$temp['post_id']] = $temp['topic_id'];								if (!$word_count)								{									$keyword_results[$temp['post_id']] = $temp['topic_id'];									$sort_data[$temp['post_id']] = $temp['sort_by'];								}								else if ($match_type == 'or')								{									$keyword_results[$temp['post_id']] = $temp['topic_id'];									$sort_data[$temp['post_id']] = $temp['sort_by'];								}								else if ($match_type == 'not')								{									unset($keyword_results[$temp['post_id']]);									unset($sort_data[$temp['post_id']]);								}							}							if ($match_type == 'and' && $word_count)							{								foreach ($keyword_results as $post_id => $topic_id)								{									if (!isset($row[$post_id]))									{										unset($keyword_results[$post_id]);										unset($sort_data[$post_id]);									}								}							}							++$word_count;							$db->free_result($result);							break;						}					}				}				// Sort the results - annoyingly array_multisort re-indexes arrays with numeric keys, so we need to split the keys out into a separate array then combine them again after				$post_ids = array_keys($keyword_results);				$topic_ids = array_values($keyword_results);				array_multisort(array_values($sort_data), $sort_dir == 'DESC' ? SORT_DESC : SORT_ASC, $sort_type, $post_ids, $topic_ids);				// combine the arrays back into a key=>value array (array_combine is PHP5 only unfortunately)				$num_results = count($keyword_results);				$keyword_results = array();				for ($i = 0;$i < $num_results;$i++)					$keyword_results[$post_ids[$i]] = $topic_ids[$i];				unset($sort_data, $post_ids, $topic_ids);			}			// If it's a search for author name (and that author name isn't Guest)			if ($author && $author != 'guest' && $author != utf8_strtolower($lang_common['Guest']))			{				switch ($db_type)				{					case 'pgsql':						$result = $db->query('SELECT id FROM '.$db->prefix.'users WHERE username ILIKE \''.$db->escape($author).'\'') or error('Unable to fetch users', __FILE__, __LINE__, $db->error());						break;					default:						$result = $db->query('SELECT id FROM '.$db->prefix.'users WHERE username LIKE \''.$db->escape($author).'\'') or error('Unable to fetch users', __FILE__, __LINE__, $db->error());						break;				}				if ($db->num_rows($result))				{					$user_ids = array();					while ($row = $db->fetch_row($result))						$user_ids[] = $row[0];					$result = $db->query('SELECT p.id AS post_id, p.topic_id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id IN('.implode(',', $user_ids).')'.$forum_sql.' ORDER BY '.$sort_by_sql.' '.$sort_dir) or error('Unable to fetch matched posts list', __FILE__, __LINE__, $db->error());					while ($temp = $db->fetch_assoc($result))						$author_results[$temp['post_id']] = $temp['topic_id'];					$db->free_result($result);				}			}			// If we searched for both keywords and author name we want the intersection between the results			if ($author && $keywords)			{				$search_ids = array_intersect_assoc($keyword_results, $author_results);				$search_type = array('both', array($keywords, pun_trim($_GET['author'])), implode(',', $forums), $search_in);			}			else if ($keywords)			{				$search_ids = $keyword_results;				$search_type = array('keywords', $keywords, implode(',', $forums), $search_in);			}			else			{				$search_ids = $author_results;				$search_type = array('author', pun_trim($_GET['author']), implode(',', $forums), $search_in);			}			unset($keyword_results, $author_results);			if ($show_as == 'topics')				$search_ids = array_values($search_ids);			else				$search_ids = array_keys($search_ids);			$search_ids = array_unique($search_ids);			$num_hits = count($search_ids);			if (!$num_hits)				message($lang_search['No hits']);		}		else if ($action == 'show_new' || $action == 'show_recent' || $action == 'show_replies' || $action == 'show_user_posts' || $action == 'show_user_topics' || $action == 'show_subscriptions' || $action == 'show_unanswered')		{			$search_type = array('action', $action);			$show_as = 'topics';			// We want to sort things after last post			$sort_by = 0;			$sort_dir = 'DESC';			// If it's a search for new posts since last visit			if ($action == 'show_new')			{				if ($pun_user['is_guest'])					message($lang_common['No permission'], false, '403 Forbidden');				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.$pun_user['last_visit'].' AND t.moved_to IS NULL'.(isset($_GET['fid']) ? ' AND t.forum_id='.intval($_GET['fid']) : '').' ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No new posts']);			}			// If it's a search for recent posts (in a certain time interval)			else if ($action == 'show_recent')			{				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.(time() - $interval).' AND t.moved_to IS NULL'.(isset($_GET['fid']) ? ' AND t.forum_id='.intval($_GET['fid']) : '').' ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No recent posts']);			}			// If it's a search for topics in which the user has posted			else if ($action == 'show_replies')			{				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'posts AS p ON t.id=p.topic_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id='.$pun_user['id'].' GROUP BY t.id'.($db_type == 'pgsql' ? ', t.last_post' : '').' ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No user posts']);			}			// If it's a search for posts by a specific user ID			else if ($action == 'show_user_posts')			{				$show_as = 'posts';				$result = $db->query('SELECT p.id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON p.topic_id=t.id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id='.$user_id.' ORDER BY p.posted DESC') or error('Unable to fetch user posts', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No user posts']);				// Pass on the user ID so that we can later know whose posts we're searching for				$search_type[2] = $user_id;			}			// If it's a search for topics by a specific user ID			else if ($action == 'show_user_topics')			{				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'posts AS p ON t.first_post_id=p.id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id='.$user_id.' ORDER BY t.last_post DESC') or error('Unable to fetch user topics', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No user topics']);				// Pass on the user ID so that we can later know whose topics we're searching for				$search_type[2] = $user_id;			}			// If it's a search for subscribed topics			else if ($action == 'show_subscriptions')			{				if ($pun_user['is_guest'])					message($lang_common['Bad request']);				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'topic_subscriptions AS s ON (t.id=s.topic_id AND s.user_id='.$user_id.') LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No subscriptions']);				// Pass on user ID so that we can later know whose subscriptions we're searching for				$search_type[2] = $user_id;			}			// If it's a search for unanswered posts			else			{				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.num_replies=0 AND t.moved_to IS NULL ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());				$num_hits = $db->num_rows($result);				if (!$num_hits)					message($lang_search['No unanswered']);			}			$search_ids = array();			while ($row = $db->fetch_row($result))				$search_ids[] = $row[0];			$db->free_result($result);		}		else			message($lang_common['Bad request']);		// Prune "old" search results		$old_searches = array();		$result = $db->query('SELECT ident FROM '.$db->prefix.'online') or error('Unable to fetch online list', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result))		{			while ($row = $db->fetch_row($result))				$old_searches[] = '\''.$db->escape($row[0]).'\'';			$db->query('DELETE FROM '.$db->prefix.'search_cache WHERE ident NOT IN('.implode(',', $old_searches).')') or error('Unable to delete search results', __FILE__, __LINE__, $db->error());		}		// Fill an array with our results and search properties		$temp = serialize(array(			'search_ids'		=> serialize($search_ids),			'num_hits'			=> $num_hits,			'sort_by'			=> $sort_by,			'sort_dir'			=> $sort_dir,			'show_as'			=> $show_as,			'search_type'		=> $search_type		));		$search_id = mt_rand(1, 2147483647);		$ident = ($pun_user['is_guest']) ? get_remote_address() : $pun_user['username'];		$db->query('INSERT INTO '.$db->prefix.'search_cache (id, ident, search_data) VALUES('.$search_id.', \''.$db->escape($ident).'\', \''.$db->escape($temp).'\')') or error('Unable to insert search results', __FILE__, __LINE__, $db->error());		if ($search_type[0] != 'action')		{			$db->end_transaction();			$db->close();			// Redirect the user to the cached result page			header('Location: search.php?search_id='.$search_id);			exit;		}	}	$forum_actions = array();	// If we're on the new posts search, display a "mark all as read" link	if (!$pun_user['is_guest'] && $search_type[0] == 'action' && $search_type[1] == 'show_new')		$forum_actions[] = '<a href="misc.php?action=markread">'.$lang_common['Mark all as read'].'</a>';	// Fetch results to display	if (!empty($search_ids))	{		switch ($sort_by)		{			case 1:				$sort_by_sql = ($show_as == 'topics') ? 't.poster' : 'p.poster';				break;			case 2:				$sort_by_sql = 't.subject';				break;			case 3:				$sort_by_sql = 't.forum_id';				break;			default:				$sort_by_sql = ($show_as == 'topics') ? 't.last_post' : 'p.posted';				break;		}		// Determine the topic or post offset (based on $_GET['p'])		$per_page = ($show_as == 'posts') ? $pun_user['disp_posts'] : $pun_user['disp_topics'];		$num_pages = ceil($num_hits / $per_page);		$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);		$start_from = $per_page * ($p - 1);		// Generate paging links		$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'search.php?search_id='.$search_id);		// throw away the first $start_from of $search_ids, only keep the top $per_page of $search_ids		$search_ids = array_slice($search_ids, $start_from, $per_page);		// Run the query and fetch the results		if ($show_as == 'posts')			$result = $db->query('SELECT p.id AS pid, p.poster AS pposter, p.posted AS pposted, p.poster_id, p.message, p.hide_smilies, t.id AS tid, t.poster, t.subject, t.first_post_id, t.last_post, t.last_post_id, t.last_poster, t.num_replies, t.forum_id, f.forum_name FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id WHERE p.id IN('.implode(',', $search_ids).') ORDER BY '.$sort_by_sql.' '.$sort_dir) or error('Unable to fetch search results', __FILE__, __LINE__, $db->error());		else			$result = $db->query('SELECT t.id AS tid, t.poster, t.subject, t.last_post, t.last_post_id, t.last_poster, t.num_replies, t.closed, t.sticky, t.forum_id, f.forum_name FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id WHERE t.id IN('.implode(',', $search_ids).') ORDER BY '.$sort_by_sql.' '.$sort_dir) or error('Unable to fetch search results', __FILE__, __LINE__, $db->error());		$search_set = array();		while ($row = $db->fetch_assoc($result))			$search_set[] = $row;		$crumbs_text = array();		$crumbs_text['show_as'] = $lang_search['Search'];		if ($search_type[0] == 'action')		{			if ($search_type[1] == 'show_user_topics')				$crumbs_text['search_type'] = '<a href="search.php?action=show_user_topics&amp;user_id='.$search_type[2].'">'.sprintf($lang_search['Quick search show_user_topics'], pun_htmlspecialchars($search_set[0]['poster'])).'</a>';			else if ($search_type[1] == 'show_user_posts')				$crumbs_text['search_type'] = '<a href="search.php?action=show_user_posts&amp;user_id='.$search_type[2].'">'.sprintf($lang_search['Quick search show_user_posts'], pun_htmlspecialchars($search_set[0]['pposter'])).'</a>';			else if ($search_type[1] == 'show_subscriptions')			{				// Fetch username of subscriber				$subscriber_id = $search_type[2];				$result = $db->query('SELECT username FROM '.$db->prefix.'users WHERE id='.$subscriber_id) or error('Unable to fetch username of subscriber', __FILE__, __LINE__, $db->error());				if ($db->num_rows($result))					$subscriber_name = $db->result($result);				else					message($lang_common['Bad request'], false, '404 Not Found');				$crumbs_text['search_type'] = '<a href="search.php?action=show_subscriptions&amp;user_id='.$subscriber_id.'">'.sprintf($lang_search['Quick search show_subscriptions'], pun_htmlspecialchars($subscriber_name)).'</a>';			}			else				$crumbs_text['search_type'] = '<a href="search.php?action='.$search_type[1].'">'.$lang_search['Quick search '.$search_type[1]].'</a>';		}		else		{			$keywords = $author = '';			if ($search_type[0] == 'both')			{				list ($keywords, $author) = $search_type[1];				$crumbs_text['search_type'] = sprintf($lang_search['By both show as '.$show_as], pun_htmlspecialchars($keywords), pun_htmlspecialchars($author));			}			else if ($search_type[0] == 'keywords')			{				$keywords = $search_type[1];				$crumbs_text['search_type'] = sprintf($lang_search['By keywords show as '.$show_as], pun_htmlspecialchars($keywords));			}			else if ($search_type[0] == 'author')			{				$author = $search_type[1];				$crumbs_text['search_type'] = sprintf($lang_search['By user show as '.$show_as], pun_htmlspecialchars($author));			}			$crumbs_text['search_type'] = '<a href="search.php?action=search&amp;keywords='.urlencode($keywords).'&amp;author='.urlencode($author).'&amp;forums='.$search_type[2].'&amp;search_in='.$search_type[3].'&amp;sort_by='.$sort_by.'&amp;sort_dir='.$sort_dir.'&amp;show_as='.$show_as.'">'.$crumbs_text['search_type'].'</a>';		}		$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_search['Search results']);		define('PUN_ACTIVE_PAGE', 'search');		require PUN_ROOT.'header.php';?><div class="linkst">	<div class="inbox crumbsplus">		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="search.php"><?php echo $crumbs_text['show_as'] ?></a></li>			<li><span>&#160;</span><strong><?php echo $crumbs_text['search_type'] ?></strong></li>		</ul>		<div class="pagepost">			<p class="pagelink"><?php echo $paging_links ?></p>		</div>		<div class="clearer"></div>	</div></div><?php		if ($show_as == 'topics')		{			$topic_count = 0;?><div id="vf" class="blocktable">	<h2><span><?php echo $lang_search['Search results'] ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_common['Topic'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_common['Forum'] ?></th>					<th class="tc3" scope="col"><?php echo $lang_common['Replies'] ?></th>					<th class="tcr" scope="col"><?php echo $lang_common['Last post'] ?></th>				</tr>			</thead>			<tbody><?php		}		else if ($show_as == 'posts')		{			require PUN_ROOT.'lang/'.$pun_user['language'].'/topic.php';			require PUN_ROOT.'include/parser.php';			$post_count = 0;		}		// Get topic/forum tracking data		if (!$pun_user['is_guest'])			$tracked_topics = get_tracked_topics();		foreach ($search_set as $cur_search)		{			$forum = '<a href="viewforum.php?id='.$cur_search['forum_id'].'">'.pun_htmlspecialchars($cur_search['forum_name']).'</a>';			if ($pun_config['o_censoring'] == '1')				$cur_search['subject'] = censor_words($cur_search['subject']);			if ($show_as == 'posts')			{				++$post_count;				$icon_type = 'icon';				if (!$pun_user['is_guest'] && $cur_search['last_post'] > $pun_user['last_visit'] && (!isset($tracked_topics['topics'][$cur_search['tid']]) || $tracked_topics['topics'][$cur_search['tid']] < $cur_search['last_post']) && (!isset($tracked_topics['forums'][$cur_search['forum_id']]) || $tracked_topics['forums'][$cur_search['forum_id']] < $cur_search['last_post']))				{					$item_status = 'inew';					$icon_type = 'icon icon-new';					$icon_text = $lang_topic['New icon'];				}				else				{					$item_status = '';					$icon_text = '<!-- -->';				}				if ($pun_config['o_censoring'] == '1')					$cur_search['message'] = censor_words($cur_search['message']);				$message = parse_message($cur_search['message'], $cur_search['hide_smilies']);				$pposter = pun_htmlspecialchars($cur_search['pposter']);				if ($cur_search['poster_id'] > 1)				{					if ($pun_user['g_view_users'] == '1')						$pposter = '<strong><a href="profile.php?id='.$cur_search['poster_id'].'">'.$pposter.'</a></strong>';					else						$pposter = '<strong>'.$pposter.'</strong>';				}?><div class="blockpost<?php echo ($post_count % 2 == 0) ? ' roweven' : ' rowodd' ?><?php if ($cur_search['pid'] == $cur_search['first_post_id']) echo ' firstpost' ?><?php if ($post_count == 1) echo ' blockpost1' ?><?php if ($item_status != '') echo ' '.$item_status ?>">	<h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <span><?php if ($cur_search['pid'] != $cur_search['first_post_id']) echo $lang_topic['Re'].' ' ?><?php echo $forum ?></span> <span>&#160;<a href="viewtopic.php?id=<?php echo $cur_search['tid'] ?>"><?php echo pun_htmlspecialchars($cur_search['subject']) ?></a></span> <span>&#160;<a href="viewtopic.php?pid=<?php echo $cur_search['pid'].'#p'.$cur_search['pid'] ?>"><?php echo format_time($cur_search['pposted']) ?></a></span></span></h2>	<div class="box">		<div class="inbox">			<div class="postbody">				<div class="postleft">					<dl>						<dt><?php echo $pposter ?></dt><?php if ($cur_search['pid'] == $cur_search['first_post_id']) : ?>						<dd><span><?php echo $lang_topic['Replies'].' '.forum_number_format($cur_search['num_replies']) ?></span></dd><?php endif; ?>						<dd><div class="<?php echo $icon_type ?>"><div class="nosize"><?php echo $icon_text ?></div></div></dd>					</dl>				</div>				<div class="postright">					<div class="postmsg">						<?php echo $message."\n" ?>					</div>				</div>				<div class="clearer"></div>			</div>		</div>		<div class="inbox">			<div class="postfoot clearb">				<div class="postfootright">					<ul>						<li><span><a href="viewtopic.php?id=<?php echo $cur_search['tid'] ?>"><?php echo $lang_search['Go to topic'] ?></a></span></li>						<li><span><a href="viewtopic.php?pid=<?php echo $cur_search['pid'].'#p'.$cur_search['pid'] ?>"><?php echo $lang_search['Go to post'] ?></a></span></li>					</ul>				</div>			</div>		</div>	</div></div><?php			}			else			{				++$topic_count;				$status_text = array();				$item_status = ($topic_count % 2 == 0) ? 'roweven' : 'rowodd';				$icon_type = 'icon';				$subject = '<a href="viewtopic.php?id='.$cur_search['tid'].'">'.pun_htmlspecialchars($cur_search['subject']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_search['poster']).'</span>';				if ($cur_search['sticky'] == '1')				{					$item_status .= ' isticky';					$status_text[] = '<span class="stickytext">'.$lang_forum['Sticky'].'</span>';				}				if ($cur_search['closed'] != '0')				{					$status_text[] = '<span class="closedtext">'.$lang_forum['Closed'].'</span>';					$item_status .= ' iclosed';				}				if (!$pun_user['is_guest'] && $cur_search['last_post'] > $pun_user['last_visit'] && (!isset($tracked_topics['topics'][$cur_search['tid']]) || $tracked_topics['topics'][$cur_search['tid']] < $cur_search['last_post']) && (!isset($tracked_topics['forums'][$cur_search['forum_id']]) || $tracked_topics['forums'][$cur_search['forum_id']] < $cur_search['last_post']))				{					$item_status .= ' inew';					$icon_type = 'icon icon-new';					$subject = '<strong>'.$subject.'</strong>';					$subject_new_posts = '<span class="newtext">[ <a href="viewtopic.php?id='.$cur_search['tid'].'&amp;action=new" title="'.$lang_common['New posts info'].'">'.$lang_common['New posts'].'</a> ]</span>';				}				else					$subject_new_posts = null;				// Insert the status text before the subject				$subject = implode(' ', $status_text).' '.$subject;				$num_pages_topic = ceil(($cur_search['num_replies'] + 1) / $pun_user['disp_posts']);				if ($num_pages_topic > 1)					$subject_multipage = '<span class="pagestext">[ '.paginate($num_pages_topic, -1, 'viewtopic.php?id='.$cur_search['tid']).' ]</span>';				else					$subject_multipage = null;				// Should we show the "New posts" and/or the multipage links?				if (!empty($subject_new_posts) || !empty($subject_multipage))				{					$subject .= !empty($subject_new_posts) ? ' '.$subject_new_posts : '';					$subject .= !empty($subject_multipage) ? ' '.$subject_multipage : '';				}?>				<tr class="<?php echo $item_status ?>">					<td class="tcl">						<div class="<?php echo $icon_type ?>"><div class="nosize"><?php echo forum_number_format($topic_count + $start_from) ?></div></div>						<div class="tclcon">							<div>								<?php echo $subject."\n" ?>							</div>						</div>					</td>					<td class="tc2"><?php echo $forum ?></td>					<td class="tc3"><?php echo forum_number_format($cur_search['num_replies']) ?></td>					<td class="tcr"><?php echo '<a href="viewtopic.php?pid='.$cur_search['last_post_id'].'#p'.$cur_search['last_post_id'].'">'.format_time($cur_search['last_post']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_search['last_poster']) ?></span></td>				</tr><?php			}		}		if ($show_as == 'topics')			echo "\t\t\t".'</tbody>'."\n\t\t\t".'</table>'."\n\t\t".'</div>'."\n\t".'</div>'."\n".'</div>'."\n\n";?><div class="<?php echo ($show_as == 'topics') ? 'linksb' : 'postlinksb'; ?>">	<div class="inbox crumbsplus">		<div class="pagepost">			<p class="pagelink"><?php echo $paging_links ?></p>		</div>		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="search.php"><?php echo $crumbs_text['show_as'] ?></a></li>			<li><span>&#160;</span><strong><?php echo $crumbs_text['search_type'] ?></strong></li>		</ul><?php echo (!empty($forum_actions) ? "\t\t".'<p class="subscribelink clearb">'.implode(' - ', $forum_actions).'</p>'."\n" : '') ?>		<div class="clearer"></div>	</div></div><?php		require PUN_ROOT.'footer.php';	}	else		message($lang_search['No hits']);}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_search['Search']);$focus_element = array('search', 'keywords');define('PUN_ACTIVE_PAGE', 'search');require PUN_ROOT.'header.php';?><div id="searchform" class="blockform">	<h2><span><?php echo $lang_search['Search'] ?></span></h2>	<div class="box">		<form id="search" method="get" action="search.php">			<div class="inform">				<fieldset>					<legend><?php echo $lang_search['Search criteria legend'] ?></legend>					<div class="infldset">						<input type="hidden" name="action" value="search" />						<label class="conl"><?php echo $lang_search['Keyword search'] ?><br /><input type="text" name="keywords" size="40" maxlength="100" /><br /></label>						<label class="conl"><?php echo $lang_search['Author search'] ?><br /><input id="author" type="text" name="author" size="25" maxlength="25" /><br /></label>						<p class="clearb"><?php echo $lang_search['Search info'] ?></p>					</div>				</fieldset>			</div>			<div class="inform">				<fieldset>					<legend><?php echo $lang_search['Search in legend'] ?></legend>					<div class="infldset"><?php$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.redirect_url FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.redirect_url IS NULL ORDER BY c.disp_position, c.id, f.disp_position', true) or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());// We either show a list of forums of which multiple can be selectedif ($pun_config['o_search_all_forums'] == '1' || $pun_user['is_admmod']){	echo "\t\t\t\t\t\t".'<div class="conl multiselect">'.$lang_search['Forum search']."\n";	echo "\t\t\t\t\t\t".'<br />'."\n";	echo "\t\t\t\t\t\t".'<div class="checklist">'."\n";	$cur_category = 0;	while ($cur_forum = $db->fetch_assoc($result))	{		if ($cur_forum['cid'] != $cur_category) // A new category since last iteration?		{			if ($cur_category)			{				echo "\t\t\t\t\t\t\t\t".'</div>'."\n";				echo "\t\t\t\t\t\t\t".'</fieldset>'."\n";			}						echo "\t\t\t\t\t\t\t".'<fieldset><legend><span>'.pun_htmlspecialchars($cur_forum['cat_name']).'</span></legend>'."\n";			echo "\t\t\t\t\t\t\t\t".'<div class="rbox">';			$cur_category = $cur_forum['cid'];		}		echo "\t\t\t\t\t\t\t\t".'<label><input type="checkbox" name="forums[]" id="forum-'.$cur_forum['fid'].'" value="'.$cur_forum['fid'].'" />'.pun_htmlspecialchars($cur_forum['forum_name']).'</label>'."\n";	}	if ($cur_category)	{		echo "\t\t\t\t\t\t\t\t".'</div>'."\n";		echo "\t\t\t\t\t\t\t".'</fieldset>'."\n";	}		echo "\t\t\t\t\t\t".'</div>'."\n";	echo "\t\t\t\t\t\t".'</div>'."\n";}// ... or a simple select list for one forum onlyelse{	echo "\t\t\t\t\t\t".'<label class="conl">'.$lang_search['Forum search']."\n";	echo "\t\t\t\t\t\t".'<br />'."\n";	echo "\t\t\t\t\t\t".'<select id="forum" name="forum">'."\n";	$cur_category = 0;	while ($cur_forum = $db->fetch_assoc($result))	{		if ($cur_forum['cid'] != $cur_category) // A new category since last iteration?		{			if ($cur_category)				echo "\t\t\t\t\t\t\t".'</optgroup>'."\n";			echo "\t\t\t\t\t\t\t".'<optgroup label="'.pun_htmlspecialchars($cur_forum['cat_name']).'">'."\n";			$cur_category = $cur_forum['cid'];		}		echo "\t\t\t\t\t\t\t\t".'<option value="'.$cur_forum['fid'].'">'.pun_htmlspecialchars($cur_forum['forum_name']).'</option>'."\n";	}	echo "\t\t\t\t\t\t\t".'</optgroup>'."\n";	echo "\t\t\t\t\t\t".'</select>'."\n";	echo "\t\t\t\t\t\t".'<br /></label>'."\n";}?>						<label class="conl"><?php echo $lang_search['Search in']."\n" ?>						<br /><select id="search_in" name="search_in">							<option value="0"><?php echo $lang_search['Message and subject'] ?></option>							<option value="1"><?php echo $lang_search['Message only'] ?></option>							<option value="-1"><?php echo $lang_search['Topic only'] ?></option>						</select>						<br /></label>						<p class="clearl"><?php echo $lang_search['Search in info'] ?></p><?php echo ($pun_config['o_search_all_forums'] == '1' || $pun_user['is_admmod'] ? '<p>'.$lang_search['Search multiple forums info'].'</p>' : '') ?>					</div>				</fieldset>			</div>			<div class="inform">				<fieldset>					<legend><?php echo $lang_search['Search results legend'] ?></legend>					<div class="infldset">						<label class="conl"><?php echo $lang_search['Sort by']."\n" ?>						<br /><select name="sort_by">							<option value="0"><?php echo $lang_search['Sort by post time'] ?></option>							<option value="1"><?php echo $lang_search['Sort by author'] ?></option>							<option value="2"><?php echo $lang_search['Sort by subject'] ?></option>							<option value="3"><?php echo $lang_search['Sort by forum'] ?></option>						</select>						<br /></label>						<label class="conl"><?php echo $lang_search['Sort order']."\n" ?>						<br /><select name="sort_dir">							<option value="DESC"><?php echo $lang_search['Descending'] ?></option>							<option value="ASC"><?php echo $lang_search['Ascending'] ?></option>						</select>						<br /></label>						<label class="conl"><?php echo $lang_search['Show as']."\n" ?>						<br /><select name="show_as">							<option value="topics"><?php echo $lang_search['Show as topics'] ?></option>							<option value="posts"><?php echo $lang_search['Show as posts'] ?></option>						</select>						<br /></label>						<p class="clearb"><?php echo $lang_search['Search results info'] ?></p>					</div>				</fieldset>			</div>			<p class="buttons"><input type="submit" name="search" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /></p>		</form>	</div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);// Tell common.php that we don't want output bufferingdefine('PUN_DISABLE_BUFFERING', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_maintenance.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_maintenance.php';$action = isset($_REQUEST['action']) ? pun_trim($_REQUEST['action']) : '';if ($action == 'rebuild'){	$per_page = isset($_GET['i_per_page']) ? intval($_GET['i_per_page']) : 0;	$start_at = isset($_GET['i_start_at']) ? intval($_GET['i_start_at']) : 0;	// Check per page is > 0	if ($per_page < 1)		message($lang_admin_maintenance['Posts must be integer message']);	@set_time_limit(0);	// If this is the first cycle of posts we empty the search index before we proceed	if (isset($_GET['i_empty_index']))	{		// This is the only potentially "dangerous" thing we can do here, so we check the referer		confirm_referrer('admin_maintenance.php');		$db->truncate_table('search_matches') or error('Unable to empty search index match table', __FILE__, __LINE__, $db->error());		$db->truncate_table('search_words') or error('Unable to empty search index words table', __FILE__, __LINE__, $db->error());		// Reset the sequence for the search words (not needed for SQLite)		switch ($db_type)		{			case 'mysql':			case 'mysqli':			case 'mysql_innodb':			case 'mysqli_innodb':				$result = $db->query('ALTER TABLE '.$db->prefix.'search_words auto_increment=1') or error('Unable to update table auto_increment', __FILE__, __LINE__, $db->error());				break;			case 'pgsql';				$result = $db->query('SELECT setval(\''.$db->prefix.'search_words_id_seq\', 1, false)') or error('Unable to update sequence', __FILE__, __LINE__, $db->error());		}	}	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_maintenance['Rebuilding search index']);?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title><?php echo generate_page_title($page_title) ?></title><style type="text/css">body {	font: 12px Verdana, Arial, Helvetica, sans-serif;	color: #333333;	background-color: #FFFFFF}h1 {	font-size: 16px;	font-weight: normal;}</style></head><body><h1><?php echo $lang_admin_maintenance['Rebuilding index info'] ?></h1><hr /><?php	$query_str = '';	require PUN_ROOT.'include/search_idx.php';	// Fetch posts to process this cycle	$result = $db->query('SELECT p.id, p.message, t.subject, t.first_post_id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id WHERE p.id >= '.$start_at.' ORDER BY p.id ASC LIMIT '.$per_page) or error('Unable to fetch posts', __FILE__, __LINE__, $db->error());	$end_at = 0;	while ($cur_item = $db->fetch_assoc($result))	{		echo '<p><span>'.sprintf($lang_admin_maintenance['Processing post'], $cur_item['id']).'</span></p>'."\n";		if ($cur_item['id'] == $cur_item['first_post_id'])			update_search_index('post', $cur_item['id'], $cur_item['message'], $cur_item['subject']);		else			update_search_index('post', $cur_item['id'], $cur_item['message']);		$end_at = $cur_item['id'];	}	// Check if there is more work to do	if ($end_at > 0)	{		$result = $db->query('SELECT id FROM '.$db->prefix.'posts WHERE id > '.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to fetch next ID', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result) > 0)			$query_str = '?action=rebuild&i_per_page='.$per_page.'&i_start_at='.$db->result($result);	}	$db->end_transaction();	$db->close();	exit('<script type="text/javascript">window.location="admin_maintenance.php'.$query_str.'"</script><hr /><p>'.sprintf($lang_admin_maintenance['Javascript redirect failed'], '<a href="admin_maintenance.php'.$query_str.'">'.$lang_admin_maintenance['Click here'].'</a>').'</p>');}if ($action == 'prune'){	$prune_from = pun_trim($_POST['prune_from']);	$prune_sticky = intval($_POST['prune_sticky']);	if (isset($_POST['prune_comply']))	{		confirm_referrer('admin_maintenance.php');		$prune_days = intval($_POST['prune_days']);		$prune_date = ($prune_days) ? time() - ($prune_days * 86400) : -1;		@set_time_limit(0);		if ($prune_from == 'all')		{			$result = $db->query('SELECT id FROM '.$db->prefix.'forums') or error('Unable to fetch forum list', __FILE__, __LINE__, $db->error());			$num_forums = $db->num_rows($result);			for ($i = 0; $i < $num_forums; ++$i)			{				$fid = $db->result($result, $i);				prune($fid, $prune_sticky, $prune_date);				update_forum($fid);			}		}		else		{			$prune_from = intval($prune_from);			prune($prune_from, $prune_sticky, $prune_date);			update_forum($prune_from);		}		// Locate any "orphaned redirect topics" and delete them		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());		$num_orphans = $db->num_rows($result);		if ($num_orphans)		{			for ($i = 0; $i < $num_orphans; ++$i)				$orphans[] = $db->result($result, $i);			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());		}		redirect('admin_maintenance.php', $lang_admin_maintenance['Posts pruned redirect']);	}	$prune_days = pun_trim($_POST['req_prune_days']);	if ($prune_days == '' || preg_match('%[^0-9]%', $prune_days))		message($lang_admin_maintenance['Days must be integer message']);	$prune_date = time() - ($prune_days * 86400);	// Concatenate together the query for counting number of topics to prune	$sql = 'SELECT COUNT(id) FROM '.$db->prefix.'topics WHERE last_post<'.$prune_date.' AND moved_to IS NULL';	if ($prune_sticky == '0')		$sql .= ' AND sticky=0';	if ($prune_from != 'all')	{		$prune_from = intval($prune_from);		$sql .= ' AND forum_id='.$prune_from;		// Fetch the forum name (just for cosmetic reasons)		$result = $db->query('SELECT forum_name FROM '.$db->prefix.'forums WHERE id='.$prune_from) or error('Unable to fetch forum name', __FILE__, __LINE__, $db->error());		$forum = '"'.pun_htmlspecialchars($db->result($result)).'"';	}	else		$forum = $lang_admin_maintenance['All forums'];	$result = $db->query($sql) or error('Unable to fetch topic prune count', __FILE__, __LINE__, $db->error());	$num_topics = $db->result($result);	if (!$num_topics)		message(sprintf($lang_admin_maintenance['No old topics message'], $prune_days));	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Prune']);	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';	generate_admin_menu('maintenance');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_maintenance['Prune head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_maintenance.php">				<div class="inform">					<input type="hidden" name="action" value="prune" />					<input type="hidden" name="prune_days" value="<?php echo $prune_days ?>" />					<input type="hidden" name="prune_sticky" value="<?php echo $prune_sticky ?>" />					<input type="hidden" name="prune_from" value="<?php echo $prune_from ?>" />					<fieldset>						<legend><?php echo $lang_admin_maintenance['Confirm prune subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_maintenance['Confirm prune info'], $prune_days, $forum, forum_number_format($num_topics)) ?></p>							<p class="warntext"><?php echo $lang_admin_maintenance['Confirm prune warn'] ?></p>						</div>					</fieldset>				</div>				<p class="buttons"><input type="submit" name="prune_comply" value="<?php echo $lang_admin_common['Prune'] ?>" /><a href="javascript:history.go(-1)"><?php echo $lang_admin_common['Go back'] ?></a></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php	require PUN_ROOT.'footer.php';	exit;}// Get the first post ID from the db$result = $db->query('SELECT id FROM '.$db->prefix.'posts ORDER BY id ASC LIMIT 1') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());if ($db->num_rows($result))	$first_id = $db->result($result);$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Maintenance']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('maintenance');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_maintenance['Maintenance head'] ?></span></h2>		<div class="box">			<form method="get" action="admin_maintenance.php">				<div class="inform">					<input type="hidden" name="action" value="rebuild" />					<fieldset>						<legend><?php echo $lang_admin_maintenance['Rebuild index subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_maintenance['Rebuild index info'], '<a href="admin_options.php#maintenance">'.$lang_admin_common['Maintenance mode'].'</a>') ?></p>							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Posts per cycle label'] ?></th>									<td>										<input type="text" name="i_per_page" size="7" maxlength="7" value="300" tabindex="1" />										<span><?php echo $lang_admin_maintenance['Posts per cycle help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Starting post label'] ?></th>									<td>										<input type="text" name="i_start_at" size="7" maxlength="7" value="<?php echo (isset($first_id)) ? $first_id : 0 ?>" tabindex="2" />										<span><?php echo $lang_admin_maintenance['Starting post help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Empty index label'] ?></th>									<td class="inputadmin">										<label><input type="checkbox" name="i_empty_index" value="1" tabindex="3" checked="checked" />&#160;&#160;<?php echo $lang_admin_maintenance['Empty index help'] ?></label>									</td>								</tr>							</table>							<p class="topspace"><?php echo $lang_admin_maintenance['Rebuild completed info'] ?></p>							<div class="fsetsubmit"><input type="submit" name="rebuild_index" value="<?php echo $lang_admin_maintenance['Rebuild index'] ?>" tabindex="4" /></div>						</div>					</fieldset>				</div>			</form>			<form method="post" action="admin_maintenance.php" onsubmit="return process_form(this)">				<div class="inform">					<input type="hidden" name="action" value="prune" />					<fieldset>						<legend><?php echo $lang_admin_maintenance['Prune subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Days old label'] ?></th>									<td>										<input type="text" name="req_prune_days" size="3" maxlength="3" tabindex="5" />										<span><?php echo $lang_admin_maintenance['Days old help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Prune sticky label'] ?></th>									<td>										<label class="conl"><input type="radio" name="prune_sticky" value="1" tabindex="6" checked="checked" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="prune_sticky" value="0" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_maintenance['Prune sticky help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_maintenance['Prune from label'] ?></th>									<td>										<select name="prune_from" tabindex="7">											<option value="all"><?php echo $lang_admin_maintenance['All forums'] ?></option><?php	$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id WHERE f.redirect_url IS NULL ORDER BY c.disp_position, c.id, f.disp_position') or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());	$cur_category = 0;	while ($forum = $db->fetch_assoc($result))	{		if ($forum['cid'] != $cur_category) // Are we still in the same category?		{			if ($cur_category)				echo "\t\t\t\t\t\t\t\t\t\t\t".'</optgroup>'."\n";			echo "\t\t\t\t\t\t\t\t\t\t\t".'<optgroup label="'.pun_htmlspecialchars($forum['cat_name']).'">'."\n";			$cur_category = $forum['cid'];		}		echo "\t\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$forum['fid'].'">'.pun_htmlspecialchars($forum['forum_name']).'</option>'."\n";	}?>											</optgroup>										</select>										<span><?php echo $lang_admin_maintenance['Prune from help'] ?></span>									</td>								</tr>							</table>							<p class="topspace"><?php printf($lang_admin_maintenance['Prune info'], '<a href="admin_options.php#maintenance">'.$lang_admin_common['Maintenance mode'].'</a>') ?></p>							<div class="fsetsubmit"><input type="submit" name="prune" value="<?php echo $lang_admin_common['Prune'] ?>" tabindex="8" /></div>						</div>					</fieldset>				</div>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if (!$pun_user['is_admmod'])	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_index.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_index.php';$action = isset($_GET['action']) ? $_GET['action'] : null;// Check for upgradeif ($action == 'check_upgrade'){	if (!ini_get('allow_url_fopen'))		message($lang_admin_index['fopen disabled message']);	$latest_version = trim(@file_get_contents('http://fluxbb.org/latest_version'));	if (empty($latest_version))		message($lang_admin_index['Upgrade check failed message']);	if (version_compare($pun_config['o_cur_version'], $latest_version, '>='))		message($lang_admin_index['Running latest version message']);	else		message(sprintf($lang_admin_index['New version available message'], '<a href="http://fluxbb.org/">FluxBB.org</a>'));}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Index']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('index');?>	<div class="block">		<h2><span><?php echo $lang_admin_index['Forum admin head'] ?></span></h2>		<div id="adintro" class="box">			<div class="inbox">				<p><?php echo $lang_admin_index['Welcome to admin'] ?></p>				<ul>					<li><span><?php echo $lang_admin_index['Welcome 1'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 2'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 3'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 4'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 5'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 6'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 7'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 8'] ?></span></li>					<li><span><?php echo $lang_admin_index['Welcome 9'] ?></span></li>				</ul>			</div>		</div>		<h2 class="block2"><span><?php echo $lang_admin_index['About head'] ?></span></h2>		<div id="adstats" class="box">			<div class="inbox">				<dl>					<dt><?php echo $lang_admin_index['FluxBB version label'] ?></dt>					<dd>						<?php printf($lang_admin_index['FluxBB version data']."\n", $pun_config['o_cur_version'], '<a href="admin_index.php?action=check_upgrade">'.$lang_admin_index['Check for upgrade'].'</a>') ?>					</dd>					<dt><?php echo $lang_admin_index['Server statistics label'] ?></dt>					<dd>						<a href="admin_statistics.php"><?php echo $lang_admin_index['View server statistics'] ?></a>					</dd>					<dt><?php echo $lang_admin_index['Support label'] ?></dt>					<dd>						<a href="http://fluxbb.org/forums/index.php"><?php echo $lang_admin_index['Forum label'] ?></a> - <a href="http://fluxbb.org/community/irc.html"><?php echo $lang_admin_index['IRC label'] ?></a>					</dd>				</dl>			</div>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_permissions.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_permissions.php';if (isset($_POST['form_sent'])){	confirm_referrer('admin_permissions.php');	$form = array_map('intval', $_POST['form']);	foreach ($form as $key => $input)	{		// Make sure the input is never a negative value		if($input < 0)			$input = 0;		// Only update values that have changed		if (array_key_exists('p_'.$key, $pun_config) && $pun_config['p_'.$key] != $input)			$db->query('UPDATE '.$db->prefix.'config SET conf_value='.$input.' WHERE conf_name=\'p_'.$db->escape($key).'\'') or error('Unable to update board config', __FILE__, __LINE__, $db->error());	}	// Regenerate the config cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_config_cache();	redirect('admin_permissions.php', $lang_admin_permissions['Perms updated redirect']);}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Permissions']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('permissions');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_permissions['Permissions head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_permissions.php">				<p class="submittop"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" /></p>				<div class="inform">					<input type="hidden" name="form_sent" value="1" />					<fieldset>						<legend><?php echo $lang_admin_permissions['Posting subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_permissions['BBCode label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[message_bbcode]" value="1"<?php if ($pun_config['p_message_bbcode'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[message_bbcode]" value="0"<?php if ($pun_config['p_message_bbcode'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['BBCode help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Image tag label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[message_img_tag]" value="1"<?php if ($pun_config['p_message_img_tag'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[message_img_tag]" value="0"<?php if ($pun_config['p_message_img_tag'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Image tag help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['All caps message label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[message_all_caps]" value="1"<?php if ($pun_config['p_message_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[message_all_caps]" value="0"<?php if ($pun_config['p_message_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['All caps message help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['All caps subject label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="1"<?php if ($pun_config['p_subject_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="0"<?php if ($pun_config['p_subject_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['All caps subject help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Require e-mail label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[force_guest_email]" value="1"<?php if ($pun_config['p_force_guest_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[force_guest_email]" value="0"<?php if ($pun_config['p_force_guest_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Require e-mail help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_permissions['Signatures subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_permissions['BBCode sigs label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="1"<?php if ($pun_config['p_sig_bbcode'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="0"<?php if ($pun_config['p_sig_bbcode'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['BBCode sigs help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Image tag sigs label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="1"<?php if ($pun_config['p_sig_img_tag'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="0"<?php if ($pun_config['p_sig_img_tag'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Image tag sigs help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['All caps sigs label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="1"<?php if ($pun_config['p_sig_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="0"<?php if ($pun_config['p_sig_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['All caps sigs help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Max sig length label'] ?></th>									<td>										<input type="text" name="form[sig_length]" size="5" maxlength="5" value="<?php echo $pun_config['p_sig_length'] ?>" />										<span class="clearb"><?php echo $lang_admin_permissions['Max sig length help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Max sig lines label'] ?></th>									<td>										<input type="text" name="form[sig_lines]" size="3" maxlength="3" value="<?php echo $pun_config['p_sig_lines'] ?>" />										<span class="clearb"><?php echo $lang_admin_permissions['Max sig lines help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_permissions['Registration subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Banned e-mail label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="1"<?php if ($pun_config['p_allow_banned_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="0"<?php if ($pun_config['p_allow_banned_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Banned e-mail help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_permissions['Duplicate e-mail label'] ?></th>									<td>										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="1"<?php if ($pun_config['p_allow_dupe_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="0"<?php if ($pun_config['p_allow_dupe_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_permissions['Duplicate e-mail help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" /></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_censoring.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_censoring.php';// Add a censor wordif (isset($_POST['add_word'])){	confirm_referrer('admin_censoring.php');	$search_for = pun_trim($_POST['new_search_for']);	$replace_with = pun_trim($_POST['new_replace_with']);	if ($search_for == '')		message($lang_admin_censoring['Must enter word message']);	$db->query('INSERT INTO '.$db->prefix.'censoring (search_for, replace_with) VALUES (\''.$db->escape($search_for).'\', \''.$db->escape($replace_with).'\')') or error('Unable to add censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php', $lang_admin_censoring['Word added redirect']);}// Update a censor wordelse if (isset($_POST['update'])){	confirm_referrer('admin_censoring.php');	$id = intval(key($_POST['update']));	$search_for = pun_trim($_POST['search_for'][$id]);	$replace_with = pun_trim($_POST['replace_with'][$id]);	if ($search_for == '')		message($lang_admin_censoring['Must enter word message']);	$db->query('UPDATE '.$db->prefix.'censoring SET search_for=\''.$db->escape($search_for).'\', replace_with=\''.$db->escape($replace_with).'\' WHERE id='.$id) or error('Unable to update censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php', $lang_admin_censoring['Word updated redirect']);}// Remove a censor wordelse if (isset($_POST['remove'])){	confirm_referrer('admin_censoring.php');	$id = intval(key($_POST['remove']));	$db->query('DELETE FROM '.$db->prefix.'censoring WHERE id='.$id) or error('Unable to delete censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php',  $lang_admin_censoring['Word removed redirect']);}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Censoring']);$focus_element = array('censoring', 'new_search_for');define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('censoring');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_censoring['Censoring head'] ?></span></h2>		<div class="box">			<form id="censoring" method="post" action="admin_censoring.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_censoring['Add word subhead'] ?></legend>						<div class="infldset">							<p><?php echo $lang_admin_censoring['Add word info'].' '.($pun_config['o_censoring'] == '1' ? sprintf($lang_admin_censoring['Censoring enabled'], '<a href="admin_options.php#censoring">'.$lang_admin_common['Options'].'</a>') : sprintf($lang_admin_censoring['Censoring disabled'], '<a href="admin_options.php#censoring">'.$lang_admin_common['Options'].'</a>')) ?></p>							<table cellspacing="0">							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_censoring['Censored word label'] ?></th>									<th class="tc2" scope="col"><?php echo $lang_admin_censoring['Replacement label'] ?></th>									<th class="hidehead" scope="col"><?php echo $lang_admin_censoring['Action label'] ?></th>								</tr>							</thead>							<tbody>								<tr>									<td class="tcl"><input type="text" name="new_search_for" size="24" maxlength="60" tabindex="1" /></td>									<td class="tc2"><input type="text" name="new_replace_with" size="24" maxlength="60" tabindex="2" /></td>									<td><input type="submit" name="add_word" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="3" /></td>								</tr>							</tbody>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_censoring['Edit remove subhead'] ?></legend>						<div class="infldset"><?php$result = $db->query('SELECT id, search_for, replace_with FROM '.$db->prefix.'censoring ORDER BY id') or error('Unable to fetch censor word list', __FILE__, __LINE__, $db->error());if ($db->num_rows($result)){?>							<table cellspacing="0" >							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_censoring['Censored word label'] ?></th>									<th class="tc2" scope="col"><?php echo $lang_admin_censoring['Replacement label'] ?></th>									<th class="hidehead" scope="col"><?php echo $lang_admin_censoring['Action label'] ?></th>								</tr>							</thead>							<tbody><?php	while ($cur_word = $db->fetch_assoc($result))		echo "\t\t\t\t\t\t\t\t".'<tr><td class="tcl"><input type="text" name="search_for['.$cur_word['id'].']" value="'.pun_htmlspecialchars($cur_word['search_for']).'" size="24" maxlength="60" /></td><td class="tc2"><input type="text" name="replace_with['.$cur_word['id'].']" value="'.pun_htmlspecialchars($cur_word['replace_with']).'" size="24" maxlength="60" /></td><td><input type="submit" name="update['.$cur_word['id'].']" value="'.$lang_admin_common['Update'].'" />&#160;<input type="submit" name="remove['.$cur_word['id'].']" value="'.$lang_admin_common['Remove'].'" /></td></tr>'."\n";?>							</tbody>							</table><?php}else	echo "\t\t\t\t\t\t\t".'<p>'.$lang_admin_censoring['No words in list'].'</p>'."\n";?>						</div>					</fieldset>				</div>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Make sure no one attempts to run this script "directly"if (!defined('PUN'))	exit;$tpl_temp = trim(ob_get_contents());$tpl_main = str_replace('<pun_main>', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <pun_main>// START SUBST - <pun_footer>ob_start();?><div id="brdfooter" class="block">	<h2><span><?php echo $lang_common['Board footer'] ?></span></h2>	<div class="box"><?phpif (isset($footer_style) && ($footer_style == 'viewforum' || $footer_style == 'viewtopic') && $is_admmod){	echo "\t\t".'<div id="modcontrols" class="inbox">'."\n";	if ($footer_style == 'viewforum')	{		echo "\t\t\t".'<dl>'."\n";		echo "\t\t\t\t".'<dt><strong>'.$lang_forum['Mod controls'].'</strong></dt>'."\n";		echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;p='.$p.'">'.$lang_common['Moderate forum'].'</a></span></dd>'."\n";		echo "\t\t\t".'</dl>'."\n";	}	else if ($footer_style == 'viewtopic')	{		echo "\t\t\t".'<dl>'."\n";		echo "\t\t\t\t".'<dt><strong>'.$lang_topic['Mod controls'].'</strong></dt>'."\n";		echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;tid='.$id.'&amp;p='.$p.'">'.$lang_common['Moderate topic'].'</a></span></dd>'."\n";		echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;move_topics='.$id.'">'.$lang_common['Move topic'].'</a></span></dd>'."\n";		if ($cur_topic['closed'] == '1')			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;open='.$id.'">'.$lang_common['Open topic'].'</a></span></dd>'."\n";		else			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;close='.$id.'">'.$lang_common['Close topic'].'</a></span></dd>'."\n";		if ($cur_topic['sticky'] == '1')			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;unstick='.$id.'">'.$lang_common['Unstick topic'].'</a></span></dd>'."\n";		else			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;stick='.$id.'">'.$lang_common['Stick topic'].'</a></span></dd>'."\n";		echo "\t\t\t".'</dl>'."\n";	}	echo "\t\t\t".'<div class="clearer"></div>'."\n\t\t".'</div>'."\n";}?>		<div id="brdfooternav" class="inbox"><?phpecho "\t\t\t".'<div class="conl">'."\n";// Display the "Jump to" drop listif ($pun_config['o_quickjump'] == '1'){	// Load cached quick jump	if (file_exists(FORUM_CACHE_DIR.'cache_quickjump_'.$pun_user['g_id'].'.php'))		include FORUM_CACHE_DIR.'cache_quickjump_'.$pun_user['g_id'].'.php';	if (!defined('PUN_QJ_LOADED'))	{		if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))			require PUN_ROOT.'include/cache.php';		generate_quickjump_cache($pun_user['g_id']);		require FORUM_CACHE_DIR.'cache_quickjump_'.$pun_user['g_id'].'.php';	}}echo "\t\t\t".'</div>'."\n";?>			<div class="conr"><?php// If no footer style has been specified, we use the default (only copyright/debug info)$footer_style = isset($footer_style) ? $footer_style : NULL;if ($footer_style == 'index'){	if ($pun_config['o_feed_type'] == '1')		echo "\t\t\t\t".'<p id="feedlinks"><span class="rss"><a href="extern.php?action=feed&amp;type=rss">'.$lang_common['RSS active topics feed'].'</a></span></p>'."\n";	else if ($pun_config['o_feed_type'] == '2')		echo "\t\t\t\t".'<p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;type=atom">'.$lang_common['Atom active topics feed'].'</a></span></p>'."\n";}else if ($footer_style == 'viewforum'){	if ($pun_config['o_feed_type'] == '1')		echo "\t\t\t\t".'<p id="feedlinks"><span class="rss"><a href="extern.php?action=feed&amp;fid='.$forum_id.'&amp;type=rss">'.$lang_common['RSS forum feed'].'</a></span></p>'."\n";	else if ($pun_config['o_feed_type'] == '2')		echo "\t\t\t\t".'<p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;fid='.$forum_id.'&amp;type=atom">'.$lang_common['Atom forum feed'].'</a></span></p>'."\n";}else if ($footer_style == 'viewtopic'){	if ($pun_config['o_feed_type'] == '1')		echo "\t\t\t\t".'<p id="feedlinks"><span class="rss"><a href="extern.php?action=feed&amp;tid='.$id.'&amp;type=rss">'.$lang_common['RSS topic feed'].'</a></span></p>'."\n";	else if ($pun_config['o_feed_type'] == '2')		echo "\t\t\t\t".'<p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid='.$id.'&amp;type=atom">'.$lang_common['Atom topic feed'].'</a></span></p>'."\n";}?>				<p id="poweredby"><?php printf($lang_common['Powered by'], '<a href="http://fluxbb.org/">FluxBB</a>'.(($pun_config['o_show_version'] == '1') ? ' '.$pun_config['o_cur_version'] : '')) ?></p>			</div>			<div class="clearer"></div>		</div>	</div></div><?php// Display debug info (if enabled/defined)if (defined('PUN_DEBUG')){	echo '<p id="debugtime">[ ';	// Calculate script generation time	$time_diff = sprintf('%.3f', get_microtime() - $pun_start);	echo sprintf($lang_common['Querytime'], $time_diff, $db->get_num_queries());	if (function_exists('memory_get_usage'))	{		echo ' - '.sprintf($lang_common['Memory usage'], file_size(memory_get_usage()));		if (function_exists('memory_get_peak_usage'))			echo ' '.sprintf($lang_common['Peak usage'], file_size(memory_get_peak_usage()));	}	echo ' ]</p>'."\n";}// End the transaction$db->end_transaction();// Display executed queries (if enabled)if (defined('PUN_SHOW_QUERIES'))	display_saved_queries();$tpl_temp = trim(ob_get_contents());$tpl_main = str_replace('<pun_footer>', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <pun_footer>// Close the db connection (and free up any result data)$db->close();// Spit out the pageexit($tpl_main);
