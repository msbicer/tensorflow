<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');else if ($pun_user['g_view_users'] == '0')	message($lang_common['No permission'], false, '403 Forbidden');// Load the userlist.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/userlist.php';// Load the search.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/search.php';// Determine if we are allowed to view post counts$show_post_count = ($pun_config['o_show_post_count'] == '1' || $pun_user['is_admmod']) ? true : false;$username = isset($_GET['username']) && $pun_user['g_search_users'] == '1' ? pun_trim($_GET['username']) : '';$show_group = isset($_GET['show_group']) ? intval($_GET['show_group']) : -1;$sort_by = isset($_GET['sort_by']) && (in_array($_GET['sort_by'], array('username', 'registered')) || ($_GET['sort_by'] == 'num_posts' && $show_post_count)) ? $_GET['sort_by'] : 'username';$sort_dir = isset($_GET['sort_dir']) && $_GET['sort_dir'] == 'DESC' ? 'DESC' : 'ASC';// Create any SQL for the WHERE clause$where_sql = array();$like_command = ($db_type == 'pgsql') ? 'ILIKE' : 'LIKE';if ($username != '')	$where_sql[] = 'u.username '.$like_command.' \''.$db->escape(str_replace('*', '%', $username)).'\'';if ($show_group > -1)	$where_sql[] = 'u.group_id='.$show_group;// Fetch user count$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'users AS u WHERE u.id>1 AND u.group_id!='.PUN_UNVERIFIED.(!empty($where_sql) ? ' AND '.implode(' AND ', $where_sql) : '')) or error('Unable to fetch user list count', __FILE__, __LINE__, $db->error());$num_users = $db->result($result);// Determine the user offset (based on $_GET['p'])$num_pages = ceil($num_users / 50);$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);$start_from = 50 * ($p - 1);$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_common['User list']);if ($pun_user['g_search_users'] == '1')	$focus_element = array('userlist', 'username');// Generate paging links$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'userlist.php?username='.urlencode($username).'&amp;show_group='.$show_group.'&amp;sort_by='.$sort_by.'&amp;sort_dir='.$sort_dir);define('PUN_ALLOW_INDEX', 1);define('PUN_ACTIVE_PAGE', 'userlist');require PUN_ROOT.'header.php';?><div class="blockform">	<h2><span><?php echo $lang_search['User search'] ?></span></h2>	<div class="box">		<form id="userlist" method="get" action="userlist.php">			<div class="inform">				<fieldset>					<legend><?php echo $lang_ul['User find legend'] ?></legend>					<div class="infldset"><?php if ($pun_user['g_search_users'] == '1'): ?>						<label class="conl"><?php echo $lang_common['Username'] ?><br /><input type="text" name="username" value="<?php echo pun_htmlspecialchars($username) ?>" size="25" maxlength="25" /><br /></label><?php endif; ?>						<label class="conl"><?php echo $lang_ul['User group']."\n" ?>						<br /><select name="show_group">							<option value="-1"<?php if ($show_group == -1) echo ' selected="selected"' ?>><?php echo $lang_ul['All users'] ?></option><?php$result = $db->query('SELECT g_id, g_title FROM '.$db->prefix.'groups WHERE g_id!='.PUN_GUEST.' ORDER BY g_id') or error('Unable to fetch user group list', __FILE__, __LINE__, $db->error());while ($cur_group = $db->fetch_assoc($result)){	if ($cur_group['g_id'] == $show_group)		echo "\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'" selected="selected">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";	else		echo "\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";}?>						</select>						<br /></label>						<label class="conl"><?php echo $lang_search['Sort by']."\n" ?>						<br /><select name="sort_by">							<option value="username"<?php if ($sort_by == 'username') echo ' selected="selected"' ?>><?php echo $lang_common['Username'] ?></option>							<option value="registered"<?php if ($sort_by == 'registered') echo ' selected="selected"' ?>><?php echo $lang_common['Registered'] ?></option><?php if ($show_post_count): ?>							<option value="num_posts"<?php if ($sort_by == 'num_posts') echo ' selected="selected"' ?>><?php echo $lang_ul['No of posts'] ?></option><?php endif; ?>						</select>						<br /></label>						<label class="conl"><?php echo $lang_search['Sort order']."\n" ?>						<br /><select name="sort_dir">							<option value="ASC"<?php if ($sort_dir == 'ASC') echo ' selected="selected"' ?>><?php echo $lang_search['Ascending'] ?></option>							<option value="DESC"<?php if ($sort_dir == 'DESC') echo ' selected="selected"' ?>><?php echo $lang_search['Descending'] ?></option>						</select>						<br /></label>						<p class="clearb"><?php echo ($pun_user['g_search_users'] == '1' ? $lang_ul['User search info'].' ' : '').$lang_ul['User sort info']; ?></p>					</div>				</fieldset>			</div>			<p class="buttons"><input type="submit" name="search" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /></p>		</form>	</div></div><div class="linkst">	<div class="inbox">		<p class="pagelink"><?php echo $paging_links ?></p>		<div class="clearer"></div>	</div></div><div id="users1" class="blocktable">	<h2><span><?php echo $lang_common['User list'] ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_common['Username'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_common['Title'] ?></th><?php if ($show_post_count): ?>					<th class="tc3" scope="col"><?php echo $lang_common['Posts'] ?></th><?php endif; ?>					<th class="tcr" scope="col"><?php echo $lang_common['Registered'] ?></th>				</tr>			</thead>			<tbody><?php// Retrieve a list of user IDs, LIMIT is (really) expensive so we only fetch the IDs here then later fetch the remaining data$result = $db->query('SELECT u.id FROM '.$db->prefix.'users AS u WHERE u.id>1 AND u.group_id!='.PUN_UNVERIFIED.(!empty($where_sql) ? ' AND '.implode(' AND ', $where_sql) : '').' ORDER BY '.$sort_by.' '.$sort_dir.', u.id ASC LIMIT '.$start_from.', 50') or error('Unable to fetch user IDs', __FILE__, __LINE__, $db->error());if ($db->num_rows($result)){	$user_ids = array();	for ($i = 0;$cur_user_id = $db->result($result, $i);$i++)		$user_ids[] = $cur_user_id;	// Grab the users	$result = $db->query('SELECT u.id, u.username, u.title, u.num_posts, u.registered, g.g_id, g.g_user_title FROM '.$db->prefix.'users AS u LEFT JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id WHERE u.id IN('.implode(',', $user_ids).') ORDER BY '.$sort_by.' '.$sort_dir.', u.id ASC') or error('Unable to fetch user list', __FILE__, __LINE__, $db->error());	while ($user_data = $db->fetch_assoc($result))	{		$user_title_field = get_title($user_data);?>				<tr>					<td class="tcl"><?php echo '<a href="profile.php?id='.$user_data['id'].'">'.pun_htmlspecialchars($user_data['username']).'</a>' ?></td>					<td class="tc2"><?php echo $user_title_field ?></td><?php if ($show_post_count): ?>					<td class="tc3"><?php echo forum_number_format($user_data['num_posts']) ?></td><?php endif; ?>					<td class="tcr"><?php echo format_time($user_data['registered'], true) ?></td>				</tr><?php	}}else	echo "\t\t\t".'<tr>'."\n\t\t\t\t\t".'<td class="tcl" colspan="'.(($show_post_count) ? 4 : 3).'">'.$lang_search['No hits'].'</td></tr>'."\n";?>			</tbody>			</table>		</div>	</div></div><div class="linksb">	<div class="inbox">		<p class="pagelink"><?php echo $paging_links ?></p>		<div class="clearer"></div>	</div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_censoring.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_censoring.php';// Add a censor wordif (isset($_POST['add_word'])){	confirm_referrer('admin_censoring.php');	$search_for = pun_trim($_POST['new_search_for']);	$replace_with = pun_trim($_POST['new_replace_with']);	if ($search_for == '')		message($lang_admin_censoring['Must enter word message']);	$db->query('INSERT INTO '.$db->prefix.'censoring (search_for, replace_with) VALUES (\''.$db->escape($search_for).'\', \''.$db->escape($replace_with).'\')') or error('Unable to add censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php', $lang_admin_censoring['Word added redirect']);}// Update a censor wordelse if (isset($_POST['update'])){	confirm_referrer('admin_censoring.php');	$id = intval(key($_POST['update']));	$search_for = pun_trim($_POST['search_for'][$id]);	$replace_with = pun_trim($_POST['replace_with'][$id]);	if ($search_for == '')		message($lang_admin_censoring['Must enter word message']);	$db->query('UPDATE '.$db->prefix.'censoring SET search_for=\''.$db->escape($search_for).'\', replace_with=\''.$db->escape($replace_with).'\' WHERE id='.$id) or error('Unable to update censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php', $lang_admin_censoring['Word updated redirect']);}// Remove a censor wordelse if (isset($_POST['remove'])){	confirm_referrer('admin_censoring.php');	$id = intval(key($_POST['remove']));	$db->query('DELETE FROM '.$db->prefix.'censoring WHERE id='.$id) or error('Unable to delete censor word', __FILE__, __LINE__, $db->error());	// Regenerate the censoring cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_censoring_cache();	redirect('admin_censoring.php',  $lang_admin_censoring['Word removed redirect']);}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Censoring']);$focus_element = array('censoring', 'new_search_for');define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('censoring');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_censoring['Censoring head'] ?></span></h2>		<div class="box">			<form id="censoring" method="post" action="admin_censoring.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_censoring['Add word subhead'] ?></legend>						<div class="infldset">							<p><?php echo $lang_admin_censoring['Add word info'].' '.($pun_config['o_censoring'] == '1' ? sprintf($lang_admin_censoring['Censoring enabled'], '<a href="admin_options.php#censoring">'.$lang_admin_common['Options'].'</a>') : sprintf($lang_admin_censoring['Censoring disabled'], '<a href="admin_options.php#censoring">'.$lang_admin_common['Options'].'</a>')) ?></p>							<table cellspacing="0">							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_censoring['Censored word label'] ?></th>									<th class="tc2" scope="col"><?php echo $lang_admin_censoring['Replacement label'] ?></th>									<th class="hidehead" scope="col"><?php echo $lang_admin_censoring['Action label'] ?></th>								</tr>							</thead>							<tbody>								<tr>									<td class="tcl"><input type="text" name="new_search_for" size="24" maxlength="60" tabindex="1" /></td>									<td class="tc2"><input type="text" name="new_replace_with" size="24" maxlength="60" tabindex="2" /></td>									<td><input type="submit" name="add_word" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="3" /></td>								</tr>							</tbody>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_censoring['Edit remove subhead'] ?></legend>						<div class="infldset"><?php$result = $db->query('SELECT id, search_for, replace_with FROM '.$db->prefix.'censoring ORDER BY id') or error('Unable to fetch censor word list', __FILE__, __LINE__, $db->error());if ($db->num_rows($result)){?>							<table cellspacing="0" >							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_censoring['Censored word label'] ?></th>									<th class="tc2" scope="col"><?php echo $lang_admin_censoring['Replacement label'] ?></th>									<th class="hidehead" scope="col"><?php echo $lang_admin_censoring['Action label'] ?></th>								</tr>							</thead>							<tbody><?php	while ($cur_word = $db->fetch_assoc($result))		echo "\t\t\t\t\t\t\t\t".'<tr><td class="tcl"><input type="text" name="search_for['.$cur_word['id'].']" value="'.pun_htmlspecialchars($cur_word['search_for']).'" size="24" maxlength="60" /></td><td class="tc2"><input type="text" name="replace_with['.$cur_word['id'].']" value="'.pun_htmlspecialchars($cur_word['replace_with']).'" size="24" maxlength="60" /></td><td><input type="submit" name="update['.$cur_word['id'].']" value="'.$lang_admin_common['Update'].'" />&#160;<input type="submit" name="remove['.$cur_word['id'].']" value="'.$lang_admin_common['Remove'].'" /></td></tr>'."\n";?>							</tbody>							</table><?php}else	echo "\t\t\t\t\t\t\t".'<p>'.$lang_admin_censoring['No words in list'].'</p>'."\n";?>						</div>					</fieldset>				</div>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');// Load the index.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/index.php';// Get list of forums and topics with new posts since last visitif (!$pun_user['is_guest']){	$result = $db->query('SELECT t.forum_id, t.id, t.last_post FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.$pun_user['last_visit'].' AND t.moved_to IS NULL') or error('Unable to fetch new topics', __FILE__, __LINE__, $db->error());	$new_topics = array();	while ($cur_topic = $db->fetch_assoc($result))		$new_topics[$cur_topic['forum_id']][$cur_topic['id']] = $cur_topic['last_post'];	$tracked_topics = get_tracked_topics();}if ($pun_config['o_feed_type'] == '1')	$page_head = array('feed' => '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;type=rss" title="'.$lang_common['RSS active topics feed'].'" />');else if ($pun_config['o_feed_type'] == '2')	$page_head = array('feed' => '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;type=atom" title="'.$lang_common['Atom active topics feed'].'" />');$forum_actions = array();// Display a "mark all as read" linkif (!$pun_user['is_guest'])	$forum_actions[] = '<a href="misc.php?action=markread">'.$lang_common['Mark all as read'].'</a>';$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']));define('PUN_ALLOW_INDEX', 1);define('PUN_ACTIVE_PAGE', 'index');require PUN_ROOT.'header.php';// Print the categories and forums$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.forum_desc, f.redirect_url, f.moderators, f.num_topics, f.num_posts, f.last_post, f.last_post_id, f.last_poster FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE fp.read_forum IS NULL OR fp.read_forum=1 ORDER BY c.disp_position, c.id, f.disp_position', true) or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());$cur_category = 0;$cat_count = 0;$forum_count = 0;while ($cur_forum = $db->fetch_assoc($result)){	$moderators = '';	if ($cur_forum['cid'] != $cur_category) // A new category since last iteration?	{		if ($cur_category != 0)			echo "\t\t\t".'</tbody>'."\n\t\t\t".'</table>'."\n\t\t".'</div>'."\n\t".'</div>'."\n".'</div>'."\n\n";		++$cat_count;		$forum_count = 0;?><div id="idx<?php echo $cat_count ?>" class="blocktable">	<h2><span><?php echo pun_htmlspecialchars($cur_forum['cat_name']) ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_common['Forum'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_index['Topics'] ?></th>					<th class="tc3" scope="col"><?php echo $lang_common['Posts'] ?></th>					<th class="tcr" scope="col"><?php echo $lang_common['Last post'] ?></th>				</tr>			</thead>			<tbody><?php		$cur_category = $cur_forum['cid'];	}	++$forum_count;	$item_status = ($forum_count % 2 == 0) ? 'roweven' : 'rowodd';	$forum_field_new = '';	$icon_type = 'icon';	// Are there new posts since our last visit?	if (!$pun_user['is_guest'] && $cur_forum['last_post'] > $pun_user['last_visit'] && (empty($tracked_topics['forums'][$cur_forum['fid']]) || $cur_forum['last_post'] > $tracked_topics['forums'][$cur_forum['fid']]))	{		// There are new posts in this forum, but have we read all of them already?		foreach ($new_topics[$cur_forum['fid']] as $check_topic_id => $check_last_post)		{			if ((empty($tracked_topics['topics'][$check_topic_id]) || $tracked_topics['topics'][$check_topic_id] < $check_last_post) && (empty($tracked_topics['forums'][$cur_forum['fid']]) || $tracked_topics['forums'][$cur_forum['fid']] < $check_last_post))			{				$item_status .= ' inew';				$forum_field_new = '<span class="newtext">[ <a href="search.php?action=show_new&amp;fid='.$cur_forum['fid'].'">'.$lang_common['New posts'].'</a> ]</span>';				$icon_type = 'icon icon-new';				break;			}		}	}	// Is this a redirect forum?	if ($cur_forum['redirect_url'] != '')	{		$forum_field = '<h3><span class="redirtext">'.$lang_index['Link to'].'</span> <a href="'.pun_htmlspecialchars($cur_forum['redirect_url']).'" title="'.$lang_index['Link to'].' '.pun_htmlspecialchars($cur_forum['redirect_url']).'">'.pun_htmlspecialchars($cur_forum['forum_name']).'</a></h3>';		$num_topics = $num_posts = '-';		$item_status .= ' iredirect';		$icon_type = 'icon';	}	else	{		$forum_field = '<h3><a href="viewforum.php?id='.$cur_forum['fid'].'">'.pun_htmlspecialchars($cur_forum['forum_name']).'</a>'.(!empty($forum_field_new) ? ' '.$forum_field_new : '').'</h3>';		$num_topics = $cur_forum['num_topics'];		$num_posts = $cur_forum['num_posts'];	}	if ($cur_forum['forum_desc'] != '')		$forum_field .= "\n\t\t\t\t\t\t\t\t".'<div class="forumdesc">'.$cur_forum['forum_desc'].'</div>';	// If there is a last_post/last_poster	if ($cur_forum['last_post'] != '')		$last_post = '<a href="viewtopic.php?pid='.$cur_forum['last_post_id'].'#p'.$cur_forum['last_post_id'].'">'.format_time($cur_forum['last_post']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_forum['last_poster']).'</span>';	else if ($cur_forum['redirect_url'] != '')		$last_post = '- - -';	else		$last_post = $lang_common['Never'];	if ($cur_forum['moderators'] != '')	{		$mods_array = unserialize($cur_forum['moderators']);		$moderators = array();		foreach ($mods_array as $mod_username => $mod_id)		{			if ($pun_user['g_view_users'] == '1')				$moderators[] = '<a href="profile.php?id='.$mod_id.'">'.pun_htmlspecialchars($mod_username).'</a>';			else				$moderators[] = pun_htmlspecialchars($mod_username);		}		$moderators = "\t\t\t\t\t\t\t\t".'<p class="modlist">(<em>'.$lang_common['Moderated by'].'</em> '.implode(', ', $moderators).')</p>'."\n";	}?>				<tr class="<?php echo $item_status ?>">					<td class="tcl">						<div class="<?php echo $icon_type ?>"><div class="nosize"><?php echo forum_number_format($forum_count) ?></div></div>						<div class="tclcon">							<div>								<?php echo $forum_field."\n".$moderators ?>							</div>						</div>					</td>					<td class="tc2"><?php echo forum_number_format($num_topics) ?></td>					<td class="tc3"><?php echo forum_number_format($num_posts) ?></td>					<td class="tcr"><?php echo $last_post ?></td>				</tr><?php}// Did we output any categories and forums?if ($cur_category > 0)	echo "\t\t\t".'</tbody>'."\n\t\t\t".'</table>'."\n\t\t".'</div>'."\n\t".'</div>'."\n".'</div>'."\n\n";else	echo '<div id="idx0" class="block"><div class="box"><div class="inbox"><p>'.$lang_index['Empty board'].'</p></div></div></div>';// Collect some statistics from the databaseif (file_exists(FORUM_CACHE_DIR.'cache_users_info.php'))	include FORUM_CACHE_DIR.'cache_users_info.php';if (!defined('PUN_USERS_INFO_LOADED')){	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_users_info_cache();	require FORUM_CACHE_DIR.'cache_users_info.php';}$result = $db->query('SELECT SUM(num_topics), SUM(num_posts) FROM '.$db->prefix.'forums') or error('Unable to fetch topic/post count', __FILE__, __LINE__, $db->error());list($stats['total_topics'], $stats['total_posts']) = $db->fetch_row($result);if ($pun_user['g_view_users'] == '1')	$stats['newest_user'] = '<a href="profile.php?id='.$stats['last_user']['id'].'">'.pun_htmlspecialchars($stats['last_user']['username']).'</a>';else	$stats['newest_user'] = pun_htmlspecialchars($stats['last_user']['username']);if (!empty($forum_actions)){?><div class="linksb">	<div class="inbox crumbsplus">		<p class="subscribelink clearb"><?php echo implode(' - ', $forum_actions); ?></p>	</div></div><?php}?><div id="brdstats" class="block">	<h2><span><?php echo $lang_index['Board info'] ?></span></h2>	<div class="box">		<div class="inbox">			<dl class="conr">				<dt><strong><?php echo $lang_index['Board stats'] ?></strong></dt>				<dd><span><?php printf($lang_index['No of users'], '<strong>'.forum_number_format($stats['total_users']).'</strong>') ?></span></dd>				<dd><span><?php printf($lang_index['No of topics'], '<strong>'.forum_number_format($stats['total_topics']).'</strong>') ?></span></dd>				<dd><span><?php printf($lang_index['No of posts'], '<strong>'.forum_number_format($stats['total_posts']).'</strong>') ?></span></dd>			</dl>			<dl class="conl">				<dt><strong><?php echo $lang_index['User info'] ?></strong></dt>				<dd><span><?php printf($lang_index['Newest user'], $stats['newest_user']) ?></span></dd><?phpif ($pun_config['o_users_online'] == '1'){	// Fetch users online info and generate strings for output	$num_guests = 0;	$users = array();	$result = $db->query('SELECT user_id, ident FROM '.$db->prefix.'online WHERE idle=0 ORDER BY ident', true) or error('Unable to fetch online list', __FILE__, __LINE__, $db->error());	while ($pun_user_online = $db->fetch_assoc($result))	{		if ($pun_user_online['user_id'] > 1)		{			if ($pun_user['g_view_users'] == '1')				$users[] = "\n\t\t\t\t".'<dd><a href="profile.php?id='.$pun_user_online['user_id'].'">'.pun_htmlspecialchars($pun_user_online['ident']).'</a>';			else				$users[] = "\n\t\t\t\t".'<dd>'.pun_htmlspecialchars($pun_user_online['ident']);		}		else			++$num_guests;	}	$num_users = count($users);	echo "\t\t\t\t".'<dd><span>'.sprintf($lang_index['Users online'], '<strong>'.forum_number_format($num_users).'</strong>').'</span></dd>'."\n\t\t\t\t".'<dd><span>'.sprintf($lang_index['Guests online'], '<strong>'.forum_number_format($num_guests).'</strong>').'</span></dd>'."\n\t\t\t".'</dl>'."\n";	if ($num_users > 0)		echo "\t\t\t".'<dl id="onlinelist" class="clearb">'."\n\t\t\t\t".'<dt><strong>'.$lang_index['Online'].' </strong></dt>'."\t\t\t\t".implode(',</dd> ', $users).'</dd>'."\n\t\t\t".'</dl>'."\n";	else		echo "\t\t\t".'<div class="clearer"></div>'."\n";}else	echo "\t\t\t".'</dl>'."\n\t\t\t".'<div class="clearer"></div>'."\n";?>		</div>	</div></div><?php$footer_style = 'index';require PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the help templatedefine('PUN_HELP', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');// Load the help.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/help.php';$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_help['Help']);define('PUN_ACTIVE_PAGE', 'help');require PUN_ROOT.'header.php';?><h2><span><?php echo $lang_help['BBCode'] ?></span></h2><div class="box">	<div class="inbox">		<p><a name="bbcode"></a><?php echo $lang_help['BBCode info 1'] ?></p>		<p><?php echo $lang_help['BBCode info 2'] ?></p>	</div></div><h2><span><?php echo $lang_help['Text style'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Text style info'] ?></p>		<p><code>[b]<?php echo $lang_help['Bold text'] ?>[/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><?php echo $lang_help['Bold text'] ?></strong></samp></p>		<p><code>[u]<?php echo $lang_help['Underlined text'] ?>[/u]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbu"><?php echo $lang_help['Underlined text'] ?></span></samp></p>		<p><code>[i]<?php echo $lang_help['Italic text'] ?>[/i]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Italic text'] ?></em></samp></p>		<p><code>[s]<?php echo $lang_help['Strike-through text'] ?>[/s]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbs"><?php echo $lang_help['Strike-through text'] ?></span></samp></p>		<p><code>[del]<?php echo $lang_help['Deleted text'] ?>[/del]</code> <?php echo $lang_help['produces'] ?> <samp><del><?php echo $lang_help['Deleted text'] ?></del></samp></p>		<p><code>[ins]<?php echo $lang_help['Inserted text'] ?>[/ins]</code> <?php echo $lang_help['produces'] ?> <samp><ins><?php echo $lang_help['Inserted text'] ?></ins></samp></p>		<p><code>[em]<?php echo $lang_help['Emphasised text'] ?>[/em]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Emphasised text'] ?></em></samp></p>		<p><code>[color=#FF0000]<?php echo $lang_help['Red text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: #ff0000"><?php echo $lang_help['Red text'] ?></span></samp></p>		<p><code>[color=blue]<?php echo $lang_help['Blue text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: blue"><?php echo $lang_help['Blue text'] ?></span></samp></p>		<p><code>[h]<?php echo $lang_help['Heading text'] ?>[/h]</code> <?php echo $lang_help['produces'] ?></p> <div class="postmsg"><h5><?php echo $lang_help['Heading text'] ?></h5></div>	</div></div><h2><span><?php echo $lang_help['Links and images'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Links info'] ?></p>		<p><a name="url"></a><code>[url=<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>]<?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?></a></samp></p>		<p><code>[url]<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/') ?></a></samp></p>		<p><code>[url=/help.php]<?php echo $lang_help['This help page'] ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/help.php') ?>"><?php echo $lang_help['This help page'] ?></a></samp></p>		<p><code>[email]myname@example.com[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com">myname@example.com</a></samp></p>		<p><code>[email=myname@example.com]<?php echo $lang_help['My email address'] ?>[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com"><?php echo $lang_help['My email address'] ?></a></samp></p>		<p><code>[topic=1]<?php echo $lang_help['Test topic'] ?>[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo $lang_help['Test topic'] ?></a></samp></p>		<p><code>[topic]1[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?></a></samp></p>		<p><code>[post=1]<?php echo $lang_help['Test post'] ?>[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo $lang_help['Test post'] ?></a></samp></p>		<p><code>[post]1[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?></a></samp></p>		<p><code>[forum=1]<?php echo $lang_help['Test forum'] ?>[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo $lang_help['Test forum'] ?></a></samp></p>		<p><code>[forum]1[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?></a></samp></p>		<p><code>[user=2]<?php echo $lang_help['Test user'] ?>[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo $lang_help['Test user'] ?></a></samp></p>		<p><code>[user]2[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?></a></samp></p>	</div>	<div class="inbox">		<p><a name="img"></a><?php echo $lang_help['Images info'] ?></p>		<p><code>[img=<?php echo $lang_help['FluxBB bbcode test'] ?>]<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png[/img]</code> <?php echo $lang_help['produces'] ?> <samp><img style="height: 21px" src="<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png" alt="<?php echo $lang_help['FluxBB bbcode test'] ?>" /></samp></p>	</div></div><h2><span><?php echo $lang_help['Quotes'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Quotes info'] ?></p>		<p><code>[quote=James]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>		<p><?php echo $lang_help['produces quote box'] ?></p>		<div class="postmsg">			<div class="quotebox"><cite>James <?php echo $lang_common['wrote'] ?></cite><blockquote><div><p><?php echo $lang_help['Quote text'] ?></p></div></blockquote></div>		</div>		<p><?php echo $lang_help['Quotes info 2'] ?></p>		<p><code>[quote]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>		<p><?php echo $lang_help['produces quote box'] ?></p>		<div class="postmsg">			<div class="quotebox"><blockquote><div><p><?php echo $lang_help['Quote text'] ?></p></div></blockquote></div>		</div>		<p><?php echo $lang_help['quote note'] ?></p>	</div></div><h2><span><?php echo $lang_help['Code'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Code info'] ?></p>		<p><code>[code]<?php echo $lang_help['Code text'] ?>[/code]</code></p>		<p><?php echo $lang_help['produces code box'] ?></p>		<div class="postmsg">			<div class="codebox"><pre><code><?php echo $lang_help['Code text'] ?></code></pre></div>		</div>	</div></div><h2><span><?php echo $lang_help['Lists'] ?></span></h2><div class="box">	<div class="inbox">		<p><a name="lists"></a><?php echo $lang_help['List info'] ?></p>		<p><code>[list][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>		<br /><span><?php echo $lang_help['produces list'] ?></span></p>		<div class="postmsg">			<ul><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ul>		</div>		<p><code>[list=1][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>		<br /><span><?php echo $lang_help['produces decimal list'] ?></span></p>		<div class="postmsg">			<ol class="decimal"><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ol>		</div>		<p><code>[list=a][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>		<br /><span><?php echo $lang_help['produces alpha list'] ?></span></p>		<div class="postmsg">			<ol class="alpha"><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ol>		</div>	</div></div><h2><span><?php echo $lang_help['Nested tags'] ?></span></h2><div class="box">	<div class="inbox">		<p><?php echo $lang_help['Nested tags info'] ?></p>		<p><code>[b][u]<?php echo $lang_help['Bold, underlined text'] ?>[/u][/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><span class="bbu"><?php echo $lang_help['Bold, underlined text'] ?></span></strong></samp></p>	</div></div><h2><span><?php echo $lang_help['Smilies'] ?></span></h2><div class="box">	<div class="inbox">		<p><a name="smilies"></a><?php echo $lang_help['Smilies info'] ?></p><?php// Display the smiley setrequire PUN_ROOT.'include/parser.php';$smiley_groups = array();foreach ($smilies as $smiley_text => $smiley_img)	$smiley_groups[$smiley_img][] = $smiley_text;foreach ($smiley_groups as $smiley_img => $smiley_texts)	echo "\t\t".'<p><code>'.implode('</code> '.$lang_common['and'].' <code>', $smiley_texts).'</code> <span>'.$lang_help['produces'].'</span> <samp><img src="'.pun_htmlspecialchars(get_base_url(true)).'/img/smilies/'.$smiley_img.'" width="15" height="15" alt="'.$smiley_texts[0].'" /></samp></p>'."\n";?>	</div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Make sure no one attempts to run this script "directly"if (!defined('PUN'))	exit;$tpl_temp = trim(ob_get_contents());$tpl_main = str_replace('<pun_main>', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <pun_main>// START SUBST - <pun_footer>ob_start();?><div id="brdfooter" class="block">	<h2><span><?php echo $lang_common['Board footer'] ?></span></h2>	<div class="box"><?phpif (isset($footer_style) && ($footer_style == 'viewforum' || $footer_style == 'viewtopic') && $is_admmod){	echo "\t\t".'<div id="modcontrols" class="inbox">'."\n";	if ($footer_style == 'viewforum')	{		echo "\t\t\t".'<dl>'."\n";		echo "\t\t\t\t".'<dt><strong>'.$lang_forum['Mod controls'].'</strong></dt>'."\n";		echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;p='.$p.'">'.$lang_common['Moderate forum'].'</a></span></dd>'."\n";		echo "\t\t\t".'</dl>'."\n";	}	else if ($footer_style == 'viewtopic')	{		echo "\t\t\t".'<dl>'."\n";		echo "\t\t\t\t".'<dt><strong>'.$lang_topic['Mod controls'].'</strong></dt>'."\n";		echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;tid='.$id.'&amp;p='.$p.'">'.$lang_common['Moderate topic'].'</a></span></dd>'."\n";		echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;move_topics='.$id.'">'.$lang_common['Move topic'].'</a></span></dd>'."\n";		if ($cur_topic['closed'] == '1')			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;open='.$id.'">'.$lang_common['Open topic'].'</a></span></dd>'."\n";		else			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;close='.$id.'">'.$lang_common['Close topic'].'</a></span></dd>'."\n";		if ($cur_topic['sticky'] == '1')			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;unstick='.$id.'">'.$lang_common['Unstick topic'].'</a></span></dd>'."\n";		else			echo "\t\t\t\t".'<dd><span><a href="moderate.php?fid='.$forum_id.'&amp;stick='.$id.'">'.$lang_common['Stick topic'].'</a></span></dd>'."\n";		echo "\t\t\t".'</dl>'."\n";	}	echo "\t\t\t".'<div class="clearer"></div>'."\n\t\t".'</div>'."\n";}?>		<div id="brdfooternav" class="inbox"><?phpecho "\t\t\t".'<div class="conl">'."\n";// Display the "Jump to" drop listif ($pun_config['o_quickjump'] == '1'){	// Load cached quick jump	if (file_exists(FORUM_CACHE_DIR.'cache_quickjump_'.$pun_user['g_id'].'.php'))		include FORUM_CACHE_DIR.'cache_quickjump_'.$pun_user['g_id'].'.php';	if (!defined('PUN_QJ_LOADED'))	{		if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))			require PUN_ROOT.'include/cache.php';		generate_quickjump_cache($pun_user['g_id']);		require FORUM_CACHE_DIR.'cache_quickjump_'.$pun_user['g_id'].'.php';	}}echo "\t\t\t".'</div>'."\n";?>			<div class="conr"><?php// If no footer style has been specified, we use the default (only copyright/debug info)$footer_style = isset($footer_style) ? $footer_style : NULL;if ($footer_style == 'index'){	if ($pun_config['o_feed_type'] == '1')		echo "\t\t\t\t".'<p id="feedlinks"><span class="rss"><a href="extern.php?action=feed&amp;type=rss">'.$lang_common['RSS active topics feed'].'</a></span></p>'."\n";	else if ($pun_config['o_feed_type'] == '2')		echo "\t\t\t\t".'<p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;type=atom">'.$lang_common['Atom active topics feed'].'</a></span></p>'."\n";}else if ($footer_style == 'viewforum'){	if ($pun_config['o_feed_type'] == '1')		echo "\t\t\t\t".'<p id="feedlinks"><span class="rss"><a href="extern.php?action=feed&amp;fid='.$forum_id.'&amp;type=rss">'.$lang_common['RSS forum feed'].'</a></span></p>'."\n";	else if ($pun_config['o_feed_type'] == '2')		echo "\t\t\t\t".'<p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;fid='.$forum_id.'&amp;type=atom">'.$lang_common['Atom forum feed'].'</a></span></p>'."\n";}else if ($footer_style == 'viewtopic'){	if ($pun_config['o_feed_type'] == '1')		echo "\t\t\t\t".'<p id="feedlinks"><span class="rss"><a href="extern.php?action=feed&amp;tid='.$id.'&amp;type=rss">'.$lang_common['RSS topic feed'].'</a></span></p>'."\n";	else if ($pun_config['o_feed_type'] == '2')		echo "\t\t\t\t".'<p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid='.$id.'&amp;type=atom">'.$lang_common['Atom topic feed'].'</a></span></p>'."\n";}?>				<p id="poweredby"><?php printf($lang_common['Powered by'], '<a href="http://fluxbb.org/">FluxBB</a>'.(($pun_config['o_show_version'] == '1') ? ' '.$pun_config['o_cur_version'] : '')) ?></p>			</div>			<div class="clearer"></div>		</div>	</div></div><?php// Display debug info (if enabled/defined)if (defined('PUN_DEBUG')){	echo '<p id="debugtime">[ ';	// Calculate script generation time	$time_diff = sprintf('%.3f', get_microtime() - $pun_start);	echo sprintf($lang_common['Querytime'], $time_diff, $db->get_num_queries());	if (function_exists('memory_get_usage'))	{		echo ' - '.sprintf($lang_common['Memory usage'], file_size(memory_get_usage()));		if (function_exists('memory_get_peak_usage'))			echo ' '.sprintf($lang_common['Peak usage'], file_size(memory_get_peak_usage()));	}	echo ' ]</p>'."\n";}// End the transaction$db->end_transaction();// Display executed queries (if enabled)if (defined('PUN_SHOW_QUERIES'))	display_saved_queries();$tpl_temp = trim(ob_get_contents());$tpl_main = str_replace('<pun_footer>', $tpl_temp, $tpl_main);ob_end_clean();// END SUBST - <pun_footer>// Close the db connection (and free up any result data)$db->close();// Spit out the pageexit($tpl_main);
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');$id = isset($_GET['id']) ? intval($_GET['id']) : 0;if ($id < 1)	message($lang_common['Bad request'], false, '404 Not Found');// Load the viewforum.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/forum.php';// Fetch some info about the forumif (!$pun_user['is_guest'])	$result = $db->query('SELECT f.forum_name, f.redirect_url, f.moderators, f.num_topics, f.sort_by, fp.post_topics, s.user_id AS is_subscribed FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_subscriptions AS s ON (f.id=s.forum_id AND s.user_id='.$pun_user['id'].') LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());else	$result = $db->query('SELECT f.forum_name, f.redirect_url, f.moderators, f.num_topics, f.sort_by, fp.post_topics, 0 AS is_subscribed FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());if (!$db->num_rows($result))	message($lang_common['Bad request'], false, '404 Not Found');$cur_forum = $db->fetch_assoc($result);// Is this a redirect forum? In that case, redirect!if ($cur_forum['redirect_url'] != ''){	header('Location: '.$cur_forum['redirect_url']);	exit;}// Sort out who the moderators are and if we are currently a moderator (or an admin)$mods_array = ($cur_forum['moderators'] != '') ? unserialize($cur_forum['moderators']) : array();$is_admmod = ($pun_user['g_id'] == PUN_ADMIN || ($pun_user['g_moderator'] == '1' && array_key_exists($pun_user['username'], $mods_array))) ? true : false;switch ($cur_forum['sort_by']){	case 0:		$sort_by = 'last_post DESC';		break;	case 1:		$sort_by = 'posted DESC';		break;	case 2:		$sort_by = 'subject ASC';		break;	default:		$sort_by = 'last_post DESC';		break;}// Can we or can we not post new topics?if (($cur_forum['post_topics'] == '' && $pun_user['g_post_topics'] == '1') || $cur_forum['post_topics'] == '1' || $is_admmod)	$post_link = "\t\t\t".'<p class="postlink conr"><a href="post.php?fid='.$id.'">'.$lang_forum['Post topic'].'</a></p>'."\n";else	$post_link = '';// Get topic/forum tracking dataif (!$pun_user['is_guest'])	$tracked_topics = get_tracked_topics();// Determine the topic offset (based on $_GET['p'])$num_pages = ceil($cur_forum['num_topics'] / $pun_user['disp_topics']);$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);$start_from = $pun_user['disp_topics'] * ($p - 1);// Generate paging links$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'viewforum.php?id='.$id);if ($pun_config['o_feed_type'] == '1')	$page_head = array('feed' => '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;fid='.$id.'&amp;type=rss" title="'.$lang_common['RSS forum feed'].'" />');else if ($pun_config['o_feed_type'] == '2')	$page_head = array('feed' => '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;fid='.$id.'&amp;type=atom" title="'.$lang_common['Atom forum feed'].'" />');$forum_actions = array();if (!$pun_user['is_guest']){	if ($pun_config['o_forum_subscriptions'] == '1')	{		if ($cur_forum['is_subscribed'])			$forum_actions[] = '<span>'.$lang_forum['Is subscribed'].' - </span><a href="misc.php?action=unsubscribe&amp;fid='.$id.'">'.$lang_forum['Unsubscribe'].'</a>';		else			$forum_actions[] = '<a href="misc.php?action=subscribe&amp;fid='.$id.'">'.$lang_forum['Subscribe'].'</a>';	}	$forum_actions[] = '<a href="misc.php?action=markforumread&amp;fid='.$id.'">'.$lang_common['Mark forum read'].'</a>';}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), pun_htmlspecialchars($cur_forum['forum_name']));define('PUN_ALLOW_INDEX', 1);define('PUN_ACTIVE_PAGE', 'index');require PUN_ROOT.'header.php';?><div class="linkst">	<div class="inbox crumbsplus">		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><strong><a href="viewforum.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></a></strong></li>		</ul>		<div class="pagepost">			<p class="pagelink conl"><?php echo $paging_links ?></p><?php echo $post_link ?>		</div>		<div class="clearer"></div>	</div></div><div id="vf" class="blocktable">	<h2><span><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_common['Topic'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_common['Replies'] ?></th><?php if ($pun_config['o_topic_views'] == '1'): ?>					<th class="tc3" scope="col"><?php echo $lang_forum['Views'] ?></th><?php endif; ?>					<th class="tcr" scope="col"><?php echo $lang_common['Last post'] ?></th>				</tr>			</thead>			<tbody><?php// Retrieve a list of topic IDs, LIMIT is (really) expensive so we only fetch the IDs here then later fetch the remaining data$result = $db->query('SELECT id FROM '.$db->prefix.'topics WHERE forum_id='.$id.' ORDER BY sticky DESC, '.$sort_by.', id DESC LIMIT '.$start_from.', '.$pun_user['disp_topics']) or error('Unable to fetch topic IDs', __FILE__, __LINE__, $db->error());// If there are topics in this forumif ($db->num_rows($result)){	$topic_ids = array();	for ($i = 0;$cur_topic_id = $db->result($result, $i);$i++)		$topic_ids[] = $cur_topic_id;	if (empty($topic_ids))		error('The topic table and forum table seem to be out of sync!', __FILE__, __LINE__);	// Fetch list of topics to display on this page	if ($pun_user['is_guest'] || $pun_config['o_show_dot'] == '0')	{		// Without "the dot"		$sql = 'SELECT id, poster, subject, posted, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $topic_ids).') ORDER BY sticky DESC, '.$sort_by.', id DESC';	}	else	{		// With "the dot"		$sql = 'SELECT p.poster_id AS has_posted, t.id, t.subject, t.poster, t.posted, t.last_post, t.last_post_id, t.last_poster, t.num_views, t.num_replies, t.closed, t.sticky, t.moved_to FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'posts AS p ON t.id=p.topic_id AND p.poster_id='.$pun_user['id'].' WHERE t.id IN('.implode(',', $topic_ids).') GROUP BY t.id'.($db_type == 'pgsql' ? ', t.subject, t.poster, t.posted, t.last_post, t.last_post_id, t.last_poster, t.num_views, t.num_replies, t.closed, t.sticky, t.moved_to, p.poster_id' : '').' ORDER BY t.sticky DESC, t.'.$sort_by.', t.id DESC';	}	$result = $db->query($sql) or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());	$topic_count = 0;	while ($cur_topic = $db->fetch_assoc($result))	{		++$topic_count;		$status_text = array();		$item_status = ($topic_count % 2 == 0) ? 'roweven' : 'rowodd';		$icon_type = 'icon';		if (is_null($cur_topic['moved_to']))			$last_post = '<a href="viewtopic.php?pid='.$cur_topic['last_post_id'].'#p'.$cur_topic['last_post_id'].'">'.format_time($cur_topic['last_post']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_topic['last_poster']).'</span>';		else			$last_post = '- - -';		if ($pun_config['o_censoring'] == '1')			$cur_topic['subject'] = censor_words($cur_topic['subject']);		if ($cur_topic['sticky'] == '1')		{			$item_status .= ' isticky';			$status_text[] = '<span class="stickytext">'.$lang_forum['Sticky'].'</span>';		}		if ($cur_topic['moved_to'] != 0)		{			$subject = '<a href="viewtopic.php?id='.$cur_topic['moved_to'].'">'.pun_htmlspecialchars($cur_topic['subject']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_topic['poster']).'</span>';			$status_text[] = '<span class="movedtext">'.$lang_forum['Moved'].'</span>';			$item_status .= ' imoved';		}		else if ($cur_topic['closed'] == '0')			$subject = '<a href="viewtopic.php?id='.$cur_topic['id'].'">'.pun_htmlspecialchars($cur_topic['subject']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_topic['poster']).'</span>';		else		{			$subject = '<a href="viewtopic.php?id='.$cur_topic['id'].'">'.pun_htmlspecialchars($cur_topic['subject']).'</a> <span class="byuser">'.$lang_common['by'].' '.pun_htmlspecialchars($cur_topic['poster']).'</span>';			$status_text[] = '<span class="closedtext">'.$lang_forum['Closed'].'</span>';			$item_status .= ' iclosed';		}		if (!$pun_user['is_guest'] && $cur_topic['last_post'] > $pun_user['last_visit'] && (!isset($tracked_topics['topics'][$cur_topic['id']]) || $tracked_topics['topics'][$cur_topic['id']] < $cur_topic['last_post']) && (!isset($tracked_topics['forums'][$id]) || $tracked_topics['forums'][$id] < $cur_topic['last_post']) && is_null($cur_topic['moved_to']))		{			$item_status .= ' inew';			$icon_type = 'icon icon-new';			$subject = '<strong>'.$subject.'</strong>';			$subject_new_posts = '<span class="newtext">[ <a href="viewtopic.php?id='.$cur_topic['id'].'&amp;action=new" title="'.$lang_common['New posts info'].'">'.$lang_common['New posts'].'</a> ]</span>';		}		else			$subject_new_posts = null;		// Insert the status text before the subject		$subject = implode(' ', $status_text).' '.$subject;		// Should we display the dot or not? :)		if (!$pun_user['is_guest'] && $pun_config['o_show_dot'] == '1')		{			if ($cur_topic['has_posted'] == $pun_user['id'])			{				$subject = '<strong class="ipost">&#160;</strong>'.$subject;				$item_status .= ' iposted';			}		}		$num_pages_topic = ceil(($cur_topic['num_replies'] + 1) / $pun_user['disp_posts']);		if ($num_pages_topic > 1)			$subject_multipage = '<span class="pagestext">[ '.paginate($num_pages_topic, -1, 'viewtopic.php?id='.$cur_topic['id']).' ]</span>';		else			$subject_multipage = null;		// Should we show the "New posts" and/or the multipage links?		if (!empty($subject_new_posts) || !empty($subject_multipage))		{			$subject .= !empty($subject_new_posts) ? ' '.$subject_new_posts : '';			$subject .= !empty($subject_multipage) ? ' '.$subject_multipage : '';		}?>				<tr class="<?php echo $item_status ?>">					<td class="tcl">						<div class="<?php echo $icon_type ?>"><div class="nosize"><?php echo forum_number_format($topic_count + $start_from) ?></div></div>						<div class="tclcon">							<div>								<?php echo $subject."\n" ?>							</div>						</div>					</td>					<td class="tc2"><?php echo (is_null($cur_topic['moved_to'])) ? forum_number_format($cur_topic['num_replies']) : '-' ?></td><?php if ($pun_config['o_topic_views'] == '1'): ?>					<td class="tc3"><?php echo (is_null($cur_topic['moved_to'])) ? forum_number_format($cur_topic['num_views']) : '-' ?></td><?php endif; ?>					<td class="tcr"><?php echo $last_post ?></td>				</tr><?php	}}else{	$colspan = ($pun_config['o_topic_views'] == '1') ? 4 : 3;?>				<tr class="rowodd inone">					<td class="tcl" colspan="<?php echo $colspan ?>">						<div class="icon inone"><div class="nosize"><!-- --></div></div>						<div class="tclcon">							<div>								<strong><?php echo $lang_forum['Empty forum'] ?></strong>							</div>						</div>					</td>				</tr><?php}?>			</tbody>			</table>		</div>	</div></div><div class="linksb">	<div class="inbox crumbsplus">		<div class="pagepost">			<p class="pagelink conl"><?php echo $paging_links ?></p><?php echo $post_link ?>		</div>		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><strong><a href="viewforum.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></a></strong></li>		</ul><?php echo (!empty($forum_actions) ? "\t\t".'<p class="subscribelink clearb">'.implode(' - ', $forum_actions).'</p>'."\n" : '') ?>		<div class="clearer"></div>	</div></div><?php$forum_id = $id;$footer_style = 'viewforum';require PUN_ROOT.'footer.php';
