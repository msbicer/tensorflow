<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_censoring.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_groups.php';// Fetch all groups$result = $db->query('SELECT * FROM '.$db->prefix.'groups ORDER BY g_id') or error('Unable to fetch user groups', __FILE__, __LINE__, $db->error());$groups = array();while ($cur_group = $db->fetch_assoc($result))	$groups[$cur_group['g_id']] = $cur_group;// Add/edit a group (stage 1)if (isset($_POST['add_group']) || isset($_GET['edit_group'])){	if (isset($_POST['add_group']))	{		$base_group = intval($_POST['base_group']);		$group = $groups[$base_group];		$mode = 'add';	}	else // We are editing a group	{		$group_id = intval($_GET['edit_group']);		if ($group_id < 1 || !isset($groups[$group_id]))			message($lang_common['Bad request']);		$group = $groups[$group_id];		$mode = 'edit';	}	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['User groups']);	$required_fields = array('req_title' => $lang_admin_groups['Group title label']);	$focus_element = array('groups2', 'req_title');	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';	generate_admin_menu('groups');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_groups['Group settings head'] ?></span></h2>		<div class="box">			<form id="groups2" method="post" action="admin_groups.php" onsubmit="return process_form(this)">				<p class="submittop"><input type="submit" name="add_edit_group" value="<?php echo $lang_admin_common['Save'] ?>" /></p>				<div class="inform">					<input type="hidden" name="mode" value="<?php echo $mode ?>" /><?php if ($mode == 'edit'): ?>					<input type="hidden" name="group_id" value="<?php echo $group_id ?>" /><?php endif; ?><?php if ($mode == 'add'): ?>					<input type="hidden" name="base_group" value="<?php echo $base_group ?>" /><?php endif; ?>					<fieldset>						<legend><?php echo $lang_admin_groups['Group settings subhead'] ?></legend>						<div class="infldset">							<p><?php echo $lang_admin_groups['Group settings info'] ?></p>							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_groups['Group title label'] ?></th>									<td>										<input type="text" name="req_title" size="25" maxlength="50" value="<?php if ($mode == 'edit') echo pun_htmlspecialchars($group['g_title']); ?>" tabindex="1" />									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['User title label'] ?></th>									<td>										<input type="text" name="user_title" size="25" maxlength="50" value="<?php echo pun_htmlspecialchars($group['g_user_title']) ?>" tabindex="2" />										<span><?php printf($lang_admin_groups['User title help'], ($group['g_id'] != PUN_GUEST ? $lang_common['Member'] : $lang_common['Guest'])) ?></span>									</td>								</tr><?php if ($group['g_id'] != PUN_ADMIN): if ($group['g_id'] != PUN_GUEST): ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Promote users label'] ?></th>									<td>										<select name="promote_next_group" tabindex="3">											<option value="0"><?php echo $lang_admin_groups['Disable promotion'] ?></option><?phpforeach ($groups as $cur_group){	if (($cur_group['g_id'] != $group['g_id'] || $mode == 'add') && $cur_group['g_id'] != PUN_ADMIN && $cur_group['g_id'] != PUN_GUEST)	{		if ($cur_group['g_id'] == $group['g_promote_next_group'])			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'" selected="selected">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";		else			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";	}}?>										</select>										<input type="text" name="promote_min_posts" size="5" maxlength="10" value="<?php echo pun_htmlspecialchars($group['g_promote_min_posts']) ?>" tabindex="4" />										<span><?php printf($lang_admin_groups['Promote users help'], $lang_admin_groups['Disable promotion']) ?></span>									</td>								</tr><?php if ($mode != 'edit' || $pun_config['o_default_user_group'] != $group['g_id']): ?>								<tr>									<th scope="row"> <?php echo $lang_admin_groups['Mod privileges label'] ?></th>									<td>										<label class="conl"><input type="radio" name="moderator" value="1"<?php if ($group['g_moderator'] == '1') echo ' checked="checked"' ?> tabindex="5" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="moderator" value="0"<?php if ($group['g_moderator'] == '0') echo ' checked="checked"' ?> tabindex="6" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Mod privileges help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Edit profile label'] ?></th>									<td>										<label class="conl"><input type="radio" name="mod_edit_users" value="1"<?php if ($group['g_mod_edit_users'] == '1') echo ' checked="checked"' ?> tabindex="7" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="mod_edit_users" value="0"<?php if ($group['g_mod_edit_users'] == '0') echo ' checked="checked"' ?> tabindex="8" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Edit profile help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Rename users label'] ?></th>									<td>										<label class="conl"><input type="radio" name="mod_rename_users" value="1"<?php if ($group['g_mod_rename_users'] == '1') echo ' checked="checked"' ?> tabindex="9" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="mod_rename_users" value="0"<?php if ($group['g_mod_rename_users'] == '0') echo ' checked="checked"' ?> tabindex="10" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Rename users help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Change passwords label'] ?></th>									<td>										<label class="conl"><input type="radio" name="mod_change_passwords" value="1"<?php if ($group['g_mod_change_passwords'] == '1') echo ' checked="checked"' ?> tabindex="11" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="mod_change_passwords" value="0"<?php if ($group['g_mod_change_passwords'] == '0') echo ' checked="checked"' ?> tabindex="12" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Change passwords help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Ban users label'] ?></th>									<td>										<label class="conl"><input type="radio" name="mod_ban_users" value="1"<?php if ($group['g_mod_ban_users'] == '1') echo ' checked="checked"' ?> tabindex="13" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="mod_ban_users" value="0"<?php if ($group['g_mod_ban_users'] == '0') echo ' checked="checked"' ?> tabindex="14" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Ban users help'] ?></span>									</td>								</tr><?php endif; endif; ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Read board label'] ?></th>									<td>										<label class="conl"><input type="radio" name="read_board" value="1"<?php if ($group['g_read_board'] == '1') echo ' checked="checked"' ?> tabindex="15" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="read_board" value="0"<?php if ($group['g_read_board'] == '0') echo ' checked="checked"' ?> tabindex="16" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Read board help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['View user info label'] ?></th>									<td>										<label class="conl"><input type="radio" name="view_users" value="1"<?php if ($group['g_view_users'] == '1') echo ' checked="checked"' ?> tabindex="17" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="view_users" value="0"<?php if ($group['g_view_users'] == '0') echo ' checked="checked"' ?> tabindex="18" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['View user info help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Post replies label'] ?></th>									<td>										<label class="conl"><input type="radio" name="post_replies" value="1"<?php if ($group['g_post_replies'] == '1') echo ' checked="checked"' ?> tabindex="19" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="post_replies" value="0"<?php if ($group['g_post_replies'] == '0') echo ' checked="checked"' ?> tabindex="20" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Post replies help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Post topics label'] ?></th>									<td>										<label class="conl"><input type="radio" name="post_topics" value="1"<?php if ($group['g_post_topics'] == '1') echo ' checked="checked"' ?> tabindex="21" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="post_topics" value="0"<?php if ($group['g_post_topics'] == '0') echo ' checked="checked"' ?> tabindex="22" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Post topics help'] ?></span>									</td>								</tr><?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Edit posts label'] ?></th>									<td>										<label class="conl"><input type="radio" name="edit_posts" value="1"<?php if ($group['g_edit_posts'] == '1') echo ' checked="checked"' ?> tabindex="23" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="edit_posts" value="0"<?php if ($group['g_edit_posts'] == '0') echo ' checked="checked"' ?> tabindex="24" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Edit posts help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Delete posts label'] ?></th>									<td>										<label class="conl"><input type="radio" name="delete_posts" value="1"<?php if ($group['g_delete_posts'] == '1') echo ' checked="checked"' ?> tabindex="25" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="delete_posts" value="0"<?php if ($group['g_delete_posts'] == '0') echo ' checked="checked"' ?> tabindex="26" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Delete posts help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Delete topics label'] ?></th>									<td>										<label class="conl"><input type="radio" name="delete_topics" value="1"<?php if ($group['g_delete_topics'] == '1') echo ' checked="checked"' ?> tabindex="27" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="delete_topics" value="0"<?php if ($group['g_delete_topics'] == '0') echo ' checked="checked"' ?> tabindex="28" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Delete topics help'] ?></span>									</td>								</tr><?php endif; ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Post links label'] ?></th>									<td>										<label class="conl"><input type="radio" name="post_links" value="1"<?php if ($group['g_post_links'] == '1') echo ' checked="checked"' ?> tabindex="29" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="post_links" value="0"<?php if ($group['g_post_links'] == '0') echo ' checked="checked"' ?> tabindex="30" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Post links help'] ?></span>									</td>								</tr><?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Set own title label'] ?></th>									<td>										<label class="conl"><input type="radio" name="set_title" value="1"<?php if ($group['g_set_title'] == '1') echo ' checked="checked"' ?> tabindex="31" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="set_title" value="0"<?php if ($group['g_set_title'] == '0') echo ' checked="checked"' ?> tabindex="32" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Set own title help'] ?></span>									</td>								</tr><?php endif; ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['User search label'] ?></th>									<td>										<label class="conl"><input type="radio" name="search" value="1"<?php if ($group['g_search'] == '1') echo ' checked="checked"' ?> tabindex="33" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="search" value="0"<?php if ($group['g_search'] == '0') echo ' checked="checked"' ?> tabindex="34" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['User search help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['User list search label'] ?></th>									<td>										<label class="conl"><input type="radio" name="search_users" value="1"<?php if ($group['g_search_users'] == '1') echo ' checked="checked"' ?> tabindex="35" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="search_users" value="0"<?php if ($group['g_search_users'] == '0') echo ' checked="checked"' ?> tabindex="36" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['User list search help'] ?></span>									</td>								</tr><?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Send e-mails label'] ?></th>									<td>										<label class="conl"><input type="radio" name="send_email" value="1"<?php if ($group['g_send_email'] == '1') echo ' checked="checked"' ?> tabindex="37" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>										<label class="conl"><input type="radio" name="send_email" value="0"<?php if ($group['g_send_email'] == '0') echo ' checked="checked"' ?> tabindex="38" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>										<span class="clearb"><?php echo $lang_admin_groups['Send e-mails help'] ?></span>									</td>								</tr><?php endif; ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Post flood label'] ?></th>									<td>										<input type="text" name="post_flood" size="5" maxlength="4" value="<?php echo $group['g_post_flood'] ?>" tabindex="39" />										<span><?php echo $lang_admin_groups['Post flood help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Search flood label'] ?></th>									<td>										<input type="text" name="search_flood" size="5" maxlength="4" value="<?php echo $group['g_search_flood'] ?>" tabindex="40" />										<span><?php echo $lang_admin_groups['Search flood help'] ?></span>									</td>								</tr><?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>									<th scope="row"><?php echo $lang_admin_groups['E-mail flood label'] ?></th>									<td>										<input type="text" name="email_flood" size="5" maxlength="4" value="<?php echo $group['g_email_flood'] ?>" tabindex="41" />										<span><?php echo $lang_admin_groups['E-mail flood help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_groups['Report flood label'] ?></th>									<td>										<input type="text" name="report_flood" size="5" maxlength="4" value="<?php echo $group['g_report_flood'] ?>" tabindex="42" />										<span><?php echo $lang_admin_groups['Report flood help'] ?></span>									</td>								</tr><?php endif; endif; ?>							</table><?php if ($group['g_moderator'] == '1' ): ?>							<p class="warntext"><?php echo $lang_admin_groups['Moderator info'] ?></p><?php endif; ?>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="add_edit_group" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="43" /></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php	require PUN_ROOT.'footer.php';}// Add/edit a group (stage 2)else if (isset($_POST['add_edit_group'])){	confirm_referrer('admin_groups.php');	// Is this the admin group? (special rules apply)	$is_admin_group = (isset($_POST['group_id']) && $_POST['group_id'] == PUN_ADMIN) ? true : false;	$title = pun_trim($_POST['req_title']);	$user_title = pun_trim($_POST['user_title']);	$promote_min_posts = isset($_POST['promote_min_posts']) ? intval($_POST['promote_min_posts']) : '0';	if (isset($_POST['promote_next_group']) &&			isset($groups[$_POST['promote_next_group']]) &&			!in_array($_POST['promote_next_group'], array(PUN_ADMIN, PUN_GUEST)) &&			(!isset($_POST['group_id']) || $_POST['promote_next_group'] != $_POST['group_id']))		$promote_next_group = $_POST['promote_next_group'];	else		$promote_next_group = '0';	$moderator = isset($_POST['moderator']) && $_POST['moderator'] == '1' ? '1' : '0';	$mod_edit_users = $moderator == '1' && isset($_POST['mod_edit_users']) && $_POST['mod_edit_users'] == '1' ? '1' : '0';	$mod_rename_users = $moderator == '1' && isset($_POST['mod_rename_users']) && $_POST['mod_rename_users'] == '1' ? '1' : '0';	$mod_change_passwords = $moderator == '1' && isset($_POST['mod_change_passwords']) && $_POST['mod_change_passwords'] == '1' ? '1' : '0';	$mod_ban_users = $moderator == '1' && isset($_POST['mod_ban_users']) && $_POST['mod_ban_users'] == '1' ? '1' : '0';	$read_board = isset($_POST['read_board']) ? intval($_POST['read_board']) : '1';	$view_users = (isset($_POST['view_users']) && $_POST['view_users'] == '1') || $is_admin_group ? '1' : '0';	$post_replies = isset($_POST['post_replies']) ? intval($_POST['post_replies']) : '1';	$post_topics = isset($_POST['post_topics']) ? intval($_POST['post_topics']) : '1';	$edit_posts = isset($_POST['edit_posts']) ? intval($_POST['edit_posts']) : ($is_admin_group) ? '1' : '0';	$delete_posts = isset($_POST['delete_posts']) ? intval($_POST['delete_posts']) : ($is_admin_group) ? '1' : '0';	$delete_topics = isset($_POST['delete_topics']) ? intval($_POST['delete_topics']) : ($is_admin_group) ? '1' : '0';	$post_links = isset($_POST['post_links']) ? intval($_POST['post_links']) : '1';	$set_title = isset($_POST['set_title']) ? intval($_POST['set_title']) : ($is_admin_group) ? '1' : '0';	$search = isset($_POST['search']) ? intval($_POST['search']) : '1';	$search_users = isset($_POST['search_users']) ? intval($_POST['search_users']) : '1';	$send_email = (isset($_POST['send_email']) && $_POST['send_email'] == '1') || $is_admin_group ? '1' : '0';	$post_flood = (isset($_POST['post_flood']) && $_POST['post_flood'] >= 0) ? intval($_POST['post_flood']) : '0';	$search_flood = (isset($_POST['search_flood']) && $_POST['search_flood'] >= 0) ? intval($_POST['search_flood']) : '0';	$email_flood = (isset($_POST['email_flood']) && $_POST['email_flood'] >= 0) ? intval($_POST['email_flood']) : '0';	$report_flood = (isset($_POST['report_flood']) && $_POST['report_flood'] >= 0) ? intval($_POST['report_flood']) : '0';	if ($title == '')		message($lang_admin_groups['Must enter title message']);	$user_title = ($user_title != '') ? '\''.$db->escape($user_title).'\'' : 'NULL';	if ($_POST['mode'] == 'add')	{		$result = $db->query('SELECT 1 FROM '.$db->prefix.'groups WHERE g_title=\''.$db->escape($title).'\'') or error('Unable to check group title collision', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result))			message(sprintf($lang_admin_groups['Title already exists message'], pun_htmlspecialchars($title)));		$db->query('INSERT INTO '.$db->prefix.'groups (g_title, g_user_title, g_promote_min_posts, g_promote_next_group, g_moderator, g_mod_edit_users, g_mod_rename_users, g_mod_change_passwords, g_mod_ban_users, g_read_board, g_view_users, g_post_replies, g_post_topics, g_edit_posts, g_delete_posts, g_delete_topics, g_post_links, g_set_title, g_search, g_search_users, g_send_email, g_post_flood, g_search_flood, g_email_flood, g_report_flood) VALUES(\''.$db->escape($title).'\', '.$user_title.', '.$promote_min_posts.', '.$promote_next_group.', '.$moderator.', '.$mod_edit_users.', '.$mod_rename_users.', '.$mod_change_passwords.', '.$mod_ban_users.', '.$read_board.', '.$view_users.', '.$post_replies.', '.$post_topics.', '.$edit_posts.', '.$delete_posts.', '.$delete_topics.', '.$post_links.', '.$set_title.', '.$search.', '.$search_users.', '.$send_email.', '.$post_flood.', '.$search_flood.', '.$email_flood.', '.$report_flood.')') or error('Unable to add group', __FILE__, __LINE__, $db->error());		$new_group_id = $db->insert_id();		// Now lets copy the forum specific permissions from the group which this group is based on		$result = $db->query('SELECT forum_id, read_forum, post_replies, post_topics FROM '.$db->prefix.'forum_perms WHERE group_id='.intval($_POST['base_group'])) or error('Unable to fetch group forum permission list', __FILE__, __LINE__, $db->error());		while ($cur_forum_perm = $db->fetch_assoc($result))			$db->query('INSERT INTO '.$db->prefix.'forum_perms (group_id, forum_id, read_forum, post_replies, post_topics) VALUES('.$new_group_id.', '.$cur_forum_perm['forum_id'].', '.$cur_forum_perm['read_forum'].', '.$cur_forum_perm['post_replies'].', '.$cur_forum_perm['post_topics'].')') or error('Unable to insert group forum permissions', __FILE__, __LINE__, $db->error());	}	else	{		$result = $db->query('SELECT 1 FROM '.$db->prefix.'groups WHERE g_title=\''.$db->escape($title).'\' AND g_id!='.intval($_POST['group_id'])) or error('Unable to check group title collision', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result))			message(sprintf($lang_admin_groups['Title already exists message'], pun_htmlspecialchars($title)));		$db->query('UPDATE '.$db->prefix.'groups SET g_title=\''.$db->escape($title).'\', g_user_title='.$user_title.', g_promote_min_posts='.$promote_min_posts.', g_promote_next_group='.$promote_next_group.', g_moderator='.$moderator.', g_mod_edit_users='.$mod_edit_users.', g_mod_rename_users='.$mod_rename_users.', g_mod_change_passwords='.$mod_change_passwords.', g_mod_ban_users='.$mod_ban_users.', g_read_board='.$read_board.', g_view_users='.$view_users.', g_post_replies='.$post_replies.', g_post_topics='.$post_topics.', g_edit_posts='.$edit_posts.', g_delete_posts='.$delete_posts.', g_delete_topics='.$delete_topics.', g_post_links='.$post_links.', g_set_title='.$set_title.', g_search='.$search.', g_search_users='.$search_users.', g_send_email='.$send_email.', g_post_flood='.$post_flood.', g_search_flood='.$search_flood.', g_email_flood='.$email_flood.', g_report_flood='.$report_flood.' WHERE g_id='.intval($_POST['group_id'])) or error('Unable to update group', __FILE__, __LINE__, $db->error());	}	// Regenerate the quick jump cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	$group_id = $_POST['mode'] == 'add' ? $new_group_id : intval($_POST['group_id']);	generate_quickjump_cache($group_id);	if ($_POST['mode'] == 'edit')		redirect('admin_groups.php', $lang_admin_groups['Group edited redirect']);	else		redirect('admin_groups.php', $lang_admin_groups['Group added redirect']);}// Set default groupelse if (isset($_POST['set_default_group'])){	confirm_referrer('admin_groups.php');	$group_id = intval($_POST['default_group']);	// Make sure it's not the admin or guest groups	if ($group_id == PUN_ADMIN || $group_id == PUN_GUEST)		message($lang_common['Bad request']);	// Make sure it's not a moderator group	if ($groups[$group_id]['g_moderator'] != 0)		message($lang_common['Bad request']);	$db->query('UPDATE '.$db->prefix.'config SET conf_value='.$group_id.' WHERE conf_name=\'o_default_user_group\'') or error('Unable to update board config', __FILE__, __LINE__, $db->error());	// Regenerate the config cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_config_cache();	redirect('admin_groups.php', $lang_admin_groups['Default group redirect']);}// Remove a groupelse if (isset($_GET['del_group'])){	confirm_referrer('admin_groups.php');	$group_id = isset($_POST['group_to_delete']) ? intval($_POST['group_to_delete']) : intval($_GET['del_group']);	if ($group_id < 5)		message($lang_common['Bad request']);	// Make sure we don't remove the default group	if ($group_id == $pun_config['o_default_user_group'])		message($lang_admin_groups['Cannot remove default message']);	// Check if this group has any members	$result = $db->query('SELECT g.g_title, COUNT(u.id) FROM '.$db->prefix.'groups AS g INNER JOIN '.$db->prefix.'users AS u ON g.g_id=u.group_id WHERE g.g_id='.$group_id.' GROUP BY g.g_id, g_title') or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());	// If the group doesn't have any members or if we've already selected a group to move the members to	if (!$db->num_rows($result) || isset($_POST['del_group']))	{		if (isset($_POST['del_group_comply']) || isset($_POST['del_group']))		{			if (isset($_POST['del_group']))			{				$move_to_group = intval($_POST['move_to_group']);				$db->query('UPDATE '.$db->prefix.'users SET group_id='.$move_to_group.' WHERE group_id='.$group_id) or error('Unable to move users into group', __FILE__, __LINE__, $db->error());			}			// Delete the group and any forum specific permissions			$db->query('DELETE FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to delete group', __FILE__, __LINE__, $db->error());			$db->query('DELETE FROM '.$db->prefix.'forum_perms WHERE group_id='.$group_id) or error('Unable to delete group forum permissions', __FILE__, __LINE__, $db->error());			// Don't let users be promoted to this group			$db->query('UPDATE '.$db->prefix.'groups SET g_promote_next_group=0 WHERE g_promote_next_group='.$group_id) or error('Unable to remove group as promotion target', __FILE__, __LINE__, $db->error());			redirect('admin_groups.php', $lang_admin_groups['Group removed redirect']);		}		else		{			$result = $db->query('SELECT g_title FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group title', __FILE__, __LINE__, $db->error());			$group_title = $db->result($result);			$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['User groups']);			define('PUN_ACTIVE_PAGE', 'admin');			require PUN_ROOT.'header.php';			generate_admin_menu('groups');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_groups['Group delete head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_groups.php?del_group=<?php echo $group_id ?>">				<div class="inform">				<input type="hidden" name="group_to_delete" value="<?php echo $group_id ?>" />					<fieldset>						<legend><?php echo $lang_admin_groups['Confirm delete subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_groups['Confirm delete info'], pun_htmlspecialchars($group_title)) ?></p>							<p class="warntext"><?php echo $lang_admin_groups['Confirm delete warn'] ?></p>						</div>					</fieldset>				</div>				<p class="buttons"><input type="submit" name="del_group_comply" value="<?php echo $lang_admin_common['Delete'] ?>" tabindex="1" /><a href="javascript:history.go(-1)" tabindex="2"><?php echo $lang_admin_common['Go back'] ?></a></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php			require PUN_ROOT.'footer.php';		}	}	list($group_title, $group_members) = $db->fetch_row($result);	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['User groups']);	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';	generate_admin_menu('groups');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_groups['Delete group head'] ?></span></h2>		<div class="box">			<form id="groups" method="post" action="admin_groups.php?del_group=<?php echo $group_id ?>">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_groups['Move users subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_groups['Move users info'], pun_htmlspecialchars($group_title), forum_number_format($group_members)) ?></p>							<label><?php echo $lang_admin_groups['Move users label'] ?>							<select name="move_to_group"><?php	$result = $db->query('SELECT g_id, g_title FROM '.$db->prefix.'groups WHERE g_id!='.PUN_GUEST.' AND g_id!='.$group_id.' ORDER BY g_title') or error('Unable to fetch user group list', __FILE__, __LINE__, $db->error());	while ($cur_group = $db->fetch_assoc($result))	{		if ($cur_group['g_id'] == PUN_MEMBER) // Pre-select the pre-defined Members group			echo "\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'" selected="selected">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";		else			echo "\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";	}?>							</select>							<br /></label>						</div>					</fieldset>				</div>				<p class="buttons"><input type="submit" name="del_group" value="<?php echo $lang_admin_groups['Delete group'] ?>" /><a href="javascript:history.go(-1)"><?php echo $lang_admin_common['Go back'] ?></a></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php	require PUN_ROOT.'footer.php';}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['User groups']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('groups');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_groups['Add groups head'] ?></span></h2>		<div class="box">			<form id="groups" method="post" action="admin_groups.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_groups['Add group subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_groups['New group label'] ?><div><input type="submit" name="add_group" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="2" /></div></th>									<td>										<select id="base_group" name="base_group" tabindex="1"><?phpforeach ($groups as $cur_group){	if ($cur_group['g_id'] != PUN_ADMIN && $cur_group['g_id'] != PUN_GUEST)	{		if ($cur_group['g_id'] == $pun_config['o_default_user_group'])			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'" selected="selected">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";		else			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";	}}?>										</select>										<span><?php echo $lang_admin_groups['New group help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_groups['Default group subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_groups['Default group label'] ?><div><input type="submit" name="set_default_group" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="4" /></div></th>									<td>										<select id="default_group" name="default_group" tabindex="3"><?phpforeach ($groups as $cur_group){	if ($cur_group['g_id'] > PUN_GUEST && $cur_group['g_moderator'] == 0)	{		if ($cur_group['g_id'] == $pun_config['o_default_user_group'])			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'" selected="selected">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";		else			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_group['g_id'].'">'.pun_htmlspecialchars($cur_group['g_title']).'</option>'."\n";	}}?>										</select>										<span><?php echo $lang_admin_groups['Default group help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>			</form>		</div>		<h2 class="block2"><span><?php echo $lang_admin_groups['Existing groups head'] ?></span></h2>		<div class="box">			<div class="fakeform">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_groups['Edit groups subhead'] ?></legend>						<div class="infldset">							<p><?php echo $lang_admin_groups['Edit groups info'] ?></p>							<table cellspacing="0"><?php$cur_index = 5;foreach ($groups as $cur_group)	echo "\t\t\t\t\t\t\t\t".'<tr><th scope="row"><a href="admin_groups.php?edit_group='.$cur_group['g_id'].'" tabindex="'.$cur_index++.'">'.$lang_admin_groups['Edit link'].'</a>'.(($cur_group['g_id'] > PUN_MEMBER) ? ' | <a href="admin_groups.php?del_group='.$cur_group['g_id'].'" tabindex="'.$cur_index++.'">'.$lang_admin_groups['Delete link'].'</a>' : '').'</th><td>'.pun_htmlspecialchars($cur_group['g_title']).'</td></tr>'."\n";?>							</table>						</div>					</fieldset>				</div>			</div>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN && ($pun_user['g_moderator'] != '1' || $pun_user['g_mod_ban_users'] == '0'))	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_bans.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_bans.php';// Add/edit a ban (stage 1)if (isset($_REQUEST['add_ban']) || isset($_GET['edit_ban'])){	if (isset($_GET['add_ban']) || isset($_POST['add_ban']))	{		// If the ID of the user to ban was provided through GET (a link from profile.php)		if (isset($_GET['add_ban']))		{			$user_id = intval($_GET['add_ban']);			if ($user_id < 2)				message($lang_common['Bad request']);			$result = $db->query('SELECT group_id, username, email FROM '.$db->prefix.'users WHERE id='.$user_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());			if ($db->num_rows($result))				list($group_id, $ban_user, $ban_email) = $db->fetch_row($result);			else				message($lang_admin_bans['No user ID message']);		}		else // Otherwise the username is in POST		{			$ban_user = pun_trim($_POST['new_ban_user']);			if ($ban_user != '')			{				$result = $db->query('SELECT id, group_id, username, email FROM '.$db->prefix.'users WHERE username=\''.$db->escape($ban_user).'\' AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());				if ($db->num_rows($result))					list($user_id, $group_id, $ban_user, $ban_email) = $db->fetch_row($result);				else					message($lang_admin_bans['No user message']);			}		}		// Make sure we're not banning an admin or moderator		if (isset($group_id))		{			if ($group_id == PUN_ADMIN)				message(sprintf($lang_admin_bans['User is admin message'], pun_htmlspecialchars($ban_user)));			$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());			$is_moderator_group = $db->result($result);			if ($is_moderator_group)				message(sprintf($lang_admin_bans['User is mod message'], pun_htmlspecialchars($ban_user)));		}		// If we have a $user_id, we can try to find the last known IP of that user		if (isset($user_id))		{			$result = $db->query('SELECT poster_ip FROM '.$db->prefix.'posts WHERE poster_id='.$user_id.' ORDER BY posted DESC LIMIT 1') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());			$ban_ip = ($db->num_rows($result)) ? $db->result($result) : '';			if ($ban_ip == '')			{				$result = $db->query('SELECT registration_ip FROM '.$db->prefix.'users WHERE id='.$user_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());				$ban_ip = ($db->num_rows($result)) ? $db->result($result) : '';			}		}		$mode = 'add';	}	else // We are editing a ban	{		$ban_id = intval($_GET['edit_ban']);		if ($ban_id < 1)			message($lang_common['Bad request']);		$result = $db->query('SELECT username, ip, email, message, expire FROM '.$db->prefix.'bans WHERE id='.$ban_id) or error('Unable to fetch ban info', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result))			list($ban_user, $ban_ip, $ban_email, $ban_message, $ban_expire) = $db->fetch_row($result);		else			message($lang_common['Bad request']);		$diff = ($pun_user['timezone'] + $pun_user['dst']) * 3600;		$ban_expire = ($ban_expire != '') ? gmdate('Y-m-d', $ban_expire + $diff) : '';		$mode = 'edit';	}	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans']);	$focus_element = array('bans2', 'ban_user');	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';	generate_admin_menu('bans');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_bans['Ban advanced head'] ?></span></h2>		<div class="box">			<form id="bans2" method="post" action="admin_bans.php">				<div class="inform">				<input type="hidden" name="mode" value="<?php echo $mode ?>" /><?php if ($mode == 'edit'): ?>				<input type="hidden" name="ban_id" value="<?php echo $ban_id ?>" /><?php endif; ?>				<fieldset>						<legend><?php echo $lang_admin_bans['Ban advanced subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?></th>									<td>										<input type="text" name="ban_user" size="25" maxlength="25" value="<?php if (isset($ban_user)) echo pun_htmlspecialchars($ban_user); ?>" tabindex="1" />										<span><?php echo $lang_admin_bans['Username help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['IP label'] ?></th>									<td>										<input type="text" name="ban_ip" size="45" maxlength="255" value="<?php if (isset($ban_ip)) echo pun_htmlspecialchars($ban_ip); ?>" tabindex="2" />										<span><?php echo $lang_admin_bans['IP help'] ?><?php if ($ban_user != '' && isset($user_id)) printf(' '.$lang_admin_bans['IP help link'], '<a href="admin_users.php?ip_stats='.$user_id.'">'.$lang_admin_common['here'].'</a>') ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['E-mail label'] ?></th>									<td>										<input type="text" name="ban_email" size="40" maxlength="80" value="<?php if (isset($ban_email)) echo $ban_email; ?>" tabindex="3" />										<span><?php echo $lang_admin_bans['E-mail help'] ?></span>									</td>								</tr>							</table>							<p class="topspace"><strong class="warntext"><?php echo $lang_admin_bans['Ban IP range info'] ?></strong></p>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_bans['Message expiry subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_bans['Ban message label'] ?></th>									<td>										<input type="text" name="ban_message" size="50" maxlength="255" value="<?php if (isset($ban_message)) echo pun_htmlspecialchars($ban_message); ?>" tabindex="4" />										<span><?php echo $lang_admin_bans['Ban message help'] ?></span>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['Expire date label'] ?></th>									<td>										<input type="text" name="ban_expire" size="17" maxlength="10" value="<?php if (isset($ban_expire)) echo $ban_expire; ?>" tabindex="5" />										<span><?php echo $lang_admin_bans['Expire date help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="add_edit_ban" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="6" /></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php	require PUN_ROOT.'footer.php';}// Add/edit a ban (stage 2)else if (isset($_POST['add_edit_ban'])){	confirm_referrer('admin_bans.php');	$ban_user = pun_trim($_POST['ban_user']);	$ban_ip = pun_trim($_POST['ban_ip']);	$ban_email = strtolower(pun_trim($_POST['ban_email']));	$ban_message = pun_trim($_POST['ban_message']);	$ban_expire = pun_trim($_POST['ban_expire']);	if ($ban_user == '' && $ban_ip == '' && $ban_email == '')		message($lang_admin_bans['Must enter message']);	else if (strtolower($ban_user) == 'guest')		message($lang_admin_bans['Cannot ban guest message']);	// Make sure we're not banning an admin or moderator	if (!empty($ban_user))	{		$result = $db->query('SELECT group_id FROM '.$db->prefix.'users WHERE username=\''.$db->escape($ban_user).'\' AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());		if ($db->num_rows($result))		{			$group_id = $db->result($result);			if ($group_id == PUN_ADMIN)				message(sprintf($lang_admin_bans['User is admin message'], pun_htmlspecialchars($ban_user)));			$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());			$is_moderator_group = $db->result($result);			if ($is_moderator_group)				message(sprintf($lang_admin_bans['User is mod message'], pun_htmlspecialchars($ban_user)));		}	}	// Validate IP/IP range (it's overkill, I know)	if ($ban_ip != '')	{		$ban_ip = preg_replace('%\s{2,}%S', ' ', $ban_ip);		$addresses = explode(' ', $ban_ip);		$addresses = array_map('pun_trim', $addresses);		for ($i = 0; $i < count($addresses); ++$i)		{			if (strpos($addresses[$i], ':') !== false)			{				$octets = explode(':', $addresses[$i]);				for ($c = 0; $c < count($octets); ++$c)				{					$octets[$c] = ltrim($octets[$c], "0");					if ($c > 7 || (!empty($octets[$c]) && !ctype_xdigit($octets[$c])) || intval($octets[$c], 16) > 65535)						message($lang_admin_bans['Invalid IP message']);				}				$cur_address = implode(':', $octets);				$addresses[$i] = $cur_address;			}			else			{				$octets = explode('.', $addresses[$i]);				for ($c = 0; $c < count($octets); ++$c)				{					$octets[$c] = (strlen($octets[$c]) > 1) ? ltrim($octets[$c], "0") : $octets[$c];					if ($c > 3 || preg_match('%[^0-9]%', $octets[$c]) || intval($octets[$c]) > 255)						message($lang_admin_bans['Invalid IP message']);				}				$cur_address = implode('.', $octets);				$addresses[$i] = $cur_address;			}		}		$ban_ip = implode(' ', $addresses);	}	require PUN_ROOT.'include/email.php';	if ($ban_email != '' && !is_valid_email($ban_email))	{		if (!preg_match('%^[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$%', $ban_email))			message($lang_admin_bans['Invalid e-mail message']);	}	if ($ban_expire != '' && $ban_expire != 'Never')	{		$ban_expire = strtotime($ban_expire.' GMT');		if ($ban_expire == -1 || !$ban_expire)			message($lang_admin_bans['Invalid date message'].' '.$lang_admin_bans['Invalid date reasons']);		$diff = ($pun_user['timezone'] + $pun_user['dst']) * 3600;		$ban_expire -= $diff;		if ($ban_expire <= time())			message($lang_admin_bans['Invalid date message'].' '.$lang_admin_bans['Invalid date reasons']);	}	else		$ban_expire = 'NULL';	$ban_user = ($ban_user != '') ? '\''.$db->escape($ban_user).'\'' : 'NULL';	$ban_ip = ($ban_ip != '') ? '\''.$db->escape($ban_ip).'\'' : 'NULL';	$ban_email = ($ban_email != '') ? '\''.$db->escape($ban_email).'\'' : 'NULL';	$ban_message = ($ban_message != '') ? '\''.$db->escape($ban_message).'\'' : 'NULL';	if ($_POST['mode'] == 'add')		$db->query('INSERT INTO '.$db->prefix.'bans (username, ip, email, message, expire, ban_creator) VALUES('.$ban_user.', '.$ban_ip.', '.$ban_email.', '.$ban_message.', '.$ban_expire.', '.$pun_user['id'].')') or error('Unable to add ban', __FILE__, __LINE__, $db->error());	else		$db->query('UPDATE '.$db->prefix.'bans SET username='.$ban_user.', ip='.$ban_ip.', email='.$ban_email.', message='.$ban_message.', expire='.$ban_expire.' WHERE id='.intval($_POST['ban_id'])) or error('Unable to update ban', __FILE__, __LINE__, $db->error());	// Regenerate the bans cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_bans_cache();	if ($_POST['mode'] == 'edit')		redirect('admin_bans.php', $lang_admin_bans['Ban edited redirect']);	else		redirect('admin_bans.php', $lang_admin_bans['Ban added redirect']);}// Remove a banelse if (isset($_GET['del_ban'])){	confirm_referrer('admin_bans.php');	$ban_id = intval($_GET['del_ban']);	if ($ban_id < 1)		message($lang_common['Bad request']);	$db->query('DELETE FROM '.$db->prefix.'bans WHERE id='.$ban_id) or error('Unable to delete ban', __FILE__, __LINE__, $db->error());	// Regenerate the bans cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_bans_cache();	redirect('admin_bans.php', $lang_admin_bans['Ban removed redirect']);}// Find banselse if (isset($_GET['find_ban'])){	$form = isset($_GET['form']) ? $_GET['form'] : array();	// trim() all elements in $form	$form = array_map('pun_trim', $form);	$conditions = $query_str = array();	$expire_after = isset($_GET['expire_after']) ? pun_trim($_GET['expire_after']) : '';	$expire_before = isset($_GET['expire_before']) ? pun_trim($_GET['expire_before']) : '';	$order_by = isset($_GET['order_by']) && in_array($_GET['order_by'], array('username', 'ip', 'email', 'expire')) ? 'b.'.$_GET['order_by'] : 'b.username';	$direction = isset($_GET['direction']) && $_GET['direction'] == 'DESC' ? 'DESC' : 'ASC';	$query_str[] = 'order_by='.$order_by;	$query_str[] = 'direction='.$direction;	// Try to convert date/time to timestamps	if ($expire_after != '')	{		$query_str[] = 'expire_after='.$expire_after;		$expire_after = strtotime($expire_after);		if ($expire_after === false || $expire_after == -1)			message($lang_admin_bans['Invalid date message']);		$conditions[] = 'b.expire>'.$expire_after;	}	if ($expire_before != '')	{		$query_str[] = 'expire_before='.$expire_before;		$expire_before = strtotime($expire_before);		if ($expire_before === false || $expire_before == -1)			message($lang_admin_bans['Invalid date message']);		$conditions[] = 'b.expire<'.$expire_before;	}	$like_command = ($db_type == 'pgsql') ? 'ILIKE' : 'LIKE';	foreach ($form as $key => $input)	{		if ($input != '' && in_array($key, array('username', 'ip', 'email', 'message')))		{			$conditions[] = 'b.'.$db->escape($key).' '.$like_command.' \''.$db->escape(str_replace('*', '%', $input)).'\'';			$query_str[] = 'form%5B'.$key.'%5D='.urlencode($input);		}	}	// Fetch ban count	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'bans as b WHERE b.id>0'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '')) or error('Unable to fetch ban list', __FILE__, __LINE__, $db->error());	$num_bans = $db->result($result);	// Determine the ban offset (based on $_GET['p'])	$num_pages = ceil($num_bans / 50);	$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);	$start_from = 50 * ($p - 1);	// Generate paging links	$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'admin_bans.php?find_ban=&amp;'.implode('&amp;', $query_str));	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans'], $lang_admin_bans['Results head']);	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';?><div class="linkst">	<div class="inbox crumbsplus">		<ul class="crumbs">			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="admin_bans.php"><?php echo $lang_admin_common['Bans'] ?></a></li>			<li><span>&#160;</span><strong><?php echo $lang_admin_bans['Results head'] ?></strong></li>		</ul>		<div class="pagepost">			<p class="pagelink"><?php echo $paging_links ?></p>		</div>		<div class="clearer"></div>	</div></div><div id="bans1" class="blocktable">	<h2><span><?php echo $lang_admin_bans['Results head'] ?></span></h2>	<div class="box">		<div class="inbox">			<table cellspacing="0">			<thead>				<tr>					<th class="tcl" scope="col"><?php echo $lang_admin_bans['Results username head'] ?></th>					<th class="tc2" scope="col"><?php echo $lang_admin_bans['Results e-mail head'] ?></th>					<th class="tc3" scope="col"><?php echo $lang_admin_bans['Results IP address head'] ?></th>					<th class="tc4" scope="col"><?php echo $lang_admin_bans['Results expire head'] ?></th>					<th class="tc5" scope="col"><?php echo $lang_admin_bans['Results message head'] ?></th>					<th class="tc6" scope="col"><?php echo $lang_admin_bans['Results banned by head'] ?></th>					<th class="tcr" scope="col"><?php echo $lang_admin_bans['Results actions head'] ?></th>				</tr>			</thead>			<tbody><?php	$result = $db->query('SELECT b.id, b.username, b.ip, b.email, b.message, b.expire, b.ban_creator, u.username AS ban_creator_username FROM '.$db->prefix.'bans AS b LEFT JOIN '.$db->prefix.'users AS u ON b.ban_creator=u.id WHERE b.id>0'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '').' ORDER BY '.$db->escape($order_by).' '.$db->escape($direction).' LIMIT '.$start_from.', 50') or error('Unable to fetch ban list', __FILE__, __LINE__, $db->error());	if ($db->num_rows($result))	{		while ($ban_data = $db->fetch_assoc($result))		{			$actions = '<a href="admin_bans.php?edit_ban='.$ban_data['id'].'">'.$lang_admin_common['Edit'].'</a> | <a href="admin_bans.php?del_ban='.$ban_data['id'].'">'.$lang_admin_common['Remove'].'</a>';			$expire = format_time($ban_data['expire'], true);?>				<tr>					<td class="tcl"><?php echo ($ban_data['username'] != '') ? pun_htmlspecialchars($ban_data['username']) : '&#160;' ?></td>					<td class="tc2"><?php echo ($ban_data['email'] != '') ? $ban_data['email'] : '&#160;' ?></td>					<td class="tc3"><?php echo ($ban_data['ip'] != '') ? pun_htmlspecialchars($ban_data['ip']) : '&#160;' ?></td>					<td class="tc4"><?php echo $expire ?></td>					<td class="tc5"><?php echo ($ban_data['message'] != '') ? pun_htmlspecialchars($ban_data['message']) : '&#160;' ?></td>					<td class="tc6"><?php echo ($ban_data['ban_creator_username'] != '') ? '<a href="profile.php?id='.$ban_data['ban_creator'].'">'.pun_htmlspecialchars($ban_data['ban_creator_username']).'</a>' : $lang_admin_bans['Unknown'] ?></td>					<td class="tcr"><?php echo $actions ?></td>				</tr><?php		}	}	else		echo "\t\t\t\t".'<tr><td class="tcl" colspan="7">'.$lang_admin_bans['No match'].'</td></tr>'."\n";?>			</tbody>			</table>		</div>	</div></div><div class="linksb">	<div class="inbox crumbsplus">		<div class="pagepost">			<p class="pagelink"><?php echo $paging_links ?></p>		</div>		<ul class="crumbs">			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="admin_bans.php"><?php echo $lang_admin_common['Bans'] ?></a></li>			<li><span>&#160;</span><strong><?php echo $lang_admin_bans['Results head'] ?></strong></li>		</ul>		<div class="clearer"></div>	</div></div><?php	require PUN_ROOT.'footer.php';}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans']);$focus_element = array('bans', 'new_ban_user');define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('bans');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_bans['New ban head'] ?></span></h2>		<div class="box">			<form id="bans" method="post" action="admin_bans.php?action=more">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_bans['Add ban subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?><div><input type="submit" name="add_ban" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="2" /></div></th>									<td>										<input type="text" name="new_ban_user" size="25" maxlength="25" tabindex="1" />										<span><?php echo $lang_admin_bans['Username advanced help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>			</form>		</div>		<h2 class="block2"><span><?php echo $lang_admin_bans['Ban search head'] ?></span></h2>		<div class="box">			<form id="find_bans" method="get" action="admin_bans.php">				<p class="submittop"><input type="submit" name="find_ban" value="<?php echo $lang_admin_bans['Submit search'] ?>" tabindex="3" /></p>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_bans['Ban search subhead'] ?></legend>						<div class="infldset">							<p><?php echo $lang_admin_bans['Ban search info'] ?></p>							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?></th>									<td><input type="text" name="form[username]" size="25" maxlength="25" tabindex="4" /></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['IP label'] ?></th>									<td><input type="text" name="form[ip]" size="30" maxlength="255" tabindex="5" /></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['E-mail label'] ?></th>									<td><input type="text" name="form[email]" size="30" maxlength="80" tabindex="6" /></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['Message label'] ?></th>									<td><input type="text" name="form[message]" size="30" maxlength="255" tabindex="7" /></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['Expire after label'] ?></th>									<td><input type="text" name="expire_after" size="10" maxlength="10" tabindex="8" />									<span><?php echo $lang_admin_bans['Date help'] ?></span></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['Expire before label'] ?></th>									<td><input type="text" name="expire_before" size="10" maxlength="10" tabindex="9" />									<span><?php echo $lang_admin_bans['Date help'] ?></span></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_bans['Order by label'] ?></th>									<td>										<select name="order_by" tabindex="10">											<option value="username" selected="selected"><?php echo $lang_admin_bans['Order by username'] ?></option>											<option value="ip"><?php echo $lang_admin_bans['Order by ip'] ?></option>											<option value="email"><?php echo $lang_admin_bans['Order by e-mail'] ?></option>											<option value="expire"><?php echo $lang_admin_bans['Order by expire'] ?></option>										</select>&#160;&#160;&#160;<select name="direction" tabindex="11">											<option value="ASC" selected="selected"><?php echo $lang_admin_bans['Ascending'] ?></option>											<option value="DESC"><?php echo $lang_admin_bans['Descending'] ?></option>										</select>									</td>								</tr>							</table>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="find_ban" value="<?php echo $lang_admin_bans['Submit search'] ?>" tabindex="12" /></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_categories.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_categories.php';// Add a new categoryif (isset($_POST['add_cat'])){	confirm_referrer('admin_categories.php');	$new_cat_name = pun_trim($_POST['new_cat_name']);	if ($new_cat_name == '')		message($lang_admin_categories['Must enter name message']);	$db->query('INSERT INTO '.$db->prefix.'categories (cat_name) VALUES(\''.$db->escape($new_cat_name).'\')') or error('Unable to create category', __FILE__, __LINE__, $db->error());	redirect('admin_categories.php', $lang_admin_categories['Category added redirect']);}// Delete a categoryelse if (isset($_POST['del_cat']) || isset($_POST['del_cat_comply'])){	confirm_referrer('admin_categories.php');	$cat_to_delete = intval($_POST['cat_to_delete']);	if ($cat_to_delete < 1)		message($lang_common['Bad request']);	if (isset($_POST['del_cat_comply'])) // Delete a category with all forums and posts	{		@set_time_limit(0);		$result = $db->query('SELECT id FROM '.$db->prefix.'forums WHERE cat_id='.$cat_to_delete) or error('Unable to fetch forum list', __FILE__, __LINE__, $db->error());		$num_forums = $db->num_rows($result);		for ($i = 0; $i < $num_forums; ++$i)		{			$cur_forum = $db->result($result, $i);			// Prune all posts and topics			prune($cur_forum, 1, -1);			// Delete the forum			$db->query('DELETE FROM '.$db->prefix.'forums WHERE id='.$cur_forum) or error('Unable to delete forum', __FILE__, __LINE__, $db->error());		}		// Locate any "orphaned redirect topics" and delete them		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());		$num_orphans = $db->num_rows($result);		if ($num_orphans)		{			for ($i = 0; $i < $num_orphans; ++$i)				$orphans[] = $db->result($result, $i);			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());		}		// Delete the category		$db->query('DELETE FROM '.$db->prefix.'categories WHERE id='.$cat_to_delete) or error('Unable to delete category', __FILE__, __LINE__, $db->error());		// Regenerate the quick jump cache		if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))			require PUN_ROOT.'include/cache.php';		generate_quickjump_cache();		redirect('admin_categories.php', $lang_admin_categories['Category deleted redirect']);	}	else // If the user hasn't confirmed the delete	{		$result = $db->query('SELECT cat_name FROM '.$db->prefix.'categories WHERE id='.$cat_to_delete) or error('Unable to fetch category info', __FILE__, __LINE__, $db->error());		$cat_name = $db->result($result);		$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Categories']);		define('PUN_ACTIVE_PAGE', 'admin');		require PUN_ROOT.'header.php';		generate_admin_menu('categories');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_categories['Delete category head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_categories.php">				<div class="inform">				<input type="hidden" name="cat_to_delete" value="<?php echo $cat_to_delete ?>" />					<fieldset>						<legend><?php echo $lang_admin_categories['Confirm delete subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_categories['Confirm delete info'], pun_htmlspecialchars($cat_name)) ?></p>							<p class="warntext"><?php echo $lang_admin_categories['Delete category warn'] ?></p>						</div>					</fieldset>				</div>				<p class="buttons"><input type="submit" name="del_cat_comply" value="<?php echo $lang_admin_common['Delete'] ?>" /><a href="javascript:history.go(-1)"><?php echo $lang_admin_common['Go back'] ?></a></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php		require PUN_ROOT.'footer.php';	}}else if (isset($_POST['update'])) // Change position and name of the categories{	confirm_referrer('admin_categories.php');	$categories = $_POST['cat'];	if (empty($categories))		message($lang_common['Bad request']);	foreach ($categories as $cat_id => $cur_cat)	{		$cur_cat['name'] = pun_trim($cur_cat['name']);		$cur_cat['order'] = pun_trim($cur_cat['order']);		if ($cur_cat['name'] == '')			message($lang_admin_categories['Must enter name message']);		if ($cur_cat['order'] == '' || preg_match('%[^0-9]%', $cur_cat['order']))			message($lang_admin_categories['Must enter integer message']);		$db->query('UPDATE '.$db->prefix.'categories SET cat_name=\''.$db->escape($cur_cat['name']).'\', disp_position='.$cur_cat['order'].' WHERE id='.intval($cat_id)) or error('Unable to update category', __FILE__, __LINE__, $db->error());	}	// Regenerate the quick jump cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_quickjump_cache();	redirect('admin_categories.php', $lang_admin_categories['Categories updated redirect']);}// Generate an array with all categories$result = $db->query('SELECT id, cat_name, disp_position FROM '.$db->prefix.'categories ORDER BY disp_position') or error('Unable to fetch category list', __FILE__, __LINE__, $db->error());$num_cats = $db->num_rows($result);for ($i = 0; $i < $num_cats; ++$i)	$cat_list[] = $db->fetch_assoc($result);$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Categories']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('categories');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_categories['Add categories head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_categories.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_categories['Add categories subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_categories['Add category label'] ?><div><input type="submit" name="add_cat" value="<?php echo $lang_admin_categories['Add new submit'] ?>" tabindex="2" /></div></th>									<td>										<input type="text" name="new_cat_name" size="35" maxlength="80" tabindex="1" />										<span><?php printf($lang_admin_categories['Add category help'], '<a href="admin_forums.php">'.$lang_admin_common['Forums'].'</a>') ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>			</form>		</div><?php if ($num_cats): ?>		<h2 class="block2"><span><?php echo $lang_admin_categories['Delete categories head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_categories.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_categories['Delete categories subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_categories['Delete category label'] ?><div><input type="submit" name="del_cat" value="<?php echo $lang_admin_common['Delete'] ?>" tabindex="4" /></div></th>									<td>										<select name="cat_to_delete" tabindex="3"><?php	foreach ($cat_list as $cur_cat)		echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_cat['id'].'">'.pun_htmlspecialchars($cur_cat['cat_name']).'</option>'."\n";?>										</select>										<span><?php echo $lang_admin_categories['Delete category help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>			</form>		</div><?php endif; ?><?php if ($num_cats): ?>		<h2 class="block2"><span><?php echo $lang_admin_categories['Edit categories head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_categories.php">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_categories['Edit categories subhead'] ?></legend>						<div class="infldset">							<table id="categoryedit" cellspacing="0" >							<thead>								<tr>									<th class="tcl" scope="col"><?php echo $lang_admin_categories['Category name label'] ?></th>									<th scope="col"><?php echo $lang_admin_categories['Category position label'] ?></th>								</tr>							</thead>							<tbody><?php	foreach ($cat_list as $cur_cat)	{?>								<tr>									<td class="tcl"><input type="text" name="cat[<?php echo $cur_cat['id'] ?>][name]" value="<?php echo pun_htmlspecialchars($cur_cat['cat_name']) ?>" size="35" maxlength="80" /></td>									<td><input type="text" name="cat[<?php echo $cur_cat['id'] ?>][order]" value="<?php echo $cur_cat['disp_position'] ?>" size="3" maxlength="3" /></td>								</tr><?php	}?>							</tbody>							</table>							<div class="fsetsubmit"><input type="submit" name="update" value="<?php echo $lang_admin_common['Update'] ?>" /></div>						</div>					</fieldset>				</div>			</form>		</div><?php endif; ?>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';if ($pun_user['g_read_board'] == '0')	message($lang_common['No view'], false, '403 Forbidden');$id = isset($_GET['id']) ? intval($_GET['id']) : 0;if ($id < 1)	message($lang_common['Bad request'], false, '404 Not Found');// Fetch some info about the post, the topic and the forum$result = $db->query('SELECT f.id AS fid, f.forum_name, f.moderators, f.redirect_url, fp.post_replies, fp.post_topics, t.id AS tid, t.subject, t.posted, t.first_post_id, t.sticky, t.closed, p.poster, p.poster_id, p.message, p.hide_smilies FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.id='.$id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());if (!$db->num_rows($result))	message($lang_common['Bad request'], false, '404 Not Found');$cur_post = $db->fetch_assoc($result);// Sort out who the moderators are and if we are currently a moderator (or an admin)$mods_array = ($cur_post['moderators'] != '') ? unserialize($cur_post['moderators']) : array();$is_admmod = ($pun_user['g_id'] == PUN_ADMIN || ($pun_user['g_moderator'] == '1' && array_key_exists($pun_user['username'], $mods_array))) ? true : false;$can_edit_subject = $id == $cur_post['first_post_id'];if ($pun_config['o_censoring'] == '1'){	$cur_post['subject'] = censor_words($cur_post['subject']);	$cur_post['message'] = censor_words($cur_post['message']);}// Do we have permission to edit this post?if (($pun_user['g_edit_posts'] == '0' ||	$cur_post['poster_id'] != $pun_user['id'] ||	$cur_post['closed'] == '1') &&	!$is_admmod)	message($lang_common['No permission'], false, '403 Forbidden');// Load the post.php language filerequire PUN_ROOT.'lang/'.$pun_user['language'].'/post.php';// Start with a clean slate$errors = array();if (isset($_POST['form_sent'])){	if ($is_admmod)		confirm_referrer('edit.php');	// If it's a topic it must contain a subject	if ($can_edit_subject)	{		$subject = pun_trim($_POST['req_subject']);		if ($pun_config['o_censoring'] == '1')			$censored_subject = pun_trim(censor_words($subject));		if ($subject == '')			$errors[] = $lang_post['No subject'];		else if ($pun_config['o_censoring'] == '1' && $censored_subject == '')			$errors[] = $lang_post['No subject after censoring'];		else if (pun_strlen($subject) > 70)			$errors[] = $lang_post['Too long subject'];		else if ($pun_config['p_subject_all_caps'] == '0' && is_all_uppercase($subject) && !$pun_user['is_admmod'])			$errors[] = $lang_post['All caps subject'];	}	// Clean up message from POST	$message = pun_linebreaks(pun_trim($_POST['req_message']));	// Here we use strlen() not pun_strlen() as we want to limit the post to PUN_MAX_POSTSIZE bytes, not characters	if (strlen($message) > PUN_MAX_POSTSIZE)		$errors[] = sprintf($lang_post['Too long message'], forum_number_format(PUN_MAX_POSTSIZE));	else if ($pun_config['p_message_all_caps'] == '0' && is_all_uppercase($message) && !$pun_user['is_admmod'])		$errors[] = $lang_post['All caps message'];	// Validate BBCode syntax	if ($pun_config['p_message_bbcode'] == '1')	{		require PUN_ROOT.'include/parser.php';		$message = preparse_bbcode($message, $errors);	}	if (empty($errors))	{		if ($message == '')			$errors[] = $lang_post['No message'];		else if ($pun_config['o_censoring'] == '1')		{			// Censor message to see if that causes problems			$censored_message = pun_trim(censor_words($message));			if ($censored_message == '')				$errors[] = $lang_post['No message after censoring'];		}	}	$hide_smilies = isset($_POST['hide_smilies']) ? '1' : '0';	$stick_topic = isset($_POST['stick_topic']) ? '1' : '0';	if (!$is_admmod)		$stick_topic = $cur_post['sticky'];	// Replace four-byte characters (MySQL cannot handle them)	$message = strip_bad_multibyte_chars($message);	// Did everything go according to plan?	if (empty($errors) && !isset($_POST['preview']))	{		$edited_sql = (!isset($_POST['silent']) || !$is_admmod) ? ', edited='.time().', edited_by=\''.$db->escape($pun_user['username']).'\'' : '';		require PUN_ROOT.'include/search_idx.php';		if ($can_edit_subject)		{			// Update the topic and any redirect topics			$db->query('UPDATE '.$db->prefix.'topics SET subject=\''.$db->escape($subject).'\', sticky='.$stick_topic.' WHERE id='.$cur_post['tid'].' OR moved_to='.$cur_post['tid']) or error('Unable to update topic', __FILE__, __LINE__, $db->error());			// We changed the subject, so we need to take that into account when we update the search words			update_search_index('edit', $id, $message, $subject);		}		else			update_search_index('edit', $id, $message);		// Update the post		$db->query('UPDATE '.$db->prefix.'posts SET message=\''.$db->escape($message).'\', hide_smilies='.$hide_smilies.$edited_sql.' WHERE id='.$id) or error('Unable to update post', __FILE__, __LINE__, $db->error());		redirect('viewtopic.php?pid='.$id.'#p'.$id, $lang_post['Edit redirect']);	}}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_post['Edit post']);$required_fields = array('req_subject' => $lang_common['Subject'], 'req_message' => $lang_common['Message']);$focus_element = array('edit', 'req_message');define('PUN_ACTIVE_PAGE', 'index');require PUN_ROOT.'header.php';$cur_index = 1;?><div class="linkst">	<div class="inbox">		<ul class="crumbs">			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>			<li><span>&#160;</span><a href="viewforum.php?id=<?php echo $cur_post['fid'] ?>"><?php echo pun_htmlspecialchars($cur_post['forum_name']) ?></a></li>			<li><span>&#160;</span><a href="viewtopic.php?id=<?php echo $cur_post['tid'] ?>"><?php echo pun_htmlspecialchars($cur_post['subject']) ?></a></li>			<li><span>&#160;</span><strong><?php echo $lang_post['Edit post'] ?></strong></li>		</ul>	</div></div><?php// If there are errors, we display themif (!empty($errors)){?><div id="posterror" class="block">	<h2><span><?php echo $lang_post['Post errors'] ?></span></h2>	<div class="box">		<div class="inbox error-info">			<p><?php echo $lang_post['Post errors info'] ?></p>			<ul class="error-list"><?php	foreach ($errors as $cur_error)		echo "\t\t\t\t".'<li><strong>'.$cur_error.'</strong></li>'."\n";?>			</ul>		</div>	</div></div><?php}else if (isset($_POST['preview'])){	require_once PUN_ROOT.'include/parser.php';	$preview_message = parse_message($message, $hide_smilies);?><div id="postpreview" class="blockpost">	<h2><span><?php echo $lang_post['Post preview'] ?></span></h2>	<div class="box">		<div class="inbox">			<div class="postbody">				<div class="postright">					<div class="postmsg">						<?php echo $preview_message."\n" ?>					</div>				</div>			</div>		</div>	</div></div><?php}?><div id="editform" class="blockform">	<h2><span><?php echo $lang_post['Edit post'] ?></span></h2>	<div class="box">		<form id="edit" method="post" action="edit.php?id=<?php echo $id ?>&amp;action=edit" onsubmit="return process_form(this)">			<div class="inform">				<fieldset>					<legend><?php echo $lang_post['Edit post legend'] ?></legend>					<input type="hidden" name="form_sent" value="1" />					<div class="infldset txtarea"><?php if ($can_edit_subject): ?>						<label class="required"><strong><?php echo $lang_common['Subject'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />						<input class="longinput" type="text" name="req_subject" size="80" maxlength="70" tabindex="<?php echo $cur_index++ ?>" value="<?php echo pun_htmlspecialchars(isset($_POST['req_subject']) ? $_POST['req_subject'] : $cur_post['subject']) ?>" /><br /></label><?php endif; ?>						<label class="required"><strong><?php echo $lang_common['Message'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />						<textarea name="req_message" rows="20" cols="95" tabindex="<?php echo $cur_index++ ?>"><?php echo pun_htmlspecialchars(isset($_POST['req_message']) ? $message : $cur_post['message']) ?></textarea><br /></label>						<ul class="bblinks">							<li><span><a href="help.php#bbcode" onclick="window.open(this.href); return false;"><?php echo $lang_common['BBCode'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>							<li><span><a href="help.php#url" onclick="window.open(this.href); return false;"><?php echo $lang_common['url tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_user['g_post_links'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>							<li><span><a href="help.php#img" onclick="window.open(this.href); return false;"><?php echo $lang_common['img tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_config['p_message_img_tag'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>							<li><span><a href="help.php#smilies" onclick="window.open(this.href); return false;"><?php echo $lang_common['Smilies'] ?></a> <?php echo ($pun_config['o_smilies'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>						</ul>					</div>				</fieldset><?php$checkboxes = array();if ($can_edit_subject && $is_admmod){	if (isset($_POST['stick_topic']) || $cur_post['sticky'] == '1')		$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" checked="checked" tabindex="'.($cur_index++).'" />'.$lang_common['Stick topic'].'<br /></label>';	else		$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" tabindex="'.($cur_index++).'" />'.$lang_common['Stick topic'].'<br /></label>';}if ($pun_config['o_smilies'] == '1'){	if (isset($_POST['hide_smilies']) || $cur_post['hide_smilies'] == '1')		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" checked="checked" tabindex="'.($cur_index++).'" />'.$lang_post['Hide smilies'].'<br /></label>';	else		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" tabindex="'.($cur_index++).'" />'.$lang_post['Hide smilies'].'<br /></label>';}if ($is_admmod){	if ((isset($_POST['form_sent']) && isset($_POST['silent'])) || !isset($_POST['form_sent']))		$checkboxes[] = '<label><input type="checkbox" name="silent" value="1" tabindex="'.($cur_index++).'" checked="checked" />'.$lang_post['Silent edit'].'<br /></label>';	else		$checkboxes[] = '<label><input type="checkbox" name="silent" value="1" tabindex="'.($cur_index++).'" />'.$lang_post['Silent edit'].'<br /></label>';}if (!empty($checkboxes)){?>			</div>			<div class="inform">				<fieldset>					<legend><?php echo $lang_common['Options'] ?></legend>					<div class="infldset">						<div class="rbox">							<?php echo implode("\n\t\t\t\t\t\t\t", $checkboxes)."\n" ?>						</div>					</div>				</fieldset><?php	}?>			</div>			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_post['Preview'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="p" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>		</form>	</div></div><?phprequire PUN_ROOT.'footer.php';
<?php/** * Copyright (C) 2008-2012 FluxBB * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher */// Tell header.php to use the admin templatedefine('PUN_ADMIN_CONSOLE', 1);define('PUN_ROOT', dirname(__FILE__).'/');require PUN_ROOT.'include/common.php';require PUN_ROOT.'include/common_admin.php';if ($pun_user['g_id'] != PUN_ADMIN)	message($lang_common['No permission'], false, '403 Forbidden');// Load the admin_forums.php language filerequire PUN_ROOT.'lang/'.$admin_language.'/admin_forums.php';// Add a "default" forumif (isset($_POST['add_forum'])){	confirm_referrer('admin_forums.php');	$add_to_cat = intval($_POST['add_to_cat']);	if ($add_to_cat < 1)		message($lang_common['Bad request']);	$db->query('INSERT INTO '.$db->prefix.'forums (forum_name, cat_id) VALUES(\''.$db->escape($lang_admin_forums['New forum']).'\', '.$add_to_cat.')') or error('Unable to create forum', __FILE__, __LINE__, $db->error());	// Regenerate the quick jump cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_quickjump_cache();	redirect('admin_forums.php', $lang_admin_forums['Forum added redirect']);}// Delete a forumelse if (isset($_GET['del_forum'])){	confirm_referrer('admin_forums.php');	$forum_id = intval($_GET['del_forum']);	if ($forum_id < 1)		message($lang_common['Bad request']);	if (isset($_POST['del_forum_comply'])) // Delete a forum with all posts	{		@set_time_limit(0);		// Prune all posts and topics		prune($forum_id, 1, -1);		// Locate any "orphaned redirect topics" and delete them		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());		$num_orphans = $db->num_rows($result);		if ($num_orphans)		{			for ($i = 0; $i < $num_orphans; ++$i)				$orphans[] = $db->result($result, $i);			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());		}		// Delete the forum and any forum specific group permissions		$db->query('DELETE FROM '.$db->prefix.'forums WHERE id='.$forum_id) or error('Unable to delete forum', __FILE__, __LINE__, $db->error());		$db->query('DELETE FROM '.$db->prefix.'forum_perms WHERE forum_id='.$forum_id) or error('Unable to delete group forum permissions', __FILE__, __LINE__, $db->error());		// Delete any subscriptions for this forum		$db->query('DELETE FROM '.$db->prefix.'forum_subscriptions WHERE forum_id='.$forum_id) or error('Unable to delete subscriptions', __FILE__, __LINE__, $db->error());		// Regenerate the quick jump cache		if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))			require PUN_ROOT.'include/cache.php';		generate_quickjump_cache();		redirect('admin_forums.php', $lang_admin_forums['Forum deleted redirect']);	}	else // If the user hasn't confirmed the delete	{		$result = $db->query('SELECT forum_name FROM '.$db->prefix.'forums WHERE id='.$forum_id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());		$forum_name = pun_htmlspecialchars($db->result($result));		$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Forums']);		define('PUN_ACTIVE_PAGE', 'admin');		require PUN_ROOT.'header.php';		generate_admin_menu('forums');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_forums['Confirm delete head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_forums.php?del_forum=<?php echo $forum_id ?>">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_forums['Confirm delete subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_forums['Confirm delete info'], $forum_name) ?></p>							<p class="warntext"><?php echo $lang_admin_forums['Confirm delete warn'] ?></p>						</div>					</fieldset>				</div>				<p class="buttons"><input type="submit" name="del_forum_comply" value="<?php echo $lang_admin_common['Delete'] ?>" /><a href="javascript:history.go(-1)"><?php echo $lang_admin_common['Go back'] ?></a></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php		require PUN_ROOT.'footer.php';	}}// Update forum positionselse if (isset($_POST['update_positions'])){	confirm_referrer('admin_forums.php');	foreach ($_POST['position'] as $forum_id => $disp_position)	{		$disp_position = trim($disp_position);		if ($disp_position == '' || preg_match('%[^0-9]%', $disp_position))			message($lang_admin_forums['Must be integer message']);		$db->query('UPDATE '.$db->prefix.'forums SET disp_position='.$disp_position.' WHERE id='.intval($forum_id)) or error('Unable to update forum', __FILE__, __LINE__, $db->error());	}	// Regenerate the quick jump cache	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))		require PUN_ROOT.'include/cache.php';	generate_quickjump_cache();	redirect('admin_forums.php', $lang_admin_forums['Forums updated redirect']);}else if (isset($_GET['edit_forum'])){	$forum_id = intval($_GET['edit_forum']);	if ($forum_id < 1)		message($lang_common['Bad request']);	// Update group permissions for $forum_id	if (isset($_POST['save']))	{		confirm_referrer('admin_forums.php');		// Start with the forum details		$forum_name = pun_trim($_POST['forum_name']);		$forum_desc = pun_linebreaks(pun_trim($_POST['forum_desc']));		$cat_id = intval($_POST['cat_id']);		$sort_by = intval($_POST['sort_by']);		$redirect_url = isset($_POST['redirect_url']) ? pun_trim($_POST['redirect_url']) : null;		if ($forum_name == '')			message($lang_admin_forums['Must enter name message']);		if ($cat_id < 1)			message($lang_common['Bad request']);		$forum_desc = ($forum_desc != '') ? '\''.$db->escape($forum_desc).'\'' : 'NULL';		$redirect_url = ($redirect_url != '') ? '\''.$db->escape($redirect_url).'\'' : 'NULL';		$db->query('UPDATE '.$db->prefix.'forums SET forum_name=\''.$db->escape($forum_name).'\', forum_desc='.$forum_desc.', redirect_url='.$redirect_url.', sort_by='.$sort_by.', cat_id='.$cat_id.' WHERE id='.$forum_id) or error('Unable to update forum', __FILE__, __LINE__, $db->error());		// Now let's deal with the permissions		if (isset($_POST['read_forum_old']))		{			$result = $db->query('SELECT g_id, g_read_board, g_post_replies, g_post_topics FROM '.$db->prefix.'groups WHERE g_id!='.PUN_ADMIN) or error('Unable to fetch user group list', __FILE__, __LINE__, $db->error());			while ($cur_group = $db->fetch_assoc($result))			{				$read_forum_new = ($cur_group['g_read_board'] == '1') ? isset($_POST['read_forum_new'][$cur_group['g_id']]) ? '1' : '0' : intval($_POST['read_forum_old'][$cur_group['g_id']]);				$post_replies_new = isset($_POST['post_replies_new'][$cur_group['g_id']]) ? '1' : '0';				$post_topics_new = isset($_POST['post_topics_new'][$cur_group['g_id']]) ? '1' : '0';				// Check if the new settings differ from the old				if ($read_forum_new != $_POST['read_forum_old'][$cur_group['g_id']] || $post_replies_new != $_POST['post_replies_old'][$cur_group['g_id']] || $post_topics_new != $_POST['post_topics_old'][$cur_group['g_id']])				{					// If the new settings are identical to the default settings for this group, delete its row in forum_perms					if ($read_forum_new == '1' && $post_replies_new == $cur_group['g_post_replies'] && $post_topics_new == $cur_group['g_post_topics'])						$db->query('DELETE FROM '.$db->prefix.'forum_perms WHERE group_id='.$cur_group['g_id'].' AND forum_id='.$forum_id) or error('Unable to delete group forum permissions', __FILE__, __LINE__, $db->error());					else					{						// Run an UPDATE and see if it affected a row, if not, INSERT						$db->query('UPDATE '.$db->prefix.'forum_perms SET read_forum='.$read_forum_new.', post_replies='.$post_replies_new.', post_topics='.$post_topics_new.' WHERE group_id='.$cur_group['g_id'].' AND forum_id='.$forum_id) or error('Unable to insert group forum permissions', __FILE__, __LINE__, $db->error());						if (!$db->affected_rows())							$db->query('INSERT INTO '.$db->prefix.'forum_perms (group_id, forum_id, read_forum, post_replies, post_topics) VALUES('.$cur_group['g_id'].', '.$forum_id.', '.$read_forum_new.', '.$post_replies_new.', '.$post_topics_new.')') or error('Unable to insert group forum permissions', __FILE__, __LINE__, $db->error());					}				}			}		}		// Regenerate the quick jump cache		if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))			require PUN_ROOT.'include/cache.php';		generate_quickjump_cache();		redirect('admin_forums.php', $lang_admin_forums['Forum updated redirect']);	}	else if (isset($_POST['revert_perms']))	{		confirm_referrer('admin_forums.php');		$db->query('DELETE FROM '.$db->prefix.'forum_perms WHERE forum_id='.$forum_id) or error('Unable to delete group forum permissions', __FILE__, __LINE__, $db->error());		// Regenerate the quick jump cache		if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))			require PUN_ROOT.'include/cache.php';		generate_quickjump_cache();		redirect('admin_forums.php?edit_forum='.$forum_id, $lang_admin_forums['Perms reverted redirect']);	}	// Fetch forum info	$result = $db->query('SELECT id, forum_name, forum_desc, redirect_url, num_topics, sort_by, cat_id FROM '.$db->prefix.'forums WHERE id='.$forum_id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());	if (!$db->num_rows($result))		message($lang_common['Bad request']);	$cur_forum = $db->fetch_assoc($result);	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Forums']);	define('PUN_ACTIVE_PAGE', 'admin');	require PUN_ROOT.'header.php';	generate_admin_menu('forums');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_forums['Edit forum head'] ?></span></h2>		<div class="box">			<form id="edit_forum" method="post" action="admin_forums.php?edit_forum=<?php echo $forum_id ?>">				<p class="submittop"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" tabindex="6" /></p>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_forums['Edit details subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_forums['Forum name label'] ?></th>									<td><input type="text" name="forum_name" size="35" maxlength="80" value="<?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?>" tabindex="1" /></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_forums['Forum description label'] ?></th>									<td><textarea name="forum_desc" rows="3" cols="50" tabindex="2"><?php echo pun_htmlspecialchars($cur_forum['forum_desc']) ?></textarea></td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_forums['Category label'] ?></th>									<td>										<select name="cat_id" tabindex="3"><?php	$result = $db->query('SELECT id, cat_name FROM '.$db->prefix.'categories ORDER BY disp_position') or error('Unable to fetch category list', __FILE__, __LINE__, $db->error());	while ($cur_cat = $db->fetch_assoc($result))	{		$selected = ($cur_cat['id'] == $cur_forum['cat_id']) ? ' selected="selected"' : '';		echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_cat['id'].'"'.$selected.'>'.pun_htmlspecialchars($cur_cat['cat_name']).'</option>'."\n";	}?>										</select>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_forums['Sort by label'] ?></th>									<td>										<select name="sort_by" tabindex="4">											<option value="0"<?php if ($cur_forum['sort_by'] == '0') echo ' selected="selected"' ?>><?php echo $lang_admin_forums['Last post'] ?></option>											<option value="1"<?php if ($cur_forum['sort_by'] == '1') echo ' selected="selected"' ?>><?php echo $lang_admin_forums['Topic start'] ?></option>											<option value="2"<?php if ($cur_forum['sort_by'] == '2') echo ' selected="selected"' ?>><?php echo $lang_admin_forums['Subject'] ?></option>										</select>									</td>								</tr>								<tr>									<th scope="row"><?php echo $lang_admin_forums['Redirect label'] ?></th>									<td><?php echo ($cur_forum['num_topics']) ? $lang_admin_forums['Redirect help'] : '<input type="text" name="redirect_url" size="45" maxlength="100" value="'.pun_htmlspecialchars($cur_forum['redirect_url']).'" tabindex="5" />'; ?></td>								</tr>							</table>						</div>					</fieldset>				</div>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_forums['Group permissions subhead'] ?></legend>						<div class="infldset">							<p><?php printf($lang_admin_forums['Group permissions info'], '<a href="admin_groups.php">'.$lang_admin_common['User groups'].'</a>') ?></p>							<table id="forumperms" cellspacing="0">							<thead>								<tr>									<th class="atcl">&#160;</th>									<th><?php echo $lang_admin_forums['Read forum label'] ?></th>									<th><?php echo $lang_admin_forums['Post replies label'] ?></th>									<th><?php echo $lang_admin_forums['Post topics label'] ?></th>								</tr>							</thead>							<tbody><?php	$result = $db->query('SELECT g.g_id, g.g_title, g.g_read_board, g.g_post_replies, g.g_post_topics, fp.read_forum, fp.post_replies, fp.post_topics FROM '.$db->prefix.'groups AS g LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (g.g_id=fp.group_id AND fp.forum_id='.$forum_id.') WHERE g.g_id!='.PUN_ADMIN.' ORDER BY g.g_id') or error('Unable to fetch group forum permission list', __FILE__, __LINE__, $db->error());	$cur_index = 7;	while ($cur_perm = $db->fetch_assoc($result))	{		$read_forum = ($cur_perm['read_forum'] != '0') ? true : false;		$post_replies = (($cur_perm['g_post_replies'] == '0' && $cur_perm['post_replies'] == '1') || ($cur_perm['g_post_replies'] == '1' && $cur_perm['post_replies'] != '0')) ? true : false;		$post_topics = (($cur_perm['g_post_topics'] == '0' && $cur_perm['post_topics'] == '1') || ($cur_perm['g_post_topics'] == '1' && $cur_perm['post_topics'] != '0')) ? true : false;		// Determine if the current settings differ from the default or not		$read_forum_def = ($cur_perm['read_forum'] == '0') ? false : true;		$post_replies_def = (($post_replies && $cur_perm['g_post_replies'] == '0') || (!$post_replies && ($cur_perm['g_post_replies'] == '' || $cur_perm['g_post_replies'] == '1'))) ? false : true;		$post_topics_def = (($post_topics && $cur_perm['g_post_topics'] == '0') || (!$post_topics && ($cur_perm['g_post_topics'] == '' || $cur_perm['g_post_topics'] == '1'))) ? false : true;?>								<tr>									<th class="atcl"><?php echo pun_htmlspecialchars($cur_perm['g_title']) ?></th>									<td<?php if (!$read_forum_def) echo ' class="nodefault"'; ?>>										<input type="hidden" name="read_forum_old[<?php echo $cur_perm['g_id'] ?>]" value="<?php echo ($read_forum) ? '1' : '0'; ?>" />										<input type="checkbox" name="read_forum_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($read_forum) ? ' checked="checked"' : ''; ?><?php echo ($cur_perm['g_read_board'] == '0') ? ' disabled="disabled"' : ''; ?> tabindex="<?php echo $cur_index++ ?>" />									</td>									<td<?php if (!$post_replies_def && $cur_forum['redirect_url'] == '') echo ' class="nodefault"'; ?>>										<input type="hidden" name="post_replies_old[<?php echo $cur_perm['g_id'] ?>]" value="<?php echo ($post_replies) ? '1' : '0'; ?>" />										<input type="checkbox" name="post_replies_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($post_replies) ? ' checked="checked"' : ''; ?><?php echo ($cur_forum['redirect_url'] != '') ? ' disabled="disabled"' : ''; ?> tabindex="<?php echo $cur_index++ ?>" />									</td>									<td<?php if (!$post_topics_def && $cur_forum['redirect_url'] == '') echo ' class="nodefault"'; ?>>										<input type="hidden" name="post_topics_old[<?php echo $cur_perm['g_id'] ?>]" value="<?php echo ($post_topics) ? '1' : '0'; ?>" />										<input type="checkbox" name="post_topics_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($post_topics) ? ' checked="checked"' : ''; ?><?php echo ($cur_forum['redirect_url'] != '') ? ' disabled="disabled"' : ''; ?> tabindex="<?php echo $cur_index++ ?>" />									</td>								</tr><?php	}?>							</tbody>							</table>							<div class="fsetsubmit"><input type="submit" name="revert_perms" value="<?php echo $lang_admin_forums['Revert to default'] ?>" tabindex="<?php echo $cur_index++ ?>" /></div>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" tabindex="<?php echo $cur_index++ ?>" /></p>			</form>		</div>	</div>	<div class="clearer"></div></div><?php	require PUN_ROOT.'footer.php';}$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Forums']);define('PUN_ACTIVE_PAGE', 'admin');require PUN_ROOT.'header.php';generate_admin_menu('forums');?>	<div class="blockform">		<h2><span><?php echo $lang_admin_forums['Add forum head'] ?></span></h2>		<div class="box">			<form method="post" action="admin_forums.php?action=adddel">				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_forums['Create new subhead'] ?></legend>						<div class="infldset">							<table class="aligntop" cellspacing="0">								<tr>									<th scope="row"><?php echo $lang_admin_forums['Add forum label'] ?><div><input type="submit" name="add_forum" value="<?php echo $lang_admin_forums['Add forum'] ?>" tabindex="2" /></div></th>									<td>										<select name="add_to_cat" tabindex="1"><?php	$result = $db->query('SELECT id, cat_name FROM '.$db->prefix.'categories ORDER BY disp_position') or error('Unable to fetch category list', __FILE__, __LINE__, $db->error());	if ($db->num_rows($result) > 0)	{		while ($cur_cat = $db->fetch_assoc($result))			echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="'.$cur_cat['id'].'">'.pun_htmlspecialchars($cur_cat['cat_name']).'</option>'."\n";	}	else		echo "\t\t\t\t\t\t\t\t\t\t\t".'<option value="0" disabled="disabled">'.$lang_admin_forums['No categories exist'].'</option>'."\n";?>										</select>										<span><?php echo $lang_admin_forums['Add forum help'] ?></span>									</td>								</tr>							</table>						</div>					</fieldset>				</div>			</form>		</div><?php// Display all the categories and forums$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.disp_position FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id ORDER BY c.disp_position, c.id, f.disp_position') or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());if ($db->num_rows($result) > 0){?>		<h2 class="block2"><span><?php echo $lang_admin_forums['Edit forums head'] ?></span></h2>		<div class="box">			<form id="edforum" method="post" action="admin_forums.php?action=edit">				<p class="submittop"><input type="submit" name="update_positions" value="<?php echo $lang_admin_forums['Update positions'] ?>" tabindex="3" /></p><?php$cur_index = 4;$cur_category = 0;while ($cur_forum = $db->fetch_assoc($result)){	if ($cur_forum['cid'] != $cur_category) // A new category since last iteration?	{		if ($cur_category != 0)			echo "\t\t\t\t\t\t\t".'</tbody>'."\n\t\t\t\t\t\t\t".'</table>'."\n\t\t\t\t\t\t".'</div>'."\n\t\t\t\t\t".'</fieldset>'."\n\t\t\t\t".'</div>'."\n";?>				<div class="inform">					<fieldset>						<legend><?php echo $lang_admin_forums['Category subhead'] ?> <?php echo pun_htmlspecialchars($cur_forum['cat_name']) ?></legend>						<div class="infldset">							<table cellspacing="0">							<thead>								<tr>									<th class="tcl"><?php echo $lang_admin_common['Action'] ?></th>									<th class="tc2"><?php echo $lang_admin_forums['Position label'] ?></th>									<th class="tcr"><?php echo $lang_admin_forums['Forum label'] ?></th>								</tr>							</thead>							<tbody><?php		$cur_category = $cur_forum['cid'];	}?>								<tr>									<td class="tcl"><a href="admin_forums.php?edit_forum=<?php echo $cur_forum['fid'] ?>" tabindex="<?php echo $cur_index++ ?>"><?php echo $lang_admin_forums['Edit link'] ?></a> | <a href="admin_forums.php?del_forum=<?php echo $cur_forum['fid'] ?>" tabindex="<?php echo $cur_index++ ?>"><?php echo $lang_admin_forums['Delete link'] ?></a></td>									<td class="tc2"><input type="text" name="position[<?php echo $cur_forum['fid'] ?>]" size="3" maxlength="3" value="<?php echo $cur_forum['disp_position'] ?>" tabindex="<?php echo $cur_index++ ?>" /></td>									<td class="tcr"><strong><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></strong></td>								</tr><?php}?>							</tbody>							</table>						</div>					</fieldset>				</div>				<p class="submitend"><input type="submit" name="update_positions" value="<?php echo $lang_admin_forums['Update positions'] ?>" tabindex="<?php echo $cur_index++ ?>" /></p>			</form>		</div><?php}?>	</div>	<div class="clearer"></div></div><?phprequire PUN_ROOT.'footer.php';
